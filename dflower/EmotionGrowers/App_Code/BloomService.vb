Imports System.ComponentModel
Imports System.Data
Imports System.Diagnostics
Imports System.Drawing.Printing
Imports System.Globalization
Imports System.IO
Imports System.Net
Imports System.Reflection
Imports System.Threading
Imports System.Threading.Tasks
Imports System.Web.Configuration
Imports System.Web.Script.Serialization
Imports System.Web.Script.Services
Imports System.Web.Services
Imports System.Xml
Imports Farms
Imports iTextSharp.text
Imports Microsoft.Reporting.WebForms
Imports Newtonsoft.Json
Imports Newtonsoft.Json.Linq
'Imports PdfPrintingNet
Imports ProdDetails
Imports Microsoft.VisualBasic.Strings
Imports ClosedXML.Excel
Imports Syncfusion.XlsIO
Imports Syncfusion.XlsIO.Implementation.PivotTables
Imports System.Configuration
Imports DAO
Imports DocumentFormat.OpenXml.Office2010.Excel
'Imports Interop.QBFC15


' To allow this Web Service to be called from script, using ASP.NET AJAX, uncomment the following line.
<System.Web.Script.Services.ScriptService()>
<WebService(Namespace:="http://tempuri.org/")>
<WebServiceBinding(ConformsTo:=WsiProfiles.BasicProfile1_1)>
<Global.Microsoft.VisualBasic.CompilerServices.DesignerGenerated()>
Public Class BloomService
    Inherits System.Web.Services.WebService
    Dim taskTransfer As Task(Of String)
    Public Shared objtaskStatus As New TaskStatus


    'Dim objDbfService As New DFlowerDBFService.DFlowerDBFServiceSoapClient
    'Dim CargoMasterSecurityService As New CargoMasterSecurityService.SecuritySoapClient
    'Dim CargoMasterService As New CargoMasterService.wsCustomersTrackingSoapClient
    'Dim GAndGService As New GAndGService.wsProcurementSoapClient
    'Dim wsAr As New wsArmellini.ArmelliniServicesGenericSoapClient
    'test for commit
    Private ReadOnly lReadFromSQL As Boolean = True
    'ConfigurationManager.AppSettings("InventoryAndOrderReadFromSQL").ToString()
    ReadOnly VendorFromEmails As String = ConfigurationManager.AppSettings("VendorFromEmails").ToString()

    Dim RequestxmlForArmellini As String = "", ResponseXml As String = ""

    Dim isArxmlfails As Boolean = False 'New Armellini


#Region "Common Functions"

    Private Function BuildWhereCondition(ByVal DataType As Type, ByVal columnName As String, ByVal columnValue As String) As String
        Try
            Dim whereCondition As String = ""
            Dim columnInfo As PropertyInfo = DataType.GetProperty(columnName)

            If columnName.ToUpper() = "WH" Then
                If columnValue = " " Then
                    whereCondition = columnName & "='" & columnValue & "'"
                Else
                    whereCondition = "UPPER(cast( " & columnName & " as varchar(100))) LIKE '%" & columnValue & "%'"
                End If

            ElseIf columnInfo IsNot Nothing Then
                If columnInfo.PropertyType Is GetType(Integer) Then
                    'whereCondition = columnName & "=" & columnValue     // comment by abinaya on 04/07/2016 for Export all data in doSearch
                    whereCondition = "cast( " & columnName & " as varchar(100)) LIKE '%" & columnValue & "%'"
                ElseIf columnInfo.PropertyType Is GetType([String]) Then
                    'whereCondition = columnName & " LIKE '%" & columnValue & "%'"
                    whereCondition = "UPPER(cast( " & columnName & " as varchar(100))) LIKE '" & columnValue & "%'"
                ElseIf columnInfo.PropertyType Is GetType(DateTime) Then
                    'whereCondition = columnName & "=ctod('" & columnValue & "')"
                    'whereCondition = "cast( " & columnName & " as varchar(100)) LIKE chrtran('%" & columnValue & "%','-','/')"     'chrtran only for foxpro
                    whereCondition = "convert(varchar(100)," & columnName & ",1) LIKE REPLACE('%" & columnValue & "%','-','/')"
                ElseIf columnInfo.PropertyType Is GetType(Decimal) Then
                    'whereCondition = columnName & "=" & columnValue     // comment by abinaya on 04/07/2016 for Export all data in doSearch
                    whereCondition = "cast(convert(decimal(10,3)," & columnName & ") as varchar(100)) LIKE '%" & columnValue & "%'"
                ElseIf columnName = "Farm" Or columnName = "City" Then
                    whereCondition = "cast( " & columnName & " as varchar(100)) LIKE '" & columnValue & "%'"

                ElseIf columnInfo.PropertyType Is GetType(Boolean) Then
                    Dim result As Boolean = True
                    If columnValue.ToString = "0" Or columnValue.ToString.ToLower = "no" Or columnValue.ToString.ToLower = "false" Then
                        result = False
                    End If
                    whereCondition = columnName & "=" & IIf(result, 1, 0) & ""
                End If
            Else
                If columnName = "PartID" Or columnName.ToLower() = "lot" Or columnName.ToLower() = "awb" Then
                    'whereCondition = columnName & " = '" & columnValue & "'"
                    whereCondition = "cast( " & columnName & " as varchar(100)) LIKE '%" & columnValue & "%'"
                Else
                    'whereCondition = columnName & " LIKE '%" & columnValue & "%'"
                    whereCondition = "UPPER(cast( " & columnName & " as varchar(100))) LIKE '" & columnValue & "%'"
                End If
            End If

            Return whereCondition
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::BuildWhereCondition")
            Return Nothing
        End Try
    End Function

    Private Function BuildFlexiGridError(ByVal ErrorMessage As String) As XmlDocument
        Dim newDoc As New XmlDocument()
        newDoc.LoadXml(Convert.ToString("<rows>" +
                      "<page>1</page>" +
                      "<total>1</total>" +
                      "<row id='-2' background-color='#000000' color='#0000ff'>" +
                        "<cell></cell>" +
                        "<cell></cell>" +
                      "</row>" +
                    "</rows>"))
        Dim idx As Integer = 0
        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = "Error ::"
        If ErrorMessage.Contains("corrupted") And ErrorMessage.Contains("'") Then
            ErrorMessage = "Cannot open the file " + ErrorMessage.Split("'")(1)
        End If
        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ErrorMessage
        Return newDoc
    End Function

    Private Function BuildFlexiGridEmpty() As XmlDocument
        Dim newDoc As New XmlDocument()
        newDoc.LoadXml(Convert.ToString("<rows></rows>"))
        Return newDoc
    End Function

    Public Function SendRequest(uri As Uri, jsonDataBytes As Byte(), contentType As String, method As String) As String


        Dim req As WebRequest = WebRequest.Create(uri)
        req.ContentType = contentType
        req.Method = method.ToUpper()



        req.Timeout = 60000
        Dim stream = req.GetRequestStream()

        If IsNothing(jsonDataBytes) = False Then
            '  req.ContentLength = jsonDataBytes.Length
            stream.Write(jsonDataBytes, 0, jsonDataBytes.Length)
        End If


        stream.Close()

        Dim response = req.GetResponse().GetResponseStream()

        Dim reader As New StreamReader(response)
        Dim resultdata = reader.ReadToEnd()
        reader.Close()
        response.Close()

        Return resultdata
    End Function


#End Region

#Region "Pages"
    ''' <summary>
    ''' Muthu Nivetha M :: 06Mar2020 :: Modified :: Added case "PageOrderAll.ascx" to get Order Details When Click Detailsbtn on PageSales
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function GetPage(ByVal controlName As String, ByVal controlPara As String) As String
        Try
            Dim pageHolder As New Page()

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If User.UserType = "Customer" Then
                If controlName.EndsWith("PageManualPO.ascx") Then
                    controlName = "pages/PageCustUser.ascx"
                End If
            End If

            Dim viewControl As UserControl = DirectCast(pageHolder.LoadControl(controlName), UserControl)

            If controlPara <> "" Then
                Dim page1 = controlName.Split("/")
                Select Case page1(1).ToString()
                    Case "PageLookupBox.ascx"
                        Dim ucontrolorder As ICustomParams_LookupOrder = TryCast(viewControl, ICustomParams_LookupOrder)
                        Dim ucontroboxnum As ICustomParams_LookupBoxnum = TryCast(viewControl, ICustomParams_LookupBoxnum)
                        Dim ucontrolfarm As ICustomParams_LookupFarm = TryCast(viewControl, ICustomParams_LookupFarm)
                        Dim ucontrolOrderNo As ICustomParams_SalesOrderNo = TryCast(viewControl, ICustomParams_SalesOrderNo)
                        Dim ucontrolFilter As ICustomParams_SalesFilter = TryCast(viewControl, ICustomParams_SalesFilter)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Order"
                                            ucontrolorder.Order = val(1)
                                        Case "Boxnum"
                                            ucontroboxnum.Boxnum = val(1)
                                        Case "Farm"
                                            ucontrolfarm.Farm = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageInventoryEdit.ascx"
                        Dim ucontrolInvenId As ICustomParams_InventId = TryCast(viewControl, ICustomParams_InventId)
                        Dim ucontrolTableName As ICustomParams_TableName = TryCast(viewControl, ICustomParams_TableName)
                        '26 Mar 19 :: Muthu Nivetha M :: Print Label on look up by boxnumber results screen
                        Dim ucontrolIsFromLookup As ICustomParams_IsFromLookUpForm = TryCast(viewControl, ICustomParams_IsFromLookUpForm)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "InvenID"
                                            ucontrolInvenId.InventID = val(1)
                                        Case "tableName"
                                            ucontrolTableName.TableName = val(1)
                                        Case "isFromLookup"     '26 Mar 19 :: Muthu Nivetha M :: Print Label on look up by boxnumber results screen
                                            ucontrolIsFromLookup.IsFromLookUp = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageOrderDetails.ascx"
                        Dim ucontrol As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        Dim ucontronumber As ICustomParams_CallHSDate = TryCast(viewControl, ICustomParams_CallHSDate)
                        Dim ucontrolPage As ICustomParams_SalesPage = TryCast(viewControl, ICustomParams_SalesPage)
                        Dim ucontrolOrderNo As ICustomParams_SalesOrderNo = TryCast(viewControl, ICustomParams_SalesOrderNo)
                        Dim ucontrolFilter As ICustomParams_SalesFilter = TryCast(viewControl, ICustomParams_SalesFilter)
                        'Muthu Nivetha M :: 13 Mar 19 :: For hold tickets restrictions
                        Dim ucontrolIsVoidedOrder As ICustomParams_IsVoided = TryCast(viewControl, ICustomParams_IsVoided)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Customer"
                                            ucontrol.CustomerNo = val(1)
                                        Case "Date"
                                            ucontronumber.CallHSDate = val(1)
                                        Case "Page"
                                            ucontrolPage.SalesPage = val(1)
                                        Case "Filter"
                                            ucontrolFilter.SalesFilter = val(1)
                                        Case "OrderNo"
                                            ucontrolOrderNo.SalesOrderNo = val(1)
                                        Case "IsVoidedOrder"        'Muthu Nivetha M :: 13 Mar 19 :: For hold tickets restrictions
                                            ucontrolIsVoidedOrder.IsVoided = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageHistory.ascx"
                        Dim ucontrol As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        Dim ucontronumber As ICustomParams_CallHSDate = TryCast(viewControl, ICustomParams_CallHSDate)
                        Dim ucontrolOrderNo As ICustomParams_SalesOrderNo = TryCast(viewControl, ICustomParams_SalesOrderNo)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Customer"
                                            ucontrol.CustomerNo = val(1)
                                        Case "Date"
                                            ucontronumber.CallHSDate = val(1)
                                        Case "OrderNo"
                                            ucontrolOrderNo.SalesOrderNo = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PagePOHistory.ascx"
                        Dim ucontrolPONumber As IPOParams_PONumber = TryCast(viewControl, IPOParams_PONumber)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "PONumber"
                                            ucontrolPONumber.PONumber = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageOrderSummary.ascx"
                        Dim ucontrolFilter As ICustomParams_SalesSummaryFilter = TryCast(viewControl, ICustomParams_SalesSummaryFilter)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Filter"
                                            ucontrolFilter.SalesSummaryFilter = val(1) + "=" + val(2) + "=" + val(3)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageADDEDITMISC.ascx"
                        Dim ucontrolCustomerNo As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        Dim ucontrolOrderNo As ICustomParams_SalesOrderNo = TryCast(viewControl, ICustomParams_SalesOrderNo)
                        Dim ucontrolOrderDetailID As ICustomParams_OrderDetailID = TryCast(viewControl, ICustomParams_OrderDetailID)
                        Dim ucontrolCalledFromVET As ICustomParams_CalledFromVET = TryCast(viewControl, ICustomParams_CalledFromVET)
                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Customer"
                                            ucontrolCustomerNo.CustomerNo = val(1)
                                        Case "OrderNo"
                                            ucontrolOrderNo.SalesOrderNo = val(1)
                                        Case "OrderDetailID"
                                            ucontrolOrderDetailID.OrderDetailID = val(1)
                                        Case "CalledFromVET"
                                            ucontrolCalledFromVET.CalledFromVET = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageUnAppliedAmountForCustomer.ascx"
                        Dim ucontrolCustomerNo_UnappliedAmount As ICustomParams_CustomerNumberUnappliedAmount = TryCast(viewControl, ICustomParams_CustomerNumberUnappliedAmount)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "CustomerNo"
                                            ucontrolCustomerNo_UnappliedAmount.CustomerNo = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageInvoiceTransactions.ascx"
                        Dim ucontrolInvoiceno As ICustomParams_InvoiceNumber = TryCast(viewControl, ICustomParams_InvoiceNumber)
                        Dim ucontrolIsARINVHistory As ICustomParams_IsARINVHistory = TryCast(viewControl, ICustomParams_IsARINVHistory)
                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Invoiceno"
                                            ucontrolInvoiceno.Invoiceno = val(1)
                                        Case "IsARINVHistory"
                                            ucontrolIsARINVHistory.IsARINVHistory = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageSPORD.ascx"
                        Dim ucontrolFilter As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Customer"
                                            ucontrolFilter.CustomerNo = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageCurrentOrdersForCustomer.ascx"
                        Dim ucontrolFilter As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Customer"
                                            ucontrolFilter.CustomerNo = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageOrderSaveProcess.ascx"
                        Dim ucontrolCustomerNo As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        Dim ucontrolOrderNo As ICustomParams_SalesOrderNo = TryCast(viewControl, ICustomParams_SalesOrderNo)
                        Dim ucontrolCalledFromVET As ICustomParams_CalledFromVET = TryCast(viewControl, ICustomParams_CalledFromVET)
                        'Muthu Nivetha M :: 13 Mar 19 :: For hold tickets restrictions
                        Dim ucontrolIsVoided As ICustomParams_IsVoided = TryCast(viewControl, ICustomParams_IsVoided)
                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Customer"
                                            ucontrolCustomerNo.CustomerNo = val(1)
                                        Case "OrderNo"
                                            ucontrolOrderNo.SalesOrderNo = val(1)
                                        Case "CalledFromVET"
                                            ucontrolCalledFromVET.CalledFromVET = val(1)
                                        Case "IsVoidedOrder"            'Muthu Nivetha M :: 13 Mar 19 :: For hold tickets restrictions
                                            ucontrolIsVoided.IsVoided = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageCustomer.ascx", "PageShipto.ascx", "PageCreditLimitsApproval.ascx"
                        Dim ucontrolFilter As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        ucontrolFilter.CustomerNo = controlPara
                    Case "PageCarrierCode.ascx"
                        Dim ucontrolCustomerNo As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        Dim ucontrolShiptoID As ICustomParams_ShiptoID = TryCast(viewControl, ICustomParams_ShiptoID)

                        For Each var In controlPara.Split("&")
                            If var.Trim.Length <> 0 Then
                                Dim val() As String = var.Split("=")
                                If val(1).Trim <> "" Then
                                    Select Case val(0)
                                        Case "Customer"
                                            ucontrolCustomerNo.CustomerNo = val(1)
                                        Case "Shipto"
                                            ucontrolShiptoID.ShiptoID = val(1)
                                    End Select
                                End If
                            End If
                        Next
                    Case "PageOpenOrders.ascx"
                        Dim ucontrolFilter As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        For Each var In controlPara.Split("&")
                            Dim val() As String = var.Split("=")
                            If val(1).Trim <> "" Then
                                Select Case val(0)
                                    Case "Customer"
                                        ucontrolFilter.CustomerNo = val(1)
                                End Select
                            End If
                        Next
                    Case "PageCustNetSales.ascx"
                        Dim ucontrolFilter As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        For Each var In controlPara.Split("&")
                            Dim val() As String = var.Split("=")
                            If val(1).Trim <> "" Then
                                Select Case val(0)
                                    Case "Customer"
                                        ucontrolFilter.CustomerNo = val(1)
                                End Select
                            End If
                        Next
                    Case "PageDuty.ascx"
                        Dim ucontrolFilter As ICustomParams_DutyTable = TryCast(viewControl, ICustomParams_DutyTable)
                        For Each var In controlPara.Split("&")
                            Dim val() As String = var.Split("=")
                            If val(1).Trim <> "" Then
                                Select Case val(0)
                                    Case "DutyTable"
                                        ucontrolFilter.DutyTable = val(1)
                                End Select
                            End If
                        Next
                    Case "PageSpordTrans.ascx"
                        Dim ucontrolCustNo As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        Dim ucontrolViewTransBySingle As ICustomParams_isTransviewForSingleF8 = TryCast(viewControl, ICustomParams_isTransviewForSingleF8)
                        Dim ucontrolTransbyF8SqlId As ICustomParams_SpordSqlIdForTrans = TryCast(viewControl, ICustomParams_SpordSqlIdForTrans)
                        Dim ucontrolTranscalledByF8 As ICustomParams_isTranscalledbyF8 = TryCast(viewControl, ICustomParams_isTranscalledbyF8)
                        For Each var In controlPara.Split("&")
                            Dim val() As String = var.Split("=")
                            If val(1).Trim <> "" Then
                                Select Case val(0)
                                    Case "CustomerNo"
                                        ucontrolCustNo.CustomerNo = val(1)
                                    Case "isTransviewForSingleF8"
                                        ucontrolViewTransBySingle.isTransviewForSingleF8 = val(1)
                                    Case "SpordSqlIdForTrans"
                                        ucontrolTransbyF8SqlId.SpordSqlIdForTrans = val(1)
                                    Case "isTranscalledbyF8"
                                        ucontrolTranscalledByF8.isTranscalledbyF8 = val(1)
                                End Select
                            End If
                        Next
                    Case "PageOrderAll.ascx"
                        Dim ucontrolFilter As ICustomParams_CustomerNo = TryCast(viewControl, ICustomParams_CustomerNo)
                        For Each var In controlPara.Split("&")
                            Dim val() As String = var.Split("=")
                            If val(1).Trim <> "" Then
                                Select Case val(0)
                                    Case "Customer"
                                        ucontrolFilter.CustomerNo = val(1)
                                End Select
                            End If
                        Next
                End Select
            End If
            pageHolder.Controls.Add(viewControl)
            Dim output As New StringWriter()
            HttpContext.Current.Server.Execute(pageHolder, output, True)
            Return output.ToString()
        Catch ex As Exception
            If ex.Message.IndexOf("does not exist") = -1 Then
                ErrorLogs.LogException(ex, "Error in Service::GetPage")
            End If
            Return ex.ToString()
        End Try
    End Function

#End Region

#Region "Global Date Session"
    <System.Web.Services.WebMethod(True)>
    Public Sub SaveDateSession(ByVal FromDate As String, ByVal ToDate As String)
        Try
            Dim DateSession(1) As String
            DateSession(0) = FromDate
            DateSession(1) = ToDate
            Session("DateSession") = DateSession
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveDateSession")
        End Try
    End Sub

    <System.Web.Services.WebMethod(True)>
    Public Function GetDateSession() As String()
        Try
            Dim DateSession(1) As String

            If Session("DateSession") Is Nothing Then
                Call SaveDateSession(Now().ToShortDateString(), Now().ToShortDateString())
            End If

            DateSession = Session("DateSession")
            Return DateSession
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDateSession")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Users"
    <System.Web.Services.WebMethod(True)>
    Public Sub ClearUserSession()
        Try
            Dim User As New User
            Session("UserDetails") = User
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearUserSession::PageUser")
        End Try
    End Sub
    ''' <summary>
    ''' recommemded by Chatgpt 2023-02-18 
    ''' </summary>
    ''' <returns></returns>
    Public Function IsUserLoggedIn() As Boolean
        Dim loggedInUser As User = TryCast(Session("LoginUserDetails"), User)
        If loggedInUser IsNot Nothing Then
            Return True
        End If
        Return False
    End Function

    ''' <summary>
    ''' Get user's notifications
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetUserNotifications() As UserNotification
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim userNotification As UserNotification
            userNotification = UserNotifications.GetUserNotifications(User.ID)
            Return userNotification
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserNotifications")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Get user's notifications
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetNotifications() As String
        Try
            'Dim User As New User
            'If Not Session("LoginUserDetails") Is Nothing Then
            '    User = Session("LoginUserDetails")
            'End If
            If IsUserLoggedIn() = True Then
                Dim userNotification As String
                userNotification = UserNotifications.GetNotifications()
                Return userNotification
            Else
                'ErrorLogs.LogException("User not logged in", "Error in Service::GetNotifications")
                Return Nothing

            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNotifications")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveNotification(ByVal text As String) As Boolean
        Try
            Return UserNotifications.SaveNotification(text)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveNotification")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Mark user's notifications as read
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function MarkUserNotificationsAsRead() As Boolean
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim result As Boolean
            result = UserNotifications.MarkUserNotificationsAsRead(User.ID)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::MarkUserNotificationsAsRead")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Get user's rights permission details for scanned orders and it's permission postitioned on 59 :: Abinaya :: 25Feb2019
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetUserTypeAccessDetails() As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim UserOrderDetailRow As String
            UserOrderDetailRow = Users.GetUserTypeAccessRightsDetails(User.ID, 59)
            Return UserOrderDetailRow
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserTypeAccessDetails::PageOrder")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Muthu Nivetha M :: 16Mar2020 :: :: Modified :: To save value for column Inventoryaccesstypes in tblusers
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveAndSendUserDetails(ByVal Name As String, ByVal Email As String, ByVal UserName As String, ByVal Password As String, ByVal IsActive As String, ByVal Landing As String, UserType As String, ByVal Permissions As String, ByVal AgencyCode As String, ByVal Warehouseid As String, ByVal IsAdmin As String, ByVal CustomerNo As String, ByVal Division As String, ByVal SalesPerson As String, ByVal IsGrowerDelete As String, ByVal IsGrowerlock As String, ByVal IsSetupsFile As String, ByVal IsSetupsReports As String, ByVal IsSetupsAdmin As String, ByVal IsSetupsImport As String, ByVal ORDER As String, ByVal OldUserID As String, ByVal InventoryAccesstypes As String, ByVal isDuplicateBoxMaintance As Boolean) As User
        Try
            'checkusersessionIsActive:start
            'Dim SessionStatus As String = ""
            'SessionStatus = CheckLoginSessionIsActive("Admin")
            'If SessionStatus = "InActive" Then
            '    Return Nothing
            'End If
            'end

            Dim User As New User

            If Not Session("UserDetails") Is Nothing Then
                User = Session("UserDetails")
            End If
            Dim UserID As String = ""

            UserID = Users.SaveOrUpdateUserDetails(Name.ToUpper, Email, UserName, Password, IsActive, Landing, UserType, Convert.ToInt32(OldUserID), User.FarmList, Permissions, AgencyCode.ToUpper(), Warehouseid, IsAdmin, CustomerNo, Division, SalesPerson, IsGrowerDelete, IsGrowerlock, IsSetupsFile, IsSetupsReports, IsSetupsAdmin, IsSetupsImport, ORDER, InventoryAccesstypes, isDuplicateBoxMaintance)
            UserID = IIf(UserID = "valid", Convert.ToInt32(OldUserID), UserID)

            If (Not UserID.Contains("UNIQUE KEY constraint")) Then
                Return Users.SendUserCredentials(UserID)
            Else
                User.ErrorMessage = UserID
                Return User
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveAndSendUserDetails::PageUser")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Muthu Nivetha M :: 16Mar2020 :: :: Modified :: To save value for column Inventoryaccesstypes in tblusers
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveOrUpdateUserDetails(ByVal Name As String, ByVal Email As String, ByVal UserName As String, ByVal Password As String, ByVal IsActive As String, ByVal Landing As String, UserType As String, ByVal Permissions As String, ByVal AgencyCode As String, ByVal Warehouseid As String, ByVal IsAdmin As String, ByVal CustomerNo As String, ByVal Division As String, ByVal SalesPerson As String, ByVal IsGrowerDelete As String, ByVal IsGrowerlock As String, ByVal IsSetupsFile As String, ByVal IsSetupsReports As String, ByVal IsSetupsAdmin As String, ByVal IsSetupsImport As String, ByVal ORDER As String, ByVal OldUserID As String, ByVal InventoryAccesstypes As String, ByVal isDuplicateBoxMaintance As Boolean) As String
        Try
            Dim User As New User
            If Not Session("UserDetails") Is Nothing Then
                User = Session("UserDetails")
            End If
            Return Users.SaveOrUpdateUserDetails(Name.ToUpper, Email, UserName, Password, IsActive, Landing, UserType, Convert.ToInt32(OldUserID), User.FarmList, Permissions, AgencyCode.ToUpper(), Warehouseid, IsAdmin, CustomerNo, Division, SalesPerson, IsGrowerDelete, IsGrowerlock, IsSetupsFile, IsSetupsReports, IsSetupsAdmin, IsSetupsImport, ORDER, InventoryAccesstypes, isDuplicateBoxMaintance)
        Catch ex As Exception
            ErrorLogs.LogException(ex, IIf(OldUserID = "0", "Error in Service::Save::SaveOrUpdateUserDetails::PageUser", "Error in Service::Update::SaveOrUpdateUserDetails::PageUser"))
            Return IIf(OldUserID = "0", ex.Message.ToString(), Nothing)
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUserByID(ID As Integer) As User
        Try
            Dim UserDetails As User = Users.GetUserByID(ID)
            Session("UserDetails") = UserDetails
            Return UserDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserByID::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetUserList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1



            Dim obj As New Users.GetUsersDetails()
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = obj.GetUsers(whereCondition, sortExp, 1, splitExportcsv(2))
                If data.Count > 0 Then

                    If data(0).ErrorMessage = "" Then
                        Dim dt1 As DataTable

                        dt1 = ConvertToDataTable(data)

                        Dim selectedColumns As String() =
                        {"Name", "UserName", "UserType", "Email", "Landing", "FarmCode", "LastLogin", "IsActive"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("LastLogin").ColumnName = "Last Login"
                        dt.Columns("IsActive").ColumnName = "Active?"

                        'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        'dtCloned.Columns("LastLogin").DataType = GetType(String)
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else

                Dim data As List(Of User) = obj.GetUsers(whereCondition, sortExp, start, rp)


                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", obj.TotalRows.ToString()),
                                                    data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                                    New XElement("cell", "<b><a href='#' id='deleteuser_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                                    New XElement("cell", "<a href='#' id='edituser_" & row.ID & "'>" & row.Name & "</a>"),
                                                    New XElement("cell", row.UserName),
                                                    New XElement("cell", row.UserType),
                                                    New XElement("cell", row.Email),
                                                    New XElement("cell", row.Landing),
                                                    New XElement("cell", "<span style='word-wrap: break-word;white-space: normal;'>" + row.FarmCode + "</span>"),
                                                    New XElement("cell", row.LastLogin),
                                                    New XElement("cell", "<img style='Cursor:pointer;' id='isactive_" & row.ID.ToString() & "' src='" & IIf(row.IsActive, "images/check-on.png", "images/check-off.png") & "'/>")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserList::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetNameAuto(ByVal Name As String) As List(Of User)
        Try
            Return Users.GetNameAuto(Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNameAuto::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUserNameAuto(ByVal UserName As String) As List(Of User)
        Try
            Return Users.GetUserNameAuto(UserName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserNameAuto::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetLandingAuto(ByVal Landing As String) As List(Of User)
        Try
            Return Users.GetLandingAuto(Landing)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetLandingAuto::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadUserType() As List(Of UserType)
        Try
            Return UserTypes.LoadUserType()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadUserType::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function Encrypt(ByVal OriginalText As String) As String
        Try
            Return Users.Encrypt(OriginalText)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::Encrypt::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function Decrypt(ByVal cipherText As String) As String
        Try
            Return Users.Decrypt(cipherText)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::Decrypt::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ValidateLogin(ByVal Username As String, ByVal Password As String) As String
        Dim ReturnValue As String = ""

        Try

            Dim UserDetails As User = Users.ValidateLogin(Username, Password)
            If Not UserDetails Is Nothing Then
                If String.IsNullOrEmpty(UserDetails.ORDER) Then
                    'following instruction Is in case ORDER column Is empty, does Not have N Or Y string.
                    UserDetails.ORDER = "NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN NNNNNNNNNNNNNNNNNNNN"
                End If
                If (UserDetails.UserName <> Nothing Or UserDetails.UserName <> "") And UserDetails.IsActive <> False Then
                    Dim UserFeatures As List(Of Feature) = Features.GetFeature()
                    Session("LoginUserFeatures") = UserFeatures
                    If UserDetails.UserTypeID = "1" Then
                        ReturnValue = "admin"
                        Session("IsAdmin") = True
                        Session("LoginUserDetails") = UserDetails
                        'Session("LoginAdminDetails") = UserDetails
                    ElseIf UserDetails.Admin = True Then
                        Session("IsAdmin") = True
                        ReturnValue = "user~" + UserDetails.Landing
                        Session("LoginUserDetails") = UserDetails
                        'ElseIf UserDetails.UserTypeID = "2" Then
                        '    Session("IsAdmin") = False
                        '    ReturnValue = "user~" + UserDetails.Landing
                        '    Session("LoginUserDetails") = UserDetails
                    Else
                        Session("IsAdmin") = False
                        ReturnValue = "user~" + UserDetails.Landing
                        Session("LoginUserDetails") = UserDetails
                    End If

                    Logs.Savelog(UserDetails.ID, "Login", "ValidateLogin", "Logged In", UserDetails.ID.ToString())
                    'Users.UpdateLastLoggedIn(UserDetails.ID, DateTime.Now)
                ElseIf (UserDetails.Email = Nothing And UserDetails.UserName = Nothing And UserDetails.IsActive = False) Then
                    ReturnValue = "invalid"
                ElseIf UserDetails.IsActive = False Then
                    ReturnValue = "InActive"
                End If

                Return ReturnValue
            End If

            ReturnValue = "invalid"

            Return ReturnValue
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ValidateLogin::PageLogin")
            Return Nothing
        End Try
    End Function




    '<System.Web.Services.WebMethod(True)>
    'Public Function CheckIsAdmin() As Boolean
    '    Try
    '        If Session("IsAdmin") <> Nothing Then
    '            Return True
    '        Else
    '            Return False
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::CheckIsAdmin::PageUser")
    '        Return Nothing
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoginNotification(ByVal LoggedUserName As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If

            'If Not Session("LoginUserDetails") Is Nothing Then
            '    User = Session("LoginUserDetails")
            'ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            '    User = Session("LoginAdminDetails")
            'End If

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim strIPAddress As String

            ' strIPAddress = System.Net.Dns.GetHostByName(strHostName).AddressList(0).ToString()
            strIPAddress = LocalIPAddress()

            Dim BodyMessage As String = ""
            If (User.Email <> Nothing And User.UserName <> Nothing And User.IsActive <> False) Then
                'If (User.Email <> Nothing And User.UserName <> Nothing) Then
                Dim Subject As String = CompanyName + " WEB Login. User: " + User.UserName + ""

                '  BodyMessage = "<p><font face='Consolas' color='black'>Blooms USA WEB Login <br/>Username: <a href='mailto:" + User.Email + "'>" + User.UserName +
                '"</a><br/>Name: " + User.Name + "<br/>IP: " + strIPAddress + "<br/>Computername: " +
                'Split(System.Net.Dns.Resolve(HttpContext.Current.Request.ServerVariables("remote_addr")).HostName, ".")(0).ToString() + "</font></p>"

                BodyMessage += Users.ReadFiles("LoginNotification.txt")
                BodyMessage = BodyMessage.Replace("~CompanyName~", CompanyName).Replace("~UserName~", User.UserName).Replace("~Name~", User.Name).Replace("~IP~", strIPAddress).Replace("~Email~", User.Email)
                Return Logs.VendorEmailLogs(User, BodyMessage, "", Subject, "login")

                'ElseIf (User.Email = Nothing And User.UserName = Nothing And User.IsActive = False) Then
                '    Return "invalid"
                'ElseIf (User.IsActive = False) Then
                '    System.Web.HttpContext.Current.Session("LoginAdminDetails") = Nothing
                '    System.Web.HttpContext.Current.Session("LoginUserDetails") = Nothing
                '    Return "InActive"
            Else
                Return "invalid"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoginNotification::PageLogin")
            Return Nothing
        End Try
    End Function

    Public Shared Function LocalIPAddress() As String
        Try
            Dim context As System.Web.HttpContext = System.Web.HttpContext.Current
            Dim sIPAddress As String = context.Request.ServerVariables("HTTP_X_FORWARDED_FOR")
            If String.IsNullOrEmpty(sIPAddress) Then
                Return context.Request.ServerVariables("REMOTE_ADDR")
            Else
                Dim ipArray As String() = sIPAddress.Split(New [Char]() {","c})
                Return ipArray(0)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LocalIPAddress::PageLogin")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteUser(ByVal ID As Integer) As String
        Try
            Return Users.DeleteUser(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteUser::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleUsersIsActive(ByVal ID As Integer, ByVal IsActive As String) As String
        Try
            Return Users.ToggleUsersIsActive(ID, IsActive)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleUsersIsActive::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUsersFormRights(ByVal UserID As Integer, ByVal Form As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            If User.UserType.ToLower() = "admin" Then
                Return Form
            Else
                Return Users.GetUserFormRights(UserID, Form)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUsersFormRights::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateRPforUser(ByVal RP As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Return Users.UpdateRPforUser(User.ID, RP, User.UserName, Decrypt(User.Password))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateRPforUser::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetVendorListByID() As List(Of User)
        Try
            Return ManualPOHeaders.GetVendorListByID()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetVendorListByID::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SendUserCredentials(ByVal UserID As String) As User
        Try
            Return Users.SendUserCredentials(UserID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SendUserCredentials::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UsersCredentailEmailLogs(ByVal ToEmails As String, ByVal Subject As String, ByVal BodyContent As String, ByVal UserEmailid As String) As String
        Try
            Return Logs.UsersCredentailEmailLogs(ToEmails, Subject, BodyContent, UserEmailid)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UsersCredentailEmailLogs::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateUserPassword(ByVal UserID As Integer, ByVal Password As String) As String
        Try
            Return Users.UpdateUserPassword(UserID, Password)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateUserPassword::Dashboard")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUserPageList(ByVal UserID As Integer) As User
        Try
            Return Users.GetUserPageList(UserID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserPageList::Dashboard")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadSalesPersonDetails() As List(Of SalesPersons)
        Try
            Return SalesPerson.LoadSalesPersonDetails()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadSalesPersonDetails::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadSalesPersonOnlyinCustomertable() As List(Of SalesPersons)
        Try
            Return SalesPerson.LoadSalesPersonOnlyinCustomertable()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadSalesPersonDetails::PageUser")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="UserName"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ResetPassword(ByVal UserName As String) As String
        Try
            Return Users.ResetPassword(UserName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ResetPassword")
            Return Nothing
        End Try
    End Function

#End Region

#Region "ConfirmedPOs"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetConfirmedPOList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                       ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument

        Try
            Dim newDoc As New XmlDocument()

            Dim DateSession(1) As String
            If (Not Session("DateSession") Is Nothing) Then
                DateSession = Session("DateSession")
            Else
                DateSession = Nothing
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If (DateSession Is Nothing) Then
                ' FromDate = DateTime.Now.ToString("MM/dd/yyyy")
                ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            Else
                FromDate = DateSession(0).ToString()
                ToDate = DateSession(1).ToString()
            End If
            Dim LoginUserDetails As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") Then
            '    FilterFarms = ""
            'End If
            'If FilterFarms <> "" Then
            '    FilterFarms = "Farm in (" + FilterFarms + ")"
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
                Filter = Filter.Replace("COMPLETED", "")
            Else
                FilterFarms = ""
            End If

            Dim DateCondition As String = ""

            If FromDate = "" Or FromDate = DateTime.Now.ToString("MM/dd/yyyy") Then '' And ToDate = DateTime.Now.ToString("MM/dd/yyyy")
                'DateCondition = "(CONVERT(DATE,POQ.SHIPDATE,103) = CONVERT(DATE,'" + ToDate + "',101) or (CONVERT(DATE,POQ.SHIPDATE,103) < CONVERT(DATE,'" + ToDate + "',101) and poq.awb='' and poq.PROSTATUS = 'CONFIRMED')) "
                DateCondition = "CONVERT(DATE,POQ.SHIPDATE,103) = CONVERT(DATE,'" + ToDate + "',101) "
            Else
                DateCondition = "CONVERT(DATE,POQ.SHIPDATE,103) >= CONVERT(DATE,'" + FromDate + "',101) " + " And " + " CONVERT(DATE,POQ.SHIPDATE,103) <= CONVERT(DATE,'" + ToDate + "',101)"
            End If

            If Filter <> "" Then
                DateCondition += " AND " + Filter
            End If

            If qtype.ToLower() = "farm" And query <> "" Then
                If Not Session("UserFarms") Is Nothing Then
                    Dim assignedFarms As List(Of Farm) = Session("UserFarms")
                    Dim hasFarm As Boolean = assignedFarms.Any(Function(cus) cus.Farm = query)
                    If hasFarm = False Then
                        page = 0
                        rp = 0
                    End If
                End If
            End If

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing
                Dim start As Integer = ((page - 1) * rp) + 1
                rp -= 1
                Dim SortExp As String
                SortExp = sortname + " " + sortorder
                data = DAOPO.GetConfirmedPOListForGrid(DateCondition, SortExp, start, FilterFarms)

                Dim dt1 As DataTable
                dt1 = ConvertToDataTable(data)

                If dt1.Rows.Count > 0 Then
                    If data(0).ErrorMessage = "" Then
                        Dim selectedColumns As String() =
                        {"Farm", "PoNumber", "Type", "ORD", "ShipDate", "Airport", "Flower", "QtyBox", "Uom", "QtyxBox", "Unitcosq", "QtyBconf", "CustNumber", "BoxNumber",
                         "PassName", "AWB", "HAWB", "Invoice", "BreakDown", "boxcode", "Upc", "Length", "Width", "Height", "Totalrb"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("PoNumber").ColumnName = "PO#"
                        dt.Columns("Type").ColumnName = " "
                        dt.Columns("ORD").ColumnName = "Line"
                        dt.Columns("QtyBox").ColumnName = "Boxes"
                        dt.Columns("QtyXBox").ColumnName = "Pack"
                        dt.Columns("UnitCosq").ColumnName = "Cost"
                        dt.Columns("QtyBConf").ColumnName = "Conf"
                        dt.Columns("Length").ColumnName = "L"
                        dt.Columns("Width").ColumnName = "W"
                        dt.Columns("Height").ColumnName = "H"
                        dt.Columns("Totalrb").ColumnName = "Totalrb"
                        dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        dtCloned.Columns("ShipDate").DataType = GetType(String)
                        dtCloned.Columns("AWB").DataType = GetType(String)
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else
                Dim start As Integer = ((page - 1) * rp) + 1
                rp -= 1
                Dim SortExp As String
                SortExp = sortname + " " + sortorder

                Dim users As User = Session("LoginUserDetails")

                Dim data As List(Of BOPO)

                data = DAOPO.GetConfirmedPOListForGrid(DateCondition, SortExp, start, FilterFarms)

                'If data.Length > 0 Then

                If data(0).ErrorMessage = "" Then
                    Dim FlowerColorVisibility As Boolean = True
                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")

                    Dim UnassignedFarmsList As New List(Of Farm)
                    UnassignedFarmsList = Farms.GetUnassignedFarms()
                    Dim TotalRowCount As Integer = 0
                    Dim dt1 As DataTable
                    dt1 = ConvertToDataTable(data)
                    If dt1.Rows.Count > 0 Then
                        TotalRowCount = dt1.Rows.Count - 1
                    End If

                    'New XElement("cell", GetFarmForConfirmedPO(row.FarmName, row.Farm, row.UserName)),
                    'New XElement("cell", String.Format(IIf(Not UnassignedFarmsList.Find(Function(c) c.Farm = row.Farm) Is Nothing, "<div class='flowerDescription' id='divunassignedFarm_" + row.Farm + "' style='padding-bottom: 3px;color:Red;cursor:pointer;font-weight:bold;text-decoration: underline;'>" & row.Farm & "</div>", GetFarmForConfirmedPO(row.FarmName, row.Farm)))),
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                    New XElement("rows", New XElement("page", page.ToString()),
                    New XElement("total", TotalRowCount),
                    data.Select(Function(row) New XElement("row", New XAttribute("id", If(row.DetailID <> 0, row.DetailID.ToString(), "0")),
                    New XAttribute("title", IIf(row.FlowerFlag <> 0 Or row.DetailID = 0, "", "Must import flower codes")), New XAttribute("style", IIf(row.FlowerFlag <> 0 Or row.DetailID = 0, "", "background:#FF9B9B")),
                    New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='teselect_" & row.DetailID.ToString() & "' src='images/check-off.png' />")),
                    New XElement("cell", IIf(Not UnassignedFarmsList.Find(Function(c) c.Farm.Trim() = row.Farm.Trim()) Is Nothing,
                                             "<div class='flowerDescription' id='divunassignedFarm_" + row.Farm + "' style='padding-bottom: 3px;color:Red;cursor:pointer;font-weight:bold;text-decoration: underline;'>" & row.Farm & "</div>",
                                             GetFarmForConfirmedPO(row.FarmName, row.Farm, row.UserName))),
                    New XElement("cell", row.PONumber),
                    New XElement("cell", row.Type),
                    New XElement("cell", row.Ord),
                    New XElement("cell", IIf(row.ShipDate = DateTime.Now.ToString("MM/dd/yyyy"), "<div style='background-color: #Red;margin-top: -5px;margin-left: -5px;padding-bottom: 3px;margin-right: -5px;;background-color:Green;'>" + row.ShipDate + "</div>", row.ShipDate)),
                    New XElement("cell", row.Airport),
                    New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='cursor:pointer;color:" + row.ForeColor.ToString() + "' title='" & row.Flower & "'>" & row.Flower & "</a>", "<a style='cursor:pointer;' title='" & row.Flower & "'>" & row.Flower & "</a>")),
                    New XElement("cell", IIf(row.QTYBOX = "0", "0", row.QTYBOX)),
                    New XElement("cell", row.UOM),
                    New XElement("cell", IIf(row.QtyXBox = "0", "", row.QtyXBox)),
                    New XElement("cell", IIf(row.UnitCosq = "0", "", row.UnitCosq.ToString("#,##0.0000"))),
                    New XElement("cell", "<a id='btnconfirmconf_" + row.DetailID.ToString() + "'>" + IIf(Convert.ToInt32(row.QtyBConf) = 0, "0", row.QtyBConf.ToString()) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(Convert.ToInt32(row.QtyBConf) = 0, "0", row.QtyBConf.ToString()) & "' id='editconf_" & row.DetailID.ToString() & "'></input>"),
                    New XElement("cell", IIf(row.CustNumber = "0", "", row.CustNumber)),
                    New XElement("cell", row.BoxNumber),
                    New XElement("cell", row.PassName),
                    New XElement("cell", "<a id='divawb_" + row.DetailID.ToString() + "'>" + row.AWB + "</a>"),
                    New XElement("cell", "<a id='divhawb_" + row.DetailID.ToString() + "'>" + row.HAWB + "</a>"),
                    New XElement("cell", "<a id='divinvoice_" + row.DetailID.ToString() + "'>" + IIf(row.Invoice = "0", "", row.Invoice) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' maxlength='7' placeholder='" & IIf(row.Invoice = "0", "", row.Invoice) & "' id='editInvoice_" & row.DetailID.ToString() & "'></input>"),
                    New XElement("cell", "<a title='" + row.BreakDown + "' id='btnconfirmbreakdown_" + row.DetailID.ToString() + "'>" + row.BreakDown + "</a><input type='text' style='display:none;width:150px' value='" + row.BreakDown + "' maxlength='126' id='editconfirmbreakdown_" & row.DetailID.ToString() & "'></input>"),
                    New XElement("cell", row.BoxCode),
                    New XElement("cell", "<a style='text-decoration:underline;color:" + If(row.Upc.Length <= "10", "none", "Red") + ";' href='#' id='UPCClicked_" & row.DetailID.ToString() & "'>" & row.Upc & "</a>"),
                    New XElement("cell", row.CustomerPO),
                    New XElement("cell", IIf(row.AWB = "", "<a style='text-decoration:underline' href='#' id='SplitBoxes_" & row.DetailID.ToString() & "'>Split</a>", "")),
                    New XElement("cell", "<a id='btnconfirmLength_" + row.DetailID.ToString() + "'>" + IIf(row.Length = "0.0", "0", row.Length) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(row.Length = "0.0", "0", row.Length) & "' id='editLength_" & row.DetailID.ToString() & "'></input>"),
                    New XElement("cell", "<a id='btnconfirmHeight_" + row.DetailID.ToString() + "'>" + IIf(row.Height = "0.0", "0", row.Height) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(row.Height = "0.0", "0", row.Height) & "' id='editHeight_" & row.DetailID.ToString() & "'></input>"),
                    New XElement("cell", "<a id='btnconfirmWidth_" + row.DetailID.ToString() + "'>" + IIf(row.Width = "0.0", "0", row.Width) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(row.Width = "0.0", "0", row.Width) & "' id='editWidth_" & row.DetailID.ToString() & "'></input>"),
                    New XElement("cell", row.Totalrb)))))
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1

                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = data.Last().UnitCosq.ToString("#,##0.00")
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(26).InnerText = ""
                    Return newDoc
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    'If data(0).ErrorMessage.Contains("'f_poh.dbf' does not exist") = False Then
                    '    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'End If
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetConfirmedPOList::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmForConfirmedPO(ByVal FarmName As String, ByVal FarmCode As String, ByVal UserName As String) As String
        'Dim UserName As String = ConfirmedPOs.GetFarmAssignedUserName(FarmCode)
        Dim str As String = "<a style='cursor:pointer;' title='" & IIf(FarmName = "", "User Name: " & UserName, "Farm Name: " & FarmName & " | User Name: " & UserName) & "'>" + FarmCode + "</a>"
        Return str
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelected(ByVal Selected As String, ByVal ID As String, ByVal ORD As String) As String
        Try
            Dim SelectedPo As New ArrayList
            If Not Session("SelectedPOs") Is Nothing Then
                SelectedPo = Session("SelectedPOs")
            End If
            Dim PODetails = SelectedPo.Cast(Of String()).Where(Function(i) i(0).Equals(ID + "_" + ORD)).FirstOrDefault()
            If Not PODetails Is Nothing Then
                If Selected = "0" Then
                    SelectedPo.Remove(PODetails)
                End If
            Else
                If Selected = "1" Then
                    SelectedPo.Add(New String() {ID + "_" + ORD.ToString()})
                End If
            End If
            Session("SelectedPOs") = SelectedPo

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelected::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedAll(ByVal Selected As String, ByVal Filter As String) As String
        Try
            Dim SelectedPOs As New ArrayList
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") Then
            '    FilterFarms = ""
            'End If
            'If FilterFarms <> "" Then
            '    FilterFarms = "Farm in (" + FilterFarms + ")"
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
            Else
                FilterFarms = ""
            End If

            Filter = ConfirmedPOFilters(Filter)
            'Dim data As Array

            'Dim data = obj.LoadPurchaseOrderDetailsByFilter(Filter, FilterFarms)
            '    If data.Length > 0 Then

            '        If data(0).ErrorMessage = "" Then

            '            If Selected = "0" Then
            '                Session("SelectedPOs") = SelectedPOs
            '            End If
            '            If Selected = "1" Then
            '                For Each obj1 In data
            '                    SelectedPOs.Add(New String() {obj1.POKEY.ToString() + "_" + obj1.ORD})
            '                Next
            '                Session("SelectedPOs") = SelectedPOs
            '            End If
            '            Return "Valid"
            '        Else
            '            Dim User As New User
            '            If Not Session("LoginUserDetails") Is Nothing Then
            '                User = Session("LoginUserDetails")
            '            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            '                User = Session("LoginAdminDetails")
            '            End If
            '            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
            '            Return Nothing
            '        End If
            '    Else
            '        Return Nothing
            '    End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedAll::PageConfirmedPO")
            Return Nothing
        End Try
        Return Nothing
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Sub ClearSelectedPOsSession()
        Try
            Dim SelectedPOs As New ArrayList
            Session("SelectedPOs") = SelectedPOs
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearSelectedPOsSession::PageConfirmedPO")
        End Try
    End Sub

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateMAWBAndHAWB(ByVal MAWB As String, ByVal HAWB As String, ByVal InvoiceNumber As String, ByVal SelectedPOs As String) As String
        Dim ConfirmedPODateCondition As String = ConfirmedPOFilters("")
        Dim TotalRecordsChoosen As Integer = 0
        Try
            Dim result As String = ""
            Dim UpdatingDetails As String = ""
            Dim POKeys As String = ""
            AppendLog(SelectedPOs, "UpdateMAWBAndHAWB Start")

            UpdatingDetails = "<PODetails>"
            For Each POData In SelectedPOs.Split(",")
                UpdatingDetails += "<PO><POQId>" + POData + "</POQId></PO>"

                POKeys += IIf(POKeys.Length <= 0, "", " OR ")
                POKeys += "(POQId=" + POData + ") "
            Next
            If POKeys <> "" Then
                TotalRecordsChoosen = SelectedPOs.Split(",").Count
            End If
            AppendLog(POKeys, "UpdateMAWBAndHAWB")
            UpdatingDetails += "</PODetails>"
            AppendLog(UpdatingDetails, "Exporting Details")
            result = DAOPO.UpdateMAWBAndHAWB(MAWB.ToUpper(), HAWB.ToUpper(), SelectedPOs, InvoiceNumber)
            If result = "valid" Then
                Dim DetailsList = Nothing
                Dim data = Nothing
                data = DAOPO.GetPurchaseOrderDetailsBySelectedPokey(SelectedPOs)

                Dim dt1 As DataTable
                dt1 = ConvertToDataTable(data)

                If dt1.Rows.Count > 0 Then
                    If data(0).ErrorMessage = "" Then
                        DetailsList = New XElement("ManualPODetails",
                    From ManualPODetails In dt1.Rows
                    Select New XElement("ManualPO", "",
                    New XElement("Farm", ManualPODetails("Farm")),
                    New XElement("Flower", ManualPODetails("Flower")),
                    New XElement("Quantity", Convert.ToInt32(ManualPODetails("QTYBOX"))),
                    New XElement("UOM", ManualPODetails("UOM")),
                    New XElement("Units", ManualPODetails("qtyxbox")),
                    New XElement("TotalUnits", (Convert.ToInt32(ManualPODetails("QTYBOX") * ManualPODetails("qtyxbox")))),
                    New XElement("UnitsPerBunch", ManualPODetails("UnitsPerBunch")),
                    New XElement("CostPerUnits", ManualPODetails("UnitCosq")),
                    New XElement("FlowerName", ManualPODetails("FlowerName")),
                    New XElement("FlowerCategory", ManualPODetails("FlowerCategory")),
                    New XElement("FobConsig", ManualPODetails("FOB")),
                    New XElement("shipdate", ManualPODetails("ShipDate")),
                    New XElement("BoxNumber", ManualPODetails("BoxNumber")),
                    New XElement("PONumber", ManualPODetails("PONumber")),
                    New XElement("Breakdown", ManualPODetails("Breakdown")),
                    New XElement("Customer", ManualPODetails("CustNumber")),
                    New XElement("BoxCode", ManualPODetails("BoxCode")),
                    New XElement("InvoiceNumber", InvoiceNumber.ToUpper()),
                    New XElement("MAWB", MAWB),
                    New XElement("HAWB", HAWB),
                    New XElement("SPORDID", ManualPODetails("SPORDID")),
                    New XElement("ORDER2ID", ManualPODetails("ORDER2ID")),
                    New XElement("WH", ManualPODetails("WH")),
                    New XElement("POQId", ManualPODetails("DetailID"))))
                        Dim LoginUserID As Integer = 0
                        If (Not Session("LoginUserDetails") Is Nothing) Then
                            Dim LoginUserDetails As User = Session("LoginUserDetails")
                            LoginUserID = LoginUserDetails.ID
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            Dim LoginUserDetails As User = Session("LoginAdminDetails")
                            LoginUserID = LoginUserDetails.ID
                        End If
                        Dim Farm As String = ConfirmedPOs.ExportConfirmedPOtoManualPO(LoginUserID, MAWB, DetailsList.ToString(), POKeys)
                        Return Farm
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "error"
                End If
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return "error"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateMAWBAndHAWB::PageConfirmedPO ; DateRange : " + ConfirmedPODateCondition + " And TotalRecords selected:" + TotalRecordsChoosen.ToString() + "")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function RemoveMAWBAndHAWB(ByVal SelectedPOs As String) As String
        'Dim ConfirmedPODateCondition As String = ConfirmedPOFilters("")
        Dim TotalRecordsChoosen As Integer = 0
        Try
            Dim result As String = ""
            Dim UpdatingDetails As String = ""
            Dim POKeys As String = ""
            UpdatingDetails = "<PODetails>"
            For Each POData In SelectedPOs.Split(",")
                UpdatingDetails += "<PO><POQId>" + POData + "</POQId></PO>"

                POKeys += IIf(POKeys.Length <= 0, "", " OR ")
                POKeys += "(POQId=" + POData + ") "
            Next
            If POKeys <> "" Then
                TotalRecordsChoosen = SelectedPOs.Split(",").Count
            End If
            AppendLog(POKeys, "UpdateMAWBAndHAWB")
            UpdatingDetails += "</PODetails>"
            AppendLog(UpdatingDetails, "Exporting Details")
            'End If

            Dim DetailsList = Nothing
            Dim data = Nothing
            data = DAOPO.GetPurchaseOrderDetailsBySelectedPokey(SelectedPOs)

            Dim dt1 As DataTable
            dt1 = ConvertToDataTable(data)

            If dt1.Rows.Count > 0 Then
                If data(0).ErrorMessage = "" Then
                    DetailsList = New XElement("ManualPODetails",
                    From ManualPODetails In dt1.Rows
                    Select New XElement("ManualPO", "",
                    New XElement("Farm", ManualPODetails("Farm")),
                    New XElement("shipdate", ManualPODetails("ShipDate")),
                    New XElement("BoxNumber", ManualPODetails("BoxNumber")),
                    New XElement("AWB", ManualPODetails("AWB"))))
                    Dim LoginUserID As Integer = 0
                    If (Not Session("LoginUserDetails") Is Nothing) Then
                        Dim LoginUserDetails As User = Session("LoginUserDetails")
                        LoginUserID = LoginUserDetails.ID
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        Dim LoginUserDetails As User = Session("LoginAdminDetails")
                        LoginUserID = LoginUserDetails.ID
                    End If
                    Dim Farm As String = ConfirmedPOs.RemoveExportedRecordFromManualPO(LoginUserID, DetailsList.ToString(), POKeys)

                    result = DAOPO.RemoveMAWBAndHAWB(UpdatingDetails)

                    If result = "valid" Then
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                        Return "error"
                    End If
                    Return "success"
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    Return "error"
                End If
            Else
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::RemoveMAWBAndHAWB")
            Return "error"
        End Try
    End Function


    ''Anitha::28-Jun-2016:: Rename ExportToExcelbyCloseXML to ExporttoExcel
    Public Shared Function ExporttoExcel(dt As DataTable, Filename As String, Optional ByVal FileFormat As String = "", Optional ByVal FromDate As String = "", Optional ByVal ToDate As String = "") As String 'ExportToExcelbyCloseXML
        Try
            Dim FolderPath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()
            Dim Foldername = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim FulFilePath = FolderPath + Foldername + "\\"
            Dim EmailSubject As String = "REPORT"

            Dim User As New User
            'checkusersessionIsActive:start
            User = System.Web.HttpContext.Current.Session("LoginUserDetails")

            Dim ToEmail = User.Email

            Dim companyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            Dim mySplit() As Char = "$".ToCharArray
            'split the filename (0)-original name : (1)-name checked for excel formatting
            Dim OrigFileName() As String = Filename.Split(mySplit, StringSplitOptions.RemoveEmptyEntries)

            Dim FulFilename As String = If(OrigFileName(0).Length >= 18, OrigFileName(0).Substring(0, 18), OrigFileName(0)) + "_" + DateTime.Now.ToString("HHmmss") + ".xlsx"
            Dim strRequest As String = FulFilePath + FulFilename
            Dim wb As New XLWorkbook()
            Dim ws = wb.Worksheets.Add(FulFilename)

            If Not String.IsNullOrEmpty(FileFormat) Then
                'Dim exportPDF = New ExportSSRS()
                FulFilename = If(OrigFileName(0).Length >= 18, OrigFileName(0).Substring(0, 18), OrigFileName(0)) + "_" + DateTime.Now.ToString("HHmmss") + FileFormat
                strRequest = FulFilePath + FulFilename
                'Return New ExportSSRS().ExportToPDF(dt, strRequest)
                Return Path.GetFileName(New ExportSSRS().ExportToPDF(dt, strRequest))
            End If

            Dim subjectFileName As String = ""
            If OrigFileName.Length > 1 Then
                subjectFileName = OrigFileName(1) + " Report"
            Else
                subjectFileName = "Report"
            End If

            'excel comma separtor for Amount column in grower screen
            If OrigFileName.Length > 1 Then
                If OrigFileName(1) = "Farm" Then    'from GrowerFarmGrid
                    ws.Range("J3", "J" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                ElseIf OrigFileName(1) = "FarmDetail" Then  'from GrowerDetailGrid
                    ws.Range("J3", "J" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                ElseIf OrigFileName(1) = "Inv" Then 'from GrowerInvoiceDetailGrid
                    ws.Range("E3", "E" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                ElseIf OrigFileName(1) = "CustDet" Then
                    ws.Range("I3", "I" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("J3", "J" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("K3", "K" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                ElseIf OrigFileName(1) = "ARInquiry" Then
                    ws.Range("I3", "I" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("J3", "J" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("K3", "K" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("L3", "L" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("M3", "M" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("N3", "N" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("O3", "O" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("P3", "P" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("Q3", "Q" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                ElseIf OrigFileName(1) = "ARINVS" Then
                    ws.Range("H3", "H" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("I3", "I" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.000")
                    ws.Range("J3", "J" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("K3", "K" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("L3", "L" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ws.Range("M3", "M" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                ElseIf OrigFileName(1) = "SPORD" Then
                    ws.Range("L3", "L" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.0000")
                    ws.Range("M3", "M" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.0000")
                ElseIf OrigFileName(1) = "HuntList" Then
                    ws.Range("L3", "L" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.0000")
                    ws.Range("M3", "M" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.0000")
                ElseIf OrigFileName(1) = "FileReports" Then
                    subjectFileName = OrigFileName(0)
                    If OrigFileName(0) = "CustSalesSummary" Then
                        ws.Range("H3", "H" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    ElseIf OrigFileName(0) = "SalesPersonSummary" Then
                        ws.Range("C3", "C" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")

                    ElseIf OrigFileName(0) = "PrintExpenseReport" Then
                        ws.Range("A1").Value = "Expense Report"
                        ws.Range("A1").Style.Font.FontSize = 18
                        ws.Range("A1").Style.Font.Bold = True
                        ws.Range("A2").Value = "From " + FromDate.Replace("/", "/") + " to " + ToDate.Replace("/", "/")
                        ws.Range("A2").Style.Font.Bold = True

                    ElseIf OrigFileName(0) = "SalesSummaryByCustomer" Then
                        ws.Range("A2").Value = "Sales Summary by Customer"
                        ws.Range("A2").Style.Font.FontSize = 18
                        ws.Range("A2").Style.Font.Bold = True

                        ws.Range("C3:AZ1000").Style.NumberFormat.SetFormat("#,##0.00")
                    ElseIf OrigFileName(0) = "SalesSummaryByFarm" Then
                        ws.Range("A2").Value = "Sales Summary by Farm"
                        ws.Range("A2").Style.Font.FontSize = 18
                        ws.Range("A2").Style.Font.Bold = True

                        ws.Range("C3:AZ1000").Style.NumberFormat.SetFormat("#,##0.00")
                    ElseIf OrigFileName(0) = "SalesSummaryByCat" Then
                        ws.Range("A2").Value = "Sales Summary by Category"
                        ws.Range("A2").Style.Font.FontSize = 18
                        ws.Range("A2").Style.Font.Bold = True

                        ws.Range("C4:AZ1000").Style.NumberFormat.SetFormat("#,##0.00")
                    ElseIf OrigFileName(0) = "CustomerGroupSalesSummary" Then
                        ws.Range("A2").Value = "Sales Summary by Customer Group"
                        ws.Range("A2").Style.Font.FontSize = 18
                        ws.Range("A2").Style.Font.Bold = True

                        ws.Range("C3:AZ1000").Style.NumberFormat.SetFormat("#,##0.00")
                    ElseIf OrigFileName(0) = "ByMonthlySaleBySPer" Then
                        ws.Range("A2").Value = "Monthly Sales Summary by Sales Person"
                        ws.Range("A2").Style.Font.FontSize = 18
                        ws.Range("A2").Style.Font.Bold = True

                        ws.Range("C3:AZ1000").Style.NumberFormat.SetFormat("#,##0.00")
                    ElseIf OrigFileName(0) = "SalesSummaryBySPer" Then
                        ws.Range("A2").Value = "Sales Person  Sales Summary"
                        ws.Range("A2").Style.Font.FontSize = 18
                        ws.Range("A2").Style.Font.Bold = True

                        ws.Range("A2").Value = FromDate + " To " + ToDate
                        ws.Range("A2").Style.Font.FontSize = 10
                        ws.Range("A2").Style.Font.Bold = True

                        ws.Range("E4:E10000").Style.NumberFormat.SetFormat("#,##0.00")
                        ws.Range("G4:G10000").Style.NumberFormat.SetFormat("#,##0.00")
                    End If
                    'ws.Range("D3", "D" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    'ws.Range("E3", "E" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.000")
                    'ws.Range("F3", "F" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                    'ws.Range("G3", "G" + Convert.ToString(dt.Rows.Count + 2)).Style.NumberFormat.SetFormat("#,##0.00")
                End If
            End If

            ws.Cell(3, 1).InsertTable(dt)
            wb.SaveAs(strRequest)
            strRequest = Foldername + "\" + FulFilename

            Dim unused = Logs.SendMail(FromEmail, ToEmail, Foldername + "\" + FulFilename, strRequest, companyName + " " + subjectFileName)

            Return FulFilename
        Catch ex As Exception
            Return ex.Message
        End Try
    End Function

    Public Function ConvertToDataTable(Of T)(data As IList(Of T)) As DataTable
        Dim properties As PropertyDescriptorCollection = TypeDescriptor.GetProperties(GetType(T))
        Dim table As New DataTable()
        For Each prop As PropertyDescriptor In properties
            table.Columns.Add(prop.Name, If(Nullable.GetUnderlyingType(prop.PropertyType), prop.PropertyType))
        Next
        For Each item As T In data
            Dim row As DataRow = table.NewRow()
            For Each prop As PropertyDescriptor In properties
                row(prop.Name) = If(prop.GetValue(item), DBNull.Value)
            Next
            table.Rows.Add(row)
        Next
        Return table

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateComments(ByVal Comments As String, ByVal POKEY As String, ByVal ORD As String) As String
        Try
            'Dim result As String = obj.UpdateBreakDown(POKEY, ORD, Comments)
            'JAD
            Dim result As String = ""
            If result <> "valid" Then
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")

            End If
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateComments::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SplitPOBoxes(ByVal POQId As Integer, ByVal TotBoxes As String, SplittingBox As String, ByVal QTYXBOX As String,
                                                 ByVal ProductCode As String, ByVal ProductName As String, ByVal BreakDownText As String, ByVal ShipDate As String, ByVal Farm As String) As String
        Try
            Dim User As New User
            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return "LogOut"
            Else
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If


            Dim companyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            Dim result As String = DAOPO.SplitPurchaseOrder(POQId, TotBoxes, SplittingBox, QTYXBOX, ProductCode, ProductName, BreakDownText.ToUpper(), Farm, ShipDate, If(User Is Nothing, "", User.Name))


            If result <> "success" Then
                Throw New Exception("Error in SplitPOBoxes::PageConfirmedPO ")
            End If

            Dim PoDet As BOPO = DAOPO.GetPurchaseOrderDetailsByPOQId(POQId)
            Dim ponum As String = ""
            Dim FarmName As String = ""
            ponum = PoDet.PONumber
            FarmName = PoDet.FarmName
            Dim toEmails As String = F_Emails.GetEmailsByType("POSPLIT")
            Dim emailSubject As String = companyName & " " & FarmName & " - " & ProductName & " Split  from PO# " & ponum & " " & SplittingBox & " out of " & TotBoxes & " boxes for " & ShipDate & " by " & User.Email & " on " & DateTime.Now.ToString()

            Dim emailBody As String = ""

            If Not String.IsNullOrEmpty(toEmails) Then
                Dim unused = Logs.SendMail(FromEmail, toEmails, emailBody, "", emailSubject)
            End If

            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SplitPOBoxes::PageConfirmedPO")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetConfirmedPOsDetailsByID(ByVal POQId As String) As Object
        Try
            'Dim data = obj.GetPurchaseOrderDetailsByPokey(ID, ORD) // Commented By Belal on 12 Sept 2020
            Dim data = DAOPO.LoadPODetailsFromPOQ(POQId)
            If data.ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Session("LoginUserDetails") IsNot Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Session("LoginAdminDetails") IsNot Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data.ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetConfirmedPOsDetailsByID::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetMAWB(ByVal Filter As String) As Object
        Try
            Dim LoginUserDetails As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") Then
            '    FilterFarms = ""
            'End If
            'If FilterFarms <> "" Then
            '    FilterFarms = "Farm in (" + FilterFarms + ")"
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
            Else
                FilterFarms = ""
            End If

            Filter = ConfirmedPOFilters(Filter)


            Dim data As List(Of BOPO)
            data = DAOPO.GetDistinctMAWBListForPO(Filter, FilterFarms)
            If data(0).ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetMAWB::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetHAWB(ByVal Filter As String) As Object
        Try
            Dim LoginUserDetails As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") Then
            '    FilterFarms = ""
            'End If
            'If FilterFarms <> "" Then
            '    FilterFarms = "Farm in (" + FilterFarms + ")"
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
            Else
                FilterFarms = ""
            End If

            Filter = ConfirmedPOFilters(Filter)

            Dim data As List(Of BOPO)
            data = DAOPO.GetDistinctHAWBListForPO(Filter, FilterFarms)
            If data(0).ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetHAWB::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    Private Function ConfirmedPOFilters(Filter As String) As String

        Dim DateSession(1) As String
        If (Not Session("DateSession") Is Nothing) Then
            DateSession = Session("DateSession")
        Else
            DateSession = Nothing
        End If

        Dim FromDate As String = ""
        Dim ToDate As String = ""
        If (DateSession Is Nothing) Then
            ' FromDate = DateTime.Now.ToString("MM/dd/yyyy")
            ToDate = DateTime.Now.ToString("MM/dd/yyyy")
        Else
            FromDate = DateSession(0).ToString()
            ToDate = DateSession(1).ToString()
        End If

        Dim LoginUserDetails As New User

        If Not Session("LoginUserDetails") Is Nothing Then
            LoginUserDetails = Session("LoginUserDetails")
        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            LoginUserDetails = Session("LoginAdminDetails")
        End If

        Dim FilterFarms As String = ""
        If (Not LoginUserDetails Is Nothing) Then
            FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
        End If

        If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
            FilterFarms = "Farm in (" + FilterFarms + ")"
        Else
            FilterFarms = ""
        End If

        Dim FilterCode As String = ""
        '=============================================================================================================
        'Commented by VEN:16-12-2015:For avoid Statement too long error (i.e.) more then 100 farms assigned in user
        '==============================================================================================================
        'If FilterFarms <> "" And FilterFarms <> "''" Then
        '    If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
        '        FilterCode = "Farm in (" + FilterFarms + ") And SHIPDATE >= ctod('" + ToDate + "') "
        '    Else
        '        FilterCode = "Farm in (" + FilterFarms + ") And SHIPDATE >= ctod('" + FromDate + "') " + " And " + " SHIPDATE <= ctod('" + ToDate + "')"
        '    End If
        'ElseIf (LoginUserDetails.UserType.ToLower() <> "inventory" And FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy")) Then
        '    FilterCode = "Farm in ('0') And SHIPDATE >= ctod('" + ToDate + "')"
        'ElseIf (LoginUserDetails.UserType.ToLower() = "inventory" And FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy")) Then
        '    FilterCode = "SHIPDATE >= ctod('" + ToDate + "')"
        'Else
        '    FilterCode = "SHIPDATE >= ctod('" + FromDate + "') " + " And " + " SHIPDATE <= ctod('" + ToDate + "')"
        'End If
        If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
            FilterCode = "SHIPDATE = ctod('" + ToDate + "') "
            'ElseIf
            '    FilterCode = "SHIPDATE >= ctod('" + FromDate + "') " + " And " + " SHIPDATE <= ctod('" + ToDate + "')"
            'ElseIf (LoginUserDetails.UserType.ToLower() <> "inventory" And FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy")) Then
            '    FilterCode = "SHIPDATE >= ctod('" + ToDate + "')"
            'ElseIf ((LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") And FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy")) Then
            '    FilterCode = "SHIPDATE >= ctod('" + ToDate + "')"
        Else
            FilterCode = "SHIPDATE >= ctod('" + FromDate + "') " + " And " + " SHIPDATE <= ctod('" + ToDate + "')"
        End If

        If Filter <> "" Then
            Filter += " And " + FilterCode
        Else
            Filter += FilterCode
        End If

        Return Filter
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarm(ByVal ProStatus As String) As Object
        Try
            Dim data As List(Of BOPO)
            data = DAOPO.GetDistinctFARMListForPO(ProStatus)
            If data(0).ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarm::PageConfirmedPO")
            Return Nothing
        End Try
    End Function
    '<System.Web.Services.WebMethod(True)>
    'Public Sub SavePODateSession(ByVal FromDate As String, ByVal ToDate As String)
    '    Try
    '        Dim DateSession(1) As String
    '        DateSession(0) = FromDate
    '        DateSession(1) = ToDate
    '        Session("PODateSession") = DateSession
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::SavePODateSession::PageConfirmedPO")
    '    End Try
    'End Sub

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetPODateSession() As String()
    '    Try
    '        Dim DateSession(1) As String
    '        DateSession = Session("PODateSession")
    '        Return DateSession
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetPODateSession::PageConfirmedPO")
    '        Return Nothing
    '    End Try
    'End Function
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateConfirmedPoDetails(ByVal Details As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim SessionStatus As String = ""
            SessionStatus = CheckLoginSessionIsActive("Admin")
            If SessionStatus = "InActive" Then
                Return Nothing
            End If


            Dim result As String
            result = "Invalid"
            Dim POKey As String = ""
            Dim Conf As String = ""
            Dim Breakdown As String = ""
            Dim Length As String = ""
            Dim Height As String = ""
            Dim Width As String = ""
            Dim Invoice As String = ""
            Dim xmlDoc As New XmlDocument
            xmlDoc.LoadXml(Details)
            Dim xDoc As XDocument = XDocument.Parse(xmlDoc.OuterXml)
            Dim ConPODetails = xDoc.Descendants("PODetail")
            For Each objDetails In ConPODetails
                POKey = objDetails.Descendants("ConfirmID").First().Value.ToString()
                Conf = objDetails.Descendants("conf").First().Value
                Length = objDetails.Descendants("Length").First().Value
                Height = objDetails.Descendants("Height").First().Value
                Width = objDetails.Descendants("Width").First().Value
                Breakdown = objDetails.Descendants("breakdown").First().Value
                Invoice = objDetails.Descendants("Invoice").First().Value
                Conf = IIf(Convert.ToString(Conf).Trim() = "", 0, Conf)
                Length = IIf(Convert.ToString(Length).Trim() = "", 0, Length)
                Height = IIf(Convert.ToString(Height).Trim() = "", 0, Height)
                Width = IIf(Convert.ToString(Width).Trim() = "", 0, Width)
                Invoice = IIf(Convert.ToString(Invoice).Trim() = "", 0, IIf(Invoice = "undefined", "0", Invoice))
                If Convert.ToString(POKey).Trim() <> "" Then
                    result = DAOPO.UpdateConfirmedPOdetails(Convert.ToInt32(POKey), Breakdown, Decimal.Parse(Conf),
                                                       Convert.ToDecimal(Length), Convert.ToDecimal(Height), Convert.ToDecimal(Width),
                                                       Convert.ToInt32(Invoice), User.Name)
                End If
            Next

            If result = "success" Then

                result = LogEmailForConfirmedPOs(Details, User)

                Return result
            Else
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateConfirmedPoDetails::PageConfirmedPO")
            Return "error"
        End Try
    End Function

    Private Function LogEmailForConfirmedPOs(PODetails As String, user As User) As String
        Try
            Dim CurrentPage As String = HttpContext.Current.Request.UrlReferrer.Query.Split("=")(1)
            If CurrentPage.ToLower.Contains("pendingpos") Then

                Dim xmlDoc As New XmlDocument
                xmlDoc.LoadXml(PODetails)
                Dim xDoc As XDocument = XDocument.Parse(xmlDoc.OuterXml)
                Dim ConPODetails = xDoc.Descendants("PODetail")

                ' Deserialize poDetails into list of XMLPODetail
                Dim details As List(Of XmlPODetail) = ConPODetails.Select(Function(x) New XmlPODetail() With {
                    .ConfirmID = x.Descendants("ConfirmID").FirstOrDefault(),
                    .PONUM = x.Descendants("PONUM").FirstOrDefault(),
                    .Boxes = x.Descendants("Boxes").FirstOrDefault(),
                    .conf = x.Descendants("conf").FirstOrDefault()}).ToList()

                Dim ponumList As List(Of String) = New List(Of String)
                ponumList = details.Select(Function(x) x.PONUM).Distinct().ToList()

                Dim companyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")


                For Each ponum In ponumList

                    If String.IsNullOrEmpty(ponum) Then
                        Continue For
                    End If

                    Dim header = PurchaseOrders.GetPurchaseOrderHeaderByPONum(ponum)

                    If header Is Nothing Then
                        Continue For
                    End If

                    ' Get the Salesman detail
                    Dim salesPerson As String = header.PassName ''.PASSWORD
                    Dim salesEmail As String = ""

                    If Not String.IsNullOrEmpty(salesPerson) And salesPerson.Contains("@") Then
                        salesEmail = salesPerson
                    Else
                        Users.GetUserEmailBySalesPerson(salesPerson)
                    End If

                    ' Email subject

                    Dim farmCode As String = header.Farm.Farm
                    Dim farmName As String = header.FarmName
                    Dim poStat As String = header.POStatus
                    Dim poShipDate As Date = header.ShipDate

                    Dim toEmails As String = "jose@dflower.com"
                    If salesEmail <> "" Then
                        'toEmails = toEmails & "," & salesEmail
                        toEmails = salesEmail
                    End If

                    Dim evnt As String = IIf(poStat = "PARTIAL", "CONFIRMED PARTIALLY", poStat)
                    Dim emailSubject As String = companyName & " " & farmCode & " - " + farmName + " " & "PO#" & ponum & " for " & poShipDate.ToString("MM/dd/yyyy") & " has been " & evnt & " by " & user.Email & " on " & DateTime.Now.ToString()

                    Dim emailBody As String = ""

                    'Email body, show for DENIED PO 
                    If poStat = "DENIED" Or poStat = "CONFIRMED" Or poStat = "PARTIAL" Then
                        emailBody = "::PO Details::" & vbCrLf & "<br/>"

                        Dim detailsForSelectedPonum As List(Of XmlPODetail) = details.Where(Function(x) x.PONUM = ponum).ToList()
                        Dim ConStr As String = ConfigurationManager.ConnectionStrings.Item("BloomsConnectionString").ToString
                        For Each det In detailsForSelectedPonum
                            Dim poKey As Integer = det.ConfirmID 'Convert.ToInt32(det.ConfirmID.Split("_")(0))
                            'Dim ord As Integer = Convert.ToInt32(det.ConfirmID.Split("_")(1))

                            Dim detail = DAOPO.LoadPODetailsFromPOQ(poKey)
                            emailBody = emailBody & "Line:" & detail.ORD &
                                    " | Boxes:" & det.Boxes.ToString() &
                                    " | Conf:" & detail.QtyBConf &
                                    " | Cost:" & detail.UnitCosq.ToString("#,##0.000") &
                                    " | Product:" & detail.Product &
                                    " | Code:" & detail.ProductCode & vbCrLf & "<br/>"


                            Using con As New System.Data.SqlClient.SqlConnection(ConStr)
                                con.Open()
                                Using DBFcmd As New System.Data.SqlClient.SqlCommand("spInsertPOHistory", con)
                                    DBFcmd.CommandType = CommandType.StoredProcedure

                                    DBFcmd.Parameters.AddWithValue("@PONUM", ponum)
                                    DBFcmd.Parameters.AddWithValue("@LOGTEXT", detail.ORD &
                                        " | Boxes:" & det.Boxes.ToString() &
                                        " | Conf:" & detail.QtyBConf &
                                        " | Cost:" & detail.UnitCosq.ToString("#,##0.000") &
                                        " | Product:" & detail.Product &
                                        " | Code:" & detail.ProductCode)
                                    DBFcmd.Parameters.AddWithValue("@ADDUSER", user.Name)
                                    DBFcmd.Parameters.AddWithValue("@ADDAPP", "CONFIRMED PO")

                                    DBFcmd.ExecuteNonQuery()
                                End Using
                            End Using



                            'Using DBFcmd As New SqlCommand("SPF_IHISTORYInsert", Con)
                            '    DBFcmd.CommandType = CommandType.StoredProcedure

                            '    DBFcmd.Parameters.AddWithValue("@Order", Order)
                            '    DBFcmd.Parameters.AddWithValue("@CUSTOMER", Customer)
                            '    DBFcmd.Parameters.AddWithValue("@NOTE", Report + " generated for Invoice# " + Order + IIf(PO = "", "", ", PO# " + PO) + " Carrier: " + Carrier + ", Shipdate " +
                            '                                                      ShipDate.ToShortDateString() + " , by " + UserEmail + " from " + IP + "")
                            '    DBFcmd.Parameters.AddWithValue("@PERSON", UserName)
                            '    DBFcmd.ExecuteNonQuery()
                            'End Using

                        Next
                    End If

                    'Send Email 
                    Dim unused = Logs.SendMail(FromEmail, toEmails, emailBody, "", emailSubject)
                Next

            End If

            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in LogEmailForConfirmedPOs")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPendingPOList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument

        Try
            Dim newDoc As New XmlDocument()

            Dim DateSession(1) As String
            If (Not Session("DateSession") Is Nothing) Then
                DateSession = Session("DateSession")
            Else
                DateSession = Nothing
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If (DateSession Is Nothing) Then
                ' FromDate = DateTime.Now.ToString("MM/dd/yyyy")
                ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            Else
                FromDate = DateSession(0).ToString()
                ToDate = DateSession(1).ToString()
            End If
            Dim LoginUserDetails As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") Then
            '    FilterFarms = ""
            'End If
            'If FilterFarms <> "" Then
            '    FilterFarms = "Farm in (" + FilterFarms + ")"
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
            Else
                FilterFarms = ""
            End If

            Dim ShipDateCondition As String = ""
            If FromDate = "" Then
                ShipDateCondition = "CONVERT(DATE,POQ.SHIPDATE,103) >= CONVERT(DATE,'" + ToDate + "',101) "
            Else
                ShipDateCondition = "CONVERT(DATE,POQ.SHIPDATE,103) >= CONVERT(DATE,'" + FromDate + "',101) " + " And " + " CONVERT(DATE,POQ.SHIPDATE,103) <= CONVERT(DATE,'" + ToDate + "',101)"
            End If
            'End If

            If Filter <> "" Then
                ShipDateCondition += " And " + Filter
            End If

            If qtype.ToLower() = "farm" And query <> "" Then
                If Not Session("UserFarms") Is Nothing Then
                    Dim assignedFarms As List(Of Farm) = Session("UserFarms")
                    Dim hasFarm As Boolean = assignedFarms.Any(Function(cus) cus.Farm = query)
                    If hasFarm = False Then
                        page = 0
                        rp = 0
                    End If
                End If
            End If
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing
                Dim start As Integer = ((page - 1) * rp) + 1
                rp -= 1
                Dim SortExp As String
                SortExp = sortname + " " + sortorder
                data = DAOPO.GetConfirmedPOListForGrid(ShipDateCondition, SortExp, start, FilterFarms)
                'End If

                Dim dt1 As DataTable
                dt1 = ConvertToDataTable(data)
                If data(0).ErrorMessage = "" Then
                    Dim selectedColumns As String() =
                        {"Farm", "PoNumber", "TYPE", "ORD", "ShipDate", "Airport", "Flower", "QtyBox", "Uom", "QtyxBox", "Unitcosq", "QtyBconf", "CustNumber", "BoxNumber",
                         "PassName", "prostatus", "BreakDown", "boxcode", "Upc", "Length", "Width", "Height"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("PoNumber").ColumnName = "PO#"
                    dt.Columns("TYPE").ColumnName = " "
                    dt.Columns("ORD").ColumnName = "Line"
                    dt.Columns("QtyBox").ColumnName = "Boxes"
                    dt.Columns("QtyXBox").ColumnName = "Pack"
                    dt.Columns("UnitCosq").ColumnName = "Cost"
                    dt.Columns("QtyBConf").ColumnName = "Conf"
                    dt.Columns("Length").ColumnName = "L"
                    dt.Columns("Width").ColumnName = "W"
                    dt.Columns("Height").ColumnName = "H"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    dtCloned.Columns("ShipDate").DataType = GetType(String)
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            Else
                Dim start As Integer = ((page - 1) * rp) + 1
                rp -= 1
                Dim SortExp As String
                SortExp = sortname + " " + sortorder
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = DAOPO.GetConfirmedPOListForGrid(ShipDateCondition, SortExp, start, FilterFarms)
                'Dim data = DAOPO.GetConfirmedPOListForGrid(page, rp, sortname, sortorder, query, qtype, FilterFarms, ShipDateCondition)

                If data(0).ErrorMessage = "" Then
                    Dim FlowerColorVisibility As Boolean = False
                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    For Each I In UserFeatures
                        If I.Name.ToLower = "show flower color" Then
                            FlowerColorVisibility = I.Value
                        End If
                    Next

                    Dim UnassignedFarmsList As New List(Of Farm)
                    UnassignedFarmsList = Farms.GetUnassignedFarms()

                    Dim SelectedPOs As New ArrayList
                    Dim TotalRowCount As Integer = 0
                    Dim dt1 As DataTable
                    dt1 = ConvertToDataTable(data)
                    If dt1.Rows.Count > 0 Then
                        TotalRowCount = dt1.Rows.Count - 1
                    End If
                    'If Not Context.Session("SelectedPOs") Is Nothing Then
                    '        SelectedPOs = Context.Session("SelectedPOs")
                    '        For Each Item In data
                    '            Dim hasItem = SelectedPOs.Cast(Of String()).Where(Function(i) i(0).Equals(Item.POKEY.ToString + "_" + Item.ORD)).FirstOrDefault()
                    '            If Not hasItem Is Nothing Then
                    '                Item.Selected = True
                    '            End If
                    '        Next
                    '    End If
                    'New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='teselect_" & row.POKEY.ToString() + "_" + row.Ord & "'  src='" & IIf(row.Selected, "images/check-on.png", "images/check-off.png") & "' />")),
                    'New XElement("cell", IIf(String.IsNullOrEmpty(Farms.GetFarmDetailsByCode(row.Farm).Farm), "<span title='Farm needs to be IMPORTED into SQL' style='color:red;font-weight:bold;'>" + row.Farm + "</span>", String.Format(IIf(Not UnassignedFarmsList.Find(Function(c) c.Farm.Trim() = row.Farm.Trim()) Is Nothing, "<div class='flowerDescription' id='divunassignedFarm_" + row.Farm + "' style='padding-bottom: 3px;color:Red;cursor:pointer;font-weight:bold;text-decoration: underline;'>" & row.Farm & "</div>", GetFarmForConfirmedPO(row.FarmName, row.Farm))))),

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", TotalRowCount),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", If(row.DetailID <> 0, row.DetailID.ToString(), "0")),
                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='teselect_" & row.DetailID.ToString() & "'  src='images/check-off.png' />")),
                    New XElement("cell", IIf(UnassignedFarmsList.Any(Function(c) c.Farm.Trim() = row.Farm.Trim()),
                    "<div class='flowerDescription' id='divunassignedFarm_" + row.Farm + "' style='padding-bottom: 3px;color:Red;cursor:pointer;font-weight:bold;text-decoration: underline;'>" + row.Farm + "</div>",
                    "<div class='flowerDescription' id='divunassignedFarm_" + row.Farm + "' style='padding-bottom: 3px;color:black;cursor:pointer;font-weight:bold;text-decoration: underline;'>" + row.Farm + "</div>")),
                        New XElement("cell", row.PONumber),
                        New XElement("cell", row.Type),
                        New XElement("cell", row.Ord),
                        New XElement("cell", row.ShipDate),
                        New XElement("cell", row.Airport),
                        New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='cursor:pointer;color:" + row.ForeColor.ToString() + "' title='" & row.Flowername & "'>" & row.Flowername & "</a>", "<a style='cursor:pointer;' title='" & row.Flowername & "'>" & row.Flowername & "</a>")),
                        New XElement("cell", IIf(row.QTYBOX = "0", "", row.QTYBOX)),
                        New XElement("cell", row.UOM),
                        New XElement("cell", IIf(row.QtyXBox = "0", "", row.QtyXBox)),
                        New XElement("cell", IIf(row.UnitCosq = "0", "", row.UnitCosq.ToString("#,##0.000"))),
                        New XElement("cell", "<a id='btnconfirmconf_" + row.DetailID.ToString() + "'>" + IIf(Convert.ToInt32(row.QtyBConf) = 0, "", row.QtyBConf.ToString()) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(Convert.ToInt32(row.QtyBConf) = 0, "", Convert.ToString(row.QtyBConf)) & "' id='editconf_" & row.DetailID.ToString() & "'></input>"),
                        New XElement("cell", IIf(row.CustNumber = "0", "", row.CustNumber)),
                        New XElement("cell", row.BoxNumber),
                        New XElement("cell", row.PassName),
                        New XElement("cell", row.PROStatus),
                        New XElement("cell", "<a title='" + row.BreakDown + "' id='btnconfirmbreakdown_" + row.DetailID.ToString() + "'>" + row.BreakDown + "</a><input type='text' style='display:none;width:150px' value='" + row.BreakDown + "' maxlength='126' id='editconfirmbreakdown_" & row.DetailID.ToString() & "'></input> <input type='text' style='display:none;' value='" & row.PONumber & "' id='ponum_" & row.DetailID.ToString() & "'></input> <input type='text' style='display:none;' value='" & IIf(Convert.ToString(row.QTYBOX) = "0", "", Convert.ToString(row.QTYBOX)) & "' id='boxes_" & row.DetailID.ToString() & "'></input>"),
                        New XElement("cell", row.CustomerPO),
                        New XElement("cell", row.BoxCode),
                        New XElement("cell", "<a style='text-decoration:underline;color:" + If(row.Upc.Length <= "10", "none", "Red") + ";' href='#' id='UPCClicked_" & row.DetailID.ToString() & "'>" & row.Upc & "</a>"),
                        New XElement("cell", "<a style='text-decoration:underline' href='#' id='SplitBoxes_" & row.DetailID.ToString() & "'>Split</a>"),
                        New XElement("cell", "<a id='btnconfirmLength_" + row.DetailID.ToString() + "'>" + IIf(row.Length = "0.0", "0", row.Length) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(row.Length = "0.0", "0", row.Length) & "' id='editLength_" & row.DetailID.ToString() & "'></input>"),
                        New XElement("cell", "<a id='btnconfirmHeight_" + row.DetailID.ToString() + "'>" + IIf(row.Height = "0.0", "0", row.Height) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(row.Height = "0.0", "0", row.Height) & "' id='editHeight_" & row.DetailID.ToString() & "'></input>"),
                        New XElement("cell", "<a id='btnconfirmWidth_" + row.DetailID.ToString() + "'>" + IIf(row.Width = "0.0", "0", row.Width) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' placeholder='" & IIf(row.Width = "0.0", "0", row.Width) & "' id='editWidth_" & row.DetailID.ToString() & "'></input>")))))


                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1

                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                    Return newDoc
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingPOList::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    Private Shared Function ConvertConfirmedConsolidateToDatatable(list As List(Of BOPurchaseOrder), ByVal FromDate As String) As DataTable
        Try
            Dim dt As New DataTable()
            dt.Columns.Add("Farm", GetType(String))
            dt.Columns.Add("Market", GetType(String))
            dt.Columns.Add("Origin", GetType(String))
            dt.Columns.Add("ProductCode", GetType(String))
            dt.Columns.Add("Product", GetType(String))
            dt.Columns.Add("QtyBox", GetType(Integer))
            dt.Columns.Add("UOM", GetType(String))
            dt.Columns.Add("WH", GetType(String))
            dt.Columns.Add("Qtyunit", GetType(Integer))
            dt.Columns.Add("Cust", GetType(String))
            dt.Columns.Add("BreakDown", GetType(String))
            dt.Columns.Add("0", GetType(String))
            dt.Columns.Add("+1", GetType(String))
            dt.Columns.Add("+2", GetType(String))
            dt.Columns.Add("+3", GetType(String))
            dt.Columns.Add("+4", GetType(String))
            dt.Columns.Add("+5", GetType(String))
            dt.Columns.Add("+6", GetType(String))
            dt.Columns.Add("+7", GetType(String))
            dt.Columns.Add("+8", GetType(String))
            dt.Columns.Add("+9", GetType(String))
            dt.Columns.Add("+10", GetType(String))
            dt.Columns.Add("+11", GetType(String))
            dt.Columns.Add("+12", GetType(String))
            dt.Columns.Add("+13", GetType(String))
            dt.Columns.Add("+14", GetType(String))
            dt.Columns.Add("+15", GetType(String))
            dt.Columns.Add("+16", GetType(String))
            dt.Columns.Add("+17", GetType(String))
            dt.Columns.Add("+18", GetType(String))
            dt.Columns.Add("+19", GetType(String))
            dt.Columns.Add("+20", GetType(String))
            dt.Columns.Add("+21", GetType(String))

            For Each item In list
                Dim row = dt.NewRow()
                row("Farm") = item.Farm
                row("Market") = item.Market
                row("Origin") = item.Origin
                row("ProductCode") = item.ProductCode
                row("Product") = item.Product
                row("QtyBox") = item.QtyBox
                row("UOM") = item.Uom
                row("Qtyunit") = item.Qtyunit
                row("WH") = item.WH
                row("Cust") = item.Cust
                row("Farm") = item.Farm
                row("Breakdown") = item.Breakdown
                row("0") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 0, item.QtyBox.ToString(), "")
                row("+1") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 1, item.QtyBox.ToString(), "")
                row("+2") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 2, item.QtyBox.ToString(), "")
                row("+3") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 3, item.QtyBox.ToString(), "")
                row("+4") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 4, item.QtyBox.ToString(), "")
                row("+5") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 5, item.QtyBox.ToString(), "")
                row("+6") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 6, item.QtyBox.ToString(), "")
                row("+7") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 7, item.QtyBox.ToString(), "")
                row("+8") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 8, item.QtyBox.ToString(), "")
                row("+9") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 9, item.QtyBox.ToString(), "")
                row("+10") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 10, item.QtyBox.ToString(), "")
                row("+11") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 11, item.QtyBox.ToString(), "")
                row("+12") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 12, item.QtyBox.ToString(), "")
                row("+13") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 13, item.QtyBox.ToString(), "")
                row("+14") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 14, item.QtyBox.ToString(), "")
                row("+15") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 15, item.QtyBox.ToString(), "")
                row("+16") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 16, item.QtyBox.ToString(), "")
                row("+17") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 17, item.QtyBox.ToString(), "")
                row("+18") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 18, item.QtyBox.ToString(), "")
                row("+19") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 19, item.QtyBox.ToString(), "")
                row("+20") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 20, item.QtyBox.ToString(), "")
                row("+21") = IIf((item.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays >= 21, item.QtyBox.ToString(), "")

                dt.Rows.Add(row)
            Next
            Return dt
        Catch ex As Exception

            Return Nothing
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetConsolidatePODetailsFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, FromDate As String, ToDate As String, ByVal ExportCSV As String) As XmlDocument

        Try
            Dim newDoc As New XmlDocument()
            Dim DAOPO As New DAOPO()


            Dim LoginUserDetails As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") Then
            '    FilterFarms = ""
            'End If
            'If FilterFarms <> "" Then
            '    FilterFarms = "Farm in (" + FilterFarms + ")"
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
            Else
                FilterFarms = ""
            End If

            Dim DateFilter As String = ""
            If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                DateFilter = "SHIPDATE = cast('" + ToDate + "' as date) "
            Else
                DateFilter = "SHIPDATE >= cast('" + FromDate + "' as date) " + " And " + " SHIPDATE <= cast('" + ToDate + "' as date) "
            End If

            If qtype.ToLower() = "farm" And query <> "" Then
                If Not Session("UserFarms") Is Nothing Then
                    Dim assignedFarms As List(Of Farm) = Session("UserFarms")
                    Dim hasFarm As Boolean = assignedFarms.Any(Function(cus) cus.Farm.ToLower() = query.ToLower())
                    If hasFarm = False Then
                        page = 0
                        rp = 0
                    End If
                End If
            End If

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = DAOPO.GetConsolidatePODetailsGridlist(page, rp, sortname, sortorder, query, qtype, DateFilter, FilterFarms)

                If data.Count() > 0 Then
                    If data(0).ErrorMessage = "" Then
                        Dim dt1 As New DataTable()
                        dt1 = ConvertConfirmedConsolidateToDatatable(data, FromDate)
                        If Not dt1 Is Nothing Then
                            Dim selectedColumns As String() =
                            {"Farm", "Market", "Origin", "ProductCode", "Product", "QtyBox", "UOM", "Qtyunit", "WH", "Cust", "Breakdown", "0", "+1", "+2", "+3", "+4", "+5", "+6", "+7", "+8", "+9", "+10",
                             "+11", "+12", "+13", "+14", "+15", "+16", "+17", "+18", "+19", "+20", "+21"}

                            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)

                            dt.Columns("Product").ColumnName = "Description"
                            dt.Columns("Cust").ColumnName = "Cust#"
                            dt.Columns("Market").ColumnName = " "
                            dt.Columns("QtyBox").ColumnName = "Boxes"
                            dt.Columns("Qtyunit").ColumnName = "Units"
                            'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                            Dim dtCloned As DataTable = dt.Clone()
                            For Each row As DataRow In dt.Rows
                                dtCloned.ImportRow(row)
                            Next
                            Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Consolidate")
                            Return BuildXmlDoc(filepath)
                        End If
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else
                Dim data = DAOPO.GetConsolidatePODetailsGridlist(page, rp, sortname, sortorder, query, qtype, DateFilter, FilterFarms)
                Dim TotalRowCount As Integer = 0
                If data.Count() > 0 Then
                    TotalRowCount = data(0).TotalRows.ToString()
                End If

                If data.Count() > 0 Then
                    If data(0).ErrorMessage = "" Then
                        Dim FlowerColorVisibility As Boolean = False
                        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        Dim users As User = Session("LoginUserDetails")
                        For Each I In UserFeatures
                            If I.Name.ToLower = "show flower color" Then
                                FlowerColorVisibility = I.Value
                            End If
                        Next
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                    New XElement("rows", New XElement("page", page.ToString()),
                    New XElement("total", TotalRowCount),
                    data.Select(Function(row) New XElement("row", New XAttribute("id", row.RowNo),
                    New XElement("cell", row.ProductCategory),
                    New XElement("cell", row.Farm),
                    New XElement("cell", row.Market),
                    New XElement("cell", row.Origin),
                    New XElement("cell", row.ProductCode),
                    New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.FlowerDetails.BGColor.ToString() + "' class='flowerDescription'><a style='cursor:pointer;color:" + row.FlowerDetails.FontColor.ToString() + "' title='" & row.Product & "'>" & row.Product & "</a>", "<a style='cursor:pointer;' title='" & row.Product & "'>" & row.Product & "</a>")),
                    New XElement("cell", row.QtyBox),
                    New XElement("cell", row.Uom),
                    New XElement("cell", row.Qtyunit),
                    New XElement("cell", row.WH),
                    New XElement("cell", row.Cust),
                    New XElement("cell", row.Breakdown),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 0, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 1, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 2, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 3, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 4, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 5, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 6, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 7, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 8, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 9, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 10, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 11, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 12, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 13, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 14, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 15, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 16, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 17, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 18, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 19, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 20, FromDate)),
                    New XElement("cell", GetDayFromShipdates(row.ShipDatesAndItsBoxes, 21, FromDate))))))


                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 0, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 1, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 2, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 3, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 4, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 5, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 6, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 7, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 8, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 9, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 10, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 11, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 12, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 13, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 14, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 15, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 16, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 17, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 18, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 19, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays = 20, row.QtyBox.ToString(), "")),
                        'New XElement("cell", IIf((row.ShipDate - Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))).TotalDays >= 21, row.QtyBox.ToString(), ""))))))

                        newDoc.LoadXml(xmlDoc.ToString())
                        Return newDoc
                    Else

                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "Error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", TotalRowCount)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetConsolidatePODetailsFgrd()::PageConfirmedPO")
            Return Nothing
        End Try
        Return Nothing
    End Function

    Public Function GetDayFromShipdates(ByVal ShipDatesAndItsBoxes As String, ByVal Day As String, ByVal FromDate As String) As String
        Try
            For Each ShipDateAndBox In ShipDatesAndItsBoxes.Split(",")
                Dim splitShipDateAndBox = ShipDateAndBox.Split("~")
                Dim ShipDate = splitShipDateAndBox(0)
                Dim Box = splitShipDateAndBox(1)
                Dim CShipDate As DateTime = Convert.ToDateTime(Convert.ToDateTime(ShipDate).ToString("MM/dd/yyyy"), New System.Globalization.CultureInfo("en-US", True))
                Dim CFromDate As DateTime = Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True))
                If (CShipDate - CFromDate).TotalDays = Day Then
                    Return Convert.ToString(Convert.ToInt16(Convert.ToDecimal(Box)))
                End If
            Next
            Return ""
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDayFromShipdates")
            Return ""
        End Try
    End Function

#End Region

#Region "Dynamicflexi"
    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDyamicFlexiGrid(ByVal tableName As String, ByVal Page As String, ByVal rp As String, ByVal Query As String, ByVal qtype As String, ByVal SortName As String, ByVal SortOrder As String) As String
    '    Try
    '        Return obj.GetDyamicFlexiGrid(tableName, Page, rp, Query, qtype, SortName, SortOrder)
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDyamicFlexiGrid")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetRowsCount(ByVal Qry As String) As String
    '    Try
    '        Return obj.GetRowsCount(Qry)
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetRowsCount")
    '        Return Nothing
    '    End Try
    'End Function
#End Region

#Region "Farm"


    <System.Web.Services.WebMethod(True)>
    Public Function SaveFarm(ByVal ID As String, ByVal FARM As String, ByVal NAME As String, ByVal VENDOR As Integer, ByVal FOB As String, ByVal PARTNER As Boolean, ByVal COMMISSION As String, ANTIDUMP As Boolean,
                                    ByVal CITY As String, ByVal GL As String, ByVal COUNTRY As String, ByVal PACKRET As Integer, ByVal MANUFACID As String, ByVal DUMPING As Decimal, ByVal FARMADD1 As String,
                                    ByVal FARMADD2 As String, ByVal OFFICEADD1 As String, ByVal OFFICEADD2 As String,
                                    ByVal OFFICETEL As String, ByVal OFFICEMAN As String, ByVal OFFICESEC As String, ByVal OFFICEFAX As String,
                                    ByVal FARMAGR As String, ByVal PRODUCTS As String, ByVal VARIETIES As String, ByVal AREA As String,
                                    ByVal BANKNAME As String, ByVal BANKADD1 As String, ByVal BANKADD2 As String, ByVal BANKACCOUN As String,
                                    ByVal BANKOFF As String, ByVal FUEL As Decimal, ByVal RETURNFUEL As Boolean, ByVal EMAIL As String,
                                    ByVal CreatedDate As String, ByVal KOMETID As String, ByVal STATUS As String, ByVal FARMEMAIL As String, ByVal SALESPERSON As String, ByVal CELLULAR As String,
         ByVal OFFICEMANPHONE As String, ByVal OFFICESECPHONE As String, ByVal OWNER As String, ByVal OWNERPHONE As String, ByVal PostHarvest As String, ByVal PostHarvestPhone As String, ByVal WebSite As String) As String
        Try
            'checkusersessionIsActive: start
            '            Dim SessionStatus As String = ""
            '            SessionStatus = CheckLoginSessionIsActive("Admin")
            '            If SessionStatus = "InActive" Then
            '                Return Nothing
            '            End If
            '            End

            Dim objFarm As New Farm

            If Not Session("FarmDetails") Is Nothing Then
                objFarm = Session("FarmDetails")
            End If

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim FarmID As String = ""
            Dim iDate As String = CreatedDate
            Dim dateVal As Date
            Dim oDate As Date
            If DateTime.TryParseExact(iDate, "dd-MM-yyyy",
                           CultureInfo.InvariantCulture,
                           DateTimeStyles.None, dateVal) Then
                oDate = DateTime.ParseExact(Convert.ToDateTime(iDate).ToString("MM/dd/yyyy", CultureInfo.InvariantCulture), "M/d/yyyy", CultureInfo.CurrentCulture)

            Else
                oDate = DateTime.ParseExact(iDate, "M/d/yyyy", CultureInfo.CurrentCulture)
            End If


            If (ID = "0") Then
                FarmID = Farms.InsertFarms(FARM, HttpUtility.UrlDecode(NAME, System.Text.Encoding.Default), VENDOR, FOB, PARTNER, COMMISSION, ANTIDUMP, CITY, GL, COUNTRY, PACKRET, MANUFACID, DUMPING, HttpUtility.UrlDecode(FARMADD1, System.Text.Encoding.Default), HttpUtility.UrlDecode(FARMADD2, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEADD1, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEADD2, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICETEL, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEMAN, System.Text.Encoding.Default),
                                           HttpUtility.UrlDecode(OFFICESEC, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEFAX, System.Text.Encoding.Default), HttpUtility.UrlDecode(FARMAGR, System.Text.Encoding.Default), PRODUCTS, VARIETIES, AREA, BANKNAME, HttpUtility.UrlDecode(BANKADD1, System.Text.Encoding.Default), HttpUtility.UrlDecode(BANKADD2, System.Text.Encoding.Default), BANKACCOUN, BANKOFF, FUEL,
                                           RETURNFUEL, HttpUtility.UrlDecode(EMAIL, System.Text.Encoding.Default), oDate, KOMETID, STATUS, HttpUtility.UrlDecode(FARMEMAIL, System.Text.Encoding.Default), LoginUserDetails.Name, SALESPERSON, CELLULAR, OFFICEMANPHONE, OFFICESECPHONE, OWNER, OWNERPHONE, PostHarvest, PostHarvestPhone, WebSite)
            Else

                Farms.UpdateFarms(ID, FARM, HttpUtility.UrlDecode(NAME, System.Text.Encoding.Default), VENDOR, FOB, PARTNER, COMMISSION, ANTIDUMP, CITY, GL, COUNTRY, PACKRET, MANUFACID, DUMPING, HttpUtility.UrlDecode(FARMADD1, System.Text.Encoding.Default), HttpUtility.UrlDecode(FARMADD2, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEADD1, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEADD2, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICETEL, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEMAN, System.Text.Encoding.Default),
                                           HttpUtility.UrlDecode(OFFICESEC, System.Text.Encoding.Default), HttpUtility.UrlDecode(OFFICEFAX, System.Text.Encoding.Default), HttpUtility.UrlDecode(FARMAGR, System.Text.Encoding.Default), PRODUCTS, VARIETIES, AREA, BANKNAME, HttpUtility.UrlDecode(BANKADD1, System.Text.Encoding.Default), HttpUtility.UrlDecode(BANKADD2, System.Text.Encoding.Default), BANKACCOUN, BANKOFF, FUEL,
                                           RETURNFUEL, HttpUtility.UrlDecode(EMAIL, System.Text.Encoding.Default), oDate, KOMETID, STATUS, HttpUtility.UrlDecode(FARMEMAIL, System.Text.Encoding.Default), LoginUserDetails.Name, SALESPERSON, CELLULAR, OFFICEMANPHONE, OFFICESECPHONE, OWNER, OWNERPHONE, PostHarvest, PostHarvestPhone, WebSite)
                FarmID = Convert.ToInt32(ID)
            End If
            If (Not FarmID.Contains("UNIQUE KEY constraint")) Then
                Return FarmID
            Else
                'User.ErrorMessage = FarmID
                Return FarmID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFarm::PageFarm")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCarrier(ByVal ID As String, ByVal CARRIER As String, ByVal NAME As String, ByVal AIRLINE As String, ByVal CUTOFF As String,
    ByVal DELCHARGE As Double, ByVal COUNTER As Integer, ByVal IATA As String, ByVal BEGAWB As Integer, ByVal ENDAWB As Integer, ByVal FLOWSCR As String, ByVal FLOWSCX As String, ByVal INFPHONE As String,
    ByVal AWBPHONE As String, ByVal CONTACT As String, ByVal NEEDBOOK As String, ByVal PRINTER As String, ByVal GENERIC As String, ByVal TWO_FORMS As String,
    ByVal ADDRESS1 As String, ByVal ADDRESS2 As String, ByVal ADDRESS3 As String, ByVal IsAccount As String, ByVal AccountLength As Integer, ByVal PALLETCHARGE As Double) As String
        Try
            'checkusersessionIsActive: start
            '            Dim SessionStatus As String = ""
            '            SessionStatus = CheckLoginSessionIsActive("Admin")
            '            If SessionStatus = "InActive" Then
            '                Return Nothing
            '            End If
            '            End

            Dim objCarrier As New Carrier

            If Not Session("CarrierDetails") Is Nothing Then
                objCarrier = Session("CarrierDetails")
            End If
            Dim CarrierID As String = ""
            Try
                If (ID = "0") Then
                    CarrierID = Carriers.InsertCarriers(CARRIER, NAME, AIRLINE, CUTOFF, DELCHARGE, COUNTER, IATA, BEGAWB, ENDAWB, FLOWSCR, FLOWSCX, INFPHONE, AWBPHONE, CONTACT, NEEDBOOK, PRINTER, GENERIC, TWO_FORMS, ADDRESS1, ADDRESS2, ADDRESS3, IsAccount, AccountLength, PALLETCHARGE)
                Else
                    Carriers.UpdateCarriers(ID, CARRIER, NAME, AIRLINE, CUTOFF, DELCHARGE, COUNTER, IATA, BEGAWB, ENDAWB, FLOWSCR, FLOWSCX, INFPHONE, AWBPHONE, CONTACT, NEEDBOOK, PRINTER, GENERIC, TWO_FORMS, ADDRESS1, ADDRESS2, ADDRESS3, IsAccount, AccountLength, PALLETCHARGE)
                    CarrierID = Convert.ToInt32(ID)
                End If
            Catch ex As Exception
                ErrorLogs.LogException(ex, "Error in Service::SaveCarrier::PageCarrier")
            End Try

            If (Not CarrierID.Contains("UNIQUE KEY constraint")) Then
                Return CarrierID
            Else
                'User.ErrorMessage = FarmID
                Return CarrierID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCarrier::PageCarrier")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function AddFarm(ByVal Farm As String, ByVal Name As String, ByVal City As String) As String
        Try
            Name = HttpUtility.UrlDecode(Name)
            Dim UserFarm As New User
            If Not Session("UserDetails") Is Nothing Then
                UserFarm = Session("UserDetails")
            End If

            For Each I As Farm In UserFarm.FarmList
                If (I.Farm = Farm) Then
                    Return "Farm already exist!!"
                End If
            Next

            Dim UFarm As New Farm
            UFarm.SlNo = UserFarm.NextFarmListSlno
            UFarm.Farm = Farm.ToUpper
            UFarm.Name = Name.ToUpper
            UFarm.City = City.ToUpper
            UserFarm.FarmList.Add(UFarm)
            UserFarm.FarmList.Sort(Function(x, y) String.Compare(x.Farm, y.Farm))

            Session("UserDetails") = UserFarm
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddFarm::PageUser")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DelUserFirmBySNo(ByVal SlNo As Integer) As String
        Try
            Dim UserFarm As New User
            If Not Session("UserDetails") Is Nothing Then
                UserFarm = Session("UserDetails")
            End If

            For Each Farm As Farm In UserFarm.FarmList
                If Farm.SlNo = SlNo Then
                    UserFarm.FarmList.Remove(Farm)
                    Exit For
                End If
            Next

            Session("UserDetails") = UserFarm

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DelUserFirmBySNo::PageUser")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmForAutocomplete(ByVal Searchtext As String) As List(Of Farm)
        Try
            Return Farms.GetFarmForAutocomplete(Searchtext.ToUpper())
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmForAutocomplete::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmDetailsByCode(ByVal Farm As String) As Farm
        Try
            Return Farms.GetFarmDetailsByCode(Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmDetailsByCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmsByCity(ByVal City As String) As String
        Try
            Dim Result As String = "<option value='0'>Choose Farm...</option>"
            Dim uFarmList As List(Of Farm) = Farms.GetFarmsByCity(City)
            For Each objFarm In uFarmList
                Result += "<option value='" + objFarm.FarmCode + "'>[" + objFarm.FarmCode + "] " + objFarm.Name + "</option>"
            Next
            Return Result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmsByCity::PagePO")
            Return "error"
        End Try
    End Function
    ' <System.Web.Services.WebMethod(True)>
    'Public Function GetFarmsFromSales(ByVal MainCity As String, ByVal flower As String) As String
    '    Try
    '        Dim Result As String = ""
    '        Dim uFarmList As List(Of Farm) = Farms.GetFarmsFromSales(MainCity, flower)
    '        For Each objFarm In uFarmList
    '            Result += "<option value='" + objFarm.FarmCode + "'>[" + objFarm.FarmCode + "] " + objFarm.Name + "</option>"
    '        Next
    '        Return Result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetFarmListFromMainCitySelection::PagePO")
    '        Return "error"
    '    End Try
    'End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmListFromMainCitySelection(ByVal MainCity As String) As String
        Try
            Dim Result As String = ""
            Dim uFarmList As List(Of Farm) = Farms.GetFarmListFromMainCitySelection(MainCity)
            For Each objFarm In uFarmList
                Result += "<option value='" + objFarm.FarmCode + "'>[" + objFarm.FarmCode + "] " + objFarm.Name + "</option>"
            Next
            Return Result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmListFromMainCitySelection::PagePO")
            Return "error"
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetFarmListByFlower(ByVal Flower As String, ByVal FarmCode As String) As String
    '    Try
    '        Dim Result As String = ""
    '        Dim uFarmList As List(Of Farm) = Farms.GetFarmListByFlower(Flower, FarmCode)
    '        For Each objFarm In uFarmList.OrderBy(Function(p) p.Name).ToList()
    '            Result += "<option value='" + objFarm.FarmCode + "'>[" + objFarm.FarmCode + "] " + objFarm.Name + "~" + objFarm.LASTCOST.ToString() + "~" + objFarm.DATELAST.ToString() + "~" + objFarm.Price.ToString() + "</option>"
    '        Next
    '        Return Result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetFarmListFromMainCitySelection::PagePO")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmListByFlower(ByVal Flower As String) As String
        Try
            Dim Result As String = ""
            Dim uFarmList As List(Of Farm) = Farms.GetFarmListByFlower(Flower, "")
            If uFarmList IsNot Nothing AndAlso uFarmList.Count > 0 Then
                For Each objFarm In uFarmList.ToList()
                    'Result += "<option value='" + objFarm.FarmCode + "'>[" + objFarm.FarmCode + "] " + objFarm.Name + "~" + objFarm.City + "~" + objFarm.LASTCOST.ToString() + "~" + objFarm.DATELAST.ToString() + "~" + objFarm.Price.ToString() + "</option>"
                    Result += "<option value='" + objFarm.FarmCode + "'>" + objFarm.FarmCode + "[" + objFarm.Name + "]" + "~" + objFarm.City + "~" + objFarm.LASTCOST.ToString() + "~" + objFarm.DATELAST.ToString() + "~" + objFarm.Price.ToString() + "</option>"
                Next

            End If
            Return Result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmListByFlower::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetUserFarmGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String) As XmlDocument
        Try
            Dim Data As New User
            If Not Session("UserDetails") Is Nothing Then
                Data = Session("UserDetails")
            End If


            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
            New XElement("rows", New XElement("page", page.ToString()),
            New XElement("total", Data.FarmList.Count.ToString()),
            Data.FarmList.Select(Function(row) New XElement("row", New XAttribute("id", row.SlNo),
            New XElement("cell", "<a href='#' id='Farmdelete_" & row.SlNo & "'><img src='images/Delete-icon.png'/></a>"),
            New XElement("cell", row.Farm),
            New XElement("cell", row.Name),
            New XElement("cell", row.City)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserFarmGrid::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmsByUserId(ByVal UserId As String) As List(Of Farm)
        Try
            If UserId <> "" Then
                Return Farms.GetFarmByUserID(UserId)
            Else
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmsByUserId::PageUser")
            Return Nothing
        End Try
    End Function
    'Added by Anubhuti 2023_04_20
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetFarmListByCATForFgrd(ByVal CAT As String) As XmlDocument
        Try
            Dim obj As New Farms.GetFarmDetails()
            Dim data As List(Of Farm) = obj.GetFarmListByCAT(CAT)
            Dim dt As DataTable = ConvertToDataTable(data)

            Dim TotalRowCount As Integer = 0

            If dt.Rows.Count > 0 Then
                TotalRowCount = data.Count
            End If
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                           New XElement("rows", New XElement("page", 1),
                           New XElement("total", TotalRowCount),
                           data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                           New XElement("cell", row.Farm),
                           New XElement("cell", row.Name)))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmListByCAT::PageFlower")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetFarmsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            If query = "ALL" Then
                whereCondition = query
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Farms.GetFarmDetails()

            Dim data As List(Of Farm) = obj.GetFarmsListForFgrd(whereCondition, sortExp, start, rp)


            Dim SelectedDetails As New ArrayList()
            If Not Context.Session("SelectedFarms") Is Nothing Then
                SelectedDetails = Context.Session("SelectedFarms")
                For Each Item In data
                    Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(Item.ID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        Item.Selected = True
                    End If
                Next
            End If

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Farm", "Name", "FOB", "City", "Country", "Manufacid", "Email"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)


                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "FarmDet$Files")
                Return BuildXmlDoc(filepath)
            Else

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='select_" & row.ID.ToString() & "' src='" & IIf(row.Selected, "images/check-on.png", "images/check-off.png") & "' />")),
                                        New XElement("cell", "<b><a href='#' id='DeleteFarms_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<b><a href='#' id='EditFarms_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.Farm),
                                        New XElement("cell", row.Name),
                                        New XElement("cell", row.FOB),
                                        New XElement("cell", row.City),
                                        New XElement("cell", row.Country),
                                        New XElement("cell", row.Manufacid),
                                        New XElement("cell", row.Email)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmsForFgrd::PageFarm")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmCityControl() As String
        Try
            Dim Cities As String = Farms.GetListOfFarmCity()
            Dim CityControls As String = ""
            Dim CityArray As String() = Cities.Split(",")
            If Cities <> "" Then
                For i As Integer = 0 To CityArray.Length - 1
                    CityControls += "<button id='btnfarmcity_" + CityArray(i).ToString() + "' class='button' value='" + CityArray(i).ToString() + "'>" + CityArray(i).ToString() + "</button>"
                Next
            End If
            Return CityControls
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmCityControl::PagePO")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetMainCityListForPurchaseOrder() As String
        Try
            Dim MainCities As String = "ALL,BOG,SJO,UIO,MDE,OTHERS,MIA,GUA,D.R"
            Dim MainCitiesSplited() As String = MainCities.Split(",")
            Dim CityControls As String = ""
            For i As Integer = 0 To MainCitiesSplited.Length - 1
                CityControls += "<div style='margin:2px;float:left;margin-right: 19px;text-indent: 6px;width: 70px;'><label><input " + IIf(MainCitiesSplited(i).ToString() = "ALL", "checked", "") + " type='radio' style='font-weight:bold' NAME='grpcity' value='" + MainCitiesSplited(i).ToString() + "' onclick=MainCityClicked('" + MainCitiesSplited(i).ToString() + "')>" + MainCitiesSplited(i).ToString() + "</button></label></div>"
            Next
            Return CityControls
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetMainCityListForPurchaseOrder::PagePO")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddFarmsinUIOCity(ByVal UserID As String) As String
        Try
            Dim UserInfo As New User
            If Not Session("UserDetails") Is Nothing Then
                UserInfo = Session("UserDetails")
            End If

            UserInfo.FarmList = Farms.GetFarmsinUIOCity(UserID, UserInfo.FarmList)
            UserInfo.FarmList.Sort(Function(x, y) String.Compare(x.Farm, y.Farm))
            Session("UserDetails") = UserInfo
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddFarmsinUIOCity::PageUser")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function DeleteFarm(ByVal ID As String) As String
        Try
            Return Farms.DeleteFarmbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteFarm::PageFarm")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmsByID(ID As String) As Farm
        Try
            Dim FarmDetails As Farm = GetFarmDetails.GetFarmsbyID(ID)
            Session("FarmDetails") = FarmDetails
            Return FarmDetails

            Dim FarmList As List(Of Farm) = Farms.GetFarmsForKometpost()

            For Each farminfo As Farm In FarmList


                Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                Dim jsonSring = "{  ""authenticationToken"": """ + KometAPIToken + """,  ""name"": ""FARM - " + farminfo.Farm + """,  ""portOrigin"": """ + farminfo.City + """,  ""code"": """ + farminfo.Farm + """,  ""phone1"": """",  ""phone2"": """",  ""webpage"":"""",  ""emailForPos"": """" }"
                Dim data = Encoding.UTF8.GetBytes(jsonSring)
                Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                Dim result_post = SendRequest(New Uri(kometapiuri + "/vendor.add"), data, "application/json", "POST")


                Dim json As JObject = JObject.Parse(result_post)
                Dim vendorid = json.SelectToken("vendorId")
                Dim message = json.SelectToken("message")
                Dim status = json.SelectToken("status")
                If Convert.ToBoolean(status) = True Then

                    Farms.UpdateKometID(vendorid, farminfo.Farm)
                    'obj.UpdateFarmsKometID(vendorid, farminfo.Farm)
                Else
                    ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportFarmsToKomet::PageFarms")
                End If



            Next

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmsByID::PageFarm")
            Return Nothing
        End Try
    End Function
    'Added by Anubhuti 2023_05_16
    <System.Web.Services.WebMethod(True)>
    Public Function GetPurchaseTypeList() As List(Of PurchaseTypes)
        Try
            Return Farms.GetPurchaseType()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPurchaseTypeList")
            Return Nothing
        End Try
    End Function

#End Region

#Region "System Email"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetUserEmail(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Email), qtype, query)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1


            Dim obj As New Email.GetSystemEmailDetails

            Dim data As List(Of Emails) = obj.GetSystemEmailForUser(whereCondition, sortExp, start, rp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", page.ToString()),
                                       New XElement("total", obj.TotalRows.ToString()),
                                       data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                       New XElement("cell", "<b><a href='#' id='Emaildelete_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                       New XElement("cell", "<b><a href='#' id='Emailedit_" & row.ID & "'>" & row.Email & "</a></b>"),
                                       New XElement("cell", "<img style='Cursor:pointer;' id='isweblogin_" & row.ID & "' src='" & IIf(row.WebLogin, "images/check-on.png", "images/check-off.png") & "' />"),
                                       New XElement("cell", "<img style='Cursor:pointer;' id='iserrors_" & row.ID & "' src='" & IIf(row.Errors, "images/check-on.png", "images/check-off.png") & "' />"),
                                       New XElement("cell", "<img style='Cursor:pointer;' id='isLabelNotification_" & row.ID & "' src='" & IIf(row.LabelNotification, "images/check-on.png", "images/check-off.png") & "' />"),
                                       New XElement("cell", "<img style='Cursor:pointer;' id='isXmlNotification_" & row.ID & "' src='" & IIf(row.XmlNotification, "images/check-on.png", "images/check-off.png") & "' />"),
                                       New XElement("cell", "<img style='Cursor:pointer;' id='isARXmlNotification_" & row.ID & "' src='" & IIf(row.ARXmlNotification, "images/check-on.png", "images/check-off.png") & "' />"),
                                       New XElement("cell", "<img style='Cursor:pointer;' id='isShipLabelNotification_" & row.ID & "' src='" & IIf(row.ShippingLabelNotification, "images/check-on.png", "images/check-off.png") & "' />"),
                                       New XElement("cell", "<img style='Cursor:pointer;' id='isEodReports_" & row.ID & "' src='" & IIf(row.EodReports, "images/check-on.png", "images/check-off.png") & "' />")))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserEmail::PageEmail")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveSystemEmail(ByVal UserEmail As String) As String
        Try
            Return Email.SaveSystemEmail(UserEmail)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveSystemEmail::PageEmail")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function EditSystemEmail(ByVal UserEmail As String, ByVal OldId As String) As String
        Try
            Return Email.EditSystemEmail(UserEmail, OldId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::EditSystemEmail::PageEmail")
            Return ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteSystemEmail(ByVal ID As Integer) As String
        Try
            Return Email.DeleteSystemEmail(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteSystemEmail::PageEmail")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSystemEmailById(ByVal ID As String) As Emails
        Try
            Return Email.GetSystemEmailById(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSystemEmailById::PageEmail")
            Return Nothing
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetWebLoginById(ID As String) As Emails
    '    Return Email.GetWebLoginById(ID)

    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleWebLogin(ByVal ID As Integer, ByVal WebLogin As String) As String
        Try
            Return Email.ToggleWebLogin(ID, WebLogin)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleWebLogin::PageEmail")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleInvoiceCreate(ByVal ID As Integer, ByVal InvoiceCreate As String) As String
        Try
            Return Email.ToggleInvoiceCreate(ID, InvoiceCreate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleInvoiceCreate::PageEmail")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleErrors(ByVal ID As Integer, ByVal Errors As String) As String
        Try
            Return Email.ToggleErrors(ID, Errors)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleErrors::PageEmail")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleLabelNotification(ByVal ID As Integer, ByVal IsLabelNotification As String) As String
        Try
            Return Email.ToggleLabelNotification(ID, IsLabelNotification)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleLabelNotification::PageEmail")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleXmlNotification(ByVal ID As Integer, ByVal XmlNotification As String) As String
        Try
            Return Email.ToggleXmlNotification(ID, XmlNotification)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleXmlNotification::PageEmail")
            Return "invalid"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ToggleARXmlNotification(ByVal ID As Integer, ByVal ARXmlNotification As String) As String
        Try
            Return Email.ToggleARXmlNotification(ID, ARXmlNotification)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleARXmlNotification::PageEmail")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleEodReports(ByVal ID As Integer, ByVal EodReports As String) As String
        Try
            Return Email.ToggleEodReports(ID, EodReports)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleEodReports::PageEmail")
            Return "invalid"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetEmailIDsToSendXml() As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end
            Dim LEmail As List(Of Emails) = Email.GetAllSystemEmails()
            Dim UserDetails As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                UserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                UserDetails = Session("LoginAdminDetails")
            End If
            Dim Emailids As String = String.Join(",", LEmail.Where(Function(s) s.XmlNotification = True).[Select](Function(x) x.Email))
            If Emailids <> "" Then
                Emailids += "," + UserDetails.Email
            Else
                Emailids += UserDetails.Email
            End If
            Return Emailids
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetEmailIDsToSendXml")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleShipLabelNotification(ByVal ID As Integer, ByVal IsShipLabelNotification As String) As String
        Try
            Return Email.ToggleShipLabelNotification(ID, IsShipLabelNotification)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleShippingLabelNotification::PageEmail")
            Return "invalid"
        End Try
    End Function

#End Region

#Region "Label Type"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetLabelTypeFXG(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(LabType), qtype, query)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1


            Dim obj As New LabType.GetLabelTypeDetails

            Dim data As List(Of LabTypes) = obj.GetSpLabelType(whereCondition, sortExp, start, rp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", page.ToString()),
                                       New XElement("total", obj.TotalRows.ToString()),
                                       data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                       New XElement("cell", "<b><a href='#' id='Labtypedelete_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                       New XElement("cell", "<b><a href='#' id='Labtypeedit_" & row.ID & "'>" & row.Labeltype & "</a></b>")))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetLabelTypeFXG::PageSettings")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveLabeltype(ByVal Labeltype As String) As String
        Try
            Return LabType.SaveLabeltype(Labeltype)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveLabeltype::PageSettings")
            Return ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function EditLabeltype(ByVal Labeltype As String, ByVal OldId As String) As String
        Try
            Return LabType.EditLabeltype(Labeltype, OldId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::EditLabeltype::PageSettings")
            Return ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteLabeltype(ByVal ID As Integer) As String
        Try
            Return LabType.DeleteLabeltype(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteLabeltype::PageSettings")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetLabelTypeById(ByVal ID As String) As LabTypes
        Try
            Return LabType.GetLabelTypeById(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetLabelTypeById::PageSettings")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetLabelType() As List(Of LabTypes)
        Try
            Return LabType.GetLabelType()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetLabelType::PageSettings")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Reports"

    '<System.Web.Services.WebMethod(True)>
    'Public Async Function testService() As Task(Of String)
    'Return "success message"
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportLabels(ByVal SelectedPOs As String) As String
        'checkusersessionIsActive:start
        Dim SessionStatus As String = ""
        If Not Session("LoginUserDetails") Is Nothing Then
            SessionStatus = CheckLoginSessionIsActive("User")
        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            SessionStatus = CheckLoginSessionIsActive("Admin")
        End If
        If SessionStatus = "InActive" Then
            Return "LogOut"
        End If
        Try

            Dim User As New User
            Dim BodyMessage As String = ""
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ""

            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim CompanyNameLabel As String = ConfigurationManager.AppSettings("CompanyNameForLabel").ToString()
            Dim CompanyAddress As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyAddressForLabel"))

            Dim filename As String = ""
            filename = "PoDetails_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"

            Dim AWBs As String = ""
            Dim Farms As String = ""

            Dim TotalLabelCount As Integer = 0

            Dim Pokey As String = ""
            Dim Ord As String = ""
            If (SelectedPOs.Split(",").Count > 0) Then
                Dim objPdf As New ExportSSRS
                foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
                Dim SysPath As String = foldername
                CombinedFilePath = foldername + "/" + filename
                Dim LabelName = ""

                Dim settings As New List(Of AdminSetting)
                settings = AdminSettings.GetAdminSettings()

                If (settings(0).LabelTypeID = 1) Then
                    LabelName = "PO"
                ElseIf (settings(0).LabelTypeID = 2) Then
                    LabelName = "POLABEL1"
                ElseIf (settings(0).LabelTypeID = 3) Then
                    LabelName = "POLABEL2"
                Else
                    LabelName = "PO"
                End If

                Dim WhereCondition As String = ""
                For Each po In SelectedPOs.Split(",")
                    Dim PoDet As BOPO = DAOPO.GetPurchaseOrderDetailsByPOQId(po)

                    'AppendLog("Getting the Po Details for :" + PoDet.PONumber, "")
                    If PoDet.ErrorMessage <> "" Then
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, PoDet.ErrorMessage, "", "Error Notification", "error")
                        Return Nothing
                    End If

                    Dim Sequence As Integer = 0
                    AppendLog("Before afect report table :", "")
                    Sequence = ConfirmedPOs.InsertPODetailsForReportExport(PoDet.DetailID, PoDet.PONumber, PoDet.Ord, PoDet.Farm, PoDet.FlowerCategory, PoDet.QtyBConf, PoDet.UOM, PoDet.ProdNameq,
                                                                PoDet.BoxNumber.TrimStart().TrimEnd(), PoDet.BoxCode, PoDet.BreakDown, PoDet.AWB, PoDet.HAWB, PoDet.CustNumber,
                                                                PoDet.ProdCodeq, PoDet.FarmName, PoDet.ManufacID, PoDet.QtyXBox, "ConfirmedPO", PoDet.Invoice,
                                                                PoDet.Length, PoDet.Height, PoDet.Width, PoDet.UnitCosq)

                    AppendLog("The Sequence is :" + Sequence.ToString(), "")
                    Dim SequenceFrom As Integer = Sequence - PoDet.QTYBOX
                    Dim seq As Integer = 0

                    TotalLabelCount = TotalLabelCount + PoDet.QTYBOX
                    WhereCondition += IIf(WhereCondition.Length <= 0, "", " Or ")
                    WhereCondition += " (PoKey=" + PoDet.DetailID.ToString() + ")"
                    If (Not AWBs.Contains(PoDet.AWB)) Then
                        AWBs += PoDet.AWB + ","
                    End If

                    If (Not Farms.Contains(PoDet.Farm)) Then
                        Farms += PoDet.Farm + ","
                    End If
                Next

                WhereCondition = "(" + WhereCondition + ")" + "And ImportedFrom='ConfirmedPO'"

                If Farms.Length <= 4 Then
                    filename = Farms.Substring(0, 3) + "_" + filename
                End If
                Dim FullFileName As String = SysPath & filename

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}

                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "CompanyName"
                reportParameterCollection(1).Values.Add(CompanyNameLabel)

                reportParameterCollection(2) = New ReportParameter()
                reportParameterCollection(2).Name = "Address"
                reportParameterCollection(2).Values.Add(CompanyAddress)

                reportParameterCollection(3) = New ReportParameter()
                reportParameterCollection(3).Name = "WhereCondition"
                reportParameterCollection(3).Values.Add(WhereCondition)

                reportParameterCollection(4) = New ReportParameter()
                reportParameterCollection(4).Name = "ImportedFrom"
                reportParameterCollection(4).Values.Add("'ConfirmedPO'")

                AppendLog("The File name is  :" + FullFileName, "")

                Dim s As String = objPdf.ExportToPdf(filename, LabelName, reportParameterCollection, ExportSSRS.PdfOrientation.Label, ExportSSRS.FileType.PDF, RptDataSourceName)

                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                LabelPrintLogs.SaveLabelPrintLog(TotalLabelCount, User.ID, WhereCondition)

                'BodyMessage = "Label was Printed by <b>" + User.Email + "</b> on <b>" + Now.ToString("yyyy_MM_dd HH_mm_ss") + "</b>"
                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
                AppendLog("Exported PDF file path" + (ReportExportFolder + filename), "")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Label Printing Notification for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email), "labelnotification")
                If Not s.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Export PO Label for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Export PO Label for Awb" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email), "labelnotification")
                End If

                Return ReportExportFolder + "\" + filename
            Else
                Return "Please select po"

            End If



        Catch ex As Exception
            AppendLog("Error in Export Po Label", "")
            AppendLog("Exception Message is :" + ex.Message, "")
            AppendLog("Inner Exception is :" + ex.ToString(), "")

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim BodyMessage As String = ex.Message.ToString() + "</br>" + " on " + Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + "</b>"
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            Dim unused = Logs.SendMail(FromEmail, "jose@dflower.com", BodyMessage, "", "Error Notification")
            ErrorLogs.LogException(ex, "Error in Service::ExportLabels")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintManualPOLabel() As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            Dim BodyMessage As String = ""
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ""
            ' Dim CombineFileName As String = ""
            'Dim fileNames As String()
            Dim PoFiles As New List(Of String)
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim CompanyNameLabel As String = ConfigurationManager.AppSettings("CompanyNameForLabel").ToString()
            Dim CompanyAddress As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyAddressForLabel"))
            Dim AWBs As String = ""
            Dim Farms As String = ""
            Dim WhereCondition As String = ""

            Dim filename As String = ""
            filename = "PoDetails_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"

            Dim SelectedManualPo As New ArrayList
            If Not Session("SelectedManualPOs") Is Nothing Then
                SelectedManualPo = Session("SelectedManualPOs")
            End If
            Dim Pokey As String = ""

            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS

            Dim settings As New List(Of AdminSetting)
            settings = AdminSettings.GetAdminSettings()
            Dim LabelName = ""

            If (settings(0).LabelTypeID = 1) Then
                LabelName = "PO"
            ElseIf (settings(0).LabelTypeID = 2) Then
                LabelName = "POLABEL1"
            ElseIf (settings(0).LabelTypeID = 3) Then
                LabelName = "POLABEL2"
            End If

            Dim TotalLabelCount As Integer = 0
            Dim MsgStr As String = ""
            If (SelectedManualPo.Count > 0) Then
                For Each po In SelectedManualPo
                    Pokey = po.ToString()
                    If MsgStr = "" Then
                        MsgStr = ManualPODetails.UpdateBlankAWB(Pokey)
                    End If
                    Dim PoDet As ManualPODetail = ManualPODetails.GetManualPODetailsByID(Pokey)


                    Dim Sequence As Integer = 0


                    Sequence = ConfirmedPOs.InsertPODetailsForReportExport(PoDet.DetailID, PoDet.PO, 1, PoDet.Farm, PoDet.FlowerCategory, PoDet.Boxes, PoDet.UOM, PoDet.Flowername,
                                                            PoDet.BoxNumber, PoDet.BoxCode, PoDet.BreakDown, PoDet.AWB, PoDet.HAWB, PoDet.CustNumber, PoDet.Flower, PoDet.FarmName, PoDet.ManufacID, PoDet.UnitsPerBox, "ManualPO", PoDet.Invoice, "0", "0", "0", PoDet.Cost)

                    Dim SequenceFrom As Integer = Sequence - PoDet.Boxes

                    CombinedFilePath = foldername + "/" + filename
                    Dim seq As Integer = 0

                    TotalLabelCount = TotalLabelCount + PoDet.Boxes
                    WhereCondition += IIf(WhereCondition.Length <= 0, "", " Or ")
                    WhereCondition += " (Pokey=" + Pokey.ToString() + " and Ord=1)"
                    If (Not AWBs.Contains(PoDet.AWB)) Then
                        AWBs += PoDet.AWB + ","
                    End If

                    If (Not Farms.Contains(PoDet.Farm)) Then
                        Farms += PoDet.Farm + ","
                    End If

                Next
                WhereCondition = "(" + WhereCondition + ")" + "And ImportedFrom='ManualPO'"

                Dim FullFileName As String = SysPath & filename

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}

                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "CompanyName"
                reportParameterCollection(1).Values.Add(CompanyNameLabel)

                reportParameterCollection(2) = New ReportParameter()
                reportParameterCollection(2).Name = "Address"
                reportParameterCollection(2).Values.Add(CompanyAddress)

                reportParameterCollection(3) = New ReportParameter()
                reportParameterCollection(3).Name = "WhereCondition"
                reportParameterCollection(3).Values.Add(WhereCondition)

                reportParameterCollection(4) = New ReportParameter()
                reportParameterCollection(4).Name = "ImportedFrom"
                reportParameterCollection(4).Values.Add("'ManualPO'")

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()

                Dim s As String = objPdf.ExportToPdf(filename, LabelName, reportParameterCollection, ExportSSRS.PdfOrientation.Label, ExportSSRS.FileType.PDF, RptDataSourceName)

                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                LabelPrintLogs.SaveLabelPrintLog(TotalLabelCount, User.ID, WhereCondition)
                'BodyMessage = "Attached File was Generated by <b>" + User.Email + "</b> on <b>" + Now.ToString("yyyy_MM_dd HH_mm_ss") + "</b>"

                'Logs.VendorEmailLogs(User, BodyMessage, CombinedFilePath, "Label Printing Notification", "labelprint")
                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                AppendLog("Exported PDF file path:" + (ReportExportFolder + "\" + filename), "")
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Label Printing Notification for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email), "labelnotification")
                If Not s.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToUpper()), "labelnotification")
                    ''''Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label for Awb" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email), "labelnotification")
                End If

                Return ReportExportFolder + "\" + filename

            Else
                Return "Please select po"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintManualPOLabel")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintManualPOLabelByHeader() As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            Dim BodyMessage As String = ""
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ""
            ' Dim CombineFileName As String = ""
            'Dim fileNames As String()
            Dim PoFiles As New List(Of String)
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim CompanyNameLabel As String = ConfigurationManager.AppSettings("CompanyNameForLabel").ToString()
            Dim CompanyAddress As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyAddressForLabel"))
            Dim AWBs As String = ""
            Dim Farms As String = ""
            Dim WhereCondition As String = ""

            Dim filename As String = ""
            filename = "PoDetails_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"

            Dim SelectedHeaderManualPo As New ArrayList
            Dim SelectedManualPo As New ArrayList
            If Not Session("SelectedHeaderManualPOs") Is Nothing Then
                SelectedHeaderManualPo = Session("SelectedHeaderManualPOs")
            End If

            For Each HeaderID In SelectedHeaderManualPo
                Dim data As List(Of ManualPODetail) = ManualPODetails.GetManualPODetailsByHeaderID(HeaderID.ToString())
                For Each obj1 In data
                    SelectedManualPo.Add(obj1.DetailID.ToString())
                Next
            Next

            Dim Pokey As String = ""

            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS

            Dim settings As New List(Of AdminSetting)
            settings = AdminSettings.GetAdminSettings()
            Dim LabelName = ""

            If (settings(0).LabelTypeID = 1) Then
                LabelName = "PO"
            ElseIf (settings(0).LabelTypeID = 2) Then
                LabelName = "POLABEL1"
            ElseIf (settings(0).LabelTypeID = 3) Then
                LabelName = "POLABEL2"
            End If

            Dim TotalLabelCount As Integer = 0
            If (SelectedManualPo.Count > 0) Then
                For Each po In SelectedManualPo
                    Pokey = po.ToString()
                    Dim PoDet As ManualPODetail = ManualPODetails.GetManualPODetailsByID(Pokey)


                    Dim Sequence As Integer = 0
                    'Dim FlowerDeta = GetFlowersByCode(PoDet.Flower)

                    Sequence = ConfirmedPOs.InsertPODetailsForReportExport(PoDet.DetailID, PoDet.PO, 1, PoDet.Farm, PoDet.FlowerCategory, PoDet.Boxes, PoDet.UOM, PoDet.Flowername,
                                                            PoDet.BoxNumber, PoDet.BoxCode, PoDet.BreakDown, PoDet.AWB, PoDet.HAWB, PoDet.CustNumber, PoDet.Flower, PoDet.FarmName,
                                                                           PoDet.ManufacID, PoDet.UnitsPerBox, "ManualPO", PoDet.Invoice, "0", "0", "0", PoDet.Cost)



                    'AppendLog("The label name is :" + LabelName, "")




                    Dim SequenceFrom As Integer = Sequence - PoDet.Boxes





                    ' AppendLog("The Compbined File name is :" + CombineFileName, "")

                    ' CombinedFilePath = HttpContext.Current.Server.MapPath("~/" + foldername + "/") + filename
                    CombinedFilePath = foldername + "/" + filename

                    '  AppendLog("The CombinedFilePath File name is :" + CombinedFilePath, "")


                    Dim seq As Integer = 0

                    'AppendLog("Box qty to loops :" + PoDet.QtyBox.ToString(), "")
                    'Dim FarmImgPath As String = ConvertTextToImage(PoDet.Farm) 'convert farm text to image and gets it path
                    'Dim ProductCategoryImgPath As String = ConvertTextToImage(PoDet.FlowerCategory) 'convert ProductCategory text to image and gets it path
                    'Dim BoxNumberImgPath As String = ConvertTextToImageForBoxNumber(PoDet.BoxNumber) 'convert ProductCategory text to image and gets it path
                    TotalLabelCount = TotalLabelCount + PoDet.Boxes

                    WhereCondition += IIf(WhereCondition.Length <= 0, "", " Or ")
                    WhereCondition += " (Pokey=" + Pokey.ToString() + " and Ord=1)"
                    If (Not AWBs.Contains(PoDet.AWB)) Then
                        AWBs += PoDet.AWB + ","
                    End If

                    If (Not Farms.Contains(PoDet.Farm)) Then
                        Farms += PoDet.Farm + ","
                    End If

                Next
                WhereCondition = "(" + WhereCondition + ")" + "And ImportedFrom='ManualPO'"

                AppendLog("Where condition to export the label", "")
                AppendLog(WhereCondition, "")


                Dim FullFileName As String = SysPath & filename

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}

                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "CompanyName"
                reportParameterCollection(1).Values.Add(CompanyNameLabel)

                reportParameterCollection(2) = New ReportParameter()
                reportParameterCollection(2).Name = "Address"
                reportParameterCollection(2).Values.Add(CompanyAddress)

                reportParameterCollection(3) = New ReportParameter()
                reportParameterCollection(3).Name = "WhereCondition"
                reportParameterCollection(3).Values.Add(WhereCondition)

                reportParameterCollection(4) = New ReportParameter()
                reportParameterCollection(4).Name = "ImportedFrom"
                reportParameterCollection(4).Values.Add("'ManualPO'")

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()

                Dim s As String = objPdf.ExportToPdf(filename, LabelName, reportParameterCollection, ExportSSRS.PdfOrientation.Label, ExportSSRS.FileType.PDF, RptDataSourceName)



                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                LabelPrintLogs.SaveLabelPrintLog(TotalLabelCount, User.ID, WhereCondition)

                'BodyMessage = "Attached File was Generated by <b>" + User.Email + "</b> on <b>" + Now.ToString("yyyy_MM_dd HH_mm_ss") + "</b>"

                'Logs.VendorEmailLogs(User, BodyMessage, CombinedFilePath, "Label Printing Notification", "labelprint")
                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                AppendLog("Exported PDF file path" + (ReportExportFolder + "\" + filename), "")
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Label Printing Notification for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email), "labelnotification")
                If Not s.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email), "labelnotification")
                End If
                Return ReportExportFolder + "\" + filename

            Else
                Return "Please select po"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintManualPOLabelByHeader")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintRackLabel(ByVal RackText As String, ByVal RackRange As String) As String
        Try


            Dim User As New User

            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If


            Dim CompanyNameLabel As String = ConfigurationManager.AppSettings("CompanyNameForLabel").ToString()
            Dim CompanyAddress As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyAddressForLabel"))

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "RackText"
            reportParameterCollection(1).Values.Add(RackText)

            Dim Range = RackRange.Split("-")
            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "RackRangeFrom"
            reportParameterCollection(2).Values.Add(Range(0))

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "RackRangeTo"
            reportParameterCollection(3).Values.Add(Range(1))



            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()


            'Dim filename As String = "RptInventory_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"
            Dim filename As String = "RackLabels_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"


            'Dim ReportName As String = "Test.pdf"
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptRackLabel", reportParameterCollection, ExportSSRS.PdfOrientation.ShippingLabel, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If Not ReportName.Trim().Contains("error : ") Then

                'Logs.VendorEmailLogs(User, "", ReportExportFolder + "/" + filename, (CompanyName + " Rack Label printed by user:" + User.Email), "labelnotification")
            End If
            Return ReportName


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintRackLabel")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintIncomingProductDetails(ByVal Farm As String, ByVal HeaderId As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim CompanyNameLabel As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyNameForLabel"))

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}

            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "farm"
            reportParameterCollection(0).Values.Add(Farm)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "ConnectionString"
            reportParameterCollection(1).Values.Add(ConString)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "CompanyName"
            reportParameterCollection(2).Values.Add(CompanyNameLabel)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "UserId"
            reportParameterCollection(3).Values.Add(User.ID)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "HeaderId"
            reportParameterCollection(4).Values.Add(HeaderId)

            Dim filename As String = "IncomingProductDetails_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"

            'VEN::For send email for printing reports
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Incoming Product Details by user:" + User.Email), "labelnotification")
            'Return objPdf.ExportToPdf(filename, "rptIncomingProductReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Dim s As String = objPdf.ExportToPdf(filename, "rptIncomingProductReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")

            If Not s.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Incoming Product Details by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Incoming Product Details by user:" + User.Email), "labelnotification")
            End If
            Return s
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintIncomingProductDetails")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintDVLabels() As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(0) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)
            Dim filename As String = "DVLabels_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"

            'VEN::For send email for printing reports
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Lable Printing Notification for DV Labels by user:" + User.Email), "labelnotification")
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " DV Labels by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'Return objPdf.ExportToPdf(filename, "rptDVLabels", reportParameterCollection, ExportSSRS.PdfOrientation.DVLabel, ExportSSRS.FileType.PDF, "BloomsReportSource")

            Dim s As String = objPdf.ExportToPdf(filename, "rptDVLabels", reportParameterCollection, ExportSSRS.PdfOrientation.DVLabel, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If Not s.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " DV Labels by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " DV Labels by user:" + User.Email), "labelnotification")
            End If
            Return s

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDVLabels")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintNewDVLabels() As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(0) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)
            Dim filename As String = "DVLabels_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"

            'VEN::For send email for printing reports
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Lable Printing Notification for DV Labels by user:" + User.Email), "labelnotification")
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " DV Labels by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'Return objPdf.ExportToPdf(filename, "rptNewDVLabels", reportParameterCollection, ExportSSRS.PdfOrientation.DVLabel, ExportSSRS.FileType.PDF, "BloomsReportSource")

            Dim s As String = objPdf.ExportToPdf(filename, "rptNewDVLabels", reportParameterCollection, ExportSSRS.PdfOrientation.DVLabel, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If Not s.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " DV Labels by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " New DV Labels by user:" + User.Email), "labelnotification")
            End If



            Return s

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintNewDVLabels")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintInventoryLabel(ByVal AWB As String, ByVal Farm As String, ByVal Flower As String, ByVal DateRec As String, ByVal BoxNum As String,
                                       ByVal TableName As String, ByVal ReceivedPiecesOnly As String, ByVal AWBFlag As String) As String
        Try
            Dim XMLInventory As XElement
            Dim Farms As String = ""
            Dim LabelsCount As Integer = 0
            Dim User As New User

            DateRec = "'" + DateRec + "'"
            Dim InventoryDetailsFromSQL = Inventory.GetInventoryDetailsByAWB(AWB, Farm, Flower, DateRec, BoxNum, TableName, ReceivedPiecesOnly, AWBFlag)
            If InventoryDetailsFromSQL.Count > 0 Then

                If InventoryDetailsFromSQL(0).ErrorMessage = "" Then
                    XMLInventory = New XElement("Inventory",
                    From Inv In InventoryDetailsFromSQL
                    Select New XElement("Detail", "",
                    New XElement("Farm", Inv.Farm),
                    New XElement("CAT", Inv.ProductCategory),
                    New XElement("Name", Inv.ProductName.Replace("'", "''")),
                    New XElement("Code", Inv.ProductCode),
                    New XElement("UOM", Inv.UOM),
                    New XElement("CustNum", Inv.CustNum.ToString()),
                    New XElement("OrderNum", Inv.OrderNumber.ToString()),
                    New XElement("AWB", Inv.AWB),
                    New XElement("Units", Inv.CSREC.ToString()),
                    New XElement("PONumber", Convert.ToString(Inv.PO)),
                    New XElement("BoxNum", Inv.BoxNumber.ToString()),
                    New XElement("Comments", Convert.ToString(Inv.Comments)),
                    New XElement("ManufacId", Convert.ToString(Inv.ManufacID)),
                    New XElement("Invoice", Convert.ToString(Inv.Invoice)),
                    New XElement("UnitsPerBox", Convert.ToString(Inv.UnitsPerBox)),
                    New XElement("Length", Convert.ToString(Inv.Length)),
                    New XElement("Width", Convert.ToString(Inv.Width)),
                    New XElement("Height", Convert.ToString(Inv.Height))))

                    For Each det In InventoryDetailsFromSQL
                        If (Not Farms.Contains(det.Farm)) Then
                            Farms += det.Farm + ","
                        End If

                        LabelsCount = LabelsCount + det.CSREC
                    Next
                Else

                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, InventoryDetailsFromSQL(0).ErrorMessage, "", "Error Notification", "error")

                    Return Nothing
                End If
            Else
                Return Nothing
            End If


            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Inventory.InsertInventoryDetailsForLabel(XMLInventory.ToString(), User.ID)

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim CompanyNameLabel As String = ConfigurationManager.AppSettings("CompanyNameForLabel").ToString()
            Dim CompanyAddress As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyAddressForLabel"))

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "CompanyName"
            reportParameterCollection(1).Values.Add(CompanyNameLabel)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Address"
            reportParameterCollection(2).Values.Add(CompanyAddress)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "WhereCondition"
            reportParameterCollection(3).Values.Add(" ")

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ImportedFrom"
            reportParameterCollection(4).Values.Add("inventory")

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()


            'Dim filename As String = "RptInventory_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"
            Dim filename As String = "Labels for Awb_" + IIf(AWB.Length > 5, Right(AWB, 5), AWB) + IIf(Farm <> "", "_" + Farm, "") + "_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim ReportName As String = objPdf.ExportToPdf(filename, "PO", reportParameterCollection, ExportSSRS.PdfOrientation.Label, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Logs.VendorEmailLogs(User, "", ReportExportFolder + "/" + filename, (CompanyName + " Label Printing Notification for Awb#" + AWB.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + LabelsCount.ToString() + " by user:" + User.Email), "labelnotification")
            If Not ReportName.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, "", ReportExportFolder + "/" + filename, (CompanyName + " Label for Awb#" + AWB.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + LabelsCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress().ToString()), "labelnotification")
                ''Logs.VendorEmailLogs(User, "", ReportExportFolder + "/" + filename, (CompanyName + " Label for Awb" + AWB.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + LabelsCount.ToString() + " by user:" + User.Email), "labelnotification")
            End If
            Return ReportName


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInventoryLabel")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintLadingBill(ByVal Order As String) As String
        Try
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            Dim HeaderInformation = CreateXMLForLadingBillHeaderSQL(Order)
            Dim DetailsInformation = CreateXMLForLadingBillDetailsSQL(Order)
            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertSalesOrderLadingBillDetails(HeaderInformation, DetailsInformation)

                'checkusersessionIsActive:start

                Dim User As New User
                If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                End If
                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "Order"
                reportParameterCollection(1).Values.Add(Order)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                If Order.Contains(",") Then
                    filename = CompanyName + "_" + "BillofLading_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                Else
                    filename = CompanyName + "_" + "BillofLading_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                End If

                'Logs.VendorEmailLogs(User, "", filename, (CompanyName + " Label Printing Notification For Awb#" + AWB.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + LablesCount.ToString() + " by user:" + User.Email), "labelnotification")

                'VEN::For send email for printing reports
                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString() + "\BillOfLading"
                Dim BodyMessage As String = ""
                Dim ReportName As String = ""
                If CompanyName <> "BloomsUSA" Then
                    ReportName = objPdf.ExportToPdf(filename, "rptBillofLadingCross", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource", "BillOfLading")
                Else
                    ReportName = objPdf.ExportToPdf(filename, "rptBillofLadingBlooms", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource", "BillOfLading")
                End If

                If Not ReportName.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Bill of Lading For Invoice#:" + Order + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Bill of Lading For Invoice:" + Order + " by user:" + User.Email), "labelnotification")
                End If

                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification for Bill of Lading. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                Return ReportExportFolder + "\" + filename 'ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" Or DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintLadingBill")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintLadingBillfromVet(ByVal Order As String) As String
        Try
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            Dim HeaderInformation = CreateXMLForLadingBillHeaderSQLfromVet(Order)
            Dim DetailsInformation = CreateXMLForLadingBillDetailsSQLfromVet(Order)
            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertSalesOrderLadingBillDetails(HeaderInformation, DetailsInformation)

                'checkusersessionIsActive:start

                Dim User As New User
                If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                End If
                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "Order"
                reportParameterCollection(1).Values.Add(Order)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                If Order.Contains(",") Then
                    filename = CompanyName + "_" + "BillofLading_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                Else
                    filename = CompanyName + "_" + "BillofLading_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                End If

                'Logs.VendorEmailLogs(User, "", filename, (CompanyName + " Label Printing Notification For Awb#" + AWB.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + LablesCount.ToString() + " by user:" + User.Email), "labelnotification")

                'VEN::For send email for printing reports
                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString() + "\BillOfLading"
                Dim BodyMessage As String = ""
                Dim ReportName As String = ""
                If CompanyName <> "BloomsUSA" Then
                    ReportName = objPdf.ExportToPdf(filename, "rptBillofLadingCross", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource", "BillOfLading")
                Else
                    ReportName = objPdf.ExportToPdf(filename, "rptBillofLadingBlooms", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource", "BillOfLading")
                End If

                If Not ReportName.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Bill of Lading For Invoice#:" + Order + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Bill of Lading For Invoice:" + Order + " by user:" + User.Email), "labelnotification")
                End If

                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification for Bill of Lading. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                Return ReportExportFolder + "\" + filename 'ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" Or DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintLadingBill")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintLadingBillConsolidated(ByVal Order As String) As String
        Try
            Dim HeaderInformation = CreateXMLForLadingBillHeaderSQL(Order)
            Dim DetailsInformation = CreateXMLForLadingBillDetailsSQL(Order)
            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertSalesOrderLadingBillDetails(HeaderInformation, DetailsInformation)

                'checkusersessionIsActive:start
                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If
                'end

                Dim User As New User
                If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                End If
                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "Order"
                reportParameterCollection(1).Values.Add(Order)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                If Order.Contains(",") Then
                    filename = CompanyName + "_" + "ConsolidatedBillofLading_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                Else
                    filename = CompanyName + "_" + "ConsolidatedBillofLading_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                End If

                'Logs.VendorEmailLogs(User, "", filename, (CompanyName + " Label Printing Notification For Awb#" + AWB.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + LablesCount.ToString() + " by user:" + User.Email), "labelnotification")

                'VEN::For send email for printing reports
                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString() + "\BillOfLading"
                Dim BodyMessage As String = ""
                Dim ReportName As String = ""
                ReportName = objPdf.ExportToPdf(filename, "rptConsolidatedBillofLading", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource", "BillOfLading")

                If Not ReportName.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Bill of Lading For Invoice#:" + Order + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Bill of Lading For Invoice:" + Order + " by user:" + User.Email), "labelnotification")
                End If

                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification for Bill of Lading. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                Return ReportExportFolder + "\" + filename 'ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" Or DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintLadingBill")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintPickList(ByVal Order As String) As String
        Try
            Dim HeaderInformation = CreateXMLForPickListHeaderSQL(Order)
            Dim DetailsInformation = CreateXMLForPickListDetailsSQL(Order)
            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data" And DetailsInformation <> "No Data") Then
                SalesOrder.InsertSalesOrderPickListDetails(HeaderInformation, DetailsInformation)

                'checkusersessionIsActive:start
                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If
                'end

                Dim User As New User
                If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                End If
                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "Order"
                reportParameterCollection(1).Values.Add(Order)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                If Order.Contains(",") Then
                    filename = CompanyName + "" + "PickList_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                Else
                    filename = CompanyName + "" + "PickList_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                End If

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString() + "\PickList"
                Dim BodyMessage As String = ""
                Dim ReportName As String = objPdf.ExportToPdf(filename, "rptPickList", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource", "PickList")
                If Not ReportName.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Pick List For Invoice#:" + Order + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Pick List For Invoice:" + Order + " by user:" + User.Email), "labelnotification")
                End If

                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Pick List. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                Return ReportExportFolder + "\" + filename 'ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" And DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPickList")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    'Added by Belal on 10th July 2021
    <System.Web.Services.WebMethod(True)>
    Public Function PrintPickListWhileSaving(ByVal Order As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim reportName As String = PrintPickList(Order)

            Dim OrderArray As List(Of String) = New List(Of String)
            OrderArray.Add(Order)
            Dim PrintedOrder As List(Of String) = New List(Of String)
            PrintedOrder.Add("PickList while saving")
            SalesOrder.UpdateActivityLogForOrderReports(OrderArray, User.Email, User.UserName, PrintedOrder, LocalIPAddress())
            Return reportName
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPickListWhileSaving")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    'Added by Belal on 11th July 2021
    <System.Web.Services.WebMethod(True)>
    Public Function PrintShippingLabelWhileSaving(ByVal Order As String, ByVal ShipDate As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim reportName As String = PrintShippingLabelList(Order, ShipDate, "", "")

            Dim OrderArray As List(Of String) = New List(Of String)
            OrderArray.Add(Order)
            Dim PrintedOrder As List(Of String) = New List(Of String)
            PrintedOrder.Add("Shipping Label while saving")
            SalesOrder.UpdateActivityLogForOrderReports(OrderArray, User.Email, User.UserName, PrintedOrder, LocalIPAddress())
            Return reportName
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintShippingLabelWhileSaving")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintMultipleReportsInOrder(ByVal PrintBillofLading As String, ByVal PrintConsolidatedBillofLading As String, ByVal PrintPickListselected As String, ByVal SelectedOrders As String, ByVal PrintShippingLabel As String, ByVal PrintCCI As String, ByVal PrintInvoice As String, ByVal ShipDate As String, ByVal CA As String, ByVal PO As String) As String
        Try
            Dim Outputpdf As New PdfSharp.Pdf.PdfDocument()
            Dim PrintBillofLadingres As String = "", PrintPickListselectedres As String = "", PrintShippingLabelselectedres As String = "", PrintCCIselectedres As String = "", PrintInvoices As String = ""
            'Dim SelectedOrders As New ArrayList
            Dim filename As String = ""
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim CombineFileName As String = ""
            Dim FullFileName As String = ""
            Dim filepath As String = ""
            Dim fileNames As String() = {}
            Dim SelectedCnt As Integer
            Dim SysPath As String = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()  'HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim PoFiles As New List(Of String)
            Dim PrintedReports As New List(Of String)
            'If Not Session("SelectedOrders") Is Nothing Then
            '    SelectedOrders = Session("SelectedOrders")
            'End If
            Dim FramePDFTable As String = ""
            Dim webClient As New WebClient()

            Dim directory As New DirectoryInfo(HttpContext.Current.Server.MapPath("Temp/"))

            Dim User As New User
            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return "LogOut"
            Else
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If
            'end



            Dim SOrders = SelectedOrders.Split(",").ToList()

            For i = SOrders.Count - 1 To 0 Step -1
                Dim InvoiceHasNegativeBoxes = CheckInvoiceHasNegativeBoxes(SOrders(i), 0)
                If InvoiceHasNegativeBoxes = "1" Then
                    SOrders.RemoveAt(i)
                End If
            Next

            If SOrders.Count > 0 Then

                Dim OrderIDs As String = String.Join(",", SOrders)


                If PrintShippingLabel = 1 Then
                    PrintShippingLabelselectedres = PrintShippingLabelList(OrderIDs, ShipDate, CA, HttpUtility.UrlDecode(PO, System.Text.Encoding.Default))
                    If PrintShippingLabelselectedres.Contains("Please release order") Or PrintShippingLabelselectedres.Contains("no consignee account") Or PrintShippingLabelselectedres.Contains("contains 0 dimensions") Then
                        Return PrintShippingLabelselectedres
                    End If
                    If PrintShippingLabelselectedres.EndsWith(".pdf") Then
                        filepath = PrintShippingLabelselectedres
                        ' FullFileName = SysPath & PrintShipptingLabelselectedres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PoFiles.Add(FullPath)
                        PrintedReports.Add("Label")
                    End If
                    SelectedCnt += 1
                End If

                If PrintPickListselected = 1 Then
                    PrintPickListselectedres = PrintPickList(OrderIDs)
                    If PrintPickListselectedres.EndsWith(".pdf") Then
                        filepath = PrintPickListselectedres
                        '  FullFileName = SysPath & PrintPickListselectedres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PoFiles.Add(FullPath)
                        PrintedReports.Add("PickList")
                    End If
                    SelectedCnt += 1
                End If

                If PrintBillofLading = 1 Then
                    PrintBillofLadingres = PrintLadingBill(OrderIDs)
                    If PrintBillofLadingres.EndsWith(".pdf") Then
                        filepath = PrintBillofLadingres
                        ' FullFileName = SysPath & PrintBillofLadingres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PoFiles.Add(FullPath)
                        PrintedReports.Add("Bill Of Lading")
                    End If
                    SelectedCnt += 1
                End If

                If PrintConsolidatedBillofLading = 1 Then
                    PrintBillofLadingres = PrintLadingBillConsolidated(OrderIDs)
                    If PrintBillofLadingres.EndsWith(".pdf") Then
                        filepath = PrintBillofLadingres
                        ' FullFileName = SysPath & PrintBillofLadingres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PoFiles.Add(FullPath)
                        PrintedReports.Add("Consolidated Bill Of Lading")
                    End If
                    SelectedCnt += 1
                End If

                If PrintCCI = 1 Then
                    PrintCCIselectedres = PrintCustomsInvoice(OrderIDs)
                    If PrintCCIselectedres.EndsWith(".pdf") Then
                        filepath = PrintCCIselectedres
                        ' FullFileName = SysPath & PrintShipptingLabelselectedres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PoFiles.Add(FullPath)
                        PrintedReports.Add("CCI")
                    End If
                    SelectedCnt += 1
                End If


                If PrintInvoice = 1 Then
                    '04 Apr 2019 :: Muthu Nivetha M :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark
                    'PrintInvoices = PrintInvoiceReport(OrderIDs, "", "", "", ShipDate, False)
                    ''PrintInvoices = PrintInvoiceReport(OrderIDs, "", "", "", "", "", ShipDate, True)
                    PrintInvoices = PrintInvoiceReport(OrderIDs, "", "", "", "", "", ShipDate, False)
                    If PrintInvoices.EndsWith(".pdf") Then
                        filepath = PrintInvoices
                        ' FullFileName = SysPath & PrintShipptingLabelselectedres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PoFiles.Add(FullPath)
                        PrintedReports.Add("Invoice")
                    End If
                    SelectedCnt += 1
                End If


                'Dim CallHS As String = ConfigurationManager.AppSettings.Item("CALLHS").ToString() 'Index Name of History File


                Dim UpdateResult = ""
                UpdateResult = SalesOrder.UpdateActivityLogForOrderReports(SelectedOrders.Split(",").ToArray(), User.Email, User.Name, PrintedReports.ToArray(), LocalIPAddress())

                If PoFiles.Count = 0 Then
                    Return "No Order Found"
                Else
                    Return String.Join("*~*", PoFiles.ToArray()).ToString()
                End If


            Else
                Return "No Order Found"
            End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintMultipleReportsInOrder::PageOrder")
            Return "error" + ex.Message
        End Try
    End Function
    ''' <summary>
    ''' 04 Apr 2019 :: Muthu Nivetha M :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark :: Modified
    ''' </summary>
    ''' <param name="Order"></param>
    ''' <param name="Type"></param>
    ''' <param name="EmailIDs"></param>
    ''' <param name="CustName"></param>
    ''' <param name="ShippingDate"></param>
    ''' <param name="isPrintForEmail"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintInvoiceReport(ByVal Order As String, ByVal Type As String, ByVal EmailIDs As String, ByVal Subject As String, ByVal Body As String, ByVal CustName As String,
                                       ByVal ShippingDate As String, ByVal isPrintForEmail As Boolean) As String '04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark 
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            '04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark 
            Dim HeaderInformation = CreateXMLForInvoiceReportHeaderSQL(Order, isPrintForEmail)
            Dim DetailsInformation = CreateXMLForInvoiceReportDetailSQL(Order)
            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertInvoiceReportData(HeaderInformation, DetailsInformation, User.ID)

                'checkusersessionIsActive:start
                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If
                'end


                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "UserID"
                reportParameterCollection(1).Values.Add(User.ID)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                If Order.Contains(",") Then
                    filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"

                Else
                    Try

                        If Type = "SalesSavePDF" Then
                            'If EmailIDs.Length > 10 Then
                            '    EmailIDs = EmailIDs.Substring(0, 10)
                            'Else
                            '    EmailIDs = EmailIDs
                            'End If
                            If Not Order.Contains(",") And Order.Length > 7 Then
                                Order = Order.Substring(0, 7)
                            Else
                                Order = Order
                            End If
                            filename = CustName + " Invoice No. " + Order + " shipped on " + Convert.ToDateTime(ShippingDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM-dd-yy") + ".pdf"
                        Else
                            filename = CompanyName + " Invoice No. " + Order + " shipped on " + Convert.ToDateTime(ShippingDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM-dd-yy") + ".pdf"
                        End If
                    Catch ex As Exception
                        filename = "Invoice_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                    End Try
                End If

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString() + "\Invoices"
                Dim InvoiceReportName As String
                InvoiceReportName = "rptInvoice"
                If ConfigurationManager.AppSettings.AllKeys.Contains("InvoiceReportName") Then
                    InvoiceReportName = ConfigurationManager.AppSettings("InvoiceReportName").ToString()
                End If
                Dim BodyMessage As String = ""
                If String.IsNullOrEmpty(InvoiceReportName) Then
                    InvoiceReportName = "rptInvoice"
                End If
                'Dim ReportName As String = ""
                Dim ReportName As String = objPdf.ExportToPdf(filename, InvoiceReportName, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource", "Invoices")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " For Invoice No:" + Order + " by user:" + User.Email), "labelnotification")
                'Dim Subject As String = ""
                If Subject.Contains("Subject will be generated from code") Then
                    If Order.Contains(",") Then
                        Subject = CompanyName + " Invoice No." + Order + " by user:" + User.Email '
                    Else
                        Subject = CompanyName + " Invoice No." + Order + " For shipping date " + Convert.ToDateTime(ShippingDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM-dd-yy")
                    End If   '//  uncommented by Belal on 13 Sept 2020 :: Subject will be generated from code based on condition
                End If
                Dim EmailList As New List(Of Emails)
                If Type = "Email" Then
                    If Not ReportName.Trim().Contains("error : ") Then
                        Dim email As New Emails
                        email.EmailIDs = EmailIDs
                        email.CustName = CustName
                        email.UserEmail = User.Email
                        email.Subject = Subject
                        email.FileName = ReportName
                        email.DocumentType = "INVOICE"
                        email.DocumentNum = Order
                        EmailList.Add(email)
                        'SendEmailForInvoice(EmailList, Body)
                    End If
                ElseIf Type <> "DayWiseClosing" Then
                    If Not ReportName.Trim().Contains("error : ") Then
                        'Logs.VendorEmailLogs(User, Body, (ReportExportFolder + "\" + filename), Subject, "labelnotification")
                    End If
                End If
                Return ReportExportFolder + "\" + filename 'ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" And DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    'Added by Belal on 10th July 2021
    <System.Web.Services.WebMethod(True)>
    Public Function PrintInvoiceReportWhileSaving(ByVal Order As String, ByVal Type As String, ByVal EmailIDs As String, ByVal Subject As String, ByVal Body As String, ByVal CustName As String,
                                       ByVal ShippingDate As String, ByVal isPrintForEmail As Boolean) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim reportName As String = PrintInvoiceReport(Order, Type, EmailIDs, Subject, Body, CustName, ShippingDate, isPrintForEmail)

            Dim OrderArray As List(Of String) = New List(Of String)
            OrderArray.Add(Order)
            Dim PrintedOrder As List(Of String) = New List(Of String)
            PrintedOrder.Add("Invoice while saving")
            'SalesOrder.UpdateActivityLogForOrderReports(OrderArray, User.Email, User.UserName, PrintedOrder, LocalIPAddress())
            Return reportName
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceReportWhileSaving")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Async Function PrintInvoiceReportAsync(ByVal Order As String, ByVal Type As String, ByVal EmailIDs As String, ByVal Subject As String, ByVal Body As String, ByVal CustName As String,
                                       ByVal ShippingDate As String, ByVal isPrintForEmail As Boolean) As Task(Of String) '04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark 
        Try
            Dim returnMessage As String = ""
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            '04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark 
            Dim HeaderInformation = CreateXMLForInvoiceReportHeaderSQL(Order, isPrintForEmail)
            Dim DetailsInformation = CreateXMLForInvoiceReportDetailSQL(Order)
            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertInvoiceReportData(HeaderInformation, DetailsInformation, User.ID)

                'checkusersessionIsActive:start
                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If
                'end


                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "UserID"
                reportParameterCollection(1).Values.Add(User.ID)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                If Order.Contains(",") Then
                    filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"

                Else
                    Try

                        If Type = "SalesSavePDF" Then
                            'If EmailIDs.Length > 10 Then
                            '    EmailIDs = EmailIDs.Substring(0, 10)
                            'Else
                            '    EmailIDs = EmailIDs
                            'End If
                            If Not Order.Contains(",") And Order.Length > 7 Then
                                Order = Order.Substring(0, 7)
                            Else
                                Order = Order
                            End If
                            filename = CustName + " Invoice No. " + Order + " shipped on " + Convert.ToDateTime(ShippingDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM-dd-yy") + ".pdf"
                        Else
                            filename = CompanyName + " Invoice No. " + Order + " shipped on " + Convert.ToDateTime(ShippingDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM-dd-yy") + ".pdf"
                        End If
                    Catch ex As Exception
                        filename = "Invoice_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                    End Try
                End If

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
                Dim InvoiceReportName As String = ""
                If ConfigurationManager.AppSettings.AllKeys.Contains("InvoiceReportName") Then
                    InvoiceReportName = ConfigurationManager.AppSettings("InvoiceReportName").ToString()
                End If
                Dim BodyMessage As String = ""
                If String.IsNullOrEmpty(InvoiceReportName) Then
                    InvoiceReportName = "rptInvoice"
                End If
                'Dim ReportName As String = ""
                Dim ReportName As String = objPdf.ExportToPdf(filename, InvoiceReportName, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " For Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                'Dim Subject As String = ""
                If Subject.Contains("Subject will be generated from code") Then
                    If Order.Contains(",") Then
                        Subject = CompanyName + " Invoice No." + Order + " by user:" + User.Email '
                    Else
                        Subject = CompanyName + " Invoice No." + Order + " For shipping date " + Convert.ToDateTime(ShippingDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM-dd-yy")
                    End If   '//  uncommented by Belal on 13 Sept 2020 :: Subject will be generated from code based on condition
                End If
                Dim EmailList As New List(Of Emails)
                If Type = "Email" Then
                    If Not ReportName.Trim().Contains("error : ") Then
                        Dim email As New Emails
                        email.EmailIDs = EmailIDs
                        email.CustName = CustName
                        email.UserEmail = User.Email
                        email.Subject = Subject
                        email.FileName = ReportName
                        email.DocumentType = "INVOICE"
                        email.DocumentNum = Order

                        EmailList.Add(email)
                        Try
                            returnMessage = Await SendEmailForInvoice(EmailList, Body)
                            Logs.Savelog(User.ID, "Sales Email Invoices", "", returnMessage, User.UserName)
                        Catch ex As Exception
                            Logs.Savelog(User.ID, "Sales Email Invoices", "", ex.Message, User.UserName)
                            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceReportAsync")
                        End Try
                    End If
                ElseIf Type <> "DayWiseClosing" Then
                    If Not ReportName.Trim().Contains("error : ") Then
                        'Logs.VendorEmailLogs(User, Body, (ReportExportFolder + "\" + filename), Subject, "labelnotification")
                    End If
                End If
                Return returnMessage
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" And DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceReportAsync")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    '''' <summary>
    '''' Anitha :: 01-DEC-2018 :: Add new method for send email for invoice to the client
    '''' </summary>
    '''' <param name="EmailList"></param>
    '<System.Web.Services.WebMethod(True)>
    Public Async Function SendEmailForInvoice(ByVal EmailList As List(Of Emails), ByVal Body As String) As Task(Of String)
        Dim User As New User

        If Not Session("LoginUserDetails") Is Nothing Then
            User = Session("LoginUserDetails")
        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            User = Session("LoginAdminDetails")
        End If
        Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

        For Each email In EmailList
            If email.EmailIDs = "" Then
                Dim CustomerNo = email.CustName 'we are passing customer no in customer only for email option
                email.EmailIDs = GetCustomerDocumentsAddress(CustomerNo, "I", "'E'")
                Dim SalesManEmail = SalesPerson.GetSalesPersonEmailIdforCustomer(CustomerNo)
                If Not String.IsNullOrEmpty(email.EmailIDs) Then
                    email.EmailIDs = email.EmailIDs.Trim() + If(SalesManEmail.Trim() <> "", "," + SalesManEmail.Trim(), "")
                End If
            End If

            If Not String.IsNullOrEmpty(email.EmailIDs) And Not email.EmailIDs.Contains(User.Email) Then
                email.EmailIDs += "," + User.Email
            End If

            Return Await Logs.SendMail(User.Email, email.EmailIDs, Body, email.FileName, email.Subject, email.DocumentType, email.DocumentNum, email.CustName)
        Next
        Return Nothing
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function UploadInvoicePOD(ByVal fileBase64Str As String, ByVal fileName As String) As String
        Try
            Dim User As New User
            Dim MessageStr As String = ""

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim invoice As Integer = fileName.Split(".")(0)
            Dim folderPath As String = HttpContext.Current.Server.MapPath("~/CreditRequestImages/PODS") ' get folder path
            If Not System.IO.Directory.Exists(folderPath) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath) ' create folder if not exist 
            End If

            fileBase64Str = fileBase64Str.Split(",")(1)
            Dim filePath As String = folderPath + "\" + fileName
            File.WriteAllBytes(filePath, Convert.FromBase64String(fileBase64Str)) ' save file

            If System.IO.File.Exists(filePath) Then 'check if file saved successfully and it exists 
                MessageStr = SalesOrder.SavePODFileInformationForInvoice(invoice, "/CreditRequestImages/PODS/" + fileName, User.UserName)
            Else
                MessageStr = "Error, file can't be saved!!"
            End If


            Return MessageStr
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UploadInvoicePOD")
            Return "Error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function ConfirmInvoiceByPaymentTerms(ByVal InvoiceList As String) As String
        Try
            Dim User As New User
            Dim MessageStr As String = ""

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If InvoiceList <> "" Then
                MessageStr = SalesOrder.ConfirmInvoiceByPaymentTerms(InvoiceList, User.Name)
            Else
                MessageStr = "error"
            End If
            Return MessageStr
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ConfirmInvoiceByPaymentTerms")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    ''' <summary>
    ''' 04 Apr 2019 :: Muthu Nivetha M :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark :: Modified
    ''' </summary>
    ''' <param name="Order"></param>
    ''' <param name="isPrintForEmail"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForInvoiceReportHeaderSQL(ByVal Order As String, ByVal isPrintForEmail As Boolean) As String ''04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark 
        Try
            Dim ResultHeader As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())

                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    data = SalesOrder.GetInvoiceReportHeader(strTest)
                    TotalRowCount = data.count


                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then

                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim HeaderInfo = New XElement("InvoiceHeader",
                                        From Header In dt.Rows()
                                        Select New XElement("Header", "",
                                        New XElement("OrderNo", Header.item("Order").ToString()),
                                        New XElement("Account", Header.item("Customer")),
                                        New XElement("BillTo", Header.item("CustomerName")),
                                        New XElement("Address1", Header.item("Address1")),
                                        New XElement("Address2", Header.item("Address2")),
                                        New XElement("Phone", Header.item("Phone")),
                                        New XElement("Fax", Header.item("Fax")),
                                        New XElement("City", Header.item("City")),
                                        New XElement("State", Header.item("State")),
                                        New XElement("Country", Header.item("Country")),
                                        New XElement("zip", Header.item("Zip")),
                                        New XElement("Contact", Header.item("Contact")),
                                        New XElement("Shipto", Header.item("Shipto")),
                                        New XElement("SalesManName", Header.item("SalesManName")),
                                        New XElement("Terms", Header.item("Terms")),
                                        New XElement("AWB", Header.item("AWB")),
                                        New XElement("Carrier", Header.item("Carrier")),
                                        New XElement("Shipdate", Header.item("ShippingDate")),
                                        New XElement("PO", Header.item("PO")),
                                        New XElement("WH", Header.item("WH")),
                                        New XElement("ShiptoAddress", Header.item("ShiptoAddress")),
                                        New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                        New XElement("ShiptoState", Header.item("ShiptoState")),
                                        New XElement("ShiptoZip", Header.item("ShiptoZip")),
                                        New XElement("Void", Header.item("VOID")),
                                        New XElement("Printed", Header.item("Printed")),
                                        New XElement("InvoiceComments", Header.item("PickRemark"))))
                            ResultHeader += HeaderInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing

                Dim TotalRowCount As Integer = 0
                '04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark 
                data = SalesOrder.GetInvoiceReportHeader(Order, isPrintForEmail)
                TotalRowCount = data.count

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim HeaderInfo = New XElement("InvoiceHeader",
                            From Header In dt.Rows()
                            Select New XElement("Header", "",
                                        New XElement("OrderNo", Header.item("Order").ToString()),
                                        New XElement("Account", Header.item("Customer")),
                                        New XElement("BillTo", Header.item("CustomerName")),
                                        New XElement("Address1", Header.item("Address1")),
                                        New XElement("Address2", Header.item("Address2")),
                                        New XElement("Phone", Header.item("Phone")),
                                        New XElement("Fax", Header.item("Fax")),
                                        New XElement("City", Header.item("City")),
                                        New XElement("State", Header.item("State")),
                                        New XElement("Country", Header.item("Country")),
                                        New XElement("zip", Header.item("Zip")),
                                        New XElement("Contact", Header.item("Contact")),
                                        New XElement("Shipto", Header.item("Shipto")),
                                        New XElement("SalesManName", Header.item("SalesManName")),
                                        New XElement("Terms", Header.item("Terms")),
                                        New XElement("AWB", Header.item("AWB")),
                                        New XElement("Carrier", Header.item("Carrier")),
                                        New XElement("Shipdate", Header.item("ShippingDate")),
                                        New XElement("PO", Header.item("PO")),
                                        New XElement("WH", Header.item("WH")),
                                        New XElement("ShiptoAddress", Header.item("ShiptoAddress")),
                                        New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                        New XElement("ShiptoState", Header.item("ShiptoState")),
                                        New XElement("ShiptoZip", Header.item("ShiptoZip")),
                                        New XElement("Void", Header.item("VOID")),
                                        New XElement("Printed", Header.item("Printed")),
                                        New XElement("InvoiceComments", Header.item("PickRemark"))))
                        Return HeaderInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultHeader

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForInvoiceReportHeaderSQL::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForInvoiceReportDetailSQL(ByVal Order As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim ResultDetails As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())

                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    data = SalesOrder.GetInvoiceReportDetail(strTest)
                    TotalRowCount = data.count

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim DetailInfo = New XElement("InvoiceDetail",
                            From Detail In dt.Rows()
                            Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("Flower", Detail.item("FlowerDetails").Flower),
                            New XElement("Category", Detail.FlowerDetails.CAT),
                            New XElement("Name", Detail.FlowerDetails.Name),
                            New XElement("FarmCode", Detail.FarmDetails.FarmCode),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("Boxes", Detail.item("Boxes1")),
                            New XElement("UnitsPerBox", Detail.item("Units")),
                            New XElement("Units", Detail.item("TotalUnits1")),
                            New XElement("FOB", Detail.item("FOB")),
                            New XElement("Amount", Detail.item("Amount")),
                            New XElement("Cubes", Detail.item("Cubes")),
                            New XElement("Type", Detail.item("Type")),
                            New XElement("TAX1", Detail.item("Tax1")),
                            New XElement("TAX2", Detail.item("Tax2")),
                            New XElement("UPC", Detail.item("UPC")),
                            New XElement("DATECODE", Detail.item("DATECODE")),
                            New XElement("BOXCODE", Detail.item("BOXCODE")),
                            New XElement("NOTES", Detail.item("NOTES")),
                            New XElement("UserID", User.ID)))
                            ResultDetails += DetailInfo.ToString()
                        Else
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                data = SalesOrder.GetInvoiceReportDetail(Order)
                TotalRowCount = data.count

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim DetailInfo = New XElement("InvoiceDetail",
                        From Detail In dt.Rows()
                        Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("Flower", Detail.item("FlowerDetails").Flower),
                            New XElement("Category", Detail.item("FlowerDetails").CAT),
                            New XElement("Name", Detail.item("FlowerDetails").Name),
                            New XElement("FarmCode", Detail.item("FarmDetails").FarmCode),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("Boxes", Detail.item("Boxes1")),
                            New XElement("UnitsPerBox", Detail.item("Units")),
                            New XElement("Units", Detail.item("TotalUnits1")),
                            New XElement("FOB", Detail.item("FOB")),
                            New XElement("Amount", Detail.item("Amount")),
                            New XElement("Cubes", Detail.item("Cubes")),
                            New XElement("Type", Detail.item("Type")),
                            New XElement("TAX1", Detail.item("Tax1")),
                            New XElement("TAX2", Detail.item("Tax2")),
                            New XElement("UPC", Detail.item("UPC")),
                            New XElement("DATECODE", Detail.item("DATECODE")),
                            New XElement("BOXCODE", Detail.item("BOXCODE")),
                            New XElement("NOTES", Detail.item("NOTES")),
                            New XElement("UserID", User.ID)))
                        ResultDetails += DetailInfo.ToString()
                    Else
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForInvoiceReportDetailSQL::PageOrder")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function AddUpcLabelDetails(ByVal Description As String, ByVal UPCDate As String, ByVal Price As String, ByVal Farm As String, UPCode As String, ByVal Quantity As String) As String
        Return UPCCodelabel.AddUpcLabelDetails(Description, UPCDate, Price, Farm, UPCode, Quantity)
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportUPCLabels(ByVal Description As String, ByVal UPCDate As String, ByVal Price As String, ByVal Farm As String, UPCode As String, ByVal Quantity As String, ByVal PrintCompanyName As String) As String


        'checkusersessionIsActive:start
        Dim SessionStatus As String = ""
        If Not Session("LoginUserDetails") Is Nothing Then
            SessionStatus = CheckLoginSessionIsActive("User")
        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            SessionStatus = CheckLoginSessionIsActive("Admin")
        End If
        If SessionStatus = "InActive" Then
            Return "LogOut"
        End If
        'end
        Dim ReturnMessage As String = ""
        Dim BodyMessage As String = ""
        Try

            Dim User As New User
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ""
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim filename As String = ""
            filename = "UPCDetails_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"

            Dim AWBs As String = ""
            Dim Farms As String = ""

            Dim TotalLabelCount As Integer = 0
            Dim objPdf As New ExportSSRS
            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim SysPath As String = foldername
            CombinedFilePath = foldername + "/" + filename
            Dim LabelName = ""
            LabelName = "rptUPCBarcode"
            Dim WhereCondition As String = ""
            Dim FullFileName As String = SysPath & filename
            Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}

            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "PrintCompanyName"
            reportParameterCollection(1).Values.Add(PrintCompanyName)

            AppendLog("The File name is  :" + FullFileName, "")
            Dim s As String = objPdf.ExportToPdf(filename, LabelName, reportParameterCollection, ExportSSRS.PdfOrientation.UPCLabel, ExportSSRS.FileType.PDF, RptDataSourceName)
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Label Printing Notification for UPC Code : " + UPCode + " Labels Printed: " + Quantity + " by user:" + User.Email), "labelnotification")
            If Not s.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " UPC Code : " + UPCode + " Labels Printed: " + Quantity + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " UPC Code : " + UPCode + " Labels Printed: " + Quantity + " by user:" + User.Email), "labelnotification")
            End If
            ReturnMessage = ReportExportFolder + "\" + filename


        Catch ex As Exception
            AppendLog("Error in Export UPC Label", "")
            AppendLog("Exception Message is :" + ex.Message, "")
            AppendLog("Inner Exception is :" + ex.ToString(), "")

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            BodyMessage = ex.Message.ToString() + "</br>" + " on " + Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + "</b>"

            ''''''''''Logs.VendorEmailLogs(User, BodyMessage, "", "Error Notification", "error")
            ErrorLogs.LogException(ex, "Error in Service::ExportLabels")
            ReturnMessage = "error"
        End Try
        If ReturnMessage = "error" Then
            Logs.VendorEmailLogs(User, BodyMessage, "", "Error Notification", "error")
        End If
        Return ReturnMessage
    End Function

    Public Shared Function getFontForCode(ByVal UPCode As String) As String
        Try
            'UPCode = "644209420957"
            Dim FirstNumber() As Integer = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}

            Dim MIDNumber() As Char = {"P", "Q", "W", "E", "R", "T", "Y", "U", "I", "O"}
            Dim Dash = "-"
            Dim SecondPartNumber() As Char = {";", "A", "S", "D", "F", "G", "H", "J", "K", "L"}
            Dim lastPart() As Char = {"/", "Z", "X", "C", "V", "B", "N", "M", ",", "."}
            Dim getFirstFive As Char() = UPCode.Take(6).ToArray
            Dim ReplaceCode As String = ""
            Dim i As Integer
            For i = 0 To UPCode.Length - 1
                If (i = 0) Then
                    ReplaceCode = UPCode.Chars(i)
                ElseIf (i > 0 And i < 6) Then
                    ReplaceCode += MIDNumber(Val(UPCode(i)))
                ElseIf (i = 6) Then
                    ReplaceCode += "-"
                    ReplaceCode += SecondPartNumber(Val(UPCode(i)))
                ElseIf (i > 6 And i < 11) Then
                    ReplaceCode += SecondPartNumber(Val(UPCode(i)))
                ElseIf (i = 11) Then
                    ReplaceCode += lastPart(Val(UPCode(i)))
                End If
            Next
            Return ReplaceCode
        Catch ex As Exception
            Return "error"
        End Try
    End Function

    Private Function BuildXmlDoc(ByVal StrMsg As String) As XmlDocument
        Dim newDoc As New XmlDocument()
        newDoc.LoadXml(Convert.ToString("<cell>" + ConfigurationManager.AppSettings("XmlPath") + "\ReportExports\" + StrMsg + "</cell>"))
        Return newDoc
    End Function



    ''' <summary>
    ''' '16 Mar 19 :: Print Label on look up by boxnumber results screen
    ''' Muthu Nivetha M :: 16 Mar 19 :: Print Label on look up by boxnumber results screen
    ''' Muthu Nivetha M :: 10Mar2020 :: Modified :: To generate special reg labels only for Cust  type='T' with recipe details
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForShippingLabelSQL(ByVal Order As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim IsForLookup As Boolean = False
            Dim salesdetail As New List(Of BO.SalesDetail)
            If Session("SessionIsForLookup") IsNot Nothing Then
                IsForLookup = True
                salesdetail = Session("SessionIsForLookup")
            End If

            Dim ResultHeader As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())

                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0

                    '16 Mar 19 :: Print Label on look up by boxnumber results screen
                    If IsForLookup Then
                        data = SalesOrder.GetShippingLabelDetailsSQL(strTest, User.Name, True, salesdetail(0).FarmCode, salesdetail(0).BoxNum)
                    Else
                        data = SalesOrder.GetShippingLabelDetailsSQL(strTest, User.Name)
                    End If

                    TotalRowCount = data.Count


                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                            Dim HeaderInfo = New XElement("ShippingLabelDetails",
                                From Header In dt.Rows()
                                Select New XElement("Shipping", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("ShippingDate", Header.item("ShippingDate")),
                                New XElement("PONumber", Header.item("PO")),
                                New XElement("ShiptoName", Header.item("Shipto")),
                                New XElement("ShiptoAddress1", Header.item("ShiptoAddress1")),
                                New XElement("ShiptoAddress2", Header.item("ShiptoAddress2")),
                                New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                New XElement("ShiptoState", Header.item("ShiptoState")),
                                New XElement("ShiptoZip", Header.item("ShiptoZip")),
                                New XElement("BoxNumber", Header.item("BoxNum")),
                                New XElement("BoxCode", Header.item("BoxCode")),
                                New XElement("Units", Header.item("Units")),
                                New XElement("Boxes", Header.item("Boxes")),
                                New XElement("UOM", Header.item("UOM")),
                                New XElement("Product", Header.item("FlowerDetails").Name),
                                New XElement("Farm", Header.item("FarmDetails").FarmCode),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("CarrierName", Header.item("CarrierName")),
                                New XElement("CustomerType", Header.item("Type")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("BoxSeqeunce", Header.item("BoxSequence")),
                                New XElement("LabelCode", Header.item("LabelCode")),
                                New XElement("ARBoxNo", Header.item("ARBoxNo")),
                                New XElement("ShippingLabelType", Header.item("ShippingLabelType")),
                                New XElement("ConstantArmellini", Header.item("ConstantArmellini")),
                                New XElement("Consignee", Header.item("Consignee")),
                                New XElement("Rack", Header.item("Rack")),
                                New XElement("L", Header.item("BoxLength")),
                                New XElement("H", Header.item("BoxHeight")),
                                New XElement("W", Header.item("BoxWidth")),
                                New XElement("SLSMANEmail", Header.item("SLSMANEmail")),
                                New XElement("PREPAID", Header.item("Prepaid").ToString()),
                                New XElement("BoxSize", Header.item("Armellini")),
                                New XElement("PickRemark", Header.item("PickRemark")),
                                New XElement("PrintHeaderReport", Header.item("PrintHeaderReport")),
                                New XElement("UserID", User.ID),
                                New XElement("UPC", UPCCodelabel.getFontForCode(Header.item("UPC"))),
                                New XElement("DATECODE", Header.item("DateCode"))))
                            ResultHeader += HeaderInfo.ToString()
                        Else
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                '16 Mar 19 :: Print Label on look up by boxnumber results screen
                If IsForLookup Then
                    data = SalesOrder.GetShippingLabelDetailsSQL(Order, User.Name, True, salesdetail(0).FarmCode, salesdetail(0).BoxNum)
                Else
                    data = SalesOrder.GetShippingLabelDetailsSQL(Order, User.Name)
                End If

                TotalRowCount = data.Count
                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Or data(0).ErrorMessage = Nothing Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim HeaderInfo = New XElement("ShippingLabelDetails",
                                From Header In dt.Rows()
                                Select New XElement("Shipping", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("ShippingDate", Header.item("ShippingDate")),
                                New XElement("PONumber", Header.item("PO")),
                                New XElement("ShiptoName", Header.item("Shipto")),
                                New XElement("ShiptoAddress1", Header.item("ShiptoAddress1")),
                                New XElement("ShiptoAddress2", Header.item("ShiptoAddress2")),
                                New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                New XElement("ShiptoState", Header.item("ShiptoState")),
                                New XElement("ShiptoZip", Header.item("ShiptoZip")),
                                New XElement("BoxNumber", Header.item("BoxNum")),
                                New XElement("BoxCode", Header.item("BoxCode")),
                                New XElement("Units", Header.item("Units")),
                                New XElement("Boxes", Header.item("Boxes")),
                                New XElement("UOM", Header.item("UOM")),
                                New XElement("Product", Header.item("FlowerDetails").Name),
                                New XElement("Farm", Header.item("FarmDetails").FarmCode),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("CarrierName", Header.item("CarrierName")),
                                New XElement("CustomerType", Header.item("Type")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("BoxSeqeunce", Header.item("BoxSequence")),
                                New XElement("LabelCode", Header.item("LabelCode")),
                                New XElement("ARBoxNo", Header.item("ARBoxNo")),
                                New XElement("ShippingLabelType", Header.item("ShippingLabelType")),
                                New XElement("ConstantArmellini", Header.item("ConstantArmellini")),
                                New XElement("Consignee", Header.item("Consignee")),
                                New XElement("Rack", Header.item("Rack")),
                                New XElement("L", Header.item("BoxLength")),
                                New XElement("H", Header.item("BoxHeight")),
                                New XElement("W", Header.item("BoxWidth")),
                                New XElement("SLSMANEmail", Header.item("SLSMANEmail")),
                                New XElement("PREPAID", Header.item("Prepaid").ToString()),
                                New XElement("BoxSize", Header.item("Armellini")),
                                New XElement("PickRemark", Header.item("PickRemark")),
                                New XElement("PrintHeaderReport", Header.item("PrintHeaderReport")),
                                New XElement("UserID", User.ID),
                                New XElement("UPC", UPCCodelabel.getFontForCode(Header.item("UPC"))),
                                New XElement("DATECODE", Header.item("DateCode"))))
                        Return HeaderInfo.ToString()
                    Else
                        If data(0).ErrorMessage.Contains("Please release order") Or data(0).ErrorMessage.Contains("no armellini account ") Or data(0).ErrorMessage.Contains("contains 0 dimensions") Then
                            Return data(0).ErrorMessage
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")

                        'Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                        'Dim toEmails As String = F_Emails.GetEmailsByType("SHIPPINGERRORS")
                        'Dim emailSubject As String = CompanyName & " Error " & data(0).ErrorMessage ''"Shipping Labels Error Notification"
                        'Dim emailBody As String = data(0).ErrorMessage
                        'Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
                        'If Not String.IsNullOrEmpty(toEmails) Then
                        '    Logs.SendMail(FromEmail, toEmails, emailBody, "", emailSubject)
                        'End If

                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultHeader

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForShippingLabelSQL::PageOrder")
            Return "error"
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function CreateARFBXML(ByVal Order As String, ByVal ShipDate As String, ByVal CA As String) As String
    '    Try
    '        Dim User As New User
    '        If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
    '            User = System.Web.HttpContext.Current.Session("LoginUserDetails")
    '        ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
    '            User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
    '        End If
    '        Dim stringSeparators() As String = {","}
    '        Dim OrderList() As String
    '        OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
    '        Dim arrlst As New ArrayList()
    '        arrlst.AddRange(OrderList)
    '        Dim i As Integer = 0

    '        Dim FloridaBeautyShipper As String = ConfigurationManager.AppSettings("FloridaBeautyShipper").ToString()

    '        Dim isForNewArmellini As String = True

    '        For i = 0 To arrlst.Count - 1
    '            Dim ShippingInformation = CreateXMLForShippingLabelSQL(arrlst(i))
    '            Dim LabelToPrint As String = SalesOrder.InsertShippingLabelDetails(ShippingInformation, User.ID, FloridaBeautyShipper, isForNewArmellini)
    '            Dim edierror As Boolean = False
    '            Try
    '                If LabelToPrint.Contains("ARREG") Or LabelToPrint.Contains("ARSM") Then
    '                    Dim fut As New Feature
    '                    fut = Features.GetFeatureByName("Auto Send ArXML")
    '                    If fut.Value = True Then
    '                        Dim ARServiceUserName As String = ""
    '                        Dim ARServicePassword As String = ""
    '                        If fut.Options.Contains("*~~~~*") And fut.Options <> Nothing Then
    '                            ARServiceUserName = fut.Options.Split("*~~~~*")(0).ToString()
    '                            ARServicePassword = fut.Options.Split("*~~~~*")(2).ToString()
    '                        End If
    '                        SendARXML(ARServiceUserName, ARServicePassword, "1")
    '                    End If
    '                End If
    '                If LabelToPrint.Contains("FBREG") Or LabelToPrint.Contains("FBSM") Then
    '                    SendFloridaBeautyEDI("1") ''Sends the Order Details to florida beauty carrier and get the response
    '                End If
    '            Catch ex As Exception
    '                edierror = True
    '            End Try
    '        Next
    '        Return "valid"
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::CreateARFBXML")
    '        Return "error : " + ex.Message + ":::" + ex.ToString()
    '    End Try
    'End Function
    ''' <summary>
    ''' Muthu Nivetha M :: 10Mar2020 :: Modified :: To generate special reg labels only for Cust  type='T' with recipe details
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintShippingLabelListOld(ByVal Order As String, ByVal ShipDate As String, ByVal CA As String, ByVal PO As String) As String
        Try
            Dim ShippingInformation = CreateXMLForShippingLabelSQL(Order)
            If (ShippingInformation <> "error" And ShippingInformation <> "No Data" And ShippingInformation.Contains("Please release order") <> True And ShippingInformation.Contains("no armellini account") <> True And ShippingInformation.Contains("contains 0 dimensions") <> True) Then
                'checkusersessionIsActive:start
                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If
                'end

                Dim User As New User
                If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                End If

                Dim FloridaBeautyShipper As String = ConfigurationManager.AppSettings("FloridaBeautyShipper").ToString()
                Dim isForNewArmellini As String = IIf(ConfigurationManager.AppSettings("SetNewArmellini").ToString() = "1", True, False)
                Dim LabelToPrint As String = SalesOrder.InsertShippingLabelDetails(ShippingInformation, User.ID, FloridaBeautyShipper, isForNewArmellini)
                'Dim LabelToPrint As String = SalesOrder.InsertShippingLabelDetails(ShippingInformation, User.ID, FloridaBeautyShipper)

                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                'If LabelToPrint.Contains("ARREG") Or LabelToPrint.Contains("ARSM") Then
                '    Dim fut As New Feature
                '    fut = Features.GetFeatureByName("Auto Send ArXML")
                '    If fut.Value = True Then
                '        Dim ARServiceUserName As String = ""
                '        Dim ARServicePassword As String = ""
                '        If fut.Options.Contains("*~~~~*") And fut.Options <> Nothing Then
                '            ARServiceUserName = fut.Options.Split("*~~~~*")(0).ToString()
                '            ARServicePassword = fut.Options.Split("*~~~~*")(2).ToString()
                '        End If
                '        SendARXML(ARServiceUserName, ARServicePassword)
                '    End If
                'End If

                'If LabelToPrint.Contains("FBREG") Then
                '    SendFloridaBeautyEDI() ''Sends the Order Details to flordia carrier and get the response
                'End If

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString() + "\Labels"
                Dim BodyMessage As String = ""
                Dim ShippingFiles As New List(Of String)
                Dim ReportName As String = ""
                Dim filename As String = ""
                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()

                If LabelToPrint = "Nodata" Then
                    Return "No Data"
                Else
                    'LabelName contains which label to be printed[SHIPSM,SHIPREG,SHIPARSM]
                    For Each labelName In LabelToPrint.Split(",")
                        If Order.Contains(",") Then
                            filename = CompanyName + "" + labelName + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        Else
                            filename = CompanyName + "" + labelName + "_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        End If
                        Dim reportParameterCollection As ReportParameter()
                        If labelName.Contains("WREG") Then
                            reportParameterCollection = New ReportParameter(2) {}

                            reportParameterCollection(0) = New ReportParameter()
                            reportParameterCollection(0).Name = "ConnectionString"
                            reportParameterCollection(0).Values.Add(ConString)

                            reportParameterCollection(1) = New ReportParameter()
                            reportParameterCollection(1).Name = "UserID"
                            reportParameterCollection(1).Values.Add(User.ID)

                            Dim WallMartSellByCaption As String = ConfigurationManager.AppSettings("WallMartSellByCaption").ToString()
                            reportParameterCollection(2) = New ReportParameter()
                            reportParameterCollection(2).Name = "WallMartSellByCaption"
                            reportParameterCollection(2).Values.Add(WallMartSellByCaption)
                        ElseIf labelName.Contains("FBREG") Or labelName.Contains("FBSM") Then
                            reportParameterCollection = New ReportParameter(2) {}

                            reportParameterCollection(0) = New ReportParameter()
                            reportParameterCollection(0).Name = "ConnectionString"
                            reportParameterCollection(0).Values.Add(ConString)

                            reportParameterCollection(1) = New ReportParameter()
                            reportParameterCollection(1).Name = "UserID"
                            reportParameterCollection(1).Values.Add(User.ID)

                            reportParameterCollection(2) = New ReportParameter()
                            reportParameterCollection(2).Name = "ShipperNo"
                            reportParameterCollection(2).Values.Add(FloridaBeautyShipper)
                        Else
                            reportParameterCollection = New ReportParameter(1) {}

                            reportParameterCollection(0) = New ReportParameter()
                            reportParameterCollection(0).Name = "ConnectionString"
                            reportParameterCollection(0).Values.Add(ConString)

                            reportParameterCollection(1) = New ReportParameter()
                            reportParameterCollection(1).Name = "UserID"
                            reportParameterCollection(1).Values.Add(User.ID)
                        End If

                        'ReportName = objPdf.ExportToPdf(filename, "rpt" + labelName + "", reportParameterCollection, ExportSSRS.PdfOrientation.ShippingLabel, ExportSSRS.FileType.PDF, "BloomsReportSource", "Labels")
                        'ShippingFiles.Add(ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ReportExportFolder + "\" + filename)
                    Next
                End If
                Dim edierror As Boolean = False
                Try
                    If LabelToPrint.Contains("ARREG") Or LabelToPrint.Contains("ARSM") Then
                        Dim fut As New Feature
                        fut = Features.GetFeatureByName("Auto Send ArXML")
                        If fut.Value = True Then
                            Dim ARServiceUserName As String = ""
                            Dim ARServicePassword As String = ""
                            If fut.Options.Contains("*~~~~*") And fut.Options <> Nothing Then
                                ARServiceUserName = fut.Options.Split("*~~~~*")(0).ToString()
                                ARServicePassword = fut.Options.Split("*~~~~*")(2).ToString()
                            End If
                            SendARXML(ARServiceUserName, ARServicePassword, "")
                        End If
                    End If

                    If LabelToPrint.Contains("FBREG") Or LabelToPrint.Contains("FBSM") Then
                        SendFloridaBeautyEDI("") ''Sends the Order Details to flordia carrier and get the response
                    End If
                Catch ex As Exception
                    edierror = True
                End Try
                If ShippingFiles.Count > 0 Then
                    Dim fileNames As String() = {}
                    fileNames = ShippingFiles.ToArray()
                    Dim CombinedFilePath As String = ""
                    Dim CombineFileName As String = ""
                    If Order.Contains(",") Then
                        CombineFileName = CompanyName + "" + "ShippingLabel_" + DateTime.Now.ToString("yyyyMMdd HHmmss") + ".pdf"
                    Else
                        CombineFileName = CompanyName + "" + "ShippingLabel_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd HHmmss") + ".pdf"
                    End If
                    'CombineFileName = "ShippingLabel_" + DateTime.Now.ToString("yyyyMMdd HHmmss") + ".pdf"

                    CombinedFilePath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ReportExportFolder + "\" + CombineFileName

                    If ShippingFiles.Count > 1 Then
                        Dim Result As String = POReportExport.CombineMultiplePDFs(fileNames, CombinedFilePath)
                    Else
                        CombineFileName = filename
                        CombinedFilePath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ReportExportFolder + "\" + CombineFileName
                    End If

                    If Not ReportName.Trim().Contains("error : ") Then
                        'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + CombineFileName), (CompanyName + " Shipping Label For Invoice#:  " + Order + IIf(PO = "", "", ", PO# " + Regex.Replace(PO, "(\s+|@|&|'|\(|\)|<|>|#)", "")) + " Carrier: " + CA + " , Shipdate " + ShipDate + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "shippinglabelnotification")
                        Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + CombineFileName), (CompanyName + " Shipping Label For Invoice:  " + Order + IIf(PO = "", "", ", PO " + Regex.Replace(PO, "(\s+|@|&|'|\(|\)|<|>|#)", "")) + " Carrier: " + CA + " , Shipdate " + ShipDate + " by user:" + User.Email), "shippinglabelnotification")
                    End If


                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + CombineFileName), (CompanyName + " Shipping Label for Invoice#:  " + Order + " by user:" + User.Email), "labelnotification")

                    ''Add By Prashant On 14 June 2020 -- Create a Text file and send it to printer using BAT command file to be created byjose 
                    ''SalesOrder.CreatetxtShippingLabels(Order, User.ID)

                    Return ReportExportFolder + "\" + CombineFileName
                Else
                    Return "No Data"
                End If
            ElseIf ShippingInformation.Contains("Please release order") Or ShippingInformation.Contains("no armellini account") Or ShippingInformation.Contains("contains 0 dimensions") Then
                Return ShippingInformation
            ElseIf ShippingInformation = "error" Then
                Return "error"
            ElseIf ShippingInformation = "No Data" Then
                Return "No Data"
            ElseIf ShippingInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintShippingLabelList")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    ''' <summary>
    ''' Muthu Nivetha M :: 10Mar2020 :: Modified :: To generate special reg labels only for Cust  type='T' with recipe details
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintShippingLabelList(ByVal Order As String, ByVal ShipDate As String, ByVal CA As String, ByVal PO As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim FloridaBeautyShipper As String = ConfigurationManager.AppSettings("FloridaBeautyShipper").ToString()
            Dim EliteRestAPIShipper As String = ConfigurationManager.AppSettings("EliteRestAPIShipper").ToString()

            Dim gngBarcodePrefix As String = ConfigurationManager.AppSettings("GNGPrefix").ToString()
            Dim isForNewArmellini As String = IIf(ConfigurationManager.AppSettings("SetNewArmellini").ToString() = "1", True, False)
            Dim labelNames As List(Of String) = New List(Of String)()
            SalesOrder.InsertShippingLabelDetailsGabriel("0", User.ID)
            For Each OrderNo In Order.Split(",")
                labelNames.AddRange(SalesOrder.InsertShippingLabelDetailsGabriel(OrderNo, User.ID))
            Next

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString() + "\Labels"
            Dim BodyMessage As String = ""
            Dim ShippingFiles As New List(Of String)
            Dim ReportName As String = ""
            Dim filename As String = ""
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()

            Dim reportParameterCollection As ReportParameter()
            Dim edierror As Boolean = False

            For Each labelName In labelNames.Distinct()
                'filename = CompanyName + "_" + labelName + "_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                filename = CompanyName + "_" + labelName + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                If labelName.Contains("WKROGER") Then
                    reportParameterCollection = New ReportParameter(1) {}

                    reportParameterCollection(0) = New ReportParameter()
                    reportParameterCollection(0).Name = "ConnectionString"
                    reportParameterCollection(0).Values.Add(ConString)

                    reportParameterCollection(1) = New ReportParameter()
                    reportParameterCollection(1).Name = "UserID"
                    reportParameterCollection(1).Values.Add(User.ID)
                ElseIf labelName.Contains("WREG") Then
                    reportParameterCollection = New ReportParameter(1) {}

                        reportParameterCollection(0) = New ReportParameter()
                        reportParameterCollection(0).Name = "ConnectionString"
                        reportParameterCollection(0).Values.Add(ConString)

                        reportParameterCollection(1) = New ReportParameter()
                        reportParameterCollection(1).Name = "UserID"
                        reportParameterCollection(1).Values.Add(User.ID)
                    ElseIf labelName.Contains("FBREG") Or labelName.Contains("FBSM") Or labelName.Contains("GGSM") Or labelName.Contains("GGREG") Or labelName.Contains("ELREG") _
                        Or labelName.Contains("ELSM") Then
                        reportParameterCollection = New ReportParameter(2) {}

                        reportParameterCollection(0) = New ReportParameter()
                        reportParameterCollection(0).Name = "ConnectionString"
                        reportParameterCollection(0).Values.Add(ConString)

                        reportParameterCollection(1) = New ReportParameter()
                        reportParameterCollection(1).Name = "UserID"
                        reportParameterCollection(1).Values.Add(User.ID)

                        reportParameterCollection(2) = New ReportParameter()
                        reportParameterCollection(2).Name = "ShipperNo"
                        If labelName.Contains("GGSM") Or labelName.Contains("GGREG") Then
                            reportParameterCollection(2).Values.Add(gngBarcodePrefix)
                        ElseIf labelName.Contains("ELSM") Or labelName.Contains("ELREG") Then
                            reportParameterCollection(2).Values.Add(EliteRestAPIShipper)
                        Else
                            reportParameterCollection(2).Values.Add(FloridaBeautyShipper)
                        End If
                    Else
                        reportParameterCollection = New ReportParameter(1) {}

                    reportParameterCollection(0) = New ReportParameter()
                    reportParameterCollection(0).Name = "ConnectionString"
                    reportParameterCollection(0).Values.Add(ConString)

                    reportParameterCollection(1) = New ReportParameter("UserID", User.ID)
                End If

                ReportName = objPdf.ExportToPdf(filename, "rptShip" + labelName + "", reportParameterCollection, ExportSSRS.PdfOrientation.ShippingLabel, ExportSSRS.FileType.PDF, "BloomsReportSource", "Labels")
                ShippingFiles.Add(ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ReportExportFolder + "\" + filename)

                edierror = False

                Try
                    If labelName.Contains("GGREG") Or labelName.Contains("GGSM") Then
                        '' G&G API
                        Dim unused = LogiztikAllianceService.Send(Order)

                    End If
                Catch ex As Exception
                    edierror = True
                End Try
                Try
                    If labelName.Contains("ELREG") Or labelName.Contains("ELSM") Then
                        '' Elite API
                        Dim unused = EliteService.SendAsync(Order, User)
                    End If
                Catch ex As Exception
                    edierror = True
                End Try
            Next
            edierror = False
            Try
                If labelNames.Contains("ARREG") Or labelNames.Contains("ARSM") Then
                    Dim fut As New Feature
                    fut = Features.GetFeatureByName("Auto Send ArXML")
                    If fut.Value = True Then
                        Dim ARServiceUserName As String = ""
                        Dim ARServicePassword As String = ""
                        If fut.Options.Contains("*~~~~*") And fut.Options <> Nothing Then
                            ARServiceUserName = fut.Options.Split("*~~~~*")(0).ToString()
                            ARServicePassword = fut.Options.Split("*~~~~*")(2).ToString()
                        End If
                        SendARXML(ARServiceUserName, ARServicePassword, "")
                    End If
                ElseIf labelNames.Contains("FBREG") Or labelNames.Contains("FBSM") Then
                    SendFloridaBeautyEDI("") ''Sends the Order Details to flordia carrier and get the response
                End If
            Catch ex As Exception
                edierror = True
            End Try

            If ShippingFiles.Count > 0 Then
                Dim fileNames As String() = {}
                fileNames = ShippingFiles.ToArray()
                Dim CombinedFilePath As String = ""
                Dim CombineFileName As String = ""
                If Order.Contains(",") Then
                    CombineFileName = CompanyName + "" + "ShippingLabel_" + DateTime.Now.ToString("yyyyMMdd HHmmss") + ".pdf"
                Else
                    CombineFileName = CompanyName + "" + "ShippingLabel_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd HHmmss") + ".pdf"
                End If
                'CombineFileName = "ShippingLabel_" + DateTime.Now.ToString("yyyyMMdd HHmmss") + ".pdf"

                CombinedFilePath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ReportExportFolder + "\" + CombineFileName

                If ShippingFiles.Count > 1 Then
                    Dim Result As String = POReportExport.CombineMultiplePDFs(fileNames, CombinedFilePath)
                Else
                    CombineFileName = filename
                    CombinedFilePath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ReportExportFolder + "\" + CombineFileName
                End If

                If Not ReportName.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + CombineFileName), (CompanyName + " Shipping Label For Invoice#:  " + Order + IIf(PO = "", "", ", PO# " + Regex.Replace(PO, "(\s+|@|&|'|\(|\)|<|>|#)", "")) + " Carrier: " + CA + " , Shipdate " + ShipDate + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "shippinglabelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + CombineFileName), (CompanyName + " Shipping Label For Invoice:  " + Order + IIf(PO = "", "", ", PO " + Regex.Replace(PO, "(\s+|@|&|'|\(|\)|<|>|#)", "")) + " Carrier: " + CA + " , Shipdate " + ShipDate + " by user:" + User.Email), "shippinglabelnotification")
                End If



                Return ReportExportFolder + "\" + CombineFileName
            Else
                Return "No Data"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintShippingLabelList")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintList(ByVal PrinterName As String) As String
        Try
            Dim PrinterValue = Features.getPrinterValueOption(PrinterName)
            Dim wshnetwork As Object = CreateObject("WScript.Network")
            wshnetwork.SetDefaultPrinter(PrinterValue)
            Return "valid"
        Catch ex As Exception
            Return ex.Message.ToString
        End Try
    End Function

    Public Function getPrinterOptions(ByVal FeatureID As String, ByVal Printername As String) As String
        Dim CString = "<input class='Printertext' type='text' id='Pr_" + FeatureID + "' value='" + Printername + "'/>"
        Return CString
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintCustomsInvoice(ByVal Order As String) As String
        Try

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim HeaderInformation = CreateXMLForCustomsInvoiceHeaderSQL(Order)
            Dim DetailsInformation = CreateXMLForCustomsInvoiceDetailsSQL(Order)
            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertCustomsInvoiceDetails(HeaderInformation, DetailsInformation, User.ID)


                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)


                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "UserID"
                reportParameterCollection(1).Values.Add(User.ID)



                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                If Order.Contains(",") Then
                    filename = CompanyName + "" + "CCI_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                Else
                    filename = CompanyName + "" + "CCI_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                End If

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
                Dim BodyMessage As String = ""
                Dim ReportName As String = objPdf.ExportToPdf(filename, "rptCCI", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " CCI for Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                If Not ReportName.Trim().Contains("error : ") Then
                    'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + "CCI For Invoice#:" + Order + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + "CCI For Invoice:" + Order + " by user:" + User.Email), "labelnotification")
                End If
                Return ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" And DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintCustomsInvoice")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function CreateXMLForCustomsInvoiceHeader(ByVal Order As String) As String
    '    Try

    '        Dim User As New User
    '        If Not Session("LoginUserDetails") Is Nothing Then
    '            User = Session("LoginUserDetails")
    '        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '            User = Session("LoginAdminDetails")
    '        End If

    '        Dim ResultHeader As String = ""
    '        Dim SelectedRecordsCount As Integer = 0
    '        Dim stringSeparators() As String = {","}
    '        Dim OrderList() As String
    '        OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
    '        Dim arrlst As New ArrayList()
    '        arrlst.AddRange(OrderList)
    '        Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
    '        If (arrlst.Count > TransferSplitingRangeValue) Then

    '            Dim SplitingIndex As Integer = 0
    '            Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
    '            Dim i As Integer = 0
    '            For i = 0 To SplitingTimesCount - 1
    '                If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
    '                    TransferSplitingRangeValue = arrlst.Count - SplitingIndex
    '                End If
    '                Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
    '                SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

    '                Dim strTest As String = ""
    '                strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
    '                Dim data = obj.GetCustomsInvoiceHeader(strTest)
    '                If data.Length > 0 Then
    '                    If data(0).ErrorMessage = "" Then
    '                        Dim HeaderInfo = New XElement("CustomsInvoiceHeader",
    '                            From Header In data
    '                            Select New XElement("Header", "",
    '                            New XElement("OrderNo", Header.Order.ToString()),
    '                            New XElement("ShiptoName", Header.Shipto),
    '                            New XElement("ShiptoAddress1", Header.ShiptoAddress1),
    '                            New XElement("ShiptoAddress2", Header.ShiptoAddress2),
    '                            New XElement("ShiptoCity", Header.ShiptoCity),
    '                            New XElement("ShiptoState", Header.ShiptoState),
    '                            New XElement("Carrier", Header.Carrier),
    '                            New XElement("CarrierName", Header.CarrierName),
    '                            New XElement("TermDesc", Header.Terms),
    '                            New XElement("PCOName", Header.PCOName),
    '                            New XElement("PCOAddress1", Header.PCOAddress1),
    '                            New XElement("PCOAddress2", Header.PCOAddress2),
    '                            New XElement("PCOAddress3", Header.PCOAddress3),
    '                            New XElement("PCOAddress3", Header.PCOAddress3),
    '                            New XElement("Customer", Header.Customer),
    '                            New XElement("UserID", User.ID)))
    '                        ResultHeader += HeaderInfo.ToString()
    '                    Else
    '                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                        Return "error"
    '                    End If
    '                Else
    '                    Return "No Data"
    '                End If
    '            Next
    '        Else
    '            Dim data = obj.GetCustomsInvoiceHeader(Order)
    '            If data.Length > 0 Then
    '                If data(0).ErrorMessage = "" Then
    '                    Dim HeaderInfo = New XElement("CustomsInvoiceHeader",
    '                        From Header In data
    '                        Select New XElement("Header", "",
    '                            New XElement("OrderNo", Header.Order.ToString()),
    '                            New XElement("ShiptoName", Header.Shipto),
    '                            New XElement("ShiptoAddress1", Header.ShiptoAddress1),
    '                            New XElement("ShiptoAddress2", Header.ShiptoAddress2),
    '                            New XElement("ShiptoCity", Header.ShiptoCity),
    '                            New XElement("ShiptoState", Header.ShiptoState),
    '                            New XElement("Carrier", Header.Carrier),
    '                            New XElement("CarrierName", Header.CarrierName),
    '                            New XElement("TermDesc", Header.Terms),
    '                            New XElement("PCOName", Header.PCOName),
    '                            New XElement("PCOAddress1", Header.PCOAddress1),
    '                            New XElement("PCOAddress2", Header.PCOAddress2),
    '                            New XElement("PCOAddress3", Header.PCOAddress3),
    '                            New XElement("Customer", Header.Customer),
    '                            New XElement("UserID", User.ID)))
    '                    Return HeaderInfo.ToString()
    '                Else
    '                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                    Return "error"
    '                End If
    '            Else
    '                Return "No Data"
    '            End If
    '        End If
    '        Return ResultHeader

    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::CreateXMLForCustomsInvoiceHeader::PageOrder")
    '        Return "error"
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function CreateXMLForCustomsInvoiceDetails(ByVal Order As String) As String
    '    Try

    '        Dim User As New User
    '        If Not Session("LoginUserDetails") Is Nothing Then
    '            User = Session("LoginUserDetails")
    '        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '            User = Session("LoginAdminDetails")
    '        End If

    '        Dim ResultDetails As String = ""
    '        Dim SelectedRecordsCount As Integer = 0
    '        Dim stringSeparators() As String = {","}
    '        Dim OrderList() As String
    '        OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
    '        Dim arrlst As New ArrayList()
    '        arrlst.AddRange(OrderList)
    '        Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
    '        If (arrlst.Count > TransferSplitingRangeValue) Then
    '            Dim SplitingIndex As Integer = 0
    '            Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
    '            Dim i As Integer = 0
    '            For i = 0 To SplitingTimesCount - 1
    '                If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
    '                    TransferSplitingRangeValue = arrlst.Count - SplitingIndex
    '                End If
    '                Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
    '                SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

    '                Dim strTest As String = ""
    '                strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
    '                Dim data = obj.GetCustomsInvoiceDetail(strTest)
    '                If data.Length > 0 Then
    '                    If data(0).ErrorMessage = "" Then
    '                        Dim DetailInfo = New XElement("CustomsInvoiceDetail",
    '                        From Detail In data
    '                        Select New XElement("Detail", "",
    '                        New XElement("OrderNo", Detail.Order.ToString()),
    '                        New XElement("Flower", Detail.FlowerDetails.Flower),
    '                        New XElement("Category", Detail.FlowerDetails.CAT),
    '                        New XElement("Name", Detail.FlowerDetails.Name),
    '                        New XElement("FarmCode", Detail.FarmDetails.FarmCode),
    '                        New XElement("Country", Detail.FarmDetails.Country),
    '                        New XElement("Boxes", Detail.Boxes),
    '                        New XElement("Units", Detail.Units),
    '                        New XElement("FOB", Detail.FOB),
    '                        New XElement("Amount", Detail.Amount),
    '                        New XElement("Customer", Detail.CustCode),
    '                        New XElement("UserID", User.ID),
    '                        New XElement("Weight", Detail.Weight)))
    '                        Return DetailInfo.ToString()
    '                        ResultDetails += DetailInfo.ToString()
    '                    Else
    '                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                        Return "error"
    '                    End If
    '                Else
    '                    Return "No Data"
    '                End If
    '            Next
    '        Else
    '            Dim data = obj.GetCustomsInvoiceDetail(Order)
    '            If data.Length > 0 Then
    '                If data(0).ErrorMessage = "" Then
    '                    Dim DetailInfo = New XElement("CustomsInvoiceDetail",
    '                    From Detail In data
    '                    Select New XElement("Detail", "",
    '                    New XElement("OrderNo", Detail.Order.ToString()),
    '                    New XElement("Flower", Detail.FlowerDetails.Flower),
    '                    New XElement("Category", Detail.FlowerDetails.CAT),
    '                    New XElement("Name", Detail.FlowerDetails.Name),
    '                    New XElement("FarmCode", Detail.FarmDetails.FarmCode),
    '                    New XElement("Country", Detail.FarmDetails.Country),
    '                    New XElement("Boxes", Detail.Boxes),
    '                    New XElement("Units", Detail.Units),
    '                    New XElement("FOB", Detail.FOB),
    '                    New XElement("Amount", Detail.Amount),
    '                    New XElement("Customer", Detail.CustCode),
    '                    New XElement("UserID", User.ID),
    '                    New XElement("Weight", Detail.Weight)))
    '                    Return DetailInfo.ToString()
    '                Else
    '                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                    Return "error"
    '                End If
    '            Else
    '                Return "No Data"
    '            End If
    '        End If
    '        Return ResultDetails
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::CreateXMLForCustomsInvoiceDetails::PageOrder")
    '        Return "error"
    '    End Try
    'End Function

    ''' <summary>
    ''' ANITHA :: 13-Mar-2018 :: SQL Conversion for report CCI
    ''' </summary>
    ''' <param name="Order"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForCustomsInvoiceHeaderSQL(ByVal Order As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim ResultHeader As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    ' Dim data = obj.GetCustomsInvoiceHeader(strTest)
                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    data = SalesOrder.GetCustomsInvoiceHeaderSQL(strTest)
                    TotalRowCount = data.Count
                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim HeaderInfo = New XElement("CustomsInvoiceHeader",
                                From Header In dt.Rows()
                                Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("ShiptoName", Header.item("Shipto")),
                                New XElement("ShiptoAddress1", Header.item("ShiptoAddress1")),
                                New XElement("ShiptoAddress2", Header.item("ShiptoAddress2")),
                                New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                New XElement("ShiptoState", Header.item("ShiptoState")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("CarrierName", Header.item("CarrierName")),
                                New XElement("TermDesc", Header.item("Terms")),
                                New XElement("PCOName", Header.item("PCOName")),
                                New XElement("PCOAddress1", Header.item("PCOAddress1")),
                                New XElement("PCOAddress2", Header.item("PCOAddress2")),
                                New XElement("PCOAddress3", Header.item("PCOAddress3")),
                                New XElement("PCOAddress3", Header.item("PCOAddress3")),
                                New XElement("Customer", Header.item("Customer")),
                                New XElement("UserID", User.ID)))
                            ResultHeader += HeaderInfo.ToString()
                        Else
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                data = SalesOrder.GetCustomsInvoiceHeaderSQL(Order)
                TotalRowCount = data.Count

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim HeaderInfo = New XElement("CustomsInvoiceHeader",
                            From Header In dt.Rows()
                            Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("ShiptoName", Header.item("Shipto")),
                                New XElement("ShiptoAddress1", Header.item("ShiptoAddress1")),
                                New XElement("ShiptoAddress2", Header.item("ShiptoAddress2")),
                                New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                New XElement("ShiptoState", Header.item("ShiptoState")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("CarrierName", Header.item("CarrierName")),
                                New XElement("TermDesc", Header.item("Terms")),
                                New XElement("PCOName", Header.item("PCOName")),
                                New XElement("PCOAddress1", Header.item("PCOAddress1")),
                                New XElement("PCOAddress2", Header.item("PCOAddress2")),
                                New XElement("PCOAddress3", Header.item("PCOAddress3")),
                                New XElement("PCOAddress3", Header.item("PCOAddress3")),
                                New XElement("Customer", Header.item("Customer")),
                                New XElement("UserID", User.ID)))
                        Return HeaderInfo.ToString()
                    Else
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultHeader

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForCustomsInvoiceHeaderSQL::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForCustomsInvoiceDetailsSQL(ByVal Order As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim ResultDetails As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    'Dim data = obj.GetCustomsInvoiceDetail(strTest)
                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    data = SalesOrder.GetCustomsInvoiceDetailSQL(strTest)
                    TotalRowCount = data.Count

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim DetailInfo = New XElement("CustomsInvoiceDetail",
                            From Detail In dt.Rows()
                            Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("Flower", Detail.item("FlowerDetails").Flower),
                            New XElement("Category", Detail.item("FlowerDetails").CAT),
                            New XElement("Name", Detail.item("FlowerDetails").Name),
                            New XElement("FarmCode", Detail.item("FarmDetails").FarmCode),
                            New XElement("Country", Detail.item("FarmDetails").Country),
                            New XElement("Boxes", Detail.item("Boxes")),
                            New XElement("Units", Detail.item("Units")),
                            New XElement("FOB", Detail.item("FOB")),
                            New XElement("Amount", Detail.item("Amount")),
                            New XElement("Customer", Detail.item("CustCode")),
                            New XElement("UserID", User.ID),
                            New XElement("Weight", Detail.item("Weight"))))
                            Return DetailInfo.ToString()
                            ResultDetails += DetailInfo.ToString()
                        Else
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                data = SalesOrder.GetCustomsInvoiceDetailSQL(Order)
                TotalRowCount = data.Count

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim DetailInfo = New XElement("CustomsInvoiceDetail",
                        From Detail In dt.Rows()
                        Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("Flower", Detail.item("FlowerDetails").Flower),
                            New XElement("Category", Detail.item("FlowerDetails").CAT),
                            New XElement("Name", Detail.item("FlowerDetails").Name),
                            New XElement("FarmCode", Detail.item("FarmDetails").FarmCode),
                            New XElement("Country", Detail.item("FarmDetails").Country),
                            New XElement("Boxes", Detail.item("Boxes")),
                            New XElement("Units", Detail.item("Units")),
                            New XElement("FOB", Detail.item("FOB")),
                            New XElement("Amount", Detail.item("Amount")),
                            New XElement("Customer", Detail.item("CustCode")),
                            New XElement("UserID", User.ID),
                            New XElement("Weight", Detail.item("Weight"))))
                        Return DetailInfo.ToString()
                    Else
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForCustomsInvoiceDetailsSQL::PageOrder")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' AUTHOR : Mani
    ''' Date created : 08/22/2017
    ''' Brief description of :Genrerate Ageing Report
    ''' </summary>
    ''' <param name="SalesPerson"></param>
    ''' <param name="TransactionUpto"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintAgeingReport(ByVal SalesPerson As String, ByVal TransactionUpto As String,
                                      ByVal ExportType As String, ByVal UpdateCustomerBalances As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "StatementDate"
            reportParameterCollection(1).Values.Add(TransactionUpto)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "SalesPerson"
            reportParameterCollection(2).Values.Add(SalesPerson)


            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "UpdateCustomerBalances"
            reportParameterCollection(3).Values.Add(UpdateCustomerBalances)


            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            Dim Extension As String = ""

            If ExportType = "PDF" Then
                Extension = ".pdf"
            Else
                Extension = ".xls"
            End If


            If SalesPerson = "" Or SalesPerson = "AllCustomersWithoutGroupBySalesPerson" Or SalesPerson = "AllCustomersGroupedBySalesPerson" Then
                filename = "Ageing_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + Extension
            Else
                filename = "Ageing_" + SalesPerson + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + Extension
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = ""
            If ExportType = "PDF" Then
                ReportName = objPdf.ExportToPdf(filename, "rptAgeing", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Else
                ReportName = objPdf.ExportToPdf(filename, "rptAgeing", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.Excel, "BloomsReportSource")
            End If

            If Not ReportName.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Ageing Report by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Ageing Report by user:" + User.Email), "labelnotification")
                Return XmlPath.Replace("~/", "").Replace("\", "/") + "\" + ReportExportFolder + "\" + filename
            Else
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintAgeingReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintCollectionReport(ByVal PaymentFrom As String, ByVal PaymentTo As String, ByVal IncludeDays As String, ByVal SalesFrom As String, ByVal SalesTo As String, ByVal ReportType As String, ByVal ExportType As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim reportParameterCollection As ReportParameter() = New ReportParameter(8) {}

            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "PaymentFromDt"
            reportParameterCollection(1).Values.Add(PaymentFrom)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "PaymentToDt"
            reportParameterCollection(2).Values.Add(PaymentTo)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "IncludeDays"
            reportParameterCollection(3).Values.Add(IncludeDays)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "SalesFromDt"
            reportParameterCollection(4).Values.Add(SalesFrom)

            reportParameterCollection(5) = New ReportParameter()
            reportParameterCollection(5).Name = "SalesToDt"
            reportParameterCollection(5).Values.Add(SalesTo)

            reportParameterCollection(6) = New ReportParameter()
            reportParameterCollection(6).Name = "Customer"
            reportParameterCollection(6).Values.Add(0)

            reportParameterCollection(7) = New ReportParameter()
            reportParameterCollection(7).Name = "IsShowGPM"
            reportParameterCollection(7).Values.Add("0")

            reportParameterCollection(8) = New ReportParameter()
            reportParameterCollection(8).Name = "WhoMadeSales"
            reportParameterCollection(8).Values.Add(ReportType)


            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            Dim Extension As String = ""

            If ExportType = "PDF" Then
                Extension = ".pdf"
            Else
                Extension = ".xls"
            End If

            filename = "CollectionReport_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + Extension

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = ""
            If ExportType = "PDF" Then
                ReportName = objPdf.ExportToPdf(filename, "rptCollectionReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Else
                ReportName = objPdf.ExportToPdf(filename, "rptCollectionReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.Excel, "BloomsReportSource")
            End If

            If Not ReportName.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Ageing Report by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Collection Report by user:" + User.Email), "labelnotification")
                Return XmlPath.Replace("~/", "").Replace("\", "/") + "\" + ReportExportFolder + "\" + filename
            Else
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintCollectionReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    ''' <summary>
    ''' AUTHOR : Mani
    ''' Date created : 08/09/2018
    ''' Brief description of :Genrerate detailed Ageing Report
    ''' </summary>
    ''' <param name="SalesPerson"></param>
    ''' <param name="TransactionUpto"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintDetailedAgeingReport(ByVal SalesPerson As String, ByVal TransactionUpto As String, ByVal ExportType As String, ByVal Customer As String) As String
        Try
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim resultPath As String = ""
            If ExportType.ToLower() = "excel" Then

                Dim dt1 As DataTable
                dt1 = ARINVS.GetDetailedAgeingReportData(TransactionUpto, SalesPerson, Customer)
                'Dim selectedColumns As String() =
                '    {"Customer", "Parent", "Name", "SalesMan", "SLSMANNAME", "Phone", "PO", "Invoice", "InvDate", "TotalBalance", "M1", "M2", "M3", "M4", "M5"}
                '''' dt.Columns("M1").ColumnName = "Name you want change"
                'Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'Dim dtCloned As DataTable = dt.Clone()
                'For Each row As DataRow In dt1.Rows
                '    dtCloned.ImportRow(row)
                'Next
                Dim filename = ExporttoExcel(dt1, "DetailedAging$DetailedAging")
                resultPath = XmlPath + "\" + ReportExportFolder + "\" + filename
            ElseIf ExportType.ToLower() = "pdf" Then
                Dim User As New User
                Dim BodyMessage As String = ""
                Dim foldername As String = ""
                Dim RptDataSourceName As String = "BloomsReportSource"
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim filename As String = ""
                filename = "DetailedAgeing_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"
                foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
                Dim SysPath As String = foldername

                Dim objPdf As New ExportSSRS
                Dim FullFileName As String = SysPath & filename

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)
                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "StatementDate"
                reportParameterCollection(1).Values.Add(TransactionUpto)
                reportParameterCollection(2) = New ReportParameter()
                reportParameterCollection(2).Name = "SalesPerson"
                reportParameterCollection(2).Values.Add(SalesPerson)
                reportParameterCollection(3) = New ReportParameter()
                reportParameterCollection(3).Name = "CUSTOMER"
                reportParameterCollection(3).Values.Add(Customer)

                Dim s As String = objPdf.ExportToPdf(filename, "rptDetailedAgeing", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, RptDataSourceName)
                resultPath = XmlPath + "\" + ReportExportFolder + "\" + filename
            End If
            Return resultPath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDetailedAgeingReport")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' ANITHA :: 17-JUL-2018 :: [1790] :: Fwd: [Request received] :: Inventory - Print inventory label by farm and boxnumber :: get inventory based on the farm and boxnum
    ''' </summary>
    ''' <param name="FARM"></param>
    ''' <param name="BOXNUM"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetInventorybyFarmAndBOXNUM(ByVal FARM As String, ByVal BOXNUM As String) As BO.Inventory
        Return Inventory.GetInventorybyFarmAndBOXNUM(FARM, BOXNUM)
    End Function

    ''' <summary>
    ''' Anitha :: 23-Oct-2018 :: release racks for selected order
    ''' </summary>
    ''' <param name="Order"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ReleaseRacksforOrder(ByVal Order As String) As String
        Try

            Return SalesOrder.ReleaseRacksforOrder(Order)

        Catch ex As Exception
            Return ex.Message()
        End Try
    End Function

    ''' <summary>
    ''' AUTHOR : Bhuvanesh
    ''' Date created : 05/22/2019
    ''' Brief description of :Genrerate NACM Report
    ''' </summary>
    ''' <param name="TransactionUpto"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintNacmReport(ByVal TransactionUpto As String) As String
        Try
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim resultPath As String = ""

            Dim dt1 As DataTable
            dt1 = ARINVS.GetNacmReportData(TransactionUpto)

            Dim filename = ExporttoExcel(dt1, "NacmReport")
            resultPath = XmlPath + "\" + ReportExportFolder + "\" + filename

            Return resultPath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintNacmReport")
            Return Nothing
        End Try
    End Function

#Region "Standing/Prebooks Reports ( Reports for F8 )"
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSPReports(ByVal SelectedReport As String, ByVal FromDate As String, ByVal ToDate As String, ByVal Slsman As String, ByVal isCO As Boolean) As String
        Dim ReportName As String = ""
        Try
            'System.Globalization.CultureInfo.CurrentUICulture.DateTimeFormat.ShortDatePattern()
            Select Case (SelectedReport)
                Case "rdoSPValidStandingOdrRpt"         'Valid Standing Orders
                    ReportName = GenerateStandingOrPreBooksReports(SelectedReport, FromDate, ToDate, Slsman, isCO)
                Case "rdoSPAllStandingOdrRpt"           'All Standing Orders
                    ReportName = GenerateStandingOrPreBooksReports(SelectedReport, FromDate, ToDate, Slsman, isCO)
                Case "rdoSPUnfilStandingOdrRpt"          'Unfilled Valid Standing Orders
                    ReportName = GenerateStandingOrPreBooksReports(SelectedReport, FromDate, ToDate, Slsman, isCO)
                Case "rdoSPAllPreBooksRpt"              'Print All Pre-Book
                    ReportName = GenerateStandingOrPreBooksReports(SelectedReport, FromDate, ToDate)
            End Select
            Return ReportName
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSPReports")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    Private Function GenerateStandingOrPreBooksReports(ByVal SelectedReport As String, ByVal FromDate As String, ByVal ToDate As String, Optional ByVal Slsman As String = "", Optional ByVal isCO As Boolean = False) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end
            Dim sysFormat As String = CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern
            Dim currentdate As Date = Date.Now()
            Dim Format_Date = Format(CDate(currentdate), sysFormat)
            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(6) {}
            Dim reportrdlname As String = ""
            Dim filenameprefix As String = ""
            Dim paramlist As New List(Of String)

            Select Case (SelectedReport)
                Case "rdoSPValidStandingOdrRpt"
                    paramlist.AddRange(New String() {"ConnectionString", "FromDate", "SelectedReport", "SalesMan", "isCOOnly", "SPReportName", "FormatedDate"})
                    reportParameterCollection = New ReportParameter(paramlist.Count) {}
                    reportParameterCollection = CommonRptParamsSPReports(ConString, FromDate, "SOrderByCustomer", paramlist, "0", "", Slsman, isCO, "STANDING ORDERS BY CUSTOMER", Format_Date)
                    reportrdlname = "rptSpordSPOrdersRpt"
                    filenameprefix = "Valid_SOrders for " + DateTime.Parse(FromDate).DayOfWeek.ToString()
                    'filenameprefix = "Valid_SOrders for " + DateTime.Parse(FromDate).DayOfWeek.ToString() + "_" + DateTime.Parse(FromDate).ToShortTimeString("hh mm ss")
                Case "rdoSPAllStandingOdrRpt"
                    paramlist.AddRange(New String() {"ConnectionString", "FromDate", "SelectedReport", "SalesMan", "isCOOnly", "SPReportName", "FormatedDate"})
                    reportParameterCollection = New ReportParameter(paramlist.Count) {}
                    reportParameterCollection = CommonRptParamsSPReports(ConString, FromDate, "AllStandingOrders", paramlist, "0", "", Slsman, isCO, "All STANDING ORDERS BY CUSTOMER", Format_Date)
                    reportrdlname = "rptSpordSPOrdersRpt"
                    filenameprefix = "All_SOrders for " + DateTime.Parse(FromDate).DayOfWeek.ToString()
                Case "rdoSPUnfilStandingOdrRpt"
                    paramlist.AddRange(New String() {"ConnectionString", "FromDate", "SelectedReport", "SalesMan", "isCOOnly", "SPReportName", "FormatedDate"})
                    reportParameterCollection = New ReportParameter(paramlist.Count) {}
                    reportParameterCollection = CommonRptParamsSPReports(ConString, FromDate, "ValidUnfilledStandingOrders", paramlist, "0", "", Slsman, isCO, "VALID UNFILLED STANDING ORDERS BY CUSTOMER", Format_Date)
                    reportrdlname = "rptSpordSPOrdersRpt"
                    filenameprefix = "Unfill_SOrders for " + DateTime.Parse(FromDate).DayOfWeek.ToString()
                Case "rdoSPAllPreBooksRpt"
                    paramlist.AddRange(New String() {"ConnectionString", "FromDate", "ToDate", "SelectedReport", "FormatedDate"})
                    reportParameterCollection = New ReportParameter(paramlist.Count) {}
                    reportParameterCollection = CommonRptParamsSPReports(ConString, FromDate, "NotificationByAllCustomer", paramlist, "0", ToDate, "", False, "", Format_Date)
                    reportrdlname = "rptSpordNotificationByAllCust"
                    filenameprefix = "All Pre-Books From "
            End Select

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If FromDate <> "" Then
                filename = filenameprefix + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + If(ToDate <> "", " To " + Convert.ToDateTime(ToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy"), "")
                filename = filename.TrimEnd() + ".pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, reportrdlname, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If FromDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary From " + FromDate + If(ToDate <> "", " To " + ToDate, "") + " by user:" + User.Email), "labelnotification")
                End If
            End If
            'Return ReportName
            Return ReportName
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GenerateStandingOrPreBooksReports")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    Private Function CommonRptParamsSPReports(ByVal ConString As String, ByVal FromDate As String, ByVal SelectedReportname As String, ByVal paramlist As List(Of String), ByVal Customer As String, ByVal ToDate As String, ByVal SalesMan As String, ByVal isCOOnly As Boolean, ByVal SPReportName As String, ByVal Format_Date As String) As ReportParameter()

        Dim reportParameterCollection As ReportParameter() = New ReportParameter(0) {}
        Try
            Dim reportparamlength As Integer = paramlist.Count - 1
            reportParameterCollection = New ReportParameter(reportparamlength) {}
            For indx As Integer = 0 To paramlist.Count - 1
                Select Case paramlist(indx).ToString().ToLower()
                    Case "ConnectionString".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "ConnectionString"
                        reportParameterCollection(indx).Values.Add(ConString)
                    Case "FromDate".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "Fromdate"
                        reportParameterCollection(indx).Values.Add(FromDate)
                    Case "SelectedReport".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "SelectedReport"
                        reportParameterCollection(indx).Values.Add(SelectedReportname)
                    Case "Todate".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "Todate"
                        reportParameterCollection(indx).Values.Add(ToDate)
                    Case "Customer".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "Customer"
                        reportParameterCollection(indx).Values.Add(Customer)
                    Case "SalesMan".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "SalesMan"
                        reportParameterCollection(indx).Values.Add(SalesMan)
                    Case "isCOOnly".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "isCOonly"
                        reportParameterCollection(indx).Values.Add(isCOOnly)
                    Case "SPReportName".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "SPReportName"
                        reportParameterCollection(indx).Values.Add(SPReportName)
                    Case "FormatedDate".ToLower()
                        reportParameterCollection(indx) = New ReportParameter()
                        reportParameterCollection(indx).Name = "FormatedDate"
                        reportParameterCollection(indx).Values.Add(Format_Date)
                End Select
            Next
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CommonRptParamsSPReports")
        End Try
        Return reportParameterCollection
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesManListAutoComplete(ByVal Slsman As String) As List(Of SalesMan)
        Try
            Return SalesmanCode.GetSalesManListAutoComplete(Slsman)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesManListAutoComplete")
            Return Nothing
        End Try
    End Function
#End Region

#End Region

#Region "AdminSettings"
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateAdminSettings(ByVal LabelTypeID As String, ByVal InvAppEmails As String) As String
        Try
            Return AdminSettings.UpdateAdminSettings(LabelTypeID, InvAppEmails)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAdminSettings::PageSettings")
            Return ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAdminSettings() As List(Of AdminSetting)
        Try
            Return AdminSettings.GetAdminSettings()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAdminSettings::PageSettings")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCredentialEmailContentSettings() As CredentiatlEmailContent
        Try
            Return AdminSettings.GetCredentialEmailContentSettings()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCredentialEmailContentSettings::PageSettings")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCredentialEmailContentSettings(ByVal Id As String, ByVal Content As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Return AdminSettings.UpdateCredentialEmailContentSettings(Id, User.ID, Content)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCredentialEmailContentSettings::PageSettings")
            Return ex.Message.ToString()
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerReportEmailContent() As CredentiatlEmailContent
        Try
            Return AdminSettings.GetGrowerReportEmailContent()

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerReportEmailContent::PageSettings")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateGrowerReportEmailContent(ByVal Id As String, ByVal Content As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Return AdminSettings.UpdateCredentialEmailContentSettings(Id, User.ID, HttpUtility.UrlDecode(Content, System.Text.Encoding.Default))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateGrowerReportEmailContent::PageSettings")
            Return ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCompanyDetails(ByVal Id As String, ByVal CompanyName As String, ByVal Address As String, ByVal Phone As String, ByVal Fax As String, ByVal CompanyLogoPath As String) As String
        Try
            Return AdminSettings.UpdateCompanyDetails(Id, CompanyName, Address, Phone, Fax, CompanyLogoPath)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCompanyDetails::PageSettings")
            Return ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCompanyDetails() As CompanyDetails
        Try
            Return AdminSettings.GetCompanyDetails()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCompanyDetails::PageSettings")
            Return Nothing
        End Try
    End Function
#End Region

#Region "WebPermission"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetWebPermissionList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(WebPermissions), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New WebPermissions.GetWebPermissionDetails()
            Dim data As List(Of WebPermission) = obj.GetWebPermissions(whereCondition, sortExp, start, rp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.PageID),
                                        New XElement("cell", "<b><a href='#' id='deletepermission_" & row.PageID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<a href='#' id='editpermission_" & row.PageID & "'>" & row.Name & "</a>"),
                                        New XElement("cell", row.Page),
                                        New XElement("cell", row.UserTypes)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWebPermissionList::PageWebpermission")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUserTypeList() As String
        Try
            Dim UserTypeList As New List(Of UserType)
            UserTypeList = UserTypes.LoadUserType()
            Dim UserType As String = ""
            For Each i In UserTypeList
                UserType += "<a id='btnUserType_" + i.ID.ToString + "' class='btnusertypelist' value='" + i.UserType.ToString + "'>" + i.UserType.ToString + "</a>"
            Next
            Return UserType
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserTypeList::PageWebpermission")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetWebPermissionforUserType(ByVal UserType As String) As String
        Try
            Dim Permissions As New List(Of WebPermission)
            Permissions = WebPermissions.GetWebPermissionforUserType(UserType)
            Dim webpermissioncode As String = ""
            webpermissioncode = "<tr class='trwebpermission trTitle'><td style='font-weight: bold; height: 32px;'>WEB Permission</td></tr>"
            For Each i In Permissions
                If UserType.ToLower() = "vendor" Then
                    If i.Page = "ConfirmedPOs" Or i.Page = "PendingPOs" Or i.Page = "Incoming" Or i.Page = "ManualPO" Then
                        webpermissioncode += "<tr class='trwebpermission' id=tr_" + Convert.ToString(i.PageID) + "><td>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox'  class='chkwebpermission' id='chk_" + Convert.ToString(i.PageID) + "' /></td></tr>"
                    End If
                Else
                    If i.Page = "Grower" Then
                        webpermissioncode += "<tr class='trwebpermission' id=tr_" + Convert.ToString(i.PageID) + "><td>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox' class='chkwebpermission chkGrowerReports' id='chk_" + Convert.ToString(i.PageID) + "'  /></td></tr>"
                        webpermissioncode += "<tr style='display:none;background: bisque;' class='trwebpermission trGrowerReportSub'><td><b style='font-size: 17px;padding-left: 17px;'>↳</b> Can Delete Grower?</td><td><input type='checkbox' id='ChkIsGrowerDelete'/></td>" +
                                             "</tr>"
                        webpermissioncode += "<tr style='display:none;background: bisque;' class='trwebpermission trGrowerReportSub'><td><b style='font-size: 17px;padding-left: 17px;'>↳</b> Can Lock Grower?</td><td><input type='checkbox' id='ChkIsGrowerlock'/></td>" +
                                             "</tr>"
                    ElseIf i.Page = "Setups" Then
                        webpermissioncode += "<tr class='trwebpermission' id=tr_" + Convert.ToString(i.PageID) + "><td>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox' class='chkwebpermission chkSetups' id='chk_" + Convert.ToString(i.PageID) + "'  /></td></tr>"
                        webpermissioncode += "<tr style='display:none;background: bisque;' class='trwebpermission trSetupsSub'><td><b style='font-size: 17px;padding-left: 17px;'>↳</b> File Maintenance</td><td><input type='checkbox' checked='checked' id='ChkIsSetupsFile'/></td>" +
                                             "</tr>"
                        webpermissioncode += "<tr style='display:none;background: bisque;' class='trwebpermission trSetupsSub'><td><b style='font-size: 17px;padding-left: 17px;'>↳</b> File Reports</td><td><input type='checkbox' checked='checked' id='ChkIsSetupsReports'/></td>" +
                                             "</tr>"
                        webpermissioncode += "<tr style='display:none;background: bisque;' class='trwebpermission trSetupsSub'><td><b style='font-size: 17px;padding-left: 17px;'>↳</b> Admin</td><td><input type='checkbox' checked='checked' id='ChkIsSetupsAdmin'/></td>" +
                                             "</tr>"
                        webpermissioncode += "<tr style='display:none;background: bisque;' class='trwebpermission trSetupsSub'><td><b style='font-size: 17px;padding-left: 17px;'>↳</b> Import</td><td><input type='checkbox' checked='checked' id='ChkIsSetupsImport'/></td>" +
                                             "</tr>"
                    ElseIf i.Page = "Order" Then
                        webpermissioncode += "<tr class='trwebpermission' id=tr_" + Convert.ToString(i.PageID) + "><td>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox' class='chkwebpermission chkOrders' id='chk_" + Convert.ToString(i.PageID) + "'  /></td></tr>"
                    ElseIf i.Page = "Sales" Then
                        webpermissioncode += "<tr class='trwebpermission' id=tr_" + Convert.ToString(i.PageID) + "><td>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox' class='chkwebpermission chkSales' id='chk_" + Convert.ToString(i.PageID) + "'  /></td></tr>"
                    Else
                        webpermissioncode += "<tr class='trwebpermission' id=tr_" + Convert.ToString(i.PageID) + "><td>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox'  class='chkwebpermission' id='chk_" + Convert.ToString(i.PageID) + "' /></td></tr>"
                    End If
                End If
            Next
            Return webpermissioncode
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWebPermissionforUserType::PageWebpermission")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPermissionforUserID(ByVal UserID As Integer) As List(Of WebPermission)
        Try
            Return WebPermissions.GetPermissionforUserID(UserID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPermissionforUserID::PageWebpermission")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveWebPermissionDetails(ByVal Name As String, ByVal Page As String, ByVal UserTypeList As String, ByVal IsAdmin As String, ByVal IsActive As String) As String
        Try
            Return WebPermissions.SaveWebPermissionDetails(Name, Page, UserTypeList, IsAdmin, IsActive)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveWebPermissionDetails::PageWebpermission")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateWebPermissionDetails(ByVal Name As String, ByVal Page As String, ByVal UserTypeList As String, ByVal IsAdmin As String, ByVal IsActive As String, ByVal PageID As Integer) As String
        Try
            Return WebPermissions.UpdateWebPermissionDetails(Name, Page, UserTypeList, IsAdmin, IsActive, PageID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateWebPermissionDetails::PageWebpermission")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteWebPermissionDetails(ByVal PageID As Integer) As String
        Try
            Return WebPermissions.DeleteWebPermissionDetails(PageID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteWebPermissionDetails::PageWebpermission")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPermissionforPageID(ByVal PageID As Integer) As WebPermission
        Try
            Return WebPermissions.GetWebPermissionforPageID(PageID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPermissionforPageID::PageWebpermission")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Logs"
    <System.Web.Services.WebMethod(True)>
    Public Sub ClearSelectedLogSession()
        Dim log As New ArrayList
        Session("SelectedLogs") = log
    End Sub


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetLogsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Logs.GetLogDetails()
            Dim data As List(Of Log) = obj.GetLogsListForFgrd(whereCondition, sortExp, start, rp)


            Dim SelectedLogDetails As New ArrayList()
            If Not Context.Session("SelectedLogs") Is Nothing Then
                SelectedLogDetails = Context.Session("SelectedLogs")
                For Each Item In data
                    Dim hasItem = SelectedLogDetails.Cast(Of String).Where(Function(i) i.Equals(Item.ID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        Item.LogSelected = True
                    End If
                Next
            End If

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='Logselect_" & row.ID.ToString() & "' src='" & IIf(row.LogSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                                        New XElement("cell", row.ModifiedDateTime),
                                        New XElement("cell", row.ModifiedByName),
                                        New XElement("cell", row.ModifiedPage),
                                        New XElement("cell", row.Action)))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetLogsForFgrd::PageLogs")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedLog(ByVal Selected As String, ByVal ID As String) As String
        Try

            Dim SelectedLogs As New ArrayList
            If Not Session("SelectedLogs") Is Nothing Then
                SelectedLogs = Session("SelectedLogs")
            End If
            Dim LogDet = SelectedLogs.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not LogDet Is Nothing Then
                If Selected = "0" Then
                    SelectedLogs.Remove(LogDet)
                End If
            Else
                If Selected = "1" Then
                    SelectedLogs.Add(ID)
                End If
            End If
            Session("SelectedLogs") = SelectedLogs

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedLog::PageLogs")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedAllLog(ByVal SelectedAll As String) As String
        Try
            Dim SelectedLogs As New ArrayList
            Dim data As List(Of Log) = Logs.GetAllLogs()
            If SelectedAll = "0" Then
                Session("SelectedLogs") = SelectedLogs
            End If
            If SelectedAll = "1" Then
                For Each obj1 In data
                    SelectedLogs.Add(obj1.ID.ToString())
                Next
                Session("SelectedLogs") = SelectedLogs
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedAllLog::PageLogs")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteSelectedLogs() As String
        Try

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim SelectedLogs As New ArrayList
            If Not Session("SelectedLogs") Is Nothing Then
                SelectedLogs = Session("SelectedLogs")
            End If
            If SelectedLogs.Count > 0 Then
                Dim SelectedLogsCS = String.Join(",", SelectedLogs.ToArray())
                Logs.DeleteSelectedLogs(SelectedLogsCS)
                ClearSelectedLogSession()
            End If
            Return "success"

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteSelectedLogs::PageLogs")
            Return "error"
        End Try
    End Function

    Public Sub AppendLog(Message As String, ErrorPage As String)
        Try
            Dim LogPath As String = Server.MapPath("~/Log/")

            If Not Directory.Exists(LogPath) Then
                Directory.CreateDirectory(LogPath)
            End If

            Dim filename As String = "EventLog_" + DateTime.Now.ToString("dd-MM-yyyy") + ".txt"
            Dim filepath As String = LogPath & filename
            If File.Exists(filepath) Then
                Using writer As New StreamWriter(filepath, True)
                    writer.WriteLine("-------------------START-------------")
                    writer.WriteLine(DateTime.Now)
                    writer.WriteLine("Source :" + ErrorPage)
                    writer.WriteLine("Message :" + Message)
                    writer.WriteLine("-------------------END-------------")
                End Using
            Else
                Dim writer As StreamWriter = File.CreateText(filepath)
                writer.WriteLine("-------------------START-------------")
                writer.WriteLine(DateTime.Now)
                writer.WriteLine("Source :" + ErrorPage)
                writer.WriteLine("Message :" + Message)
                writer.WriteLine("-------------------END-------------")
                writer.Close()
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AppendLog")

        End Try
    End Sub

    Public Sub PrinterLog(Message As String, ErrorPage As String)
        Try
            Dim LogPath As String = Server.MapPath("~/Log/")

            If Not Directory.Exists(LogPath) Then
                Directory.CreateDirectory(LogPath)
            End If

            Dim filename As String = "PrinterLog_" + DateTime.Now.ToString("dd-MM-yyyy") + ".txt"
            Dim filepath As String = LogPath & filename
            If File.Exists(filepath) Then
                Using writer As New StreamWriter(filepath, True)
                    writer.WriteLine("-------------------START-------------")
                    writer.WriteLine(DateTime.Now)
                    writer.WriteLine("Source :" + ErrorPage)
                    writer.WriteLine("Message :" + Message)
                    writer.WriteLine("-------------------END-------------")
                End Using
            Else
                Dim writer As StreamWriter = File.CreateText(filepath)
                writer.WriteLine("-------------------START-------------")
                writer.WriteLine(DateTime.Now)
                writer.WriteLine("Source :" + ErrorPage)
                writer.WriteLine("Message :" + Message)
                writer.WriteLine("-------------------END-------------")
                writer.Close()
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AppendLog")

        End Try
    End Sub

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetLabelPrintLogsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                             ByVal query As String, ByVal qtype As String, Filter As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New LabelPrintLogs.GetLabelPrintLogDetails()
            Dim data As List(Of LabelPrintLog) = obj.GetLabelPrintLogsListForFgrd(whereCondition, sortExp, start, rp)
            'Dim objser As New DFlowerDBFService.DFlowerDBFServiceSoapClient
            Dim Farm As String = ""
            Dim Boxnum As String = ""
            Farm = Filter.Split(" and ")(0).Split("=")(1).Replace("'", "")
            Boxnum = Filter.Split(" and ")(2).Split("=")(1)
            Dim BarCode As String = "'" + Farm.PadLeft(3) + Boxnum.PadLeft(5, "0") + "'"
            If data.Count = 0 Then
                Dim TotalRowCount As Integer = 0
                Dim LogList = Nothing
                LogList = Inventory.GetInventoryDetailsbyBarCode(BarCode)
                TotalRowCount = LogList.count
                Dim dt As DataTable = ConvertToDataTable(LogList)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                          New XElement("rows", New XElement("page", page.ToString()),
                                          New XElement("total", TotalRowCount.ToString()),
                                          From row In dt.Rows()
                                          Select
                                          New XElement("row", New XAttribute("id", row.item("ID").ToString()),
                                          New XElement("cell", row.item("Farm")),
                                          New XElement("cell", row.item("ProductCode")),
                                          New XElement("cell", row.item("ProductName")),
                                          New XElement("cell", row.item("Units")),
                                          New XElement("cell", row.item("UOM")),
                                          New XElement("cell", row.item("Cost")),
                                          New XElement("cell", row.item("CustNum")),
                                          New XElement("cell", row.item("AWB")),
                                          New XElement("cell", row.item("Application")),
                                          New XElement("cell", Right("000" + row.item("Sequence").ToString(), 3)),
                                          New XElement("cell", ""),
                                          New XElement("cell", Convert.ToDateTime(row.item("Dt")).ToString("G")),
                                          New XElement("cell", row.item("UpdateUser")),
                                          New XElement("cell", row.item("Invoice")))))

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(xmlDoc.ToString())
                        Return newDoc
                    Else
                        Dim Boxlist = Logs.getBoxLogDetails(BarCode)
                        TotalRowCount = Boxlist.Count
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                      New XElement("rows", New XElement("page", page.ToString()),
                                      New XElement("total", TotalRowCount.ToString()),
                                      Boxlist.Select(Function(row) New XElement("row", New XAttribute("id", row.LogID.ToString()),
                                      New XElement("cell", ""),
                                      New XElement("cell", ""),
                                      New XElement("cell", ""),
                                      New XElement("cell", ""),
                                      New XElement("cell", ""),
                                      New XElement("cell", ""),
                                      New XElement("cell", ""),
                                      New XElement("cell", ""),
                                      New XElement("cell", row.ImportedFrom),
                                      New XElement("cell", Right("000" + row.Sequence.ToString(), 3)),
                                      New XElement("cell", row.Rack),
                                      New XElement("cell", row.PrintedDate.ToString("G")),
                                      New XElement("cell", row.PrintedUser),
                                      New XElement("cell", row.Invoice)))))

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(xmlDoc.ToString())
                        Return newDoc
                    End If
                ElseIf TotalRowCount = 0 Then
                    Dim Boxlist = Logs.getBoxLogDetails(BarCode)
                    TotalRowCount = Boxlist.Count
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                  New XElement("rows", New XElement("page", page.ToString()),
                                  New XElement("total", TotalRowCount.ToString()),
                                  Boxlist.Select(Function(row) New XElement("row", New XAttribute("id", row.LogID.ToString()),
                                  New XElement("cell", ""),
                                  New XElement("cell", ""),
                                  New XElement("cell", ""),
                                  New XElement("cell", ""),
                                  New XElement("cell", ""),
                                  New XElement("cell", ""),
                                  New XElement("cell", ""),
                                  New XElement("cell", ""),
                                  New XElement("cell", row.ImportedFrom),
                                  New XElement("cell", Right("000" + row.Sequence.ToString(), 3)),
                                  New XElement("cell", row.Rack),
                                  New XElement("cell", row.PrintedDate.ToString("G")),
                                  New XElement("cell", row.PrintedUser),
                                  New XElement("cell", row.Invoice)))))

                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Return newDoc
                End If
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.LogID.ToString()),
                                        New XElement("cell", row.PODetails.Farm),
                                        New XElement("cell", row.PODetails.Flower),
                                        New XElement("cell", row.PODetails.Flowername),
                                        New XElement("cell", row.PODetails.Boxes),
                                        New XElement("cell", row.PODetails.UOM),
                                        New XElement("cell", row.PODetails.UnitsPerBox),
                                        New XElement("cell", row.PODetails.CustNumber),
                                        New XElement("cell", IIf(row.PODetails.AWB.Length > 4, row.PODetails.AWB.Substring(row.PODetails.AWB.Length - 4, 4), row.PODetails.AWB)),
                                        New XElement("cell", row.ImportedFrom),
                                        New XElement("cell", Right("000" + row.Sequence.ToString(), 3)),
                                        New XElement("cell", row.Rack),
                                        New XElement("cell", row.PrintedDate.ToString("G")),
                                        New XElement("cell", row.PrintedUser),
                                        New XElement("cell", row.PODetails.Invoice),
                                        New XElement("cell", row.PODetails.HAWB)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetLabelPrintLogsForFgrd::PageIncoming")
            Return Nothing
        End Try
        Return Nothing
    End Function

#End Region

#Region "Flowers"
    '<System.Web.Services.WebMethod(True)>
    'Public Function GetFlowersByCode(ByVal code As String) As Object
    'Try
    'Dim Data = obj.GetFlowersByCode(code)
    'If Data.ErrorMessage = "" Then
    'Return Data
    'Else
    'Dim User As New User
    'If Not Session("LoginUserDetails") Is Nothing Then
    '               User = Session("LoginUserDetails")
    'ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '               User = Session("LoginAdminDetails")
    'End If
    '           Logs.VendorEmailLogs(User, Data.ErrorMessage, "", "Error Notification", "error")
    'Return Nothing
    'End If
    'Catch ex As Exception
    '       ErrorLogs.LogException(ex, "Error in Service::GetFlowersByCode")
    'Return Nothing
    'End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportFlowersfromDBF() As String
    '    Try
    '        Dim ListOfFlowers = obj.LoadFlowers()
    '        If ListOfFlowers.Length > 0 Then

    '            If ListOfFlowers(0).ErrorMessage = "" Then
    '                Dim FlowerList = New XElement("FlowersDetails",
    '                From Flower In ListOfFlowers
    '                Select New XElement("Flowers", "",
    '                New XElement("FLOWER", Flower.Flower),
    '                New XElement("CAT", Flower.CAT),
    '                New XElement("NAME", Flower.Name),
    '                New XElement("UNITSPERBU", Flower.UnitsPerBunch),
    '                New XElement("UNITS", Flower.UNITS),
    '                New XElement("VARIETY", Flower.VARIETY),
    '                New XElement("UOM", Flower.UOM),
    '                New XElement("GRADE", Flower.GRADE),
    '                New XElement("COLOR", Flower.Color),
    '                New XElement("COLORCODE", Flower.ColorCode),
    '                New XElement("FLOWERTYPE", Flower.FLOWERTYPE),
    '                New XElement("KOMETID", Flower.KOMETID)))
    '                Return Flowers.SaveFlowers(FlowerList.ToString())
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.VendorEmailLogs(User, ListOfFlowers(0).ErrorMessage, "", "Error Notification", "error")
    '                Return ListOfFlowers(0).ErrorMessage
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportFlowersfromDBF::PageFlowers")
    '        Return "error"
    '    End Try
    'End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerByID(ByVal ID As String) As Flower
        Try
            Return Flowers.GetFlowerbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerByID")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerForAutoComplete(ByVal Searchtext As String) As List(Of Flower)
        Try
            Return Flowers.GetFlowerForAutoComplete(Searchtext)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerForAutoComplete")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerForAutoCompleteFarmwise(ByVal Searchtext As String, ByVal FarmCode As String) As List(Of Flower)
        Try
            Return Flowers.GetFlowerForAutoCompleteFarmWise(Searchtext, FarmCode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerForAutoCompleteFarmwise")
            Return Nothing
        End Try
    End Function



    ''' <summary>
    ''' MANI:08/FEB/2018::GET Flowers with catogory='k'
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerWithCatergoryK() As List(Of Flower)
        Try
            Return Flowers.GetFlowerWithCatergoryK()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerWithCatergoryK")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetChargeByFlowerCode(ByVal FlowerCode As String) As String
        Try
            Return Flowers.GetChargeByFlowerCode(FlowerCode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetChargeByFlowerCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowersWithSameVarietyAndCategoryByFlowerCode(ByVal FlowerCode As String) As List(Of Flower)
        Try
            Return Flowers.GetFlowersWithSameVarietyAndCategoryByFlowerCode(FlowerCode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowersWithSameVarietyAndCategoryByFlowerCode")
            Return Nothing
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function UpdateFlowerByID(ByVal ID As String, ByVal FlowerCode As String, ByVal FlowerName As String, ByVal Cat As String, ByVal ColorCode As String) As String
        Try
            Return Flowers.UpdateFlowerbyID(ID, FlowerCode, FlowerName, Cat, Convert.ToInt32(ColorCode))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateFlowerByID")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetFlowersForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Flowers.GetFlowerDetails()
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Flower) = obj.GetFlowersListForFgrd(whereCondition, sortExp, start, rp)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                ''24-09-2018 :: Anitha :: Added Status by Jose
                Dim selectedColumns As String() = {"Flower", "Name", "UOM", "UNITS", "BUNCH", "CAT", "VARIETY", "GRADE", "COLOR", "STATUS"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("BUNCH").ColumnName = "UNITS/BUNCH"
                dt.Columns("CAT").ColumnName = "Category"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "FlowerDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of Flower) = obj.GetFlowersListForFgrd(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteFlowers_" & row.ID & "'/>"),
                                        New XElement("cell", "<b><a href='#' id='EditFlowers_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.Flower),
                                        New XElement("cell", "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ForeColor.ToString() + ";'>" + row.Name + "</a></div>"),
                                        New XElement("cell", row.UOM),
                                        New XElement("cell", row.UNITS),
                                        New XElement("cell", row.UOMSOLD),
                                        New XElement("cell", row.BUNCH),
                                        New XElement("cell", row.CAT),
                                        New XElement("cell", row.VARIETY),
                                        New XElement("cell", row.GRADE),
                                        New XElement("cell", row.Color),
                                        New XElement("cell", row.STATUS))))) ''24-09-2018 :: Anitha :: Added Status by Jose
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowersForFgrd::PageFlowers")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Created by Abinaya :: 25Apr2018
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function LoadColors() As List(Of BO.Colors)
        Try
            Return DAO.Colors.LoadColors()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadColors::PageFlowers")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Created by Abinaya :: 25Apr2018
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function LoadColorCode() As List(Of BO.ColorCode)
        Try
            Return DAO.ColorCode.LoadColorCode()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadColorCode::PageFlowers")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Created by Abinaya :: 25Apr2018
    ''' </summary>
    ''' <param name="Category"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function LoadGrades(ByVal Category As String) As List(Of BO.Grades)
        Try
            Return DAO.Grades.LoadGrades(Category)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadGrades::PageFlowers")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Created by Abinaya :: 25Apr2018
    ''' </summary>
    ''' <param name="Category"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function LoadVariety(ByVal Category As String) As List(Of BO.Variety)
        Try
            Return DAO.Variety.LoadVariety(Category)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadVariety::PageFlowers")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveFlowers(ByVal ID As String, ByVal FlowerCode As String, ByVal Cat As String, ByVal FlowerName As String, ByVal Grade As String, ByVal Color As String,
    ByVal Variety As String, ByVal UnitsPerBox As String, ByVal PackedBy As String, ByVal UOMSOLD As String, ByVal WEIGHT As String, ByVal UnitsPerBunch As String, ByVal ScreenColor As String,
    ByVal DaysInCooler As String, ByVal SalesPrice As String, ByVal Status As String, ByVal GL As String, ByVal UserCode As String, ByVal isDuplicateBoxMaintance As Boolean) As String
        Try
            Dim FlowerID As String = ""
            'Modified by Anubhuti 2023_04_20
            Dim ExistsInFarmYN As String = CheckIfSelectedCATAssignedToAnyFarm(Cat)
            If (ExistsInFarmYN <> "1") Then
                FlowerID = "CAT Not Assigned"
                Return FlowerID
            Else
                If (ID = "0" Or isDuplicateBoxMaintance) Then
                    FlowerID = Flowers.InsertFlowers(FlowerCode, Cat, FlowerName, Grade, Color, Variety, Convert.ToInt32(UnitsPerBox), PackedBy, UOMSOLD, WEIGHT, Convert.ToInt32(UnitsPerBunch), ScreenColor, Convert.ToInt32(DaysInCooler), Convert.ToDecimal(SalesPrice), Status, GL, UserCode)
                    If Cat <> "K" And (isDuplicateBoxMaintance And Not FlowerID.Contains("UNIQUE KEY constraint")) Then
                        Dim result As String = ""
                        result = Flowers.InsertDuplicateRecipe(ID, FlowerID)
                    End If
                Else
                    FlowerID = Flowers.UpdateFlowers(ID, FlowerCode, Cat, FlowerName, Grade, Color, Variety, Convert.ToInt32(UnitsPerBox), PackedBy, UOMSOLD, WEIGHT, Convert.ToInt32(UnitsPerBunch), ScreenColor, Convert.ToInt32(DaysInCooler), Convert.ToDecimal(SalesPrice), Status, GL, UserCode)
                End If
                If (Not FlowerID.Contains("UNIQUE KEY constraint")) Then
                    Return FlowerID
                Else
                    'User.ErrorMessage = FarmID
                    Return FlowerID
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFlowers::PageFlowers")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteFlowerByID(ByVal ID As String) As String
        Try
            Return Flowers.DeleteFlowerbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteFlowerByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerForAutoCompleteInSPORD(ByVal Searchtext As String, ByVal Farm As String) As List(Of Flower)
        Try
            Return Flowers.GetFlowerForAutoCompleteInSPORD(Searchtext, Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerForAutoCompleteInSPORD")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerEasyAutocomplete(ByVal Searchtext As String) As List(Of Flower)
        Try
            Return Flowers.GetFlowerEasyAutocomplete(Searchtext)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerEasyAutocomplete")
            Return Nothing
        End Try
    End Function

    'Added by Anubhuti 2023_04_20
    <System.Web.Services.WebMethod(True)>
    Public Function CheckIfSelectedCATAssignedToAnyFarm(ByVal CAT As String) As String
        Try
            Return Flowers.CheckIfSelectedCATAssignedToAnyFarm(CAT)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckIfSelectedCATAssignedToAnyFarm")
            Return Nothing
        End Try
    End Function


#Region "Recipe"
    ''' <summary>
    ''' Altered :: Muthu Nivetha M :: 06Feb2020 :: Resolved show the name of the type Flower in this case instead of F
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetRecipeForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String, ByVal RecipeProductID As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If
            If (whereCondition Is String.Empty) Then
                whereCondition = "PRODUCTID='" + RecipeProductID + "'"
            ElseIf (whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + "PRODUCTID='" + RecipeProductID + "'"
            End If
            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&") + " AND "
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Flowers
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Recipe) = obj.GetRecipeForFgrd(whereCondition, sortExp, start, rp)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                ''24-09-2018 :: Anitha :: Added Status by Jose
                Dim selectedColumns As String() = {"Flower", "Name", "UNITS", "UOM", "Cost", "Type"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Flower").ColumnName = "PRODUCT"
                dt.Columns("Name").ColumnName = "DESCRIPTION"
                dt.Columns("UNITS").ColumnName = "QTY"
                dt.Columns("Cost").ColumnName = "COST"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "RecipeDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of Recipe) = obj.GetRecipeForFgrd(whereCondition, sortExp, start, rp)
                'Modified by Anubhuti 2023_01_17
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteRecipe_" & row.ID & "'/>"),
                                        New XElement("cell", "<b><a href='#' id='EditRecipe_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                         New XElement("cell", "<div class='flowerDescription' id='divflowerDescription_" + row.FlowerID + "' data-flowerName='" + row.Name + "' style='padding-bottom: 3px;cursor:pointer;font-weight:bold;text-decoration: underline;'>" & row.Flower & "</div>"),
                           New XElement("cell", "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.FontColor.ToString() + ";'>" + row.Name + "</a></div>"),
                                        New XElement("cell", row.UNITS),
                                        New XElement("cell", row.UOM),
                                        New XElement("cell", row.Cost),
                                        New XElement("cell", RecipeTypes(row.Type))))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetRecipeForFgrd::PageFlowers")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Created :: Muthu Nivetha M :: 06Feb2020 :: Resolved show the name of the type Flower in this case instead of F
    ''' </summary>
    Private Function RecipeTypes(ByVal type As String) As String
        Dim recipetype = ""
        If type = "" Or type Is Nothing Then
            recipetype = ""
        End If
        Select Case (type.ToLower())
            Case "F".ToLower()
                recipetype = "[" + type.ToUpper() + "] Flower"
            Case "L".ToLower()
                recipetype = "[" + type.ToUpper() + "] Labor"
            Case "P".ToLower()
                recipetype = "[" + type.ToUpper() + "] Pick"
            Case "M".ToLower()
                recipetype = "[" + type.ToUpper() + "] Material"
            Case "O".ToLower()
                recipetype = "[" + type.ToUpper() + "] Other"
        End Select
        Return recipetype
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function SaveRecipeDetails(ByVal RecipeID As String, ByVal ProductID As Integer, ByVal Product As String, ByVal QTY As Integer, ByVal UOM As String, ByVal Cost As Decimal, ByVal Type As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then

                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim data As String = ""
            If RecipeID = "0" Then
                data = Flowers.InsertRecipeDetails(RecipeID, ProductID, Product, QTY, UOM, Cost, Type)
            Else
                data = Flowers.UpdateRecipeDetails(RecipeID, ProductID, Product, QTY, UOM, Cost, Type)
            End If
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "SaveRecipeDetails")
            Return "error"
        End Try

    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetUOMForRecipe() As Object
        Try
            Return Flowers.GetUOMForRecipe()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUOMForRecipe")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetRecipeByID(ByVal ID As String) As Recipe
        Try
            Return Flowers.GetRecipeByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetRecipeByID")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteRECIPEDetails(ByVal ID As String) As String
        Try
            Dim data = Flowers.DeleteRECIPEDetails(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "DeleteRECIPEDetails")
            Return Nothing
        End Try
    End Function

#End Region

#End Region

#Region "ManualPOHeader"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetManualPOHeaderForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                             ByVal qtype As String, ByVal AgencyCode As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype = "AWB" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(ManualPOHeader), qtype, query)
            End If

            'Dim FromDate As String = "" -cmted by mani

            'FromDate = DateTime.Now.ToString("MM/dd/yyyy")-cmted by mani

            Dim LoginUserDetails As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (AgencyCode <> "" And AgencyCode <> String.Empty And LoginUserDetails.UserType = "Cargo Agent") Then
            '    FilterFarms = AgencyCode
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
            Else
                FilterFarms = ""
            End If

            If (whereCondition = "" Or whereCondition = String.Empty Or whereCondition = Nothing) Then
                whereCondition = FilterFarms
            Else
                If (FilterFarms <> "" And FilterFarms <> String.Empty) Then
                    whereCondition = whereCondition + " And " + FilterFarms
                Else
                    whereCondition = whereCondition
                End If
            End If
            'Dim currentDate As DateTime = DateTime.Now
            'Dim FromDate As DateTime = currentDate.AddDays(-180)
            'Console.WriteLine("Current date: " & currentDate)
            'Console.WriteLine("Date before 180 days: " & FromDate)
            'If whereCondition <> String.Empty Or whereCondition <> "" Then
            '    whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>='" + FromDate + "'"
            'Else
            '    whereCondition = "cast(ShippedDate as date)>='" + FromDate + "'"
            'End If


            ''Only apply the single date filter -cmted by mani
            'If (ShippedToDateFilter = String.Empty) Then
            '    If FromDate = DateTime.Now.ToString("MM/dd/yyyy") And ShippedDateFilter = String.Empty Then
            '        If whereCondition <> String.Empty Or whereCondition <> "" Then
            '            whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>='" + FromDate + "'"
            '        Else
            '            whereCondition = "cast(ShippedDate as date)>='" + FromDate + "'"
            '        End If
            '    ElseIf ShippedDateFilter <> String.Empty Then
            '        If whereCondition <> String.Empty Or whereCondition <> "" Then
            '            whereCondition = whereCondition + " And " + "cast(ShippedDate as date)='" + ShippedDateFilter + "'"
            '        Else
            '            whereCondition = "cast(ShippedDate as date)='" + ShippedDateFilter + "'"
            '        End If
            '    End If
            'ElseIf (ShippedToDateFilter <> String.Empty) Then
            '    If whereCondition <> String.Empty Or whereCondition <> "" Then
            '        whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>='" + ShippedDateFilter + "' And cast(ShippedDate as date)<='" + ShippedToDateFilter + "'"
            '    Else
            '        whereCondition = "cast(ShippedDate as date)>='" + ShippedDateFilter + "' And cast(ShippedDate as date)<='" + ShippedToDateFilter + "'"
            '    End If
            'End If
            ' jad 2023-06-24
            'If whereCondition <> "" Then
            '    whereCondition = whereCondition + " and IsShiped <>1"
            'Else
            '    whereCondition = "IsShiped <>1"
            'End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ManualPOHeaders.GetPOHeader()

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of ManualPOHeader) = obj.GetManualPOHeader(whereCondition, sortExp, start, rp)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)

                Dim selectedColumns As String() = {"ShippedDate", "AWB", "FarmCode", "Pieces", "Agency", "FOB", "Header"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("ShippedDate").ColumnName = "Date"
                dt.Columns("AWB").ColumnName = "AWB"
                dt.Columns("FarmCode").ColumnName = "Farm"
                dt.Columns("Pieces").ColumnName = "Boxes"
                dt.Columns("Agency").ColumnName = "AG"
                dt.Columns("FOB").ColumnName = "FOB"
                dt.Columns("Header").ColumnName = "Name"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Date").DataType = GetType(String)
                dtCloned.Columns("AWB").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)

            Else

                Dim data As List(Of ManualPOHeader) = obj.GetManualPOHeader(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", If(obj.TotalRows.ToString() = "0", "1", obj.TotalRows.ToString())),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.HeaderID), New XAttribute("Class", IIf(row.POSelected, "trChecked", "")),
                                            New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeletePOHeader_" & row.HeaderID & "'/>"),
                                            New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='editPOHeader_" & row.HeaderID & "'/>"),
                                            New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='ManualHeaderPOselect_" & row.HeaderID.ToString() & "' src='" &
                                                                IIf(row.POSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                                            New XElement("cell", row.ShippedDate.ToString("MM/dd/yy")),
                                            New XElement("cell", "<a id='headerawb_" + row.HeaderID.ToString() + "' title='" + If(row.AWB <> "" And row.AWB <> String.Empty, row.AWB, "") + "'>" + If(row.AWB <> "" And row.AWB <> String.Empty, If(row.AWB.Length > 4, row.AWB.Substring(row.AWB.Length - 4, 4), row.AWB), "") + "</a>"),
                                            New XElement("cell", "<a id='poheaderfarm_" + row.HeaderID.ToString() + "'>" + row.FarmCode + "</a>"),
                                            New XElement("cell", "<a id='aTotalBoxes_" + row.HeaderID.ToString() + "' title='" + "Pieces: " + row.Pieces.ToString() + " | FBE: " + row.FBE.ToString() + " | Total Units: " + row.TotalUnits.ToString() + "'>" + IIf(row.Pieces.ToString() = 0, "", row.Pieces.ToString()) + "</a>"),
                                            New XElement("cell", row.Agency),
                                            New XElement("cell", "<a id='manualpoheaderfob_" + row.HeaderID.ToString() + "'>" + row.FOB.ToString() + "</a>"),
                                            New XElement("cell", row.Header)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetManualPOHeaderForFgrd::PageManualPO")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPOHeaderByID(ID As Integer) As ManualPOHeader
        Try
            Dim POHeaderDetails As ManualPOHeader = ManualPOHeaders.GetPOHeaderById(ID)
            Return POHeaderDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOHeaderByID::PageManualPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SavePOHeader(ByVal ID As String, ByVal Header As String, ByVal Farm As String, ByVal Agency As String, ByVal HeaderDate As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            If ID = 0 Then
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Dim farmdata As Farm
                farmdata = Farms.GetFarmDetailsByCode(Farm)
                If farmdata.Farm = Nothing Then
                    farmdata.Name = ""
                    farmdata.Manufacid = ""
                    farmdata.FOB = ""
                End If

                Dim data = ManualPODetails.GetManaulPODetailFromFarmPR(Farm)
                If data.Count > 0 Then
                    Dim DetailsList = New XElement("ManualPODetails",
                        From ManualPODetails In data
                        Select New XElement("ManualPO", "",
                            New XElement("Farm", ManualPODetails.Farm),
                            New XElement("Flower", ManualPODetails.Flower),
                            New XElement("Quantity", 0),
                            New XElement("UOM", ManualPODetails.UOM),
                            New XElement("Units", ManualPODetails.UnitsPerBox),
                            New XElement("UnitsPerBunch", ManualPODetails.UnitsPerBunch),
                            New XElement("CostPerUnits", ManualPODetails.Cost),
                            New XElement("FlowerName", ManualPODetails.Flowername),
                            New XElement("FlowerCategory", ManualPODetails.FlowerCategory),
                            New XElement("FobConsig", farmdata.FOB)))

                    Return ManualPOHeaders.SavePOHeader(ID, Header, User.ID, Farm, farmdata.Name, farmdata.Manufacid, farmdata.FOB, DetailsList.ToString(), HeaderDate, Agency.ToUpper())
                Else
                    Return ManualPOHeaders.SavePOHeader(ID, Header, User.ID, Farm, farmdata.Name, farmdata.Manufacid, farmdata.FOB, "<ManualPODetails />", HeaderDate, Agency.ToUpper())
                End If
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Dim farmdata = GetFarmDetailsByCode(Farm)
                Return ManualPOHeaders.SavePOHeader(ID, Header, User.ID, Farm, farmdata.Name, farmdata.Manufacid, farmdata.FOB, "", HeaderDate, Agency.ToUpper())
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SavePOHeader::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeletePOHeader(ByVal ID As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim POHeaderDetails As ManualPOHeader = ManualPOHeaders.GetPOHeaderById(ID)
            If User.UserType <> "Vendor" And User.UserType <> "Sales Person" Then
                Return ManualPOHeaders.DeletePOHeader(ID)
            ElseIf POHeaderDetails.AWB = "" Or POHeaderDetails.AWB = Nothing Or POHeaderDetails.AWB = "0" Then
                Return ManualPOHeaders.DeletePOHeader(ID)
            Else
                Return "AccessDenied"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeletePOHeader")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUserFarmCodeByUserID(ByVal Searchtext As String, ByVal UserID As Integer) As List(Of Farm)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If User.UserType.ToLower() = "vendor" Or User.UserType.ToLower() = "cargo agent" Then
                Return Farms.GetUserFarmCodeByUserID(Searchtext.ToUpper, User.ID)
            Else
                Return Farms.GetUserFarmCodeByUserID(Searchtext.ToUpper, 0)
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserFarmCodeByUserID::PageManualPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUserFarmCodeByUserIDForManualPO(ByVal FarmCode As String, ByVal UserID As Integer) As Farm
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If User.UserType.ToLower() = "vendor" Or User.UserType.ToLower() = "cargo agent" Then
                Return Farms.GetUserFarmCodeByUserIDForManualPO(FarmCode.ToUpper.Trim(), UserID)
            Else
                Return Farms.GetUserFarmCodeByUserIDForManualPO(FarmCode.ToUpper.Trim(), 0)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserFarmCodeByUserIDForManualPO::PageManualPO")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function SaveHeaderFiles(ByVal HeaderId As String, ByVal HeaderFileName As String, fileType As String) As String
        Try
            Return ManualPOHeaders.SaveHeaderFiles(HeaderId, HeaderFileName, fileType)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveHeaderFiles::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetHeaderFiles(ByVal HeaderId As String) As ManualPOHeader
        Try
            Return ManualPOHeaders.GetHeaderFiles(HeaderId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetHeaderFiles::PageManualPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleManualHeaderPOSelected(ByVal Selected As String, ByVal ID As String) As String
        Try
            Dim SelectedHeaderManualPo As New ArrayList
            If Not Session("SelectedHeaderManualPOs") Is Nothing Then
                SelectedHeaderManualPo = Session("SelectedHeaderManualPOs")
            End If
            Dim HeaderPODetails = SelectedHeaderManualPo.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not HeaderPODetails Is Nothing Then
                If Selected = "0" Then
                    SelectedHeaderManualPo.Remove(HeaderPODetails)
                End If
            Else
                If Selected = "1" Then
                    SelectedHeaderManualPo.Add(ID)
                End If
            End If
            Session("SelectedHeaderManualPOs") = SelectedHeaderManualPo

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleManualHeaderPOSelected::PageManualPO")
            Return "error"
        End Try
    End Function




    <System.Web.Services.WebMethod(True)>
    Public Function ToggleManualHeaderPOSelectedAll(ByVal SelectedManualPO As String, ByVal Query As String, ByVal QueryType As String) As String
        Try
            Dim SelectedHeaderManualPo As New ArrayList
            'Dim data As List(Of ManualPODetail) = ManualPODetails.GetManualPODetailsByHeaderID(HeaderID)
            Dim whereCondition As String = ""
            If QueryType = "AWB" Then
                Query = Regex.Replace(Query, "[-]", "")
            End If

            If QueryType IsNot Nothing AndAlso Query IsNot Nothing AndAlso Query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(ManualPOHeader), QueryType, Query)
            End If

            If whereCondition <> "" Then
                whereCondition = whereCondition + " and IsShiped <>1 and ShippedDate > GETDATE()-14"
            Else
                whereCondition = "IsShiped <>1 and ShippedDate > GETDATE()-14"
            End If

            Dim data As List(Of ManualPOHeader) = ManualPOHeaders.GetAllPOHeader(whereCondition)
            If SelectedManualPO = "0" Then
                Session("SelectedHeaderManualPOs") = SelectedHeaderManualPo
            End If
            If SelectedManualPO = "1" Then
                For Each obj1 In data
                    SelectedHeaderManualPo.Add(obj1.HeaderID.ToString())
                Next
                Session("SelectedHeaderManualPOs") = SelectedHeaderManualPo
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleManualHeaderPOSelectedAll::PageManualPO")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Sub ClearManualHeaderPOSelectedSession()
        Try
            Dim SelectedPOs As New ArrayList
            Session("SelectedHeaderManualPOs") = SelectedPOs
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearManualHeaderPOSelectedSession::PageManualPO")
        End Try
    End Sub

#End Region

#Region "ManualPODetail"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetManualPODetailForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                             ByVal Filter As String, ByVal IsEdit As Boolean, ByVal ExportCSV As String) As XmlDocument

        'AppendLog(Filter, "")
        'AppendLog(IsEdit, "")
        Try
            Dim whereCondition As String = ""
            If qtype = "AWB" Then
                query = Regex.Replace(query, "[-]", "")
            End If
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            ' AppendLog(whereCondition, "PODetails Grid Bind")


            Dim obj As New ManualPODetails.GetPODetail()
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of ManualPODetail) = obj.GetManualPODetail(whereCondition, sortExp, start, rp)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)

                Dim selectedColumns As String() = {"Farm", "Flower", "Description", "AWB", "HAWB", "Boxes", "PO", "Invoice", "UOM", "UnitsPerBunch", "CustNumber", "Cost", "TotalCost",
                                                   "TotalUnits", "Comments", "BreakDown", "Type", "ShipDate", "BoxCode", "BoxNumber", "Scanned", "Missing"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("ShipDate").ColumnName = "Date"
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Date").DataType = GetType(String)
                dtCloned.Columns("AWB").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)

            Else
                Dim data As List(Of ManualPODetail) = obj.GetManualPODetail(whereCondition, sortExp, start, rp)

                Dim SelectedManualPOs As New ArrayList()
                If Not Context.Session("SelectedManualPOs") Is Nothing Then
                    SelectedManualPOs = Context.Session("SelectedManualPOs")
                    For Each Item In data
                        Dim hasItem = SelectedManualPOs.Cast(Of String).Where(Function(i) i.Equals(Item.DetailID.ToString)).FirstOrDefault()
                        If Not hasItem Is Nothing Then
                            Item.POSelected = True
                        End If
                    Next
                End If

                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                Dim ShipmentStatus As Boolean = False
                Dim FlowerColorVisibility As Boolean = False
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next

                'Dim ShipmentFarmStatus As Boolean = False
                'If (Convert.ToString(ConfigurationManager.AppSettings("ShipmentValidation")) = "true") Then
                '    ShipmentFarmStatus = Convert.ToString(ConfigurationManager.AppSettings("ShipmentValidation"))
                'End If

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                      New XElement("rows", New XElement("page", page.ToString()),
                      New XElement("total", If(obj.TotalRows.ToString() = "0", "1", obj.TotalRows.ToString())),
                      data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID), New XAttribute("Class", IIf(row.POSelected, "trChecked", "")), New XAttribute("style", IIf(row.Missing <> 0 And row.DetailID <> 0, "background:#FF9B9B !important", "")),
                      New XElement("cell", "<b><a href='#' id='deleteManualPOdetail_" & row.DetailID.ToString() & "'><img src='images/Delete-icon.png'/></a></b>"),
                      New XElement("cell", "<b><a href='#' id='editManualPOdetail_" & row.DetailID.ToString() & "'><img src='images/Edit.png'/></a></b>"),
                      New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='ManualPOselect_" & row.DetailID.ToString() & "' src='" &
                                            IIf(row.POSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                      New XElement("cell", row.Farm),
                      New XElement("cell", row.Flower),
                      New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.FlowrDetails.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.FlowrDetails.ForeColor.ToString() + ";'>" + row.Description + "</a></div>", "<a >" + row.Description + "</a>")),
                      New XElement("cell", IIf(row.DetailID = 0, row.Boxes, "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + ";text-decoration: none;'  id='editBoxeslink_" & row.DetailID.ToString() & "'>" & row.Boxes &
                                           "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:35px' placeholder='" & row.Boxes & "' class='NumbersOnly'  id='editBoxestext_" & row.DetailID.ToString() & "' maxlength='5'></input>")),
                      New XElement("cell", row.UOM),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + ";text-decoration: none;' id='editUnitsBunchlink_" & row.DetailID.ToString() & "'>" & row.UnitsPerBunch &
                                           "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:50px' class='NumbersOnly editUnitsBunchtext' placeholder='" & row.UnitsPerBunch & "' id='editUnitsBunchtext_" & row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + ";text-decoration: none;' id='editUnitslink_" & row.DetailID.ToString() & "'>" & row.UnitsPerBox &
                                           "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:50px' class='NumbersOnly editUnitstext' placeholder='" & row.UnitsPerBox & "' maxlength='4' id='editUnitstext_" & row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", row.TotalUnits),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + ";text-decoration: none;' id='editCostlink_" & row.DetailID.ToString() & "'>" & row.Cost &
                                           "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:50px' class='DecimalsOnly editCosttext' placeholder='" & row.Cost & "' id='editCosttext_" & row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "$" + row.TotalCost.ToString("#,##0.00")),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + "; text-decoration:none;' title='" + IIf(row.Type = "", "", row.Type) + "' id='editTypelink_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.Type = "", "", row.Type) & "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:50px;padding: 1px;' maxlength='1' class='AllUpperCaseTextBox SpecifiedCharOnly' placeholder='" & row.Type & "' id='editTypetext_" &
                                           row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + "; text-decoration:none;' id='editCustNumberlink_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.CustNumber = "0", "", row.CustNumber) & "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:100px' maxlength='5' class='NumbersOnly' placeholder='" & row.CustNumber & "' id='editCustNumbertext_" &
                                           row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + ";text-decoration: none;' title='" + row.Comments + "' href ='#' id='editCommentslink_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.Comments = "", "", row.Comments) & "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:100px' maxlength='10' placeholder='" & row.Comments & "' id='editCommentstext_" &
                                           row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + ";text-decoration: none;' title='" + IIf(row.BreakDown = "", "", row.BreakDown) + "' id='editBreakDownlink_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.BreakDown = "", "", row.BreakDown) & "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:150px' maxlength='50' placeholder='" & row.BreakDown & "' id='editBreakDowntext_" &
                                           row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + "; text-decoration:none;' title='" + IIf(row.BoxCode = "", "", row.BoxCode) + "' id='editBoxCodelink_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.BoxCode = "", "", row.BoxCode) & "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:100px' maxlength='15' placeholder='" & row.BoxCode & "' id='editBoxCodetext_" &
                                           row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a style='cursor:pointer;text-decoration: underline;' data-farm='" + row.Farm + "' data-boxnum='" + row.BoxNumber + "' id='btnmanualpoBoxNo_" + row.DetailID.ToString() + "'>" + row.BoxNumber + "</a>"),
                      New XElement("cell", "<a href='#' style='display:" + IIf(IsEdit, "none", "block") + ";text-decoration: none;' id='editPOlink_" & row.DetailID.ToString() & "'>" & IIf(row.PO = "0", "", row.PO) &
                                           "</a><input type='text' style='display:" + IIf(IsEdit, "block", "none") + ";width:50px' class='restrictspecialcharacters editPOtext' placeholder='" & row.PO & "' maxlength='12' id='editPOtext_" & row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a id='btnmanualpoinvoice_" + row.DetailID.ToString() + "'>" + row.Invoice + "</a>"),
                      New XElement("cell", "<a id='btnmanualpoawb_" + row.DetailID.ToString() + "'>" + row.AWB + "</a>"),
                      New XElement("cell", "<a id='btnmanualpohawb_" + row.DetailID.ToString() + "'>" + row.HAWB + "</a>"),
                      New XElement("cell", "<a id='btnmanualposhipdate_" + row.DetailID.ToString() + "'>" + row.ShipDate.ToString("MM/dd/yyyy") + "</a>"),
                      New XElement("cell", row.Missing),
                      New XElement("cell", "<a id='btnmanualpoduplicate_" + row.DetailID.ToString() + "' class='DuplicateColumns' href='#' style='color:blue;'>Dup</a>"),
                      New XElement("cell", row.MissingAtOrigin),
                      New XElement("cell", String.Format("<img style='margin-top:-3px' id='ItemNotTransfered_" & row.HeaderID.ToString() & "' title='" + IIf(row.ItemNotTransfered, "Item Not Transfered", "Transfered") + "'  src='" & IIf(row.ItemNotTransfered, "images/check-on.png", "images/check-off.png") & "' />"))))))


                Dim newDoc As New XmlDocument()
                Dim idx As Integer = data.Count - 1
                newDoc.LoadXml(xmlDoc.ToString())
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = "Total"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetManualPODetailForFgrd::PageManualPO")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadFlowers(ByVal Farmcode As String) As Object
        Try
            Return Flowers.LoadFlowers(Farmcode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadFlowers::PageManualPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUOMForManualPOByFarm(ByVal FarmCode As String) As Object
        Try
            Dim data As Object
            data = DAOProd.GetUOMForManualPOByFarm(FarmCode)

            Return data

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUOMForManualPO::PageManualPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUOMForManualPO() As Object
        Try
            Dim data As Object
            data = DAOProd.GetUOMFromPROD()

            Return data

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUOMForManualPO::PageManualPO")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteManualPODetails(ByVal ID As String, ByVal HeaderId As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim PODetails As ManualPODetail = ManualPODetails.GetManualPODetailsByID(ID)
            If User.UserType.ToLower() <> "vendor" And User.UserType.ToLower() <> "cargo agent" Then
                Return ManualPODetails.DeleteManualPODetails(ID, HeaderId)
            ElseIf PODetails.AWB = "" Or PODetails.AWB = Nothing Or PODetails.AWB = "0" Then
                Return ManualPODetails.DeleteManualPODetails(ID, HeaderId)
            Else
                Return "AccessDenied"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteManualPODetails::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetManualPODetailsByID(ByVal ID As String) As ManualPODetail
        Try
            Return ManualPODetails.GetManualPODetailsByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetManualPODetailsByID::PageManualPO")
            Return Nothing
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetTopManualPODetailsByHeaderID(ByVal ID As String) As ManualPODetail
    '    Return ManualPODetails.GetTopManualPODetailsByHeaderID(ID)
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveManualPODetails(ByVal DetailID As String, ByVal HeaderId As String, ByVal Farm As String, ByVal Flower As String,
        ByVal AWB As String, ByVal HAWB As String, ByVal Invoice As String, ByVal PONumber As String, ByVal Quantity As String,
        ByVal UOM As String, ByVal Units As String, ByVal UnitsPerBunch As String, ByVal UnitsPerBox As String, ByVal CostPerUnits As String, ByVal Type As String,
        ByVal Comments As String, ByVal CustNumber As String, ByVal OrderNumber As String, ByVal FobConsig As String,
        ByVal CreatedUserId As String, ByVal FlowerName As String, ByVal Mode As Integer, ByVal FlowerCategory As String,
        ByVal BoxCode As String, ByVal BoxNumber As String,
        ByVal PurchaseType As String, ByVal BreakDown As String) As String
        Try
            If (BoxNumber = "") Then

                Dim User As New User
                'checkusersessionIsActive:start
                If Session("LoginUserDetails") Is Nothing Then
                    Return "LogOut"
                Else
                    User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                End If

                Dim BoxnumberResult As String = "0" 'obj.GetBoxNumberFromConstant(User.Name)

                Try
                    If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
                        Return BoxnumberResult
                    Else
                        BoxNumber = BoxnumberResult
                    End If
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in::SaveManualPODetails::PageManualPO::While Getting Box Number")
                    Return "error"
                End Try
            End If

            Return ManualPODetails.SaveManualPODetails(Convert.ToInt32(DetailID), Convert.ToInt32(HeaderId), Farm, Flower,
                  AWB, HAWB, Invoice, PONumber, Quantity, UOM, Units, UnitsPerBunch, UnitsPerBox, CostPerUnits, Type.ToUpper(), Comments, CustNumber, OrderNumber,
                  FobConsig, CreatedUserId, FlowerName, Mode, FlowerCategory, BoxCode, BoxNumber, PurchaseType, BreakDown)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveManualPODetails::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleManualPOSelected(ByVal Selected As String, ByVal ID As String) As String
        Try
            Dim SelectedManualPo As New ArrayList
            If Not Session("SelectedManualPOs") Is Nothing Then
                SelectedManualPo = Session("SelectedManualPOs")
            End If
            Dim PODetails = SelectedManualPo.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not PODetails Is Nothing Then
                If Selected = "0" Then
                    SelectedManualPo.Remove(PODetails)
                End If
            Else
                If Selected = "1" Then
                    SelectedManualPo.Add(ID)
                End If
            End If
            Session("SelectedManualPOs") = SelectedManualPo

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleManualPOSelected::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleManualPOSelectedAll(ByVal SelectedManualPO As String, ByVal HeaderID As String) As String
        Try
            Dim SelectedPOs As New ArrayList
            Dim data As List(Of ManualPODetail) = ManualPODetails.GetManualPODetailsByHeaderID(HeaderID)
            If SelectedManualPO = "0" Then
                Session("SelectedManualPOs") = SelectedPOs
            End If
            If SelectedManualPO = "1" Then
                For Each obj1 In data
                    SelectedPOs.Add(obj1.DetailID.ToString())
                Next
                Session("SelectedManualPOs") = SelectedPOs
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleManualPOSelectedAll::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Sub ClearManualPOSelectedSession()
        Try
            Dim SelectedPOs As New ArrayList
            Session("SelectedManualPOs") = SelectedPOs
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearManualPOSelectedSession::PageManualPO")
        End Try
    End Sub

    <System.Web.Services.WebMethod(True)>
    Public Function ShipManualPOs(ByVal awb As String, ByVal hawb As String, ByVal ShipDate As String, ByVal invoice As String, ByVal HeaderID As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return "LogOut"
            Else
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If

            Dim SelectedManualPo As New ArrayList
            Dim UpdatedBoxNoPO As New List(Of ManualPODetail)
            If Not Session("SelectedManualPOs") Is Nothing Then
                SelectedManualPo = Session("SelectedManualPOs")
            End If
            If SelectedManualPo.Count > 0 Then
                Dim ManualPOIds As String = String.Join(",", SelectedManualPo.ToArray())
                UpdatedBoxNoPO = ManualPODetails.BoxNumberUpdateIds(ManualPOIds, awb)
                Dim updateBoxNoids As String = String.Join(",", UpdatedBoxNoPO.[Select](Function(x) x.DetailID))

                Dim FinalBoxNo As String = "0"
                'Dim BoxnumberResult As String = obj.GetMultipleBoxNumberFromConstant(UpdatedBoxNoPO.Count, User.Name)

                'If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
                '    Return BoxnumberResult
                'Else
                '    FinalBoxNo = BoxnumberResult
                'End If


                If IsNumeric(FinalBoxNo) Then
                    'Dim startboxno As Integer = (Convert.ToUInt32(FinalBoxNo) - UpdatedBoxNoPO.Count) + 1
                    Dim startboxno As Integer = 0
                    Return ManualPODetails.ShipSelectedManualPos(ManualPOIds, awb, hawb.ToUpper, ShipDate, invoice, HeaderID, updateBoxNoids, startboxno)
                Else
                    Return FinalBoxNo
                End If
            ElseIf SelectedManualPo.Count = 0 And HeaderID <> 0 Then
                Dim ManualPODetailsByHeaderID As List(Of ManualPODetail) = ManualPODetails.GetManualPODetailsByHeaderID(HeaderID)
                Dim ManualPOIds As String = String.Join(",", ManualPODetailsByHeaderID.[Select](Function(x) x.DetailID))
                If ManualPOIds <> "" Then
                    UpdatedBoxNoPO = ManualPODetails.BoxNumberUpdateIds(ManualPOIds, awb)
                    Dim updateBoxNoids As String = String.Join(",", UpdatedBoxNoPO.[Select](Function(x) x.DetailID))

                    Dim FinalBoxNo As String = "0"
                    'Dim BoxnumberResult As String = obj.GetMultipleBoxNumberFromConstant(UpdatedBoxNoPO.Count, User.Name)

                    'If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
                    '    Return BoxnumberResult
                    'Else
                    '    FinalBoxNo = BoxnumberResult
                    'End If

                    Dim startboxno As Integer = (Convert.ToUInt32(FinalBoxNo) - UpdatedBoxNoPO.Count) + 1
                    Return ManualPODetails.ShipSelectedManualPos(ManualPOIds, awb, hawb.ToUpper, ShipDate, invoice, HeaderID, updateBoxNoids, startboxno)
                End If
            Else
                Return "please select"
            End If
            Return "please select"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ShipManualPOs::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForSelectedPOs(ByVal Farm As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end
            Dim SelectedManualPo As New ArrayList
            If Not Session("SelectedManualPOs") Is Nothing Then
                SelectedManualPo = Session("SelectedManualPOs")
            End If
            If SelectedManualPo.Count > 0 Then
                Dim ManualPOIds As String = String.Join(",", SelectedManualPo.ToArray())
                Return ManualPODetails.CreatePODetailsXMLFile(ManualPOIds, Farm)
            Else
                Return "please select"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForSelectedPOs::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SendManualPOEmails(ByVal XMLFile As String, ByVal ToEmails As String, ByVal Subject As String, ByVal BodyContent As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end
            Dim VendorEmailPath = ConfigurationManager.AppSettings("VendorEmailsFolder") + "\XML\"
            If (Not Directory.Exists(VendorEmailPath)) Then
                Directory.CreateDirectory(VendorEmailPath)
            End If

            If (File.Exists(VendorEmailPath + XMLFile)) Then
                File.Delete(VendorEmailPath + XMLFile)
            End If

            System.IO.File.Copy(Server.MapPath("temp/" + XMLFile), VendorEmailPath + XMLFile)
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Return Logs.ManualPOEmailLogs(User.Email, ToEmails, BodyContent, XMLFile, Subject)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SendManualPOEmails::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCurrentDateShippingDetails(ByVal HeaderID As String) As ManualPODetail
        Return ManualPODetails.GetCurrentDateShippingDetails(HeaderID)
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateManualPODetails(ByVal PODetails As String, ByVal HeaderID As String) As String
        Try
            Return ManualPODetails.UpdateManualPODetails(PODetails, HeaderID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateManualPODetails::PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteZeroValueManualPODetails(ByVal HeaderID As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end
            Dim SelectedManualPo As New ArrayList
            If Not Session("SelectedManualPOs") Is Nothing Then
                SelectedManualPo = Session("SelectedManualPOs")
            End If
            Dim ManualPOIds As String = ""
            If SelectedManualPo.Count > 0 Then
                ManualPOIds = String.Join(",", SelectedManualPo.ToArray())
            End If
            Return ManualPODetails.DeleteZeroValueManualPODetails(HeaderID, ManualPOIds)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteZeroValueManualPODetails::PageManualPO")
            Return "error"
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetFlowersForAutocomplete(ByVal Searchtext As String) As Object
    '    Try
    '        Dim Data = obj.GetFlowersForAutocomplete(Searchtext.ToUpper)
    '        If Data.Length > 0 Then

    '            If Data(0).ErrorMessage = "" Then
    '                Return Data
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, Data(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetFlowersForAutocomplete::PageManualPO")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetBoxNumberFromConstant() As String
    '    Try
    '        Dim User As New User
    '        'checkusersessionIsActive:start
    '        If Session("LoginUserDetails") Is Nothing Then
    '            Return "LogOut"
    '        Else
    '            User = System.Web.HttpContext.Current.Session("LoginUserDetails")
    '        End If
    '        Return obj.GetBoxNumberFromConstant(User.Name)
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetBoxNumberFromConstant::PageManualPO")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DuplicateManualPODetailsbyID(ByVal DetailID As Integer, ByVal BoxNumber As String) As String
        Try
            If (BoxNumber = "" Or BoxNumber = "0" Or BoxNumber = Nothing) Then
                Return ManualPODetails.DuplicateManualPODetailsbyID(DetailID, "0")
            Else
                Try
                    Dim User As New User
                    'checkusersessionIsActive:start
                    If Session("LoginUserDetails") Is Nothing Then
                        Return "LogOut"
                    Else
                        User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                    End If

                    Dim BoxnumberResult As String = 0 'obj.GetBoxNumberFromConstant(User.Name)

                    If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
                        Return BoxnumberResult
                    Else
                        BoxNumber = BoxnumberResult
                    End If
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in::DuplicateManualPODetailsbyID::PageManualPO::While Getting Box Number")
                    Return "error"
                End Try

                Return ManualPODetails.DuplicateManualPODetailsbyID(DetailID, BoxNumber)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DuplicateManualPODetailsbyID::PageManualPO")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetUOMForSPORD(ByVal FarmCode As String, ByVal UOMCode As String) As Object
        Try
            Return DAOProd.GetUOMForSPORD(FarmCode, UOMCode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUOMForSPORD::PageSPORD")
            Return Nothing
        End Try
    End Function

#End Region

#Region "CheckSession"
    Private Function CheckLoginSessionIsActive(ByVal Type As String) As String
        Try
            If (Type = "User") Then
                If (HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                    Return "InActive"
                Else
                    Return "Active"
                End If
            ElseIf (Type = "Admin") Then
                If (HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                    If (HttpContext.Current.Session("LoginAdminDetails") Is Nothing And Session("IsAdmin") Is Nothing) Then
                        Return "InActive"
                    Else
                        Return "Active"
                    End If
                Else
                    Return "Active"
                End If
            End If

            Return "Active"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckLoginSessionIsActive")
            Return Nothing
        End Try
    End Function
#End Region

#Region "ColorCode"
    <System.Web.Services.WebMethod(True)>
    Public Function GetColorCodeList() As String
        Try
            Dim ColorCodeList As New List(Of Flower)
            ColorCodeList = Flowers.GetColorCodeList()
            Dim ColorCode As String = ""

            Dim n As Integer = 1
            Dim m As Integer = 0

            For n = 1 To (ColorCodeList.Count / 16)
                ColorCode += "<td><table>"
                Dim a As Integer = 0
                If m <> 1 Then
                    a = m
                End If
                m = n * 16
                For Each i In ColorCodeList
                    If a < m Then
                        ColorCode += "<tr><td><div id='code_" + ColorCodeList(a).ID + "' style='background-color:" + ColorCodeList(a).BGColor + ";color:" + ColorCodeList(a).ForeColor + ";' class='codelist'>Code " + ColorCodeList(a).ColorCode + "</div></td></tr>"
                    End If
                    a = a + 1
                Next
                ColorCode += "</table></td>"
            Next
            ColorCode = "<table><tr>" + ColorCode + "</tr></table>"
            Return ColorCode
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetColorCodeList::PageColorCode")
            Return ""
        End Try
    End Function
#End Region

#Region "Incoming"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetManualPOHeaderForIncomingFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                             ByVal qtype As String, ByVal Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype = "AWB" Then
                query = Regex.Replace(query, "[-]", "")
                qtype = "H1.AWB"
                query = "%" + query
            End If
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If



            Dim DateSession(1) As String
            If (Not Session("DateSession") Is Nothing) Then
                DateSession = Session("DateSession")
            Else
                DateSession = Nothing
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If (DateSession Is Nothing) Then
                'FromDate = DateTime.Now.ToString("MM/dd/yyyy")
                ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            Else
                FromDate = DateSession(0).ToString()
                ToDate = DateSession(1).ToString()
            End If

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim FilterFarms As String = ""

            If (Not LoginUserDetails Is Nothing) Then
                If (LoginUserDetails.UserType.ToLower() = "vendor" Or LoginUserDetails.UserType.ToLower() = "cargo agent") Then
                    FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
                    FilterFarms = "h1.farm in (" + FilterFarms + ")"
                End If
            End If

            If (whereCondition = "" Or whereCondition = String.Empty Or whereCondition = Nothing) Then
                If (Filter = "" And Filter = String.Empty) Then
                    If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                        whereCondition = "cast(ShippedDate as date)>= '" + ToDate + "'"
                    Else
                        whereCondition = "(cast(ShippedDate as date)>= '" + FromDate + "' And " + " cast(ShippedDate as date) <= '" + ToDate + "')"
                    End If
                    whereCondition = whereCondition
                Else
                    whereCondition = Filter
                End If
            Else
                If (Filter <> "" And Filter <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter
                Else
                    If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                        whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>= '" + ToDate + "'"
                    Else
                        whereCondition = whereCondition + " And " + "(cast(ShippedDate as date)>= '" + FromDate + "' And " + " cast(ShippedDate as date) <= '" + ToDate + "')"
                    End If
                    whereCondition = whereCondition
                End If
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            'Dim data As List(Of ManualPOHeader) = obj.GetIncomingPOHeader(whereCondition, sortExp, start, rp)

            Dim SelectedManualPOs As New ArrayList()
            Session("SelectedManualPoHeaders") = SelectedManualPOs

            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")


            Dim obj As New Incoming.GetIncomingPOHeader()
            If (ExportCSV <> "") Then
                If (FilterFarms <> "" And FilterFarms <> String.Empty) Then
                    whereCondition = whereCondition + " And " + FilterFarms
                Else
                    whereCondition = whereCondition
                End If

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of ManualPOHeader) = obj.GetIncomingPOHeader(whereCondition, sortExp, start, splitExportcsv(2))

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                'Date,AWB,Farm,Farm Name,Boxes,FBE,Amount,Invoice,Comments,Agency,Airport,Scanned,Missing,Weight,Dim.Weight,MPF,Duties,Image File,PDF File,Details,Status
                Dim selectedColumns As String() =
                    {"ShippedDate", "AWB", "FarmCode", "FarmName", "Pieces", "FBE", "TotalCost", "Invoice", "Header", "Agency", "Airport", "Scanned", "Missing", "Weight", "DimensionalWeight",
                     "MPF", "Duties", "ImageFileName", "PDFFileName"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("ShippedDate").ColumnName = "Date"
                dt.Columns("FarmCode").ColumnName = "Farm"
                dt.Columns("FarmName").ColumnName = "Farm Name"
                dt.Columns("Pieces").ColumnName = "Boxes"
                dt.Columns("TotalCost").ColumnName = "Amount"
                dt.Columns("Header").ColumnName = "Comments"
                dt.Columns("DimensionalWeight").ColumnName = "Dim.Weight"
                dt.Columns("ImageFileName").ColumnName = "Image File"
                dt.Columns("PDFFileName").ColumnName = "PDF File"
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Date").DataType = GetType(String)
                dtCloned.Columns("AWB").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)
            Else
                If (FilterFarms <> "" And FilterFarms <> String.Empty) Then
                    whereCondition = whereCondition + " And " + FilterFarms
                Else
                    whereCondition = whereCondition + " or h1.IsXMLDownload=0"
                End If

                Dim data As List(Of ManualPOHeader) = obj.GetIncomingPOHeader(whereCondition, sortExp, start, rp)
                ''set the invoice number zero instead of empty string
                ''New XElement("cell", "<a id='lblincomingInvoice_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + IIf(row.PoDetails.Invoice = "0", "", row.PoDetails.Invoice) + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly' maxlength='7' placeholder='" & IIf(row.PoDetails.Invoice = "0", "", row.PoDetails.Invoice) & "' id='txtincomingInvoice_" & row.HeaderID.ToString() + "_" + row.PoDetails.Invoice & "'></input>"),
                ''data.Select(Function(row) New XElement("row", New XAttribute("id", row.HeaderID), New XAttribute("style", IIf((row.PoDetails.DifferentBoxes <> 0 Or (row.Pieces - row.PoDetails.Scanned) <> 0) And row.HeaderID <> 0, "background:#FF9B9B !important", "")),
                ''JAD 2023-07-2023 red color background (used for checking scanned boxes removed) for easier visibility
                'Modified by Anubhuti 2023_08_16
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", If(obj.TotalRows.ToString() = "0", "1", obj.TotalRows.ToString())),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.HeaderID),
                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='POHeaderselect_" & row.HeaderID.ToString() & "' src='" & IIf(row.POSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                        New XElement("cell", row.ShippedDate.ToString("MM/dd/yy")),
                        New XElement("cell", If(row.AWB <> "" And row.AWB <> String.Empty, FormatAWBnumber(row.AWB), "")),
                        New XElement("cell", row.FarmCode),
                        New XElement("cell", row.FarmName),
                        New XElement("cell", row.Pieces.ToString()),
                        New XElement("cell", "<a id='lblincomingFBE_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.FBE.ToString("0.000") + "</a>"),
                        New XElement("cell", row.TotalCost.ToString("#,##0.00")),
                        New XElement("cell", IIf(row.HeaderID = 0, "", "<input type='text' id='txtfarmamount_" + row.HeaderID.ToString() + "' class='DecimalsOnly' style='width:77px; text-align:right;' maxlength='9' placeholder='" & row.FarmAmount.ToString() & "''/>")),
                        New XElement("cell", "<a id='lblincomingInvoice_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.PoDetails.Invoice + "</a><input type='text' style='display:none;width:50px' class='NumbersOnly incomingInvoice' maxlength='7' placeholder='" & row.PoDetails.Invoice & "' id='txtincomingInvoice_" & row.HeaderID.ToString().Trim() + "_" + row.PoDetails.Invoice.Trim() & "'></input>"),
                        New XElement("cell", String.Format("<a id='lnkHeaderPDFFile_" + row.HeaderID.ToString() + "' title='" + IIf(Convert.ToString(row.PDFFileName) = "", "", row.PDFFileName) + "' style='cursor:pointer' href='#'>" + IIf(Convert.ToString(row.PDFFileName) = "", "No File", row.PDFFileName) + "</a>")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.Header.ToString(), "<a id='lblincomComment_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.Header.ToString() + "</a><input type='text' id='txtincomComment_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "' style='display:none;width:150px;' placeholder='" & row.Header.ToString() & "''/>")),
                        New XElement("cell", "<a id='lblincomingWH_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.WH + "</a>"),
                        New XElement("cell", row.Agency.ToString()),
                        New XElement("cell", "<a id='lblincomingAirport_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.Airport.ToString() + "</a>"),
                        New XElement("cell", row.PoDetails.Scanned),
                        New XElement("cell", row.Pieces - row.PoDetails.Scanned),
                        New XElement("cell", IIf(row.HeaderID = 0, row.Weight.ToString(), "<a id='lblincomweight_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.Weight.ToString() + "</a><input type='text' id='txtincomweight_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "' class='DecimalsOnly' style='display:none;width:150px; maxlength='50' placeholder='" & row.Weight.ToString() & "''/>")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.DimensionalWeight.ToString(), "<a id='lblincomdimweight_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.DimensionalWeight.ToString() + "</a><input type='text' id='txtincomdimweight_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "' class='DecimalsOnly' style='display:none;width:150px; maxlength='50' placeholder='" & row.DimensionalWeight.ToString() & "''/>")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.MPF.ToString(), "<a id='lblincommpf_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.MPF.ToString() + "</a><input type='text' id='txtincommpf_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "' class='DecimalsOnly' style='display:none;width:150px; maxlength='50' placeholder='" & row.MPF.ToString() & "''/>")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.Duties.ToString(), "<a id='lblincomduties_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "'>" + row.Duties.ToString() + "</a><input type='text' id='txtincomduties_" + row.HeaderID.ToString() + "_" + row.PoDetails.Invoice + "' class='DecimalsOnly' style='display:none;width:150px; maxlength='50' placeholder='" & row.Duties.ToString() & "''/>")),
                        New XElement("cell", String.Format("<a href='#' id='lnkHeaderImageFile_" + row.HeaderID.ToString() + "' title='" + IIf(Convert.ToString(row.ImageFileName) = "", "", row.ImageFileName) + "' style='cursor:pointer'>" + IIf(Convert.ToString(row.ImageFileName) = "", "No File", row.ImageFileName) + "</a>")),
                        New XElement("cell", String.Format("<img id='lnkHeaderDetails_" + row.HeaderID.ToString() + "_" + row.FarmCode.ToString() + "_" + row.AWB.ToString() + "_" + row.PoDetails.Invoice.ToString() + "' style='cursor:pointer;margin-top:-3px;height: 16px;" + IIf(row.ItemNotTransfered, "border: 1px solid #fff;", "") + "' src='images/Details" + IIf(row.ItemNotTransfered, "_Red", "") + ".png' />")),
                        New XElement("cell", ManualPOHeaderForIncomingFgrdStatusColumnFormat(row.HeaderID, row.IsXMLDownload, row.ShippedDate)),
                        New XElement("cell", row.PoDetails.ScannedOrigin),
                        New XElement("cell", row.PoDetails.MissingAtOrigin)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                If data.Count > 0 Then
                    Dim idx As Integer = data.Count - 1
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                End If
                Return newDoc
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetManualPOHeaderForIncomingFgrd::PageIncoming")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function CompareManualInomingBoxes(ByVal AwbFarm As String, ByVal Invoice As String) As String
    '    Try
    '        Dim Awb As String() = AwbFarm.Split("-")
    '        Dim ret As DataTable = obj.CompareHeaderDetailsBoxes(Awb(0), Awb(1), Invoice)
    '        Dim selectedColumns As String() =
    '                {"PONumber", "ConfirmedQty", "IncomingQty", "Difference"}
    '        Dim dt As DataTable = New DataView(ret).ToTable(False, selectedColumns)
    '        Dim filename = ExporttoExcel(dt, "CompareManualInomingBoxes" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + "")
    '        Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
    '        Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
    '        Dim filepath = ReportExportFolder + "\" + filename
    '        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
    '        Return FullPath
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::RemovePDFFile::PageIncoming")
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function RemovePDFFile(ByVal HeaderID As String) As String
        Try
            Dim obj As New Incoming.GetIncomingPOHeader()
            Dim ret As String = obj.RemovePDFFile(HeaderID)

            Return ret
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::RemovePDFFile::PageIncoming")
            Return "An error has occurred when removing the PDF File."
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetManualPOHeaderForPayableFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                             ByVal qtype As String, ByVal Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype = "AWB" Then
                query = Regex.Replace(query, "[-]", "")
            End If
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If



            Dim DateSession(1) As String
            If (Not Session("DateSession") Is Nothing) Then
                DateSession = Session("DateSession")
            Else
                DateSession = Nothing
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If (DateSession Is Nothing) Then
                'FromDate = DateTime.Now.ToString("MM/dd/yyyy")
                ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            Else
                FromDate = DateSession(0).ToString()
                ToDate = DateSession(1).ToString()
            End If

            Dim LoginUserDetails As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim FilterFarms As String = ""
            If (Not LoginUserDetails Is Nothing) Then
                FilterFarms = LoginUserDetails.Farms.Replace("~", "'")
            End If

            'If (LoginUserDetails.UserType.ToLower() = "inventory" Or LoginUserDetails.UserType.ToLower() = "admin") Then
            '    FilterFarms = ""
            'End If
            'If FilterFarms <> "" Then
            '    FilterFarms = "Farm in (" + FilterFarms + ")"
            'End If
            If (LoginUserDetails.UserType = "Vendor" Or LoginUserDetails.UserType = "Cargo Agent") Then
                FilterFarms = "Farm in (" + FilterFarms + ")"
            Else
                FilterFarms = ""
            End If

            If (whereCondition = "" Or whereCondition = String.Empty Or whereCondition = Nothing) Then
                If (Filter = "" And Filter = String.Empty) Then
                    If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                        whereCondition = "cast(ShippedDate as date)>= '" + ToDate + "'"
                    Else
                        whereCondition = "cast(ShippedDate as date)>= '" + FromDate + "' And " + " cast(ShippedDate as date) <= '" + ToDate + "'"
                    End If
                    whereCondition = whereCondition
                Else
                    whereCondition = Filter
                End If

            Else
                If (Filter <> "" And Filter <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter
                Else
                    If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                        whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>= '" + ToDate + "'"
                    Else
                        whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>= '" + FromDate + "' And " + " cast(ShippedDate as date) <= '" + ToDate + "'"
                    End If
                    whereCondition = whereCondition
                End If
            End If

            If (FilterFarms <> "" And FilterFarms <> String.Empty) Then
                whereCondition = whereCondition + " And " + FilterFarms
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            'Dim data As List(Of ManualPOHeader) = obj.GetIncomingPOHeader(whereCondition, sortExp, start, rp)

            Dim SelectedManualPOs As New ArrayList()
            Session("SelectedManualPoHeaders") = SelectedManualPOs

            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")


            'New XElement("cell", IIf(row.HeaderID = 0, row.Weight.ToString(), "<a id='lblincomweight_" + row.HeaderID.ToString() + "'>" + row.Weight.ToString() + "</a><input type='text' id='txtincomweight_" + row.HeaderID.ToString() + "' class='DecimalsOnly' style='display:none;width:150px; maxlength='50' placeholder='" & row.Weight.ToString() & "''/>")),

            Dim obj As New Incoming.GetIncomingPOHeader()
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of ManualPOHeader) = obj.GetIncomingPOHeaderPayable(whereCondition, sortExp, start, splitExportcsv(2))

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                'Date,AWB,Farm,Farm Name,Boxes,FBE,Amount,Invoice,Comments,Agency,Airport,Scanned,Missing,Weight,Dim.Weight,MPF,Duties,Image File,PDF File,Details,Status
                Dim selectedColumns As String() =
                    {"ShippedDate", "AWB", "FarmCode", "FarmName", "Pieces", "FBE", "TotalCost", "Invoice", "Header", "Agency", "Airport", "Scanned", "Missing", "Weight", "DimensionalWeight",
                     "MPF", "Duties", "ImageFileName", "PDFFileName"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("ShippedDate").ColumnName = "Date"
                dt.Columns("FarmCode").ColumnName = "Farm"
                dt.Columns("FarmName").ColumnName = "Farm Name"
                dt.Columns("Pieces").ColumnName = "Boxes"
                dt.Columns("TotalCost").ColumnName = "Amount"
                dt.Columns("Header").ColumnName = "Comments"
                dt.Columns("DimensionalWeight").ColumnName = "Dim.Weight"
                dt.Columns("ImageFileName").ColumnName = "Image File"
                dt.Columns("PDFFileName").ColumnName = "PDF File"
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Date").DataType = GetType(String)
                dtCloned.Columns("AWB").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of ManualPOHeader) = obj.GetIncomingPOHeaderPayable(whereCondition, sortExp, start, rp)
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", If(obj.TotalRows.ToString() = "0", "1", obj.TotalRows.ToString())),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.HeaderID), New XAttribute("style", IIf((row.PoDetails.DifferentBoxes <> 0 Or row.PoDetails.Missing <> 0) And row.HeaderID <> 0, "background:#FF9B9B !important", "")),
                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='POHeaderselect_" & row.HeaderID.ToString() & "' src='" & IIf(row.POSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                        New XElement("cell", row.ShippedDate.ToString("MM/dd/yy")),
                        New XElement("cell", If(row.AWB <> "" And row.AWB <> String.Empty, FormatAWBnumber(row.AWB), "")),
                        New XElement("cell", row.FarmCode),
                        New XElement("cell", row.FarmName),
                        New XElement("cell", row.Pieces.ToString()),
                        New XElement("cell", "<a id='lblincomingFBE_" + row.HeaderID.ToString() + "'>" + row.FBE.ToString("0.000") + "</a>"),
                        New XElement("cell", String.Format("<span id='POAmount_" & row.HeaderID.ToString() & "' style='text-align:right;'>" & row.TotalCost.ToString("#,##0.00") & "</span>")),
                        New XElement("cell", "<a id='lblincomingInvoice_" + row.Header.ToString() + "' style='text-align:right;'>" + row.PoDetails.Invoice.ToString() + "</a>"),
                        New XElement("cell", String.Format("<span id='FarmAmount_" & row.HeaderID.ToString() & "' style='text-align:right; " & IIf(row.FarmAmount = 0, "", IIf(Not row.TotalCost = row.FarmAmount, "color:red;", "")) & "' > " & row.FarmAmount & "</span>")),
                        New XElement("cell", IIf(row.HeaderID = 0, "", "<input type='text' id='txtfarmamount_" + row.HeaderID.ToString() + "' class='DecimalsOnly' style='width:77px; text-align:right;' maxlength='9' placeholder='" & row.FarmAmount.ToString() & "''/>")),
                        New XElement("cell", String.Format("<a id='lnkHeaderPDFFile_" + row.HeaderID.ToString() + "' title='" + IIf(Convert.ToString(row.PDFFileName) = "", "", row.PDFFileName) + "' style='cursor:pointer' href='#'>" + IIf(Convert.ToString(row.PDFFileName) = "", "No File", row.PDFFileName) + "</a>")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.Credits.ToString("0.00"), "<input type='text' id='txtCredits_" + row.HeaderID.ToString() + "' class='DecimalsOnly' " & IIf(row.Paid, "readonly='readonly'", "") & " style='width:77px;text-align:right;' placeholder='" & row.Credits.ToString("0.00") & "'/>")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.AmountToPay.ToString("0.00"), "<input type='text' id='txtAmountToPay_" + row.HeaderID.ToString() + "' class='DecimalsOnly' readonly='true'  style='width:84px;text-align:right;' placeholder='" & row.AmountToPay.ToString("0.00") & "'/>")),
                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='BuyerApprovalselect_" & row.HeaderID.ToString() & "' src='" & IIf(row.BuyerApproval, "images/check-on.png", "images/check-off.png") & "' />")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.Header.ToString(), "<input type='text' id='txtDateApproved_" + row.HeaderID.ToString() + "'  style='width:77px;' placeholder='" & IIf(row.BuyerApproval, row.DateApproved.ToString("MM/dd/yyyy"), "") & "'/>")),
                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='Paidselect_" & row.HeaderID.ToString() & "' src='" & IIf(row.Paid, "images/check-on.png", "images/check-off.png") & "' />")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.Header.ToString(), "<input type='text' id='txtDatePayed_" + row.HeaderID.ToString() + "'  style='width:77px;' placeholder='" & IIf(row.Paid, row.DatePayed.ToString("MM/dd/yyyy"), "") & "'/>")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.PendingPayment.ToString("0.00"), "<input type='text' id='txtPendingPayment_" + row.HeaderID.ToString() + "' class='DecimalsOnly' readonly='true'  style='width:107px;text-align:right;' placeholder='" & row.PendingPayment.ToString("0.00") & "'/>")),
                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='QBselect_" & row.HeaderID.ToString() & "' src='" & IIf(row.QB, "images/check-on-disabled.png", "images/check-off.png") & "' />")),
                        New XElement("cell", IIf(row.HeaderID = 0, row.Header.ToString(), "<input type='text' id='txtDateQB_" + row.HeaderID.ToString() + "'  style='width:77px;' placeholder='" & IIf(row.QB, row.DateQB.ToString("MM/dd/yyyy"), "") & "'/>"))
                   ))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                If data.Count > 0 Then
                    Dim idx As Integer = data.Count - 1
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""

                End If
                Return newDoc
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetManualPOHeaderForPayableFgrd::PageIncoming")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function


    'Private Function BuildMeasurementsDetails(ByVal Weight As Decimal, ByVal Dimention As Decimal, ByVal MPF As Decimal, ByVal Duties As Decimal) As String
    '    If (Weight = 0 And Dimention = 0 And MPF = 0 And Duties = 0) Then
    '        Return ""
    '    Else
    '        Return "Weight: " + "<a class='measurements'>" + Weight.ToString() + "</a>" + " DIM: <a class='measurements'>" + Dimention.ToString() + "</a class='measurements'> MPF: <a class='measurements'>" + MPF.ToString() + "</a>Duties: <a class='measurements'>" + Duties.ToString() + " </a>"
    '    End If
    'End Function

    'VEN::09-10-205::FOR DATE FILLTER 

    '<System.Web.Services.WebMethod(True)>
    'Public Sub SaveIncomingDateSession(ByVal FromDate As String, ByVal ToDate As String)
    '    Try
    '        If FromDate <> "" And ToDate <> "" Then
    '            Dim DateSession(1) As String
    '            DateSession(0) = FromDate
    '            DateSession(1) = ToDate
    '            Session("DateSession") = DateSession
    '        Else
    '            Session("DateSession") = Nothing
    '        End If

    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::SaveIncomingDateSession::PageIncoming")
    '    End Try
    'End Sub
    ''VEN::09-10-205::FOR DATE FILLTER 
    '<System.Web.Services.WebMethod(True)>
    'Public Function GetIncomingDateSession() As String()
    '    Try
    '        Dim DateSession(1) As String
    '        DateSession = Session("IncomingDateSession")
    '        Return DateSession
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetIncomingDateSession::PageIncoming")
    '        Return Nothing
    '    End Try
    'End Function

    Public Function FormatAWBnumber(ByVal AWB As String) As String
        Try
            Dim MAWB As String = ""
            If (AWB.Length = 11) Then
                MAWB = AWB.Substring(0, 3) + "-" + AWB.Substring(3, 4) + "-" + AWB.Substring(7, 4)
            ElseIf (AWB.Length = 12) Then
                MAWB = AWB.Substring(0, 4) + "-" + AWB.Substring(4, 4) + "-" + AWB.Substring(8, 4)
            Else
                MAWB = AWB
            End If
            Return MAWB
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::FormatAWBnumber::PageIncoming")
            Return ""
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ToggleManualPOHeaderSelected(ByVal Selected As String, ByVal ID As String) As String
        Try
            Dim SelectedManualPoHeader As New ArrayList
            If Not Session("SelectedManualPoHeaders") Is Nothing Then
                SelectedManualPoHeader = Session("SelectedManualPoHeaders")
            End If
            Dim POHeaders = SelectedManualPoHeader.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not POHeaders Is Nothing Then
                If Selected = "0" Then
                    SelectedManualPoHeader.Remove(POHeaders)
                End If
            Else
                If Selected = "1" Then
                    SelectedManualPoHeader.Add(ID)
                End If
            End If
            Session("SelectedManualPoHeaders") = SelectedManualPoHeader

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleManualPOHeaderSelected::PageIncoming")
            Return "invalid"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ToggleManualPOHeaderSelectedAll(ByVal SelectedManualPO As String, ByVal HeaderID As String, ByVal WhereCondition As String, ByVal Query As String, ByVal QueryType As String) As String
        Try
            Dim SelectedManualPoHeader As New ArrayList
            If QueryType = "AWB" Then
                Query = Regex.Replace(Query, "[-]", "")
            End If
            WhereCondition = HttpUtility.UrlDecode(WhereCondition, System.Text.Encoding.Default)
            If QueryType IsNot Nothing AndAlso Query IsNot Nothing AndAlso Query <> String.Empty Then
                If WhereCondition <> "" Then
                    WhereCondition = WhereCondition + " And  " + BuildWhereCondition(GetType(ManualPOHeader), QueryType, Query)
                Else
                    WhereCondition = BuildWhereCondition(GetType(ManualPOHeader), QueryType, Query)
                End If
            End If

            Dim data As List(Of ManualPOHeader) = ManualPOHeaders.GetAllPOHeader(WhereCondition)
            If SelectedManualPO = "0" Then
                Session("SelectedManualPoHeaders") = SelectedManualPoHeader
            End If
            If SelectedManualPO = "1" Then
                For Each obj1 In data
                    SelectedManualPoHeader.Add(obj1.HeaderID.ToString())
                Next
                Session("SelectedManualPoHeaders") = SelectedManualPoHeader
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleManualPOHeaderSelectedAll::PageIncoming")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Sub ClearManualPOHeaderSelectedSession()
        Try
            Dim SelectedPOs As New ArrayList
            Session("SelectedManualPoHeaders") = SelectedPOs
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearManualPOHeaderSelectedSession::PageIncoming")
        End Try
    End Sub

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForSelectedPOHeaders() As String
        Try
            Dim xmldetails As XMLDetails = New XMLDetails()
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                'xmldetails.XMLFileName = "LogOut"
                'xmldetails.XMLFileContent = ""
                Return "LogOut"
            End If
            'end
            Dim SelectedManualPo As New ArrayList
            If Not Session("SelectedManualPoHeaders") Is Nothing Then
                SelectedManualPo = Session("SelectedManualPoHeaders")
            End If
            If SelectedManualPo.Count > 0 Then
                Dim ManualPOIds As String = String.Join(",", SelectedManualPo.ToArray())
                ManualPOHeaders.UpdateXMLDownloadStatus(ManualPOIds)
                'Return ManualPOHeaders.GenerateXMLFileforPOHeader(ManualPOIds)
                Return Incoming.GenerateXMLFileforIncoming(ManualPOIds)
            Else
                'xmldetails.XMLFileName = "please select"
                'xmldetails.XMLFileContent = ""
                Return "please select"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForSelectedPOHeaders::PageIncoming")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UploadDvFile(path As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim resultUpload As String = Incoming.UploadDVFile(path)
            Dim resultEdi As String = EliteService.SendDV(User)
            If resultEdi <> "success~" Then
                Return resultEdi
            End If
            Return resultUpload
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UploadDvFile::PageIncoming")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function UploadNewDvFile(path As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim resultUpload As String = Incoming.UploadNewDVFile(path)
            Dim resultEdi As String = EliteService.SendNewDV(User)
            If resultEdi <> "success~" Then
                Return resultEdi
            End If
            Return resultUpload
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UploadDvFile::PageIncoming")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Async Function UploadPostPaymentFile(ByVal fileBase64Str As String, ByVal fileName As String, ByVal depositNo As String) As Task(Of String)
        Try
            Dim result As String
            Dim folderPath As String = HttpContext.Current.Server.MapPath("~/temp/")

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If Not System.IO.Directory.Exists(folderPath) Then
                System.IO.Directory.CreateDirectory(folderPath)
            End If

            fileBase64Str = fileBase64Str.Split(","c)(1)
            Dim filePath As String = folderPath & "\" & fileName
            System.IO.File.WriteAllBytes(filePath, Convert.FromBase64String(fileBase64Str))
            If System.IO.File.Exists(filePath) Then
                Dim dt As DataTable = New DataTable()
                dt = Await ConvertPaymentCSVtoDataTable(filePath, User.Email, depositNo)
                If (dt.Rows.Count() = 0) Then
                    result = "Wrong pos found in payment detail file for deposit# " + depositNo
                Else
                    result = Payments.UploadPaymentFileToTempTable(dt, filePath, depositNo)
                End If
            Else
                Throw New Exception("File can not be saved!")
            End If
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UploadPostPaymentFile::PagePostPayment")
            Return "error"
        End Try
        Return ""
    End Function

    Public Shared Async Function ConvertPaymentCSVtoDataTable(ByVal strFilePath As String, ByVal email As String, ByVal depositNo As String) As Task(Of DataTable)
        Dim dt As DataTable = New DataTable()
        Dim invalidPos As String = ""

        Using sr As StreamReader = New StreamReader(strFilePath)
            Dim headers As String() = sr.ReadLine().Split(","c)

            For Each header As String In headers
                dt.Columns.Add(header)
            Next

            While Not sr.EndOfStream
                Dim rows As String() = sr.ReadLine().Split(","c)
                Dim dr As DataRow = dt.NewRow()
                Dim po As String = ""

                For i As Integer = 0 To headers.Length - 1
                    If (i = 0) Then
                        po = rows(i).PadLeft(10, "0"c)
                        dr(i) = po
                    Else
                        dr(i) = rows(i)
                    End If
                Next

                Dim isValidPo As Boolean = Payments.validatePaymentPO(po)
                If (isValidPo) Then
                    dt.Rows.Add(dr)
                Else
                    invalidPos += po + "</br>"
                End If

            End While
        End Using
        Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

        If (Not invalidPos.Equals("")) Then
            Await Logs.SendMail(FromEmail, email, invalidPos, "", "Wrong pos found in payment detail file for deposit# " + depositNo, "", "", "")

        Else
            Await Logs.SendMail(FromEmail, email, invalidPos, "", "All pos correct for deposit# " + depositNo, "", "", "")

        End If

        Return dt
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetScannedBarCodesbyAWB() As String
        Try
            Dim SelectedManualPo As New ArrayList
            If Not Session("SelectedManualPoHeaders") Is Nothing Then
                SelectedManualPo = Session("SelectedManualPoHeaders")
            End If
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim awb As String = ""
            Dim ResponseXML As String = ""
            If SelectedManualPo.Count > 0 Then
                For Each i In SelectedManualPo
                    Dim u As ManualPOHeader = ManualPOHeaders.GetPOHeaderById(Convert.ToInt32(i.ToString()))
                    awb = Convert.ToString(u.AWB)
                    If (ConfigurationManager.AppSettings("ShipmentServiceURL") <> "" Or ConfigurationManager.AppSettings("ShipmentServiceURL") <> Nothing) Then
                        If (awb <> "" And awb <> "0") Then
                            Dim url As String = ConfigurationManager.AppSettings("ShipmentServiceURL").ToString() + awb
                            Dim httpWebRequest As HttpWebRequest = DirectCast(WebRequest.Create(url), HttpWebRequest)
                            httpWebRequest.Method = "POST"
                            httpWebRequest.ContentType = "application/x-www-form-urlencoded"

                            Dim httpWebResponse As HttpWebResponse = DirectCast(httpWebRequest.GetResponse(), HttpWebResponse)
                            Dim responseStream As Stream = httpWebResponse.GetResponseStream()
                            Dim streamReader As New StreamReader(responseStream)
                            Dim response As String = streamReader.ReadToEnd()
                            ResponseXML = ResponseXML + response.ToString()
                            Dim BarCode As String = ""
                            Dim BarCodeWithSeq As String = ""
                            response = response.Replace(vbLf, "")
                            If (Convert.ToString(response) <> "") Then
                                Dim xdoc As New XmlDocument()
                                xdoc.LoadXml(response)
                                Dim xmlDoc As XDocument = XDocument.Parse(xdoc.OuterXml)
                                Dim BarCodelist = xmlDoc.Descendants("ROW").Descendants("BARCODE").ToList()

                                For Each Row In BarCodelist
                                    If Row IsNot Nothing And Row.Value <> "99999" Then
                                        BarCode += Convert.ToString(Row.Value).Remove(Convert.ToString(Row.Value).Length - 3) + ","
                                        BarCodeWithSeq += Convert.ToString(Row.Value) + ","
                                    End If
                                Next
                                If (BarCode <> "") Then
                                    BarCode = BarCode.Remove(BarCode.Length - 1)
                                    BarCodeWithSeq = BarCodeWithSeq.Remove(BarCodeWithSeq.Length - 1)
                                    Incoming.UpdateScannedMissingBoxesbyAWB(awb, BarCode, u.HeaderID, User.ID, BarCodeWithSeq)
                                End If
                            End If
                        Else
                            Return "Not Shipped"
                        End If
                    Else
                        Return "Not Valid URL"
                    End If
                Next
                Return ResponseXML
            ElseIf SelectedManualPo.Count = 0 Then
                Return "NoSelect"
            Else
                Return ""
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetScannedBarCodesbyAWB::PageIncoming")
            Return "error"
        End Try
    End Function

    Public Class BarcodeDataSummary
        Public Farm As String
        Public BoxCode As String
        Public Barcode As String

        Public Sub New(ByVal Farm As String, ByVal BoxCode As String, ByVal Barcode As String)
            Me.Farm = Farm
            Me.BoxCode = BoxCode
            Me.Barcode = Barcode
        End Sub
    End Class

    <System.Web.Services.WebMethod(True)>
    Public Function ScanningValidationForAWBAndFarm(ByVal AWB As String, ByVal ReceivingDate As String, ByVal CargoDate As String, ByVal FlightDate As String, ByVal TransferFile As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            AWB = Regex.Replace(AWB, "[^0-9a-zA-Z.]+", "")
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()

            Dim Farm As String = ""
            'Added By Belal on 29th Sep 2020 For New API
            Dim webClient As New System.Net.WebClient
            Dim BarCodesStringFromNewAPI = webClient.DownloadString("https://cloud.logiztikalliance.com:5005/logCloudWS/api/ClientesExternosA/ListarCodigosDeBarraPorCliente/251/99bOdf4S1W6ZCaC7d6dR9D6/" & AWB)
            Dim BarCodeJArray As JArray = JArray.Parse(BarCodesStringFromNewAPI)
            Dim barcodeListFromAPI As List(Of String) = New List(Of String)

            Dim barcodeSummary As List(Of BarcodeDataSummary) = New List(Of BarcodeDataSummary)
            Dim vFarm As String, vBoxCode As String, vBarcode As String
            For Each item In BarCodeJArray
                vFarm = ""
                vBoxCode = ""
                barcodeListFromAPI.Add(item.Value(Of String)("barcode"))
                vBarcode = item.Value(Of String)("barcode")
                If Not String.IsNullOrEmpty(vBarcode) Then
                    vFarm = vBarcode.Substring(0, 3)
                    vBoxCode = vBarcode.Substring(3, 5)
                End If
                barcodeSummary.Add(New BarcodeDataSummary(vFarm, vBoxCode, vBarcode))
            Next
            ''2020/10/03, group barcode by farm and box code
            Dim lstGrpByFarmAndBoxCode =
                From d In barcodeSummary.AsEnumerable()
                Group By FarmFld = d.Farm, BoxCodeFld = d.BoxCode
                Into Groupme = Group, Count()
            ''group barcode by farm
            Dim lstGrpByFarm =
                From d In barcodeSummary.AsEnumerable()
                Group By FarmFld = d.Farm
                Into Groupme = Group, Count()
            Dim newHtmlLine = "<br />"
            ''get string of values sparated with comma
            Dim strGrpByFarmAndBoxCode = String.Join(", ", lstGrpByFarmAndBoxCode _
                                        .OrderBy(Function(p) p.FarmFld) _
                                        .Select(Function(i) (i.FarmFld & "," & i.BoxCodeFld & "," & i.Count & newHtmlLine)))

            ''add column names at the top of the string
            strGrpByFarmAndBoxCode = "Farm, Box Code, Count" + newHtmlLine + strGrpByFarmAndBoxCode
            ''remove commas from the beginning of each lines to make string clear
            strGrpByFarmAndBoxCode = strGrpByFarmAndBoxCode.Replace(newHtmlLine & ", ", newHtmlLine)
            ''get string of values sparated with comma
            Dim strGrpByFarm = String.Join(", ", lstGrpByFarm _
                                .OrderBy(Function(p) p.FarmFld) _
                                .Select(Function(i) (i.FarmFld & "," & i.Count & newHtmlLine)))
            ''add column names at the top of the string
            strGrpByFarm = "Farm, Count" & newHtmlLine & strGrpByFarm
            ''remove commas from the beginning of each lines to make string clear
            strGrpByFarm = strGrpByFarm.Replace(newHtmlLine & ", ", newHtmlLine)
            '''''''''
            ''2020/10/06, add total boxes by farm in the email content
            strGrpByFarm = strGrpByFarm & newHtmlLine & "Totals for group: " & lstGrpByFarm.Sum(Function(p) p.Count) & newHtmlLine
            strGrpByFarmAndBoxCode = strGrpByFarmAndBoxCode & newHtmlLine & "Totals for group: " & lstGrpByFarmAndBoxCode.Sum(Function(p) p.Count)
            ''''
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
            Dim strBarcodeListFromAPI = String.Join(",", barcodeListFromAPI) & newHtmlLine & newHtmlLine & strGrpByFarm & newHtmlLine & strGrpByFarmAndBoxCode
            '''''''''
            Dim unused = Logs.SendMail(FromEmail, "jose@dflower.com,ateran@mistyflowers.com", strBarcodeListFromAPI, "", "Barcode List for awb# " & AWB)
            '''''''''
            'Dim BoxesDetailsGandGservice = GAndGService.funGetScannedBoxesToDFlowerByAWB(AWB, "251")
            ''Dim BoxesDetailsGandGservice = GAndGService.funGetScannedBoxesToDFlowerByAWB(AWB, "251")
            'Dim BoxesXmlParse1 As XDocument = XDocument.Parse(BoxesDetailsGandGservice)

            ''filter xml barcode result by farm
            'Dim Barcodes1 = BoxesXmlParse1.Descendants("tblData").Descendants("tblData").Descendants("Barcode").[Select](Function(x) x.Value).ToList()
            'Dim DistinctFarmsInXml1 = BoxesXmlParse1.Descendants("tblData").Descendants("Barcode").GroupBy(Function(x) x.Value.Substring(0, 3)).[Select](Function(x) x.Key()).ToList()

            'Dim Farms As String = ""
            Dim wc As String = ""
            'For Each DistinctFarms In DistinctFarmsInXml1
            '    Farms += IIf(Farms.Length <= 0, "", ",")
            '    Farms += "'" + DistinctFarms + "'"
            'Next

            'whereCondition = "cast(ShippedDate as date)>= '" + FromDate + "' And " + " cast(ShippedDate as date) <= '" + ToDate + "'"
            'If Farms <> "" Then
            ''Email Notification for scanning validation with xml response
            'Try
            '        ''Email Notification for scanning validation with xml response
            '        Dim XMLFileName As String = "SV_" + AWB + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".XML"
            '        Dim VendorEmailPath = ConfigurationManager.AppSettings("VendorEmailsFolder") + "\XML"
            '        If (Not Directory.Exists(VendorEmailPath)) Then
            '            Directory.CreateDirectory(VendorEmailPath)
            '        End If

            '        Dim filepath As String = VendorEmailPath & "\" & XMLFileName
            '        If File.Exists(filepath) Then
            '            File.WriteAllText(filepath, "")
            '            Using writer As New StreamWriter(filepath, True)
            '                writer.WriteLine("<?xml version='1.0' encoding='UTF-8'?>")
            '                writer.WriteLine(BoxesXmlParse1)
            '            End Using

            '        Else
            '            Dim writer As StreamWriter = File.CreateText(filepath)
            '            writer.WriteLine("<?xml version='1.0' encoding='UTF-8'?>")
            '            writer.WriteLine(BoxesXmlParse1)
            '            writer.Close()
            '        End If

            '        Dim BodyContent As String = "Flight Date= " + FlightDate + "###Cargo Date = " + CargoDate + "###Receiving Date = " + ReceivingDate + "###"
            '        'Logs.VendorEmailLogs(User, BodyContent, "XML/" + XMLFileName, (CompanyName + " Scanning Validation Notification for AWB#:  " + AWB + " And User#: " + TransferFile + " And Cargo Date " + FilterDate + "  by user:" + User.Email), "error")

            '    Catch ex As Exception
            '        ErrorLogs.LogException(ex, "Error in Service::ScanningValidationForAWB:Send Email Notification::PageIncoming")
            '    End Try


            'wc = "Farm in (" + Farms + ") "
            'wc += " cast(shipdate as date)= CTOD('" + CargoDate + "')"
            'Dim data = obj.GetPurchaseOrderDetailsByFarmsAndLastFiveDays(wc)
            Dim data = Incoming.GetPurchaseOrdersforLastFiveDays(CargoDate)
            If data.Count > 0 Then
                If data(0).ErrorMessage = "" Then
                    Dim poqDetailsList = New XElement("PODetails",
                            From Details In data
                            Select New XElement("PO", "",
                            New XElement("Farm", Details.Farm),
                            New XElement("Flower", Details.Flower),
                            New XElement("Quantity", Convert.ToInt32(Details.Quantity)),
                            New XElement("UOM", Details.UOM),
                            New XElement("Units", Details.Units),
                            New XElement("TotalUnits", (Convert.ToInt32(Details.Quantity) * Convert.ToInt32(Details.Units))),
                            New XElement("UnitsPerBunch", Details.UnitsPerBunch),
                            New XElement("CostPerUnits", Details.CostPerUnits),
                            New XElement("FlowerName", Details.FlowerName),
                            New XElement("FlowerCategory", Details.FlowerCategory),
                            New XElement("FobConsig", Details.FOB),
                            New XElement("shipdate", ReceivingDate),
                            New XElement("BoxNumber", Details.BoxNum),
                            New XElement("PONumber", Details.PONumber),
                            New XElement("Breakdown", Details.Breakdown),
                            New XElement("Customer", Details.Cust),
                            New XElement("BoxCode", Details.BoxCode),
                            New XElement("InvoiceNumber", Details.Invoice),
                            New XElement("MAWB", Details.AWB),
                            New XElement("HAWB", Details.Hawb),
                            New XElement("SPORDID", Details.SPORDID),
                            New XElement("ORDER2ID", Details.ORDER2ID),
                            New XElement("WH", Details.WH)))
                    Logs.Savelog(User.ID, "Incoming", "ScanningValidationForAWBAndFarm", (CompanyName + Str(data.Count) + " Downloading purchase orders AWB#:  " + AWB + " And User#: " + TransferFile + " And Cargo Date " + CargoDate + "  by user:" + User.Email), 0)

                    'Dim re As String = "[^\x09\x0A\x0D\x20-\xD7FF\xE000-\xFFFD\x10000-x10FFFF]"
                    'Dim poqDetailsList = Regex.Replace(poqDetailsList, re, "")

                    Dim HeaderIDs As String = Incoming.UpdateScanningValidationBoxDetails(User.ID, AWB, poqDetailsList.ToString(), String.Join(",", barcodeListFromAPI.ToArray()), ReceivingDate, wc, "", TransferFile, CargoDate)
                    'objDbfService.UpdatePOQAfterScanningValidation(User.ID, AWB, ReceivingDate)
                    If HeaderIDs <> "" Then
                        TransferIncomingDetailsAfterScanningValidation(HeaderIDs, TransferFile, ReceivingDate)
                    End If
                    ''2020/09/30
                    'Try
                    Logs.Savelog(User.ID, "Incoming", "ScanningValidationForAWBAndFarm", (CompanyName + " Scanning Validation Done for AWB#:  " + AWB + " And User#: " + TransferFile + " And Cargo Date " + CargoDate + "  by user:" + User.Email), 0)
                    'Catch ex As Exception

                    'End Try
                    Return "Success"
                Else
                    'Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    Return Nothing
                End If
            Else
                Incoming.UpdateScanningValidationBoxDetails(User.ID, AWB, "", String.Join(",", barcodeListFromAPI.ToArray()), ReceivingDate, wc, "", TransferFile, CargoDate)
                Return "Success"
            End If
            'Else
            '    Return "No records found"
            'End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ScanningValidationForAWB::PageIncoming")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetAvailableAwbsFromService(ByVal SelectedDate As String) As String
        Try
            'Process:#1

            'Get access token from cargomastersecurityservice 
            'Dim oToken = CargoMasterSecurityService.authenticate("wsMisty", "wsmst423")
            'Access Cargo master service by token generated . Method:getAWBListShipDate
            'Get available awbs list for the date choosen
            'Dim ResponseCargoService = CargoMasterService.getAWBListShipDate("MIS", SelectedDate, oToken)

            'Get only AWB's by process the xml result
            'Dim ResponseCargoServiceXmlParse As XDocument = XDocument.Parse("<root>" + ResponseCargoService.InnerXml.Replace("xmlns=" & Chr(34) & "http://www.tempuri.org/xsdGuiasImportador.xsd" & Chr(34), "") + "</root>")
            'Dim AWBsFromCargoService = ResponseCargoServiceXmlParse.Descendants("root").Descendants("awb_importer").Descendants("awb").[Select](Function(x) x.Value).ToList()


            'Process:#2
            'Access GAndG service
            'Get available awbs list for the date choosen:funGetAWBHeaderInfo
            'Dim ResponseGAndGService = GAndGService.funGetAWBHeaderInfo(SelectedDate, "251")
            ''Get only AWB's by process the xml result
            'Dim ResponseGandGServiceXmlParse As XDocument = XDocument.Parse(ResponseGAndGService)
            'Dim AWBsFromGandGService = ResponseGandGServiceXmlParse.Descendants("box").Descendants("IdAWB").[Select](Function(x) x.Value).ToList()
            'Dim PiecesFromGandGService = ResponseGandGServiceXmlParse.Descendants("box").Descendants("Pieces").[Select](Function(x) x.Value).ToList()


            'Dim result1 = ResponseGandGServiceXmlParse.Descendants("box").FirstOrDefault()

            ''Framing html result from information
            Dim Result As String = ""
            'If AWBsFromCargoService.Count > 0 Or AWBsFromGandGService.Count > 0 Then
            '    Result = "<table style='margin-left:53px;position:absolute;'><tr><td style ='vertical-align:top;padding: 8px;'><table>"
            '    If AWBsFromCargoService.Count > 0 Then
            '        Result += "<tr>" +
            '        "<td  class='AWBListtd' style='background-color: #dedede;text-align:center'>CARGO MASTER</td></tr>"
            '    End If

            '    For Each AWB In AWBsFromCargoService
            '        'Dim PiecesForAWBFromCargoMasterService = CargoMasterService.getAWBInfoImporter(AWB, "MIS", oToken)
            '        'Dim PiecesForAWBFromCargoMasterService = CargoMasterService.GetTotalPiecesAWB(AWB, "MIS", oToken)
            '        'Result += "<tr><td class='AWBListtd'><a href='#' class='aAWBclick' style='outline: 0;'>" + Convert.ToString(AWB) + "</a>  (" + Convert.ToString(PiecesForAWBFromCargoMasterService) + ")</td></tr>"
            '        Result += "<tr><td class='AWBListtd'><a href='#' class='aAWBclick' style='outline: 0;'>" + Convert.ToString(AWB) + "</a>(N/A)</td></tr>"
            '    Next
            '    If AWBsFromGandGService.Count > 0 Then
            '        Result += "</table></td><td style='vertical-align:top;padding: 8px;'><table><tr><td class='AWBListtd' style='background-color: #dedede;text-align:center'>G&G</td></tr>"
            '    Else
            '        Result += "</table>"
            '    End If
            '    For i = 0 To AWBsFromGandGService.Count - 1
            '        Dim Pieces As String = PiecesFromGandGService(i)
            '        Dim AWB As String = Convert.ToString(AWBsFromGandGService(i))
            '        Result += "<tr><td class='AWBListtd'><a href='#'  class='aAWBclick' style='outline: 0;'>" + AWB + "</a> (" + Decimal.Parse(Pieces).ToString("G29") + ")</td></tr>"
            '    Next
            'End If

            Return Result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::GetAvailableAwbsFromService::PageIncoming")
            Return "error"
        End Try
    End Function

    '' <summary>
    '' Transfer Incoming Details After Completing Scanning Validation
    '' </summary>
    '' <param name="UserFile"></param>
    '' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function TransferIncomingDetailsAfterScanningValidation(ByVal HeaderIDs As String, ByVal UserFile As String, ByVal ReceivingDate As String) As String
        Try
            AppendLog("HeaderIDs:" + HeaderIDs, "TransferIncomingDetailsAfterScanningValidation")
            AppendLog("UserFile:" + UserFile, "TransferIncomingDetailsAfterScanningValidation")
            AppendLog(DateTime.Now, "Transfer:Starts")
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim result = ""
            'Dim result = objDbfService.ImportIncomingDetails(UserFile.ToUpper().ToString(), HeaderIDs.TrimEnd(",").ToString(), "1", ReceivingDate, 0, User.UserName)
            ''Dim result = obj.ImportIncomingDetails(UserFile.ToUpper().ToString(), HeaderIDs.TrimEnd(",").ToString(), "1", ReceivingDate, 0)
            If result <> "success" Then
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return "error"
            End If
            AppendLog(DateTime.Now, "Transfer:Ends")
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::TransferIncomingDetailsAfterScanningValidation::PageIncoming")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateIncomingPoBuyerApprovalDetails(ByVal HeaderId As Integer, Credits As Decimal, AmountToPay As Decimal, BuyerApproval As Boolean, DateApproved As String) As String
        Try
            Return Incoming.UpdateIncomingPoBuyerApprovalDetails(HeaderId, Credits, AmountToPay, BuyerApproval, DateApproved)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingPoBuyerApprovalDetails::PageIncoming")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateIncomingPoCreditAmount(ByVal HeaderId As Integer, CreditAmount As Decimal, AmountToPay As Decimal) As String
        Try
            Return Incoming.UpdateIncomingPoCreditAmount(HeaderId, CreditAmount, AmountToPay)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingPoCreditAmount::PageIncoming")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateIncomingPoFarmAmount(ByVal HeaderId As Integer, FarmAmount As Decimal) As String
        Try
            Return Incoming.UpdateIncomingPoFarmAmount(HeaderId, FarmAmount)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingPoFarmAmount::PageIncoming")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateIncomingPoPayment_Details(ByVal HeaderId As Integer, Paid As Boolean, DatePayed As String, PendingPayment As Decimal) As String
        Try
            Return Incoming.UpdateIncomingPoPayment_Details(HeaderId, Paid, DatePayed, PendingPayment)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingPoPayment_Details::PageIncoming")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function UpdateIncomingPoQB_Details(ByVal HeaderId As Integer, QB As Boolean, DateQB As String) As String
        Try
            Return Incoming.UpdateIncomingPoQB_Details(HeaderId, QB, DateQB)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingPoQB_Details::PageIncoming")
            Return "error"
        End Try
    End Function

    <WebMethod>
    Public Function UpdateIncomingPoQBByHeaderIdList(ByVal listquickbookbillIncoming As List(Of QuickBookBillIncoming)) As String
        Try
            ' updated by Hardik on 01-30-2023
            'Dim sessionManager = ConnectionOpen()
            'BuildVendorAddRq(sessionManager, listquickbookbillIncoming.[Select](Function(db) db.FarmName).Distinct().ToList())
            'DoBillAdd(sessionManager, listquickbookbillIncoming)
            'ConnctionClose(sessionManager)
            'DoBillAdd(listquickbookbillIncoming)
            Return Incoming.UpdateIncomingPoQBByHeaderIdList(listquickbookbillIncoming)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingPoQBByHeaderIdList::PageIncoming")
            Return "error"
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function UpdateMeasurementDetails(ByVal AWB As String, ByVal Farm As String, ByVal IncomDate As String, ByVal Headerid As Integer, ByVal Weight As Decimal, ByVal DimensionalWeight As Decimal, ByVal MPF As Decimal, ByVal Duties As Decimal) As String
    '    Try
    '        Return Incoming.UpdateMeasurementDetails(AWB, Farm, IncomDate, Headerid, Weight, DimensionalWeight, MPF, Duties)
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::UpdateMeasurementDetails")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateIncomingDetails(ByVal Details As String) As String
        Try
            Return Incoming.UpdateIncomingDetails(Details)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingDetails::PageIncoming")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAWBNumbersForInComing() As List(Of ManualPOHeader)
        Try
            Return Incoming.GetAWBNumbersForInComing()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAWBNumbersForInComing::PageIncoming")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function TransferIncomingDetails(ByVal SelectedHeaders As String, ByVal UserFile As String, ByVal ReceivingDate As String, ByVal OtherCostPerFBE As String, ByVal Freight As String, ByVal Handling As String, ByVal Warehouse As String, ByVal FBE As String, ByVal TotalBoxes As String, ByVal OtherCharges As String) As String
        Try
            Dim result As String = ""

            'Dim SelectedManualPo As New ArrayList
            'If Not Session("SelectedManualPoHeaders") Is Nothing Then
            '    SelectedManualPo = Session("SelectedManualPoHeaders")
            'End If
            'Dim SelectedHeaders As String = ""

            'If (SelectedManualPo.Count > 0) Then
            '    For Each hd In SelectedManualPo
            '        SelectedHeaders += hd.ToString() + ","
            '    Next
            'Else
            '    Return "NoSelect"
            'End If
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            AppendLog(SelectedHeaders, "TransferIncomingDetails")
            AppendLog(DateTime.Now, "Transfer:Starts")
            result = Incoming.ImportIncomingDetails(UserFile.ToUpper(), SelectedHeaders.TrimEnd(","), ReceivingDate, Freight, Handling, User.ID, Warehouse, FBE, TotalBoxes, OtherCharges)
            If result <> "Success~0" Then
                AppendLog(DateTime.Now, "Transfer:Error: " + result)
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return result
            End If
            AppendLog(DateTime.Now, "Transfer:Ends")
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::TransferIncomingDetails::PageIncoming")
            Return Nothing
        End Try
    End Function
    'Added by Anubhuti 20/12/2022
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateIncomingFarmInvoice(ByVal SelectedHeaders As String, ByVal SelectedInvoice As String, ByVal SelectedStatus As String) As String
        Try
            Dim result As String = ""
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            result = Incoming.UpdateIncomingFarmInvoice(SelectedHeaders, SelectedInvoice, SelectedStatus)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateIncomingFarmInvoice::PageIncoming")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateInvoicesForAllocation() As String
        Try
            SalesOrder.CreateInvoicesForAllocation()
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateInvoicesForAllocation::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateTempSalesOrderAllocationInvoiceDetailsField(ByVal FieldName As String, ByVal FieldValue As String, ByVal FieldKey As String) As String
        Try
            SalesOrder.UpdateTempSalesOrderAllocationInvoiceDetailsField(FieldName, FieldValue, FieldKey)
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateTempSalesOrderAllocationInvoiceDetailsField::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ValidateIncomingDetails(ByVal SelectedHeaders As String, ByVal TotalBoxes As String) As String
        Try
            Return Incoming.ValidateIncomingDetails(SelectedHeaders.TrimEnd(","), TotalBoxes)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ValidateIncomingDetails::PageIncoming")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ValidateInventoryUserDetailsToTransfer(ByVal SelectedHeaders As String) As String
        Try
            Return DAO.InventoryUsersSQL.ValidateInventoryUserDetailsToTransfer(SelectedHeaders.TrimEnd(","))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ValidateInventoryUserDetailsToTransfer::PageIncoming")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetRecordsCountfromuser(ByVal User As String, ByVal ProcessStatus As String) As String
        Try
            Dim records As Decimal = 0
            'records = Convert.ToInt32(obj.GetRecordsCountfromuser(User.ToUpper()))
            If ProcessStatus = "Start" Then
                Dim TotalRecordsCount As Integer = 0
                TotalRecordsCount = records
                Session("TotalRecordsCount") = TotalRecordsCount
            ElseIf ProcessStatus = "Transfer" Then
                Dim SelectedRecordsCount As Integer = 0
                Dim TotalRecordsCount As Integer = 0
                SelectedRecordsCount = Session("SelectedRecordsCount")
                TotalRecordsCount = Session("TotalRecordsCount")
                If TotalRecordsCount <> 0 Then
                    records = Math.Round(((records - TotalRecordsCount) / SelectedRecordsCount) * 100)
                Else
                    records = Math.Round((records / SelectedRecordsCount) * 100)
                End If
            End If
            Return records.ToString()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetRecordsCountfromuser::PageIncoming")
            Return ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function StopTransfer() As String
        objtaskStatus.Start = False
        'objtaskStatus.Status = "completed"
        Return "success"
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DownloadIncommingXML() As String

        Try
            'Dim SelectedManualPo As New ArrayList
            'If Not Session("SelectedManualPoHeaders") Is Nothing Then
            '    SelectedManualPo = Session("SelectedManualPoHeaders")
            'End If
            'Dim SelectedHeaders As String = ""
            'If (SelectedManualPo.Count > 0) Then
            '    For Each hd In SelectedManualPo
            '        SelectedHeaders += hd.ToString() + ","
            '    Next
            'Else
            '    Return "NoSelect"
            'End If

            'Dim PoDetailsByHeaderId As List(Of ManualPODetail) = ManualPODetails.GetManualPODetailsByHeaderIDs(SelectedHeaders.TrimEnd(","))

            'Dim DetailsList = New XElement("Details",
            'From ManualPODetails In PoDetailsByHeaderId
            'Select New XElement("Detail", "",
            'New XElement("Farm", ManualPODetails.Farm),
            'New XElement("Flower", ManualPODetails.Flower),
            'New XElement("Lot", ManualPODetails.AWB),
            'New XElement("DateRec", ManualPODetails.ShipDate),
            'New XElement("Units", ManualPODetails.TotalUnits),
            'New XElement("CSREC", Convert.ToInt32(ManualPODetails.Boxes)),
            'New XElement("UOM", ManualPODetails.UOM),
            'New XElement("BoxNumber", Convert.ToInt32(ManualPODetails.BoxNumber)),
            'New XElement("Cost", ManualPODetails.Cost),
            'New XElement("Name", ManualPODetails.Description),
            'New XElement("ColorCode", ManualPODetails.ColorCode),
            'New XElement("InvenType", ManualPODetails.Type),
            'New XElement("Cust", ManualPODetails.CustNumber),
            'New XElement("PO", ManualPODetails.PO),
            'New XElement("Invoice", ManualPODetails.Invoice),
            'New XElement("Comments", ManualPODetails.Comments)))

            'File.WriteAllText("../temp/Incommingdetails_" + Now.ToString("yyyyMMddHHmmss") + ".xml", DetailsList.ToString())

            Dim filePath As String = "D:\common\Sites\VendorEmails\XML\1000.xml"
            Dim strURL As String = filePath
            Dim req As New WebClient()
            Dim response As HttpResponse = HttpContext.Current.Response
            response.Clear()
            response.ClearContent()
            response.ClearHeaders()
            response.Buffer = True
            response.AddHeader("Content-Disposition", "attachment;filename=""" + strURL + """")
            Dim data As Byte() = req.DownloadData(strURL)
            response.BinaryWrite(data)

            'response.[End]()
            HttpContext.Current.Response.Flush()
            HttpContext.Current.Response.SuppressContent = True
            HttpContext.Current.ApplicationInstance.CompleteRequest()
            Thread.Sleep(100)
            Return ""
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DownloadIncommingXML::PageIncoming")
            Return ex.Message.ToString()
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function VerifyIncomingDetails(ByVal WhereCondition As String, ByVal Query As String, ByVal QueryType As String) As String
        Try

            If QueryType = "AWB" Then
                Query = Regex.Replace(Query, "[-]", "")
            End If

            WhereCondition = HttpUtility.UrlDecode(WhereCondition, System.Text.Encoding.Default)
            If QueryType IsNot Nothing AndAlso Query IsNot Nothing AndAlso Query <> String.Empty Then
                If WhereCondition <> "" Then
                    WhereCondition = WhereCondition + " And  " + BuildWhereCondition(GetType(ManualPOHeader), QueryType, Query)
                Else
                    WhereCondition = BuildWhereCondition(GetType(ManualPOHeader), QueryType, Query)
                End If
            End If


            Dim IncomingHeaderDet As List(Of ManualPOHeader) = ManualPOHeaders.GetAllPOHeader(WhereCondition)

            Dim HeaderIDs = String.Join(",", IncomingHeaderDet.[Select](Function(x) x.HeaderID))

            Dim AWBAndFarm = ""
            For Each HeaderDet In IncomingHeaderDet
                AWBAndFarm += IIf(AWBAndFarm.Length <= 0, "", " OR ")
                AWBAndFarm += "(AWB='" + HeaderDet.AWB + "' AND Farm='" + HeaderDet.FarmCode + "') "
            Next

            'If AWBAndFarm <> "" Then
            '    Dim data = objDbfService.GetPurchaseOrderDetailsByAWBAndFarm(AWBAndFarm)
            '    If data.Length > 0 Then

            '        If data(0).ErrorMessage = "" Then
            '            Dim DetailsList = New XElement("PODetails",
            '        From Details In data
            '        Select New XElement("PO", "",
            '        New XElement("Farm", Details.Farm),
            '        New XElement("Flower", Details.Flower),
            '        New XElement("Quantity", Convert.ToInt32(Details.Quantity)),
            '        New XElement("UOM", Details.UOM),
            '        New XElement("Units", Details.Units),
            '        New XElement("TotalUnits", (Convert.ToInt32(Details.Quantity) * Convert.ToInt32(Details.Units))),
            '        New XElement("UnitsPerBunch", Details.UnitsPerBunch),
            '        New XElement("CostPerUnits", Details.CostPerUnits),
            '        New XElement("FlowerName", Details.FlowerName),
            '        New XElement("FlowerCategory", Details.FlowerCategory),
            '        New XElement("FobConsig", Details.FarmDetails.FOB),
            '        New XElement("shipdate", Details.PODetails.ShipDate),
            '        New XElement("BoxNumber", Details.PODetails.BoxNum),
            '        New XElement("PONumber", Details.PODetails.PONumber),
            '        New XElement("Breakdown", Details.PODetails.Breakdown),
            '        New XElement("Customer", Details.PODetails.Cust),
            '        New XElement("BoxCode", Details.PODetails.BoxCode),
            '        New XElement("InvoiceNumber", Details.PODetails.Invoice),
            '        New XElement("MAWB", Details.PODetails.AWB),
            '        New XElement("HAWB", Details.PODetails.Hawb)))

            '            Dim LoginUserID As Integer = 0
            '            If (Not Session("LoginUserDetails") Is Nothing) Then
            '                Dim LoginUserDetails As User = Session("LoginUserDetails")
            '                LoginUserID = LoginUserDetails.ID
            '            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            '                Dim LoginUserDetails As User = Session("LoginAdminDetails")
            '                LoginUserID = LoginUserDetails.ID
            '            End If
            '            Return Incoming.VerifyIncomingDetails(LoginUserID, DetailsList.ToString(), HeaderIDs, AWBAndFarm)
            '        Else
            '            Dim User As New User
            '            If Not Session("LoginUserDetails") Is Nothing Then
            '                User = Session("LoginUserDetails")
            '            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
            '                User = Session("LoginAdminDetails")
            '            End If
            '            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
            '            Return Nothing
            '        End If
            '    End If
            'End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::VerifyIncomingDetails::PageIncoming")
            Return "error"
        End Try
        Return Nothing
    End Function



#End Region

#Region "Feature"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetFeatureList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Features), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Features.GetFeatureDetails()
            Dim data As List(Of Feature) = obj.GetFeatures(whereCondition, sortExp, start, rp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.FeatureID),
                                        New XElement("cell", "<b><a href='#' id='deleteFeature_" & row.FeatureID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<a href='#' id='editFeature_" & row.FeatureID & "'>" & row.Name & "</a>")))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFeatureList::PageFeature")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFeatureWithValues() As String
        Try
            Dim Featurelist As New List(Of Feature)
            Featurelist = Features.GetFeature()
            Dim Featurecode As String = ""
            'Featurecode = "<tr class='trFeatures trTitle'><td style='font-weight: bold; height: 32px;'>Features</td></tr>"
            'Filter from checbox list 
            Dim list As New List(Of String) From {"Invoice", "PickList", "Labels", "BOL"}
            Dim ModifiedDate As String = ""
            For Each i In Featurelist
                If (i.Name = "Picklist Option") Then
                    Featurecode += "<tr class='trFeatures' id=tr_" + Convert.ToString(i.FeatureID) + "><td style='width:150px;'>" + Convert.ToString(i.Name) + "</td><td>" + getListOptionforPickList(i.FeatureID) + "</td></tr>"
                    ModifiedDate = i.ModifiedDate.ToString("G")
                ElseIf (list.Contains(i.Name)) Then
                    'Featurecode += "<tr class='trFeatures' id=tr_" + Convert.ToString(i.FeatureID) + "><td style='width:150px;'>" + Convert.ToString(i.Name) + "</td><td>" + getPrinterOptions(i.FeatureID, i.Prvalue) + "</td></tr>"
                    'ModifiedDate = i.ModifiedDate.ToString("G")
                ElseIf (i.Name = "Auto Send ArXML") Then
                    Featurecode += "<tr Class='trFeatures' id=tr_" + Convert.ToString(i.FeatureID) + "><td style='width:150px;'>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox' class='chkFeature chkArmellini' id='chkAR_" + Convert.ToString(i.FeatureID) + "' /></td></tr>"
                    Dim ARUserName As String = ""
                    Dim ARPassword As String = ""
                    Dim Ishidden As Boolean = False
                    If i.Options.Contains("*~~~~*") And i.Options <> Nothing Then
                        ARUserName = i.Options.Split("*~~~~*")(0).ToString()
                        ARPassword = i.Options.Split("*~~~~*")(2).ToString()
                    End If

                    Featurecode += "<tr " + IIf(i.Value = False, "style='display:none'", "") + " class='ArmellniFields'><td>AR UserName</td><td><input type='text' style='width: 150px;' id='txtARUsername' value='" + ARUserName + "'></td></tr>" +
                                   "<tr " + IIf(i.Value = False, "style='display:none'", "") + " class='ArmellniFields'><td>AR Password</td><td><input type='text' style='width: 150px;' id='txtARPassword' value='" + ARPassword + "'></td></tr>"
                    ModifiedDate = i.ModifiedDate.ToString("G")
                Else
                    Featurecode += "<tr class='trFeatures' id=tr_" + Convert.ToString(i.FeatureID) + "><td style='width:150px;'>" + Convert.ToString(i.Name) + "</td><td><input type='checkbox' class='chkFeature' id='chk_" + Convert.ToString(i.FeatureID) + "' /></td></tr>"
                    ModifiedDate = i.ModifiedDate.ToString("G")
                End If
            Next
            Featurecode += "<tr><td></td><td><button type ='button' id='btnUpdateFeatures' class='dialogbuttonstyle icon-save' style='cursor: pointer'" +
                          " role='button' aria-disabled='false'><span class='ui-button-text'>Save</span></button></td></tr><tr><td colspan='2'>" +
                          "<label id='lblFeatureModifiedDate'>" + "Last Updated Date:<b style='color:rgb(0, 0, 153)'>" + ModifiedDate + "</b></label></td></tr>"
            Return Featurecode
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::GetFeatureWithValues::PageFeature")
            Return Nothing
        End Try
    End Function

    Public Function getListOptionforPickList(ByVal FeatureID As String) As String
        Dim CString = "<select id='Picklist_" + FeatureID + "'><option value='AWB,GROWER,PRODUCT'>AWB,FarmCode,Flower</option><option value='GROWER,PRODUCT'>FarmCode,Flower</option></select>"
        Return CString
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFeature() As List(Of Feature)
        Try
            Return Features.GetFeature()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFeature::PageFeature")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveFeatureDetails(ByVal Name As String) As String
        Try
            Return Features.SaveFeatureDetails(Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFeatureDetails::PageFeature")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateFeatureDetails(ByVal Name As String, ByVal FeatureID As Integer) As String
        Try
            Return Features.UpdateFeatureDetails(Name, FeatureID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateFeatureDetails::PageFeature")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteFeatureDetails(ByVal FeatureID As Integer) As String
        Try
            Return Features.DeleteFeatureDetails(FeatureID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteFeatureDetails::PageFeature")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFeatureforFeatureID(ByVal FeatureID As Integer) As Feature
        Try
            Return Features.GetFeatureforFeatureID(FeatureID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFeatureforFeatureID::PageFeature")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveFeatureValues(ByVal FeatureDetails As String) As String
        Try
            Return Features.SaveFeatureValues(HttpUtility.UrlDecode(FeatureDetails, System.Text.Encoding.Default))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFeatureValues::PageAdminSettings")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFreightByAirportAndHandlingByWarehouse(ByVal Airport As String, ByVal Warehouse As String) As String
        Try
            Return Incoming.GetFreightByAirportAndHandlingByWarehouse(Airport, Warehouse)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFreightAndHandlingChargesByAirportAndWarehouse::PageIncoming")
            Return "0~0"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetDutyPerUnit(ByVal Flower As String, ByVal Airport As String, ByVal Cost As String) As String
        Try
            Return Incoming.GetDutyPerUnit(Flower, Airport, Cost)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDutyPerUnit::PageIncoming")
            Return "0"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetDutyPerUnitByFarm(ByVal Flower As String, ByVal Farm As String, ByVal Cost As String) As String
        Try
            Return Incoming.GetDutyPerUnitByFarm(Flower, Farm, Cost)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDutyPerUnitByFarm::PageInventoryUser")
            Return "0"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFBE(ByVal Flower As String, ByVal Farm As String, ByVal UOM As String) As String
        Try
            Return Incoming.GetFBE(Flower, Farm, UOM)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFBE::PageIncoming")
            Return "0"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetProductFBEDetails(ByVal Category As String, ByVal Farm As String, ByVal UOM As String) As String
        Try
            Return Incoming.GetProductFBEDetails(Category, Farm, UOM)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetProductFBEDetails::PageOrderSaveProcess")
            Return "0"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetFreightByFarmAndHandlingByWarehouse(ByVal Farm As String, ByVal Warehouse As String) As String
        Try
            Return Incoming.GetFreightByFarmAndHandlingByWarehouse(Farm, Warehouse)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFreightByFarmAndHandlingByWarehouse::PageIncoming")
            Return "0~0"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetTransferFileByUser() As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Return Incoming.GetTransferUserByUserType(User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTransferFileByUser::PageIncoming")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Warehouse"
    <System.Web.Services.WebMethod(True)>
    Public Function GetWarehouseList() As List(Of Warehouse)
        Try
            Return Warehouses.GetWarehouseList()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWarehouseList::PageUser")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetWarehouseListByUser() As List(Of Warehouse)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Return Warehouses.GetWarehouseListByUser(User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWarehouseListByUser::PageUser")
            Return Nothing
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportWarehousefromDBF() As String
    '    Try
    '        Dim ListOfWarehouse = obj.LoadWarehouse()
    '        If ListOfWarehouse.Length > 0 Then
    '            If ListOfWarehouse(0).ErrorMessage = "" Then
    '                Dim WHList = New XElement("WarehouseDetails",
    '                From WH In ListOfWarehouse
    '                Select New XElement("Warehouses", "",
    '                    New XElement("WH", WH.WH),
    '                    New XElement("Name", WH.Name),
    '                    New XElement("Address", WH.Address),
    '                    New XElement("City", WH.City),
    '                    New XElement("Picking", WH.Picking),
    '                    New XElement("Invoice", WH.Invoice),
    '                    New XElement("ShipLabel", WH.ShipLabel),
    '                    New XElement("INVlabel", WH.INVlabel),
    '                    New XElement("Default", WH.WhDefault),
    '                    New XElement("AWB", WH.AWB),
    '                    New XElement("ShippingBI", WH.ShippingBI)))
    '                Return Warehouses.ImportWarehouse(WHList.ToString())
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, ListOfWarehouse(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportWarehousefromDBF::PageWarehouse")
    '        Return Nothing
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetWarehouseForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Warehouse), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Warehouses.GetWarehouseDetails
            Dim data As List(Of Warehouse) = obj.GetWarehouseListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"WH", "Name", "Address", "City"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("WH").ColumnName = "WH"
                dt.Columns("Name").ColumnName = "Name"
                dt.Columns("Address").ColumnName = "Address"
                dt.Columns("City").ColumnName = "City"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "WarehouseDet$Files")
                Return BuildXmlDoc(filepath)
            Else

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.WarehouseID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteWarehouse_" & row.WarehouseID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditWarehouse_" & row.WarehouseID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.WH)),
                                        New XElement("cell", row.Name),
                                        New XElement("cell", Convert.ToString(row.Address)),
                                        New XElement("cell", Convert.ToString(row.City))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWarehouseForFgrd::PageWarehouse")
            Return Nothing
        End Try
    End Function

    '    <System.Web.Services.WebMethod(True)>
    '    Public Function AddWarehouse(ByVal ID As String, ByVal WH As String, ByVal Name As String, ByVal City As String) As String
    '        Try
    '            Dim UserWh As New User
    '            If Not Session("UserDetails") Is Nothing Then
    '                UserWh = Session("UserDetails")
    '            End If

    '            For Each I As Warehouse In UserWh.WarehouseList
    '                If (I.WH = WH) Then
    '                    Return "Warehouse already exist!!"
    '                End If
    '            Next

    '            Dim UWh As New Warehouse
    '            ' UWh.SlNo = UserWh.NextWarehouseListSlno
    '            UWh.WarehouseID = ID
    '            UWh.WH = WH
    '            UWh.Name = Name
    '            UWh.City = City
    '            UserWh.WarehouseList.Add(UWh)
    '            'UserWh.WarehouseList.Sort(Function(x, y) String.Compare(x.WH, y.Name))

    '            Session("UserDetails") = UserWh
    '            Return "Valid"
    '        Catch ex As Exception
    '            ErrorLogs.LogException(ex, "Error in Service::AddWarehouse")
    '            Return "invalid"
    '        End Try
    '    End Function

    '    <System.Web.Services.WebMethod(True)>
    '    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    '    Public Function GetUserWarehouseGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String) As XmlDocument
    '        Try
    '            Dim Data As New User
    '            If Not Session("UserDetails") Is Nothing Then
    '                Data = Session("UserDetails")
    '            End If


    '            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
    '            New XElement("rows", New XElement("page", page.ToString()),
    '            New XElement("total", Data.WarehouseList.Count.ToString()),
    '            Data.WarehouseList.Select(Function(row) New XElement("row", New XAttribute("id", row.WarehouseID),
    '            New XElement("cell", "<a href='#' id='Warehousedelete_" & row.WarehouseID & "'><img src='images/Delete-icon.png'/></a>"),
    '            New XElement("cell", row.WH),
    '            New XElement("cell", row.Name),
    '            New XElement("cell", row.City)))))
    '            Dim newDoc As New XmlDocument()
    '            newDoc.LoadXml(xmlDoc.ToString())
    '            Return newDoc
    '        Catch ex As Exception
    '            ErrorLogs.LogException(ex, "Error in Service::GetUserWarehouseGrid")
    '            Return Nothing
    '        End Try
    '    End Function

    '    <System.Web.Services.WebMethod(True)>
    '    Public Function DeleteUserWarehouse(ByVal WhName As String, ByVal Id As String) As String
    '        Try
    '            'Return Warehouses.DeleteUserWarehouse(WhName, Id)

    '            Dim UserFarm As New User
    '            If Not Session("UserDetails") Is Nothing Then
    '                UserFarm = Session("UserDetails")
    '            End If

    '            For Each wh As Warehouse In UserFarm.WarehouseList
    '                If wh.WarehouseID = Id Then
    '                    UserFarm.WarehouseList.Remove(wh)
    '                    Exit For
    '                End If
    '            Next

    '            Session("UserDetails") = UserFarm

    '            Return "success"

    '        Catch ex As Exception
    '            ErrorLogs.LogException(ex, "Error in Service::DeleteUserWarehouse")
    '            Return Nothing
    '        End Try
    '    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetWarehouseDetailByID(ByVal ID As String) As Warehouse
        Try
            Return Warehouses.GetWarehouseDetailByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWarehouseByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteWarehouseByID(ByVal ID As String) As String
        Try
            Return Warehouses.DeleteWarehousebyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteWarehouseByID")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function SaveWarehouse(ByVal ID As String, ByVal WH As String, ByVal Name As String, ByVal Address As String, ByVal City As String, ByVal Picking As String,
    ByVal Invoice As String, ByVal ShipLabel As String, ByVal INVLabel As String, ByVal Email As String, ByVal Handling As String) As String
        Try
            Dim WarehouseID As String = ""
            If (ID = "0") Then
                WarehouseID = Warehouses.InsertWarehouse(WH, Name, HttpUtility.UrlDecode(Address, System.Text.Encoding.Default), City, HttpUtility.UrlDecode(Picking, System.Text.Encoding.Default), HttpUtility.UrlDecode(Invoice, System.Text.Encoding.Default), HttpUtility.UrlDecode(ShipLabel, System.Text.Encoding.Default), HttpUtility.UrlDecode(INVLabel, System.Text.Encoding.Default), HttpUtility.UrlDecode(Email, System.Text.Encoding.Default), HttpUtility.UrlDecode(Handling, System.Text.Encoding.Default))
            Else
                WarehouseID = Warehouses.UpdateWarehouse(Convert.ToInt32(ID), WH, Name, HttpUtility.UrlDecode(Address, System.Text.Encoding.Default), City, HttpUtility.UrlDecode(Picking, System.Text.Encoding.Default), HttpUtility.UrlDecode(Invoice, System.Text.Encoding.Default), HttpUtility.UrlDecode(ShipLabel, System.Text.Encoding.Default), HttpUtility.UrlDecode(INVLabel, System.Text.Encoding.Default), HttpUtility.UrlDecode(Email, System.Text.Encoding.Default), HttpUtility.UrlDecode(Handling, System.Text.Encoding.Default))
            End If
            If (Not WarehouseID.Contains("UNIQUE KEY constraint")) Then
                Return WarehouseID
            Else
                'User.ErrorMessage = FarmID
                Return WarehouseID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveWarehouse::PageWarehouse")
            Return Nothing
        End Try
    End Function

#Region "WareHouse Handling"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetWHHandlingForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal WarehouseId As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(WarehouseHandling), qtype, query)
            End If
            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1
            If (page <= 0) Then
                rp = 0
                start = 0
            End If
            If whereCondition <> "" Then
                whereCondition = " where " + whereCondition
            End If
            If whereCondition = "" And WarehouseId <> "" Then
                whereCondition = " CAST(Warehouse as int) = CAST(" + WarehouseId + " as int) "
            End If
            Dim obj As New Warehouses.WarehouseHandlings
            Dim WHHandlingList = Nothing
            WHHandlingList = obj.GetWHHandlingForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                If WHHandlingList Is Nothing Then
                    Return Nothing
                End If
                If (TryCast(WHHandlingList, Tuple(Of DataSet, String)).Item1.Tables(1).Rows(0)(0) <= 0) Then
                    Return Nothing
                End If
                If Convert.ToString(TryCast(WHHandlingList, Tuple(Of DataSet, String)).Item2) = "success" Then
                    Dim selectedColumns As String() = {"WH", "Name", "UOM", "Description", "Handling"}
                    Dim dt As DataTable = New DataView(TryCast(WHHandlingList, Tuple(Of DataSet, String)).Item1.Tables(0)).ToTable(False, selectedColumns)
                    dt.Columns("WH").ColumnName = "WH Code"
                    dt.Columns("Name").ColumnName = "WH Name"
                    Dim filepath = ExporttoExcel(dt, splitExportcsv(1) + "Header")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, WHHandlingList(0).ErrorMessage, "", "Error Notification", "Error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please contact site administrator.")
                End If
            Else
                Dim dtWHHandlingList As New DataSet
                If Not TryCast(WHHandlingList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                    dtWHHandlingList = TryCast(WHHandlingList, Tuple(Of DataSet, String)).Item1 'ConvertToDataTable(PricingList)
                Else
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", page.ToString()),
                                       New XElement("total", dtWHHandlingList.Tables(1).Rows(0)(0)),
                                         From row In dtWHHandlingList.Tables(0).Rows()
                                         Select
                                        New XElement("row", New XAttribute("id", row("WHHandlingChargeId")),
                                             New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteWHHandling_" & row("WHHandlingChargeId") & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditWHHandling_" & row("WHHandlingChargeId") & "'/>"),
                                       New XElement("cell", row("WH")),
                                       New XElement("cell", row("Name")),
                                       New XElement("cell", row("UOM")),
                                       New XElement("cell", row("Description")),
                                       New XElement("cell", row("Handling")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWHHandlingForFgrd::PageWarehouse")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function SaveWarehouseHandling(ByVal Id As String, ByVal WarehouseId As String, ByVal UOM As String, ByVal Desc As String, ByVal Handling As String) As String
        Try
            Dim WarehouseHandlingID As String = ""
            WarehouseHandlingID = Warehouses.WarehouseHandlings.InsertUpdateWarehouseHandling(Convert.ToInt32(Id), WarehouseId, UOM, Desc, HttpUtility.UrlDecode(Handling, System.Text.Encoding.Default), If(Id = "0", True, False))
            If (Not WarehouseHandlingID.Contains("UOM EXIST ALREADY")) Then
                Return WarehouseHandlingID
            Else
                Return WarehouseHandlingID
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveWarehouseHandling::PageWarehouse")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetUOMForWHHandling(ByVal FarmCode As String) As Object
        Try
            Return DAOProd.GetUOMForWHHandling(FarmCode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUOMForWHHandling::PageWarehouse")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetWHHandlingDetailByID(ByVal ID As String) As WarehouseHandling
        Try
            Return Warehouses.WarehouseHandlings.GetWHHandlingDetailByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWHHandlingDetailByID")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteWHHandlingByID(ByVal ID As String) As String
        Try
            Return Warehouses.WarehouseHandlings.DeleteWHHandlingByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteWHHandlingByID")
            Return Nothing
        End Try
    End Function
#End Region
#End Region

#Region "SalesOrder"

    <System.Web.Services.WebMethod(True)>
    Public Function SaveOrder1ShiptoDetails(ByVal ID As String, ByVal Shipto As String, ByVal ShiptoName As String, ByVal Address1 As String, ByVal Address2 As String, ByVal City As String, ByVal State As String, ByVal Zip As String, ByVal Country As String, ByVal Phone As String, ByVal Fax As String, ByVal Contact As String) As String
        Try
            Dim result As String = ""
            result = SalesOrder.UpdateShiptoDetails(ID, Shipto, ShiptoName, Address1, Address2, City, State, Zip, Country, Phone, Fax, Contact)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveOrder1ShiptoDetails::PageShipto")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateOrderDetailRepeat(Invoice As String, StartDate As String, NoTimesToRepeat As Integer) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Return SalesOrder.UpdateOrderDetailRepeat(Invoice, StartDate, NoTimesToRepeat, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateOrderDetailRepeat::SaleOrder")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateInvoiceDetailRepeat(Invoice As String, StartDate As String, NoTimesToRepeat As Integer) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Return SalesOrder.UpdateInvoiceDetailRepeat(Invoice, StartDate, NoTimesToRepeat, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateOrderDetailRepeat::SaleOrder")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateDimensionByOrderNo(SQLID As String, L As String, W As String, H As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Return SalesOrder.UpdateDimensionByOrderNo(SQLID, L, W, H)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateDimensionByOrderNo::SaleOrder")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateAWBByOrderNo(OrderNo As String, AWB As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Return SalesOrder.UpdateAWBByOrderNo(OrderNo, AWB)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAWBByOrderNo::SaleOrder")
            Throw ex
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetUpcFromPricesByFlower(ByVal Customer As String, ByVal FlowerCode As String) As BO.SalesDetail
        Try
            Return SalesOrder.GetUpcFromPricesByFlower(Customer, FlowerCode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUpcFromPricesByFlower")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCurrentOrderForCustomer(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, Customer As String, ByVal IsDropScreen As String, ByVal IsConsolScreen As String, ByVal OrderNo As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If



            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim Filter As String = ""
            If IsDropScreen Then
                'Filter += " Customer =" + Customer + " And orderdate >= cast(GetDate() as date) and Printed=0 And List=0 And [Order]<>'" + OrderNo + "' And Hold<>'Y' and PO=case when (select PO from F_ORDER1 where [ORDER]='" + OrderNo + "')='' then po else (select PO from F_ORDER1 where [ORDER]='" + OrderNo + "') end" // commented by Belal 18 Aug 2020
                'Filter += " Customer =" + Customer + " And Printed=0 And List=0 And [Order]<>'" + OrderNo.ToString() + "' And Hold<>'Y' and PO=case when (select PO from F_ORDER1 where [ORDER]='" + OrderNo + "')='' then po else (select PO from F_ORDER1 where [ORDER]='" + OrderNo + "') end"  '// Removed the order condition

                Filter += " Customer =" + Customer + " And Printed=0 And List=0 And [Order]<>'" + OrderNo.ToString() + "' And Hold<>'Y'"  '// Removed the order condition

                'ElseIf IsConsolScreen Then 'For consolidation Filter with same shipdate,shipto,carrier and PO.
                '    Dim orderData = Nothing

                '    orderData = SalesOrder.GetSalesHeaderForCurrentOrderFromSQL("[Order]=" + OrderNo.ToString())
                '    'TotalRowCount = data.count

                '    'Filter += " Customer =" + Customer + " And orderdate = cast('" + Convert.ToDateTime(orderData(0).ORDERDATE, New System.Globalization.CultureInfo("en-US", True)).ToString("MM/dd/yyyy") + "' as date) and Printed=0 And List=0 And [Order]<>'" + OrderNo + "' and Shipto='" + orderData(0).SHIPTO + "' and Carrier ='" + orderData(0).CARRIER + "' and PO='" + orderData(0).PO + "' And Hold<>'Y'"
                '    Filter += " Customer =" + Customer + " And orderdate = cast('" + Convert.ToDateTime(orderData(0).ORDERDATE, New System.Globalization.CultureInfo("en-US", True)).ToString("MM/dd/yyyy") + "' as date) and Printed=0 And List=0 And [Order]<>'" + OrderNo + "' and Shipto='" + orderData(0).SHIPTO + "' and Carrier ='" + orderData(0).CARRIER + "' And Hold<>'Y'"
            Else
                Filter += "Customer=" + Customer
            End If


            Dim data = Nothing

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim TotalRowCount As Integer = 0
                'Modified by Anubhuti 2023_08_30
                data = SalesOrder.GetSalesHeaderForCurrentOrderFromSQL(Customer, OrderNo)
                TotalRowCount = data.count


                Dim dt1 As DataTable = ConvertToDataTable(data)

                If TotalRowCount > 0 Then
                    If dt1(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                        Dim selectedColumns As String() =
                            {"Order", "OrderDate", "Day", "Carrier", "WH", "Printed", "List", "Bills", "ShiptoName", "PO", "cInvenType", "Boxes", "FBE", "InvAmount", "GPM", "ScannedBox"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("Order").ColumnName = "INV#"
                        dt.Columns("OrderDate").ColumnName = "Date"
                        dt.Columns("List").ColumnName = "Scan"
                        dt.Columns("PO").ColumnName = "PO#"
                        dt.Columns("cInvenType").ColumnName = " "
                        dt.Columns("InvAmount").ColumnName = "$Inv.Amount"
                        dt.Columns("Boxes").ColumnName = "Pcs"
                        dt.Columns("GPM").ColumnName = "%GPM"
                        dt.Columns("ScannedBox").ColumnName = "Missing"

                        dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        dtCloned.Columns("Date").DataType = GetType(String)

                        dtCloned.Columns("Printed").DataType = GetType(String)
                        dtCloned.Columns("Scan").DataType = GetType(String)
                        dtCloned.Columns("Bills").DataType = GetType(String)
                        dtCloned.Columns("%GPM").DataType = GetType(String)
                        dtCloned.Columns("$Inv.Amount").DataType = GetType(String)
                        dtCloned.Columns("FBE").DataType = GetType(String)
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        For Each row As DataRow In dtCloned.Rows
                            For Each column As DataColumn In dtCloned.Columns
                                If (column.ToString = "Day") Then
                                    If row.Item("Day").ToString().ToLower() <> "today" Then
                                        row.SetField(column, row.Item("Day").ToString.Substring(0, 3))
                                    End If
                                ElseIf (column.ToString() = "%GPM") Then
                                    row.SetField(column, Convert.ToDecimal(row.Item("%GPM")).ToString("#,##0.0") + "%")
                                ElseIf (column.ToString() = "$Inv.Amount") Then
                                    row.SetField(column, "$" + Convert.ToDecimal(row.Item("$Inv.Amount")).ToString("#,##0.00"))
                                ElseIf (column.ToString() = "FBE") Then
                                    row.SetField(column, Convert.ToDecimal(row.Item("FBE")).ToString("#,##0.000"))
                                ElseIf (column.ToString() = "Date") Then
                                    row.SetField(column, Convert.ToDateTime(row.Item("Date")).ToString("MM/dd/yyyy"))
                                ElseIf (column.ToString = "Confirmed") Then
                                    row.SetField(column, IIf(row.Item("Confirmed").ToString = "False", "", "Yes"))
                                ElseIf (column.ToString = "Printed") Then
                                    row.SetField(column, IIf(row.Item("Printed").ToString = "False", "", "Yes"))
                                ElseIf (column.ToString = "Scan") Then
                                    row.SetField(column, IIf(row.Item("Scan").ToString = "False", "", "Yes"))
                                ElseIf (column.ToString = "Bills") Then
                                    row.SetField(column, IIf(row.Item("Bills").ToString = "False", "", "Yes"))
                                End If
                            Next
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)
                    Else
                        'Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else
                Dim TotalRowCount As Integer = 0
                data = SalesOrder.GetSalesHeaderForCurrentOrderFromSQL(Customer, OrderNo)
                TotalRowCount = data.count


                Dim dt As DataTable = ConvertToDataTable(data)
                'dt.DefaultView.Sort = "RowNo asc"
                'dt = dt.DefaultView.ToTable
                'If dt.Rows.Count > 0 Then
                '    If dt.Rows.Count > 0 Then
                '        TotalRowCount = dt(TotalRowCount - 1)("TotalRows").ToString()
                '    End If
                'End If


                If TotalRowCount > 0 Then

                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                        Dim SelectedPOs As New ArrayList

                        Dim xmldoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", TotalRowCount),
                                     From row In dt.Rows()
                                     Select
                        New XElement("row", New XAttribute("id", row.item("order")), New XAttribute("background-color", ""), New XAttribute("color", ""),
                        New XElement("cell", String.Format("<img style='cursor:pointer;margin-top:-3px' id='orderselectincurrentorders_" & row.item("order").ToString() & "' src='" & IIf(row.item("orderselected"), "images/check-on.png", "images/check-off.png") & "' />")),
                        New XElement("cell", If(IsDropScreen Or IsConsolScreen, "<a href='#' style='color:black'>" + row.item("order").ToString() + "</a>", If(User.UserType.ToLower() = "warehouse", row.item("order").ToString(), "<a id=EditOrderInCurrentOrders_" + row.item("order").ToString() + " style='text-decoration:underline;cursor:pointer;margin-left:-4px;'>" + row.item("order").ToString() + "</a>"))),
                        New XElement("cell", If(User.UserType.ToLower() = "warehouse", row.item("customer").ToString(), "<a id='acustomerincurrentorders_" + row.item("customer").ToString() + "," + Convert.ToDateTime(row.item("orderdate")).AddMonths(-12).ToString("MM/dd/yyyy") + "' style='text-decoration:underline;cursor:pointer;'>" + row.item("customer").ToString() + "</a>")),
                        New XElement("cell", IIf(User.Name.ToLower() = "demo", "xxxxxxxxxxxxxxxxxxxxxxxx", "<a title='" + If(IsDBNull(row.item("customername")), "", row.item("customername").replace("'", "")) + "'>" + row.item("customername") + "</a>")),
                        New XElement("cell", If(IsDropScreen Or IsConsolScreen, Convert.ToDateTime(row.item("orderdate")).ToString("MM/dd/yyyy"), "<a id='aOrderDateCustomer_" + row.item("order").ToString() + "' style='text-decoration:underline;cursor:pointer;'>" + Convert.ToDateTime(row.item("orderdate")).ToString("MM/dd/yyyy") + "</a>")),
                        New XElement("cell", IIf(Convert.ToString(row.item("day")).ToLower() = "today" Or row.item("day") = String.Empty Or row.item("day") = "", row.item("day"), If(row.item("day").length > 3, row.item("day").substring(0, 3), ""))),
                        New XElement("cell", CheckArmelliniLog(row.item("carrier"), row.item("order"), "", True, "", row("orderdate"))),
                        New XElement("cell", row.item("wh")),
                        New XElement("cell", IIf(row.item("printed"), "<img style='margin-top:-3px; margin-left:3px' src='images/greentick.png'>", "")),
                        New XElement("cell", IIf(row.item("list"), "<img style='margin-top:-3px; margin-left:3px' src='images/yellowtick.png'>", "")),
                        New XElement("cell", IIf(row.item("bills"), "<img style='margin-top:-3px; margin-left:3px' src='images/pinktick.png'>", "")),
                        New XElement("cell", IIf(row.item("scanned") And row.item("shipped"), "<img id='imgscannedcustomer_" + row.item("order").ToString() + "' style='margin-top:-3px; margin-left:3px;cursor:pointer;border-bottom:2px solid #1016ab' src='images/bluetick.png'>", IIf(row.item("scanned") And Not row.item("shipped"), "<img id='imgscannedcustomer_" + row.item("order").ToString() + "' style='margin-top:-3px; margin-left:3px;cursor:pointer;border-bottom:2px solid #ac5b6a' src='images/redtick.png'>", ""))),
                        New XElement("cell", "<a title='" + ReplaceSingleQutoesInString(row.item("ShiptoName")) + "<br/>" + ReplaceSingleQutoesInString(row.item("shiptoaddress1")) + "<br/>" + ReplaceSingleQutoesInString(row.item("shiptoaddress2")) + "<br/>" + ReplaceSingleQutoesInString(row.item("shiptocity")) + "," + ReplaceSingleQutoesInString(row.item("shiptostate")) + "<br/>" + ReplaceSingleQutoesInString(row.item("shiptozip")) + "'>" + ReplaceSingleQutoesInString(row.item("ShiptoName")) + "</a>"),
                        New XElement("cell", row.item("po").ToString),
                        New XElement("cell", GetGridColumnValue(row, 3, page)),
                        New XElement("cell", "<a id='aOrderBoxes_" + row.item("order").ToString() + "' style='cursor:pointer;'>" + row.item("boxes").ToString + "</a>"),
                        New XElement("cell", Convert.ToDecimal(row.item("fbe")).ToString("#,##0.00")),
                        New XElement("cell", Convert.ToDecimal(row.item("Cubes")).ToString("#,##0.00")),
                        New XElement("cell", "$ " + Convert.ToDecimal(row.item("invamount")).ToString("#,##0.00")),
                        New XElement("cell", Convert.ToDecimal(row.item("gpm")).ToString("#,##0.0") + "%"),
                        New XElement("cell", row.item("scannedbox").ToString()),
                        New XElement("cell", IIf(row.item("HOLD") = True, "Y", "N")),
                        New XElement("cell", row.item("SLSMAN").ToString()))))
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmldoc))
                        Dim idx As Integer = TotalRowCount - 1

                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = "Totals"
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""


                        Return newDoc
                    Else
                        ' Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCurrentOrderForCustomer::PageOrder")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderHeaderListNew(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String, ByVal FilterDivision As String) As XmlDocument
        Try
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return Nothing
            End If

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If


            Dim data = Nothing

            If (FilterDivision = "notscanned") Then
                Dim dtDBF As DataTable
                Dim dtSQL As New DataTable
                dtDBF = Nothing

                Dim TotalRowCount As Integer = 0
                Dim HistoryrecordsOnly As String = "0"

                Dim FilterCond = FrameFilterForSalesOrderHeaderSQL(Filter, True)
                Dim whereCondition As String = ""
                If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                    whereCondition = BuildWhereCondition(GetType(BO.SalesHeader), qtype, query.Replace("'", "''"))
                    If (FilterCond <> String.Empty And whereCondition <> String.Empty) Then
                        whereCondition = whereCondition + " And " + FilterCond.Replace("&amp;", "&")
                    ElseIf (FilterCond Is String.Empty And whereCondition <> String.Empty) Then
                        whereCondition = whereCondition
                    End If
                Else
                    If (FilterCond <> String.Empty And whereCondition Is String.Empty) Then
                        whereCondition = FilterCond.Replace("&amp;", "&")
                    ElseIf (FilterCond <> String.Empty And whereCondition IsNot String.Empty) Then
                        whereCondition = whereCondition + " AND " + FilterCond.Replace("&amp;", "&")
                    End If
                End If

                'Commented By Prashant On 05/24/2020 for Not implemented the column in vet1 
                If User.Division <> "" And User.Division <> "0" Then
                    whereCondition += " AND DIVISION IN (" + User.Division + ")"
                End If

                Dim canOnlySeeOwnSales As Boolean = IIf(User.ORDER.ToString().Substring(24, 1).ToString() = "Y", True, False)
                If (Session("ShowAllSalesPersonSales") IsNot Nothing And Session("ShowAllSalesPersonSales") = False) Then
                    canOnlySeeOwnSales = True
                End If

                If (canOnlySeeOwnSales) Then
                    whereCondition += " AND SLSMAN = " + User.SalesPerson + " "
                End If

                Dim sortExp As String = sortname & " " & sortorder
                'Dim start As Integer = ((page - 1) * rp) + 1
                Dim start As Integer = 1

                rp -= 1

                If (page <= 0) Then
                    rp = 0
                    start = 0
                End If
                Dim objSales As New SalesOrder.GetSalesOrderHeader

                data = objSales.GetSalesOrderHeaderListNotScanned(whereCondition, sortExp, start, rp, FilterDivision, HistoryrecordsOnly, "")
                TotalRowCount = data.count
                dtSQL = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                   {"Order", "BGColor", "FontColor", "OrderSelected", "Customer", "AWB", "OrderDate", "CustomerName", "Day", "Carrier", "State",
                   "Country", "WH", If(dtSQL.Columns.Contains("HOLD"), "HOLD", "Confirmed"), "Terms", "IsClosedOrder", "Printed", "List", "Bills", "Scanned", "SHIPPED", "Shipto",
                   "ShiptoAddress1", "ShiptoAddress2", "ShiptoCity", "ShiptoState", "ShiptoZip", "PO", "cInvenType", "Weight", "Cubes", "Boxes", "FBE", "InvAmount", "GPM",
                   "ScannedBox", "SalesManEmail", "SalesManName", "FOBAmount", "INVCOST", "ErrorMessage", "TotalRows", "VOID", "SLSMAN", "ORDERUPDATEFLAG", "CONFIRMED", "PODFILE",
                   "Emailed", "XMLStatus", "Consignee", "HasPickListMessage"}

                Dim dt As New DataTable
                dt = New DataView(dtSQL).ToTable(False, selectedColumns)
                Dim icclose As String = "<img style='margin-top:-3px; margin-left:3px;height: 13px;' src='images/icon_close.png'>"

                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        If TotalRowCount > 0 Then
                            TotalRowCount = dt.Rows.Count() - 1
                        End If

                        Dim daysOfService = ArmelliniService.GetDayOfService()


                        Dim SelectedPOs As New ArrayList
                        Dim xmldoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", TotalRowCount),
                            From row In dt.Rows()
                            Select
                            New XElement("row", New XAttribute("id", row.item("Order")), New XAttribute("background-color", IIf(row.item("BGColor") = "", "", row.item("BGColor"))), New XAttribute("color", IIf(row.item("FontColor") = "", "", row.item("FontColor"))),
                            New XElement("cell", GetGridColumnValue(row, 1, page)),
                            New XElement("cell", If(User.UserType.ToLower() = "warehouse", row.item("Order").ToString(), "<a id=EditOrder_" + row.item("Order").ToString() + " style='text-decoration:underline;cursor:pointer;margin-left:-4px;' data-void='" + row.item("VOID").ToString() + "'>" + row.item("Order").ToString() + "</a>")),
                            New XElement("cell", If(User.UserType.ToLower() = "warehouse", row.item("Customer").ToString(), "<a id='aCustomer_" + row.item("Customer").ToString() + "," + Convert.ToDateTime(row.item("OrderDate")).AddMonths(-12).ToString("MM/dd/yyyy") + "' style='text-decoration:underline;cursor:pointer;'>" + row.item("Customer").ToString() + "</a>")),
                            New XElement("cell", IIf(User.Name.ToLower() = "demo", "XXXXXXXXXXXXXXXXXXXXXXXX", "<a title='" + row.item("CustomerName").Replace("'", "") + "'>" + row.item("CustomerName") + "</a>")),
                            New XElement("cell", "<a class='OrderCalculation' id='aAWB_" + row.item("Order").ToString() + "'>" + row.item("AWB").ToString() + "<a>"),
                            New XElement("cell", OrderUpdateFlag(Convert.ToBoolean(row.item("ORDERUPDATEFLAG")), row.item("Order").ToString(), row.item("OrderDate").ToString())),
                            New XElement("cell", SalesOrderDayColumnFormat(row.item("Day"), row.item("HasPickListMessage"), row.item("Order").ToString())),
                            New XElement("cell", CheckArmelliniLog(row.item("Carrier"), row.item("Order"), row.item("XMLStatus"), IsShipDateValid(row.item("consignee"), row.item("OrderDate"), daysOfService), row.item("consignee"), row.item("OrderDate"))),
                            New XElement("cell", IIf(String.IsNullOrEmpty(row.item("Shiptostate")), row.item("State"), row.item("Shiptostate"))),
                            New XElement("cell", row.item("Country")),
                            New XElement("cell", row.item("WH")),
                            New XElement("cell", IIf(row.item("Confirmed") = True, "<p style='display:none'>1</p><img id='Confirmed_" + row.item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px' src='images/greentick.png'>", "<p style='display:none'>0</p>")),
                            New XElement("cell", IIf(row.item("Confirmed") = False And Convert.ToString(row.item("Terms")) = "*COD*", "<span class='spanTerms_" + row.item("order").ToString() + "' style='background: Red;color: white;padding: 6px 11px;margin-left: -11px;'><a style='color:white;' id='acTemrs_" + row.item("Order").ToString() + "'>" + Convert.ToString(row.item("Terms")) + "<a></span>", Convert.ToString(row.item("Terms")))),
                            New XElement("cell", IIf(Convert.ToString(row("IsClosedOrder")).ToLower() <> "true", IIf(row.item("Printed"), "<p style='display:none'>1</p><img id='Printed_" + row.item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px' src='images/greentick.png'>", "<p style='display:none'>0</p>"), icclose)),
                            New XElement("cell", IIf(Convert.ToString(row("IsClosedOrder")).ToLower() <> "true", IIf(row.item("List"), "<p style='display:none'>1</p><img id='list_" + row.item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px' src='images/yellowtick.png'>", "<p style='display:none'>0</p>"), icclose)),
                            New XElement("cell", SalesOrderBillsColumnFormat(row)),
                            New XElement("cell", IIf(row.item("Scanned") And row.item("SHIPPED"),
                            "<p style='display:none'>1</p><img id='imgScanned_" + row.item("Order").ToString() + "' style='margin-top:-3px; margin-left:3px;cursor:pointer;border-bottom:2px solid #1016AB' src='images/bluetick.png'>",
                            IIf(row.item("Scanned") And Not row.item("SHIPPED"), "<img id='imgScanned_" + row.item("Order").ToString() + "' style='margin-top:-3px; margin-left:3px;cursor:pointer;border-bottom:2px solid #AC5B6A' src='images/redtick.png'>", "<p style='display:none'>0</p>"))),
                            New XElement("cell", GetGridColumnValue(row, 4, page)),
                            New XElement("cell", row.item("PO").ToString),
                            New XElement("cell", GetGridColumnValue(row, 3, page)),
                            New XElement("cell", row.item("Weight")),
                            New XElement("cell", row.item("Cubes")),
                            New XElement("cell", GetGridColumnValue(row, 2, page)),
                            New XElement("cell", "<a class='OrderCalculation' id='aOrderFBE_" + row.item("Order").ToString() + "'>" + Convert.ToDecimal(row.item("FBE")).ToString("#,##0.00") + "<a>"),
                            New XElement("cell", "$ " + Convert.ToDecimal(row.item("InvAmount")).ToString("#,##0.00")),
                            New XElement("cell", Convert.ToDecimal(row.item("GPM")).ToString("#,##0.0") + "%"),
                            New XElement("cell", "<a id='aOrderMissingBoxes_" + row.item("Order").ToString() + "'>" + row.item("ScannedBox").ToString() + "<a>"),
                            New XElement("cell", String.Format("<a id='lblPrintLadingBill_" + row.item("Order").ToString() + "' title='Bill of Lading'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>")),
                            New XElement("cell", String.Format("<a id='lblPrintPickList_" + row.item("Order").ToString() + "' title='Print Pick List'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>")),
                            New XElement("cell", "<a style='cursor: pointer;' data-Email='" + row.item("SalesManEmail") + "' id='aSLSMAN_" + row.item("Order").ToString + "'>" + row.item("SalesManName") + "</a>"),
                            New XElement("cell", Convert.ToDecimal(row.item("FobAmount"))),
                            New XElement("cell", Convert.ToDecimal(row.item("InvCost"))),
                            New XElement("cell", "<a id='IsClosedOrder_" + Convert.ToString(row("Order")) + "'>" + Convert.ToString(row("IsClosedOrder")) + "</a>"),
                            New XElement("cell", Convert.ToInt32(row.item("SLSMAN"))),
                            New XElement("cell", IIf(Convert.ToString(row("PODFILE")) = "", "No POD", "<a onclick='openPDFViewer(""" + Convert.ToString(row("PODFILE")) + """)'><img style='cursor: pointer; height: 15px;' src='images/greenhold.png'></a>")),
                            New XElement("cell", IIf(Convert.ToString(row("Emailed")) = "e", "<img style='Cursor:pointer;margin-top:-3px' id='EmailedPoSelect_" & row("Order").ToString() & "' src='images/check-on.png' />", IIf(Convert.ToString(row("Emailed")) = "x", "<img style='Cursor:pointer;margin-top:-3px' id='EmailedPoSelect_" & row("Order").ToString() & "' src='images/Filter.png' />", ""))))))

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmldoc))
                        Dim idx As Integer = TotalRowCount

                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = "Totals"
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(26).InnerText = ""
                        ' newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(27).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(33).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(34).InnerText = ""
                        Return newDoc
                    Else
                        ' Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt(TotalRowCount - 1)("ErrorMessage").ToString(), "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If

            Else
                FilterDivision = ""

                If (ExportCSV <> "") Then
                    Dim splitExportcsv = ExportCSV.Split("|")

                    Dim TotalRowCount As Integer = 0
                    Dim HistoryrecordsOnly As String = "0"

                    Dim FilterCond = FrameFilterForSalesOrderHeaderSQL(Filter)
                    Dim whereCondition As String = ""
                    Dim qsearchFilters As String = ""
                    If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                        qsearchFilters = BuildWhereCondition(GetType(BO.SalesHeader), qtype, query.Replace("'", "''"))
                        whereCondition = FilterCond.Replace("&amp;", "&")
                    Else
                        If (FilterCond <> String.Empty And whereCondition Is String.Empty) Then
                            whereCondition = FilterCond.Replace("&amp;", "&")
                        ElseIf (FilterCond <> String.Empty And whereCondition IsNot String.Empty) Then
                            whereCondition = whereCondition + " AND " + FilterCond.Replace("&amp;", "&")
                        End If
                    End If

                    Dim sortExp As String = sortname & " " & sortorder
                    Dim start As Integer = ((page - 1) * rp) + 1
                    rp -= 1

                    If (page <= 0) Then
                        rp = 0
                        start = 0
                    End If
                    Dim objSales As New SalesOrder.GetSalesOrderHeader

                    data = objSales.GetSalesOrderHeaderList(whereCondition, sortExp, start, rp, FilterDivision, HistoryrecordsOnly, qsearchFilters)
                    TotalRowCount = data.count
                    'dtSQL = ConvertToDataTable(data)

                    Dim dt1 As DataTable = ConvertToDataTable(data)

                    If TotalRowCount > 0 Then
                        If dt1(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                            'Dim selectedColumns As String() = {"Order", "OrderDate", "Day", "CustomerName", "Carrier", "WH", "Printed", "List", "Bills", "Shipto", "PO", "cInvenType", "Boxes", "FBE", "InvAmount", "GPM", "ScannedBox"}
                            Dim selectedColumns As String() = {"Order", "OrderDate", "Day", "CustomerName", "Carrier", "WH", "Printed", "List", "Bills", "Shipto", "PO", "cInvenType", "Boxes", "FBE", "InvAmount", "ScannedBox"}

                            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                            dt.Columns("Order").ColumnName = "INV#"
                            dt.Columns("OrderDate").ColumnName = "Date"
                            dt.Columns("List").ColumnName = "Scan"
                            dt.Columns("PO").ColumnName = "PO#"
                            dt.Columns("cInvenType").ColumnName = " "
                            dt.Columns("InvAmount").ColumnName = "$Inv.Amount"
                            dt.Columns("Boxes").ColumnName = "Pcs"
                            'dt.Columns("GPM").ColumnName = "%GPM"
                            dt.Columns("ScannedBox").ColumnName = "Missing"
                            dt.Rows.RemoveAt(dt.Rows.Count - 1)
                            Dim dtCloned As DataTable = dt.Clone()
                            dtCloned.Columns("Date").DataType = GetType(String)
                            dtCloned.Columns("Printed").DataType = GetType(String)
                            dtCloned.Columns("Scan").DataType = GetType(String)
                            dtCloned.Columns("Bills").DataType = GetType(String)
                            'dtCloned.Columns("%GPM").DataType = GetType(String)
                            dtCloned.Columns("$Inv.Amount").DataType = GetType(String)
                            dtCloned.Columns("FBE").DataType = GetType(String)
                            For Each row As DataRow In dt.Rows
                                dtCloned.ImportRow(row)
                            Next
                            For Each row As DataRow In dtCloned.Rows
                                For Each column As DataColumn In dtCloned.Columns
                                    If (column.ToString = "Day") Then
                                        If row.Item("Day").ToString().ToLower() <> "today" Then
                                            row.SetField(column, row.Item("Day").ToString.Substring(0, 3))
                                        End If
                                    ElseIf (column.ToString() = "%GPM") Then
                                        row.SetField(column, Convert.ToDecimal(row.Item("%GPM")).ToString("#,##0.0") + "%")
                                    ElseIf (column.ToString() = "$Inv.Amount") Then
                                        row.SetField(column, "$" + Convert.ToDecimal(row.Item("$Inv.Amount")).ToString("#,##0.00"))
                                    ElseIf (column.ToString() = "FBE") Then
                                        row.SetField(column, Convert.ToDecimal(row.Item("FBE")).ToString("#,##0.000"))
                                    ElseIf (column.ToString() = "Date") Then
                                        row.SetField(column, Convert.ToDateTime(row.Item("Date")).ToString("MM/dd/yyyy"))
                                    ElseIf (column.ToString = "Confirmed") Then
                                        row.SetField(column, IIf(row.Item("Confirmed").ToString = "False", "", "Yes"))
                                    ElseIf (column.ToString = "Printed") Then
                                        row.SetField(column, IIf(row.Item("Printed").ToString = "False", "", "Yes"))
                                    ElseIf (column.ToString = "Scan") Then
                                        row.SetField(column, IIf(row.Item("Scan").ToString = "False", "", "Yes"))
                                    ElseIf (column.ToString = "Bills") Then
                                        row.SetField(column, IIf(row.Item("Bills").ToString = "False", "", "Yes"))
                                    End If
                                Next
                            Next
                            Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                            Return BuildXmlDoc(filepath)
                        Else
                            'Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification from ", "error")
                            'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                        End If
                    Else
                        Return Nothing
                    End If
                Else
                    Dim dtDBF As DataTable
                    Dim dtSQL As New DataTable
                    dtDBF = Nothing

                    Dim TotalRowCount As Integer = 0
                    Dim HistoryrecordsOnly As String = "0"

                    Dim FilterCond = FrameFilterForSalesOrderHeaderSQL(Filter)
                    Dim whereCondition As String = ""
                    If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                        whereCondition = BuildWhereCondition(GetType(BO.SalesHeader), qtype, query.Replace("'", "''"))
                        If (FilterCond <> String.Empty And whereCondition <> String.Empty) Then
                            whereCondition = whereCondition + " And " + FilterCond.Replace("&amp;", "&")
                        ElseIf (FilterCond Is String.Empty And whereCondition <> String.Empty) Then
                            whereCondition = whereCondition
                        End If
                    Else
                        If (FilterCond <> String.Empty And whereCondition Is String.Empty) Then
                            whereCondition = FilterCond.Replace("&amp;", "&")
                        ElseIf (FilterCond <> String.Empty And whereCondition IsNot String.Empty) Then
                            whereCondition = whereCondition + " AND " + FilterCond.Replace("&amp;", "&")
                        End If
                    End If

                    'Commented By Prashant On 05/24/2020 for Not implemented the column in vet1 
                    If User.Division <> "" And User.Division <> "0" Then
                        whereCondition += " AND DIVISION IN (" + User.Division + ")"
                    End If

                    Dim canOnlySeeOwnSales As Boolean = IIf(User.ORDER.ToString().Substring(24, 1).ToString() = "Y", True, False)
                    If (Session("ShowAllSalesPersonSales") IsNot Nothing And Session("ShowAllSalesPersonSales") = False) Then
                        canOnlySeeOwnSales = True
                    End If

                    If (canOnlySeeOwnSales) Then
                        whereCondition += " AND SLSMAN = " + User.SalesPerson + " "
                    End If

                    Dim sortExp As String = sortname & " " & sortorder
                    'Dim start As Integer = ((page - 1) * rp) + 1
                    Dim start As Integer = 1

                    rp -= 1

                    If (page <= 0) Then
                        rp = 0
                        start = 0
                    End If
                    Dim objSales As New SalesOrder.GetSalesOrderHeader

                    data = objSales.GetSalesOrderHeaderList(whereCondition, sortExp, start, rp, FilterDivision, HistoryrecordsOnly, "")
                    TotalRowCount = data.count
                    dtSQL = ConvertToDataTable(data)
                    Dim selectedColumns As String() =
                   {"Order", "BGColor", "FontColor", "OrderSelected", "Customer", "AWB", "OrderDate", "CustomerName", "Day", "Carrier", "State",
                   "Country", "WH", If(dtSQL.Columns.Contains("HOLD"), "HOLD", "Confirmed"), "Terms", "IsClosedOrder", "Printed", "List", "Bills", "Scanned", "SHIPPED", "Shipto",
                   "ShiptoAddress1", "ShiptoAddress2", "ShiptoCity", "ShiptoState", "ShiptoZip", "PO", "cInvenType", "Weight", "Cubes", "Boxes", "FBE", "InvAmount", "GPM",
                   "ScannedBox", "SalesManEmail", "SalesManName", "FOBAmount", "INVCOST", "ErrorMessage", "TotalRows", "VOID", "SLSMAN", "ORDERUPDATEFLAG", "CONFIRMED", "PODFILE",
                   "Emailed", "XMLStatus", "Consignee", "HasPickListMessage"}


                    Dim dt As New DataTable
                    dt = New DataView(dtSQL).ToTable(False, selectedColumns)
                    Dim icclose As String = "<img style='margin-top:-3px; margin-left:3px;height: 13px;' src='images/icon_close.png'>"

                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            If TotalRowCount > 0 Then
                                TotalRowCount = dt.Rows.Count() - 1
                            End If

                            Dim daysOfService = ArmelliniService.GetDayOfService()


                            Dim SelectedPOs As New ArrayList
                            Dim xmldoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", TotalRowCount),
                            From row In dt.Rows()
                            Select
                            New XElement("row", New XAttribute("id", row.item("Order")), New XAttribute("background-color", IIf(row.item("BGColor") = "", "", row.item("BGColor"))), New XAttribute("color", IIf(row.item("FontColor") = "", "", row.item("FontColor"))),
                            New XElement("cell", GetGridColumnValue(row, 1, page)),
                            New XElement("cell", If(User.UserType.ToLower() = "warehouse", row.item("Order").ToString(), "<a id=EditOrder_" + row.item("Order").ToString() + " style='text-decoration:underline;cursor:pointer;margin-left:-4px;' data-void='" + row.item("VOID").ToString() + "'>" + row.item("Order").ToString() + "</a>")),
                            New XElement("cell", If(User.UserType.ToLower() = "warehouse", row.item("Customer").ToString(), "<a id='aCustomer_" + row.item("Customer").ToString() + "," + Convert.ToDateTime(row.item("OrderDate")).AddMonths(-12).ToString("MM/dd/yyyy") + "' style='text-decoration:underline;cursor:pointer;'>" + row.item("Customer").ToString() + "</a>")),
                            New XElement("cell", IIf(User.Name.ToLower() = "demo", "XXXXXXXXXXXXXXXXXXXXXXXX", "<a title='" + row.item("CustomerName").Replace("'", "") + "'>" + row.item("CustomerName") + "</a>")),
                            New XElement("cell", "<a class='OrderCalculation' id='aAWB_" + row.item("Order").ToString() + "'>" + row.item("AWB").ToString() + "<a>"),
                            New XElement("cell", OrderUpdateFlag(Convert.ToBoolean(row.item("ORDERUPDATEFLAG")), row.item("Order").ToString(), row.item("OrderDate").ToString())),
                            New XElement("cell", SalesOrderDayColumnFormat(row.item("Day"), row.item("HasPickListMessage"), row.item("Order").ToString())),
                            New XElement("cell", CheckArmelliniLog(row.item("Carrier"), row.item("Order"), row.item("XMLStatus"), IsShipDateValid(row.item("consignee"), row.item("OrderDate"), daysOfService), row.item("consignee"), row.item("OrderDate"))),
                            New XElement("cell", IIf(String.IsNullOrEmpty(row.item("Shiptostate")), row.item("State"), row.item("Shiptostate"))),
                            New XElement("cell", row.item("Country")),
                            New XElement("cell", row.item("WH")),
                            New XElement("cell", IIf(row.item("Confirmed") = True, "<p style='display:none'>1</p><img id='Confirmed_" + row.item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px' src='images/greentick.png'>", "<p style='display:none'>0</p>")),
                            New XElement("cell", IIf(row.item("Confirmed") = False And Convert.ToString(row.item("Terms")) = "*COD*", "<span class='spanTerms_" + row.item("order").ToString() + "' style='background: Red;color: white;padding: 6px 11px;margin-left: -11px;'><a style='color:white;' id='acTemrs_" + row.item("Order").ToString() + "'>" + Convert.ToString(row.item("Terms")) + "<a></span>", Convert.ToString(row.item("Terms")))),
                            New XElement("cell", IIf(Convert.ToString(row("IsClosedOrder")).ToLower() <> "true", IIf(row.item("Printed"), "<p style='display:none'>1</p><img id='Printed_" + row.item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px' src='images/greentick.png'>", "<p style='display:none'>0</p>"), icclose)),
                            New XElement("cell", IIf(Convert.ToString(row("IsClosedOrder")).ToLower() <> "true", IIf(row.item("List"), "<p style='display:none'>1</p><img id='list_" + row.item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px' src='images/yellowtick.png'>", "<p style='display:none'>0</p>"), icclose)),
                            New XElement("cell", SalesOrderBillsColumnFormat(row)),
                            New XElement("cell", IIf(row.item("Scanned") And row.item("SHIPPED"),
                            "<p style='display:none'>1</p><img id='imgScanned_" + row.item("Order").ToString() + "' style='margin-top:-3px; margin-left:3px;cursor:pointer;border-bottom:2px solid #1016AB' src='images/bluetick.png'>",
                            IIf(row.item("Scanned") And Not row.item("SHIPPED"), "<img id='imgScanned_" + row.item("Order").ToString() + "' style='margin-top:-3px; margin-left:3px;cursor:pointer;border-bottom:2px solid #AC5B6A' src='images/redtick.png'>", "<p style='display:none'>0</p>"))),
                            New XElement("cell", GetGridColumnValue(row, 4, page)),
                            New XElement("cell", row.item("PO").ToString),
                            New XElement("cell", GetGridColumnValue(row, 3, page)),
                            New XElement("cell", row.item("Weight")),
                            New XElement("cell", row.item("Cubes")),
                            New XElement("cell", GetGridColumnValue(row, 2, page)),
                            New XElement("cell", "<a class='OrderCalculation' id='aOrderFBE_" + row.item("Order").ToString() + "'>" + Convert.ToDecimal(row.item("FBE")).ToString("#,##0.00") + "<a>"),
                            New XElement("cell", "$ " + Convert.ToDecimal(row.item("InvAmount")).ToString("#,##0.00")),
                            New XElement("cell", Convert.ToDecimal(row.item("GPM")).ToString("#,##0.0") + "%"),
                            New XElement("cell", "<a id='aOrderMissingBoxes_" + row.item("Order").ToString() + "'>" + row.item("ScannedBox").ToString() + "<a>"),
                            New XElement("cell", String.Format("<a id='lblPrintLadingBill_" + row.item("Order").ToString() + "' title='Bill of Lading'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>")),
                            New XElement("cell", String.Format("<a id='lblPrintPickList_" + row.item("Order").ToString() + "' title='Print Pick List'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>")),
                            New XElement("cell", "<a style='cursor: pointer;' data-Email='" + row.item("SalesManEmail") + "' id='aSLSMAN_" + row.item("Order").ToString + "'>" + row.item("SalesManName") + "</a>"),
                            New XElement("cell", Convert.ToDecimal(row.item("FobAmount"))),
                            New XElement("cell", Convert.ToDecimal(row.item("InvCost"))),
                            New XElement("cell", "<a id='IsClosedOrder_" + Convert.ToString(row("Order")) + "'>" + Convert.ToString(row("IsClosedOrder")) + "</a>"),
                            New XElement("cell", Convert.ToInt32(row.item("SLSMAN"))),
                            New XElement("cell", IIf(Convert.ToString(row("PODFILE")) = "", "No POD", "<a onclick='openPDFViewer(""" + Convert.ToString(row("PODFILE")) + """)'><img style='cursor: pointer; height: 15px;' src='images/greenhold.png'></a>")),
                            New XElement("cell", IIf(Convert.ToString(row("Emailed")) = "e", "<img style='Cursor:pointer;margin-top:-3px' id='EmailedPoSelect_" & row("Order").ToString() & "' src='images/check-on.png' />", IIf(Convert.ToString(row("Emailed")) = "x", "<img style='Cursor:pointer;margin-top:-3px' id='EmailedPoSelect_" & row("Order").ToString() & "' src='images/Filter.png' />", ""))))))

                            Dim newDoc As New XmlDocument()
                            newDoc.LoadXml(Convert.ToString(xmldoc))
                            Dim idx As Integer = TotalRowCount

                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = "Totals"
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(26).InnerText = ""
                            ' newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(27).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(33).InnerText = ""
                            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(34).InnerText = ""
                            Return newDoc
                        Else
                            ' Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, dt(TotalRowCount - 1)("ErrorMessage").ToString(), "", "Error Notification", "error")
                            'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                        End If
                    Else
                        Return Nothing
                    End If
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderHeaderListNew::PageOrder")
            Return Nothing
        End Try
    End Function


    Private Function GetGridColumnValue(row As DataRow, column As Integer, page As String) As String
        If column = 1 Then
            If (row.Item("Boxes") <> 0 Or page = "1") And row.Item("Shipto") <> "*SHIPTO ERROR*" Then
                Return String.Format("<img style='Cursor:pointer;margin-top:-3px' id='Orderselect_" & row.Item("Order").ToString() & "' src='" & IIf(row.Item("OrderSelected"), "images/check-on.png", "images/check-off.png") & "'  />")
            Else
                Return String.Format("<span style='background: #ff0a0e;padding: 6px 11px;margin-left: -11px;color: white;'></span>")
            End If
        ElseIf column = 2 Then
            If row.Item("Boxes") <> 0 Then
                Return "<a class='OrderCalculation' id='aOrderBoxes_" + row.Item("Order").ToString() + "'>" + row.Item("Boxes").ToString() + "<a>"
            Else
                Return String.Format("<span style='background: #ff0a0e;padding: 6px 11px;margin-left: -11px;color: white;'><a class='OrderCalculation' id='aOrderBoxes_" + row.Item("Order").ToString() + "'>" + row.Item("Boxes").ToString() + "<a></span>")
            End If
        ElseIf column = 3 Then
            If row.Item("cInvenType") Is DBNull.Value Then Return ""

            If row.Item("cInvenType") = "A" Then
                Return "<span class='spancInvenType_" + row.Item("order").ToString() + "' style='background: #0000A0;color: white;padding: 6px 11px;margin-left: -11px;'><a style='color:white;' id='acInvenType_" + row.Item("Order").ToString() + "'>" + row.Item("cInvenType").ToString() + "<a></span>"
            ElseIf row.Item("cInvenType") = "P" Then
                Return "<span class='spancInvenType_" + row.Item("order").ToString() + "' style='background: pink;color: white;padding: 6px 11px;margin-left: -11px;'><a style='color:white;' id='acInvenType_" + row.Item("Order").ToString() + "'>" + row.Item("cInvenType").ToString() + "<a></span>"
            Else
                Return row.Item("cInvenType").ToString()
            End If
        ElseIf column = 4 Then
            Dim carriers As New List(Of String) From {"AR", "A1", "FB", "GG", "G&G", "PF", "PR", "EL", "FT", "AF"}
            If row.Item("Shipto") = "*SHIPTO ERROR*" Then
                Return "<a style='background: #ff0a0e;color: white;'>" + ReplaceSingleQutoesInString(row.Item("Shipto")) + "</a>"
            ElseIf carriers.Contains(row.Item("carrier")) And row.Item("consignee") = "" Then
                Return "<a style='background: #ff0a0e;color: white;'>Need consignee</a>"
            Else
                Return "<a title='" + ReplaceSingleQutoesInString(row.Item("Shipto")) + "<br/>" + ReplaceSingleQutoesInString(row.Item("ShiptoAddress1")) + "<br/>" + ReplaceSingleQutoesInString(row.Item("ShiptoAddress2")) + "<br/>" + ReplaceSingleQutoesInString(row.Item("ShiptoCity")) + "," + ReplaceSingleQutoesInString(row.Item("ShiptoState")) + "<br/>" + ReplaceSingleQutoesInString(row.Item("ShiptoZip")) + "'>" + ReplaceSingleQutoesInString(row.Item("Shipto")) + "</a>"
            End If
        End If
    End Function
    Private Function ReplaceSingleQutoesInString(ByVal data As String) As String
        Try
            Return data.ToString.Replace("'", ControlChars.Quote)
        Catch ex As Exception
            Return data
        End Try
    End Function

    'It checks whether the boxes is successfully posted to armellini service for carrier A1,A2,A3,AR
    Public Function IsShipDateValid(ByVal consignee As String, ByVal shipDate As DateTime, ByVal daysOfService As List(Of ServiceDays)) As Boolean
        'daysOfService.Where(Function(x) x.consigneeAccountNumber = row.item("consignee") And x.shipDate = row.item("date")).Any())
        If shipDate < DateTime.Today Then
            Return True
        End If
        Try
            Return daysOfService.Where(Function(x) x.consigneeAccountNumber = consignee And x.shipDate = shipDate).Any()
        Catch ex As Exception
            Return True
        End Try
    End Function

    'It checks whether the boxes is successfully posted to armellini service for carrier A1,A2,A3,AR
    Public Function CheckArmelliniLog(ByVal Carrier As String, ByVal OrderNo As String, ByVal status As String, ByVal validShipDate As Boolean, ByVal consignee As String, ByVal orderDate As DateTime) As String
        Try
            If (Carrier <> "A1" And Carrier <> "A2" And Carrier <> "A3" And Carrier <> "AR" And Carrier <> "FB" And Carrier <> "GG" And Carrier <> "G&G" And Carrier <> "EL" And Carrier <> "FT" And Carrier <> "AF") Then
                Return "<span class='Carrier_" + OrderNo + "'>" + Carrier + "</span>"
            Else
                If status = "1" Then
                    Return "<span class='Carrier_" + OrderNo + "' style='background: Green;padding: 6px 11px;margin-left: -11px;color: white;'><a href='#' style='color:white;' id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                ElseIf status = "0" Then
                    Return "<span class='Carrier_" + OrderNo + "' style='background: Red;padding: 6px 11px;margin-left: -11px;color: white;'><a href='#' style='color:white;' id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                ElseIf status = "-" And orderDate = DateTime.Today And Carrier = "FB" Then
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                    'Logs.SendMail(User.Email, "jose@dflower.com", "", "", CompanyName + " Florida Beauty error " + OrderNo, "", "", "")
                    Return "<span class='Carrier_" + OrderNo + "' style='background: Red;padding: 6px 11px;margin-left: -11px;color: white;'><a href='#' style='color:white;' id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                Else
                    If Carrier = "EL" Or Carrier = "FT" Or Carrier = "FB" Or Carrier = "GG" Or Carrier = "G&G" Or Carrier = "AF" Then
                        Return "<span class='Carrier_" + OrderNo + "'><a id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                    Else
                        'validShipDate only works for armellini
                        If validShipDate Then
                            Return "<span class='Carrier_" + OrderNo + "' style='background: Red;padding: 6px 11px;margin-left: -11px;color: white;'><a id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                        Else
                            Return "<span class='Carrier_" + OrderNo + "' style='background: Pink;padding: 6px 11px;margin-left: -11px;color: white;'><a class='NoService' id='lnkCarrierARXML_" + OrderNo + "_" + consignee + "'>" + Carrier + "</span>"
                        End If
                    End If
                End If
            End If
        Catch ex As Exception
            Return Carrier
        End Try
    End Function


    Private Function SpordCarrierColumnFormat(ByVal Carrier As String, ByVal type As String, ByVal consignee As String, ByVal shipDate As String, ByVal daysOfService As List(Of ServiceDays)) As String
        Try
            If (Carrier <> "A1" And Carrier <> "A2" And Carrier <> "A3" And Carrier <> "AR" And Carrier <> "FB") Then
                Return "<span>" + Carrier + "</span>"
            Else
                If (type = "P" Or type = "D") Then
                    Dim value As DateTime = DateTime.Parse(shipDate)
                    If value < DateTime.Today Then
                        Return "<span>" + Carrier + "</span>"
                    End If
                    Dim exists As Boolean = daysOfService.Where(Function(x) x.consigneeAccountNumber = consignee And x.shipDate = shipDate).Any()
                    If exists Then
                        Return "<span>" + Carrier + "</span>"
                    Else
                        Return "<span style='background: Pink;color: white;'>" + Carrier + "</span>"
                    End If
                Else
                    Return "<span>" + Carrier + "</span>"
                End If
            End If
        Catch ex As Exception
            Return Carrier
        End Try
    End Function


    'It checks whether the boxes is successfully posted to armellini service for carrier A1,A2,A3,AR
    <System.Web.Services.WebMethod(True)>
    Public Function CheckArmelliniLog(ByVal Carrier As String, ByVal OrderNo As String) As String
        Try
            If (Carrier <> "A1" And Carrier <> "A2" And Carrier <> "A3" And Carrier <> "AR" And Carrier <> "FB" And Carrier <> "GG" And Carrier <> "G&G" And Carrier <> "EL" And Carrier <> "FT" And Carrier <> "AF") Then
                Return "<span class='Carrier_" + OrderNo + "'>" + Carrier + "</span>"
            Else

                Dim Result = ArmelliniXML.CheckArmelliniLogXMLStatus(OrderNo, Carrier)
                If Result = "success" Then
                    Return "<span class='Carrier_" + OrderNo + "' style='background: Green;padding: 6px 11px;margin-left: -11px;color: white;'><a href='#' style='color:white;' id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                ElseIf Result = "error" Then
                    Return "<span class='Carrier_" + OrderNo + "' style='background: Red;padding: 6px 11px;margin-left: -11px;color: white;'><a href='#' style='color:white;' id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                Else
                    Return "<span class='Carrier_" + OrderNo + "'><a id='lnkCarrierARXML_" + OrderNo + "'>" + Carrier + "</span>"
                End If
            End If
        Catch ex As Exception
            Return Carrier
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetDonotShowCargoDateValueFromConstant() As Boolean
        Try
            Return SalesOrder.GetDonotShowCargoDateValueFromConstant()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in BloomService::GetDonotShowCargoDateValueFromConstant")
            Return False
        End Try
    End Function
    'SOFIA: 02/08/2021 - show / hide buttons when option is selected
    <System.Web.Services.WebMethod(True)>
    Public Function GetConstantForShowAwbOnOrderGrid() As Boolean
        Try
            Return SalesOrder.GetConstantForShowAwbOnOrderGrid()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in BloomService::GetConstantForShowAwbOnOrderGrid")
            Return False
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetConstantForShowStandingOrderAndAlocation() As Boolean
        Try
            Return SalesOrder.GetConstantForShowStandingOrderAndAlocation()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in BloomService::GetConstantForShowStandingOrderAndAlocation")
            Return False
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function OrderUpdateFlag(ByVal UpdateFlag As Boolean, ByVal OrderNo As String, ByVal OrderDate As String) As String
        Try
            If (UpdateFlag = False) Then
                Return "<a id='aOrderDate_" + OrderNo.ToString() + "' style='cursor:pointer;'>" + Convert.ToDateTime(OrderDate).ToString("MM/dd/yyyy") + "</a>"

            Else
                Return "<span class='spanOrderDate_" + OrderNo + "' style='background: #ff0a0e;padding: 6px 11px;margin-left: -11px;color: white;'><a href='#' style='color:white;' id='aOrderDate_" + OrderNo + "'>" + Convert.ToDateTime(OrderDate).ToString("MM/dd/yyyy") + "</a></span>"
            End If
        Catch ex As Exception
            Return ""
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function ResendARXMLFile(ByVal FileName As String, ByVal OldConsignee As String,
    '  ByVal NewConsignee As String, ByVal UploadStatus As Boolean,
    ' ByVal OldShipdate As String, ByVal NewShipdate As String) As Object
    ' Try
    '  Dim result = obj.ResendARXMLFile(FileName, OldConsignee, NewConsignee, UploadStatus, OldShipdate, NewShipdate)
    ' Return result
    ' Catch ex As Exception
    '    ErrorLogs.LogException(ex, "Error in Service::ResendARXMLFile::PageOrder")
    '    Return "error"
    '  End Try
    '  End Function

#Region "New Armellini resend xml"
    <System.Web.Services.WebMethod(True)>
    Public Function ResendARXMLFile(ByVal FileName As String, ByVal OldConsignee As String,
                                    ByVal NewConsignee As String, ByVal UploadStatus As Boolean,
                                    ByVal OldShipdate As String, ByVal NewShipdate As String, ByVal OrderNo As String) As Object
        Dim User As New User
        Try
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Try
                AppendLog("-------", "ResendARXMLFile")
                AppendLog("Resend Started", "ResendARXMLFile")
                AppendLog(OldConsignee, "ResendARXMLFile-OldConsignee")
                AppendLog(NewConsignee, "ResendARXMLFile-NewConsignee")
                AppendLog(Convert.ToString(UploadStatus), "ResendARXMLFile-UploadStatus")
                AppendLog(OldShipdate, "ResendARXMLFile-OldShipdate")
                AppendLog(NewShipdate, "ResendARXMLFile-NewShipdate")
            Catch ex As Exception
                ErrorLogs.LogException(ex, "Error In ResendARXMLFile-Appendlog")
            End Try

            If ArmelliniXML.ResendARXMLFile(OrderNo, IIf(User Is Nothing, 0, User.ID), NewShipdate, NewConsignee) Then
                SendARXML("", "", "1")
                Return "success"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ResendARXMLFile::PageOrder")
            Return "error"
        End Try
        Return "error"
    End Function

#End Region


#Region "Prime Text File Format"
    <System.Web.Services.WebMethod(True)>
    Public Function GeneratePrimeEDIFiles(ByVal Shipdate As String, ByVal Carrier As String) As String
        Try
            Return SalesOrder.GeneratePrimeEDIFiles(Shipdate, Carrier)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GeneratePrimeEDIFiles::PageOrder")
            Return Nothing
        End Try
    End Function
#End Region

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetArmelliniDayOfServiceByOrder(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal Consignee As String) As XmlDocument
        Try

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ArmelliniXML.GetArmelliniXMLDetails
            Dim data As List(Of String) = obj.GetArmelliniDayOfServiceByConsignee(Consignee)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", data.Count),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row),
                                        New XElement("cell", row),
                                        New XElement("cell", DateTime.Parse(row).ToString("dddd"))))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetArmelliniXMLLogsByOrder")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetArmelliniXMLLogsByOrder(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Order As String, ByVal Carrier As String) As XmlDocument
        Try
            'Dim whereCondition As String = ""
            'If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
            '    whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            'End If


            'Dim sortExp As String = sortname & " " & sortorder
            'Dim start As Integer = ((page - 1) * rp) + 1
            'rp -= 1

            Dim obj As New ArmelliniXML.GetArmelliniXMLDetails
            Dim data As List(Of BO.ArmelliniXML) = obj.GetArmelliniXMLLogsByOrder(Order, Carrier)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<a id='aShipDateARXML_" + Convert.ToString(row.ID) + "'>" + row.ShipDate + "</a>"),
                                        New XElement("cell", "<a id='aXMLFileNameForARXML_" + Convert.ToString(row.ID) + "'>" + row.XMLFileName + "</a>"),
                                        New XElement("cell", "<span title='" + If(row.ResponseMessage.Contains("'"), row.ResponseMessage.Replace("'", "&#39;"), row.ResponseMessage) + "'>" + row.ResponseMessage + "</span>"),
                                        New XElement("cell", "<a id='aXMLStatusARXML_" + Convert.ToString(row.ID) + "'>" + row.Status + "</a>"),
                                        New XElement("cell", row.CreatedDateTime),
                                        New XElement("cell", "<a id='aConsigneeARXML_" + Convert.ToString(row.ID) + "'>" + row.Consignee + "</a>"),
                                        New XElement("cell", row.ArBoxNo)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetArmelliniXMLLogsByOrder")
            Return Nothing
        End Try
    End Function

    Private Function FrameFilterForSalesOrderHeader(ByVal Filter As String) As String
        Try

            Dim DateSession(1) As String
            If (Not Session("DateSession") Is Nothing) Then
                DateSession = Session("DateSession")
            Else
                DateSession = Nothing
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If (DateSession Is Nothing) Then
                FromDate = DateTime.Now.ToString("MM/dd/yyyy")
                ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            Else
                FromDate = DateSession(0).ToString()
                ToDate = DateSession(1).ToString()
            End If

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim FilterCode As String = ""
            If (LoginUserDetails.WarehouseList.Count > 0) Then
                Dim warehouses As String = ""
                If LoginUserDetails.WarehouseList.Count > 0 Then
                    warehouses = String.Join("','", LoginUserDetails.WarehouseList.[Select](Function(x) x.WH.ToUpper()))
                End If
                FilterCode = "WH IN ('" + warehouses.ToString() + "')"
            End If

            If LoginUserDetails.UserType = "Customer" Then
                FilterCode += IIf(FilterCode <> "", " And Customer=" + LoginUserDetails.CustomerNo, "Customer=" + LoginUserDetails.CustomerNo)
            End If


            If LoginUserDetails.UserType = "Sales Person" Then
                FilterCode += IIf(FilterCode <> "", "And SLSMAN=" + LoginUserDetails.SalesPerson, "SLSMAN=" + LoginUserDetails.SalesPerson)
            End If

            'If FilterDivision <> "" Then
            '    If User.Division <> "0" Then
            '        FilterDivision = User.Division
            '    Else
            '        FilterDivision = ""
            '    End If
            'End If

            If ToDate = DateTime.Now.ToString("MM/dd/yyyy") And FromDate = "" Then
                If (FilterCode = "") Then
                    FilterCode = "OrderDate >= ctod('" + ToDate + "') "
                Else
                    FilterCode = FilterCode + " and OrderDate >= ctod('" + ToDate + "') "
                End If
            Else
                If (FilterCode = "") Then
                    FilterCode = "OrderDate >= ctod('" + FromDate + "') " + " And OrderDate <= " + " ctod('" + ToDate + "')"
                Else
                    FilterCode = FilterCode + " and OrderDate >= ctod('" + FromDate + "') " + " And OrderDate <=" + " ctod('" + ToDate + "')"
                End If
            End If

            Dim CarrierFilterSession(0) As String
            If (Not Session("CarrierFilterSession") Is Nothing) Then
                CarrierFilterSession = Session("CarrierFilterSession")
            Else
                CarrierFilterSession = Nothing
            End If

            Dim Carrier As String = ""

            If (CarrierFilterSession Is Nothing) Then
                FilterCode = FilterCode
            Else
                If (CarrierFilterSession.Length > 0 And CarrierFilterSession(0) = "") Then
                    FilterCode = FilterCode
                Else
                    FilterCode = If(FilterCode = "", " Carrier= '" + CarrierFilterSession(0).ToString() + "'", FilterCode + " and  Carrier= '" + CarrierFilterSession(0).ToString() + "'")
                End If
            End If


            If Filter <> "" Then
                If (FilterCode <> "") Then
                    Filter += " And " + FilterCode
                End If
            Else
                Filter += FilterCode + " And Void=0"
                'Filter = FilterCode 
            End If

            Return Filter
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::FrameFilterForSalesOrderHeader::PageOrder")
            Return Nothing
        End Try
    End Function

    Private Function FrameFilterForSalesOrderHeaderSQL(ByVal Filter As String, ByVal Optional overrideDates As Boolean = False) As String
        Try

            Dim DateSession(1) As String
            If (Not Session("DateSession") Is Nothing) Then
                DateSession = Session("DateSession")
            Else
                DateSession = Nothing
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If (DateSession Is Nothing) Then
                FromDate = DateTime.Now.ToString("MM/dd/yyyy")
                ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            Else
                FromDate = DateSession(0).ToString()
                ToDate = DateSession(1).ToString()
            End If

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim FilterCode As String = ""
            If (LoginUserDetails.WarehouseList.Count > 0) Then
                Dim warehouses As String = ""
                If LoginUserDetails.WarehouseList.Count > 0 Then
                    warehouses = String.Join("','", LoginUserDetails.WarehouseList.[Select](Function(x) x.WH.ToUpper()))
                End If
                FilterCode = "WH IN ('" + warehouses.ToString() + "')"
            End If

            If LoginUserDetails.UserType = "Customer" Then
                FilterCode += IIf(FilterCode <> "", " And Customer=" + LoginUserDetails.CustomerNo, "Customer=" + LoginUserDetails.CustomerNo)
            End If


            If Session("ShowAllSalesPersonSales") = False Then
                If LoginUserDetails.UserType = "Sales Person" Then
                    FilterCode += IIf(FilterCode <> "", "And SLSMAN=" + LoginUserDetails.SalesPerson, "SLSMAN=" + LoginUserDetails.SalesPerson)
                End If
                'If LoginUserDetails.UserType = "Employee" Then
                'FilterCode += IIf(FilterCode <> "", "And SLSMAN=" + LoginUserDetails.SalesPerson, "SLSMAN=" + LoginUserDetails.SalesPerson)
                'End If
            End If
            'If LoginUserDetails.UserType = "Sales Person" Then
            '    FilterCode += IIf(FilterCode <> "", "And SLSMAN=" + LoginUserDetails.SalesPerson, "SLSMAN=" + LoginUserDetails.SalesPerson)
            'End If

            If Not overrideDates Then

                If ToDate = DateTime.Now.ToString("MM/dd/yyyy") And FromDate = "" Then
                    If (FilterCode = "") Then
                        FilterCode = "[Date] >= cast('" + ToDate + "' as date) "
                    Else
                        FilterCode = FilterCode + " and [Date] >= cast('" + ToDate + "' as date) "
                    End If
                Else
                    If (FilterCode = "") Then
                        FilterCode = "[Date] >= cast('" + FromDate + "' as date) " + " And [Date] <= " + " cast('" + ToDate + "' as date)"
                    Else
                        FilterCode = FilterCode + " and [Date] >= cast('" + FromDate + "' as date) " + " And [Date] <=" + " cast('" + ToDate + "' as date)"
                    End If
                End If
            End If


            Dim CarrierFilterSession(0) As String
            If (Not Session("CarrierFilterSession") Is Nothing) Then
                CarrierFilterSession = Session("CarrierFilterSession")
            Else
                CarrierFilterSession = Nothing
            End If

            Dim Carrier As String = ""

            If (CarrierFilterSession Is Nothing) Then
                FilterCode = FilterCode
            Else
                If (CarrierFilterSession.Length > 0 And CarrierFilterSession(0) = "") Then
                    FilterCode = FilterCode
                Else
                    FilterCode = If(FilterCode = "", " Carrier= '" + CarrierFilterSession(0).ToString() + "'", FilterCode + " and  Carrier= '" + CarrierFilterSession(0).ToString() + "'")
                End If
            End If


            If Filter <> "" Then
                If (FilterCode <> "") Then
                    Filter += " And " + FilterCode
                End If
            Else

                Filter += FilterCode + " And Void=0"
            End If

            Return Filter
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::FrameFilterForSalesOrderHeaderSQL::PageOrder")
            Return Nothing
        End Try
    End Function

    'VEN::23-10-205::FOR DATE FILLTER 
    '<System.Web.Services.WebMethod(True)>
    'Public Sub SaveSalesOrderDateSession(ByVal FromDate As String, ByVal ToDate As String)
    '    Try
    '        If FromDate <> "" And ToDate <> "" Then
    '            Dim DateSession(1) As String
    '            DateSession(0) = FromDate
    '            DateSession(1) = ToDate
    '            Session("SalesOrderDateSession") = DateSession
    '        Else
    '            Session("SalesOrderDateSession") = Nothing
    '        End If

    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::SaveSalesOrderDateSession::PageOrder")
    '    End Try
    'End Sub

    'VEN::23-10-205::FOR DATE FILLTER 
    '<System.Web.Services.WebMethod(True)>
    'Public Function GetSalesOrderDateSession() As String()
    '    Try
    '        Dim DateSession(1) As String
    '        DateSession = Session("SalesOrderDateSession")
    '        Return DateSession
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderDateSession::PageOrder")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetCarrierDetails(ByVal Filter As String) As Object
    '    Try
    '        Dim data = obj.GetCarrierDetails(Filter)
    '        If data.Length > 0 Then

    '            If data(0).ErrorMessage = "" Then
    '                Return data
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetCarrierDetails::PageOrder")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'JAD  Please review this code    2021-05-01
    'Public Function GetDistinctCarrierDetailsForChartbyFBE(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctCarrier = obj.GetDistinctCarrierDetailsForChartbyFBE(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If (DistinctCarrier.Count > 0) Then
    '            If (DistinctCarrier(0).ErrorMessage = "") Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim CarrierCountAfterSixRecords As Integer = 0
    '                Dim CarrierAfterSixRecords As String
    '                For Each I In DistinctCarrier
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.FBE.ToString("#,##0.000")
    '                        PieChart.color = GetColorForChart(Count)
    '                        PieChart.label = I.CarrierCode
    '                        PieChart.labelColor = "black"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        CarrierAfterSixRecords = I.CarrierCode
    '                        CarrierCountAfterSixRecords = CarrierCountAfterSixRecords + I.FBE.ToString("#,##0.000")
    '                    End If
    '                Next
    '                If CarrierCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = CarrierCountAfterSixRecords
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "black"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctCarrier(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctCarrierDetailsForChartbyFBE")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctCarrierDetailsForChartbyPcs(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctCarrier = obj.GetDistinctCarrierDetailsForChartbyPCS(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If (DistinctCarrier.Length > 0) Then
    '            If DistinctCarrier(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim CarrierCountAfterSixRecords As Integer = 0
    '                Dim CarrierAfterSixRecords As String
    '                For Each I In DistinctCarrier
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.Boxes
    '                        PieChart.color = GetColorForChart(Count)
    '                        PieChart.label = I.CarrierCode
    '                        PieChart.labelColor = "black"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        CarrierAfterSixRecords = I.CarrierCode
    '                        CarrierCountAfterSixRecords = CarrierCountAfterSixRecords + I.Boxes
    '                    End If
    '                Next
    '                If CarrierCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = CarrierCountAfterSixRecords
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "black"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctCarrier(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctCarrierDetailsForChartbyPcs")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctStateDetailsForChartbyBoxes(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctState = obj.GetDistinctStateDetailsForChartbyBoxes(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctState.Length > 0 Then
    '            If DistinctState(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim StateCountAfterSixRecords As Integer = 0
    '                Dim StateAfterSixRecords As String
    '                For Each I In DistinctState
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.Boxes
    '                        PieChart.color = GetColorForChart(Count)
    '                        PieChart.label = I.State
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        StateAfterSixRecords = I.State
    '                        StateCountAfterSixRecords = StateCountAfterSixRecords + I.Boxes
    '                    End If
    '                Next
    '                If StateCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = StateCountAfterSixRecords
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctState(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctStateDetailsForChartbyBoxes")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctStateDetailsForChartbySales(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctState = obj.GetDistinctStateDetailsForChartbySales(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctState.Length > 0 Then
    '            If DistinctState(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim StateCountAfterSixRecords As Integer = 0
    '                Dim StateAfterSixRecords As String
    '                For Each I In DistinctState
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.InvAmount.ToString("#,##0.00")
    '                        PieChart.color = GetColorForChart(Count)
    '                        PieChart.label = I.State
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChart.SuFixSymbol = "%"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        StateAfterSixRecords = I.State
    '                        StateCountAfterSixRecords = StateCountAfterSixRecords + I.InvAmount.ToString("#,##0.00")
    '                    End If
    '                Next
    '                If StateCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = StateCountAfterSixRecords
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChart1.SuFixSymbol = "%"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctState(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctStateDetailsForChartbySales")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctSalesManDetailsForChart(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctSalesMan = obj.GetDistinctSalesManDetailsForChart(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctSalesMan.Length > 0 Then
    '            If DistinctSalesMan(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim SalesManCountAfterSixRecords As Integer = 0
    '                Dim SalesManAfterSixRecords As String
    '                For Each I In DistinctSalesMan
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.InvAmount.ToString("#,##0.00")
    '                        PieChart.color = I.SalesManColor
    '                        'PieChart.label = I.SalesManName
    '                        'PieChart.label = I.SalesManName + "&nbsp;&nbsp;" + I.InvAmountSales.ToString("#,##0.00")
    '                        PieChart.label = I.SalesManName + "|" + "$ " + I.InvAmountSales.ToString("#,##0.00")
    '                        'PieChart.label = "<table><tbody><tr><td>" + I.SalesManName + "</td><td> " + I.InvAmountSales.ToString("#,##0.00") + "</td></tr></tbody></table>"
    '                        '<table><tbody><tr><td>FREDDY MELERO</td><td>&nbsp;&nbsp;29,906.33</td></tr></tbody></table>
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChart.SuFixSymbol = "%"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        SalesManAfterSixRecords = I.SalesManName
    '                        SalesManCountAfterSixRecords = SalesManCountAfterSixRecords + I.InvAmount.ToString("#,##0.00")
    '                    End If
    '                Next
    '                If SalesManCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = SalesManCountAfterSixRecords
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChart1.SuFixSymbol = "%"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctSalesMan(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctSalesManDetailsForChart")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctFlowerColorDetailsForChartbyBoxes(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctFlowerColor = obj.GetDistinctFlowerColorDetailsForChartbyBoxes(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctFlowerColor.Length > 0 Then
    '            If DistinctFlowerColor(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim FlowerColorCountAfterSixRecords As Integer = 0
    '                Dim FlowerColorAfterSixRecords As String
    '                'Dim Colors = String.Join(",", DistinctFlowerColor.[Select](Function(x) x.DetailsList(0).FlowerDetails.Color.ToUpper()))
    '                Dim Colors As String = ""
    '                For Each I In DistinctFlowerColor
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.Boxes
    '                        PieChart.color = GetColorForOrderColorChart(I.DetailsList(0).FlowerDetails.Color, Colors)
    '                        Colors = Colors + "," + PieChart.color.ToUpper()
    '                        PieChart.label = I.DetailsList(0).FlowerDetails.Color
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        FlowerColorAfterSixRecords = I.DetailsList(0).FlowerDetails.Color
    '                        FlowerColorCountAfterSixRecords = FlowerColorCountAfterSixRecords + I.Boxes
    '                    End If
    '                Next
    '                If FlowerColorCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = FlowerColorCountAfterSixRecords
    '                    PieChart1.color = GetColorForOrderColorChart("Others", Colors)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctFlowerColor(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctFlowerColorDetailsForChartbyBoxes")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctFlowerColorDetailsForChartbySales(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctFlowerColor = obj.GetDistinctFlowerColorDetailsForChartbySales(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctFlowerColor.Length > 0 Then
    '            If DistinctFlowerColor(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim FlowerColorCountAfterSixRecords As Integer = 0
    '                Dim FlowerColorAfterSixRecords As String
    '                Dim Colors = String.Join(",", DistinctFlowerColor.[Select](Function(x) x.FlowerColor.ToUpper()))
    '                For Each I In DistinctFlowerColor
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.InvAmount.ToString("#,##0.00")
    '                        PieChart.color = GetColorForOrderColorChart(I.FlowerColor, Colors)
    '                        Colors = Colors + "," + PieChart.color.ToUpper()
    '                        PieChart.label = I.FlowerColor
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChart.SuFixSymbol = "%"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        FlowerColorAfterSixRecords = I.FlowerColor
    '                        FlowerColorCountAfterSixRecords = FlowerColorCountAfterSixRecords + I.InvAmount.ToString("#,##0.00")
    '                    End If
    '                Next
    '                If FlowerColorCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = FlowerColorCountAfterSixRecords
    '                    PieChart1.color = GetColorForOrderColorChart("Others", Colors)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChart1.SuFixSymbol = "%"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctFlowerColor(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctFlowerColorDetailsForChartbySales")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctFlowerCatDetailsForChart(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctFlowerCat = obj.GetDistinctFlowerCatDetailsForChart(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctFlowerCat.Length > 0 Then
    '            If DistinctFlowerCat(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim FlowerCatCountAfterSixRecords As Integer = 0
    '                Dim FlowerCatAfterSixRecords As String
    '                For Each I In DistinctFlowerCat
    '                    If Count <= 5 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.FlowerCatCount
    '                        PieChart.color = GetColorForChart(Count)
    '                        PieChart.label = I.DetailsList(0).FlowerDetails.CAT
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        FlowerCatAfterSixRecords = I.DetailsList(0).FlowerDetails.CAT
    '                        FlowerCatCountAfterSixRecords = FlowerCatCountAfterSixRecords + I.FlowerCatCount
    '                    End If
    '                Next
    '                If FlowerCatCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = FlowerCatCountAfterSixRecords
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "Others"
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctFlowerCat(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctFlowerCatDetailsForChart")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetDistinctFlowerDescDetailsForChart(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctFlowerDesc = obj.GetDistinctFlowerDescDetailsForChart(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctFlowerDesc.Length > 0 Then
    '            If DistinctFlowerDesc(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim FlowerDescCountAfterSixRecords As Integer = 0
    '                Dim FlowerDescAfterSixRecords As String
    '                Dim FlowerDescCountAfterSixRecordsAmount As Decimal = 0
    '                For Each I In DistinctFlowerDesc
    '                    If Count <= 19 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.FlowerCount
    '                        PieChart.color = GetColorForChart(Count)
    '                        PieChart.label = "~ " + I.DetailsList(0).FlowerDetails.Name + "|" + "$" + I.InvAmount.ToString("#,##0.00")
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        FlowerDescAfterSixRecords = I.DetailsList(0).FlowerDetails.Name
    '                        FlowerDescCountAfterSixRecords = FlowerDescCountAfterSixRecords + I.FlowerCount
    '                        FlowerDescCountAfterSixRecordsAmount = FlowerDescCountAfterSixRecordsAmount + I.InvAmount
    '                    End If
    '                Next
    '                If FlowerDescCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = FlowerDescCountAfterSixRecords
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "~ Others" + "|" + "$" + FlowerDescCountAfterSixRecordsAmount.ToString("#,##0.00")
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctFlowerDesc(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetDistinctFlowerDescDetailsForChart")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetCustomerDescDetailsForChart(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As List(Of PieChart)
    '    Try
    '        Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
    '        Dim DistinctCustomerDesc = obj.GetCustomerDescDetailsForChart(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
    '        If DistinctCustomerDesc.Length > 0 Then
    '            If DistinctCustomerDesc(0).ErrorMessage = "" Then
    '                Dim PieChartList As New List(Of PieChart)
    '                Dim Count As Integer = 0
    '                Dim CustomerDescCountAfterSixRecords As Integer = 0
    '                Dim CustomerDescCountAfterSixRecordsAmount As Decimal = 0
    '                Dim CustomerDescAfterSixRecords As String
    '                For Each I In DistinctCustomerDesc
    '                    If Count <= 19 Then
    '                        Dim PieChart As New PieChart
    '                        PieChart.value = I.InvAmount.ToString("#,##0.00")
    '                        PieChart.SuFixSymbol = "%"
    '                        PieChart.color = GetColorForChart(Count)
    '                        PieChart.label = "~ " + I.CustomerName + "|" + "$" + I.CustAmount.ToString("#,##0.00")
    '                        PieChart.labelColor = "white"
    '                        PieChart.labelFontSize = "16px"
    '                        PieChartList.Add(PieChart)
    '                        Count = Count + 1
    '                    Else
    '                        CustomerDescAfterSixRecords = I.CustomerName
    '                        CustomerDescCountAfterSixRecords = CustomerDescCountAfterSixRecords + I.InvAmount.ToString("#,##0.00")
    '                        CustomerDescCountAfterSixRecordsAmount = CustomerDescCountAfterSixRecordsAmount + I.CustAmount
    '                    End If
    '                Next
    '                If CustomerDescCountAfterSixRecords <> 0 Then
    '                    Dim PieChart1 As New PieChart
    '                    PieChart1.value = CustomerDescCountAfterSixRecords
    '                    PieChart1.SuFixSymbol = "%"
    '                    PieChart1.color = GetColorForChart(Count)
    '                    PieChart1.label = "~ Others" + "|" + "$" + CustomerDescCountAfterSixRecordsAmount.ToString("#,##0.00")
    '                    PieChart1.labelColor = "white"
    '                    PieChart1.labelFontSize = "16px"
    '                    PieChartList.Add(PieChart1)
    '                End If
    '                Return PieChartList
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, DistinctCustomerDesc(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetCustomerDescDetailsForChart")
    '        Return Nothing
    '    End Try
    'End Function

    Private Function GetColorForOrderColorChart(colorName As String, Flowercolors As String) As String

        Dim c As System.Drawing.Color = System.Drawing.Color.FromName(colorName)
        Dim RandomColorNameForChart As String = ""
        If c.IsKnownColor Then
            Dim htmlHexColorValueThree As String = [String].Format("#{0:X2}{1:X2}{2:X2}", c.R, c.G, c.B)
            RandomColorNameForChart = htmlHexColorValueThree
        Else

            Dim RandomColor As String = "#00FF40,#5F04B4,#B43104,#DA81F5,#F5BCA9,#FF4000,#01A9DB,#D8F6CE,#A9F5A9,#122A0A"
            Dim colorList() As String = RandomColor.Split(",")
            For cl As Integer = 0 To colorList.Length - 1
                If (Not Flowercolors.Contains(colorList(cl))) Then
                    RandomColorNameForChart = colorList(cl)
                    Return RandomColorNameForChart
                End If
            Next
        End If
        Thread.Sleep(100)
        Return RandomColorNameForChart
    End Function

    Private Function GetColorForChart(ByVal Count As String) As String
        Select Case Count
            Case 0
                Return "blue"
            Case 1
                Return "green"
            Case 2
                Return "orange"
            Case 3
                Return "brown"
            Case 4
                Return "Yellow"
            Case 5
                Return "violet"
            Case 6
                Return "red"
            Case Else
                Return "red"
        End Select
    End Function



    'Public Function GetOrderChart(ByVal Filter As String, ByVal page As Integer, ByVal rp As Integer, ByVal query As String,
    '                                                  ByVal qtype As String) As Object
    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderChart(ByVal Filter As String) As Object ''Modified by Anubhuti 11/11/2022
        Try

            Dim SalesOrderdt As New DataTable()
            'If lReadFromSQL = False Then
            '    Filter = FrameFilterForSalesOrderHeader(Filter).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")
            '    SalesOrderdt = obj.GetSalesForChart(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), page, rp, query, qtype)
            'Else

            Filter = FrameFilterForSalesOrderHeaderSQL(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default)).Replace("A1", "AR").Replace("A2", "AR").Replace("A3", "AR")

            Dim objSales As New SalesOrder.GetSalesOrderHeader
            SalesOrderdt = objSales.GetSalesOrderForChart(Filter, "", "")
            'End If
            If SalesOrderdt.Rows.Count > 0 Then
                'Dim MultipleChartList As Object
                Dim MultipleChartList As New List(Of List(Of PieChart))
                MultipleChartList.Add(GetSalesManChart(SalesOrderdt))
                MultipleChartList.Add(GetCarrierChartByPcs(SalesOrderdt))
                '' MultipleChartList.Add(GetCarrierChartByFBE(SalesOrderdt))
                MultipleChartList.Add(GetStateChartbyBoxes(SalesOrderdt))
                MultipleChartList.Add(GetStateChartbySales(SalesOrderdt))
                MultipleChartList.Add(GetFlowerColorChartbyBoxes(SalesOrderdt))
                MultipleChartList.Add(GetFlowerColorChartbySales(SalesOrderdt))
                MultipleChartList.Add(GetFlowerCatForChart(SalesOrderdt))
                MultipleChartList.Add(GetFlowerDescForChart(SalesOrderdt))
                MultipleChartList.Add(GetCustomerForChart(SalesOrderdt))
                MultipleChartList.Add(GetSalesTypeChart(SalesOrderdt))
                MultipleChartList.Add(GetCarrierChartByFBE(SalesOrderdt))
                Return MultipleChartList
            Else
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderChart")
            Return Nothing
        End Try
    End Function

    Public Function GetSalesTypeChart(SalesOrderdt As DataTable) As List(Of PieChart)
        Try

            Dim GrpQueryForSalesType = From row In SalesOrderdt
                                       Group row By Sales = New With {
                                                Key .SalesType = row.Field(Of String)("Type")
                                         } Into SalesTypeGroup = Group
                                       Select New With {
                                               .SalesType = Sales.SalesType,
                                               .InvAmount = SalesTypeGroup.Sum(Function(r) r.Field(Of Decimal)("INVAMOUNT"))
                                        }
            Dim DistinctSalesByType As DataTable = Flowers.ToDataTable(GrpQueryForSalesType)

            Dim TotalInvAmount As Decimal = 0
            If (DistinctSalesByType.Rows.Count > 0) Then
                DistinctSalesByType.DefaultView.Sort = "INVAMOUNT desc"
                TotalInvAmount = DistinctSalesByType.Compute("Sum(INVAMOUNT)", "")
                DistinctSalesByType = DistinctSalesByType.DefaultView.ToTable()
            End If

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim SalesManCountAfterSixRecords As Integer = 0
            Dim SalesManAfterSixRecords As String
            For Each row In DistinctSalesByType.Rows
                Dim InvAmtPer As Decimal = 0
                If (Convert.ToString(row("INVAMOUNT")) <> "" And TotalInvAmount <> 0) Then
                    InvAmtPer = ((Convert.ToDecimal(row("INVAMOUNT")) / TotalInvAmount) * 100).ToString("#,##0.00")
                End If
                If Count <= 5 Then

                    Dim SalesType = ""
                    If Convert.ToString(row("SalesType")) = "F" Then
                        SalesType = "F-Standing Orders"
                    ElseIf Convert.ToString(row("SalesType")) = "O" Then
                        SalesType = "O-Pre-books"
                    ElseIf Convert.ToString(row("SalesType")) = "I" Then
                        SalesType = "I-Internet"
                    ElseIf Convert.ToString(row("SalesType")) = "N" Then
                        SalesType = "N-Market"
                    ElseIf Convert.ToString(row("SalesType")) = "K" Then
                        SalesType = "K-Miscellaneous"
                    ElseIf Convert.ToString(row("SalesType")) = "P" Then
                        SalesType = "P-Sample"
                    Else
                        SalesType = Convert.ToString(row("SalesType"))
                    End If

                    Dim PieChart As New PieChart
                    PieChart.value = InvAmtPer
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = Convert.ToString(SalesType) + "|" + "$ " + Convert.ToDecimal(row("InvAmount")).ToString("#,##0.00")
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChart.SuFixSymbol = "%"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    SalesManAfterSixRecords = Convert.ToString(row("SalesType"))
                    SalesManCountAfterSixRecords = SalesManCountAfterSixRecords + InvAmtPer
                End If
            Next
            If SalesManCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = SalesManCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "Others"
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChart1.SuFixSymbol = "%"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesManChart")
            Return Nothing
        End Try
    End Function

    Public Function GetSalesManChart(SalesOrderdt As DataTable) As List(Of PieChart)
        Try

            Dim GrpQueryForSalesMan = From row In SalesOrderdt
                                      Group row By SalesMan = New With {
                                                Key .SalesManName = row.Field(Of String)("SalesManName"),
                                                Key .FONTCOLOR = row.Field(Of String)("FONTCOLOR")
                                         } Into SalesManGroup = Group
                                      Select New With {
                                               .SalesManName = SalesMan.SalesManName,
                                               .SalesManColor = SalesMan.FONTCOLOR,
                                               .InvAmount = SalesManGroup.Sum(Function(r) r.Field(Of Decimal)("INVAMOUNT"))
                                        }
            Dim DistinctSalesMan As DataTable = Flowers.ToDataTable(GrpQueryForSalesMan)

            Dim TotalInvAmount As Decimal = 0
            If (DistinctSalesMan.Rows.Count > 0) Then
                DistinctSalesMan.DefaultView.Sort = "INVAMOUNT desc"
                TotalInvAmount = DistinctSalesMan.Compute("Sum(INVAMOUNT)", "")
                DistinctSalesMan = DistinctSalesMan.DefaultView.ToTable()
            End If

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim SalesManCountAfterSixRecords As Integer = 0
            Dim SalesManAfterSixRecords As String
            For Each row In DistinctSalesMan.Rows
                Dim InvAmtPer As Decimal = 0
                If (Convert.ToString(row("INVAMOUNT")) <> "" And TotalInvAmount <> 0) Then
                    InvAmtPer = ((Convert.ToDecimal(row("INVAMOUNT")) / TotalInvAmount) * 100).ToString("#,##0.00")
                End If
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = InvAmtPer
                    PieChart.color = Convert.ToString(row("SalesManColor"))
                    PieChart.label = Convert.ToString(row("SalesManName")) + "|" + "$ " + Convert.ToDecimal(row("InvAmount")).ToString("#,##0.00")
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChart.SuFixSymbol = "%"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    SalesManAfterSixRecords = row("SalesManName")
                    SalesManCountAfterSixRecords = SalesManCountAfterSixRecords + InvAmtPer
                End If
            Next
            If SalesManCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = SalesManCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "Others"
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChart1.SuFixSymbol = "%"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesManChart")
            Return Nothing
        End Try
    End Function


    Private Function GetCarrierChartByFBE(SalesOrderdt As DataTable) As List(Of PieChart)
        Try
            Dim GrpQueryForSalesMan = From row In SalesOrderdt
                                      Group row By Carrier = New With {
                                                Key .Carrier = row.Field(Of String)("Carrier"),
                                                Key .Order = row.Field(Of Integer)("Order")
                                         } Into CarrierGroup = Group
                                      Select New With {
                                               .CarrierCode = Carrier.Carrier,
                                               .FBE = CarrierGroup.Max(Function(r) r.Field(Of Decimal)("FBE"))
                                        }

            Dim DistinctCarrierSalesMan As DataTable = Flowers.ToDataTable(GrpQueryForSalesMan)

            Dim GrpQueryForSalesMan1 = From row In DistinctCarrierSalesMan
                                       Group row By Carrier = New With {
                                                Key .Carrier = row.Field(Of String)("CarrierCode")
                                         } Into CarrierGroup = Group
                                       Select New With {
                                               .CarrierCode = Carrier.Carrier,
                                               .FBE = CarrierGroup.Sum(Function(r) r.Field(Of Decimal)("FBE"))
                                        }

            Dim DistinctCarrierSalesMan1 As DataTable = Flowers.ToDataTable(GrpQueryForSalesMan1)

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim CarrierCountAfterSixRecords As Integer = 0
            Dim CarrierAfterSixRecords As String
            For Each row In DistinctCarrierSalesMan1.Rows
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = Convert.ToDecimal(row("FBE"))
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = Convert.ToString(row("CarrierCode"))
                    PieChart.labelColor = "black"
                    PieChart.labelFontSize = "16px"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    CarrierAfterSixRecords = Convert.ToString(row("CarrierCode"))
                    CarrierCountAfterSixRecords = CarrierCountAfterSixRecords + Convert.ToDecimal(row("FBE")).ToString("#,##0.000")
                End If
            Next
            If CarrierCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = CarrierCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "Others"
                PieChart1.labelColor = "black"
                PieChart1.labelFontSize = "16px"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierChartByFBE")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCarrierChartByPcs(SalesOrderdt As DataTable) As List(Of PieChart)
        Try

            Dim GrpQueryForCarrier = From row In SalesOrderdt
                                     Group row By Carrier = New With {
                                                Key .Carrier = row.Field(Of String)("Carrier")
                                         } Into CarrierGroup = Group
                                     Select New With {
                                               .CarrierCode = Carrier.Carrier,
                                               .Boxes = CarrierGroup.Sum(Function(r) r.Field(Of Decimal)("Boxes"))
                                        }

            Dim DistinctCarrierForBoxes As DataTable = Flowers.ToDataTable(GrpQueryForCarrier)
            If DistinctCarrierForBoxes.Rows.Count > 0 Then
                DistinctCarrierForBoxes.DefaultView.Sort = "BOXES DESC"
                DistinctCarrierForBoxes = DistinctCarrierForBoxes.DefaultView.ToTable()
            End If

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim CarrierCountAfterSixRecords As Integer = 0
            Dim CarrierAfterSixRecords As String
            For Each row In DistinctCarrierForBoxes.Rows
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = row("Boxes")
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = row("CarrierCode")
                    PieChart.labelColor = "black"
                    PieChart.labelFontSize = "16px"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    CarrierAfterSixRecords = row("CarrierCode")
                    CarrierCountAfterSixRecords = CarrierCountAfterSixRecords + row("Boxes")
                End If
            Next
            If CarrierCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = CarrierCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "Others"
                PieChart1.labelColor = "black"
                PieChart1.labelFontSize = "16px"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierChartByPcs")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetStateChartbyBoxes(SalesOrderdt As DataTable) As List(Of PieChart)
        Try
            Dim GrpQueryForState = From row In SalesOrderdt
                                   Group row By State = New With {
                                                Key .State = row.Field(Of String)("State")
                                         } Into StateGroup = Group
                                   Select New With {
                                               .State = State.State,
                                               .Boxes = StateGroup.Sum(Function(r) r.Field(Of Decimal)("Boxes"))
                                        }

            Dim DistinctStateForBoxes As DataTable = Flowers.ToDataTable(GrpQueryForState)
            If DistinctStateForBoxes.Rows.Count > 0 Then
                DistinctStateForBoxes.DefaultView.Sort = "BOXES DESC"
                DistinctStateForBoxes = DistinctStateForBoxes.DefaultView.ToTable()
            End If

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim StateCountAfterSixRecords As Integer = 0
            Dim StateAfterSixRecords As String
            For Each row In DistinctStateForBoxes.Rows
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = row("Boxes")
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = Convert.ToString(row("State"))
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    StateAfterSixRecords = Convert.ToString(row("State"))
                    StateCountAfterSixRecords = StateCountAfterSixRecords + row("Boxes")
                End If
            Next
            If StateCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = StateCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "Others"
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetStateChartbyBoxes")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetStateChartbySales(SalesOrderdt As DataTable) As List(Of PieChart)
        Try
            Dim GrpQueryForState = From row In SalesOrderdt
                                   Group row By State = New With {
                                                Key .State = row.Field(Of String)("State")
                                         } Into StateGroup = Group
                                   Select New With {
                                               .State = State.State,
                                               .INVAMOUNT = StateGroup.Sum(Function(r) r.Field(Of Decimal)("INVAMOUNT"))
                                        }

            Dim DistinctStateForInvoiceAmount As DataTable = Flowers.ToDataTable(GrpQueryForState)
            Dim TotalInvAmount As Decimal = 0

            If DistinctStateForInvoiceAmount.Rows.Count > 0 Then
                DistinctStateForInvoiceAmount.DefaultView.Sort = "INVAMOUNT DESC"
                TotalInvAmount = DistinctStateForInvoiceAmount.Compute("Sum(INVAMOUNT)", "")
                DistinctStateForInvoiceAmount = DistinctStateForInvoiceAmount.DefaultView.ToTable()
            End If


            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim StateCountAfterSixRecords As Integer = 0
            Dim StateAfterSixRecords As String
            For Each row In DistinctStateForInvoiceAmount.Rows
                Dim InvAmtPercent As Decimal = 0
                If (Convert.ToString(row("INVAMOUNT")) <> "" And TotalInvAmount <> 0) Then
                    InvAmtPercent = (Convert.ToDecimal(row("INVAMOUNT")) / TotalInvAmount) * 100
                End If
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = InvAmtPercent.ToString("#,##0.00")
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = Convert.ToString(row("State"))
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChart.SuFixSymbol = "%"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    StateAfterSixRecords = Convert.ToString(row("State"))
                    StateCountAfterSixRecords = StateCountAfterSixRecords + InvAmtPercent.ToString("#,##0.00")
                End If
            Next
            If StateCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = StateCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "Others"
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChart1.SuFixSymbol = "%"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetStateChartbySales")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerColorChartbyBoxes(SalesOrderdt As DataTable) As List(Of PieChart)
        Try


            Dim flowerdt = Flowers.FlowerDetailinSQL()
            Dim query = From ord In SalesOrderdt.AsEnumerable()
                        Join flower In flowerdt.AsEnumerable()
                        On ord.Field(Of String)("flower") Equals
                        flower.Field(Of String)("flower")
                        Select New With
                        {
                        .ColorName = flower.Field(Of String)("ColorName"),
                        .Boxes = Convert.ToInt32(ord.Field(Of Decimal)("Boxes"))
                        }
            SalesOrderdt = New DataTable()
            SalesOrderdt = Flowers.ToDataTable(query)
            Dim DistinctColorNameForBoxes As New DataTable()
            If SalesOrderdt.Rows.Count > 0 Then
                Dim GrpQueryForFLColor = From row In SalesOrderdt
                                         Group row By Color = row.Field(Of String)("ColorName") Into MonthGroup = Group
                                         Select New With {
                                      Key Color,
                                      .BOXCOUNT = MonthGroup.Sum(Function(r) r.Field(Of Int32)("Boxes"))
                                 }

                DistinctColorNameForBoxes = Flowers.ToDataTable(GrpQueryForFLColor)

                If DistinctColorNameForBoxes.Rows.Count > 0 Then
                    DistinctColorNameForBoxes.DefaultView.Sort = "BOXCOUNT DESC"
                    DistinctColorNameForBoxes = DistinctColorNameForBoxes.DefaultView.ToTable()
                End If
            End If



            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim FlowerColorCountAfterSixRecords As Integer = 0
            Dim FlowerColorAfterSixRecords As String
            'Dim Colors = String.Join(",", DistinctFlowerColor.[Select](Function(x) x.DetailsList(0).FlowerDetails.Color.ToUpper()))
            Dim Colors As String = ""
            For Each row In DistinctColorNameForBoxes.Rows
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = row("BOXCOUNT")
                    PieChart.color = GetColorForOrderColorChart(row("Color"), Colors)
                    Colors = Colors + "," + PieChart.color.ToUpper()
                    PieChart.label = row("Color")
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    FlowerColorAfterSixRecords = row("Color")
                    FlowerColorCountAfterSixRecords = FlowerColorCountAfterSixRecords + row("BOXCOUNT")
                End If
            Next
            If FlowerColorCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = FlowerColorCountAfterSixRecords
                PieChart1.color = GetColorForOrderColorChart("Others", Colors)
                PieChart1.label = "Others"
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerColorChartbyBoxes")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerColorChartbySales(SalesOrderdt As DataTable) As List(Of PieChart)
        Try

            Dim flowerdt = Flowers.FlowerDetailinSQL()
            Dim query = From ord In SalesOrderdt.AsEnumerable()
                        Join flower In flowerdt.AsEnumerable()
                        On ord.Field(Of String)("flower") Equals
                        flower.Field(Of String)("flower")
                        Select New With
                        {
                        .ColorName = flower.Field(Of String)("ColorName"),
                        .INVAMOUNT = Convert.ToInt32(ord.Field(Of Decimal)("INVAMOUNT"))
                        }
            SalesOrderdt = New DataTable()
            SalesOrderdt = Flowers.ToDataTable(query)
            Dim DistinctColorNameForSales As New DataTable()
            Dim TotalInvAmount As Decimal = 0
            If SalesOrderdt.Rows.Count > 0 Then
                Dim GrpQueryForFLColor = From row In SalesOrderdt
                                         Group row By Color = row.Field(Of String)("ColorName") Into MonthGroup = Group
                                         Select New With {
                                      Key Color,
                                      .INVAMOUNT = MonthGroup.Sum(Function(r) r.Field(Of Int32)("INVAMOUNT"))
                                 }

                DistinctColorNameForSales = Flowers.ToDataTable(GrpQueryForFLColor)

                If DistinctColorNameForSales.Rows.Count > 0 Then
                    DistinctColorNameForSales.DefaultView.Sort = "INVAMOUNT DESC"
                    TotalInvAmount = DistinctColorNameForSales.Compute("Sum(INVAMOUNT)", "")
                    DistinctColorNameForSales = DistinctColorNameForSales.DefaultView.ToTable()
                End If
            End If


            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim FlowerColorCountAfterSixRecords As Integer = 0
            Dim FlowerColorAfterSixRecords As String
            Dim Colors As String = ""
            For Each row In DistinctColorNameForSales.Rows
                Dim InvAmtPercent As Decimal = 0
                If (Convert.ToString(row("INVAMOUNT")) <> "" And TotalInvAmount <> 0) Then
                    InvAmtPercent = (Convert.ToDecimal(row("INVAMOUNT")) / TotalInvAmount) * 100
                End If
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = InvAmtPercent.ToString("#,##0.00")
                    PieChart.color = GetColorForOrderColorChart(row("Color"), Colors)
                    Colors = Colors + "," + PieChart.color.ToUpper()
                    PieChart.label = row("Color")
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChart.SuFixSymbol = "%"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    FlowerColorAfterSixRecords = row("Color")
                    FlowerColorCountAfterSixRecords = FlowerColorCountAfterSixRecords + InvAmtPercent.ToString("#,##0.00")
                End If
            Next
            If FlowerColorCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = FlowerColorCountAfterSixRecords
                PieChart1.color = GetColorForOrderColorChart("Others", Colors)
                PieChart1.label = "Others"
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChart1.SuFixSymbol = "%"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerColorChartbySales")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerCatForChart(SalesOrderdt As DataTable) As List(Of PieChart)
        Try
            Dim flowerdt = Flowers.FlowerDetailinSQL()
            Dim query = From ord In SalesOrderdt.AsEnumerable()
                        Join flower In flowerdt.AsEnumerable()
                        On ord.Field(Of String)("flower") Equals
                        flower.Field(Of String)("flower")
                        Select New With
                        {
                         .Cat = flower.Field(Of String)("cat")
                        }
            SalesOrderdt = New DataTable()
            SalesOrderdt = Flowers.ToDataTable(query)
            Dim DistinctFlowerCategory As New DataTable()
            If SalesOrderdt.Rows.Count > 0 Then
                Dim GrpQueryForFLCAT = From row In SalesOrderdt
                                       Group row By CAT = row.Field(Of String)("CAT") Into CATGroup = Group
                                       Select New With {
                                      Key CAT,
                                      .FlowerCatCount = CATGroup.Count()
                                 }

                DistinctFlowerCategory = Flowers.ToDataTable(GrpQueryForFLCAT)

                If DistinctFlowerCategory.Rows.Count > 0 Then
                    DistinctFlowerCategory.DefaultView.Sort = "FlowerCatCount DESC"
                    DistinctFlowerCategory = DistinctFlowerCategory.DefaultView.ToTable()
                End If
            End If

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim FlowerCatCountAfterSixRecords As Integer = 0
            Dim FlowerCatAfterSixRecords As String
            For Each row In DistinctFlowerCategory.Rows
                If Count <= 5 Then
                    Dim PieChart As New PieChart
                    PieChart.value = row("FlowerCatCount")
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = row("CAT")
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    FlowerCatAfterSixRecords = row("CAT")
                    FlowerCatCountAfterSixRecords = FlowerCatCountAfterSixRecords + row("FlowerCatCount")
                End If
            Next
            If FlowerCatCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = FlowerCatCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "Others"
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerCatForChart")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerDescForChart(SalesOrderdt As DataTable) As List(Of PieChart)
        Try

            Dim flowerdt = Flowers.FlowerDetailinSQL()
            Dim query = From ord In SalesOrderdt.AsEnumerable()
                        Join flower In flowerdt.AsEnumerable()
                        On ord.Field(Of String)("flower") Equals
                        flower.Field(Of String)("flower")
                        Select New With
                        {
                           .FLOWERDESC = flower.Field(Of String)("Name"),
                           .INVAMOUNT = ord.Field(Of Decimal)("INVAMOUNT"),
                           .Price = ord.Field(Of Decimal)("PRICE")
                        }
            SalesOrderdt = New DataTable()
            SalesOrderdt = Flowers.ToDataTable(query)
            Dim DistinctFlowerDesc As New DataTable()
            If SalesOrderdt.Rows.Count > 0 Then
                Dim GrpQueryForFLDESC = From row In SalesOrderdt
                                        Group row By FLOWERDESC = row.Field(Of String)("FLOWERDESC") Into DescGroup = Group
                                        Select New With {
                                       Key FLOWERDESC,
                                       .DescCOUNT = DescGroup.Count(),
                                       .INVAMOUNT = DescGroup.Sum(Function(r) r.Field(Of Decimal)("INVAMOUNT")),
                                       .Price = DescGroup.Average(Function(r) r.Field(Of Decimal)("PRICE"))
                                 }

                DistinctFlowerDesc = Flowers.ToDataTable(GrpQueryForFLDESC)

                If DistinctFlowerDesc.Rows.Count > 0 Then
                    DistinctFlowerDesc.DefaultView.Sort = "INVAMOUNT DESC"
                    DistinctFlowerDesc = DistinctFlowerDesc.DefaultView.ToTable()
                End If
            End If

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim FlowerDescCountAfterSixRecords As Integer = 0
            Dim FlowerDescAfterSixRecords As String
            Dim FlowerDescCountAfterSixRecordsAmount As Decimal = 0
            Dim AvgPricePerUnit As Decimal = 0
            Dim AvgPricePerUnitAfterSixRecords As Decimal = 0
            For Each row In DistinctFlowerDesc.Rows
                AvgPricePerUnit = Convert.ToDecimal(row("INVAMOUNT")) / row("DescCOUNT")
                If Count <= 19 Then
                    Dim PieChart As New PieChart
                    PieChart.value = row("DescCOUNT")
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = "~ " + row("FLOWERDESC").ToString() + "|" + "$" + Convert.ToDecimal(row("PRICE")).ToString("#,##0.00") + "|" + "$" + Convert.ToDecimal(row("INVAMOUNT")).ToString("#,##0.00")
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    FlowerDescAfterSixRecords = row("FLOWERDESC")
                    FlowerDescCountAfterSixRecords = FlowerDescCountAfterSixRecords + row("DescCOUNT")
                    FlowerDescCountAfterSixRecordsAmount = FlowerDescCountAfterSixRecordsAmount + row("INVAMOUNT")
                    AvgPricePerUnitAfterSixRecords = AvgPricePerUnitAfterSixRecords + Convert.ToDecimal(row("PRICE"))
                End If
            Next
            If FlowerDescCountAfterSixRecords <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = FlowerDescCountAfterSixRecords
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "~ Others" + "|" + "$" + AvgPricePerUnitAfterSixRecords.ToString("#,##0.00") + "|" + "$" + FlowerDescCountAfterSixRecordsAmount.ToString("#,##0.00")
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerDescForChart")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerForChart(SalesOrderdt As DataTable) As List(Of PieChart)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim GrpQueryForCustomer = From row In SalesOrderdt
                                      Group row By Customer = New With {
                                                Key .Customer = row.Field(Of Integer)("Customer"),
                                                Key .CustomerName = row.Field(Of String)("CustomerName")
                                         } Into CustomerGroup = Group
                                      Select New With {
                                               .Customer = Customer.Customer,
                                               .CustomerName = Customer.CustomerName,
                                               .InvAmount = CustomerGroup.Sum(Function(r) r.Field(Of Decimal)("INVAMOUNT"))
                                        }
            Dim DistinctCustomer As DataTable = Flowers.ToDataTable(GrpQueryForCustomer)

            'Dim TotalInvAmount As Decimal = 0
            If (DistinctCustomer.Rows.Count > 0) Then
                DistinctCustomer.DefaultView.Sort = "INVAMOUNT desc"
                'TotalInvAmount = DistinctCustomer.Compute("Sum(INVAMOUNT)", "")
                DistinctCustomer = DistinctCustomer.DefaultView.ToTable()
            End If

            Dim PieChartList As New List(Of PieChart)
            Dim Count As Integer = 0
            Dim CustomerDescCountAfterSixRecords As Integer = 0
            Dim CustomerDescCountAfterSixRecordsAmount As Decimal = 0
            Dim CustomerDescAfterSixRecords As String
            For Each row In DistinctCustomer.Rows
                'Dim InvAmtPer As Decimal = 0
                'If (Convert.ToString(row("INVAMOUNT")) <> "" And TotalInvAmount <> 0) Then
                '    InvAmtPer = ((Convert.ToDecimal(row("INVAMOUNT")) / TotalInvAmount) * 100).ToString("#,##0.00")
                'End If
                If Count <= 19 Then
                    Dim PieChart As New PieChart
                    'PieChart.value = InvAmtPer.ToString("#,##0.00")
                    'PieChart.SuFixSymbol = "%"
                    PieChart.value = 0 'Convert.ToDecimal(row("INVAMOUNT")) '.ToString("#,##0.00")
                    'PieChart.PreFixSymbol = "$"
                    PieChart.color = GetColorForChart(Count)
                    PieChart.label = "~ " + IIf(User.Name.ToLower() = "demo", "XXXXXXXXXXXXXXXXXXXXXXXX", Convert.ToString(row("CustomerName"))) + "|" + "$" + Convert.ToDecimal(row("INVAMOUNT")).ToString("#,##0.00") '+ "|" + "$" + row("InvAmount").ToString()
                    PieChart.labelColor = "white"
                    PieChart.labelFontSize = "16px"
                    PieChartList.Add(PieChart)
                    Count = Count + 1
                Else
                    CustomerDescAfterSixRecords = Convert.ToString(row("CustomerName"))
                    'CustomerDescCountAfterSixRecords = CustomerDescCountAfterSixRecords + InvAmtPer.ToString("#,##0.00")
                    CustomerDescCountAfterSixRecordsAmount = CustomerDescCountAfterSixRecordsAmount + row("INVAMOUNT")
                End If
            Next
            If CustomerDescCountAfterSixRecordsAmount <> 0 Then
                Dim PieChart1 As New PieChart
                PieChart1.value = 0 'CustomerDescCountAfterSixRecordsAmount '.ToString("#,##0.00")
                'PieChart1.SuFixSymbol = "%"
                'PieChart1.PreFixSymbol = "$"
                PieChart1.color = GetColorForChart(Count)
                PieChart1.label = "~ Others" + "|" + "$" + CustomerDescCountAfterSixRecordsAmount.ToString("#,##0.00")
                PieChart1.labelColor = "white"
                PieChart1.labelFontSize = "16px"
                PieChartList.Add(PieChart1)
            End If
            Return PieChartList

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomerForChart")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleOrderSelected(ByVal Selected As String, ByVal ID As String) As String
        Try
            Dim SelectedOrder As New ArrayList
            If Not Session("SelectedOrders") Is Nothing Then
                SelectedOrder = Session("SelectedOrders")
            End If
            Dim Orders = SelectedOrder.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not Orders Is Nothing Then
                If Selected = "0" Then
                    SelectedOrder.Remove(Orders)
                End If
            Else
                If Selected = "1" Then
                    SelectedOrder.Add(ID)
                End If
            End If
            Session("SelectedOrders") = SelectedOrder

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleOrderSelected::PageOrder")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleOrderSelectedAll(ByVal SelectedOrder As String, ByVal Filter As String, ByVal query As String, ByVal qtype As String) As String
        Try
            Filter = FrameFilterForSalesOrderHeader(Filter)
            Dim SelectedOrders As New ArrayList
            Dim data As New ArrayList
            'Dim data = obj.ToggleSelectedAllOrder(HttpUtility.UrlDecode(Filter, System.Text.Encoding.Default), query, qtype)
            If SelectedOrder = "0" Then
                Session("SelectedOrders") = SelectedOrders
            End If
            If SelectedOrder = "1" Then
                For Each obj1 In data
                    SelectedOrders.Add(obj1.Order.ToString())
                Next
                Session("SelectedOrders") = SelectedOrders
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleOrderSelectedAll::PageOrder")
            Return "invalid"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Sub ClearOrderSelectedSession()
        Try
            Dim SelectedOrders As New ArrayList
            Session("SelectedOrders") = SelectedOrders
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearOrderSelectedSession::PageOrder")
        End Try
    End Sub


    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForLadingBillHeaderSQL(ByVal Order As String) As String
        Try
            Dim ResultHeader As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    'Dim data = obj.GetLadingBillHeader(strTest)

                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    data = SalesOrder.GetLadingBillHeaderSQL(strTest)
                    TotalRowCount = data.Count

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim HeaderInfo = New XElement("LadingHeder",
                                From Header In dt.Rows()
                                Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("Consignee", Header.item("Shipto")),
                                New XElement("Address1", Header.item("ShiptoAddress1")),
                                New XElement("Address2", Header.item("ShiptoAddress2")),
                                New XElement("Phone", Header.item("Phone")),
                                New XElement("City", Header.item("ShiptoCity")),
                                New XElement("State", Header.item("ShiptoState")),
                                New XElement("Country", Header.item("Country")),
                                New XElement("zip", Header.item("ShiptoZip")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("DeclaredValue", Header.item("DeclaredValue")),
                                New XElement("Truckdate", Header.item("OrderDate")),
                                New XElement("PO", Header.item("PO")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("WH", Header.item("WH"))))
                            'Return HeaderInfo.ToString()
                            ResultHeader += HeaderInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                data = SalesOrder.GetLadingBillHeaderSQL(Order)
                TotalRowCount = data.Count

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim HeaderInfo = New XElement("LadingHeder",
                             From Header In dt.Rows()
                             Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("Consignee", Header.item("Shipto")),
                                New XElement("Address1", Header.item("ShiptoAddress1")),
                                New XElement("Address2", Header.item("ShiptoAddress2")),
                                New XElement("Phone", Header.item("Phone")),
                                New XElement("City", Header.item("ShiptoCity")),
                                New XElement("State", Header.item("ShiptoState")),
                                New XElement("Country", Header.item("Country")),
                                New XElement("zip", Header.item("ShiptoZip")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("DeclaredValue", Header.item("DeclaredValue")),
                                New XElement("Truckdate", Header.item("OrderDate")),
                                New XElement("PO", Header.item("PO")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("WH", Header.item("WH"))))
                        Return HeaderInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultHeader
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForLadingBillHeaderSQL::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForLadingBillDetailsSQL(ByVal Order As String) As String
        Try
            Dim ResultDetails As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    'Dim data = obj.GetLadingBillDetail(strTest)
                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    'If lReadFromSQL = False Then
                    '    data = obj.GetLadingBillDetail(strTest)
                    '    TotalRowCount = data.Length
                    'Else
                    data = SalesOrder.GetLadingBillDetailSQL(strTest)
                    TotalRowCount = data.Count
                    'End If

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim DetailInfo = New XElement("LadinDetail",
                            From Detail In dt.Rows()
                            Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("GROWER", Detail.item("FarmDetails").FarmCode),
                            New XElement("PRODUCT", Detail.item("FlowerDetails").Name),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("BoxLength", Detail.item("BoxLength")),
                            New XElement("BoxWidth", Detail.item("BoxWidth")),
                            New XElement("BoxHeight", Detail.item("BoxHeight")),
                            New XElement("BOXCODE", Detail.item("BoxCode")),
                            New XElement("Cubes", Detail.item("Cubes")),
                            New XElement("BOXES", Detail.item("Boxes"))))
                            ResultDetails += DetailInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                'If lReadFromSQL = False Then
                '    data = obj.GetLadingBillDetail(Order)
                '    TotalRowCount = data.Length
                'Else
                data = SalesOrder.GetLadingBillDetailSQL(Order)
                TotalRowCount = data.Count
                'End If

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim DetailInfo = New XElement("LadinDetail",
                        From Detail In dt.Rows()
                        Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("GROWER", Detail.item("FarmDetails").FarmCode),
                            New XElement("PRODUCT", Detail.item("FlowerDetails").Name),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("BoxLength", Detail.item("BoxLength")),
                            New XElement("BoxWidth", Detail.item("BoxWidth")),
                            New XElement("BoxHeight", Detail.item("BoxHeight")),
                            New XElement("BOXCODE", Detail.item("BoxCode")),
                            New XElement("Cubes", Detail.item("Cubes")),
                            New XElement("BOXES", Detail.item("Boxes"))))
                        ResultDetails += DetailInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForLadingBillDetailsSQL::PageOrder")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForLadingBillHeaderSQLfromVet(ByVal Order As String) As String
        Try
            Dim ResultHeader As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    'Dim data = obj.GetLadingBillHeader(strTest)

                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    data = SalesOrder.GetLadingBillHeaderSQLfromVet(strTest)
                    TotalRowCount = data.Count

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim HeaderInfo = New XElement("LadingHeder",
                                From Header In dt.Rows()
                                Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("Consignee", Header.item("Shipto")),
                                New XElement("Address1", Header.item("ShiptoAddress1")),
                                New XElement("Address2", Header.item("ShiptoAddress2")),
                                New XElement("Phone", Header.item("Phone")),
                                New XElement("City", Header.item("ShiptoCity")),
                                New XElement("State", Header.item("ShiptoState")),
                                New XElement("Country", Header.item("Country")),
                                New XElement("zip", Header.item("ShiptoZip")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("DeclaredValue", Header.item("DeclaredValue")),
                                New XElement("Truckdate", Header.item("OrderDate")),
                                New XElement("PO", Header.item("PO")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("WH", Header.item("WH"))))
                            'Return HeaderInfo.ToString()
                            ResultHeader += HeaderInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                data = SalesOrder.GetLadingBillHeaderSQLfromVet(Order)
                TotalRowCount = data.Count

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim HeaderInfo = New XElement("LadingHeder",
                             From Header In dt.Rows()
                             Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("Consignee", Header.item("Shipto")),
                                New XElement("Address1", Header.item("ShiptoAddress1")),
                                New XElement("Address2", Header.item("ShiptoAddress2")),
                                New XElement("Phone", Header.item("Phone")),
                                New XElement("City", Header.item("ShiptoCity")),
                                New XElement("State", Header.item("ShiptoState")),
                                New XElement("Country", Header.item("Country")),
                                New XElement("zip", Header.item("ShiptoZip")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("DeclaredValue", Header.item("DeclaredValue")),
                                New XElement("Truckdate", Header.item("OrderDate")),
                                New XElement("PO", Header.item("PO")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("WH", Header.item("WH"))))
                        Return HeaderInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultHeader
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForLadingBillHeaderSQL::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForLadingBillDetailsSQLfromVet(ByVal Order As String) As String
        Try
            Dim ResultDetails As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    'Dim data = obj.GetLadingBillDetail(strTest)
                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    'If lReadFromSQL = False Then
                    '    data = obj.GetLadingBillDetail(strTest)
                    '    TotalRowCount = data.Length
                    'Else
                    data = SalesOrder.GetLadingBillDetailSQLfromVet(strTest)
                    TotalRowCount = data.Count
                    'End If

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim DetailInfo = New XElement("LadinDetail",
                            From Detail In dt.Rows()
                            Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("GROWER", Detail.item("FarmDetails").FarmCode),
                            New XElement("PRODUCT", Detail.item("FlowerDetails").Name),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("BoxLength", Detail.item("BoxLength")),
                            New XElement("BoxWidth", Detail.item("BoxWidth")),
                            New XElement("BoxHeight", Detail.item("BoxHeight")),
                            New XElement("BOXCODE", Detail.item("BoxCode")),
                            New XElement("Cubes", Detail.item("Cubes")),
                            New XElement("BOXES", Detail.item("Boxes"))))
                            ResultDetails += DetailInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                'If lReadFromSQL = False Then
                '    data = obj.GetLadingBillDetail(Order)
                '    TotalRowCount = data.Length
                'Else
                data = SalesOrder.GetLadingBillDetailSQLfromVet(Order)
                TotalRowCount = data.Count
                'End If

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim DetailInfo = New XElement("LadinDetail",
                        From Detail In dt.Rows()
                        Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("GROWER", Detail.item("FarmDetails").FarmCode),
                            New XElement("PRODUCT", Detail.item("FlowerDetails").Name),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("BoxLength", Detail.item("BoxLength")),
                            New XElement("BoxWidth", Detail.item("BoxWidth")),
                            New XElement("BoxHeight", Detail.item("BoxHeight")),
                            New XElement("BOXCODE", Detail.item("BoxCode")),
                            New XElement("Cubes", Detail.item("Cubes")),
                            New XElement("BOXES", Detail.item("Boxes"))))
                        ResultDetails += DetailInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForLadingBillDetailsSQL::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintMultipleladingBill() As String
        Try
            Dim SelectedOrders As New ArrayList
            If Not Session("SelectedOrders") Is Nothing Then
                SelectedOrders = Session("SelectedOrders")
            End If
            If SelectedOrders.Count > 0 Then
                Dim OrderIDs As String = String.Join(",", SelectedOrders.ToArray())
                Return PrintLadingBill(OrderIDs)
            Else
                Return "No Order Found"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintMultipleladingBill::PageOrder")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForPickListHeaderSQL(ByVal Order As String) As String
        Try
            Dim ResultHeader As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())

                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    'If lReadFromSQL = False Then
                    '    data = obj.GetPickListHeader(strTest)
                    '    TotalRowCount = data.Length
                    'Else
                    data = SalesOrder.GetPickListHeaderSQL(strTest)
                    TotalRowCount = data.Count
                    'End If

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                            Dim HeaderInfo = New XElement("PickListHeader",
                                From Header In dt.Rows()
                                Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("Account", Header.item("Customer")),
                                New XElement("BillTo", Header.item("CustomerName")),
                                New XElement("Address1", Header.item("Address1")),
                                New XElement("Address2", Header.item("Address2")),
                                New XElement("Phone", Header.item("Phone")),
                                New XElement("Fax", Header.item("Fax")),
                                New XElement("City", Header.item("City")),
                                New XElement("State", Header.item("State")),
                                New XElement("Country", Header.item("Country")),
                                New XElement("zip", Header.item("Zip")),
                                New XElement("Contact", Header.item("Contact")),
                                New XElement("Shipto", Header.item("Shipto")),
                                New XElement("SalesManName", Header.item("SalesManName")),
                                New XElement("Terms", Header.item("Terms")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("Truckdate", Header.item("OrderDate")),
                                New XElement("PO", Header.item("PO")),
                                New XElement("WH", Header.item("WH")),
                                New XElement("ShiptoAddress", Header.item("ShiptoAddress")),
                                New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                New XElement("ShiptoState", Header.item("ShiptoState")),
                                New XElement("ShiptoZip", Header.item("ShiptoZip")),
                                New XElement("Void", Header.item("VOID")),
                                New XElement("List", Header.item("List"))))
                            ResultHeader += HeaderInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                'If lReadFromSQL = False Then
                '    data = obj.GetPickListHeader(Order)
                '    TotalRowCount = data.Length
                'Else
                data = SalesOrder.GetPickListHeaderSQL(Order)
                TotalRowCount = data.Count
                'End If

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim HeaderInfo = New XElement("PickListHeader",
                                From Header In dt.Rows()
                                Select New XElement("Header", "",
                                New XElement("OrderNo", Header.item("Order").ToString()),
                                New XElement("Account", Header.item("Customer")),
                                New XElement("BillTo", Header.item("CustomerName")),
                                New XElement("Address1", Header.item("Address1")),
                                New XElement("Address2", Header.item("Address2")),
                                New XElement("Phone", Header.item("Phone")),
                                New XElement("Fax", Header.item("Fax")),
                                New XElement("City", Header.item("City")),
                                New XElement("State", Header.item("State")),
                                New XElement("Country", Header.item("Country")),
                                New XElement("zip", Header.item("Zip")),
                                New XElement("Contact", Header.item("Contact")),
                                New XElement("Shipto", Header.item("Shipto")),
                                New XElement("SalesManName", Header.item("SalesManName")),
                                New XElement("Terms", Header.item("Terms")),
                                New XElement("AWB", Header.item("AWB")),
                                New XElement("Carrier", Header.item("Carrier")),
                                New XElement("Truckdate", Header.item("OrderDate")),
                                New XElement("PO", Header.item("PO")),
                                New XElement("WH", Header.item("WH")),
                                New XElement("ShiptoAddress", Header.item("ShiptoAddress")),
                                New XElement("ShiptoCity", Header.item("ShiptoCity")),
                                New XElement("ShiptoState", Header.item("ShiptoState")),
                                New XElement("ShiptoZip", Header.item("ShiptoZip")),
                                New XElement("Void", Header.item("VOID")),
                                New XElement("List", Header.item("List"))))
                        Return HeaderInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultHeader

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForPickListHeaderSQL::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForPickListDetailsSQL(ByVal Order As String) As String
        Try
            Dim ResultDetails As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    'Dim data = obj.GetPickListDetail(strTest)
                    Dim data = Nothing
                    Dim TotalRowCount As Integer = 0
                    'If lReadFromSQL = False Then
                    '    data = obj.GetPickListDetail(strTest)
                    '    TotalRowCount = data.Length
                    'Else
                    data = SalesOrder.GetPickListDetailSQL(strTest)
                    TotalRowCount = data.Count
                    'End If

                    Dim dt As DataTable = ConvertToDataTable(data)
                    If TotalRowCount > 0 Then
                        If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                            Dim DetailInfo = New XElement("PickListDetail",
                            From Detail In dt.Rows()
                            Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("GROWER", Detail.item("FarmDetails").FarmCode),
                            New XElement("PRODUCT", Detail.item("FlowerDetails").Name),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("UNITS", Detail.item("Units")),
                            New XElement("BOXNUM", Detail.item("BoxNum")),
                            New XElement("ARMELLINI", Detail.item("Armellini")),
                            New XElement("AWB", Detail.item("AWB")),
                            New XElement("COLOR", Detail.item("FlowerDetails").Color),
                            New XElement("BoxLength", Detail.item("BoxLength")),
                            New XElement("BoxWidth", Detail.item("BoxWidth")),
                            New XElement("BoxHeight", Detail.item("BoxHeight")),
                            New XElement("BOXES", Detail.item("Boxes")),
                            New XElement("CUBES", Detail.item("Cubes")),
                            New XElement("PICKREMARK", Detail.item("PickRemark")),
                            New XElement("FBE", Detail.item("FBE")),
                            New XElement("BoxCode", Detail.item("BoxCode")),
                            New XElement("UPC", Detail.item("UPC")),
                            New XElement("DATEREC", Detail.item("DateRec"))))
                            ResultDetails += DetailInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = Nothing
                Dim TotalRowCount As Integer = 0
                'If lReadFromSQL = False Then
                '    data = obj.GetPickListDetail(Order)
                '    TotalRowCount = data.Length
                'Else
                data = SalesOrder.GetPickListDetailSQL(Order)
                TotalRowCount = data.Count
                'End If

                Dim dt As DataTable = ConvertToDataTable(data)
                If TotalRowCount > 0 Then
                    If dt(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim DetailInfo = New XElement("PickListDetail",
                        From Detail In dt.Rows()
                        Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.item("Order").ToString()),
                            New XElement("GROWER", Detail.item("FarmDetails").FarmCode),
                            New XElement("PRODUCT", Detail.item("FlowerDetails").Name),
                            New XElement("UOM", Detail.item("UOM")),
                            New XElement("UNITS", Detail.item("Units")),
                            New XElement("BOXNUM", Detail.item("BoxNum")),
                            New XElement("ARMELLINI", Detail.item("Armellini")),
                            New XElement("AWB", Detail.item("AWB")),
                            New XElement("COLOR", Detail.item("FlowerDetails").Color),
                            New XElement("BoxLength", Detail.item("BoxLength")),
                            New XElement("BoxWidth", Detail.item("BoxWidth")),
                            New XElement("BoxHeight", Detail.item("BoxHeight")),
                            New XElement("BOXES", Detail.item("Boxes")),
                            New XElement("CUBES", Detail.item("Cubes")),
                            New XElement("PICKREMARK", Detail.item("PickRemark")),
                            New XElement("FBE", Detail.item("FBE")),
                            New XElement("BoxCode", Detail.item("BoxCode")),
                            New XElement("UPC", Detail.item("UPC")),
                            New XElement("DATEREC", Detail.item("DateRec"))))
                        Return DetailInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForPickListDetailsSQL::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintMultiplePickList() As String
        Try
            Dim SelectedOrders As New ArrayList
            If Not Session("SelectedOrders") Is Nothing Then
                SelectedOrders = Session("SelectedOrders")
            End If
            If SelectedOrders.Count > 0 Then
                Dim OrderIDs As String = String.Join(",", SelectedOrders.ToArray())
                Return PrintPickList(OrderIDs)
            Else
                Return "No Order Found"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintMultiplePickList::PageOrder")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' Muthu Nivetha M : 13 Mar 19 : For hold tickets restrictions
    ''' Muthu Nivetha M :: 17Feb2020 :: Modified :: To add Dimensions on Orderdetails grid
    ''' Muthu Nivetha M :: 06Mar2020 :: Modified :: To add a hyperlink on the invoice#
    ''' Muthu Nivetha M :: 11Mar2020 :: Modified :: To show only the rows that awb AWB>0 in OrderDetails on Sales
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal OrderNo As String, ByVal ExportCSV As String, ByVal Exclude As String, ByVal iscalledFromPage As String) As XmlDocument
        Try
            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If User.UserType = "Sales Person" Then
                Filter += IIf(Filter <> "", "And SALESMAN=" + User.SalesPerson, "SALESMAN=" + User.SalesPerson)
            End If
            Dim whereCondition As String = ""
            Dim whereAWBCond As String = ""
            whereAWBCond = (IIf(iscalledFromPage <> "", IIf(iscalledFromPage.ToLower() = "PageOrderAll".ToLower(), " AND AWB>0 ", ""), ""))
            If OrderNo <> "" Then
                'If lReadFromSQL = False Then
                '    whereCondition = "Order=" + OrderNo + "" + whereAWBCond
                'Else
                whereCondition = "[Order]=" + OrderNo + "" + whereAWBCond
                'End If
            Else
                If (Filter <> "") Then
                    whereCondition = "Type <> 'K' AND void=0 " + whereAWBCond + Filter + ""
                Else
                    whereCondition = "Type <> 'K' And void=0 " + whereAWBCond
                End If
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1
            If (page <= 0) Then
                rp = 0
                start = 0
            End If
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim TotalRowCount As Integer = 0
                Dim data = Nothing
                data = SalesOrder.GetSalesOrderDetailsList(whereCondition, "ORDER BY Flower, SQLID asc", start, rp, User.ID)
                TotalRowCount = data.count
                'End If
                If TotalRowCount > 0 Then
                    Dim dt1 As DataTable = ConvertToDataTable(data)
                    If dt1(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then
                        Dim selectedColumns As String() =
                                    {"Order", "ShippingDate", "CustCode", "CustName", "Flower", "Name", "SLSMAN", "FarmCode", "AWB", "Boxes", "UOM", "FBE", "Units", "TotalUnits", "Price",
                                     "Cost", "Type", "gpm", "BoxNum", "BoxCode", "UPC", "PODFlower"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("ShippingDate").ColumnName = "Date"
                        dt.Columns("Order").ColumnName = "INV#"
                        dt.Columns("CustCode").ColumnName = "CUST#"
                        dt.Columns("CustName").ColumnName = "Customer"
                        dt.Columns("GPM").ColumnName = "%GPM"
                        dt.Columns("SLSMAN").ColumnName = "SLS"
                        dt.Columns("Name").ColumnName = "Description"
                        dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        dtCloned.Columns("Date").DataType = GetType(String)
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)
                    Else
                        ' Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt1(TotalRowCount - 1)("ErrorMessage").ToString(), "", "Error Notification", "Error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please Try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else
                Dim data = Nothing
                Dim isEXTRAFIELD As String = "S"
                '27 Mar 19 :: Muthu Nivetha M ::  On invoice show if line is a substitute     
                data = SalesOrder.GetSalesOrderDetailsList(whereCondition, "ORDER BY Flower,SQLID asc", start, rp)
                'data = SalesOrder.GetSalesOrderDetailsList(whereCondition, sortExp, start, rp)
                Dim dt As DataTable = ConvertToDataTable(data)
                If dt.Rows.Count > 0 Then
                    If dt(0)("ErrorMessage").ToString() = "" Then
                        Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                        Dim TotalRowCount As Integer = 0
                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If
                        'Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        'Dim FlowerColorVisibility As Boolean = False
                        'For Each i In UserFeatures
                        '    If i.Name.ToLower = "show flower color" Then
                        '        FlowerColorVisibility = i.Value
                        '    End If
                        'Next
                        'New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("BGColor").ToString() + "' class='flowerDescription'><a title='" + row("Flower") + "' id='OrderDetailName_" & Convert.ToString(row("ID")) & "' style='color:" + row("FontColor").ToString() + ";'>" + row("Name") + "</a></div>", "<a >" + row("Name") + "</a>")),

                        '27 Mar 19 :: Muthu Nivetha M ::  On invoice show if line is a substitute :: Starts
                        '20 Mar 19 :: Muthu Nivetha M :: HOLD Tickets :: Starts
                        Dim breakdown = Function(ByVal row As DataRow) As String
                                            If row("Breakdown") Is DBNull.Value Then
                                                Return ""
                                            End If

                                            If String.IsNullOrEmpty(row("Breakdown")) Then
                                                Return ""
                                            End If
                                            Return "<img src='images/star.png' width='10' height='10'>"
                                        End Function

                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                       From row In dt.Rows()
                       Select
                       New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("color", ""),
                       New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='OrderDetailselect_" & Convert.ToString(row("ID")) & "' src='images/check-off.png' />")),
                       New XElement("cell", "<img href='#'  id='OrderDetailDelete_" & Convert.ToString(row("ID")) & "~" & row("Farmcode") & "' src='images/Delete-icon.png' style='cursor:pointer'/>"),
                       New XElement("cell", "<img href='#'  id='OrderDetailEdit_" & Convert.ToString(row("ID")) & "~" & row("Farmcode") & "' src='images/Edit.png' style='cursor:pointer'/>"),
                       New XElement("cell", "<a href='#'  title='Credits' id='credit_" & IIf(row("ID") = 0, "", row("ID").ToString()) & "'  style='cursor:pointer;'><img src='images/FACE03.png' style='width: 21px;height: 17px;margin-left: -3px;'/></a>"),
                       New XElement("cell", row("ID")),
                       New XElement("cell", IIf(row("Order") = "0", "", "<a id=OrderDetailINV_" + Convert.ToString(row("ID")) + " style='text-decoration:underline;cursor:pointer;margin-left:-4px;'>" + Convert.ToString(row("Order")) + "</a>")),
                       New XElement("cell", If(row("ShippingDate") = Convert.ToDateTime("01/01/1900"), "", Convert.ToDateTime(row("ShippingDate")).ToString("MM/dd/yyyy"))),
                       New XElement("cell", "<a id='OrderDetailCustCode_" & Convert.ToString(row("ID")) & "' >" + IIf(row("CustCode") = "0", "", row("CustCode").ToString()) + "</a>"),
                       New XElement("cell", "<span id='OrderDetailCustName_" & Convert.ToString(row("ID")) & "' >" & IIf(User.Name.ToLower() = "demo", "XXXXXXXXXXXXXXXXXXXXXXXX", IIf(row("CustName") = "", "", row("CustName"))) & "</span>"),
                       New XElement("cell", IIf(row("ID") = 0, "", "<span style='font-weight: bold;padding: 6px 20px;margin-left: -15px; " + ChangeBgColorBasedOnSalesOrderStatus(row("Farmcode"), row("awb"), row("PODFlower"), If(row("Status") Is DBNull.Value, "", row("Status")), row("InvenType")) + "'>" + row("InvenType") + "</span>")),
                       New XElement("cell", IIf(row("EXTRAFIELD").ToString().ToUpper() = isEXTRAFIELD, "<div style='padding: 0;color:red;'>" + row("Flower") + "</div>", row("Flower"))),
                       New XElement("cell", "<div style='padding-bottom: 3px;background-color:" + row("BGColor").ToString() + "' class='flowerDescription'><a title='" + row("Breakdown") + "' id='OrderDetailName_" & Convert.ToString(row("ID")) & "' style='color:" + row("FontColor").ToString() + ";'>" + breakdown(row) + row("Name") + "</a></div>"),
                       New XElement("cell", IIf(row("FarmCode") = "ZZ", "", row("FarmCode"))),
                       New XElement("cell", IIf(row("ID") = 0 Or row("FarmCode") = "ZZ", "", If(Convert.ToString(row("AWB")) = 0, IIf(CompanyName.Contains("BloomsUSA"), "", Convert.ToDateTime(row("Daterec")).ToString("MM/dd")), If(row("AWB").ToString().Length <= 3, row("AWB"), row("AWB").ToString().Substring(If(row("AWB") = 0, 0, row("AWB").ToString().Length - 4)))))),
                       New XElement("cell", "<a class='OrderCalculation' id='OrderDetailBoxes_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("Boxes1")) + "</a>"),
                       New XElement("cell", "<a id='OrderDetailUOM_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("UOM")) + "</a>"),
                       New XElement("cell", IIf(Convert.ToString(row("FBE")) = "0", "", Convert.ToDecimal(row("FBE")).ToString("#,##0.000"))),
                       New XElement("cell", "<a id='OrderDetailUnits_" & Convert.ToString(row("ID")) & "' >" + IIf(Convert.ToString(row("Units")) = "0", "", Convert.ToString(row("Units"))) + "</a>"),
                       New XElement("cell", IIf(Convert.ToString(row("UnitsBunch")) = "0", "", row("UnitsBunch"))),
                       New XElement("cell", IIf(Convert.ToString(row("TotalUnits1")) = "0", "", Convert.ToInt32(row("TotalUnits1")).ToString("#,#"))),
                       New XElement("cell", IIf(Convert.ToString(row("FOB")) = "0", "", Convert.ToDecimal(row("FOB")).ToString("#,##0.000"))),
                       New XElement("cell", IIf(row("TotPerLine") = "0", If(row("ID") = 0, Convert.ToDecimal(row("GrandTotal")).ToString("#,##0.00"), "0"), If(row("ID") = 0, Convert.ToDecimal(row("GrandTotal")).ToString("#,##0.00"), Convert.ToDecimal(row("TotPerLine")).ToString("#,##0.00")))),
                       New XElement("cell", IIf(Convert.ToDecimal(row("TotalCost")).ToString("#,##0.00") = "0.00", "", Convert.ToDecimal(row("TotalCost")).ToString("#,##0.00"))),
                       New XElement("cell", "<a id='OrderDetailType_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("Type")) + "</a>"),
                       New XElement("cell", IIf(Convert.ToString(row("gpm")) = "0", "", "<a href='#'  title='Cost: " + Convert.ToString(Convert.ToDecimal(row("Cost")).ToString("#,##0.00")) + " Freight: " + Convert.ToString(Convert.ToDecimal(row("Othercost")).ToString("#,##0.00")) + " Handling: " + Convert.ToString(Convert.ToDecimal(row("Handling")).ToString("#,##0.00")) + " Landedcost: " + Convert.ToString(Convert.ToDecimal(row("Landedcost")).ToString("#,##0.00")) + " Duties: " + Convert.ToString(Convert.ToDecimal(row("ANDEAN")).ToString("#,##0.00")) + " Freight Out: " + Convert.ToString(Convert.ToDecimal(row("Freightout")).ToString("#,##0.00")) + "'>" + Convert.ToDecimal(row("gpm")).ToString("#,##0.0") + "%") + "</a>"),
                       New XElement("cell", IIf(row("BoxNum") = "0", "", row("BoxNum"))),
                       New XElement("cell", row("BoxCode")),
                       New XElement("cell", IIf(row("UPC") = "0", "", row("UPC"))),
                       New XElement("cell", "<span style='font-weight: bold;padding: 6px 20px;margin-left: -15px; " + ChangeBgColorBasedOnPurchaseOrderStatus(If(row("Status") Is DBNull.Value, "", row("Status")), 0) + "'><a title='Status: " + If(row("Status") Is DBNull.Value, "", row("Status")) + ", Farm ShipDate: " + If(row("SHIPDATE") Is DBNull.Value, "", row("SHIPDATE")) + "' id='OrderDetailPODflower_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("PODFlower")) + "</a></span>"),
                       New XElement("cell", IIf(row("BoxLength") = "0" Or row("BoxWidth") = "0" Or row("BoxHeight") = "0", "<a style='background-color:red;' id='OrderDetailDimensions_" & Convert.ToString(row("ID")) & "' >" + row("Dimensions") + "</a>", "<a id='OrderDetailDimensions_" & Convert.ToString(row("ID")) & "' >" + row("Dimensions") + "</a>")),
                       New XElement("cell", "<a id='OrderDetailInvenId_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("InvenID")) + "</a>"),
                       New XElement("cell", row("Retail")),
                       New XElement("cell", "<a id='NewOrderDetailAWB_" & Convert.ToString(row("ID")) & "' >" + If(Convert.ToString(row("AWB")) = 0, If(row("ID") = 0, "", ""), If(row("AWB").ToString().Length <= 3, row("AWB"), row("AWB").ToString().Substring(If(row("AWB") = 0, 0, row("AWB").ToString().Length - 4)))) + "</a>"),
                       New XElement("cell", row("days")),
                       New XElement("cell", row("Breakdown")),
                       New XElement("cell", "<a href='#' id='NewOrderDetailOlderBox_" & Convert.ToString(row("ID")) & "' style='display: block;'>" & row("BoxesAvailable") & "</a>"))))
                        ' New XElement("cell", Row("Breakdown"))

                        'New XElement("cell", IIf(row("Boxes = "0", "", Convert.ToInt32(row("Boxes))),
                        '  New XElement("cell", IIf(row.Price = "0", "", row.Price.ToString("#,##0.000"))),
                        'New XElement("cell", IIf(row.Cost = "0", "", row.Cost.ToString("#,##0.000"))),
                        ' ,
                        'New XElement("cell", "<a class='OrderCalculation' id='OrderDetailBoxes_" & Convert.ToString(row("ID")) & "' >" + IIf(Convert.ToString(row("Boxes1")) = "0", "", Convert.ToString(row("Boxes1"))) + "</a>")
                        '20 Mar 19 :: Muthu Nivetha M :: HOLD Tickets :: Starts
                        '27 Mar 19 :: Muthu Nivetha M ::  On invoice show if line is a substitute :: Ends

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Dim idx As Integer = dt.Rows.Count - 1
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = "Totals"
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(31).InnerText = ""
                        Return newDoc
                    Else
                        'Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderDetailsList::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderCallHSList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal OrderNo As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            If OrderNo = "" Then
                Dim whereCondition As String = ""
                If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                    whereCondition = BuildWhereCondition(GetType(BO.SalesHeader), qtype, query)
                End If
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
                whereCondition = whereCondition.Replace("&lt;&gt;", "<>")

                Dim sortExp As String = sortname & " " & sortorder
                Dim start As Integer = ((page - 1) * rp) + 1
                rp -= 1

                Dim obj As New SalesOrder.GetSalesOrderHeader

                If (ExportCSV <> "") Then

                    Dim splitExportcsv = ExportCSV.Split("|")

                    Dim data As List(Of BO.SalesCallHS) = obj.GetSalesCallHSList(whereCondition, sortExp, start, splitExportcsv(2))

                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)
                    Dim selectedColumns As String() =
                        {"Customer", "CallHS_Date", "CallHS_Time", "Person", "Note"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("CallHS_Date").ColumnName = "Date"
                    dt.Columns("CallHS_Time").ColumnName = "Time"
                    'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    dtCloned.Columns("Date").DataType = GetType(String)
                    dtCloned.Columns("Time").DataType = GetType(String)
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                    Return BuildXmlDoc(filepath)

                Else
                    Dim data As List(Of BO.SalesCallHS) = obj.GetSalesCallHSList(whereCondition, sortExp, start, rp)

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", obj.TotalRows.ToString()),
                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.CUSTOMER.ToString()), New XAttribute("background-color", ""), New XAttribute("color", ""),
                            New XElement("cell", IIf(row.CUSTOMER.ToString() = "0", "", row.CUSTOMER.ToString())),
                            New XElement("cell", If(row.CallHS_DATE = Convert.ToDateTime("01/01/1900"), "", row.CallHS_DATE.ToString("MM/dd/yyyy"))),
                            New XElement("cell", IIf(row.CallHS_TIME = "0", "", row.CallHS_TIME)),
                            New XElement("cell", IIf(row.PERSON = "", "", row.PERSON)),
                            New XElement("cell", IIf(row.NOTE = "", "", row.NOTE))))))

                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Return newDoc
                End If


            Else
                Dim data = Nothing
                If (ExportCSV <> "") Then

                    Dim splitExportcsv = ExportCSV.Split("|")

                    'Dim data = obj.GetSalesCallHS_FG(page, splitExportcsv(2), "CallHS_Date asc", sortorder, query, qtype, Filter, "", IIf(OrderNo.Trim().Length < 7, "history\" + ConfigurationManager.AppSettings.Item("CALLHS").ToString() + OrderNo.ToString().PadLeft(7, "0"), "history\" + ConfigurationManager.AppSettings.Item("CALLHS").ToString() + OrderNo))
                    data = SalesOrder.GetInvoiceHistory(OrderNo)


                    If data.Length > 0 Then

                        If data(0).ErrorMessage = "" Then

                            Dim dt1 As DataTable

                            dt1 = ConvertToDataTable(data)
                            Dim selectedColumns As String() =
                                {"Customer", "CallHS_Date", "CallHS_Time", "Person", "Note"}

                            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                            dt.Columns("CallHS_Date").ColumnName = "Date"
                            dt.Columns("CallHS_Time").ColumnName = "Time"
                            'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                            Dim dtCloned As DataTable = dt.Clone()
                            dtCloned.Columns("Date").DataType = GetType(String)
                            dtCloned.Columns("Time").DataType = GetType(String)
                            For Each row As DataRow In dt.Rows
                                dtCloned.ImportRow(row)
                            Next
                            Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                            Return BuildXmlDoc(filepath)

                        Else

                            If data(0).ErrorMessage.Contains("does not exist") Then
                                Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                            Else
                                Dim User As New User
                                If Not Session("LoginUserDetails") Is Nothing Then
                                    User = Session("LoginUserDetails")
                                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                    User = Session("LoginAdminDetails")
                                End If
                                Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                                Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                            End If

                        End If
                    Else
                        Return Nothing
                    End If
                Else
                    Dim ordernumlen As String = OrderNo.Trim().Length
                    Dim callhs As String = IIf(OrderNo.Trim().Length < 7, "history\" + ConfigurationManager.AppSettings.Item("CALLHS").ToString() + OrderNo.ToString().PadLeft(7, "0"), "history\" + ConfigurationManager.AppSettings.Item("CALLHS").ToString() + OrderNo)




                    Dim TotalRowCount As Integer = 0
                    'If lReadFromSQL = False Then
                    '    data = obj.GetSalesCallHS_FG(page, rp, "CallHS_Date asc", sortorder, query, qtype, Filter, "", IIf(OrderNo.Trim().Length < 7, "history\" + ConfigurationManager.AppSettings.Item("CALLHS").ToString() + OrderNo.ToString().PadLeft(7, "0"), "history\" + ConfigurationManager.AppSettings.Item("CALLHS").ToString() + OrderNo))
                    '    TotalRowCount = data.length
                    'Else
                    data = SalesOrder.GetInvoiceHistory(OrderNo)
                    TotalRowCount = data.count
                    'End If

                    Dim dt As DataTable = ConvertToDataTable(data)



                    If TotalRowCount > 0 Then

                        If data(0).ErrorMessage = "" Then


                            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", TotalRowCount),
                            From row In dt.Rows()
                            Select New XElement("row", New XAttribute("id", "1"), New XAttribute("background-color", ""), New XAttribute("color", ""),
                            New XElement("cell", IIf(row("Customer").ToString() = "0", "", row("Customer").ToString())),
                            New XElement("cell", If(row("CallHS_Date") = Convert.ToDateTime("01/01/1900"), "", Convert.ToDateTime(row("CallHS_Date")).ToString("MM/dd/yyyy hh:mm:ss"))),
                            New XElement("cell", IIf(row("CallHS_Time") = "0", "", row("CallHS_Time"))),
                            New XElement("cell", IIf(row("Person") = "", "", row("Person"))),
                            New XElement("cell", IIf(row("Note") = "", "", row("Note"))))))
                            Dim newDoc As New XmlDocument()
                            newDoc.LoadXml(Convert.ToString(xmlDoc))
                            Return newDoc
                        Else

                            If data(0).ErrorMessage.Contains("does Not exist") Then
                                Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                            Else
                                Dim User As New User
                                If Not Session("LoginUserDetails") Is Nothing Then
                                    User = Session("LoginUserDetails")
                                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                    User = Session("LoginAdminDetails")
                                End If
                                Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                                Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                            End If

                        End If
                    Else
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                           New XElement("rows", New XElement("page", page.ToString()),
                           New XElement("total", TotalRowCount),
                           From row In dt.Rows()
                           Select New XElement("row", New XAttribute("id", "1"), New XAttribute("background-color", ""), New XAttribute("color", ""),
                           New XElement("cell", IIf(row("Customer").ToString() = "0", "", row("Customer").ToString())),
                           New XElement("cell", If(row("CallHS_Date") = Convert.ToDateTime("01/01/1900"), "", Convert.ToDateTime(row("CallHS_Date")).ToString("MM/dd/yyyy"))),
                           New XElement("cell", IIf(row("CallHS_Time") = "0", "", row("CallHS_Time"))),
                           New XElement("cell", IIf(row("Person") = "", "", row("Person"))),
                           New XElement("cell", IIf(row("Note") = "", "", row("Note"))))))
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Return newDoc
                    End If
                End If
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetSalesOrderCallHSList()::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckAccountNoForARShippingLabel() As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Return SalesOrder.CheckAccountNoForARShippingLabel(User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckAccountNoForARShippingLabel::PageOrder")
            Return Nothing
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    '<ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    'Public Function GetSalesOrderSummaryList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    'ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String, ByVal Exclude As String) As XmlDocument

    '    Try

    '        If qtype.ToLower() = "lot" Then
    '            query = Regex.Replace(query, "[-]", "")
    '        End If

    '        If (ExportCSV <> "") Then

    '            Dim splitExportcsv = ExportCSV.Split("|")

    '            Dim data = obj.GetSalesSummary_FG(page, splitExportcsv(2), sortname, sortorder, query, qtype, Filter, "", Exclude)
    '            If data.Length > 0 Then

    '                If data(0).ErrorMessage = "" Then
    '                    Dim dt1 As DataTable

    '                    dt1 = ConvertToDataTable(data)
    '                    Dim selectedColumns As String() =
    '                        {"SALESMAN", "SalesManName", "Boxes", "SALES", "PROFIT", "gpm", "C", "I", "INV", "FBE"}

    '                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
    '                    dt.Columns("SALESMAN").ColumnName = "SLS#"
    '                    dt.Columns("SalesManName").ColumnName = "Sales Person"
    '                    dt.Columns("Boxes").ColumnName = "Boxes"
    '                    dt.Columns("SALES").ColumnName = "SALES"
    '                    dt.Columns("PROFIT").ColumnName = "PROFIT"
    '                    dt.Columns("gpm").ColumnName = "GPM%"
    '                    dt.Columns("C").ColumnName = "C"
    '                    dt.Columns("I").ColumnName = "I"
    '                    dt.Columns("INV").ColumnName = "$/INV"
    '                    dt.Columns("FBE").ColumnName = "$/FBE"

    '                    'dt.Rows.RemoveAt(dt.Rows.Count - 1)
    '                    Dim dtCloned As DataTable = dt.Clone()
    '                    dtCloned.Columns("Sales Person").DataType = GetType(String)
    '                    For Each row As DataRow In dt.Rows
    '                        dtCloned.ImportRow(row)
    '                    Next
    '                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
    '                    Return BuildXmlDoc(filepath)

    '                Else
    '                    Dim User As New User
    '                    If Not Session("LoginUserDetails") Is Nothing Then
    '                        User = Session("LoginUserDetails")
    '                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                        User = Session("LoginAdminDetails")
    '                    End If
    '                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
    '                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
    '                End If
    '            Else
    '                Return Nothing
    '            End If
    '        Else

    '            Dim data = obj.GetSalesSummary_FG(page, rp, sortname, sortorder, query, qtype, Filter, "", Exclude)
    '            If data.Length > 0 Then

    '                If data(0).ErrorMessage = "" Then

    '                    Dim SelectedPOs As New ArrayList
    '                    Dim TotalRowCount As Integer = 0

    '                    If data.Length > 0 Then
    '                        TotalRowCount = data(0).TotalRows.ToString()
    '                    End If

    '                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
    '                     New XElement("rows", New XElement("page", page.ToString()),
    '                     New XElement("total", If(data(0).TotalRows.ToString() = "0", "1", data(0).TotalRows.ToString())),
    '                     data.Select(Function(row) New XElement("row", New XAttribute("id", row.SALESMAN.ToString()), New XAttribute("background-color", ""), New XAttribute("color", ""),
    '                     New XElement("cell", IIf(row.SALESMAN.ToString() = "", "", row.SALESMAN.ToString())),
    '                     New XElement("cell", IIf(row.SalesManName.ToString() = "", "", row.SalesManName.ToString())),
    '                     New XElement("cell", row.Boxes),
    '                     New XElement("cell", row.SALES.ToString("#,##0.00")),
    '                     New XElement("cell", row.PROFIT.ToString("#,##0.00")),
    '                     New XElement("cell", row.gpm),
    '                     New XElement("cell", row.C),
    '                     New XElement("cell", row.I),
    '                     New XElement("cell", row.INV.ToString("#,##0.00")),
    '                     New XElement("cell", row.FBE.ToString("#,##0.00"))))))
    '                    Dim newDoc As New XmlDocument()
    '                    newDoc.LoadXml(Convert.ToString(xmlDoc))

    '                    Dim idx As Integer = data.Count - 1


    '                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
    '                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Totals"
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
    '                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""

    '                    Return newDoc
    '                Else
    '                    If data(0).ErrorMessage.Contains("does not exist") Then
    '                        Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
    '                    Else
    '                        Dim User As New User
    '                        If Not Session("LoginUserDetails") Is Nothing Then
    '                            User = Session("LoginUserDetails")
    '                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                            User = Session("LoginAdminDetails")
    '                        End If
    '                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
    '                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
    '                    End If
    '                End If
    '            Else

    '                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
    '                 New XElement("rows", New XElement("page", page.ToString()),
    '                 New XElement("total", data.Length),
    '                 data.Select(Function(row) New XElement("row", New XAttribute("id", ""), New XAttribute("background-color", ""), New XAttribute("color", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", ""),
    '                 New XElement("cell", "")))))
    '                Dim newDoc As New XmlDocument()
    '                newDoc.LoadXml(Convert.ToString(xmlDoc))
    '                Return newDoc
    '                'Return Nothing
    '            End If
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderSummaryList::PageOrderSummary")
    '        Return Nothing
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderSummaryListSQL(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String, ByVal Exclude As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.SalesHeader), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
            End If

            whereCondition = whereCondition.Replace("&lt;&gt;", "<>")
            whereCondition = whereCondition.Replace("&lt;", "<")
            whereCondition = whereCondition.Replace("&gt;", ">")

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing

                'If lReadFromSQL = False Then
                '    data = obj.GetSalesSummary_FG(page, rp, sortname, sortorder, query, qtype, Filter, "", Exclude)
                'Else
                'data = SalesOrder.GetSalesOrderDetailsList(If(OrderNo <> "", "[Order]=" + OrderNo, ""), "", 0, 0)
                data = SalesOrder.GetSalesOrderSummaryListSQL(whereCondition, sortExp, start, rp, "")
                'End If
                Dim dt1 As DataTable = ConvertToDataTable(data)

                If dt1.Rows.Count > 0 Then
                    If dt1(0)("ErrorMessage").ToString() = "" Then
                        Dim selectedColumns As String() =
                            {"SALESMAN", "SalesManName", "Boxes", "SALES", "PROFIT", "gpm", "C", "I", "INV", "FBE"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("SALESMAN").ColumnName = "SLS#"
                        dt.Columns("SalesManName").ColumnName = "Sales Person"
                        dt.Columns("Boxes").ColumnName = "Boxes"
                        dt.Columns("SALES").ColumnName = "SALES"
                        dt.Columns("PROFIT").ColumnName = "PROFIT"
                        dt.Columns("gpm").ColumnName = "GPM%"
                        dt.Columns("C").ColumnName = "C"
                        dt.Columns("I").ColumnName = "I"
                        dt.Columns("INV").ColumnName = "$/INV"
                        dt.Columns("FBE").ColumnName = "$/FBE"

                        'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        dtCloned.Columns("Sales Person").DataType = GetType(String)
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)

                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else

                Dim data = Nothing

                'If lReadFromSQL = False Then
                '    data = obj.GetSalesSummary_FG(page, rp, sortname, sortorder, query, qtype, Filter, "", Exclude)
                'Else
                data = SalesOrder.GetSalesOrderSummaryListSQL(whereCondition, sortExp, start, rp, "")
                'End If
                Dim dt As DataTable = ConvertToDataTable(data)

                If dt.Rows.Count > 0 Then

                    If dt(0)("ErrorMessage").ToString() = "" Then

                        Dim TotalRowCount As Integer = 0

                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                         New XElement("rows", New XElement("page", page.ToString()),
                         New XElement("total", TotalRowCount),
                         From row In dt.Rows()
                         Select New XElement("row", New XAttribute("id", row.item("SALESMAN").ToString()), New XAttribute("background-color", ""), New XAttribute("color", ""),
                         New XElement("cell", IIf(row.item("SALESMAN").ToString() = "", "", row.item("SALESMAN").ToString())),
                         New XElement("cell", IIf(row.item("SalesManName").ToString() = "", "", row.item("SalesManName").ToString())),
                         New XElement("cell", row.item("Boxes")),
                         New XElement("cell", Convert.ToDecimal(row.item("SALES")).ToString("#,##0.00")),
                         New XElement("cell", Convert.ToDecimal(row.item("PROFIT")).ToString("#,##0.00")),
                         New XElement("cell", row.item("gpm")),
                         New XElement("cell", row.item("C")),
                         New XElement("cell", row.item("I")),
                         New XElement("cell", Convert.ToDecimal(row.item("INV")).ToString("#,##0.00")),
                         New XElement("cell", Convert.ToDecimal(row.item("FBE")).ToString("#,##0.00")))))
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))

                        Dim idx As Integer = dt.Rows.Count - 1


                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Totals"
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""

                        Return newDoc
                    Else
                        If data(0).ErrorMessage.Contains("does not exist") Then
                            Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                        End If
                    End If
                Else

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                     New XElement("rows", New XElement("page", page.ToString()),
                     New XElement("total", dt.Rows.Count - 1),
                      From row In dt.Rows()
                      Select New XElement("row", New XAttribute("id", ""), New XAttribute("background-color", ""), New XAttribute("color", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc
                    'Return Nothing
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderSummaryList::PageOrderSummary")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetScannedDetailsForInvoice(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, Invoice As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing

                data = SalesOrder.GetScannedDetails_FG(Invoice)

                Dim dt1 As DataTable = ConvertToDataTable(data)



                If dt1.Rows.Count > 0 Then

                    If Convert.ToString(dt1(0)("ErrorMessage")) = "" Then

                        Dim selectedColumns As String() =
                                    {"FarmCode", "Flower", "Name", "Boxes", "UOM", "UnitsBunch", "Units", "Boxnum", "ScannedBox", "MissingBox"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("FarmCode").ColumnName = "Farm"
                        dt.Columns("Flower").ColumnName = "Flower"
                        dt.Columns("Name").ColumnName = "Description"
                        dt.Columns("Boxes").ColumnName = "Boxes"
                        dt.Columns("UOM").ColumnName = "UOM"
                        dt.Columns("UnitsBunch").ColumnName = "UnitsBunch"
                        dt.Columns("Units").ColumnName = "Units"
                        dt.Columns("Boxnum").ColumnName = "Boxnum"
                        dt.Columns("ScannedBox").ColumnName = "Scanned"
                        dt.Columns("MissingBox").ColumnName = "Missing"
                        dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)

                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else
                Dim FlowerColorVisibility As Boolean = False
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next

                Dim data = Nothing
                data = SalesOrder.GetScannedDetails_FG(Invoice)

                Dim dt As DataTable = ConvertToDataTable(data)

                If dt.Rows.Count > 0 Then

                    If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                        Dim SelectedPOs As New ArrayList
                        Dim TotalRowCount As Integer = 0

                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If

                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                         New XElement("rows", New XElement("page", page.ToString()),
                         New XElement("total", If(TotalRowCount.ToString() = "0", "1", TotalRowCount.ToString())),
                         From row In dt.Rows()
                         Select New XElement("row", New XAttribute("id", Convert.ToString(row("RowNo"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                         New XElement("cell", IIf(Convert.ToString(row("FarmCode")) = "", "", Convert.ToString(row("FarmCode")))),
                         New XElement("cell", IIf(Convert.ToString(row("Flower")) = "", "", Convert.ToString(row("Flower")).ToString())),
                         New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("FlowerDetails").BGColor.ToString() + ";cursor:pointer;color:" + row("FlowerDetails").FontColor.ToString() +
                                                                                        "' class='flowerDescription' title='" + row("FlowerDetails").Name.Replace("'", "") + "'>" & row("FlowerDetails").Name &
                                                                                        "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                        row("FlowerDetails").Name.Replace("'", "") + "'>" & row("FlowerDetails").Name & "</div>"))),
                         New XElement("cell", row("Boxes")),
                         New XElement("cell", row("UOM")),
                         New XElement("cell", row("UnitsBunch")),
                         New XElement("cell", row("Units")),
                         New XElement("cell", IIf(row("BoxNum") = 0, row("BoxNum").ToString(), "<a id=lnkBoxnum_'" + row("RowNo").ToString() + "' data-order='" + Invoice + "' data-farm='" + row("FarmCode").ToString() + "' data-boxnum='" + row("BoxNum").ToString() + "' style=text-decoration:underline;cursor:pointer>" & row("BoxNum").ToString() & "</a>")),
                         New XElement("cell", row("ScannedBox")),
                         New XElement("cell", row("MissingBox")))))
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Dim idx As Integer = dt.Rows.Count - 1
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""

                        Return newDoc
                    Else
                        If data(0)("ErrorMessage").Contains("does not exist") Then
                            Return BuildFlexiGridError(data(0)("ErrorMessage").Split("###")(15).Replace("Exception", ""))
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0)("ErrorMessage"), "", "Error Notification", "error")
                            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                        End If
                    End If
                Else

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                     New XElement("rows", New XElement("page", page.ToString()),
                     New XElement("total", data.Length),
                     data.Select(Function(row) New XElement("row", New XAttribute("id", ""), New XAttribute("background-color", ""), New XAttribute("color", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", ""),
                     New XElement("cell", "")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc
                    'Return Nothing
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetScannedDetailsForInvoice::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckIfAllowAutoposting(ByVal farmcode As String) As String
        Try
            Return IIf(Farms.AllowAutoposting(farmcode), "Y", "N")
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetScannedDetailsForInvoice::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PostPOToVendorSystem(ByVal farmcode As String, ByVal ponumber As String) As String
        Try
            Return IIf(Farms.AllowAutoposting(farmcode), "Y", "N")
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetScannedDetailsForInvoice::PageOrder")
            Return Nothing
        End Try
    End Function
    '<System.Web.Services.WebMethod(True)>
    'Public Function GetBoxnumSequenceFromXML(ByVal Order As String, ByVal Farm As String, ByVal Boxnum As String) As String
    '    Try
    '        Dim data = obj.GetBoxnumSequence(Order, Farm, Boxnum)
    '        Dim Result As String = ""
    '        Dim i As Integer
    '        If data.Length > 0 Then
    '            System.Array.Sort(data)
    '            Result = "<table style='margin-left:150px;position:absolute;'>"
    '            Result += "<tr><td class='BoxSeqListtd' style='background-color: #dedede;text-align:center;vertical-align:top;padding: 10px;'>Sequence</td></tr>"

    '            For i = 0 To data.Length - 1
    '                Result += "<tr><td class='BoxSeqListtd style='background-color: #dedede;text-align:center;'>" + data(i) + "</td></tr>"
    '            Next
    '            Result += "</table>"
    '        End If
    '        Return Result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetBoxnumSequenceFromXML::PageOrder")
    '        Throw ex
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderHeaderByOrderNo(ByVal OrderNo As String, ByVal CalledFromVET As String, ByVal Customer As String) As BO.SalesHeader
        Try
            ''' agregar si tiene EDI para validar Gabriel
            If (CalledFromVET = "1") Then
                Return VET.GetVETHeaderByOrderNo(OrderNo, Customer)
            Else
                Return SalesOrder.GetOrderHeaderByOrderNo(OrderNo, Customer)
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderHeaderByOrderNo::PageOrder")
            Return Nothing
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function InsertOrderLock(ByVal OrderNumber As String) As String
        Try
            Return SalesOrder.InsertOrderLock(OrderNumber)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::InsertOrderLock::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteOrderLock(ByVal OrderNumber As String) As String
        Try
            Return SalesOrder.DeleteOrderLock(OrderNumber)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteOrderLock::PageOrder")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' ANITHA :: OCT-03-2018 :: PrintSalesSummaryReport
    ''' </summary>
    ''' <param name="SalesSummaryFromDate"></param>
    ''' <param name="SalesSummaryToDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryReport(ByVal SalesSummaryFromDate As String, ByVal SalesSummaryToDate As String, ByVal SalesSummaryByCarrier As String, ByVal SalesSummarySelectCarrier As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            Dim result As String = ""
            Dim ds As New DataSet()
            Dim HistoryRecordsOnly As String = "0"

            result = SalesOrder.InsertSalesSummaryReport(SalesSummaryFromDate, SalesSummaryToDate, User.ID, User.UserType, HistoryRecordsOnly, ds, SalesSummarySelectCarrier)

            If result = "success" Then

                Dim cnt = SalesOrder.CheckSalesSummaryRowCnt(SalesSummaryFromDate, SalesSummaryToDate, User.ID, SalesSummarySelectCarrier)

                If cnt > 0 Then
                    Dim objPdf As New ExportSSRS
                    Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                    Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}
                    reportParameterCollection(0) = New ReportParameter()
                    reportParameterCollection(0).Name = "ConnectionString"
                    reportParameterCollection(0).Values.Add(ConString)

                    reportParameterCollection(1) = New ReportParameter()
                    reportParameterCollection(1).Name = "FromDate"
                    reportParameterCollection(1).Values.Add(SalesSummaryFromDate)

                    reportParameterCollection(2) = New ReportParameter()
                    reportParameterCollection(2).Name = "ToDate"
                    reportParameterCollection(2).Values.Add(SalesSummaryToDate)

                    reportParameterCollection(3) = New ReportParameter()
                    reportParameterCollection(3).Name = "UserID"
                    reportParameterCollection(3).Values.Add(User.ID)

                    reportParameterCollection(4) = New ReportParameter()
                    reportParameterCollection(4).Name = "ByCarrier"
                    reportParameterCollection(4).Values.Add(SalesSummaryByCarrier)

                    Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                    Dim filename As String = ""
                    filename = "SalesSummaryReport" + Convert.ToDateTime(SalesSummaryFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(SalesSummaryToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
                    Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
                    Dim BodyMessage As String = ""
                    Dim ReportName As String = ""
                    If SalesSummaryByCarrier = "Y" Then
                        ReportName = objPdf.ExportToPdf(filename, "rptSalesSummary_new", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                    Else
                        ReportName = objPdf.ExportToPdf(filename, "rptSalesSummary_WithoutCarrier", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                    End If
                    If Not ReportName.Trim().Contains("error : ") Then
                        Logs.SendErrorEmail(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " EOD Sales Summary From:" + SalesSummaryFromDate + " To " + SalesSummaryToDate + " by user:" + User.Email), "labelnotification")
                    End If
                    Return ReportName
                Else
                    Return "No Data"
                End If
            Else
                Return result
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    ''' Anitha :: 14-Nov-2018 :: Clear the Scanned Orders
    <System.Web.Services.WebMethod(True)>
    Public Function ClearGun() As String
        Try
            Return SalesOrder.ClearGun()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearGun::PageOrder")
            Return ex.Message()
        End Try
    End Function

    ''' Clear the tblBarCodes rows
    <System.Web.Services.WebMethod(True)>
    Public Function CleartblBarcodes() As String
        Try
            Return SalesOrder.CleartblBarcodes()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CleartblBarcodes::PageOrder")
            Return ex.Message()
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function FuelUpdate(ByVal OrderNumber As String) As String
        Try
            Return SalesOrder.FuelUpdate(OrderNumber)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::FuelUpdate::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function OrderDetailConsolView(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal OrderNo As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim whereCondition As String = ""

            If OrderNo <> "" Then
                whereCondition = "[Order]=" + OrderNo + "And Type <> 'K'"
            Else
                If (Filter <> "") Then
                    whereCondition = "Type <> 'K' And [Order]<>'0' And " + Filter + ""
                Else
                    whereCondition = "Type <> 'K' And [Order]<>'0'"
                End If
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim TotalRowCount As Integer = 0
                Dim data = Nothing

                data = SalesOrder.GetSalesOrderConsolList(whereCondition, "Flower asc", start, rp, User.ID)
                TotalRowCount = data.count


                If TotalRowCount > 0 Then
                    Dim dt1 As DataTable = ConvertToDataTable(data)

                    If dt1(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                        Dim selectedColumns As String() =
                                    {"Order", "INVENTYPE", "Flower", "Name", "FarmCode", "Boxes1", "UOM", "Units", "TotalUnits1", "FOB",
                                     "TotPerLine", "Dimensions", "Cubes", "Weight"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("Order").ColumnName = "INV#"
                        dt.Columns("Name").ColumnName = "Description"
                        dt.Columns("TotPerLine").ColumnName = "Total$"
                        dt.Columns("Boxes1").ColumnName = "Boxes"
                        dt.Columns("TotalUnits1").ColumnName = "TotalUnits"
                        dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)

                    Else
                        ' Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt1(TotalRowCount - 1)("ErrorMessage").ToString(), "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else

                Dim data = Nothing
                Dim isEXTRAFIELD As String = "S"                        '27 Mar 19 :: Muthu Nivetha M ::  On invoice show if line is a substitute     

                data = SalesOrder.GetSalesOrderConsolList(whereCondition, "Flower asc", start, rp)
                Dim dt As DataTable = ConvertToDataTable(data)

                If dt.Rows.Count > 0 Then

                    If dt(0)("ErrorMessage").ToString() = "" Then


                        Dim TotalRowCount As Integer = 0

                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If

                        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        Dim FlowerColorVisibility As Boolean = False
                        For Each i In UserFeatures
                            If i.Name.ToLower = "show flower color" Then
                                FlowerColorVisibility = i.Value
                            End If
                        Next


                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                       From row In dt.Rows()
                       Select
                       New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", IIf(row("Order") = "0", "", Convert.ToString(row("Order")))),
                       New XElement("cell", row("InvenType")),
                       New XElement("cell", IIf(row("EXTRAFIELD").ToString().ToUpper() = isEXTRAFIELD, "<div style='padding: 0;color:red;'>" + row("Flower") + "</div>", row("Flower"))),
                       New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("BGColor").ToString() + "' class='flowerDescription'><a id='OrderDetailName_" & Convert.ToString(row("ID")) & "' style='color:" + row("FontColor").ToString() + ";'>" + row("Name") + "</a></div>", "<a >" + row("Name") + "</a>")),
                       New XElement("cell", row("FarmCode")),
                       New XElement("cell", "<a class='OrderCalculation' id='OrderDetailBoxes_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("Boxes1")) + "</a>"),
                       New XElement("cell", "<a id='OrderDetailUOM_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("UOM")) + "</a>"),
                       New XElement("cell", "<a id='OrderDetailUnits_" & Convert.ToString(row("ID")) & "' >" + IIf(Convert.ToString(row("Units")) = "0", "", Convert.ToString(row("Units"))) + "</a>"),
                       New XElement("cell", IIf(Convert.ToString(row("TotalUnits1")) = "0", "", row("TotalUnits1"))),
                       New XElement("cell", IIf(Convert.ToString(row("FOB")) = "0", "", Convert.ToDecimal(row("FOB")).ToString("#,##0.000"))),
                       New XElement("cell", IIf(row("TotPerLine") = "0", Convert.ToDecimal(row("GrandTotal")).ToString("#,##0.00"), Convert.ToDecimal(row("TotPerLine")).ToString("#,##0.00"))),
                             New XElement("cell", row("Dimensions")),
                             New XElement("cell", IIf(row("Cubes") = "0", "", Convert.ToDecimal(row("Cubes")).ToString("#,##0.000"))),
                            New XElement("cell", IIf(row("WEIGHT") = "0", "", Convert.ToDecimal(row("WEIGHT")).ToString("#,##0.00"))),
                       New XElement("cell", "<span id='OrderDetailCAT_" & row.Item("ID") & "'>" + row("CAT") + "</span>"),
                       New XElement("cell", "<span id='OrderDetailColor_" & row("ID") & "'>" + row("Color") + "</span>"),
                       New XElement("cell", "<span id='OrderDetailVariety_" & row("ID") & "'>" + row("Variety") + "</span>"),
                       New XElement("cell", "<span id='OrderDetailGrade_" & row("ID") & "'>" + row("Grade") + "</span>"))))


                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))

                        Return newDoc
                    Else
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::OrderDetailConsolView::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function OrderDetailCATSUMM(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal OrderNo As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim whereCondition As String = ""

            If OrderNo <> "" Then
                whereCondition = "[Order]=" + OrderNo + " And vw.Type <> 'K'"
            Else
                If (Filter <> "") Then
                    whereCondition = "vw.Type <> 'K' And [Order]<>'0' And " + Filter + ""
                Else
                    whereCondition = "vw.Type <> 'K' And [Order]<>'0'"
                End If
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If




            Dim data = Nothing

            data = SalesOrder.GetSalesOrderCATSUMMList(whereCondition)
            Dim dt As DataTable = ConvertToDataTable(data)

            If dt.Rows.Count > 0 Then

                If dt(0)("ErrorMessage").ToString() = "" Then


                    Dim TotalRowCount As Integer = 0

                    If dt.Rows.Count > 0 Then
                        TotalRowCount = dt(0)("TotalRows").ToString()
                    End If

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                    New XElement("rows", New XElement("page", page.ToString()),
                    New XElement("total", TotalRowCount),
                    From row In dt.Rows()
                    Select
                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                    New XElement("cell", row("CAT")),
                    New XElement("cell", row("NAME")),
                    New XElement("cell", row("Bunches")),
                    New XElement("cell", row("Units")),
                    New XElement("cell", row("Amount")),
                    New XElement("cell", row("Cubes")),
                    New XElement("cell", row("Weight")))))


                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))

                    Return newDoc
                Else
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Return Nothing
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::OrderDetailConsolView::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function OrderDetailDimensionView(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal OrderNo As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim whereCondition As String = ""

            If OrderNo <> "" Then
                whereCondition = "[Order] in (" + OrderNo + ") And Type <> 'K'"    'Changed by Anubhuti on 09/12/2022
            Else
                If (Filter <> "") Then
                    whereCondition = "Type <> 'K' And [Order]<>'0' And " + Filter + ""
                Else
                    whereCondition = "Type <> 'K' And [Order]<>'0'"
                End If
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim TotalRowCount As Integer = 0
                Dim data = Nothing

                data = SalesOrder.GetSalesOrderDimensionList(whereCondition, "Flower asc", start, rp, User.ID)
                TotalRowCount = data.count


                If TotalRowCount > 0 Then
                    Dim dt1 As DataTable = ConvertToDataTable(data)

                    If dt1(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                        Dim selectedColumns As String() =
                                    {"Order", "INVENTYPE", "Flower", "Name", "FarmCode", "Boxes1", "UOM", "Units", "TotalUnits1", "FOB",
                                     "TotPerLine", "Dimensions", "Cubes", "Weight"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("Order").ColumnName = "INV#"
                        dt.Columns("Name").ColumnName = "Description"
                        dt.Columns("TotPerLine").ColumnName = "Total$"
                        dt.Columns("Boxes1").ColumnName = "Boxes"
                        dt.Columns("TotalUnits1").ColumnName = "TotalUnits"
                        dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)

                    Else
                        ' Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt1(TotalRowCount - 1)("ErrorMessage").ToString(), "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else

                Dim data = Nothing
                Dim isEXTRAFIELD As String = "S"                        '27 Mar 19 :: Muthu Nivetha M ::  On invoice show if line is a substitute     

                data = SalesOrder.GetSalesOrderDimensionList(whereCondition, "Flower asc", start, rp)
                Dim dt As DataTable = ConvertToDataTable(data)

                If dt.Rows.Count > 0 Then

                    If dt(0)("ErrorMessage").ToString() = "" Then


                        Dim TotalRowCount As Integer = 0

                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If

                        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        Dim FlowerColorVisibility As Boolean = False
                        For Each i In UserFeatures
                            If i.Name.ToLower = "show flower color" Then
                                FlowerColorVisibility = i.Value
                            End If
                        Next


                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                       From row In dt.Rows()
                       Select
                       New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", "<img href='#'  id='OrderDetailDelete_" & Convert.ToString(row("SQLID")) & "' src='images/Delete-icon.png' style='cursor:pointer'/>"),
                       New XElement("cell", "<img href='#'  id='OrderDetailEditDim_" & Convert.ToString(row("SQLID")) & "' src='images/Edit.png' style='cursor:pointer'/>"),
                       New XElement("cell", IIf(row("Order") = "0", "", Convert.ToString(row("Order")))),
                       New XElement("cell", row("InvenType")),
                       New XElement("cell", row("CAT")),
                       New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("BGColor").ToString() + "' class='flowerDescription'><a id='OrderDetailName_" & Convert.ToString(row("ID")) & "' data-toggle='tooltip[' title='" + row("Flower") + "' style='color:" + row("FontColor").ToString() + ";'>" + row("Name") + "</a></div>", "<a >" + row("Name") + "</a>")),
                       New XElement("cell", row("FarmCode")),
                       New XElement("cell", "<a class='OrderCalculation' id='OrderDetailBoxes_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("Boxes1")) + "</a>"),
                       New XElement("cell", "<a id='OrderDetailUOM_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("UOM")) + "</a>"),
                       New XElement("cell", "<a id='OrderDetailUnits_" & Convert.ToString(row("ID")) & "' >" + IIf(Convert.ToString(row("Units")) = "0", "", Convert.ToString(row("Units"))) + "</a>"),
                             New XElement("cell", IIf(row("BoxLength") = "0" Or row("BoxWidth") = "0" Or row("BoxHeight") = "0", "<a style='background-color:red;' id='OrderDetailDimensions_" & Convert.ToString(row("ID")) & "' >" + row("Dimensions") + "</a>", "<a id='OrderDetailDimensions_" & Convert.ToString(row("ID")) & "' >" + row("Dimensions") + "</a>")),
                             New XElement("cell", IIf(row("Cubes") = "0", "", Convert.ToDecimal(row("Cubes")).ToString("#,##0.000"))),
                            New XElement("cell", IIf(row("WEIGHT") = "0", "", Convert.ToDecimal(row("WEIGHT")).ToString("#,##0.00"))),
                       New XElement("cell", "<span id='OrderDetailCAT_" & row.Item("ID") & "'>" + row("CAT") + "</span>"),
                       New XElement("cell", "<span id='OrderDetailColor_" & row("ID") & "'>" + row("Color") + "</span>"),
                       New XElement("cell", "<span id='OrderDetailVariety_" & row("ID") & "'>" + row("Variety") + "</span>"),
                       New XElement("cell", "<span id='OrderDetailGrade_" & row("ID") & "'>" + row("Grade") + "</span>"))))


                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))

                        Return newDoc
                    Else
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::OrderDetailConsolView::PageOrder")
            Return Nothing
        End Try
    End Function
#End Region

#Region "F3 - New Order"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function LoadF3SalesDetailsForSelectedCust(SelectedCust As String, ExportCSV As String) As XmlDocument
        Try

            Dim F3SalesDetList = Nothing
            F3SalesDetList = SalesOrder.LoadF3SalesDetailsForSelectedCust(SelectedCust)

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                If F3SalesDetList Is Nothing Then
                    Return Nothing
                End If

                If Convert.ToString(TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item2) = "success" Then
                    Dim selectedColumns As String() = {"FLOWER", "FLOWERNAME", "FARM", "DATE1", "BOXES", "PRICE", "COST", "GPM"}
                    Dim dt As DataTable = New DataView(TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1.Tables(0)).ToTable(False, selectedColumns)
                    dt.Columns("FLOWER").ColumnName = "PRODUCT"
                    dt.Columns("FLOWERNAME").ColumnName = "NAME"
                    dt.Columns("DATE1").ColumnName = "DATE"
                    dt.Columns("GPM").ColumnName = "%GPM"
                    Dim filepath = ExporttoExcel(dt, splitExportcsv(1) + "Header")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, F3SalesDetList(0).ErrorMessage, "", "Error Notification", "Error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim dtF3SalesDetList As New DataSet
                If Not TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                    dtF3SalesDetList = TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1 'ConvertToDataTable(PricingList)
                Else
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", "0"),
                                       New XElement("total", dtF3SalesDetList.Tables(1).Rows(0)(0)),
                                         From row In dtF3SalesDetList.Tables(0).Rows()
                                         Select
                                         New XElement("row", New XAttribute("id", row("ID")),
                                         New XElement("cell", row("FLOWER")),
                                             New XElement("cell", "<div style='padding-bottom: 3px;background-color:" + row("BGColor").ToString() + "' class='flowerDescription'><a id='OrderDetailName_" & Convert.ToString(row("ID")) & "' style='color:" + row("FontColor").ToString() + ";'>" + row("FLOWERNAME") + "</a></div>"),
                                             New XElement("cell", row("FARM")),
                                             New XElement("cell", IIf(row("DATE1") Is DBNull.Value, Convert.ToString(""), Convert.ToDateTime(row("DATE1")).ToString("MM/dd/yy"))),
                                             New XElement("cell", row("BOXES")),
                                             New XElement("cell", IIf(row("PRICE") Is DBNull.Value, Convert.ToDecimal(0).ToString("#0.00"), Convert.ToDecimal(row("PRICE")).ToString("#0.000"))),
                                             New XElement("cell", row("COST")),
                                             New XElement("cell", row("GPM")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: LoadF3SalesDetailsForSelectedCust()::PageOrderNew")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function LoadF3SalesPurchasesDetailsForSelectedCust(SelectedCust As String, FromDate As String, UptoDate As String, ExportCSV As String) As XmlDocument
        Try

            Dim F3SalesDetList = Nothing
            F3SalesDetList = SalesOrder.LoadF3SalesPurchasesDetailsForSelectedCust(SelectedCust, FromDate, UptoDate)

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                If F3SalesDetList Is Nothing Then
                    Return Nothing
                End If

                If Convert.ToString(TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item2) = "success" Then
                    Dim selectedColumns As String() = {"FLOWER", "FLOWERNAME", "FARM", "DATE1", "BOXES", "PRICE", "COST", "GPM"}
                    Dim dt As DataTable = New DataView(TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1.Tables(0)).ToTable(False, selectedColumns)
                    dt.Columns("FLOWER").ColumnName = "PRODUCT"
                    dt.Columns("FLOWERNAME").ColumnName = "NAME"
                    dt.Columns("DATE1").ColumnName = "DATE"
                    dt.Columns("GPM").ColumnName = "%GPM"
                    Dim filepath = ExporttoExcel(dt, splitExportcsv(1) + "Header")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, F3SalesDetList(0).ErrorMessage, "", "Error Notification", "Error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim dtF3SalesDetList As New DataSet
                If Not TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                    dtF3SalesDetList = TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1 'ConvertToDataTable(PricingList)
                Else
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If
                'Modified by Anubhuti on 02/21/2023
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", "0"),
                                        New XElement("total", If(dtF3SalesDetList.Tables(1).Rows(0)(0) = "0", 1, dtF3SalesDetList.Tables(1).Rows(0)(0))),
                                         From row In dtF3SalesDetList.Tables(0).Rows()
                                         Select
                                         New XElement("row", New XAttribute("id", row("ID")),
                                         New XElement("cell", row("FLOWER")),
                                             New XElement("cell", "<div style='padding-bottom: 3px;background-color:" + row("BGColor").ToString() + "' class='flowerDescription'><a id='OrderDetailName_" & Convert.ToString(row("ID")) & "' style='color:" + row("FontColor").ToString() + ";'>" + row("FLOWERNAME") + "</a></div>" + "</a>"),
                                             New XElement("cell", row("FARM")),
                                             New XElement("cell", IIf(row("DATE1") Is DBNull.Value, Convert.ToString(""), Convert.ToDateTime(row("DATE1")).ToString("MM/dd/yy"))),
                                             New XElement("cell", row("BOXES")),
                                             New XElement("cell", IIf(row("PRICE") Is DBNull.Value, Convert.ToDecimal(0).ToString("#0.00"), Convert.ToDecimal(row("PRICE")).ToString("#0.000"))),
                                             New XElement("cell", row("COST")),
                                             New XElement("cell", row("GPM")),
                                             New XElement("cell", row("INVOICE")))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: LoadF3SalesPurchasesDetailsForSelectedCust()::PageOrderNew")
            Return Nothing
        End Try
    End Function


    'Added By Belal on 01 Sept 2020 :: For selected flower customer list
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function LoadF3SalesDetailsForSelectedFlower(ByVal SelectedFlower As String) As XmlDocument
        Try


            Dim F3SalesDetList = Nothing
            F3SalesDetList = SalesOrder.LoadF3SalesDetailsForSelectedFlower(SelectedFlower)
            Dim dtF3SalesDetList As New DataSet
            If Not TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                dtF3SalesDetList = TryCast(F3SalesDetList, Tuple(Of DataSet, String)).Item1 'ConvertToDataTable(PricingList)
            Else
                Dim newDoc1 As New XmlDocument()
                newDoc1.LoadXml("<rows><total>0</total></rows>")
                Return newDoc1
            End If
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", "0"),
                                       New XElement("total", dtF3SalesDetList.Tables(0).Rows.Count()),
                                         From row In dtF3SalesDetList.Tables(0).Rows()
                                         Select
                                         New XElement("row", New XAttribute("id", "0"),
                                         New XElement("cell", row("CUSTOMER")),
                                             New XElement("cell", row("CUSTOMERNAME")),
                                             New XElement("cell", row("BOXES")),
                                             New XElement("cell", row("UOM")),
                                             New XElement("cell", row("UNITS")),
                                             New XElement("cell", row("FOB")),
                                             New XElement("cell", IIf(row("DATE1") Is DBNull.Value, Convert.ToString(""), Convert.ToDateTime(row("DATE1")).ToString("MM/dd/yy"))))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: LoadF3SalesDetailsForSelectedFlower()::PageOrderNew")
            Return Nothing
        End Try
    End Function

    'Added By Belal on 05 Sept 2020 :: For EMAIL LOGS
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function LoadEmailLogs(ByVal EmailType As String, ByVal EmailedDocumentNumber As String) As XmlDocument
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim EmailLogList = Nothing
            EmailLogList = SalesOrder.LoadEmailLogs(User.Email, EmailType, EmailedDocumentNumber)
            Dim dtEmailLogList As New DataSet
            If Not TryCast(EmailLogList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                dtEmailLogList = TryCast(EmailLogList, Tuple(Of DataSet, String)).Item1
            Else
                Dim newDoc1 As New XmlDocument()
                newDoc1.LoadXml("<rows><total>0</total></rows>")
                Return newDoc1
            End If
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", "0"),
                                       New XElement("total", dtEmailLogList.Tables(0).Rows.Count()),
                                         From row In dtEmailLogList.Tables(0).Rows()
                                         Select
                                         New XElement("row", New XAttribute("id", "0"),
                                         New XElement("cell", row("SENT_AT")),
                                             New XElement("cell", row("FROM_MAIL")),
                                             New XElement("cell", row("TO_MAIL")),
                                             New XElement("cell", row("SUBJECT")),
                                             New XElement("cell", IIf(row("STATUS") = "error", "<a href='#' style='text-decoration: none!important;color: black !important;' title='" + row("ERRORMESSAGE") + "' > " + row("STATUS") + " </a>", row("STATUS"))),
                                             New XElement("cell", row("FILENAME")))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: LoadEmailLogs()")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Pricing"
    <System.Web.Services.WebMethod(True)>
    Public Function LoadPricingDetailsForSelectedCust(ByVal SelectedCust As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
            Dim FlowerColorVisibility As Boolean = False
            For Each i In UserFeatures
                If i.Name.ToLower = "show flower color" Then
                    FlowerColorVisibility = i.Value
                End If
            Next

            Dim F3SalesDetList = Nothing
            F3SalesDetList = SPORD.LoadPricingDetailsForSelectedCust(SelectedCust)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: LoadPricingDetailsForSelectedCust()::PageOrderNew")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Inventory"


    <System.Web.Services.WebMethod(True)>
    Public Function Getpercent0ByProductCategory(ByVal FlowerCode As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim result = Inventory.Getpercent0ByProductCategory(FlowerCode)

            Return result

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: Getpercent0ByProductCategory()")
            Return 0
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintBoxedReceivedToExcel(ByVal FromDate As String, ToDate As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = Inventory.PrintBoxedReceivedToExcel(FromDate, ToDate)
            'dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "PrintBoxedReceivedToExcel$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintBoxedReceivedToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryForAddingOrderDetailFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal FilterColumn As String, ByVal Customer As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim WH As String = ""

            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Inventory), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                Else
                    whereCondition = whereCondition
                End If
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1
            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            Dim newDoc1 As New XmlDocument()
            Dim InventoryList = Inventory.GetInventoryForAddingOrderDetailFgrd(whereCondition, sortExp, start, rp, Customer)
            Dim dtInventoryList As New DataSet
            If Not TryCast(InventoryList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                If Not TryCast(InventoryList, Tuple(Of DataSet, String)).Item2 Is Nothing Then
                    Dim result = ""
                    result = TryCast(InventoryList, Tuple(Of DataSet, String)).Item2
                    If (result.ToString() = "No Active WH".ToLower()) Then
                        newDoc1.LoadXml("<rows><total>0</total></rows>")
                        Return newDoc1
                    End If
                End If
                dtInventoryList = TryCast(InventoryList, Tuple(Of DataSet, String)).Item1
            Else
                newDoc1.LoadXml("<rows><total>0</total></rows>")
                Return newDoc1
            End If

            Dim TotBoxes = 0
            If dtInventoryList.Tables(0).Rows.Count > 0 Then
                TotBoxes = Convert.ToInt32(dtInventoryList.Tables(0).Compute("SUM(RowwiseAvailQty)", String.Empty))
            End If

            '27 Mar 19 :: Muthu Nivetha M :: Expand Breakdown, and Message fields :: Starts
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                    New XElement("rows", New XElement("page", page.ToString()),
                                    New XElement("total", dtInventoryList.Tables(0).Rows.Count),
                                    From row In dtInventoryList.Tables(0).Rows()
                                    Select New XElement("row", New XAttribute("id", row("RECNO")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("ID"), row("RECNO"), "aOrderInventoryINVIDs")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("WH"), row("RECNO"), "aOrderCustomerWH")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Farm"), row("RECNO"), "aOrderInventoryFarm")),
                                    New XElement("cell", row("Country")),
                                    New XElement("cell", row("AWB")),
                                    New XElement("cell", InventoryForAddingOrderDetailType(row("Type"), row("RECNO"))),
                                    New XElement("cell", InventoryForAddingOrderFlowerName(row)),
                                    New XElement("cell", InventoryForAddingOrderQtyWithID(row)),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("UOM"), row("RECNO"), "aOrderInventoryUOM")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Units"), row("RECNO"), "aOrderInventoryUnits")),
                                    New XElement("cell", row("UnitsBunch")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("ActualPrice"), row("RECNO"), "aOrderInventoryActualPrice")),
                                    New XElement("cell", row("Price")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Fuel"), row("RECNO"), "aOrderInventoryFuel")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Plusfuel"), row("RECNO"), "aOrderCustomerPlusFuel")),
                                    New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" + row("Message1").Replace("'", "") + "'>" & row("Message1") & "</div>"),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("DAYS"), row("RECNO"), "aOrderCustomerDays")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("linefuel"), row("RECNO"), "aOrderCustomerlinefuel")),
                                    New XElement("cell", row("CUST")),
                                    New XElement("cell", row("ORDER")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("BOXNUM"), row("RECNO"), "aOrderCustomerBOXNUM")),
                                    New XElement("cell", InventoryForAddingOrderWithAnchorTag(row("PICTURE"), row("RECNO"), "aOrderCustomerPICTURE", False)),
                                    New XElement("cell", row("LandedCost")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Flower"), row("RECNO"), "aOrderInventoryFlower")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Cat"), row("RECNO"), "aOrderInventoryCategory")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Variety"), row("RECNO"), "aOrderInventoryVariety")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Color"), row("RECNO"), "aOrderInventoryColor")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("Grade"), row("RECNO"), "aOrderInventoryGrade")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("FBE"), row("RECNO"), "aOrderCustomerFBE")),
                                    New XElement("cell", InventoryForAddingOrderWithID("", row("RECNO"), "aOrderCustomerDimensions")),
                                    New XElement("cell", InventoryForAddingOrderWithID("", row("RECNO"), "aOrderCustomerCubes")),
                                    New XElement("cell", InventoryForAddingOrderWithID("", row("RECNO"), "aOrderCustomerGPM")),
                                    New XElement("cell", InventoryForAddingOrderWithID(row("LandedCost"), row("RECNO"), "aOrderCustomerLandedCost")),
                                    New XElement("cell", row("LastPrice")),
                                    New XElement("cell", row("LastPurchaseDate")))))

            '27 Mar 19 :: Muthu Nivetha M :: Expand Breakdown, and Message fields :: Ends
            'New XElement("cell", row("COST")),
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            If TotBoxes > 0 Then
                Dim idx As Integer = dtInventoryList.Tables(0).Rows.Count - 1
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = (Convert.ToInt32(TotBoxes)).ToString()
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(26).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(27).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(28).InnerText = ""
            End If
            Return newDoc

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetInventoryForAddingOrderDetailFgrd()::PageOrder")
            Return Nothing
        End Try

    End Function
    Private Function InventoryForAddingOrderFlowerName(ByVal row As DataRow) As String
        Dim result As String
        result = String.Format("<div style='padding-bottom: 3px;background-color:{0}' class='flowerDescription'>", row("BGColor"))
        result += String.Format("<a id='aOrderInventoryFlowerName_{0}' style='cursor:pointer;color:{1}' title='{2}'>", row("RECNO"), row("FontColor"), row("Description"))
        If row("LastPrice") <> "" Then
            result += "<img src='images/star.png' width='10' height='10'>"
        End If
        result += String.Format("{0}</a> </div>", row("Description"))
        Return result
    End Function
    Private Function InventoryForAddingOrderQtyWithID(ByVal row As DataRow) As String
        If row("TotalBoxesHold") > 0 Then
            Return String.Format("<a id='aOrderInventoryQty_{0}'>{1}*</a>", row("recno"), row("qty"))
        End If
        Return String.Format("<a id='aOrderInventoryQty_{0}'>{1}</a>", row("recno"), row("qty"))
    End Function
    Private Function InventoryForAddingOrderWithID(ByVal value As String, ByVal id As String, ByVal key As String) As String
        Return String.Format("<a id='{0}_{1}'>{2}</a>", key, id, value)

    End Function

    Private Function InventoryForAddingOrderWithAnchorTag(ByVal value As String, ByVal id As String, ByVal key As String, ByVal is5star As Boolean) As String
        If value <> "" Then
            If is5star Then
                Return String.Format("<a target='_blank' href='{2}' id='{0}_{1}'><img src='images/5star.jpg' style='height: 15px' ></a>", key, id, value)
            Else
                Return String.Format("<a target='_blank' href='{2}' id='{0}_{1}'><img src='data:image/x-icon;base64,AAABAAEAICAQAAAAAADoAgAAFgAAACgAAAAgAAAAQAAAAAEABAAAAAAAgAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAACAAAAAgIAAgAAAAIAAgACAgAAAgICAAMDAwAAAAP8AAP8AAAD//wD/AAAA/wD/AP//AAD///8AzMzMzMzMzMzMzMzMAAAAAMzMzMzMzMzMzMzMzMwAAADMzMzMzMzMzMzMzMzMwAAAzMzMzMzMzMzMzMzMzMwAAMzMzMzMzMzMmZzMmZzMwADMzMzMzMzMyczJyczJzMwAzMzMzMzMzJzMzJzMzJzMwMzMzMzMzMycyZycmcyczMDMzMzMzMzMnMmZyZnMnMzMzMzMzMzMzMnMmZmcyczMzMzMzMzMzMzJnMmZzJnMzMzMzMzMzMzMnMyZmZzMnMzMzMzMzMzMzJzJmZmZzJzMzMzMzMzMzMyczMmZzMyczMzMzMzMzMzMyZnMnMmZzMzMzMzMzMzMzMzJzJzJzMzMzMzMzMzMzMzMyczMyczMzMzMzMzMzMzMzMyZmZzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMwMzMzMzMzMzMzMzMzMzMzMDMzMzMzMzMzMzMzMzMzMwAzMzMzMzMzMzMzMzMzMzAAMzMzMzMzMzMzMzMzMzMAADMzMzMzMzMzMzMzMzMwAAAzMzMzMzMzMzMzMzMzAAAAMzMzMzMzMzMzMzMzAAAAAAAAAD/AAAAPwAAAB8AAAAPAAAABwAAAAMAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAQAAAAMAAAAHAAAADwAAAB8AAAA/AAAA/w==' style='height: 15px' ></a>", key, id, value)
            End If
        End If
        Return ""
    End Function

    Private Function InventoryForAddingOrderDetailType(ByVal value As String, ByVal id As String) As String
        'CONCAT('<div style="' + CASE WHEN Flag = 'A' THEN ' background-color: red; ' ELSE '' END ,'"><a id="aOrderInventorySaleType_',CAST(RECNO AS varchar),CASE WHEN Flag = 'M' THEN '" style="color: transparent;" ' ELSE '' END,'">',Flag,'</a></div>') AS Type,
        If value = "A" Then
            Return String.Format("<div id='aOrderInventorySaleType_{0}' class='flowerDescription' style='background-color: red; padding-bottom: 3px;text-align: center;'>A</div>", id)
        ElseIf value = "M" Then
            Return ""
        Else
            Return String.Format("<div id='aOrderInventorySaleType_{0}' class='flowerDescription' style='padding-bottom: 3px;text-align: center;'>{1}</div>", id, value)
        End If
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryForAddingOrderDetailFgrd_AllocationOrder(ByVal page As Integer, ByVal Customer As String, ByVal flower As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If


            Dim newDoc1 As New XmlDocument()
            Dim InventoryList = Inventory.GetInventoryForAddingOrderDetailFgrd_AllocationOrder(Customer, flower)
            Dim dtInventoryList As New DataSet
            If Not TryCast(InventoryList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                If Not TryCast(InventoryList, Tuple(Of DataSet, String)).Item2 Is Nothing Then
                    Dim result = ""
                    result = TryCast(InventoryList, Tuple(Of DataSet, String)).Item2
                    If (result.ToString() = "No Active WH".ToLower()) Then
                        newDoc1.LoadXml("<rows><total>0</total></rows>")
                        Return newDoc1
                    End If
                End If
                dtInventoryList = TryCast(InventoryList, Tuple(Of DataSet, String)).Item1
            Else
                newDoc1.LoadXml("<rows><total>0</total></rows>")
                Return newDoc1
            End If

            Dim TotBoxes = 0
            If dtInventoryList.Tables(0).Rows.Count > 0 Then
                TotBoxes = Convert.ToInt32(dtInventoryList.Tables(0).Compute("SUM(RowwiseAvailQty)", String.Empty))
            End If

            '27 Mar 19 :: Muthu Nivetha M :: Expand Breakdown, and Message fields :: Starts
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                    New XElement("rows", New XElement("page", page.ToString()),
                                    New XElement("total", dtInventoryList.Tables(0).Rows.Count),
                                    From row In dtInventoryList.Tables(0).Rows()
                                    Select New XElement("row", New XAttribute("id", row("RECNO")),
                                    New XElement("cell", "<input type='checkbox' style='display:block !important;' name='chkOrderInvQty' id='chkOrderInvQty_" + row("RECNO").ToString + "' value=" + row("RECNO").ToString + " onclick='CheckChange(" + row("RECNO").ToString + ")'></input>"),
                                    New XElement("cell", row("ID")),
                                    New XElement("cell", row("WH")),
                                    New XElement("cell", row("Farm")),
                                    New XElement("cell", row("Country")),
                                    New XElement("cell", row("Type")),
                                    New XElement("cell", row("Cat")),
                                    New XElement("cell", row("Flower")),
                                    New XElement("cell", row("Description")),
                                    New XElement("cell", row("Qty")),
                                    New XElement("cell", row("UOM")),
                                    New XElement("cell", "<input type='text' style='width:50px;margin:-3px;margin-bottom:3px;' name='txtOrderInvQty' id='txtOrderInvQty_" + row("RECNO").ToString + "'  onchange='ChangeQtyVal(" + row("RECNO").ToString + ")' ></input>"),
                                    New XElement("cell", row("Units")),
                                    New XElement("cell", row("UnitsBunch")),
                                    New XElement("cell", row("ActualPrice")),
                                    New XElement("cell", row("Price")),
                                    New XElement("cell", row("Fuel")),
                                    New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" + row("Message1").Replace("'", "") + "'>" & row("Message1") & "</div>"),
                                    New XElement("cell", row("linefuel")),
                                    New XElement("cell", row("Plusfuel")),
                                    New XElement("cell", row("LandedCost")),
                                    New XElement("cell", row("CUST")),
                                    New XElement("cell", row("ORDER")),
                                    New XElement("cell", row("BOXNUM")),
                                    New XElement("cell", row("AWB")),
                                    New XElement("cell", row("DAYS")),
                                    New XElement("cell", row("Variety")),
                                    New XElement("cell", row("Color")),
                                    New XElement("cell", row("Grade")),
                                    New XElement("cell", row("FBE")),
                                    New XElement("cell", row("Dimensions")),
                                    New XElement("cell", row("Cubes")),
                                    New XElement("cell", row("GPM")),
                                    New XElement("cell", row("LandedCost1")),
                                    New XElement("cell", row("LastPrice")),
                                    New XElement("cell", row("LastPurchaseDate")))))

            '27 Mar 19 :: Muthu Nivetha M :: Expand Breakdown, and Message fields :: Ends
            'New XElement("cell", row("COST")),
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            If TotBoxes > 0 Then
                Dim idx As Integer = dtInventoryList.Tables(0).Rows.Count - 1
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = (Convert.ToInt32(TotBoxes)).ToString()
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(26).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(27).InnerText = ""
            End If
            Return newDoc

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetInventoryForAddingOrderDetailFgrd_AllocationOrder()::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetProductSalesbyCustomerFgrd(ByVal page As Integer, ByVal flower As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If


            Dim newDoc1 As New XmlDocument()
            Dim InventoryList As List(Of BO.Inventory) = Inventory.GetProductSalesbyCustomerFgrd(flower)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", "100"),
                                            InventoryList.Select(Function(row) New XElement("row",
                                            New XElement("cell", row.Customer),
                                            New XElement("cell", row.Name),
                                            New XElement("cell", row.BoxNumber),
                                            New XElement("cell", row.UOM),
                                            New XElement("cell", row.Units),
                                            New XElement("cell", row.FOB),
                                            New XElement("cell", Convert.ToDateTime(row.DateRec).ToString("MM/dd/yyyy"))))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetProductSalesbyCustomerFgrd()::PageOrder")
            Return Nothing
        End Try

    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateQuantityToInventory(ByVal Order As String, ByVal ORDER2SQLID As Integer, ByVal INVENSQLID As Integer, ByVal QTYTOALLOCATE As Integer) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim result = Inventory.UpdateQuantityToInventory(Order, ORDER2SQLID, INVENSQLID, QTYTOALLOCATE, User.UserName)

            Return result

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: UpdateQuantityToInventory()::UpdateQuantityToInventory")
            Return "error"
        End Try

    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function SaveInformationForApprove(ByVal inventoryId As String, ByVal customerNo As Int64, ByVal currentPrice As Decimal, ByVal boxes As Integer) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            'Modified By: Subhajit On: 06-07-2022
            Dim result = PriceApproval.SaveInformationForApprove(inventoryId, customerNo, currentPrice, User.UserName, boxes)

            Return result

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: SaveInformationForApprove()::PageSaveOrderProcess")
            Return "error"
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckForPriceApproval(ByVal inventoryId As String, ByVal customerNo As Int64, ByVal currentPrice As Decimal, ByVal boxes As Integer) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            'Modified By: Subhajit On: 06-07-2022
            Dim result = PriceApproval.CheckForPriceApproval(inventoryId, customerNo, currentPrice, User.UserName, boxes)

            Return result

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: CheckForPriceApproval()::PageSaveOrderProcess")
            Return ""
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeletePriceApproval(ByVal inventoryId As String, ByVal customerNo As Int64, ByVal currentPrice As Decimal, ByVal boxes As Integer) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            'Modified By: Subhajit On: 06-07-2022
            Dim result = PriceApproval.DeletePriceApproval(inventoryId, customerNo, currentPrice, User.UserName, boxes)

            Return result

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: CheckForPriceApproval()::PageSaveOrderProcess")
            Return ""
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryHeaderList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                           ByVal query As String, ByVal qtype As String, Filter As String, ByVal TableName As String, ByVal ExportCSV As String, ByVal ReceivedPiecesOnly As String, ByVal AWBFlag As String) As XmlDocument
        Try
            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If
            If TableName = "inven" Then
                If sortname = "DateRec" Then
                    sortorder = "asc"
                End If
            End If
            Dim DateSession(1) As String
            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If TableName = "invhist" Then
                If (Not Session("DateSession") Is Nothing) Then
                    DateSession = Session("DateSession")
                Else
                    DateSession = Nothing
                End If

                If (DateSession Is Nothing) Then
                    ToDate = DateTime.Now.ToString("MM/dd/yyyy")
                Else
                    FromDate = DateSession(0).ToString()
                    ToDate = DateSession(1).ToString()
                End If
            End If

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim FilterCode As String = ""


            If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                FilterCode = "DATEREC >= '" + ToDate + "' "
            ElseIf FromDate <> "" And ToDate <> "" Then
                FilterCode = "DATEREC >= '" + FromDate + "' " + " And " + " DATEREC <= '" + ToDate + "'"
            End If


            If (LoginUserDetails.WarehouseList.Count > 0) Then
                Dim warehouses As String = ""
                If LoginUserDetails.WarehouseList.Count > 0 Then
                    warehouses = String.Join("','", LoginUserDetails.WarehouseList.[Select](Function(x) x.WH.ToUpper()))
                End If
                If FilterCode = "" And Filter = "" Then
                    FilterCode += " WH IN ('" + warehouses.ToString() + "')"
                Else
                    FilterCode += " AND WH IN ('" + warehouses.ToString() + "')"
                End If
            End If

            If Filter <> "" Then
                If (FilterCode <> "") Then
                    Filter += " And " + FilterCode
                End If
            Else
                Filter = FilterCode
            End If

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data = Nothing

                data = Inventory.GetInventoryHeader_FGFromSQL(Filter, TableName, ReceivedPiecesOnly, AWBFlag)
                If (data.count <= 0) Then
                    Return Nothing
                End If

                If data(0).ErrorMessage = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() =
                            {"AWB", "DateRec", "CSREC", "FBE"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("DateRec").ColumnName = "Received"
                    dt.Columns("CSREC").ColumnName = "Pieces"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    dtCloned.Columns("Received").DataType = GetType(String)
                    dtCloned.Columns("AWB").DataType = GetType(String)
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Header")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    ' Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim data = Nothing

                data = Inventory.GetInventoryHeader_FGFromSQL(Filter, TableName, ReceivedPiecesOnly, AWBFlag)
                If data Is Nothing Then
                    Return Nothing
                End If
                Dim dt As DataTable = ConvertToDataTable(data)

                If dt.Rows.Count > 0 Then

                    Dim TotalRowCount As Integer = 0

                    If dt.Rows.Count > 0 Then
                        TotalRowCount = dt(0)("TotalRows").ToString()
                    End If


                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                        New XElement("rows", New XElement("page", page.ToString()),
                                                        New XElement("total", TotalRowCount),
                                                        From row In dt.Rows()
                                                        Select
                                                        New XElement("row", New XAttribute("id", row.Item("AWB") + "_" + row.Item("RowNo").ToString()), New XAttribute("style", If(row.Item("Flag") = "A", "color:white;background-color:#0000A0;", "")),
                                                        New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='Airport : " + row.Item("City") + " </b> Status : " + row.Item("Flag") + "'>" & FormatInventoryAWBnumber(row.Item("AWB")) & "</div>"),
                                                        New XElement("cell", Convert.ToDateTime(row.Item("DateRec")).ToString("MM/dd/yyyy")),
                                                        New XElement("cell", row.Item("CSREC")),
                                                        New XElement("cell", Convert.ToDecimal(row.Item("FBE")).ToString("#,##0.000")),
                                                        New XElement("cell", Convert.ToString(row.Item("Flag"))),
                                                        New XElement("cell", String.Format("<a onclick='PrintInventoryLabelByFlower(""" +
                                                                            row.Item("AWB").ToString() + ""","""","""",""" + Convert.ToDateTime(row.Item("DateRec")).ToString("MM/dd/yyyy") +
                                                                            ""","""",""" + TableName + """,""" + ReceivedPiecesOnly + """)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>")),
                                                        New XElement("cell", row.Item("Flag")))))
                    If dt(0)("ErrorMessage").ToString() = "" Then

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Dim idx As Integer = dt.Rows.Count - 1

                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        Return newDoc
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt(0)("ErrorMessage"), "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryHeaderList::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryDetailsListByFarm(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                                  ByVal query As String, ByVal qtype As String, Filter As String, ByVal TableName As String, ByVal ExportCSV As String, ByVal ReceivedPiecesOnly As String, ByVal AWBFlag As String) As XmlDocument

        Try

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            If ExportCSV <> "" Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data = Nothing

                data = Inventory.GetInventoryDetailsGridlistByFarm(Filter, TableName, ReceivedPiecesOnly, AWBFlag)


                If (data.count <= 0) Then
                    Return Nothing
                End If

                If data(0).ErrorMessage = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() =
                            {"Farm", "ProductCode", "ProductName", "CSREC", "UOM", "UnitsBunch", "Units", "TotalUnits", "FBE", "Cost", "TotalCost", "InvenType", "CustNum",
                            "Comments", "BoxNumber", "PO", "Invoice"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("ProductCode").ColumnName = "Flower"
                    dt.Columns("ProductName").ColumnName = "Description"
                    dt.Columns("CSREC").ColumnName = "Boxes"
                    dt.Columns("TotalCost").ColumnName = "$Total"
                    dt.Columns("InvenType").ColumnName = "Type"
                    dt.Columns("CustNum").ColumnName = "Cust#"
                    dt.Columns("BoxNumber").ColumnName = "Box#"
                    dt.Columns("PO").ColumnName = "PO#"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Farm")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            Else
                Dim data = Nothing
                Dim FilterCode As String = ""

                If (LoginUserDetails.WarehouseList.Count > 0) Then
                    Dim warehouses As String = ""
                    If LoginUserDetails.WarehouseList.Count > 0 Then
                        warehouses = String.Join("','", LoginUserDetails.WarehouseList.[Select](Function(x) x.WH.ToUpper()))
                    End If
                    FilterCode = " WH IN ('" + warehouses.ToString() + "')"
                End If
                If Filter <> "" Then
                    If FilterCode <> "" Then
                        Filter += " AND " + FilterCode
                    End If
                Else
                    Filter = FilterCode
                End If

                data = Inventory.GetInventoryDetailsGridlistByFarm(Filter, TableName, ReceivedPiecesOnly, AWBFlag)
                Dim dt As DataTable = ConvertToDataTable(data)
                If dt.Rows.Count > 0 Then

                    If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                        Dim SelectedPOs As New ArrayList
                        Dim TotalRowCount As Integer = 0

                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If

                        Dim FlowerColorVisibility As Boolean = True
                        'Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        'For Each i In UserFeatures
                        '    If i.Name.ToLower = "show flower color" Then
                        '        FlowerColorVisibility = i.Value
                        '    End If
                        'Next

                        'Modified by Anubhuti 2023_06_29
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                New XElement("rows", New XElement("page", page.ToString()),
                                                New XElement("total", TotalRowCount),
                                                From row In dt.Rows()
                                                Select
                                                New XElement("row", New XAttribute("id", row.Item("ID").ToString()),
                                                New XElement("cell", "<b><a href='#' id='deleteInventoryPOdetail_" & row.Item("ID") & "'><img src='images/Delete-icon.png'/></a></b>"),
                                                New XElement("cell", "<b><a href='#' data-farm='" + row.Item("Farm") + "' data-productcode='" + row.Item("ProductCode") + "' id='editInventoryPOdetail_" & row.Item("ID") & "'><img src='images/Edit.png'/></a></b>"),
                                                New XElement("cell", "<span id='invenWH_" & row.Item("ID") & "'>" + row.Item("WH") + "</span>"),
                                                New XElement("cell", IIf(row.Item("AWB").ToString().Length > 4, Strings.Right(row.Item("AWB").ToString(), 4), row.Item("AWB").ToString())),
                                                New XElement("cell", row.Item("Farm")),
                                                New XElement("cell", row.Item("ProductCode")),
                                                New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Item("FlowerDetails").BGColor.ToString() + ";cursor:Pointer;color:" + row.Item("FlowerDetails").FontColor.ToString() +
                                                                                    "' class='flowerDescription' title='" + row.Item("ProductName").Replace("'", "") + "'>" & row.Item("ProductName") &
                                                                                    "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                    row.Item("ProductName").Replace("'", "") + "'>" & row.Item("ProductName") & "</div>"))),
                                                New XElement("cell", IIf(Convert.ToInt16(row.Item("CSSOLD").ToString()) < 0, "<span id='spancsSold_" & row.Item("ID").ToString() & "' style='background: Red;color: white;padding: 8px 21px;margin-left: -15px;margin-right: -4px; text-align: right;', title='System Error in Sold Qty, Contact Programmer'><a style='color:white;text-align: right;' id='acCssold_" + row.item("ID").ToString() + "'>" + Convert.ToString(row.item("CSREC")) + "<a></span>", IIf(Convert.ToInt16(row.Item("CSSOLD").ToString()) > Convert.ToInt16(row.Item("RecQty").ToString()), "<span id='spancsSold_" & row.Item("ID").ToString() & "' style='background: Red;color: white;padding: 8px 21px;margin-left: -15px;margin-right: -4px; text-align: right;', title='System Error in Sold Qty, Contact Programmer'><a style='color:white;text-align: right;' id='acCssold_" + row.item("ID").ToString() + "'>" + Convert.ToString(row.item("CSREC")) + "<a></span>", "<span title='Received=" + Convert.ToString(row.item("CSREC")) + " & Sold=" + Convert.ToString(row.item("CSSOLD")) + "'>" + Convert.ToString(row.item("CSREC")) + "</span>"))),
                                                New XElement("cell", row.Item("UOM")),
                                                New XElement("cell", row.Item("UnitsBunch")),
                                                New XElement("cell", row.Item("Units")),
                                                New XElement("cell", Convert.ToDecimal(row.Item("TotalUnits")).ToString("#,###,##0")),
                                                New XElement("cell", Convert.ToDecimal(row.Item("FBE")).ToString("#,##0.000")),
                                                New XElement("cell", Convert.ToDecimal(row.Item("Cost")).ToString("#,##0.000")),
                                                New XElement("cell", "$" + Convert.ToDecimal(row.Item("TotalCost")).ToString("#,##0.00")),
                                                New XElement("cell", row.Item("InvenType")),
                                                New XElement("cell", row.Item("Type")),
                                                New XElement("cell", IIf(row.Item("CustNum") <> 0, row.Item("CustNum"), "")),
                                                New XElement("cell", row.Item("Comments")),
                                                New XElement("cell", "<a id='aBoxnum_" + row.Item("ID").ToString() + "' style='text-decoration:underline;cursor:pointer;'>" + row.Item("BoxNumber").ToString() + "</a>"),
                                                New XElement("cell", row.Item("PO")),
                                                New XElement("cell", row.Item("Invoice")),
                                                New XElement("cell", Convert.ToString(row.Item("Days"))),
                                                New XElement("cell", String.Format("<a onclick='PrintInventoryLabelByFlower(""" +
                                                                    row.Item("AWB").ToString() + """, """ + row.Item("Farm").ToString() + """,""" + row.Item("ProductCode") + """,""" + Convert.ToDateTime(row.Item("DateRec")).ToString("MM/dd/yyyy") +
                                                                    """,""" + row.Item("BoxNumber").ToString() + """,""" + TableName + """,""" + ReceivedPiecesOnly + """)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png'/></a>")),
                                                New XElement("cell", "<img style='cursor:pointer;margin-left:-4px;' title='" + GetPersonIconDetails(row.Item("AddUser"), Convert.ToDateTime(row.Item("AddDate")).ToString("MM/dd/yyyy"), row.Item("AddTime"), row.Item("AddApp"), row.Item("UpdateUser"), Convert.ToDateTime(row.Item("UpdateDate")).ToString("MM/dd/yyyy"), row.Item("UpdateTime"), "", row.Item("DeleteUser"), Convert.ToDateTime(row.Item("DeleteDate")).ToString("MM/dd/yyyy"), row.Item("DeleteTime"), "", row.Item("LockUser"), Convert.ToDateTime(row.Item("LockDate")).ToString("MM/dd/yyyy"), row.Item("LockTime"), "") + "' id='imgaddeditDetails_" + row.Item("ID").ToString() + "' src='images/Edit_user.png' />"),
                                                New XElement("cell", "<span id='invenCAT_" & row.Item("ID") & "'>" + row.Item("ProductCategory") + "</span>"),
                                                New XElement("cell", "<span id='invenColor_" & row.Item("ID") & "'>" + row.Item("Color") + "</span>"),
                                                New XElement("cell", "<span id='invenVariety_" & row.Item("ID") & "'>" + row.Item("Variety") + "</span>"),
                                                New XElement("cell", "<span id='invenGrade_" & row.Item("ID") & "'>" + row.Item("Grade") + "</span>"),
                                                New XElement("cell", "<span id='invenWH_" & row.Item("ID") & "'>" + row.Item("WH") + "</span>"),
                                                New XElement("cell", row.Item("AWB")),
                                                New XElement("cell", IIf(row.Item("CreReqID") <> 0, "<a href='#'  title='Farm Credits' id='farmcredit_" & row.Item("ID").ToString() & "~" & row.Item("CreReqID") & "'  style='cursor:pointer;'><img src='images/sadface.png' style='width: 21px;height: 17px;margin-left: -3px;'/></a>", "<a href='#'  title='Farm Credits' id='farmcredit_" & row.Item("ID").ToString() & "~" & row.Item("CreReqID") & "'  style='cursor:pointer;'><img src='images/FACE03.png' style='width: 16px;height: 16px;'/></a>")))))

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Dim idx As Integer = dt.Rows.Count - 1

                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = "Total"
                        ' newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                        ' newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(31).InnerText = ""
                        Return newDoc

                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt(0)("ErrorMessage"), "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryDetailsListByFarm::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                            ByVal query As String, ByVal qtype As String, Filter As String, ByVal TableName As String, ByVal ExportCSV As String, ByVal ReceivedPiecesOnly As String, ByVal AWBFlag As String) As XmlDocument

        Try

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data = Nothing
                data = Inventory.GetInventoryDetailsGridlist(Filter, TableName, ReceivedPiecesOnly, AWBFlag)
                If (data.count <= 0) Then
                    Return Nothing
                End If

                If data(0).ErrorMessage = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() =
                        {"Farm", "DateRec", "CSREC", "FBE"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("CSREC").ColumnName = "Pieces"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    dtCloned.Columns("DateRec").DataType = GetType(String)
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Details")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            Else
                Dim data = Nothing
                Dim FilterCode As String = ""

                If (LoginUserDetails.WarehouseList.Count > 0) Then
                    Dim warehouses As String = ""
                    If LoginUserDetails.WarehouseList.Count > 0 Then
                        warehouses = String.Join("','", LoginUserDetails.WarehouseList.[Select](Function(x) x.WH.ToUpper()))
                    End If
                    FilterCode = " WH IN ('" + warehouses.ToString() + "')"
                End If
                If Filter <> "" Then
                    If FilterCode <> "" Then
                        Filter += " AND " + FilterCode
                    End If
                Else
                    Filter = FilterCode
                End If

                data = Inventory.GetInventoryDetailsGridlist(Filter, TableName, ReceivedPiecesOnly, AWBFlag)
                Dim dt As DataTable = ConvertToDataTable(data)

                If dt.Rows.Count > 0 Then

                    If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                        Dim SelectedPOs As New ArrayList
                        Dim TotalRowCount As Integer = 0

                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If


                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                        New XElement("rows", New XElement("page", page.ToString()),
                                                        New XElement("total", TotalRowCount),
                                                        From row In dt.Rows()
                                                        Select
                                                        New XElement("row", New XAttribute("id", row.Item("Farm") + "_" + row.Item("RowNo").ToString()),
                                                        New XElement("cell", row("Farm")),
                                                        New XElement("cell", Convert.ToDateTime(row("DateRec")).ToString("MM/dd/yyyy")),
                                                        New XElement("cell", row.Item("CSREC")),
                                                        New XElement("cell", Convert.ToDecimal(row.Item("FBE")).ToString("#,##0.000")),
                                                        New XElement("cell", String.Format("<a onclick='PrintInventoryLabelByFlower(""" +
                                                                            row("AWB").ToString() + """,""" + row.Item("Farm").ToString() + ""","""",""" + Convert.ToDateTime(row.Item("DateRec")).ToString("MM/dd/yyyy") +
                                                                            ""","""",""" + TableName + """,""" + ReceivedPiecesOnly + """)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>")))))
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Dim idx As Integer = dt.Rows.Count - 1

                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        Return newDoc

                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt(0)("ErrorMessage"), "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryDetailsList::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryAWBList(ByVal TableName As String, ByVal fromDate As String, ByVal toDate As String) As String
        Try
            Return Inventory.GetInventoryAWBList(TableName, fromDate, toDate)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryAWBList::PageInventory")
            Return Nothing
        End Try
    End Function


    Private Function FormatInventoryAWBnumber(ByVal AWB As String) As String
        Try
            Dim MAWB As String = ""
            If (AWB.Length = 9) Then
                MAWB = AWB.Substring(0, 1) + "-" + AWB.Substring(1, 4) + "-" + AWB.Substring(5, 4)
            ElseIf (AWB.Length = 10) Then
                MAWB = AWB.Substring(0, 2) + "-" + AWB.Substring(2, 4) + "-" + AWB.Substring(6, 4)
            ElseIf (AWB.Length = 11) Then
                MAWB = AWB.Substring(0, 3) + "-" + AWB.Substring(3, 4) + "-" + AWB.Substring(7, 4)
            ElseIf (AWB.Length = 12) Then
                MAWB = AWB.Substring(0, 4) + "-" + AWB.Substring(4, 4) + "-" + AWB.Substring(8, 4)
            Else
                MAWB = AWB
            End If
            Return MAWB
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::FormatInventoryAWBnumber::PageInventory")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryAddEditInfo(ByVal ID As Integer, ByVal TableName As String) As Object
        Try

            Dim data = Nothing
            data = Inventory.GetInventoryAddEditInfo(ID, TableName)

            If data.ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data.ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryAddEditInfo::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryById(ByVal ID As String, ByVal TableName As String) As Object
        Try
            Dim data = Nothing
            'If lReadFromSQL = False Then
            '    data = obj.GetInventoryByID(ID, TableName)
            'Else
            data = Inventory.GetInventoryById(ID, TableName)
            'End If

            If data IsNot Nothing Then                                    'Muthu Nivetha M :: 11 Mar 19 :: Object variable or With block variable not set.
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, "Error in GetInventoryById in BloomService", "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryById::PageInventory")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Muthu Nivetha M :: 05Mar2020 :: Modified :: To save values of othercost,handling,duties/andean and landedcost for Edit Inventory email requirements
    ''' Muthu Nivetha M :: 06Mar2020 :: Modified :: As per Jose's request, removed saving log on updating details from inventory in tblLog table
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveInventoryDetails(ByVal ID As String, ByVal TableName As String, ByVal Flower As String, ByVal FlowerName As String, ByVal FlowerCategory As String, ByVal QtyRec As Integer, ByVal QtySold As Integer, ByVal UOM As String, ByVal UnitsPerBunch As Integer, ByVal Units As Integer, ByVal Cost As Decimal, ByVal InvenType As String, ByVal BoxNum As Integer, ByVal OrderNum As Integer, ByVal PO As String, ByVal Invoice As Integer, ByVal Cust As Integer, ByVal Comments As String, ByVal ColorCode As String, ByVal Type As String, ByVal warehouse As String, ByVal AWB As Int64, ByVal DateRec As String, ByVal Farm As String, ByVal BreakDown As String, ByVal OtherCost As Decimal, ByVal Handling As Decimal, ByVal Duties As Decimal, ByVal LandedCost As Decimal, ByVal SellingPrice As Decimal, ByVal BRAND As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            Else
                Return "logout"
            End If
            FlowerName = System.Net.WebUtility.HtmlDecode(FlowerName)

            Dim result = ""
            result = Inventory.UpdateInventoryDetails(ID, TableName, Flower, FlowerName, FlowerCategory, QtyRec, QtySold, UOM, UnitsPerBunch, Units, Cost, InvenType.ToUpper(), BoxNum, OrderNum, PO, Invoice, Cust, Comments, ColorCode, Type, User.Name, warehouse, Convert.ToString(AWB), DateRec, Farm, BreakDown, OtherCost, Handling, Duties, LandedCost, SellingPrice, BRAND)

            If result = "success" Then
                Dim LoginUserDetails As New User
                If (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                    LoginUserDetails = HttpContext.Current.Session("LoginUserDetails")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                End If
            Else
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
            End If
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveInventoryDetails::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ReleaseInventory(ByVal IDs As String, ByVal ReleaseFrom As String, ByVal ReleaseTo As String) As String
        Try
            Dim result As String
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If User Is Nothing Then
                Return "LogOut"
            End If
            result = Inventory.ReleaseInventory(IDs, ReleaseFrom, ReleaseTo)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ReleaseInventory::PageInventory")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function ReleaseInventoryFromPricing(ByVal IDs As String, ByVal ReleaseFrom As String, ByVal ReleaseTo As String) As String
        Try
            Dim result As String
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If User Is Nothing Then
                Return "LogOut"
            End If
            result = Inventory.ReleaseInventoryFromPricing(IDs, ReleaseFrom, ReleaseTo)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ReleaseInventoryFromPricing::PageInventory")
            Return "error"
        End Try
    End Function
    'Added by Anubhuti 1GetinventoryPricing9/10/2021
    <System.Web.Services.WebMethod(True)>
    Public Function GetinventoryPricing() As String
        Try
            Dim result As String
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If User Is Nothing Then
                Return "LogOut"
            End If
            result = Inventory.GetinventoryPricing(User.ID)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetinventoryPricing::PageInventory")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteInventoryDetails(ByVal ID As String, ByVal TableName As String) As String
        Try
            Dim result As String
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If


            If User Is Nothing Then
                Return "LogOut"
            End If

            result = Inventory.DeleteInventoryDetails(ID, TableName, User.UserName)

            If result = "success" Then
                Dim LoginUserDetails As New User
                If (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                    LoginUserDetails = HttpContext.Current.Session("LoginUserDetails")
                    Logs.Savelog(LoginUserDetails.ID, "Inventory", "DeleteInventoryDetails", "Deleted inventory from " + TableName + ",id is : <b>" + ID.ToString() + "</b>", ID.ToString())
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                    Logs.Savelog(LoginUserDetails.ID, "Inventory", "DeleteInventoryDetails", "Deleted inventory from " + TableName + ",id is : <b>" + ID.ToString() + "</b>", ID.ToString())
                End If
            Else
                'Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
            End If
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteInventoryDetails::PageInventory")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function CheckInvenIDIsExistinVETOrOrder(ByVal InventoryId As String) As String
        Try
            Return Inventory.CheckInvenIDIsExistinVETOrOrder(InventoryId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckInvenIDIsExistinVETOrOrder::PageInventory")
            Return "error"
        End Try
    End Function

    'Private Shared Function ConvertInventoryPurchasedToDatatable(list As List(Of UserDetails)) As DataTable
    '    Dim dt As New DataTable()
    '    dt.Columns.Add("Flower", GetType(String))
    '    dt.Columns.Add("Name", GetType(String))
    '    dt.Columns.Add("UOM", GetType(String))
    '    dt.Columns.Add("Cust", GetType(Integer))
    '    dt.Columns.Add("AWB", GetType(String))
    '    dt.Columns.Add("Farm", GetType(String))
    '    dt.Columns.Add("Comments", GetType(String))
    '    dt.Columns.Add("User", GetType(String))
    '    dt.Columns.Add("+15", GetType(String))
    '    dt.Columns.Add("+14", GetType(String))
    '    dt.Columns.Add("+13", GetType(String))
    '    dt.Columns.Add("+12", GetType(String))
    '    dt.Columns.Add("+11", GetType(String))
    '    dt.Columns.Add("+10", GetType(String))
    '    dt.Columns.Add("+9", GetType(String))
    '    dt.Columns.Add("+8", GetType(String))
    '    dt.Columns.Add("+7", GetType(String))
    '    dt.Columns.Add("+6", GetType(String))
    '    dt.Columns.Add("+5", GetType(String))
    '    dt.Columns.Add("+4", GetType(String))
    '    dt.Columns.Add("+3", GetType(String))
    '    dt.Columns.Add("+2", GetType(String))
    '    dt.Columns.Add("+1", GetType(String))
    '    dt.Columns.Add("0", GetType(String))
    '    dt.Columns.Add("CSREC", GetType(Integer))
    '    dt.Columns.Add("Units", GetType(Integer))
    '    dt.Columns.Add("BoxNum", GetType(String))
    '    dt.Columns.Add("FBE", GetType(Decimal))
    '    dt.Columns.Add("Cost", GetType(String))
    '    For Each item In list
    '        Dim row = dt.NewRow()
    '        row("Flower") = item.FlowerDetails.Flower
    '        row("Name") = item.FlowerDetails.Name
    '        row("UOM") = item.UOM
    '        row("Cust") = item.CustNum
    '        row("AWB") = item.HAWB
    '        row("Farm") = item.Farm
    '        row("Comments") = item.Comments
    '        row("User") = ""
    '        row("+15") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 15, item.CSREC.ToString(), "")
    '        row("+14") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 14, item.CSREC.ToString(), "")
    '        row("+13") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 13, item.CSREC.ToString(), "")
    '        row("+12") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 12, item.CSREC.ToString(), "")
    '        row("+11") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 11, item.CSREC.ToString(), "")
    '        row("+10") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 10, item.CSREC.ToString(), "")
    '        row("+9") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 9, item.CSREC.ToString(), "")
    '        row("+8") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 8, item.CSREC.ToString(), "")
    '        row("+7") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 7, item.CSREC.ToString(), "")
    '        row("+6") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 6, item.CSREC.ToString(), "")
    '        row("+5") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 5, item.CSREC.ToString(), "")
    '        row("+4") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 4, item.CSREC.ToString(), "")
    '        row("+3") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 3, item.CSREC.ToString(), "")
    '        row("+2") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 2, item.CSREC.ToString(), "")
    '        row("+1") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 1, item.CSREC.ToString(), "")
    '        row("0") = IIf((item.DateRec - DateTime.Now.Date).TotalDays = 0, item.CSREC.ToString(), "")
    '        row("CSREC") = item.CSREC
    '        row("UNITS") = item.Units
    '        row("BOXNUM") = item.BoxNumber
    '        row("FBE") = item.FBE
    '        row("Cost") = item.Cost
    '        dt.Rows.Add(row)
    '    Next
    '    Return dt
    'End Function

    '<System.Web.Services.WebMethod(True)>
    '<ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    'Public Function GetInventoryUserPurchaseList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    '                                       ByVal query As String, ByVal qtype As String, Filter As String, ByVal ConsolidateType As String, ByVal ExportCSV As String) As XmlDocument
    '    Try

    '        If qtype.ToLower() = "lot" Then
    '            query = Regex.Replace(query, "[-]", "")
    '        End If

    '        Dim whereCondition As String = ""
    '        If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
    '            whereCondition = BuildWhereCondition(GetType(BO.Inventory), qtype, query.Replace("'", "''"))
    '            If (Filter <> String.Empty And whereCondition <> String.Empty) Then
    '                whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
    '            ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
    '                whereCondition = whereCondition
    '            End If
    '        Else
    '            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
    '                whereCondition = Filter.Replace("&amp;", "&")
    '            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
    '                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
    '            End If
    '        End If


    '        Dim sortExp As String = sortname & " " & sortorder
    '        Dim start As Integer = ((page - 1) * rp) + 1
    '        rp -= 1

    '        If (page <= 0) Then
    '            rp = 0
    '            start = 0
    '        End If

    '        If (ExportCSV <> "") Then

    '            Dim splitExportcsv = ExportCSV.Split("|")

    '            Dim data = obj.GetUserConsolidate_FG(whereCondition.ToUpper(), sortExp, start, rp, ConsolidateType.ToUpper)
    '            Dim TotalRowCount As Integer = 0

    '            If data.Length > 0 Then
    '                TotalRowCount = data(0).TotalRows.ToString()
    '            End If
    '            If data.Length > 0 Then
    '                If data(0).ErrorMessage = "" Then
    '                    Dim dt1 As New DataTable()
    '                    'dt1 = ConvertInventoryPurchasedToDatatable(data.ToList())

    '                    Dim selectedColumns As String() =
    '                        {"Flower", "Name", "CSREC", "UOM", "Units", "Cust", "AWB", "Farm", "BoxNum", "FBE", "Comments", "User", "+15", "+14", "+13", "+12", "+11", "+10", "+9", "+8", "+7", "+6", "+5", "+4",
    '                         "+3", "+2", "+1", "0"}

    '                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
    '                    dt.Columns("Name").ColumnName = "Description"
    '                    dt.Columns("Cust").ColumnName = "Cust#"
    '                    dt.Columns("AWB").ColumnName = "AWB#"
    '                    dt.Columns("CSREC").ColumnName = "Boxes"
    '                    'dt.Rows.RemoveAt(dt.Rows.Count - 1)
    '                    Dim dtCloned As DataTable = dt.Clone()
    '                    For Each row As DataRow In dt.Rows
    '                        row("AWB#") = FormatInventoryAWBnumber(row("AWB#"))
    '                        dtCloned.ImportRow(row)
    '                    Next
    '                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Purchased")
    '                    Return BuildXmlDoc(filepath)
    '                Else
    '                    Dim User As New User
    '                    If Not Session("LoginUserDetails") Is Nothing Then
    '                        User = Session("LoginUserDetails")
    '                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                        User = Session("LoginAdminDetails")
    '                    End If
    '                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
    '                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
    '                End If
    '            Else
    '                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
    '                                                New XElement("rows", New XElement("page", page.ToString()),
    '                                                New XElement("total", TotalRowCount)))
    '                Dim newDoc As New XmlDocument()
    '                newDoc.LoadXml(Convert.ToString(xmlDoc))
    '                Return newDoc
    '            End If
    '        Else
    '            'Dim data = Nothing
    '            'If ConsolidateType.ToUpper() = "COOLER" And lReadFromSQL = True Then
    '            '    'data =inv
    '            'Else
    '            Dim data = obj.GetUserConsolidate_FG(whereCondition.ToUpper(), sortExp, start, rp, ConsolidateType.ToUpper)
    '            'End If


    '            Dim TotalRowCount As Integer = 0

    '            If data.Length > 0 Then
    '                TotalRowCount = data(0).TotalRows.ToString()
    '            End If
    '            If data.Length > 0 Then
    '                If data(0).ErrorMessage = "" Then
    '                    Dim FlowerColorVisibility As Boolean = False
    '                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
    '                    For Each i In UserFeatures
    '                        If i.Name.ToLower = "show flower color" Then
    '                            FlowerColorVisibility = i.Value
    '                        End If
    '                    Next


    '                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
    '                                                New XElement("rows", New XElement("page", page.ToString()),
    '                                                New XElement("total", TotalRowCount),
    '                                                data.Select(Function(row) New XElement("row", New XAttribute("id", row.RowNo.ToString()),
    '                                                New XElement("cell", "<span title='" + row.Cost + "'>" & row.FlowerDetails.Flower & "</span>"),
    '                                                New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.FlowerDetails.BGColor.ToString() +
    '                                                                                   ";cursor:pointer;color:" + row.FlowerDetails.FontColor.ToString() +
    '                                                                                   "' class='flowerDescription' title='" + row.FlowerDetails.Name.Replace("'", "") + "'>" &
    '                                                                                   row.FlowerDetails.Name & "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' " +
    '                                                                                   "class='flowerDescription' title='" + row.FlowerDetails.Name.Replace("'", "") + "'>" &
    '                                                                                   row.FlowerDetails.Name & "</div>"))),
    '                                                New XElement("cell", row.UOM),
    '                                                New XElement("cell", IIf(Convert.ToString(row.CustNum) = "0", "", row.CustNum)),
    '                                                New XElement("cell", row.HAWB),
    '                                                New XElement("cell", row.Farm),
    '                                                New XElement("cell", row.Comments),
    '                                                New XElement("cell", ""),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 15, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 14, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 13, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 12, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 11, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 10, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 9, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 8, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 7, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 6, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 5, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 4, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 3, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 2, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 1, row.CSREC.ToString(), "")),
    '                                                New XElement("cell", IIf((row.DateRec - DateTime.Now.Date).TotalDays = 0, row.CSREC.ToString(), ""))))))
    '                    Dim newDoc As New XmlDocument()
    '                    newDoc.LoadXml(Convert.ToString(xmlDoc))
    '                    'If (ExportCSV <> "") Then
    '                    '    Dim splitExportcsv = ExportCSV.Split("|")
    '                    '    Dim filepath = ExportToCSV.CreateCSVList(xmlDoc.ToString(), splitExportcsv(1))
    '                    '    Return BuildXmlDoc(filepath)
    '                    'End If

    '                    Return newDoc
    '                Else
    '                    Dim User As New User
    '                    If Not Session("LoginUserDetails") Is Nothing Then
    '                        User = Session("LoginUserDetails")
    '                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                        User = Session("LoginAdminDetails")
    '                    End If
    '                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
    '                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
    '                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
    '                End If
    '            Else
    '                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
    '                                                New XElement("rows", New XElement("page", page.ToString()),
    '                                                New XElement("total", TotalRowCount)))
    '                Dim newDoc As New XmlDocument()
    '                newDoc.LoadXml(Convert.ToString(xmlDoc))
    '                Return newDoc
    '            End If
    '        End If

    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetInventoryUserPurchaseList::PageInventory")
    '        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerDetailsByCode(ByVal Flower As String) As Object
        Try
            Return Flowers.GetFlowerDetailsByCode(Flower)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFlowerDetailsByCode::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAllFlowerByCode(ByVal Flower As String) As Object
        Try
            Return Flowers.GetAllFlowerByCode(Flower)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAllFlowerByCode::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetTypeForInventory() As Object
        Try
            Dim data = Nothing
            data = Inventory.GetTypeForInventory()

            If data(0).ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data.ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTypeForInventory::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInvenTypeForInventory() As Object
        Try
            Dim data = Nothing
            data = Inventory.GetInvenTypeForInventory()

            If data(0).ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data.ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInvenTypeForInventory::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function InsertInventoryLock(ByVal InventoryId As String) As String
        Try
            Return Inventory.InsertInventoryLock(InventoryId)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::InsertInventoryLock::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteInventoryLock(ByVal InventoryId As String) As String
        Try
            Return Inventory.DeleteInventoryLock(InventoryId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteInventoryLock::PageInventory")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' MANI::07/July/2018::Method to print cooler inventory Report
    ''' ANITHA :: 10/Dec/2018 :: Add new param Received only
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintCoolerInventoryListingReport(ByVal whereclause As String, ByVal ReceivedPiecesOnly As String, ByVal CoolerDisplay As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim WH As String = ""
            For Each r In User.WarehouseList
                WH += IIf(r.WH <> "", "'" + r.WH + "'" + ",", "'',")
            Next

            If WH <> "" Then
                whereclause += IIf(whereclause <> "", " WH in(" + WH.TrimEnd(",") + ") And", "WH in(" + WH.TrimEnd(",") + ") And")
            End If

            Dim BodyMessage As String = ""
            Dim foldername As String = ""
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim filename As String = ""
            filename = "CoolerInventoryListing_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"
            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS
            Dim FullFileName As String = SysPath & filename

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)
            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "whereclause"
            reportParameterCollection(1).Values.Add(whereclause)
            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ReceivedPiecesOnly"
            reportParameterCollection(2).Values.Add(ReceivedPiecesOnly)
            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "CoolerDisplay"
            reportParameterCollection(3).Values.Add(CoolerDisplay)

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim s As String = objPdf.ExportToPdf(filename, "rptCoolerInventoryListing", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, RptDataSourceName)



            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'If Not s.Trim().Contains("error : ") Then
            '    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'End If
            Return ReportExportFolder + "\" + filename
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintManualPOLabelByHeader")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintPhysicalInventoryReport(ByVal Awb As Long) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            Dim User As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim WH As String = ""
            For Each r In User.WarehouseList
                WH += IIf(r.WH <> "", "'" + r.WH + "'" + ",", "'',")
            Next

            'If WH <> "" Then
            '    whereclause = " WH in(" + WH.TrimEnd(",") + ") And", "WH in(" + WH.TrimEnd(",") + ") And")
            'End If

            Dim BodyMessage As String = ""
            Dim foldername As String = ""
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim filename As String = ""
            filename = "PhysicalInventory_as_of_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"
            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS
            Dim FullFileName As String = SysPath & filename

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)
            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "Awb"
            reportParameterCollection(1).Values.Add(Awb)

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim s As String = objPdf.ExportToPdf(filename, "rptPhysicalInventory", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, RptDataSourceName)



            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'If Not s.Trim().Contains("error : ") Then
            '    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'End If
            'Return ReportExportFolder + "\" + filename
            Return filename
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintManualPOLabelByHeader")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' MANI::07/July/2018::Method to print cooler inventory Report
    ''' ANITHA :: 10/Dec/2018 :: Add new param Received only
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintEndofMonthCoolerInventoryListingReport(ByVal whereclause As String, ByVal ReportDt As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim WH As String = ""
            For Each r In User.WarehouseList
                WH += IIf(r.WH <> "", "'" + r.WH + "'" + ",", "'',")
            Next

            If WH <> "" Then
                whereclause += IIf(whereclause <> "", " WH in(" + WH.TrimEnd(",") + ") And", "WH in(" + WH.TrimEnd(",") + ") And")
            End If

            Dim BodyMessage As String = ""
            Dim foldername As String = ""
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim filename As String = ""
            filename = "EndofMonthCoolerInventoryListing_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"
            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS
            Dim FullFileName As String = SysPath & filename

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)
            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "whereclause"
            reportParameterCollection(1).Values.Add(whereclause)
            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "todate"
            'reportParameterCollection(2).Values.Add(DateTime.Today.AddDays(DateTime.Today.Day * -1))
            reportParameterCollection(2).Values.Add(ReportDt)

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim s As String = objPdf.ExportToPdf(filename, "rptEndofMonthCoolerInventoryListing", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, RptDataSourceName)



            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'If Not s.Trim().Contains("error : ") Then
            '    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'End If
            Return ReportExportFolder + "\" + filename
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintEndofMonthCoolerInventoryListingReport")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintReceiptsSummaryReport(ByVal whereclause As String, ByVal FromDate As String, ByVal ToDate As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            ''generate csv  and send an email
            Inventory.ReceiptsSummaryForQB(FromDate, ToDate)
            ''''
            Dim WH As String = ""
            For Each r In User.WarehouseList
                WH += IIf(r.WH <> "", "'" + r.WH + "'" + ",", "'',")
            Next

            If WH <> "" Then
                whereclause += IIf(whereclause <> "", " WH in(" + WH.TrimEnd(",") + ") And", "WH in(" + WH.TrimEnd(",") + ") And")
            End If

            Dim BodyMessage As String = ""
            Dim foldername As String = ""
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim filename As String = ""
            filename = "ReceiptsSummary_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"
            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS
            Dim FullFileName As String = SysPath & filename

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)
            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "whereclause"
            reportParameterCollection(1).Values.Add(whereclause)
            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "fromdate"
            reportParameterCollection(2).Values.Add(FromDate)
            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "todate"
            reportParameterCollection(3).Values.Add(ToDate)

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim s As String = objPdf.ExportToPdf(filename, "rptReceiptsSummary", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, RptDataSourceName)


            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'If Not s.Trim().Contains("error : ") Then
            '    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'End If
            Return ReportExportFolder + "\" + filename
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintReceiptsSummaryReport")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintHandlingReport(ByVal whereclause As String, ByVal FromDate As String, ByVal ToDate As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If


            Dim WH As String = ""
            For Each r In User.WarehouseList
                WH += IIf(r.WH <> "", "'" + r.WH + "'" + ",", "'',")
            Next

            If WH <> "" Then
                whereclause += IIf(whereclause <> "", " ih.WH in(" + WH.TrimEnd(",") + ") And", "ih.WH in(" + WH.TrimEnd(",") + ") And")
            End If

            Dim BodyMessage As String = ""
            Dim foldername As String = ""
            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim filename As String = ""
            filename = "HandlingReport_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"
            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS
            Dim FullFileName As String = SysPath & filename

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)
            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "whereclause"
            reportParameterCollection(1).Values.Add(whereclause)
            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "fromdate"
            reportParameterCollection(2).Values.Add(FromDate)
            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "todate"
            reportParameterCollection(3).Values.Add(ToDate)

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim s As String = objPdf.ExportToPdf(filename, "rptHandlingReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, RptDataSourceName)


            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            'If Not s.Trim().Contains("error : ") Then
            '    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'End If
            Return ReportExportFolder + "\" + filename
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintHandlingReport")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="huntawbno"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintHuntList(ByVal huntawbno As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = Inventory.GetHuntList(huntawbno)
            Dim selectedColumns As String() = {"ORDER", "CUSTOMER", "FARM", "FLOWER", "DESCRIPTION", "QTY", "UNITS", "UOM", "BOXNUM", "IDINVEN", "AWB#", "DATE", "ADDUSER", "ADDDATE", "ADDTIME", "ADDAPP"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            'dt.Columns("AWB").ColumnName = "AWB"
            'dt.Columns("FARMCODE").ColumnName = "FARMCODE" 
            'dt.Columns("FLOWER").ColumnName = "FLOWER"

            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "HuntList$HuntList")
            Return filepath

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintHuntList::PageInventory")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' Fetch receiving date from ARHIST :: Created by Abinaya :: 10Jul2018
    ''' </summary>
    ''' <param name="AWB"></param>
    ''' <returns>Receiving date</returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetDateRecDetailsByAWB(ByVal AWB As String) As String
        Try
            Return Inventory.GetDateRecDetailsByAWB(Convert.ToInt64(AWB))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDateRecDetailsByAWB::PageInventory")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' Update new AWB details on its corresponding tables :: Created by Abinaya :: 10Jul2018
    ''' </summary>
    ''' <param name="OldAWB"></param>
    ''' <param name="OldWarehouse"></param>
    ''' <param name="OldFarm"></param>
    ''' <param name="OldProduct"></param>
    ''' <param name="OldBoxnum"></param>
    ''' <param name="NewAWB"></param>
    ''' <param name="NewWarehouse"></param>
    ''' <param name="NewFarm"></param>
    ''' <param name="NewRecDate"></param>
    ''' <param name="NewCost"></param>
    ''' <returns>Success string</returns>
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateNewAWBDetails(OldAWB As String, OldWarehouse As String, OldFarm As String, OldProduct As String, OldBoxnum As String, OldInvoice As String, OldRecDate As String, NewAWB As String, NewWarehouse As String, NewFarm As String, NewRecDate As String, NewCost As String, NewInvoice As String) As String
        Try
            Return Inventory.UpdateNewAWBDetails(If(OldAWB = "", 0, Convert.ToInt64(OldAWB)), OldWarehouse, OldFarm, OldProduct, If(OldBoxnum = "", 0, Convert.ToInt32(OldBoxnum)), OldInvoice, OldRecDate, If(NewAWB = "", 0, Convert.ToInt64(NewAWB)), NewWarehouse, NewFarm, NewRecDate, If(NewCost = "", 0.0, Convert.ToDecimal(NewCost)), NewInvoice)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateNewAWBDetails::PageInventory")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' ABI::19/July/2018::Method to print discrepancy Report
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintDiscrepancyReport() As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            Dim BodyMessage As String = ""

            Dim foldername As String = ""

            Dim RptDataSourceName As String = "BloomsReportSource"
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim filename As String = ""
            filename = "DiscrepancyReport_" + DateTime.Now.ToString("yyyy_MM_dd HH_mm_ss_fff") + ".pdf"

            foldername = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + ConfigurationManager.AppSettings("ExportFolder").ToString()
            ' Dim SysPath As String = HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim SysPath As String = foldername

            Dim objPdf As New ExportSSRS

            Dim FullFileName As String = SysPath & filename

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(0) {}

            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()

            Dim s As String = objPdf.ExportToPdf(filename, "rptDiscrepancy", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, RptDataSourceName)

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()

            'If Not s.Trim().Contains("error : ") Then
            '    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Manual PO Label by Header for Awb#" + AWBs.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + TotalLabelCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
            'End If
            Return ReportExportFolder + "\" + filename


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDiscrepancyReport")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="page"></param>
    ''' <param name="rp"></param>
    ''' <param name="sortname"></param>
    ''' <param name="sortorder"></param>
    ''' <param name="query"></param>
    ''' <param name="qtype"></param>
    ''' <param name="Filter"></param>
    ''' <param name="ExportCSV"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetViewInventoryTransactionsGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                                  ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return Nothing
            End If

            If ExportCSV <> "" Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing

                'If lReadFromSQL = False Then
                ''data = obj.GetViewInventoryTransactionsGrid_FG(page, splitExportcsv(2), sortname, sortorder, query, qtype, Filter)
                'Else
                data = Inventory.GetViewInventoryTransactionsGrid(Filter)
                'End If

                If (data.count <= 0) Then
                    Return Nothing
                End If

                If data(0).ErrorMessage = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() =
                            {"Farm", "ProductCode", "ProductName", "CSREC", "UOM", "UnitsBunch", "Units", "TotalUnits", "FBE", "Cost", "TotalCost", "InvenType", "CustNum",
                            "Comments", "BoxNumber", "PO", "Invoice"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("ProductCode").ColumnName = "Flower"
                    dt.Columns("ProductName").ColumnName = "Description"
                    dt.Columns("CSREC").ColumnName = "Boxes"
                    dt.Columns("TotalCost").ColumnName = "$Total"
                    dt.Columns("InvenType").ColumnName = "Type"
                    dt.Columns("CustNum").ColumnName = "Cust#"
                    dt.Columns("BoxNumber").ColumnName = "Box#"
                    dt.Columns("PO").ColumnName = "PO#"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Farm")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            Else
                Dim data = Nothing
                data = Inventory.GetViewInventoryTransactionsGrid(Filter)

                If data Is Nothing Then
                    Return BuildFlexiGridError("Sorry... no information found on file.")
                End If

                Dim dt As DataTable = ConvertToDataTable(data)

                If dt.Rows.Count > 0 Then

                    If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                        Dim SelectedPOs As New ArrayList
                        Dim TotalRowCount As Integer = 0

                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt(0)("TotalRows").ToString()
                        End If

                        Dim FlowerColorVisibility As Boolean = False
                        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        For Each i In UserFeatures
                            If i.Name.ToLower = "show flower color" Then
                                FlowerColorVisibility = i.Value
                            End If
                        Next

                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                New XElement("rows", New XElement("page", page.ToString()),
                                                New XElement("total", TotalRowCount),
                                                From row In dt.Rows()
                                                Select
                                                New XElement("row", New XAttribute("id", row.Item("ID").ToString()),
                                                New XElement("cell", row.Item("TransType")),
                                                New XElement("cell", row.Item("Farm")),
                                                New XElement("cell", row.Item("ProductCode")),
                                                New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Item("FlowerDetails").BGColor.ToString() + ";cursor:Pointer;color:" + row.Item("FlowerDetails").FontColor.ToString() +
                                                                                    "' class='flowerDescription' title='" + row.Item("ProductName").Replace("'", "") + "'>" & row.Item("ProductName") &
                                                                                    "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                    row.Item("ProductName").Replace("'", "") + "'>" & row.Item("ProductName") & "</div>"))),
                                                New XElement("cell", row.Item("WH")),
                                                New XElement("cell", If(row.Item("AWB") <> "" And row.Item("AWB") <> String.Empty, FormatAWBnumber(row.Item("AWB")), "")),
                                                New XElement("cell", Convert.ToDateTime(row.Item("DateRec")).ToString("MM/dd/yy")),
                                                New XElement("cell", row.Item("FLAG")),
                                                New XElement("cell", row.Item("CSREC")),
                                                New XElement("cell", row.Item("CSSOLD")),
                                                New XElement("cell", row.Item("UOM")),
                                                New XElement("cell", row.Item("UnitsBunch")),
                                                New XElement("cell", row.Item("Units")),
                                                New XElement("cell", Convert.ToDecimal(row.Item("Cost")).ToString("#,##0.000")),
                                                New XElement("cell", row.Item("InvenType")),
                                                New XElement("cell", IIf(row.Item("CustNum") <> 0, row.Item("CustNum"), "")),
                                                New XElement("cell", row.Item("Comments")),
                                                New XElement("cell", row.Item("BoxNumber")),
                                                New XElement("cell", row.Item("PO")),
                                                New XElement("cell", row.Item("Invoice")),
                                                New XElement("cell", row.Item("adddate")),
                                                New XElement("cell", row.Item("adduser")))))


                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Dim idx As Integer = dt.Rows.Count - 1

                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                        Return newDoc

                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt(0)("ErrorMessage"), "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryDetailsListByFarm::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryTransInfo(ByVal ID As String) As Object
        Try

            Dim data = Nothing
            data = Inventory.GetInventoryTransInfo(ID)
            If data.ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data.ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryTransInfo::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadMultipleFarmsDropdownWhenSelling(ByVal InvenIDs As String) As List(Of BO.Inventory)
        Try
            Return Inventory.LoadMultipleFarmsDropdownWhenSelling(InvenIDs)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadMultipleFarmsDropdownWhenSelling")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInvenTransAWBForAutoComplete(ByVal SearchText As String) As List(Of BO.InventoryTrans)
        Try
            Return Inventory.GetInvenTransAWBForAutoComplete(SearchText)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInvenTransAWBForAutoComplete::PageInventory")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Get InventId by farm number And box number  By mani: 05Sep2018
    ''' </summary>
    ''' <param name="Farmno"></param>
    ''' <param name="Boxno"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetinvenIdbyfarmandbox(ByVal Farmno As String, ByVal Boxno As Integer) As BO.Inventory
        Try
            Return Inventory.GetInvenID(Farmno, Boxno)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetinvenIdbyfarmandbox")
            Return Nothing
        End Try
    End Function




#End Region

#Region "InventoryUsers"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryUserHeaderList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                           ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If


            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Inventory), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            'Dim DateSession(1) As String
            'If (Not Session("DateSession") Is Nothing) Then
            '    DateSession = Session("DateSession")
            'Else
            '    DateSession = Nothing
            'End If

            'Dim FromDate As String = ""
            'Dim ToDate As String = ""
            'If (DateSession Is Nothing) Then
            '    'FromDate = DateTime.Now.ToString("MM/dd/yyyy")
            '    ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            'Else
            '    FromDate = DateSession(0).ToString()
            '    ToDate = DateSession(1).ToString()
            'End If

            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim FilterCode As String = ""



            If Filter <> "" Then
                If (FilterCode <> "") Then
                    Filter += " And " + FilterCode
                End If
            Else
                'If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                '    FilterCode = "DATEREC >= ctod('" + ToDate + "') "
                'Else
                '    FilterCode = "DATEREC >= ctod('" + FromDate + "') " + " And " + " DATEREC <= ctod('" + ToDate + "')"
                'End If
                Filter += FilterCode
            End If

            If ExportCSV <> "" Then

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing

                data = Inventory.GetInventoryUserHeaderGridlist(whereCondition.ToUpper(), sortExp, start, rp)


                If data Is Nothing Then
                    Return Nothing
                End If

                If lReadFromSQL = True Then
                    If (data.count <= 0) Then
                        Return Nothing
                    End If
                Else
                    If (data.length <= 0) Then
                        Return Nothing
                    End If
                End If

                If Convert.ToString(data(0).ErrorMessage) = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() =
                        {"AWB", "DateRec", "Qty", "FBE", "USERFileNo"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("DateRec").ColumnName = "Received"
                    dt.Columns("Qty").ColumnName = "Pieces"
                    dt.Columns("USERFileNo").ColumnName = "FileName"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    dtCloned.Columns("Received").DataType = GetType(String)
                    dtCloned.Columns("AWB").DataType = GetType(String)
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "UserHeader")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            Else

                Dim data = Nothing
                data = Inventory.GetInventoryUserHeaderGridlist(whereCondition.ToUpper(), sortExp, start, rp)

                Dim dt As DataTable
                If Not data Is Nothing Then
                    dt = ConvertToDataTable(data)
                Else
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc
                End If




                If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                    Dim TotalRowCount As Integer = 0

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", dt.Rows.Count),
                                                    From row In dt
                                                    Select
                                                    New XElement("row", New XAttribute("id", row("RowNo").ToString()),
                                                    New XElement("cell", FormatInventoryAWBnumber(row("AWB"))),
                                                    New XElement("cell", Convert.ToDateTime(row("DateRec")).ToString("MM/dd/yyyy")),
                                                    New XElement("cell", row("Qty").ToString()),
                                                    New XElement("cell", Convert.ToDecimal(row("FBE")).ToString("#,##0.000")),
                                                    New XElement("cell", row("Farm")),
                                                    New XElement("cell", row("USERFileNo")),
                                                    New XElement("cell", row("USERFileNo").ToUpper().Replace("WINVNW", "")),
                                                    New XElement("cell", String.Format("<a onclick='PrintInventoryLabelByFlower(""" +
                                                                        row("AWB").ToString() + ""","""","""",""" + Convert.ToDateTime(row("DateRec")).ToString("MM/dd/yyyy") +
                                                                        ""","""",""" + row("USERFileNo") + """)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png'/></a>")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Dim idx As Integer = dt.Rows.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""

                    Return newDoc
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, Convert.ToString(dt(0)("ErrorMessage")), "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryUserHeaderList::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryUserFarmDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                           ByVal query As String, ByVal qtype As String, Filter As String, ByVal TableName As String, ByVal ExportCSV As String) As XmlDocument
        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If


            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Inventory), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing

                If lReadFromSQL = False Then
                    'data = obj.GetUserDetails_FG(whereCondition, sortExp, start, rp, TableName)
                Else
                    data = Inventory.GetUserDetailsGridlist(whereCondition, sortExp, start, rp, TableName)
                End If


                If data Is Nothing Then
                    Return Nothing
                End If

                If lReadFromSQL = True Then
                    If (data.count <= 0) Then
                        Return Nothing
                    End If
                Else
                    If (data.length <= 0) Then
                        Return Nothing
                    End If
                End If





                If Convert.ToString(data(0).ErrorMessage) = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() = {"Farm", "Flower", "Name", "CSREC", "UOM", "FBE", "UnitsBunch", "Units", "TotalUnits", "Cost", "TotalCost", "InvenType", "CustNum",
                                                       "Comments", "BoxNumber", "PO", "Invoice", "AWB", "DateRec"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("CSREC").ColumnName = "Boxes"
                    dt.Columns("UnitsBunch").ColumnName = "Units/Bunch"
                    dt.Columns("TotalCost").ColumnName = "$Total"
                    dt.Columns("InvenType").ColumnName = "Type"
                    dt.Columns("CustNum").ColumnName = "Cust#"
                    dt.Columns("PO").ColumnName = "PO#"
                    dt.Columns("DateRec").ColumnName = "Date"
                    dt.Columns("Name").ColumnName = "Description"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    dtCloned.Columns("Date").DataType = GetType(String)
                    dtCloned.Columns("AWB").DataType = GetType(String)
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "UserDetailsFarm")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, Convert.ToString(data(0).ErrorMessage), "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim data = Nothing
                data = Inventory.GetInventoryUserFarmGridlist(whereCondition, sortExp, start, rp, TableName)

                Dim dt As DataTable
                dt = ConvertToDataTable(data)


                If Not dt Is Nothing Then
                    If dt.Rows.Count <= 0 Then
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml("<rows><total>0</total></rows>")
                        Return newDoc
                    End If
                Else
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc
                End If


                If Convert.ToString(dt(0)("ErrorMessage")) = "" Then


                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", dt.Rows.Count),
                                                    From row In dt
                                                    Select
                                                    New XElement("row", New XAttribute("id", row.Item("RowNo").ToString()),
                                                    New XElement("cell", row.Item("Farm")),
                                                    New XElement("cell", row.Item("Qty").ToString()),
                                                    New XElement("cell", Convert.ToDecimal(row.Item("FBE")).ToString("#,##0.000")),
                                                    New XElement("cell", Convert.ToDateTime(row.Item("DateRec")).ToString("MM/dd/yyyy")),
                                                    New XElement("cell", row.Item("AWB")),
                                                    New XElement("cell", row.Item("USERFileNo")), New XElement("cell", String.Format("<a onclick='PrintInventoryLabelByFlower(""" +
                                                                        row.Item("AWB").ToString() + """, """ + row.Item("Farm").ToString() + ""","""",""" + Convert.ToDateTime(row.Item("DateRec")).ToString("MM/dd/yyyy") +
                                                                        """, """", """ + row.Item("USERFileNo") + """)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png'/></a>")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Dim idx As Integer = dt.Rows.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    Return newDoc
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, Convert.ToString(dt(0)("ErrorMessage")), "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryUserFarmDetailsList::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryUserDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                           ByVal query As String, ByVal qtype As String, Filter As String, ByVal TableName As String, ExportCSV As String) As XmlDocument
        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If


            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Inventory), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing

                data = Inventory.GetUserDetailsGridlist(whereCondition, sortExp, start, rp, TableName)


                If data Is Nothing Then
                    Return Nothing
                End If

                If (data.count <= 0) Then
                    Return Nothing
                End If




                If Convert.ToString(data(0).ErrorMessage) = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() = {"Farm", "Flower", "Name", "CSREC", "UOM", "FBE", "UnitsBunch", "Units", "TotalUnits", "Cost", "TotalCost", "InvenType", "CustNum",
                                                       "Comments", "BoxNumber", "PO", "Invoice", "AWB", "DateRec"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("CSREC").ColumnName = "Boxes"
                    dt.Columns("UnitsBunch").ColumnName = "Units/Bunch"
                    dt.Columns("TotalCost").ColumnName = "$Total"
                    dt.Columns("InvenType").ColumnName = "Type"
                    dt.Columns("CustNum").ColumnName = "Cust#"
                    dt.Columns("PO").ColumnName = "PO#"
                    dt.Columns("DateRec").ColumnName = "Date"
                    dt.Columns("Name").ColumnName = "Description"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    dtCloned.Columns("Date").DataType = GetType(String)
                    dtCloned.Columns("AWB").DataType = GetType(String)
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "UserDetailsFarm")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, Convert.ToString(data(0).ErrorMessage), "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else

                Dim data = Nothing
                data = Inventory.GetUserDetailsGridlist(whereCondition, sortExp, start, rp, TableName)

                Dim dt As DataTable
                dt = ConvertToDataTable(data)


                If Not dt Is Nothing Then
                    If dt.Rows.Count <= 0 Then
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml("<rows><total>0</total></rows>")
                        Return newDoc
                    End If
                Else
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc
                End If





                If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                    'Dim TotalRowCount As Integer = 0

                    'If data.Count > 0 Then
                    '    TotalRowCount = data(0).TotalRows.ToString()
                    'End If

                    Dim FlowerColorVisibility As Boolean = False
                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    For Each i In UserFeatures
                        If i.Name.ToLower = "show flower color" Then
                            FlowerColorVisibility = i.Value
                        End If
                    Next


                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", dt.Rows.Count),
                                                    From row In dt
                                                    Select
                                                    New XElement("row", New XAttribute("id", row("RowNo").ToString()),
                                                    New XElement("cell", "<b><a href='#' id='deleteInventoryUserdetail_" & row("RowNo") & "'><img src='images/Delete-icon.png'/></a></b>"),
                                                    New XElement("cell", "<b><a href='#' id='editInventoryUserdetail_" & row("RowNo") & "'><img src='images/Edit.png'/></a></b>"),
                                                    New XElement("cell", row("Farm")),
                                                    New XElement("cell", row("Flower")),
                                                    New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("FlowerDetails").BGColor.ToString() +
                                                                                       ";cursorPointer;color:" + row("FlowerDetails").FontColor.ToString() +
                                                                                       "' class='flowerDescription' title='" + Convert.ToString(row("Name")).Replace("'", "") +
                                                                                       "'>" & Convert.ToString(row("Name")) & "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                        Convert.ToString(row("Name")).Replace("'", "") + "'>" & Convert.ToString(row("Name")) & "</div>"))),
                                                    New XElement("cell", row("CSREC").ToString()),
                                                    New XElement("cell", row("UOM")),
                                                    New XElement("cell", Convert.ToDecimal(row("FBE")).ToString("#,##0.000")),
                                                    New XElement("cell", row("UnitsBunch")),
                                                    New XElement("cell", row("Units").ToString()),
                                                    New XElement("cell", row("TotalUnits").ToString()),
                                                    New XElement("cell", row("Cost").ToString()),
                                                    New XElement("cell", "$" + Convert.ToDecimal(row("TotalCost")).ToString("#,##0.00")),
                                                    New XElement("cell", row("InvenType")),
                                                    New XElement("cell", IIf(Convert.ToString(row("CustNum")) = "0", "", row("CustNum"))),
                                                    New XElement("cell", row("Comments")),
                                                    New XElement("cell", row("BoxNumber")),
                                                    New XElement("cell", row("PO")),
                                                    New XElement("cell", row("Invoice")),
                                                    New XElement("cell", Convert.ToDateTime(row("DateRec")).ToString("MM/dd/yyyy")),
                                                    New XElement("cell", row("AWB")),
                                                    New XElement("cell", TableName),
                                                    New XElement("cell", String.Format("<a onclick='PrintInventoryLabelByFlower(""" +
                                                                        row("AWB").ToString() + """, """ + row("Farm").ToString() + """,""" + row("Flower") + """,""" + Convert.ToDateTime(row("DateRec")).ToString("MM/dd/yyyy") +
                                                                        """,""" + row("BoxNumber").ToString() + """, """ + TableName + """)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png'/></a>")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Dim idx As Integer = dt.Rows.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                    Return newDoc
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryUserDetailsList::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    Private Shared Function ConvertInventoryConsolidateToDatatable(dt1 As DataTable) As DataTable
        Try
            Dim dt As New DataTable()
            dt.Columns.Add("Cat", GetType(String))
            dt.Columns.Add("Flower", GetType(String))
            dt.Columns.Add("Name", GetType(String))
            dt.Columns.Add("UOM", GetType(String))
            dt.Columns.Add("WH", GetType(String))
            dt.Columns.Add("Cust", GetType(Integer))
            dt.Columns.Add("AWB", GetType(String))
            dt.Columns.Add("Farm", GetType(String))
            dt.Columns.Add("Comments", GetType(String))
            dt.Columns.Add("User", GetType(String))
            dt.Columns.Add("+3", GetType(String))
            dt.Columns.Add("+2", GetType(String))
            dt.Columns.Add("+1", GetType(String))
            dt.Columns.Add("0", GetType(String))
            dt.Columns.Add("1", GetType(String))
            dt.Columns.Add("2", GetType(String))
            dt.Columns.Add("3", GetType(String))
            dt.Columns.Add("4", GetType(String))
            dt.Columns.Add("5", GetType(String))
            dt.Columns.Add("6", GetType(String))
            dt.Columns.Add("7", GetType(String))
            dt.Columns.Add("8", GetType(String))
            dt.Columns.Add("9", GetType(String))
            dt.Columns.Add("10", GetType(String))
            dt.Columns.Add("11", GetType(String))
            dt.Columns.Add("12", GetType(String))
            dt.Columns.Add("13", GetType(String))
            dt.Columns.Add("14", GetType(String))
            dt.Columns.Add("15", GetType(String))
            dt.Columns.Add("16", GetType(String))
            dt.Columns.Add("17", GetType(String))
            dt.Columns.Add("18", GetType(String))
            dt.Columns.Add("19", GetType(String))
            dt.Columns.Add("20", GetType(String))
            dt.Columns.Add("21", GetType(String))
            dt.Columns.Add("22", GetType(String))
            dt.Columns.Add("23", GetType(String))
            dt.Columns.Add("24", GetType(String))
            dt.Columns.Add("+25", GetType(String))
            dt.Columns.Add("CSREC", GetType(Integer))
            dt.Columns.Add("Units", GetType(Integer))
            dt.Columns.Add("BoxNum", GetType(String))
            dt.Columns.Add("FBE", GetType(Decimal))
            dt.Columns.Add("Cost", GetType(String))
            For Each item In dt1.Rows
                Dim row = dt.NewRow()
                row("Cat") = item("FlowerDetails").CAT
                row("Flower") = item("FlowerDetails").Flower
                row("Name") = item("FlowerDetails").Name
                row("UOM") = item("UOM")
                row("WH") = item("WH")
                row("Cust") = item("CustNum")
                row("AWB") = item("AWB")
                row("Farm") = item("Farm")
                row("User") = item("UserFileNo").ToUpper().Replace("WINVNW", "")
                row("+3") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays >= 3, item("CSREC").ToString(), "")
                row("+2") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = 2, item("CSREC").ToString(), "")
                row("+1") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = 1, item("CSREC").ToString(), "")
                row("0") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = 0, item("CSREC").ToString(), "")
                row("1") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -1, item("CSREC").ToString(), "")
                row("2") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -2, item("CSREC").ToString(), "")
                row("3") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -3, item("CSREC").ToString(), "")
                row("4") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -4, item("CSREC").ToString(), "")
                row("5") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -5, item("CSREC").ToString(), "")
                row("6") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -6, item("CSREC").ToString(), "")
                row("7") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -7, item("CSREC").ToString(), "")
                row("8") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -8, item("CSREC").ToString(), "")
                row("9") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -9, item("CSREC").ToString(), "")
                row("10") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -10, item("CSREC").ToString(), "")
                row("11") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -11, item("CSREC").ToString(), "")
                row("12") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -12, item("CSREC").ToString(), "")
                row("13") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -13, item("CSREC").ToString(), "")
                row("14") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -14, item("CSREC").ToString(), "")
                row("15") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -15, item("CSREC").ToString(), "")
                row("16") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -16, item("CSREC").ToString(), "")
                row("17") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -17, item("CSREC").ToString(), "")
                row("18") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -18, item("CSREC").ToString(), "")
                row("19") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -19, item("CSREC").ToString(), "")
                row("20") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -20, item("CSREC").ToString(), "")
                row("21") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -21, item("CSREC").ToString(), "")
                row("22") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -22, item("CSREC").ToString(), "")
                row("23") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -23, item("CSREC").ToString(), "")
                row("24") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays = -24, item("CSREC").ToString(), "")
                row("+25") = IIf((Convert.ToDateTime(item("DateRec")) - DateTime.Now.Date).TotalDays <= -25, item("CSREC").ToString(), "")
                row("CSREC") = item("CSREC")
                row("UNITS") = item("Units")
                row("BOXNUM") = item("BoxNumber")
                row("FBE") = item("FBE")
                row("Cost") = item("Cost")
                dt.Rows.Add(row)
            Next
            Return dt
        Catch ex As Exception

            Return Nothing
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryUserConsolidateList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                           ByVal query As String, ByVal qtype As String, Filter As String, ByVal ConsolidateType As String, ByVal ExportCSV As String) As XmlDocument
        Try

            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Inventory), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim WH As String = ""
            If User.UserType = "Warehouse" Then
                For Each r In User.WarehouseList
                    WH += IIf(r.WH <> "", "'" + r.WH + "'" + ",", "'',")
                Next
                If WH <> "" Then
                    Filter += IIf(Filter <> "", "And WH in(" + WH.TrimEnd(",") + ")", "WH in(" + WH.TrimEnd(",") + ")")
                End If
            End If

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing

                data = Inventory.GetConsolidateCoolerGridlist(whereCondition.ToUpper(), sortExp, 0, 0, ConsolidateType.ToUpper())

                If data Is Nothing Then
                    Return Nothing
                End If

                If (data.count <= 0) Then
                    Return Nothing
                End If

                If Convert.ToString(data(0).ErrorMessage) = "" Then
                    Dim dt1 As New DataTable()
                    dt1 = ConvertToDataTable(data)
                    dt1 = ConvertInventoryConsolidateToDatatable(dt1)
                    If Not dt1 Is Nothing Then
                        Dim selectedColumns As String() =
                            {"Cat", "Flower", "Name", "CSREC", "UOM", "Units", "WH", "Cust", "AWB", "Farm", "BoxNum", "FBE", "Comments", "User", "+3", "+2", "+1", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10",
                             "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "+25"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)

                        dt.Columns("Name").ColumnName = "Description"
                        dt.Columns("Cust").ColumnName = "Cust#"
                        dt.Columns("AWB").ColumnName = "AWB#"
                        dt.Columns("CSREC").ColumnName = "Boxes"

                        'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        For Each row As DataRow In dt.Rows
                            row("AWB#") = FormatInventoryAWBnumber(row("AWB#"))
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Consolidate")
                        Return BuildXmlDoc(filepath)
                    End If
                Else
                    'Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            Else
                Dim data = Nothing
                data = Inventory.GetConsolidateCoolerGridlist(whereCondition.ToUpper(), sortExp, start, rp, ConsolidateType.ToUpper())
                Dim dt As DataTable


                Dim TotalRowCount As Integer = 0

                If Not data Is Nothing Then
                    dt = ConvertToDataTable(data)
                    If dt.Rows.Count <= 0 Then
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml("<rows><total>0</total></rows>")
                        Return newDoc
                    End If
                Else
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc
                End If

                If Convert.ToString(dt(0)("ErrorMessage")) = "" Then
                    Dim FlowerColorVisibility As Boolean = False
                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    For Each i In UserFeatures
                        If i.Name.ToLower = "show flower color" Then
                            FlowerColorVisibility = i.Value
                        End If
                    Next
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                New XElement("rows", New XElement("page", page.ToString()),
                                                New XElement("total", dt(0)("TotalRows").ToString()),
                                                From row In dt
                                                Select
                                                New XElement("row", New XAttribute("id", row("RowNo").ToString()),
                                                New XElement("cell", row.Item("FlowerDetails").CAT),
                                                New XElement("cell", "<span title='" + row.Item("Cost").ToString() + "'>" & row.Item("FlowerDetails").FLOWER & "</span>"),
                                                New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Item("FlowerDetails").BGColor.ToString() +
                                                                                   ";cursorPointer;color:" + row.Item("FlowerDetails").FontColor.ToString() +
                                                                                   "' class='flowerDescription' title='" + row.Item("FlowerDetails").Name.Replace("'", "") + "'>" &
                    row.Item("FlowerDetails").Name & "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' " +
                                                                                   "class='flowerDescription' title='" + row.Item("FlowerDetails").Name.Replace("'", "") + "'>" &
                                                                                   row.Item("FlowerDetails").Name & "</div>"))),
                                                New XElement("cell", "<span title='" + Convert.ToDecimal(row.Item("Price")).ToString("#,##0.000") + "'>" + row.Item("UOM") + " x " + row.Item("Units").ToString() + " x " + Convert.ToDecimal(row.Item("Cost")).ToString("#,##0.000") + "</span>"),
                                                New XElement("cell", row.Item("InvenType")),
                                                New XElement("cell", row.Item("WH")),
                                                New XElement("cell", IIf(Convert.ToString(row.Item("CustNum")) = "0", "", row.Item("CustNum"))),
                                                New XElement("cell", FormatInventoryAWBnumber(row.Item("AWB"))),
                                                New XElement("cell", row.Item("Farm")),
                                                New XElement("cell", row.Item("Comments")),
                                                New XElement("cell", row.Item("USERFileNo")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays >= 3, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = 2, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = 1, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = 0, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -1, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -2, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -3, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -4, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -5, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -6, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -7, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -8, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -9, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -10, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -11, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -12, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -13, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -14, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -15, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -16, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -17, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -18, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -19, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -20, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -21, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -22, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -23, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays = -24, row.Item("CSREC").ToString(), "")),
                                                New XElement("cell", IIf((Convert.ToDateTime(row.Item("DateRec")) - DateTime.Now.Date).TotalDays <= -25, row.Item("CSREC").ToString(), "")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc
                Else
                    ' Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, Convert.ToString(dt(0)("ErrorMessage")), "", "Error Notification", "Error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If

            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetInventoryUserConsolidateList()::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
        Return Nothing
    End Function
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetConsolidatePurchaseGridlist(ByVal FromDate As String) As XmlDocument
        Try
            Dim dt = New DataTable
            dt = Inventory.GetConsolidatePurchaseGridlist(FromDate)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
            New XElement("rows", New XElement("page", ""),
            New XElement("total", dt.Rows.Count),
            From row In dt
            Select
            New XElement("row", New XAttribute("id", 0),
            New XElement("cell", row.Item("CAT")),
            New XElement("cell", row.Item("PRODCODQ")),
            New XElement("cell", row.Item("PRODNAMQ")),
            New XElement("cell", row.Item("UOM")),
            New XElement("cell", row.Item("MARKET")),
            New XElement("cell", row.Item("WH")),
            New XElement("cell", row.Item("CUSTOMER")),
            New XElement("cell", row.Item("AWB")),
            New XElement("cell", row.Item("FARM")),
            New XElement("cell", row.Item("COMMENTS")),
            New XElement("cell", row.Item("0")),
            New XElement("cell", row.Item("1")),
            New XElement("cell", row.Item("2")),
            New XElement("cell", row.Item("3")),
            New XElement("cell", row.Item("4")),
            New XElement("cell", row.Item("5")),
            New XElement("cell", row.Item("6")),
            New XElement("cell", row.Item("7")),
            New XElement("cell", row.Item("8")),
            New XElement("cell", row.Item("9")),
            New XElement("cell", row.Item("10")),
            New XElement("cell", row.Item("11")),
            New XElement("cell", row.Item("12")),
            New XElement("cell", row.Item("13")),
            New XElement("cell", row.Item("14")))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(Convert.ToString(xmlDoc))
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetInventoryUserConsolidateList()::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryUserDetailForEdit(ByVal Lot As String, ByVal Farm As String, ByVal Flower As String,
                                             ByVal BoxNumber As Integer, ByVal tableName As String) As Object
        Try
            Dim data = Nothing
            data = Inventory.GetUserDetailsForEdit(Lot, Farm, Flower, BoxNumber, tableName)

            If data.ErrorMessage = "" Then
                Return data
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, data.ErrorMessage, "", "Error Notification", "error")
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryUserDetailForEdit::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateInventoryUserDetails(ByVal AWB As String, ByVal TableName As String, ByVal Flower As String, ByVal FlowerName As String, ByVal FlowerCategory As String, ByVal QtyRec As Integer, ByVal QtySold As Integer, ByVal UOM As String,
                                                      ByVal UnitsPerBunch As Integer, ByVal Units As Integer, ByVal Cost As Decimal, ByVal InvenType As String, ByVal BoxNum As Integer,
                                                      ByVal OrderNum As Integer, ByVal PO As String, ByVal Invoice As Integer, ByVal Cust As Integer, ByVal Comments As String,
                                                      ByVal Farm As String, ByVal ColorCode As String, ByVal Type As String) As String
        Try
            Dim result As String
            result = Inventory.UpdateInventoryUserDetails(AWB, TableName, Flower, FlowerName, FlowerCategory, QtyRec, QtySold, UOM, UnitsPerBunch, Units, Cost, InvenType.ToUpper(), BoxNum, OrderNum, PO, Invoice, Cust, Comments, Farm, ColorCode)

            If result = "success" Then
                Dim LoginUserDetails As New User
                If (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                    LoginUserDetails = HttpContext.Current.Session("LoginUserDetails")
                    Logs.Savelog(LoginUserDetails.ID, "Inventory", "UpdateInventoryUserDetails", "Updated from " + TableName + ", AWB is: <b>" + AWB.ToString() + "</b>", "Tablename: " + TableName + ",AWB,Farm & BoxNumber is : <b>" + AWB.ToString() + "-" + Farm + "-" + BoxNum.ToString() + "</b>")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                    Logs.Savelog(LoginUserDetails.ID, "Inventory", "UpdateInventoryUserDetails", "Updated from " + TableName + ", AWB is: <b>" + AWB.ToString() + "</b>", "Tablename: " + TableName + ",AWB,Farm & BoxNumber is : <b>" + AWB.ToString() + "-" + Farm + "-" + BoxNum.ToString() + "</b>")
                End If
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return Nothing
            End If
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateInventoryUserDetails::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteInventoryUserDetails(ByVal TableName As String, ByVal Farm As String, ByVal BoxNumber As String, ByVal AWB As String) As String
        Try

            Dim result As String
            result = Inventory.DeleteInventoryUserDetails(TableName, Farm, Convert.ToInt32(BoxNumber), AWB)


            If result = "success" Then
                Dim LoginUserDetails As New User
                If (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                    LoginUserDetails = HttpContext.Current.Session("LoginUserDetails")
                    Logs.Savelog(LoginUserDetails.ID, "Inventory", "DeleteInventoryUserDetails", "Deleted inventory User from " + TableName + ",AWB,Farm & BoxNumber is : <b>" + AWB.ToString() + "-" + Farm + "-" + BoxNumber.ToString() + "</b>", "Tablename: " + TableName + ",AWB,Farm & BoxNumber is : <b>" + AWB.ToString() + "-" + Farm + "-" + BoxNumber.ToString() + "</b>")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                    Logs.Savelog(LoginUserDetails.ID, "Inventory", "DeleteInventoryUserDetails", "Deleted inventory User from " + TableName + ",AWB,Farm & BoxNumber is : <b>" + AWB.ToString() + "-" + Farm + "-" + BoxNumber.ToString() + "</b>", "Tablename: " + TableName + ",AWB,Farm & BoxNumber is : <b>" + AWB.ToString() + "-" + Farm + "-" + BoxNumber.ToString() + "</b>")
                End If
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return "error"
            End If
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteInventoryUserDetails::PageInventory")
            Return "error"
        End Try
    End Function

    'Added by Anubhuti On 04/02/2023
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateReleaseStatusInventoryAWB(ByVal AWB As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Return Inventory.UpdateReleaseStatusInventoryAWB(AWB, User.ID, User.UserName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateReleaseStatusInventoryAWB::PageInventory")
            Return Nothing
        End Try
    End Function
#End Region

#Region "InventoryUsersSQL"

    <System.Web.Services.WebMethod(True)>
    Public Function SaveInventoryUsersHeader(ByVal UserNo As String, ByVal AWB As String, ByVal DateRec As String,
        ByVal Handling As String, ByVal FBE As String, ByVal FreightAmount As String, ByVal HeaderID As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAO.InventoryUsersSQL.SaveInventoryUsersHeader(UserNo, AWB, DateRec, Handling, FBE, FreightAmount, User.ID, HeaderID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveInventoryUsersHeader::PageInventoryUserSQL")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' Muthu Nivetha M :: 20Mar2020 :: Modified :: To save values of othercost,handling,duties/andean and landedcost while saving user inventory details
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveInventoryUsersDetail(ByVal HeaderID As String, ByVal Farm As String, ByVal Flower As String, ByVal UOM As String, ByVal ReceivedBoxes As String, ByVal SoldBoxes As String, ByVal UnitsPerBunch As String, ByVal UnitsPerBox As String, ByVal Cost As String, ByVal InvenType As String, ByVal Order As String, ByVal PO As String, ByVal CustNumber As String, ByVal Comments As String, ByVal BoxNumber As String, ByVal DetailID As String, ByVal Type As String, ByVal Warehouse As String, ByVal BreakDown As String, ByVal OtherCost As Decimal, ByVal Handling As Decimal, ByVal Duties As Decimal, ByVal LandedCost As Decimal, ByVal Invoice As Integer, ByVal SellingPrice As Decimal, ByVal BRAND As String, ByVal PriceB As String, ByVal PriceC As String) As String 'Modified by Anubhuti 03/03/2023
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If User Is Nothing Then
                Return "LogOut"
            End If
            'If DetailID = "0" Or DetailID = 0 Then
            '    'Dim BoxnumberResult As String = obj.GetBoxNumberFromConstant(User.Name)
            '    Dim BoxnumberResult As String = "0"
            '    Try
            '        If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
            '            Return BoxnumberResult
            '        Else
            '            BoxNumber = BoxnumberResult
            '        End If
            '    Catch ex As Exception
            '        ErrorLogs.LogException(ex, "Error in::SaveManualPODetails::PageManualPO::While Getting Box Number")
            '        Return "error"
            '    End Try
            'End If
            Return DAO.InventoryUsersSQL.SaveInventoryUsersDetail(HeaderID, DetailID, Flower, Farm, UOM, ReceivedBoxes, SoldBoxes, UnitsPerBunch, UnitsPerBox, Cost, InvenType, Order, PO, CustNumber, Comments, BoxNumber, User.ID, Type, Warehouse, BreakDown, OtherCost, Handling, Duties, LandedCost, Invoice, SellingPrice, BRAND, PriceB, PriceC)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveInventoryUsersDetail::PageInventoryUserSQL")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryUsersHeaderFromSQLForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                             ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""


            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.InventoryUsersSQL), qtype, query)
            End If


            Dim LoginUserDetails As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ManualPOHeaders.GetPOHeader()

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of BO.InventoryUsersSQL) = DAO.InventoryUsersSQL.GetInventoryUsersHeaderFromSQLForFgrd(whereCondition, sortExp, start, rp)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)

                Dim selectedColumns As String() = {"AWB", "DateRec", "Boxes", "FBE", "UserFileNo"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("DateRec").ColumnName = "RecevingDate"
                dt.Columns("Boxes").ColumnName = "Pieces"
                Dim filepath = ExporttoExcel(dt, splitExportcsv(1))
                Return BuildXmlDoc(filepath)

            Else

                Dim data As List(Of BO.InventoryUsersSQL) = DAO.InventoryUsersSQL.GetInventoryUsersHeaderFromSQLForFgrd(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", data.Count),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.HeaderID),
                                            New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteInventoryUsersHeader_" & row.HeaderID & "'/>"),
                                            New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='editInventoryUsersHeader_" & row.HeaderID & "'/>"),
                                            New XElement("cell", row.AWB),
                                            New XElement("cell", row.DATEREC),
                                            New XElement("cell", row.Boxes),
                                            New XElement("cell", row.FBE),
                                            New XElement("cell", "<span id='lblUserFileNo_" + Convert.ToString(row.HeaderID) + "'>" + row.UserFileNo + "</span>"),
                                            New XElement("cell", String.Format("<a onclick='PrintInventoryUsersLabel(""" + row.HeaderID.ToString() + """,0)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>"))))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetManualPOHeaderForFgrd::PageInventoryUserSQL")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryUsersDetailsFromSQLForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                           ByVal query As String, ByVal qtype As String, ByVal HeaderID As String, ExportCSV As String) As XmlDocument
        Try

            Dim whereCondition As String = " where HeaderID=" + HeaderID + ""




            Dim LoginUserDetails As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")


                Dim Data = DAO.InventoryUsersSQL.GetInventoryUsersDetailsFromSQLForFgrd(whereCondition, sortExp, start, rp)


                If Data Is Nothing Then
                    Return Nothing
                End If

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(Data)

                Dim selectedColumns As String() = {"WH", "Farm", "Flower", "FlowerName", "CSREC", "UOM", "FBE", "UnitsBunch", "Units", "TotalUnits", "Cost", "TotalCost", "InvenType", "CustNum",
                                                       "Comments", "BoxNumber", "PO", "Invoice", "AWB", "DateRec", "LANDEDCOST", "TotalLandedCost"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("CSREC").ColumnName = "Boxes"
                dt.Columns("UnitsBunch").ColumnName = "Units/Bunch"
                dt.Columns("TotalCost").ColumnName = "$Total"
                dt.Columns("InvenType").ColumnName = "Type"
                dt.Columns("CustNum").ColumnName = "Cust#"
                dt.Columns("PO").ColumnName = "PO#"
                dt.Columns("DateRec").ColumnName = "Date"
                dt.Columns("FlowerName").ColumnName = "Description"
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Date").DataType = GetType(String)
                dtCloned.Columns("AWB").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "InventoryUsersDetails")
                Return BuildXmlDoc(filepath)

            Else
                Dim Data = DAO.InventoryUsersSQL.GetInventoryUsersDetailsFromSQLForFgrd(whereCondition, sortExp, start, rp)

                If Data Is Nothing Then
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If

                Dim FlowerColorVisibility As Boolean = False
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", Data.Count),
                                                    Data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID),
                                                    New XElement("cell", "<b><a href='#' id='deleteInventoryUsersDetail_" & row.DetailID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                                    New XElement("cell", "<b><a href='#' id='editInventoryUsersDetail_" & row.DetailID & "'><img src='images/Edit.png'/></a></b>"),
                                                    New XElement("cell", row.WH),
                                                    New XElement("cell", row.Farm),
                                                    New XElement("cell", row.Flower),
                                                    New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGCOLOR.ToString() +
                                                                                       ";cursorPointer;color:" + row.FONTCOLOR.ToString() +
                                                                                       "' class='flowerDescription' title='" + row.FlowerName.Replace("'", "") +
                                                                                       "'>" & row.FlowerName & "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                        Convert.ToString(row.FlowerName).Replace("'", "") + "'>" & Convert.ToString(row.FlowerName)) & "</div>")),
                                                    New XElement("cell", row.CSREC.ToString()),
                                                    New XElement("cell", row.UOM),
                                                    New XElement("cell", Convert.ToDecimal(row.FBE).ToString("#,##0.000")),
                                                    New XElement("cell", row.UnitsBunch),
                                                    New XElement("cell", row.Units.ToString()),
                                                    New XElement("cell", row.TotalUnits.ToString()),
                                                    New XElement("cell", row.Cost.ToString()),
                                                    New XElement("cell", "$" + Convert.ToDecimal(row.TotalCost).ToString("#,##0.00")),
                                                    New XElement("cell", "$" + Convert.ToDecimal(row.LandedCost).ToString("#,##0.0000")),
                                                    New XElement("cell", "$" + Convert.ToDecimal(row.TotalLandedCost).ToString("#,##0.00")),
                                                    New XElement("cell", row.InvenType),
                                                    New XElement("cell", IIf(Convert.ToString(row.CustNum) = "0", "", row.CustNum)),
                                                    New XElement("cell", row.Comments),
                                                    New XElement("cell", row.BoxNumber),
                                                    New XElement("cell", row.PO),
                                                    New XElement("cell", row.Invoice),
                                                    New XElement("cell", String.Format("<a onclick='PrintInventoryUsersLabel(""" + row.HeaderID.ToString() + """,""" + row.DetailID.ToString() + """)'><img style='Cursor:pointer;margin-top:-3px' src='images/Print.png' /></a>"))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Dim idx As Integer = Data.Count - 1
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = "Total"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""

                Return newDoc


            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryUsersDetailsFromSQLForFgrd::PageInventory")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryUserDetailByID(ByVal ID As String) As BO.InventoryUsersSQL
        Try

            Return DAO.InventoryUsersSQL.GetInventoryUserDetailByID(ID)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryUserDetailByID::PageInventoryUserSQL")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetLastInsertedInvoiceByHeaderID(ByVal HeaderID As String) As String
        Try
            Return DAO.InventoryUsersSQL.GetLastInsertedInvoiceByHeaderID(HeaderID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetLastInsertedInvoiceByHeaderID::PageInventoryUserSQL")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryUsersHeaderByID(ByVal ID As String) As BO.InventoryUsersSQL
        Try
            Return DAO.InventoryUsersSQL.GetInventoryUsersHeaderByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryUsersHeaderByID::PageInventoryUserSQL")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteInventoryUserHeader(ByVal ID As String) As String
        Try
            Return DAO.InventoryUsersSQL.DeleteInventoryUserHeader(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteInventoryUserHeader::PageInventoryUserSQL")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function DeleteInventoryUserDetail(ByVal ID As String) As String
        Try
            Return DAO.InventoryUsersSQL.DeleteInventoryUserDetail(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteInventoryUserDetail::PageInventoryUserSQL")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function TransferInventoryUserDetails(ByVal HeaderId As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim dt As New DataTable()
            dt = DAO.InventoryUsersSQL.TransferInventoryUserDetails(HeaderId, User)

            Dim result As String = ""
            Dim subject As String = ""
            Dim ToEmails As String = ""
            Dim AttachmentPath As String = ""
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
            If dt.Rows.Count > 0 Then
                For Each row In dt.Rows
                    If row("FARM").ToString() = "" And row("BOXNUM").ToString() = "" Or row("BOXNUM").ToString() = "0" And row("UOM").ToString() = "" Then
                        result = row("LOT").ToString()
                        subject = ConfigurationManager.AppSettings("CompanyName").ToString() + "- Transfer to COOLER - Awb " + row("LOT").ToString() + " PO#" + row("PO").ToString()
                        If row("Emails").ToString() = "" Then
                            'Return "noemailid"
                            ToEmails = User.Email
                        Else
                            ToEmails = row("Emails").ToString() + "," + User.Email
                        End If
                        AttachmentPath = PrintInvenTransferReport(row("LOT").ToString(), "")
                    ElseIf row("UOM").ToString() <> "BU" Then
                        subject = ConfigurationManager.AppSettings("CompanyName").ToString() + "-Box Number " + row("FARM").ToString() + row("BOXNUM").ToString() + " already on inventory in awb number" + row("LOT").ToString()
                        ToEmails = User.Email
                        'result = IIf(result <> "", result + "||" + row("FARM").ToString() + row("BOXNUM").ToString() + "," + row("LOT").ToString(), row("FARM").ToString() + row("BOXNUM").ToString() + "," + row("LOT").ToString())
                        result = row("LOT").ToString()
                    End If
                    Dim unused = Logs.SendMail(FromEmail, ToEmails, "", AttachmentPath, subject)

                Next
                Return "success~" + result
            Else
                Return "invalid"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::TransferInventoryUserDetails::PageInventoryUserSQL")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function RecalculateInventoryCostUserDetails(ByVal HeaderId As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim MsgStr As String
            MsgStr = DAO.InventoryUsersSQL.RecalculateInventoryCostUserDetails(HeaderId, User)
            Return MsgStr

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::RecalculateInventoryCostUserDetails::PageInventoryUserSQL")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintInvenTransferReport(ByVal AWB As String, ByVal Farm As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end
            If String.IsNullOrEmpty(Farm) Then
                Farm = ""
            End If

            Dim INVHist As String = ConfigurationManager.AppSettings("lTransferToHistory").ToString()

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "AWB"
            reportParameterCollection(1).Values.Add(AWB)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "INVHist"
            reportParameterCollection(2).Values.Add(INVHist)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "Farm"
            reportParameterCollection(3).Values.Add(Farm)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = "Transfer Report for AWB " + AWB + IIf(Farm <> "", " and Farm " + Farm, "") + " dated " + Convert.ToDateTime(DateTime.Now().ToString(), New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yyyy") + ".pdf"


            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptInvenTransfer", reportParameterCollection, ExportSSRS.PdfOrientation.Landscape, ExportSSRS.FileType.PDF, "BloomsReportSource")

            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvenTransferReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintInventoryUsersLabel(ByVal HeaderID As String, ByVal DetailID As String) As String
        Try
            Dim XMLInventory As XElement
            Dim Farms As String = ""
            Dim LablesCount As Integer = 0
            Dim User As New User

            Dim HeaderDetails = DAO.InventoryUsersSQL.GetInventoryUsersHeaderByID(HeaderID)
            Dim InventoryUsersDetails As New List(Of BO.InventoryUsersSQL)

            InventoryUsersDetails = DAO.InventoryUsersSQL.GetInventoryUserDetailsEitherByHeaderIDAndDetailID(HeaderID, DetailID)

            If Not InventoryUsersDetails Is Nothing Then


                XMLInventory = New XElement("Inventory",
                        From Inv In InventoryUsersDetails
                        Select New XElement("Detail", "",
                        New XElement("Farm", Inv.Farm),
                        New XElement("CAT", Inv.CAT),
                        New XElement("Name", Inv.FlowerName.Replace("'", "''")),
                        New XElement("Code", Inv.Flower),
                        New XElement("UOM", Inv.UOM),
                        New XElement("CustNum", Inv.CustNum.ToString()),
                        New XElement("OrderNum", Inv.OrderNumber.ToString()),
                        New XElement("AWB", Inv.AWB),
                        New XElement("Units", Inv.CSREC.ToString()),
                        New XElement("PONumber", Convert.ToString(Inv.PO)),
                        New XElement("BoxNum", Inv.BoxNumber.ToString()),
                        New XElement("Comments", Convert.ToString(Inv.Comments)),
                        New XElement("ManufacId", 0),
                        New XElement("Invoice", Convert.ToString(Inv.OrderNumber)),
                        New XElement("UnitsPerBox", Convert.ToString(Inv.Units)),
                        New XElement("Length", Convert.ToString(Inv.Length)),
                        New XElement("Width", Convert.ToString(Inv.Width)),
                        New XElement("Height", Convert.ToString(Inv.Height))))

                For Each det In InventoryUsersDetails
                    If (Not Farms.Contains(det.Farm)) Then
                        Farms += det.Farm + ","
                    End If
                    LablesCount = LablesCount + det.CSREC
                Next
            Else
                Return Nothing
            End If



            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Inventory.InsertInventoryDetailsForLabel(XMLInventory.ToString(), User.ID)





            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end



            Dim CompanyNameLabel As String = ConfigurationManager.AppSettings("CompanyNameForLabel").ToString()
            Dim CompanyAddress As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyAddressForLabel"))

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "CompanyName"
            reportParameterCollection(1).Values.Add(CompanyNameLabel)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Address"
            reportParameterCollection(2).Values.Add(CompanyAddress)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "WhereCondition"
            reportParameterCollection(3).Values.Add(" ")

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ImportedFrom"
            reportParameterCollection(4).Values.Add("inventory")

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()


            'Dim filename As String = "RptInventory_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"
            Dim filename As String = "Labels for Awb_" + IIf(HeaderDetails.AWB.Length > 5, Right(HeaderDetails.AWB, 5), HeaderDetails.AWB) + "_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"



            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim ReportName As String = objPdf.ExportToPdf(filename, "PO", reportParameterCollection, ExportSSRS.PdfOrientation.Label, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Logs.VendorEmailLogs(User, "", ReportExportFolder + "/" + filename, (CompanyName + " Label Printing Notification for Awb#" + AWB.TrimEnd(",") + " " + Farms.TrimEnd(",") + " Labels Printed: " + LablesCount.ToString() + " by user:" + User.Email), "labelnotification")
            If Not ReportName.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, "", ReportExportFolder + "/" + filename, (CompanyName + " Label for Awb#" + HeaderDetails.AWB.TrimEnd(",") + " Labels Printed: " + LablesCount.ToString() + " by user:" + User.Email + " ip: " + LocalIPAddress().ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, "", ReportExportFolder + "/" + filename, (CompanyName + " Label for Awb" + HeaderDetails.AWB.TrimEnd(",") + " Labels Printed: " + LablesCount.ToString() + " by user:" + User.Email), "labelnotification")
            End If
            Return ReportName


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInventoryUsersPOLabel")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintInventoryUsersProductDetailsReport(ByVal AWB As String, ByVal DateRec As String, ByVal UserFileNo As String, ByVal CoolerFlag As String, ByVal CoolerDisplay As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
            Dim CompanyNameLabel As String = Convert.ToString(ConfigurationManager.AppSettings("CompanyNameForLabel"))

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "HeaderId"
            reportParameterCollection(1).Values.Add(Convert.ToInt64(0))

            'reportParameterCollection(2) = New ReportParameter()
            'reportParameterCollection(2).Name = "AWB"
            'reportParameterCollection(2).Values.Add(AWB)

            'reportParameterCollection(3) = New ReportParameter()
            'reportParameterCollection(3).Name = "UserNo"
            'reportParameterCollection(3).Values.Add(UserFileNo.Trim())

            'reportParameterCollection(4) = New ReportParameter()
            'reportParameterCollection(4).Name = "CoolerFlag"
            'reportParameterCollection(4).Values.Add(CoolerFlag)

            'reportParameterCollection(5) = New ReportParameter()
            'reportParameterCollection(5).Name = "CoolerDisplay"
            'reportParameterCollection(5).Values.Add(CoolerDisplay)


            Dim filename As String = "InventoryReceiptListing_" + DateTime.Now.ToString("yyyy_MM_dd hh_mm_ss_fff") + ".pdf"

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim s As String = objPdf.ExportToPdf(filename, "rptInventoryusersProductDetails", reportParameterCollection, ExportSSRS.PdfOrientation.SalesMaintenanceJournal, ExportSSRS.FileType.PDF, "BloomsReportSource")

            If Not s.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Inventory Receipt Listing by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Inventory Receipt Listing by user:" + User.Email), "labelnotification")
            End If
            Return s
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInventoryProductDetailsReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    ''' <summary>
    ''' ANITHA :: 01-NOV-2018 :: Get Sales by Boxnumber
    ''' </summary>
    ''' <param name="IDINVEN"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesbyIDINVEN(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
  ByVal query As String, ByVal qtype As String, ByVal IDINVEN As String) As XmlDocument
        ' Public Function GetSalesbyIDINVEN(ByVal IDINVEN As String) As String

        'Try
        '    Dim dt1 As DataTable
        '    dt1 = Inventory.GetSalesbyIDINVEN(IDINVEN)
        '    Dim selectedColumns As String() = {"INVOICE", "DATE", "CUSTOMERNAME", "BOXES", "PRINTED", "SCANNED"}

        '    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
        '    dt.Columns("CUSTOMERNAME").ColumnName = "CUST#"

        '    Dim dtCloned As DataTable = dt.Clone()
        '    For Each row As DataRow In dt.Rows
        '        dtCloned.ImportRow(row)
        '    Next
        '    Dim filepath = ExporttoExcel(dtCloned, "SalesList$SalesList")
        '    Return filepath

        'Catch ex As Exception
        '    ErrorLogs.LogException(ex, "Error in Service::GetSalesbyIDINVEN::LookupBox")
        '    Throw ex
        'End Try

        'Dim filepath = ExporttoExcel(dtCloned, "SalesList$SalesList")
        'Return filepath
        Try
            Dim TotalRowCount As Integer = 0
            Dim data As New DataTable


            data = Inventory.GetSalesbyIDINVEN(IDINVEN)
            TotalRowCount = data.Rows.Count






            If TotalRowCount > 0 Then


                Dim xmldoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                New XElement("rows", New XElement("page", page.ToString()),
                New XElement("total", TotalRowCount),
                             From row In data.Rows()
                             Select
                New XElement("row", New XAttribute("Invoice", row.Item("Invoice").ToString()), New XAttribute("id", row("Invoice").ToString()),
                New XElement("cell", "<a id=EditInv_" + row.item("Invoice").ToString() + " data-customer='" + row.item("Customer").ToString() + "' style='text-decoration:underline;cursor:pointer;margin-left:-4px;'>" + row.item("Invoice").ToString() + "</a>"),
                New XElement("cell", Convert.ToDateTime(row.Item("Date")).ToString("MM/dd/yyyy")),
                New XElement("cell", Convert.ToString(row.item("CustomerName")).ToString()),
                New XElement("cell", Convert.ToString(row.item("Boxes")).ToString()),
                New XElement("cell", Convert.ToString(row.item("Printed")).ToString()),
                New XElement("cell", Convert.ToString(row.item("Scanned")).ToString()))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmldoc))
                Dim idx As Integer = TotalRowCount - 1

                ' LogError("xmlDoc GetSalesbyIDINVEN:" & xmldoc.ToString())

                'New XElement("row", New XAttribute("Invoice", row.Item("Invoice") + "_" + row.Item("RowNo").ToString()),

                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = "" 
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = "Totals"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""


                Return newDoc
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", "0"),
                                        New XElement("total", "0")))
                Dim newDoc1 As New XmlDocument()
                newDoc1.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc1
            End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesbyIDINVEN::LookupBox")
            Throw ex
        End Try
    End Function

#End Region



#Region "Airport"
    <System.Web.Services.WebMethod(True)>
    Public Function GetAirportList() As List(Of Airport)
        Try
            Return Airports.GetAirportList()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAirportList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetAirportForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Airports.GetAirportDetails
            Dim data As List(Of Airport) = obj.GetAirportListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Airport", "Name", "Freight", "Fuel", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Airport").ColumnName = "Airport Code"
                dt.Columns("Name").ColumnName = "Name"
                dt.Columns("Freight").ColumnName = "Freight"
                dt.Columns("Monday").ColumnName = "Monday"
                dt.Columns("Tuesday").ColumnName = "Tuesday"
                dt.Columns("Wednesday").ColumnName = "Wednesday"
                dt.Columns("Thursday").ColumnName = "Thursday"
                dt.Columns("Friday").ColumnName = "Friday"
                dt.Columns("Saturday").ColumnName = "Saturday"
                dt.Columns("Sunday").ColumnName = "Sunday"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "AirportDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.AirportID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteAirport_" & row.AirportID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditAirport_" & row.AirportID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.Airport).ToUpper()),
                                        New XElement("cell", row.Name.ToUpper()),
                                        New XElement("cell", Convert.ToString(row.Freight)),
                                        New XElement("cell", Convert.ToString(row.Fuel)),
                                        New XElement("cell", row.Monday),
                                        New XElement("cell", row.Tuesday),
                                        New XElement("cell", row.Wednesday),
                                        New XElement("cell", row.ThursDay),
                                        New XElement("cell", row.Friday),
                                        New XElement("cell", row.Saturday),
                                        New XElement("cell", row.Sunday)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAirportForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAirportByCode(ByVal code As String) As Airport
        Try
            Return Airports.GetAirportByCode(code)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAirportByCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAirportDetailByID(ByVal ID As String) As Airport
        Try
            Return Airports.GetAirportDetailByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAirportByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteAirportByID(ByVal ID As String) As String
        Try
            Return Airports.DeleteAirportbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteAirportByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveAirport(ByVal ID As String, ByVal AIRPORT As String, ByVal NAME As String, ByVal FREIGHT As Decimal, ByVal FUEL As Decimal, ByVal MONDAY As String,
    ByVal TUESDAY As String, ByVal WEDNESDAY As String, ByVal THURSDAY As String, ByVal FRIDAY As String, ByVal SATURDAY As String, ByVal SUNDAY As String) As String
        Try
            Dim AirportID As String = ""
            If (ID = "0") Then
                AirportID = Airports.InsertAirport(AIRPORT, NAME, FREIGHT, FUEL, MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY)
            Else
                AirportID = Airports.UpdateAirport(Convert.ToInt32(ID), AIRPORT, NAME, FREIGHT, FUEL, MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY)
            End If
            If (Not AirportID.Contains("UNIQUE KEY constraint")) Then
                Return AirportID
            Else
                'User.ErrorMessage = FarmID
                Return AirportID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveAirport::PageAirport")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetAirportHistForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Airports.GetAirportDetails
            Dim data As List(Of Airport) = obj.GetAirportHistListForFgrd(whereCondition, sortExp, start, rp) 'Modified by Anubhuti 2023_09_06

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", data.Count.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.AirportID),
                                        New XElement("cell", row.Type),
                                        New XElement("cell", row.Airport),
                                        New XElement("cell", row.Freight),
                                        New XElement("cell", row.Fuel),
                                        New XElement("cell", row.ADDUSER),
                                        New XElement("cell", row.ADDDATE)))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAirportHistForFgrd")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' ABI::28-Apr-2018::To get airport code lists
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetAirportCodeList() As List(Of Airport)
        Try
            Return Airports.GetAirportCodeList()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAirportCodeList")
            Return Nothing
        End Try
    End Function

#End Region

#Region "PO"
    <System.Web.Services.WebMethod(True)>
    Public Function LoadPoDetailsByPoNumber(ByVal PO As String, ByVal EstimatedDate As String) As String
        'added by Belal 20 Aug 2020
        Try
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim obj As New PurchaseOrders.GetPurchaseOrderHeader
            Dim data As DataSet = obj.LoadPoDetailsByPoNumber(PO)
            Dim poData As DataTable = data.Tables(0)
            Dim poDetailData As DataTable = data.Tables(1)
            Dim poNumber As String = ""
            If Not String.IsNullOrEmpty(EstimatedDate) Then
                Dim dateValue As DateTime
                DateTime.TryParse(EstimatedDate, dateValue)
                EstimatedDate = dateValue.ToString("yyyy-MM-dd")
            End If




            If poData.Rows.Count > 0 Then
                If CompanyName = "Misty Flowers" Then
                    Dim MainXMLString As String = "<XMLPosAlliance><Po><Header>"
                    For Each row As DataRow In poData.Rows
                        poNumber = row("PoNumber").ToString()
                        MainXMLString += "<WarehouseCode>" + row("WarehouseCode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</WarehouseCode>" +
                        "<ConsigneeCode>" + row("ConsigneeCode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ConsigneeCode>" +
                        "<PoNumber>" + row("PoNumber").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</PoNumber>" +
                        "<OriginPortCode>" + row("OriginPortCode").ToString() + "</OriginPortCode>" +
                        "<DestinationPortCode>" + row("DestinationPortCode").ToString() + "</DestinationPortCode>" +
                         "<EstimatedDate>" + IIf(String.IsNullOrEmpty(EstimatedDate), row("EstimatedDate").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;"), EstimatedDate) + "</EstimatedDate>" +
                         "<Comments>" + row("Comments").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Comments>" +
                          "<PostType>" + row("PostType").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</PostType>"
                    Next row
                    MainXMLString += "</Header><Details>"

                    For Each row1 As DataRow In poDetailData.Rows
                        MainXMLString += "<Detail>" +
                        "<FarmMID>" + row1("MANUFACID").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</FarmMID>" +
                        "<ItemNo>" + row1("PRODNAMQ").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ItemNo>" +
                        "<ShipToCode>" + row1("ShipToCode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ShipToCode>" +
                        "<CarrierCode>" + "</CarrierCode>" +
                        "<FarmCode>" + row1("Farm").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</FarmCode>" +
                        "<DispatchDate>" + "</DispatchDate>" +
                        "<Barcode>" + row1("Barcode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Barcode>" +
                        "<BoxSize>" + row1("BoxSize").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</BoxSize>" +
                        "<ProductCode>" + row1("ProductCode").ToString() + "</ProductCode>" +
                        "<ProductDescription>" + row1("ProductDescription").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ProductDescription>" +
                        "<Packing>" + row1("Packing").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Packing>" +
                        "<UnitPrice>" + row1("UnitPrice").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</UnitPrice>" +
                        "<Length>" + row1("Length").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Length>" +
                        "<Width>" + row1("Width").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Width>" +
                        "<Hight>" + row1("Hight").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Hight>" +
                        "<GrossWeight>" + row1("GrossWeight").ToString() + "</GrossWeight>" +
                        "<UnitOfMeasurement>" + row1("UnitOfMeasurement").ToString() + "</UnitOfMeasurement>" +
                        "<Comments>" + row1("Comments").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Comments>" +
                        "</Detail>"
                    Next
                    MainXMLString += "</Details></Po></XMLPosAlliance>"
                    Logs.SendEmail("jose@dflower.com", "donotreply@dflower.net", MainXMLString, "", " XML Posting for PO# " + poNumber)
                    Return MainXMLString
                Else
                    Dim MainXMLString As String = "<XMLPosAlliance>"
                    For Each row1 As DataRow In poDetailData.Rows
                        MainXMLString += "<Po><Header>"
                        Dim Row = poData.Rows(0)
                        poNumber = Row("PoNumber").ToString()
                        MainXMLString += "<WarehouseCode>" + Row("WarehouseCode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</WarehouseCode>" +
                        "<ConsigneeCode>" + Row("ConsigneeCode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ConsigneeCode>" +
                        "<PoNumber>" + Row("PoNumber").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</PoNumber>" +
                        "<OriginPortCode>" + Row("OriginPortCode").ToString() + "</OriginPortCode>" +
                        "<DestinationPortCode>" + Row("DestinationPortCode").ToString() + "</DestinationPortCode>" +
                         "<EstimatedDate>" + IIf(String.IsNullOrEmpty(EstimatedDate), Row("EstimatedDate").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;"), EstimatedDate) + "</EstimatedDate>" +
                         "<Comments>" + Row("Comments").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Comments>" +
                          "<PostType>" + Row("PostType").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</PostType>"
                        MainXMLString += "</Header><Details>"
                        MainXMLString += "<Detail>" +
                        "<FarmMID>" + row1("MANUFACID").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</FarmMID>" +
                        "<ItemNo>" + row1("PRODNAMQ").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ItemNo>" +
                        "<ShipToCode>" + row1("ShipToCode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ShipToCode>" +
                        "<CarrierCode>" + "</CarrierCode>" +
                        "<FarmCode>" + row1("Farm").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</FarmCode>" +
                        "<DispatchDate>" + "</DispatchDate>" +
                        "<Barcode>" + row1("Barcode").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Barcode>" +
                        "<BoxSize>" + row1("BoxSize").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</BoxSize>" +
                        "<ProductCode>" + row1("ProductCode").ToString() + "</ProductCode>" +
                        "<ProductDescription>" + row1("ProductDescription").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</ProductDescription>" +
                        "<Packing>" + row1("Packing").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Packing>" +
                        "<UnitPrice>" + row1("UnitPrice").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</UnitPrice>" +
                        "<Length>" + row1("Length").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Length>" +
                        "<Width>" + row1("Width").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Width>" +
                        "<Hight>" + row1("Hight").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Hight>" +
                        "<GrossWeight>" + row1("GrossWeight").ToString() + "</GrossWeight>" +
                        "<UnitOfMeasurement>" + row1("UnitOfMeasurement").ToString() + "</UnitOfMeasurement>" +
                        "<Comments>" + row1("Comments").ToString().Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;").Replace("&#34;", "&quot;").Replace("'", "&apos;") + "</Comments>" +
                        "</Detail>"
                        MainXMLString += "</Details></Po>"
                    Next
                    MainXMLString += "</XMLPosAlliance>"
                    Logs.SendEmail("jose@dflower.com", "donotreply@dflower.net", MainXMLString, "", " XML Posting for PO# " + poNumber)
                    Return MainXMLString
                End If
            Else
                Return ""
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadPoDetailsByPoNumber::PagePO")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function Updatepoheaderstatus(ByVal PONumber As String, ByVal NewStatus As String) As String
        Try
            Dim obj As New PurchaseOrders.GetPurchaseOrderHeader
            Dim data As DataSet = obj.LoadPoDetailsByPoNumber(PONumber)
            Dim totalPieces As Int32 = 0
            totalPieces = data.Tables(1).Rows().Count()
            Return PurchaseOrders.Updatepoheaderstatus(PONumber, NewStatus, totalPieces)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdatePOHstatus::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckIfPOAlreadyPosted(ByVal PONumber As String) As String
        Try
            Dim obj As New PurchaseOrders.GetPurchaseOrderHeader
            Return PurchaseOrders.CheckIfPOAlreadyPosted(PONumber)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOStatus::PagePO")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckIfBoxnumberDuplicated(ByVal PONumber As String, ByVal POQIdList As String) As List(Of String)
        Try
            Return DAOPO.GetBoxnumberDuplicated(PONumber, POQIdList)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOStatus::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckPOStatus(ByVal PONumber As String) As String
        Try
            Return PurchaseOrders.CheckPOStatus(PONumber)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckPOStatus::PagePO")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function InsertPOHistoryLog(ByVal PONUM As String, ByVal LOGTEXT As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Return DAOPO.InsertPOHistoryLog(PONUM, LOGTEXT, User.Name, "PagePO")
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdatePOHstatus::PagePO")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Async Function SendMail(XMLString As String, ByVal PONUM As String, ByVal Subject As String) As Task(Of String)
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
            Return Await Logs.SendMail(FromEmail, "ateran@mistyflowers.com,jose@dflower.com", XMLString, "", Subject, "", "", "")
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SendMail::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPOHeaderForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                             ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            'If qtype = "AWB" Then
            '    query = Regex.Replace(query, "[-]", "")
            'End If

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(PurchaseOrder), qtype, query)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New PurchaseOrders.GetPurchaseOrderHeader
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of PurchaseOrder) = obj.GetPurchaseOrderHeader(whereCondition, sortExp, start, rp)

                Dim dt1 As DataTable
                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"PONumber", "FarmCode", "FarmName", "PODate", "POStatus", "ShipDate", "FarmCity", "WH", "BoxesFBE", "Boxes", "TotalUnits", "POType"}
                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("PONumber").ColumnName = "PO#"
                dt.Columns("FarmCode").ColumnName = "Farm"
                dt.Columns("FarmName").ColumnName = "Vendor Name"
                dt.Columns("ShipDate").ColumnName = "Cargo Date"
                dt.Columns("FarmCity").ColumnName = "From"
                dt.Columns("BoxesFBE").ColumnName = "F.B.E"
                dt.Columns("Boxes").ColumnName = "Pieces"
                dt.Columns("TotalUnits").ColumnName = "Units"
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Cargo Date").DataType = GetType(String)
                dtCloned.Columns("PODate").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of PurchaseOrder) = obj.GetPurchaseOrderHeader(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                    New XElement("rows", New XElement("page", page.ToString()),
                    New XElement("total", If(obj.TotalRows.ToString() = "0", "1", obj.TotalRows.ToString())),
                    data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                    New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeletePOHeader_" & row.ID & "'/>"),
                    New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='editPOHeader_" & row.ID & "'/>"),
                    New XElement("cell", row.PONumber),
                    New XElement("cell", row.FarmCode),
                    New XElement("cell", row.FarmName),
                    New XElement("cell", row.PODate.ToString("MM/dd/yyyy")),
                    New XElement("cell", row.POStatus),
                    New XElement("cell", row.ShipDate.ToString("MM/dd/yyyy")),
                    New XElement("cell", row.FarmCity),
                    New XElement("cell", row.WH),
                    New XElement("cell", row.BoxesFBE.ToString("#,##0.000")),
                    New XElement("cell", row.Boxes),
                    New XElement("cell", row.TotalUnits),
                    New XElement("cell", row.POType)))))
                Dim newDoc As New XmlDocument()
                Dim idx As Integer = data.Count - 1
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = "Total"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOHeaderForFgrd::PagePO")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    '<ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    'Public Function GetPOProductDetailsGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
    '                                         ByVal qtype As String, ByVal Farm As String) As XmlDocument
    '    Try
    '        Dim whereCondition As String = ""

    '        If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
    '            whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
    '        End If

    '        Dim sortExp As String = sortname & " " & sortorder
    '        Dim start As Integer = ((page - 1) * rp) + 1
    '        rp -= 1

    '        Dim data = obj.GetPOProductDetails_FG(page, rp, sortname, sortorder, query, qtype, Farm)

    '        Dim TotalRowCount As Integer = 0

    '        If data.Length > 0 Then

    '            TotalRowCount = data(0).TotalRows.ToString()
    '        End If

    '        Dim SelectedPOs As New ArrayList

    '        If Not Context.Session("SelectedPOs") Is Nothing Then
    '            SelectedPOs = Context.Session("SelectedPOs")
    '            For Each Item In data
    '                Dim hasItem = SelectedPOs.Cast(Of String()).Where(Function(i) i(0).Equals(Item.RECNO.ToString)).FirstOrDefault()
    '                If Not hasItem Is Nothing Then
    '                    Item.Selected = True
    '                End If
    '            Next
    '        End If
    '        Dim FlowerColorVisibility As Boolean = False
    '        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
    '        For Each i In UserFeatures
    '            If i.Name.ToLower = "show flower color" Then
    '                FlowerColorVisibility = i.Value
    '            End If
    '        Next


    '        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
    '                                    New XElement("rows", New XElement("page", page.ToString()),
    '                                    New XElement("total", If(TotalRowCount = "0", "1", TotalRowCount.ToString())),
    '                                    data.Select(Function(row) New XElement("row", New XAttribute("id", row.RECNO),
    '                                    New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='teselectPOProduct_" & row.RECNO.ToString() & "'  src='" & IIf(row.Selected, "images/check-on.png", "images/check-off.png") & "' />")),
    '                                    New XElement("cell", row.Farm),
    '                                    New XElement("cell", row.FlowerDetails.Flower),
    '                                    New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.FlowerDetails.BGColor.ToString() + "' title='" + row.FlowerDetails.Name + "' class='flowerDescription'><a style='color:" + row.FlowerDetails.FontColor.ToString() + ";'>" + row.FlowerDetails.Name + "</a></div>", row.FlowerDetails.Name)),
    '                                    New XElement("cell", row.FlowerDetails.CAT),
    '                                    New XElement("cell", row.FlowerDetails.ColorCode),
    '                                    New XElement("cell", "<a id='btnpoproductqty_" + row.RECNO.ToString() + "'>0</a><input type='text' style='display:none;width:50px;padding: 1px;' class='NumbersOnly' id='editPOProductQty_" &
    '                                                           row.RECNO.ToString() & "'></input>"),
    '                                    New XElement("cell", row.UOM),
    '                                    New XElement("cell", "<a id='btnpoproductunits_" + row.RECNO.ToString() + "'>" + row.Units.ToString() + "</a>"),
    '                                    New XElement("cell", "0"),
    '                                    New XElement("cell", "<input type='text' style='display:none;width:50px;padding: 1px;' class='NumbersOnly' id='editPOProductBunches_" &
    '                                                           row.RECNO.ToString() & "'></input>"),
    '                                    New XElement("cell", "<a id='btnpoproductcost_" + row.RECNO.ToString() + "'></a><input type='text' style='display:none;width:50px;padding: 1px;' class='DecimalsOnly' id='editPOProductcost_" &
    '                                                           row.RECNO.ToString() & "'></input>"),
    '                                    New XElement("cell", "<a id='btntotalpoproductcost_" + row.RECNO.ToString() + "'>0</a>"),
    '                                    New XElement("cell", "<input type='text' style='display:none;width:50px;padding: 1px;' maxlength='1' class='AllUpperCaseTextBox' id='editPOProducttype_" &
    '                                                           row.RECNO.ToString() & "'></input>"),
    '                                    New XElement("cell", "<input type='text' style='display:none;width:50px;padding: 1px;' class='NumbersOnly' id='editPOProductcust_" &
    '                                                           row.RECNO.ToString() & "'></input>"),
    '                                    New XElement("cell", "<input type='text' style='display:none;width:150px;padding: 1px;' maxlength='126' class='AllUpperCaseTextBox' id='editPOProductcomments_" &
    '                                                           row.RECNO.ToString() & "'></input>"),
    '                                    New XElement("cell", "<input type='text' style='display:none;width:150px;padding: 1px;' maxlength='8' class='AllUpperCaseTextBox' id='editPOProductOrder_" &
    '                                                           row.RECNO.ToString() & "'></input>"),
    '                                    New XElement("cell", "<input type='text' style='display:none;width:150px;padding: 1px;' maxlength='8' class='NumbersOnly' id='editPOProductinvoice_" &
    '                                                           row.RECNO.ToString() & "'></input>")))))
    '        Dim newDoc As New XmlDocument()
    '        newDoc.LoadXml(Convert.ToString(xmlDoc))
    '        Return newDoc
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetPOProductDetailsGrid::PagePO")
    '        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPOProductDetailsGridEditMode(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                             ByVal qtype As String, ByVal HeaderId As String) As XmlDocument
        Try
            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(PurchaseOrderDetail), qtype, query)
            End If

            If whereCondition <> "" Then
                whereCondition = whereCondition + "and HeaderId=" + HeaderId
            ElseIf whereCondition = "" Then
                whereCondition = "HeaderId=" + HeaderId
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New PurchaseOrderDetails.GetPODetails
            Dim data = obj.GetPODetails(whereCondition, sortExp, start, rp)

            Dim SelectedPODetails As New ArrayList()
            If Not Context.Session("SelectedPODetailsId") Is Nothing Then
                SelectedPODetails = Context.Session("SelectedPODetailsId")
                For Each Item In data
                    Dim hasItem = SelectedPODetails.Cast(Of String).Where(Function(i) i.Equals(Item.RECID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        Item.Selected = True
                    End If
                Next
            End If

            Dim FlowerColorVisibility As Boolean = False
            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
            For Each i In UserFeatures
                If i.Name.ToLower = "show flower color" Then
                    FlowerColorVisibility = i.Value
                End If
            Next


            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", If(obj.TotalRows.ToString() = "0", "1", obj.TotalRows.ToString())),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.RECID.ToString()),
                                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='EMselectPOProduct_" & row.RECID.ToString() & "'  src='" & IIf(row.Selected, "images/check-on.png", "images/check-off.png") & "' />")),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='EMDeletePOItems_" & row.RECID.ToString() & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EMeditPOItems_" & row.RECID.ToString() & "'/>"),
                                        New XElement("cell", row.Farm),
                                        New XElement("cell", row.Flower.Flower),
                                        New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Flower.BGColor.ToString() + "' title='" + row.Flower.Name + "' class='flowerDescription'><a style='color:" + row.Flower.ForeColor.ToString() + ";'>" + row.Flower.Name + "</a></div>", row.Flower.Name)),
                                        New XElement("cell", row.Flower.CAT),
                                        New XElement("cell", row.Flower.ColorCode),
                                        New XElement("cell", "<a id='EMbtnpoproductqty_" + row.RECID.ToString() + "'>" + row.Quantity.ToString() + "</a><input type='text' style='display:none;width:50px;padding: 1px;' class='NumbersOnly' placeholder='" + row.Quantity.ToString() + "' id='EMeditPOProductQty_" &
                                                               row.RECID.ToString() & "'></input>"),
                                        New XElement("cell", row.UOM),
                                        New XElement("cell", "<a id='EMbtnpoproductunits_" + row.RECID.ToString() + "'>" + row.Units.ToString() + "</a>"),
                                        New XElement("cell", "0"),
                                        New XElement("cell", "<a id='EMbtnpoproductbunches_" + row.RECID.ToString() + "'>" + row.Bunches.ToString() + "</a><input type='text' style='display:none;width:50px;padding: 1px;' class='NumbersOnly' placeholder='" + row.Bunches.ToString() + "' id='EMeditPOProductBunches_" &
                                                               row.RECID.ToString() & "'></input>"),
                                        New XElement("cell", "<a id='EMbtnpoproductcost_" + row.RECID.ToString() + "'>" + row.Cost.ToString() + "</a><input type='text' style='display:none;width:50px;padding: 1px;' class='DecimalsOnly' placeholder='" + row.Cost.ToString() + "' id='EMeditPOProductcost_" &
                                                               row.RECID.ToString() & "'></input>"),
                                        New XElement("cell", "<a id='EMbtntotalpoproductcost_" + row.RECID.ToString() + "'>" + row.Total.ToString() + "</a>"),
                                        New XElement("cell", "0.00%"),
                                        New XElement("cell", row.BoxNumber.ToString()),
                                        New XElement("cell", "<a id='EMbtnpoproductcustomer_" + row.RECID.ToString() + "'>" + row.Customer.ToString() + "</a><input type='text' style='display:none;width:50px;padding: 1px;' class='NumbersOnly' placeholder='" + row.Customer.ToString() + "' id='EMeditPOProductcust_" &
                                                               row.RECID.ToString() & "'></input>"),
                                        New XElement("cell", "<a id='EMbtnpoproducttype_" + row.RECID.ToString() + "'>" + row.Type.ToString() + "</a><input maxlength='1' type='text' style='display:none;width:50px;padding: 1px;' placeholder='" + row.Type.ToString() + "' id='EMeditPOProductType_" &
                                                               row.RECID.ToString() & "'></input>"),
                                        New XElement("cell", "<a id='EMbtnpoproductcomments_" + row.RECID.ToString() + "'>" + row.Comments.ToString() + "</a><input maxlength='126' type='text' style='display:none;width:120px;padding: 1px;' placeholder='" + row.Comments.ToString() + "' id='EMeditPOProductComments_" &
                                                               row.RECID.ToString() & "'></input>"),
                                        New XElement("cell", "<a id='EMbtnpoproductOrder_" + row.RECID.ToString() + "'>" + row.Order.ToString() + "</a><input maxlength='126' type='text' style='display:none;width:120px;padding: 1px;' placeholder='" + row.Order.ToString() + "' id='EMeditPOProductOrder_" &
                                                               row.RECID.ToString() & "'></input>"),
                                        New XElement("cell", "<a id='EMbtnpoproductInvoice_" + row.RECID.ToString() + "'>" + row.Invoice.ToString() + "</a><input maxlength='126' type='text' style='display:none;width:120px;padding: 1px;' class='NumbersOnly' placeholder='" + row.Invoice.ToString() + "' id='EMeditPOProductInvoice_" &
                                                               row.RECID.ToString() & "'></input>")))))
            Dim newDoc As New XmlDocument()
            Dim idx As Integer = data.Count - 1
            newDoc.LoadXml(Convert.ToString(xmlDoc))
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = "Total"
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOProductDetailsGridEditMode::PagePO")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function SavePurchaseOrderDetails(ByVal OrderDetails As String, ByVal PONumber As String,
    '                                         ByVal PODate As String, ByVal Farm As String,
    '                                         ByVal ShipDate As String, ByVal RecDate As String, ByVal POType As String,
    '                                         ByVal Carrier As String, ByVal POStatus As String, ByVal ConfDate As String,
    '                                         ByVal Fob As String, ByVal AirPort As String,
    '                                         ByVal WH As String, ByVal ItemsCount As String, ByVal Comments As String) As String

    '    Try
    '        Dim User As New User
    '        If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
    '            User = System.Web.HttpContext.Current.Session("LoginUserDetails")
    '        ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
    '            User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
    '        End If

    '        Dim FinalBoxNo As String = obj.GetMultipleBoxNumberFromConstant(Convert.ToInt32(ItemsCount), User.Name)
    '        Dim startboxno As Integer = (Convert.ToUInt32(FinalBoxNo) - Convert.ToInt32(ItemsCount)) + 1

    '        Return PurchaseOrderDetails.SavePODetails(OrderDetails, PONumber, PODate, Farm, ShipDate, RecDate, POType, Carrier, POStatus, ConfDate, Fob,
    '                                                  AirPort, WH, User.ID, startboxno, Comments)
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::SavePurchaseOrderDetails::PagePO")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdatePurchaseOrderDetails(ByVal OrderDetails As String, ByVal POHeaderId As String, ByVal PONumber As String,
                                             ByVal PODate As String, ByVal Farm As String,
                                             ByVal ShipDate As String, ByVal RecDate As String, ByVal POType As String,
                                             ByVal Carrier As String, ByVal POStatus As String, ByVal ConfDate As String,
                                             ByVal Fob As String, ByVal AirPort As String,
                                             ByVal WH As String, ByVal Comments As String) As String

        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Return PurchaseOrderDetails.UpdatePODetails(OrderDetails, POHeaderId, PONumber, PODate, Farm, ShipDate, RecDate, POType, Carrier, POStatus, ConfDate, Fob,
                                                      AirPort, WH, User.ID, Comments)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdatePurchaseOrderDetails::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeletePurchaseOrderDetails(ByVal HeaderId As String, ByVal PONumner As String) As String
        Try
            Return PurchaseOrders.DeletePurchaseOrder(HeaderId, PONumner)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeletePurchaseOrderDetails::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPurchaseOrderHeaderByID(ByVal HeaderId As String) As PurchaseOrder

        Try
            Return PurchaseOrders.GetPurchaseOrderHeaderByID(HeaderId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPurchaseOrderHeaderByID::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddProductForPO(ByVal HeaderId As String, ByVal Farm As String, ByVal Flower As String, ByVal FlowerName As String, ByVal FlowerCat As String,
                                    ByVal Quantity As String, ByVal UOM As String, ByVal Units As String, ByVal Bunches As String, ByVal BoxNumber As String, ByVal cost As String,
                                    ByVal Customer As String, ByVal Comments As String, ByVal Type As String, ByVal Order As String,
                                    ByVal Invoice As String, ByVal PONumber As String) As String

        Try
            'If (BoxNumber = "") Then
            '    BoxNumber = GetBoxNumberFromConstant()
            'End If

            Return PurchaseOrderDetails.AddPOProductDetails(HeaderId, Farm, Flower, FlowerName, FlowerCat, Convert.ToInt32(Quantity), UOM,
                                                           Convert.ToInt32(Units), Convert.ToInt32(Bunches), Convert.ToInt32(BoxNumber), Convert.ToDecimal(cost), Convert.ToInt32(Customer),
                                                           Comments, Type, Order, Convert.ToInt32(Invoice), PONumber)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddProductForPO::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeletePOProduct(ByVal HeaderId As String, ByVal ID As String, PONumber As String, ByVal Product As String) As String

        Try
            Return PurchaseOrderDetails.DeletePOProductDetails(Convert.ToInt32(HeaderId), Convert.ToInt32(ID), PONumber, Product)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeletePOProduct::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPOProductDetailsById(ByVal HeaderId As String, ByVal ID As String) As PurchaseOrderDetail

        Try
            Return PurchaseOrderDetails.GetPOProductDetailsById(HeaderId, ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOProductDetailsById::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateProductForPO(ByVal HeaderId As String, ByVal Flower As String, ByVal FlowerName As String, ByVal FlowerCat As String, ByVal ColorCode As String,
                                                ByVal Quantity As String, ByVal UOM As String, ByVal Units As String, ByVal Bunches As String, ByVal BoxNumber As Integer, ByVal cost As String,
                                               ByVal Customer As String, ByVal Comments As String, ByVal Type As String, ByVal Order As String,
                                               ByVal Invoice As String, ByVal PONumber As String, Recid As String) As String

        Try
            Return PurchaseOrderDetails.UpdatePOProductDetails(HeaderId, Flower, FlowerName, FlowerCat, ColorCode, Convert.ToInt32(Quantity), UOM,
                                                           Convert.ToInt32(Units), Convert.ToInt32(Bunches), Convert.ToInt32(BoxNumber), Convert.ToDecimal(cost), Convert.ToInt32(Customer),
                                                           Comments, Type, Order, Convert.ToInt32(Invoice), PONumber, Recid)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateProductForPO::PagePO")
            Return "error"
        End Try
    End Function
#End Region

#Region "All Purchase Orders"
    <System.Web.Services.WebMethod(True)>
    Public Function LoadAllFiltersDataForAllPurchase(ByVal Fromdate As String, ByVal Todate As String, ByVal isCargo As Boolean, ByVal Buyer As String, ByVal Farm As String, ByVal Origin As String, ByVal Status As String, ByVal Prod As String, ByVal Uom As String, ByVal Cust As String) As List(Of BOPO)
        Try
            Return DAOPO.LoadAllFiltersDataForAllPurchase(Fromdate, Todate, isCargo, Buyer, Farm, Origin, Status, Prod, Uom, Cust)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadAllFiltersDataForAllPurchase::PagePO")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetAllPurchasesGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal Fromdate As String, ByVal Todate As String, ByVal isCargo As Boolean, ByVal Buyer As String, ByVal Farm As String, ByVal Origin As String, ByVal Status As String, ByVal Prod As String, ByVal Uom As String, ByVal Cust As String) As XmlDocument
        Try
            Dim newDoc As New XmlDocument()
            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If
            Dim PurchaseList = Nothing
            PurchaseList = DAOPO.GetAllPurchasesGrid(Fromdate, Todate, isCargo, sortExp, start, rp, Buyer, Farm, Origin, Status, Prod, Uom, Cust)

            If PurchaseList Is Nothing Then
                Return Nothing
            End If
            Dim TotalRowCount As Integer = 0

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                If (TryCast(PurchaseList, Tuple(Of DataSet, String)).Item1.Tables(1).Rows(0)(0) <= 0) Then
                    Return Nothing
                End If

                If Convert.ToString(TryCast(PurchaseList, Tuple(Of DataSet, String)).Item2) = "success" Then
                    Dim selectedColumns As String() =
                            {"PONumber", "FARM", "FARMNAME", "ORIGEN", "TRUCKDATE", "SHIPDATE", "POSTAT", "PRODCODQ", "PRODNAMQ", "QTYBOX", "UOM", "FBE", "QTYXBOX", "QTYUNIT", "STEMXBUN", "UNITCOSQ", "CUSTOMER", "COMMENTQ", "FULLBOXES"}

                    Dim dt As DataTable = New DataView(TryCast(PurchaseList, Tuple(Of DataSet, String)).Item1.Tables(0)).ToTable(False, selectedColumns)
                    TotalRowCount = dt.Rows.Count - 1
                    Dim dr As DataRow = dt.Rows(TotalRowCount)
                    dr.Delete()
                    dt.AcceptChanges()
                    dt.Columns("TRUCKDATE").ColumnName = "TruckDate"
                    dt.Columns("SHIPDATE").ColumnName = "CargoDate"
                    dt.Columns("POSTAT").ColumnName = "Status"
                    dt.Columns("PRODCODQ").ColumnName = "Code"
                    dt.Columns("PRODNAMQ").ColumnName = "Description"
                    dt.Columns("QTYBOX").ColumnName = "Qty"
                    dt.Columns("UOM").ColumnName = "Uom"
                    dt.Columns("QTYXBOX").ColumnName = "Pack"
                    dt.Columns("QTYUNIT").ColumnName = "Units"
                    dt.Columns("STEMXBUN").ColumnName = "Units/Bunch"
                    dt.Columns("UNITCOSQ").ColumnName = "Cost"
                    dt.Columns("CUSTOMER").ColumnName = "Cust#"
                    dt.Columns("COMMENTQ").ColumnName = "Comments"
                    dt.Columns("FULLBOXES").ColumnName = "FullBoxes"
                    Dim filepath = ExporttoExcel(dt, splitExportcsv(1) + "Header")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, PurchaseList(0).ErrorMessage, "", "Error Notification", "Error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim dtPurchaseList As New DataSet
                If Not TryCast(PurchaseList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                    dtPurchaseList = TryCast(PurchaseList, Tuple(Of DataSet, String)).Item1
                Else
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If
                TotalRowCount = Convert.ToInt32(dtPurchaseList.Tables(1).Rows(0)(0))
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                New XElement("rows", New XElement("page", page.ToString()),
                                New XElement("total", dtPurchaseList.Tables(1).Rows(0)(0)),
                                             From row In dtPurchaseList.Tables(0).Rows()
                                             Select New XElement("row", New XAttribute("id", row("PONumber")), New XAttribute("style", If(row("PONumber") <> "0", ChangeBgColorBasedOnPurchaseOrderStatus(row("POSTAT"), 0), "")),
                                New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='AllPurchaseListselect_" & row("PONumber").ToString() & "' src='images/check-off.png' />"),
                                New XElement("cell", "<b><a href='#' id='editAllPO_" & row("PONumber").ToString() & "'><img src='images/Edit.png'/></a></b>"),
                                    New XElement("cell", row("PONumber")),
                                    New XElement("cell", row("FARM")),
                                    New XElement("cell", String.Format("<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                        row("FARMNAME").ToString().Replace("'", "") + "'>" & row("FARMNAME").ToString().Replace("'", "") & "</div>")),
                                    New XElement("cell", row("ORIGEN")),
                                    New XElement("cell", row("AIRPORT")),
                                    New XElement("cell", row("TRUCKDATE")),
                                    New XElement("cell", row("SHIPDATE")),
                                    New XElement("cell", row("POSTAT")),
                                    New XElement("cell", row("PRODCODQ")),
                                    New XElement("cell", String.Format("<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                        row("PRODNAMQ").ToString().Replace("'", "") + "'>" & row("PRODNAMQ").ToString().Replace("'", "") & "</div>")),
                                    New XElement("cell", "<a id='aAllPurchaseQty_" + row("PONumber").ToString() + "' style='font-weight: bold;'>" + (Convert.ToDecimal(row("QTYBOX"))).ToString() + "</a>"),
                                    New XElement("cell", row("UOM")),
                                    New XElement("cell", "<a id='aAllPurchaseFBE_" + row("PONumber").ToString() + "' style='font-weight: bold;'>" + (Convert.ToDecimal(row("FBE"))).ToString("#,##0.00") + "</a>"),
                                    New XElement("cell", row("QTYXBOX")),
                                    New XElement("cell", row("QTYUNIT")),
                                    New XElement("cell", row("STEMXBUN")),
                                    New XElement("cell", row("UNITCOSQ")),
                                    New XElement("cell", row("CUSTOMER")),
                                    New XElement("cell", row("MARKET")),
                                    New XElement("cell", row("COMMENTQ")),
                                    New XElement("cell", row("ORDER")),
                                    New XElement("cell", row("PASSNAME")),
                                    New XElement("cell", row("POKEY")),
                                    New XElement("cell", row("FULLBOXES")))))
                newDoc.LoadXml(xmlDoc.ToString())
                If TotalRowCount > 0 Then
                    Dim idx As Integer = TotalRowCount
                    Dim totqty As Decimal = Convert.ToDecimal(dtPurchaseList.Tables(0).Compute("SUM(QTYBOX)", String.Empty))
                    Dim totfbe As Decimal = Convert.ToDecimal(dtPurchaseList.Tables(0).Compute("SUM(FBE)", String.Empty))

                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = "<div style='margin-top: -7px;'><label  id='lblTotals' style='font-weight: bold;margin-top: -7px;'>Totals</label></div>"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = "<a id='aAllPurchaseTotQty_0' style='font-weight: bold;'>" + (Convert.ToInt32(totqty)).ToString() + "</a>"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = "<a id='aAllPurchaseTotFBE_0' style='font-weight: bold;'>" + (Convert.ToDecimal(totfbe)).ToString("#,##0.00") + "</a>"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                End If
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAllPurchasesGrid::PagePO")
            Return Nothing
        End Try
    End Function
#End Region
#Region "Create PO"

    <System.Web.Services.WebMethod(True)>
    Public Function LoadCreatePODropdowns(ByVal sqlId As Long, ByVal mode As Integer, ByVal origin As String, ByVal SaveFlag As String) As List(Of SPORDD)
        Try
            Dim data As New List(Of SPORDD)
            data = DAOPO.LoadCreatePODropdowns(sqlId, mode, origin, SaveFlag)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadCreatePODropdowns::PagePO")
            Return Nothing
        End Try
    End Function

    ' Added by Anubhuti 2023_08_04
    <System.Web.Services.WebMethod(True)>
    Public Function GetOriginByFarm(ByVal Farm As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim result = DAOPO.GetOriginByFarm(Farm)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetOriginByFarm()")
            Return 0
        End Try

    End Function

    'Start UPC,BOXCODE,DATECODE added by Anand[08/15/2021] 
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function LoadDataForCreatePOGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim newDoc As New XmlDocument()
            Dim users As User = Session("LoginUserDetails")
            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If
            Dim CreatePOList = Nothing
            CreatePOList = DAOPO.LoadDataForCreatePOGrid(users.SalesPerson)

            If CreatePOList Is Nothing Then
                Return Nothing
            End If
            Dim TotalRowCount As Integer = 0

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                If (TryCast(CreatePOList, Tuple(Of DataSet, String)).Item1.Tables(1).Rows(0)(0) <= 0) Then
                    Return Nothing
                End If

                If Convert.ToString(TryCast(CreatePOList, Tuple(Of DataSet, String)).Item2) = "success" Then
                    Dim selectedColumns As String() =
                            {"CUSTOMER", "FARM", "FLOWER", "BOXES", "PRICE", "FOB", "COST", "UNITS", "UNITSBUNCH", "UOM", "TYPE", "SHIPDATE", "ENDDATE", "CARRIER", "AGENCY", "COMMENTS", "ORDER", "CUSTNAME", "SALESMAN_NAME", "Future", "TOTALUNITS", "TOTALSALES", "TYPENAME"}

                    Dim dt As DataTable = New DataView(TryCast(CreatePOList, Tuple(Of DataSet, String)).Item1.Tables(0)).ToTable(False, selectedColumns)
                    TotalRowCount = dt.Rows.Count - 1
                    Dim dr As DataRow = dt.Rows(TotalRowCount)
                    dr.Delete()
                    dt.AcceptChanges()
                    'dt.Columns("[ORDER]").ColumnName = "ORDER"
                    Dim filepath = ExporttoExcel(dt, splitExportcsv(1) + "Header")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, CreatePOList(0).ErrorMessage, "", "Error Notification", "Error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim dtCreatePOList As New DataSet
                If Not TryCast(CreatePOList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                    dtCreatePOList = TryCast(CreatePOList, Tuple(Of DataSet, String)).Item1
                Else
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If
                TotalRowCount = Convert.ToInt32(dtCreatePOList.Tables(1).Rows(0)(0))
                'Modified by Anubhuti 2023_07_24
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                    New XElement("rows", New XElement("page", page.ToString()),
                                    New XElement("total", dtCreatePOList.Tables(1).Rows(0)(0)),
                                    From row In dtCreatePOList.Tables(0).Rows()
                                    Select New XElement("row", New XAttribute("id", row("SQLId")), New XAttribute("style", If(row("SQLId") <> "0", ChangeBgColorBasedOnPurchaseOrderStatus(row("SQLId"), 0), "")),
                                    New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='PurchasePOselect_" & row("SQLId").ToString() & "' src='images/check-off.png' />"),
                                    New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='ReservePOselect_" & row("SQLId").ToString() & "' src='images/check-off.png' />"),
                                    New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" + Convert.ToString(row("FLOWER") + "-" + row("FLOWERNAME")).Replace("'", "") + "'><a id='aCreatePOComent_" + row("FLOWER").ToString() + "'>" + row("FLOWERNAME").ToString() + "</a></div>"),
                                    New XElement("cell", row("BOXES")),
                                    New XElement("cell", row("UOM")),
                                    New XElement("cell", Convert.ToInt32(row("UNITS")).ToString()),
                                    New XElement("cell", row("UNITSBUNCH")),
                                    New XElement("cell", "<a id='aCreatePOPrice_" + row("SQLId").ToString() + "'>" + (Convert.ToDecimal(row("PRICE"))).ToString("#,##0.00") + "</a>"),
                                    New XElement("cell", row("ShipDateVal")),
                                    New XElement("cell", row("CargoDateVal")),
                                    New XElement("cell", row("Future")),
                                    New XElement("cell", row("TYPENAME")),
                                    New XElement("cell", row("FARM")),
                                    New XElement("cell", "<a id='aCreatePOCost_" + row("SQLId").ToString() + "'>" + (Convert.ToDecimal(row("COST"))).ToString("#,##0.00") + "</a>"),
                                    New XElement("cell", "<a id='aCreatePOOrder_" + row("ORDER").ToString() + "_" + row("CUSTOMER").ToString() + "' href='#' text-decoration: underline;>" + row("ORDER").ToString() + "</a>"),
                                    New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" + Convert.ToString(row("CUSTNAME")).Replace("'", "") + "'><a id='aCreatePOCust_" + row("CUSTOMER").ToString() + "'>" + If(ConfigurationManager.AppSettings("HideCustomerNameOnCreatePO").ToString() = "1", row("CUSTNAME").ToString().Split("/")(0), row("CUSTNAME").ToString()) + "</a></div>"),
                                    New XElement("cell", row("SALESMAN_NAME")),
                                    New XElement("cell", row("CARRIER")),
                                    New XElement("cell", row("AGENCY")),
                                    New XElement("cell", "<a id='aCreatePOTotUnits_" + row("SQLId").ToString() + "' style='font-weight: bold;'>" + (Convert.ToInt32(row("TOTALUNITS"))).ToString("#,##0") + "</a>"),
                                    New XElement("cell", "<a id='aCreatePOTotSales_" + row("SQLId").ToString() + "' style='font-weight: bold;'>" + (Convert.ToDecimal(row("TOTALSALES"))).ToString("#,##0.00") + "</a>"),
                                    New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" + Convert.ToString(row("COMMENTS")).Replace("'", "") + "'><a id='aCreatePOComent_" + row("ID").ToString() + "'>" + row("COMMENTS").ToString() + "</a></div>"),
                                    New XElement("cell", row("UPC")),
                                    New XElement("cell", row("BOXCODE")),
                                    New XElement("cell", row("DATECODE")),
                                    New XElement("cell", Convert.ToDateTime(row("ADDDATE")).ToString("yyyy/MM/dd hh:mm:ss tt")),
                                    New XElement("cell", Convert.ToDateTime(row("SHIPDATE")).ToString("MM/dd/yyyy")),
                                    New XElement("cell", Convert.ToDateTime(row("SHIPBOGOTA")).ToString("MM/dd/yyyy")),
                                    New XElement("cell", "<a id='aCreatePOSaveFlag_" + row("SQLId").ToString() + "' style='font-weight: bold;'>" + row("SaveFlag") + "</a>"),
                                    New XElement("cell", "<img style='cursor:pointer;margin-left:-4px;' title='" + GetPersonIconDetails(row("ADDUSER"), Convert.ToDateTime(row("ADDDATE")).ToString("MM/dd/yyyy"), row("ADDTIME"), row("ADDAPP"), row("UPDUSER"), Convert.ToDateTime(row("UPDDATE")).ToString("MM/dd/yyyy"), row("UPDTIME"), row("UPDAPP"), "", "", "", "", "", "", "", "") + "' id='imgaddeditDetails_" + row("PO").ToString() + "' src='images/Edit_user.png' />"))))
                newDoc.LoadXml(xmlDoc.ToString())
                If TotalRowCount > 0 Then
                    Dim idx As Integer = TotalRowCount
                    Dim totunits As Decimal = Convert.ToDecimal(dtCreatePOList.Tables(0).Compute("SUM(TOTALUNITS)", String.Empty))
                    Dim totsales As Decimal = Convert.ToDecimal(dtCreatePOList.Tables(0).Compute("SUM(TOTALSALES)", String.Empty))
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = "<a id='aCreatePOTotUnits_0' style='font-weight: bold;'>" + (Convert.ToInt32(totunits)).ToString() + "</a>"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = "<a id='aCreatePOTotSales_0' style='font-weight: bold;'>" + (Convert.ToDecimal(totsales)).ToString("#,##0.00") + "</a>"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                End If
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadDataForCreatePOGrid::PagePO")
            Return Nothing
        End Try
    End Function
    'Start UPC,BOXCODE,DATECODE added by Anand[08/15/2021] 
    <System.Web.Services.WebMethod(True)>
    Public Function CreatePOPurchase(ByVal SPORDID As String, ByVal Farm As String, ByVal Flower As String, ByVal Boxes As String, ByVal UOM As String, ByVal UnitsPerBunch As String, ByVal UnitsPerBox As String,
                                     ByVal CostPerUnits As String, ByVal Type As String, ByVal BoxCode As String, ByVal FarmComm1 As String, ByVal FarmComm2 As String,
                                     ByVal InternalComment As String, ByVal UPC As String, ByVal Description As String, ByVal DateCode As String, ByVal UPCPrice As String, ByVal SalesValue As String,
                                     ByVal Carrier As String, ByVal ShipDate As String, ByVal Status As String, ByVal Airport As String, ByVal WH As String,
                                     ByVal Freight As String, ByVal Handling As String, ByVal Andean As String, ByVal Price As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim PONumber As String = ""
            'PONumber = DAOPO.GetPONumberFromSalesMan(User.SalesPerson)
            'If PONumber.Contains("Sorry") Then
            '    Return PONumber
            'End If

            Dim FinalBoxNo As String = ""

            'Dim BoxnumberResult As String
            'BoxnumberResult = DAOPO.GetBoxNumberFromConstant()

            'If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
            '    Return BoxnumberResult
            'Else
            '    FinalBoxNo = BoxnumberResult
            'End If

            Dim startboxno As Integer = 0

            Return DAOPO.CreatePOPurchase(SPORDID, Farm, Flower, Boxes, UOM, UnitsPerBunch, UnitsPerBox, CostPerUnits, Type, startboxno, FarmComm1, FarmComm2,
                                          InternalComment, UPC, Description, DateCode, UPCPrice, User.ID, PONumber, SalesValue, Carrier, ShipDate, Status, Airport, WH, Freight, Handling, Andean, Price)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreatePOPurchase::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreatePOPurchaseForOrder(ByVal OrderDetId As String, ByVal Farm As String, ByVal Flower As String, ByVal Boxes As Integer, ByVal UOM As String, ByVal UnitsPerBunch As String, ByVal UnitsPerBox As String,
                                     ByVal CostPerUnits As Decimal, ByVal Type As String, ByVal BoxCode As String, ByVal FarmComm1 As String, ByVal FarmComm2 As String,
                                     ByVal InternalComment As String, ByVal UPC As String, ByVal Description As String, ByVal DateCode As String, ByVal UPCPrice As String, ByVal SalesValue As String,
                                     ByVal Carrier As String, ByVal ShipDate As String, ByVal Status As String, ByVal Airport As String, ByVal WH As String,
                                     ByVal Freight As String, ByVal Handling As String, ByVal Andean As String, ByVal Price As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim PONumber As String = ""
            'If lReadFromSQL = False Then
            '    PONumber = GetSLSMANPONum(User.SalesPerson)
            'Else
            '    PONumber = DAOPO.GetPONumberFromSalesMan(User.SalesPerson)
            'End If
            'If PONumber.Contains("Sorry") Then
            '    Return PONumber
            'End If

            Dim FinalBoxNo As String = ""
            'Dim BoxnumberResult As String
            'If lReadFromSQL = False Then
            '    BoxnumberResult = obj.GetMultipleBoxNumberFromConstant(1, User.Name)
            'Else
            '    BoxnumberResult = DAOPO.GetBoxNumberFromConstant()
            'End If

            'If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
            '    Return BoxnumberResult
            'Else
            '    FinalBoxNo = BoxnumberResult
            'End If

            Dim startboxno As Integer = 0

            Return DAOPO.CreatePOPurchaseForOrder(OrderDetId, Farm, Flower, Boxes, UOM, UnitsPerBunch, UnitsPerBox, CostPerUnits, Type, BoxCode, FarmComm1, FarmComm2,
                                          InternalComment, UPC, Description, DateCode, UPCPrice, User.ID, PONumber, SalesValue, Carrier, ShipDate, Status, Airport, WH, Freight, Handling, Andean, Price)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreatePOPurchase::PagePO")
            Return "error"
        End Try
    End Function
#End Region

#Region "Prod"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetProdForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ProdDetails.GetProdDetails()
            Dim data As List(Of Prod) = obj.GetProdListForFgrd(whereCondition, sortExp, start, rp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteProdDetails_" & row.ID.ToString() & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditProdDetails_" & row.ID.ToString() & "'/>"),
                                        New XElement("cell", row.FARM),
                                        New XElement("cell", row.CODE),
                                        New XElement("cell", row.UOM),
                                        New XElement("cell", row.NAME),
                                        New XElement("cell", row.FBE),
                                        New XElement("cell", row.SIZE)))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetProdForFgrd()::PageProd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadFarm() As List(Of Farm)
        Try
            Return Farms.LoadFarms()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadFarm::PageProductDetails")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function CheckFarmCodeAlreadyExists(ByVal Farm As String) As Integer
        Try
            Return Farms.CheckFarmCodeAlreadyExists(Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckFarmCodeAlreadyExists")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadTypes() As List(Of BO.Types)

        Try
            Return DAO.Types.LoadTypes()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadTypes::PageProductDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetProdDetailsByID(ByVal ID As Integer) As List(Of Prod)
        Try
            Dim data As List(Of Prod) = ProdDetails.GetProdDetails.GetProdDetailByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetProdDetailsByID::PageProdDetails")
            Throw ex
        End Try
    End Function
    ''' <summary>
    ''' Altered :: Muthu Nivetha M :: 05Feb2020 :: Implemented the changes of Box size maintenance/ Duplicate button
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveProdDetails(ByVal ID As String, ByVal CODE As String, ByVal FARM As String, ByVal NAME As String, ByVal UOM As String, ByVal SIZE As String, ByVal FBE As Decimal, ByVal VOLUME As Decimal, ByVal WEIGHT As Decimal, ByVal H As Decimal, ByVal W As Decimal, ByVal L As Decimal, ByVal isDuplicateBoxMaintance As Boolean) As String
        Try
            Dim ProdDetailsID As String = ""

            If (ID = "0" Or isDuplicateBoxMaintance) Then
                ProdDetailsID = ProdDetails.GetProdDetails.InsertProdDetails(CODE, FARM, NAME, UOM, SIZE, FBE, VOLUME, WEIGHT, H, W, L, isDuplicateBoxMaintance)
            Else

                ProdDetails.GetProdDetails.UpdateProdDetails(ID, CODE, FARM, NAME, UOM, SIZE, FBE, VOLUME, WEIGHT, H, W, L)
                ProdDetailsID = Convert.ToInt32(ID)
            End If
            If (Not CODE.Contains("UNIQUE KEY constraint")) Then
                Return ProdDetailsID
            Else
                Return ProdDetailsID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveProdDetails::PageProdDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteProdDetailsbyID(ByVal ID As String) As String
        Try
            Return ProdDetails.GetProdDetails.DeleteProdDetailsbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteProdDetailsbyID::PageProdDetails")
            Return Nothing
        End Try
    End Function

    'Added by Anubhuti 03/10/2023
    <System.Web.Services.WebMethod(True)>
    Public Function GetMaxPriceByCategory(ByVal FlowerCode As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim result = ProdDetails.GetMaxPriceByCategory(FlowerCode)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetMaxPriceByCategory()")
            Return 0
        End Try

    End Function
#End Region

#Region "Rack"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetRackDetails(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Rack), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If


            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data = Nothing

                data = DAO.Rack.GetRackDetails(whereCondition.ToUpper(), sortExp, 0, 0)


                If (data.count <= 0) Then
                    Return Nothing
                End If



                If data(0).ErrorMessage = "" Then
                    Dim dt1 As New DataTable
                    dt1 = ConvertToDataTable(data)
                    If Not dt1 Is Nothing Then
                        Dim selectedColumns As String() =
                        {"Rack", "Farm", "BoxNum", "BarCode", "Invoice", "Lot", "Order2Rec", "ID", "Carrier",
                         "ARBoxNo", "Consignee", "BoxSize", "Lenght", "Width", "Height", "Product", "CUSTPO", "InvProductName", "Gun", "OldRack", "AddUser", "AddDate", "AddTime", "AddApp"}
                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("Lot").ColumnName = "AWB#"
                        dt.Columns("LENGHT").ColumnName = "LENGTH"
                        dt.Columns("InvProductName").ColumnName = "Name"
                        'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Rack")
                        Return BuildXmlDoc(filepath)
                    End If

                End If
            Else

                Dim RackList = Nothing
                RackList = DAO.Rack.GetRackDetails(whereCondition.ToUpper(), sortExp, start, rp)

                Dim dsRackList As New DataTable
                If Not RackList Is Nothing Then
                    dsRackList = ConvertToDataTable(RackList)
                Else
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc
                End If



                If dsRackList.Rows.Count > 0 Then
                    If Convert.ToString(dsRackList(0)("ErrorMessage")) <> "" Then
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, Convert.ToString(dsRackList(0)("ErrorMessage")), "", "Error Notification", "error")
                        'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")

                    Else
                        Dim TotalRowCount As Integer = 0
                        If dsRackList.Rows.Count > 0 Then
                            TotalRowCount = dsRackList.Rows.Count
                        End If
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", dsRackList(0)("TotalRows")),
                        From row In dsRackList
                        Select
                        New XElement("row", New XAttribute("id", row.Item("Rack")), New XAttribute("style", IIf(row.Item("Comments") <> "", "background: RGB(157, 181, 157);", "")),
                        New XElement("cell", row.Item("Rack").ToString()),
                        New XElement("cell", row.Item("Farm")),
                        New XElement("cell", row.Item("BoxNum")),
                        New XElement("cell", row.Item("BarCode").ToString()),
                        New XElement("cell", row.Item("Invoice")),
                        New XElement("cell", row.Item("Lot")),
                        New XElement("cell", row.Item("Order2Rec").ToString()),
                        New XElement("cell", row.Item("ID")),
                        New XElement("cell", row.Item("Carrier")),
                        New XElement("cell", row.Item("ARBOXNO")),
                        New XElement("cell", row.Item("CONSIGNEE")),
                        New XElement("cell", row.Item("BOXSIZE")),
                        New XElement("cell", row.Item("LENGHT")),
                        New XElement("cell", row.Item("WIDTH")),
                        New XElement("cell", row.Item("HEIGHT")),
                        New XElement("cell", "<a title='" + row.Item("PRODUCT") + "'>" + row.Item("PRODUCT") + "</a>"),
                        New XElement("cell", row.Item("CUSTPO")),
                        New XElement("cell", "<a title='" + row.Item("Comments") + "'>" + row.Item("InvProductName") + "</a>"),
                        New XElement("cell", row.Item("Gun")),
                        New XElement("cell", row.Item("OldRack")),
                        New XElement("cell", row.Item("AddUser")),
                        New XElement("cell", Convert.ToDateTime(row.Item("AddDate")).ToString("MM/dd/yyyy")),
                        New XElement("cell", row.Item("AddTime")),
                        New XElement("cell", row.Item("AddApp")))))
                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Return newDoc
                    End If
                Else
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc
                End If
            End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetRackDetails::PageInventory")
            Return Nothing
        End Try
        Return Nothing
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetRacksLocationByBoxnum(ByVal Boxnum As String, ByVal Farm As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim obj As New DAO.Rack
            Dim data = Nothing
            data = obj.GetRacksLocationByBoxnum(Boxnum, Farm) ' Modified by Anubhuti 18-12-2022
            Dim dt As DataTable = ConvertToDataTable(data)
            Dim TotalRowCount As Integer = 0
            TotalRowCount = dt.Rows.Count

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", "0"),
                       New XElement("total", TotalRowCount),
                       From row In dt.Rows()
                       Select
                       New XElement("row", New XAttribute("id", Convert.ToString(row("BarCode"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", row("Rack")),
                       New XElement("cell", row("BarCode")),
                       New XElement("cell", row("Invoice")),
                       New XElement("cell", Convert.ToDateTime(row.Item("AddDate")).ToString("MM/dd/yyyy")),
                       New XElement("cell", row("AddTime")))))


            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(Convert.ToString(xmlDoc))
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetRacksLocationByBoxnum")
            Return Nothing
        End Try
    End Function
#End Region

#Region "#CustUser"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCustManualPODetailForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String,
                                             ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal Filter As String) As XmlDocument

        Try
            Dim whereCondition As String = ""
            If qtype = "AWB" Then
                query = Regex.Replace(query, "[-]", "")
            End If
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            Dim DateSession(1) As String
            If (Not Session("DateSession") Is Nothing) Then
                DateSession = Session("DateSession")
            Else
                DateSession = Nothing
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""
            If (DateSession Is Nothing) Then
                'FromDate = DateTime.Now.ToString("MM/dd/yyyy")
                ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            Else
                FromDate = DateSession(0).ToString()
                ToDate = DateSession(1).ToString()
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If (whereCondition = "" Or whereCondition = String.Empty Or whereCondition = Nothing) Then
                If (Filter = "" And Filter = String.Empty) Then
                    If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                        whereCondition = "cast(ShippedDate as date)>= '" + ToDate + "'"
                    Else
                        whereCondition = "cast(ShippedDate as date)>= '" + FromDate + "' And " + " cast(ShippedDate as date) <= '" + ToDate + "'"
                    End If
                    whereCondition = whereCondition + " And CustNumber=" + User.CustomerNo
                Else
                    whereCondition = Filter + " And CustNumber=" + User.CustomerNo
                End If

            Else
                If (Filter <> "" And Filter <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter
                Else
                    If FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                        whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>= '" + FromDate + "'"
                    Else
                        whereCondition = whereCondition + " And " + "cast(ShippedDate as date)>= '" + FromDate + "' And " + " cast(ShippedDate as date) <= '" + ToDate + "'"
                    End If
                    whereCondition = whereCondition + " And CustNumber=" + User.CustomerNo
                End If
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New CustUser.GetCustPODetail()
            Dim data As List(Of CustManualPODetail) = obj.GetCustManualPODetail(whereCondition, sortExp, start, rp)

            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
            Dim FlowerColorVisibility As Boolean = False
            For Each i In UserFeatures
                If i.Name.ToLower = "show flower color" Then
                    FlowerColorVisibility = i.Value
                End If
            Next


            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                  New XElement("rows", New XElement("page", page.ToString()),
                  New XElement("total", If(obj.TotalRows.ToString() = "0", "1", obj.TotalRows.ToString())),
                  data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID), New XAttribute("Class", IIf(row.POSelected, "trChecked", "")),
                  New XElement("cell", "<b><a href='#' id='deleteManualPOdetail_" & row.DetailID & "'><img src='images/Delete-icon.png'/></a></b>"),
                  New XElement("cell", "<b><a href='#' id='editManualPOdetail_" & row.DetailID & "'><img src='images/Edit.png'/></a></b>"),
                  New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='ManualPOselect_" & row.DetailID.ToString() & "' src='" &
                                        IIf(row.POSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                  New XElement("cell", If(row.AWB <> "" And row.AWB <> String.Empty, FormatAWBnumber(row.AWB), "")),
                  New XElement("cell", IIf(row.ShipDate = Convert.ToDateTime("01/01/1900"), "", row.ShipDate.ToString("MM/dd/yyyy"))),
                  New XElement("cell", row.Farm),
                  New XElement("cell", row.Flower),
                  New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.FlowrDetails.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.FlowrDetails.ForeColor.ToString() + ";'>" + row.Description + "</a></div>", "<a >" + row.Description + "</a>")),
                  New XElement("cell", row.Boxes),
                  New XElement("cell", row.UOM),
                  New XElement("cell", row.UnitsPerBunch),
                  New XElement("cell", row.UnitsPerBox),
                  New XElement("cell", row.TotalUnits),
                  New XElement("cell", row.Cost),
                  New XElement("cell", "$" + row.TotalCost.ToString("#,##0.00")),
                  New XElement("cell", IIf(row.Type = "", "", row.Type)),
                  New XElement("cell", IIf(row.CustNumber = "0", "", row.CustNumber)),
                  New XElement("cell", IIf(row.Comments = "", "", row.Comments)),
                  New XElement("cell", IIf(row.AgencyCode = "", "", row.AgencyCode)),
                  New XElement("cell", IIf(row.Airport = "", "", row.Airport)),
                  New XElement("cell", IIf(row.BreakDown = "", "", row.BreakDown)),
                  New XElement("cell", IIf(row.BoxCode = "", "", row.BoxCode)),
                  New XElement("cell", row.BoxNumber),
                  New XElement("cell", row.PO),
                  New XElement("cell", row.Invoice),
                  New XElement("cell", row.HAWB),
                  New XElement("cell", row.Missing)))))

            ' New XElement("cell", "$" + IIf(IsDBNull(row.TotalCost), 0, row.TotalCost.ToString("#,##0.00"))),
            Dim newDoc As New XmlDocument()
            Dim idx As Integer = IIf(data.Count > 0, data.Count - 1, 0)
            newDoc.LoadXml(xmlDoc.ToString())
            If (data.Count > 0) Then
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = "Totals"
            End If
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustManualPODetailForFgrd::PageCustUser")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Sub SaveCustUserDateSession(ByVal FromDate As String, ByVal ToDate As String)
    '    Try
    '        If FromDate <> "" And ToDate <> "" Then
    '            Dim DateSession(1) As String
    '            DateSession(0) = FromDate
    '            DateSession(1) = ToDate
    '            Session("CustUserDateSession") = DateSession
    '        Else
    '            Session("CustUserDateSession") = Nothing
    '        End If

    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::SaveCustUserDateSession::PageCustUser")
    '    End Try
    'End Sub

    'Anitha::02-03-2016::FOR DATE FILLTER 
    '<System.Web.Services.WebMethod(True)>
    'Public Function GetCustUserDateSession() As String()
    '    Try
    '        Dim DateSession(1) As String
    '        DateSession = Session("CustUserDateSession")
    '        Return DateSession
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetIncomingDaGetCustUserDateSessionteSession::PageCustUser")
    '        Return Nothing
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAWBNumbersForCustUser() As List(Of CustManualPODetail)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return CustUser.GetAWBNumbersForCustUser(User.CustomerNo)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAWBNumbersForCustUser::PageCustUser")
            Return Nothing
        End Try
    End Function

    'GetFomrsForInCustUser
    <System.Web.Services.WebMethod(True)>
    Public Function GetFamrsForCustUser() As List(Of CustManualPODetail)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return CustUser.GetFamrsForCustUser(User.CustomerNo)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFamrsForCustUser::PageCustUser")
            Return Nothing
        End Try
    End Function
#End Region

#Region "GrowerHeader"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerHeaderForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                            ByVal qtype As String, ByVal ExportCSV As String, ByVal FromDate As String, ByVal ToDate As String, ByVal IsActive As String) As XmlDocument
        Try
            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(GrowerHeader), qtype, query)
            End If

            'Dim DateSession(1) As String
            'If (Not Session("DateSession") Is Nothing) Then
            '    DateSession = Session("DateSession")
            'Else
            '    DateSession = Nothing
            'End If

            'Dim FromDate As String = ""
            'Dim ToDate As String = ""
            'If (DateSession Is Nothing) Then
            '    ToDate = DateTime.Now.ToString("MM/dd/yyyy")
            'Else
            '    FromDate = DateSession(0).ToString()
            '    ToDate = DateSession(1).ToString()
            'End If
            Dim LoginUserDetails As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim FilterCode As String = ""

            If FromDate <> "" And ToDate <> "" Then
                FilterCode = "GrowerFromDate >= convert(datetime,'" + FromDate + "') " + " And " + " GrowerFromDate <= convert(datetime,'" + ToDate + "')"
            ElseIf FromDate = "" And ToDate = DateTime.Now.ToString("MM/dd/yyyy") Then
                FilterCode = "GrowerFromDate >= convert(datetime,'" + ToDate + "') "
            End If



            whereCondition = IIf(whereCondition = "", FilterCode, whereCondition + " and " + FilterCode)
            If IsActive = 0 Then
                whereCondition = IIf(whereCondition = "", " IsActive=0", whereCondition + " and " + " IsActive=0")
            Else
                whereCondition = IIf(whereCondition = "", " IsActive=1", whereCondition + " and " + " IsActive=1")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerHeaders.GetGrowerHeaderFgrd()
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of GrowerHeader) = obj.GetGrowerHeaderForFgrd(whereCondition, sortExp, start, splitExportcsv(2))

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"GrowerFromDate", "GrowerToDate", "ReportName", "ReportNumber"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("GrowerFromDate").ColumnName = "From Date"
                dt.Columns("GrowerToDate").ColumnName = "To Date"
                dt.Columns("ReportName").ColumnName = "Name"
                dt.Columns("ReportNumber").ColumnName = "Report #"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("From Date").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of GrowerHeader) = obj.GetGrowerHeaderForFgrd(whereCondition, sortExp, start, rp)

                Dim UserDetails As New User
                If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                    UserDetails = HttpContext.Current.Session("LoginAdminDetails")
                ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                    UserDetails = HttpContext.Current.Session("LoginUserDetails")
                End If

                'For i = 0 To data.Count - 1
                '    data(i).GrowerLockContent = GrowerHeaders.CheckGrowerReportIsAlreadyLocked(data(i).ID, UserDetails.ID)
                'Next

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID), New XAttribute("style", IIf(row.IsActive = False <> 0, "background:#FF9B9B !important", "")),
                                            New XElement("cell", IIf(row.IsActive = True, IIf(row.GrowerLockContent Is Nothing, "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='deleteGrowerHeader_" & row.ID & "'/>", ""), "")),
                                            New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='editGrowerHeader_" & row.ID & "'/>"),
                                            New XElement("cell", row.GrowerFromDate.ToString("MM/dd/yy")),
                                            New XElement("cell", row.GrowerToDate.ToString("MM/dd/yy")),
                                            New XElement("cell", row.ReportName),
                                            New XElement("cell", row.ReportNumber),
                                            New XElement("cell", "<img style='Cursor:pointer;' id='imglock_" + IIf(row.Islocked, "1", "0") + "_" + row.ID.ToString() + "' src='" & IIf(row.Islocked, "images/locked.png", "images/unlocked.png") & "' />"),
                                            New XElement("cell", "<img style='Cursor:pointer;' title='Export To Excel' id='imgExportAllGrowerData_" + row.ID.ToString() + "' src='images/Excel.png' />"),
                                            New XElement("cell", row.GrowerLockContent)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerHeaderForFgrd::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveGrowerHeader(ByVal HeaderID As String, ByVal HeaderFromDate As String, ByVal HeaderToDate As String, ByVal ReportName As String, ByVal ReportNumber As String, ByVal IsImportGrowerfromDbf As Boolean) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If HeaderID = 0 Then 'add mode
                'step 1: save header with reportname and get inserted id
                HeaderID = GrowerHeaders.SaveGrowerHeader(HeaderID, HeaderFromDate, HeaderToDate, ReportName.ToUpper(), ReportNumber.ToUpper(), User.ID)

                'step 2: Get grower details from dbf for report num and bulk  insert in dbfservice
                If (IsImportGrowerfromDbf) Then
                    'Dim detailinsertresult = obj.GetGrowerDetailsByReportNumber(ReportNumber, HeaderID, User.ID)  //Commented by Belal 11 Aug 2020 this api no need
                    'If detailinsertresult = "No data found" Then
                    '    Return "No data found"
                    'End If
                End If


                'step 3: Import Prod details to sql for update FBE for grower details
                'If (IsImportGrowerfromDbf) Then
                ' ImportProdDetailsfromDBF()
                'End If

                'step 4: 
                GrowerHeaders.InsertGrowerNotesFromCredits(HeaderID, User.ID, "0")

                'step 5: finally update fbe for growerdetails
                GrowerHeaders.UpdateFBEForGrowerDetails(HeaderID, "0")
            Else  'edit mode
                GrowerHeaders.SaveGrowerHeader(HeaderID, HeaderFromDate, HeaderToDate, ReportName.ToUpper(), ReportNumber.ToUpper(), User.ID)
            End If



            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::SaveGrowerHeader::PageGrower")
            Return "error"
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerHeaderByID(ID As Integer) As GrowerHeader
        Try

            Dim GrowerHeader As GrowerHeader = GrowerHeaders.GetGrowerHeaderById(ID)
            Return GrowerHeader
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerHeaderByID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteGrowerHeaderWithDetailsByID(ID As Integer) As String
        Try
            Dim GrowerHeader As String = GrowerHeaders.DeleteGrowerHeaderWithDetailsById(ID)
            Return GrowerHeader
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerHeaderByID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerFarmHeaderForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                            ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(GrowerDetail), qtype, query)
            End If

            If Filter IsNot Nothing Then
                whereCondition = IIf(whereCondition <> "", whereCondition + " and " + Filter, Filter)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerDetails.GetGrowerFarmHeaderFgrd()

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of GrowerDetail) = obj.GetGrowerFarmHeaderForFgrd(whereCondition, sortExp, start, splitExportcsv(2))

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Farm", "FarmName", "FarmAirport", "FarmCountry", "FOB", "Boxes", "Boxes_rec", "FBE", "FBE_REC", "Gross"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Farm").ColumnName = "Farm"
                dt.Columns("FarmName").ColumnName = "Name"
                dt.Columns("FarmAirport").ColumnName = "Airport"
                dt.Columns("FarmCountry").ColumnName = "Country"
                dt.Columns("FOB").ColumnName = "FOB"
                dt.Columns("Boxes").ColumnName = "Pieces"
                dt.Columns("FBE").ColumnName = "FBE"
                dt.Columns("FBE_REC").ColumnName = "FBE_rec"
                dt.Columns("Gross").ColumnName = "$ Amount"

                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Farm").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "$Farm")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of GrowerDetail) = obj.GetGrowerFarmHeaderForFgrd(whereCondition, sortExp, start, rp)
                Dim UserDetails As New User
                If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                    UserDetails = HttpContext.Current.Session("LoginAdminDetails")
                ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                    UserDetails = HttpContext.Current.Session("LoginUserDetails")
                End If
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.RECNO), New XAttribute("style", IIf(row.Boxes <> row.Boxes_rec And row.RECNO <> 0, "background:#FF9B9B", "")),
                                            New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='deleteGrowerFarm_" & row.HeaderID & "_" + row.Farm + "'/>"),
                                            New XElement("cell", String.Format("<span title='" + row.FarmName.Replace("'", "") + "'>" & row.Farm & "</span>")),
                                            New XElement("cell", "<img href='#' src='images/invoice2.png' style='cursor:pointer' id='editGrowerFarmHeader_" & row.HeaderID.ToString() & "_" & row.Farm & "'/>"),
                                            New XElement("cell", row.FOB),
                                            New XElement("cell", row.Boxes_rec),
                                            New XElement("cell", row.FBE_REC.ToString("0.000")),
                                            New XElement("cell", IIf(row.Gross <> 0.0, row.Gross.ToString("N", CultureInfo.InvariantCulture), row.Gross)),
                                            New XElement("cell", String.Format("<a href='#' id='lnkGrowerFarmFile_" + row.FarmDetailID.ToString() + "_" + row.HeaderID.ToString() + "_" + row.Farm + "' data-filename='" + IIf(Convert.ToString(row.FarmFileName) = "", "Upload A File", row.FarmFileName) + "' title='" + IIf(Convert.ToString(row.FarmFileName) = "", "Upload A File", row.FarmFileName) + "' style='cursor:pointer'>" + IIf(Convert.ToString(row.FarmFileName) = "", "<img src='images/addfile.png' height='16' width='16'  />", "<img src='images/editfile.png' height='16' width='16' />") + "</a>")),
                                            New XElement("cell", row.FarmAirport),
                                            New XElement("cell", row.FarmCountry),
                                            New XElement("cell", row.FarmName),
                                            New XElement("cell", "<img href='#' src='images/Clear.png' title='clear invoice' style='cursor:pointer' id='ClearInvoiceNumberForFarm_" & row.HeaderID.ToString() & "_" & row.Farm & "'/>")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Dim idx As Integer = data.Count - 1
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""

                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerHeaderForFgrd::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteGrowerFarmByHeaderID(HeaderID As String, Farm As String) As String
        Try
            Return GrowerDetails.DeleteGrowerFarmByHeaderID(HeaderID, Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteGrowerFarmByHeaderID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteGrowerAWBByHeaderID(HeaderID As String, AWB As String) As String
        Try
            Return GrowerDetails.DeleteGrowerAWBByHeaderID(HeaderID, AWB)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteGrowerAWBByHeaderID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerAWBHeaderForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                            ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype = "Awb" Then
                query = Regex.Replace(query, "[-]", "")
            End If
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(GrowerDetail), qtype, query)
            End If

            If Filter IsNot Nothing Then
                whereCondition = IIf(whereCondition <> "", whereCondition + " and " + Filter, Filter)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerDetails.GetGrowerFarmHeaderFgrd()

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of GrowerDetail) = obj.GetGrowerAWBHeaderForFgrd(whereCondition, sortExp, start, splitExportcsv(2))

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Awb", "ReceivingDate", "FBE_rec", "FBE_Sold"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Awb").ColumnName = "Awb"
                dt.Columns("ReceivingDate").ColumnName = "DateRec"
                dt.Columns("FBE_REC").ColumnName = "FBE_rec"
                dt.Columns("FBE_Sold").ColumnName = "FBE_Sold"

                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Awb").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of GrowerDetail) = obj.GetGrowerAWBHeaderForFgrd(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.RECNO), New XAttribute("style", IIf(row.FBE_REC <> row.FBE_Sold And row.RECNO <> 0, "background:#FF9B9B", "")),
                                            New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='deleteGrowerAWB_" & row.HeaderID & "_" + row.Awb + "'/>"),
                                            New XElement("cell", FormatAWBnumber(row.Awb)),
                                            New XElement("cell", row.ReceivingDate.ToString("MM/dd/yyyy")),
                                            New XElement("cell", row.FBE_REC.ToString("0.000")),
                                            New XElement("cell", row.FBE_Sold.ToString("0.000"))))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Dim idx As Integer = data.Count - 1
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = "Total"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""

                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerHeaderForFgrd::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerFarmDetailForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                            ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(GrowerDetail), qtype, query)
            End If

            If Filter IsNot Nothing Then
                whereCondition = IIf(whereCondition <> "", whereCondition + " and " + Filter, Filter)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerDetails.GetGrowerFarmHeaderFgrd()
            If (ExportCSV <> "") Then

                'Dim splitExportcsv = ExportCSV.Split("|")
                Dim filepath As String = ExportGrowerDetailsToExcelByWhereCondition("", whereCondition, sortExp)

                'Dim data As List(Of GrowerDetail) = obj.GetGrowerFarmDetailForFgrd(whereCondition, sortExp, start, splitExportcsv(2))

                'Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                'Dim selectedColumns As String() =
                '    {"Farm", "Flower", "FlowerName", "Boxes_rec", "Boxes", "UOM", "Units", "TotalUnits", "Cost", "TotalCost", "FBE", "ReceivingDate", "Customer", "Awb", "Boxnum", "Invoice", "Notes", "FOB", "Type", "Adjust", "BoxCharge", "Freight", "Duties", "Fuel", "Fumigation",
                '     "Other", "Commission", "Packing", "Handling", "Tax1", "Tax2", "Tax3", "FuelPaid"}

                'Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'dt.Columns("Awb").ColumnName = "Awb"
                'dt.Columns("Boxes").ColumnName = "Boxes"
                'dt.Columns("FBE").ColumnName = "FBE"
                'dt.Columns("ReceivingDate").ColumnName = "DateRec"
                'dt.Columns("FOB").ColumnName = "PurchaseType"
                'dt.Columns("Adjust").ColumnName = "Credits"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                'Dim dtCloned As DataTable = dt.Clone()
                'dtCloned.Columns("Awb").DataType = GetType(String)
                'For Each row As DataRow In dt.Rows
                '    dtCloned.ImportRow(row)
                'Next
                'Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "$FarmDetail")

                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of GrowerDetail) = obj.GetGrowerFarmDetailForFgrd(whereCondition, sortExp)

                Dim FlowerColorVisibility As Boolean = False
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                'For Each i In UserFeatures
                '    If i.Name.ToLower = "show flower color" Then
                '        FlowerColorVisibility = i.Value
                '    End If
                'Next

                If Not UserFeatures Is Nothing Then
                    For Each i In UserFeatures
                        If i.Name.ToLower = "show flower color" Then
                            FlowerColorVisibility = i.Value
                        End If
                    Next
                End If
                'New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div id='GrowerDetailFlower_" + row.DetailID.ToString() + "' style='padding-bottom: 3px;background-color:" + row.FlowerDetails.BGColor.ToString() + ";cursor:pointer;color:" + row.FlowerDetails.FontColor.ToString() +
                '                                          "' class='flowerDescription' title='" + row.Flower + "-" + row.FlowerName.Replace("'", "") + "'>" & row.FlowerName &
                '                                        "</div>", "<div id='GrowerDetailFlower_" + row.DetailID.ToString() + "' style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" + row.Flower + "-" +
                '                                         Row.FlowerName.Replace("'", "") + "'>" & row.FlowerName & "</div>"))),

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID), New XAttribute("style", IIf(row.DetailID <> 0, IIf(row.Boxes <> row.Boxes_rec, "background:#FF9B9B", IIf(row.Adjust <> row.NotesAmount, "background:rgb(201, 104, 35)", "")), "")),
                                            New XElement("cell", "<b><a href='#' id='deleteGrowerFarmDetail_" & row.DetailID & "'><img style='cursor:pointer' src='images/Delete-icon.png'/></a></b>"),
                                            New XElement("cell", "<b><a href='#' id='editGrowerFarmDetail_" & row.DetailID & "'><img style='cursor:pointer' src='images/Edit.png'/></a></b>"),
                                            New XElement("cell", "<b><a href='#' id='editGrowerDetailNotes_" & row.DetailID & "'>" + IIf(row.NotesCount > 0, "<img src='images/notes.png'/>", "<img src='images/no-notes.png'/>") + "</a></b>"),
                                            New XElement("cell", String.Format("<span id='GrowerDetailFarm_" + row.DetailID.ToString() + "' title='" + row.FarmName.Replace("'", "") + "'>" & row.Farm & "</span>")),
                                            New XElement("cell", String.Format("<span id='GrowerDetailFlowerCode_" + row.DetailID.ToString() + "'>" & row.Flower & "</span>")),
                                            New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div id='GrowerDetailFlower_" + row.DetailID.ToString() + "' style='padding-bottom: 3px;" &
                                                                                      "' class='flowerDescription' title='" + row.Flower + "-" + row.FlowerName.Replace("'", "") + "'>" & row.FlowerName &
                                                                                    "</div>", "<div id='GrowerDetailFlower_" + row.DetailID.ToString() + "' style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" + row.Flower + "-" +
                                                                                     row.FlowerName.Replace("'", "") + "'>" & row.FlowerName & "</div>"))),
                                            New XElement("cell", "<a id='GrowerDetailBoxes_rec_" + row.DetailID.ToString() + "'>" + row.Boxes_rec.ToString("N0") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailBoxes_" + row.DetailID.ToString() + "'>" + row.Boxes.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailUOM_" + row.DetailID.ToString() + "'>" + row.UOM.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailUnits_" + row.DetailID.ToString() + "'>" + row.Units.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailTotalUnits_" + row.DetailID.ToString() + "'>" + row.TotalUnits.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailCost_" + row.DetailID.ToString() + "'>" + row.Cost.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailTotCost_" + row.DetailID.ToString() + "'>" + IIf(row.TotalCost <> 0.0, row.TotalCost.ToString("N", CultureInfo.InvariantCulture), row.TotalCost.ToString("0.00")) + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailFBE_" + row.DetailID.ToString() + "'>" + row.FBE_REC.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailReceivingDate_" + row.DetailID.ToString() + "'>" + row.ReceivingDate.ToString("MM/dd") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailCust_" + row.DetailID.ToString() + "'>" + row.Customer + "</a>"),
                                            New XElement("cell", String.Format("<span id='GrowerDetailAwb_" + row.DetailID.ToString() + "' title='" + row.Awb + "'>" & If(row.Awb <> "" And row.Awb <> String.Empty, If(row.Awb.Length > 4, row.Awb.Substring(row.Awb.Length - 4, 4), row.Awb), "") & "</span>")),
                                            New XElement("cell", "<a id='GrowerDetailBoxnum_" + row.DetailID.ToString() + "'>" + row.Boxnum + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailInvoice_" + row.DetailID.ToString() + "'>" + row.Invoice + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailNotes_" + row.DetailID.ToString() + "'>" + row.Notes + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailFOB_" + row.DetailID.ToString() + "'>" + row.FOB + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailType_" + row.DetailID.ToString() + "'>" + row.Type + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailAdjust_" + row.DetailID.ToString() + "'>" + row.Adjust.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailBoxCharge_" + row.DetailID.ToString() + "'>" + row.BoxCharge.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailFreight_" + row.DetailID.ToString() + "'>" + row.Freight.ToString("#,##0.00") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailDuties_" + row.DetailID.ToString() + "'>" + row.Duties.ToString("#,##0.00") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailFuel_" + row.DetailID.ToString() + "'>" + row.Fuel.ToString("#,##0.00") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailFumigation_" + row.DetailID.ToString() + "'>" + row.Fumigation.ToString("#,##0.00") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailOther_" + row.DetailID.ToString() + "'>" + row.Other.ToString("#,##0.00") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailCommission_" + row.DetailID.ToString() + "'>" + row.Commission.ToString("#,##0.00") + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailPacking_" + row.DetailID.ToString() + "'>" + row.Packing.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailHandling_" + row.DetailID.ToString() + "'>" + row.Handling.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailPrice_" + row.DetailID.ToString() + "'>" + row.Price.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailTax1_" + row.DetailID.ToString() + "'>" + row.Tax1.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailTax2_" + row.DetailID.ToString() + "'>" + row.Tax2.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailTax3_" + row.DetailID.ToString() + "'>" + row.Tax3.ToString() + "</a>"),
                                            New XElement("cell", "<a id='GrowerDetailFuelPaid_" + row.DetailID.ToString() + "'>" + row.FuelPaid.ToString() + "</a>")))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Dim idx As Integer = data.Count - 1
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = "Total"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""   
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(26).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(27).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(28).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(29).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(30).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(31).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(32).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(33).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(34).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(35).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(36).InnerText = ""
                Return newDoc

            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerFarmDetailForFgrd::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ExportGrowerDetailsToExcelByWhereCondition(ByVal HeaderID As String, ByVal WhereCondition As String, ByVal SortExp As String) As String
        Try

            Dim obj As New GrowerDetails.GetGrowerFarmHeaderFgrd()
            Dim data As List(Of GrowerDetail)
            If HeaderID = "" Then
                data = obj.GetGrowerFarmDetailForFgrd(WhereCondition, SortExp)
            Else
                data = obj.GetGrowerFarmDetailForFgrd("HeaderID=" + HeaderID + "", SortExp)
            End If

            Dim dt1 As DataTable
            dt1 = ConvertToDataTable(data)
            Dim selectedColumns As String() =
                    {"Farm", "Flower", "FlowerName", "Boxes_rec", "Boxes", "UOM", "Units", "TotalUnits", "Cost", "TotalCost", "FBE_REC", "ReceivingDate", "Customer", "Awb", "Boxnum", "Invoice", "Notes", "FOB", "Type", "Adjust", "BoxCharge", "Freight", "Duties", "Fuel", "Fumigation",
                     "Other", "Commission", "Packing", "Handling", "Tax1", "Tax2", "Tax3", "FuelPaid"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            dt.Columns("Awb").ColumnName = "Awb"
            dt.Columns("Boxes").ColumnName = "Boxes"
            dt.Columns("FBE_REC").ColumnName = "FBE_rec"
            dt.Columns("ReceivingDate").ColumnName = "DateRec"
            dt.Columns("FOB").ColumnName = "PurchaseType"
            dt.Columns("Adjust").ColumnName = "Credits"

            dt.Rows.RemoveAt(dt.Rows.Count - 1)
            Dim dtCloned As DataTable = dt.Clone()
            dtCloned.Columns("Awb").DataType = GetType(String)
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "Grower$FarmDetail")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportGrowerDetailsByCondition::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteGrowerDetailsByID(ID As Integer) As String
        Try
            Dim GrowerDetail As String = GrowerDetails.DeleteGrowerDetailsByID(ID)
            Return GrowerDetail
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteGrowerDetailByID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerDetailByID(ID As Integer) As GrowerDetail
        Try
            Dim GrowerDetail As GrowerDetail = GrowerDetails.GetGrowerDetailById(ID)
            Return GrowerDetail
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerDetailByID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveGrowerDetail(ByVal ID As String, ByVal Farm As String, ByVal Flower As String, ByVal FlowerName As String,
                                     ByVal Boxes As Integer, ByVal Boxes_rec As Integer, ByVal Units As Integer, ByVal UOM As String,
                                     ByVal Adjust As Decimal, ByVal Freight As Decimal, ByVal Duties As Decimal, ByVal Fumigation As Decimal,
                                     ByVal Other As Decimal, ByVal Cost As Decimal, ByVal Price As Decimal,
                                     ByVal Invoice As String, ByVal Type As String, ByVal ReceivingDate As String, ByVal Awb As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim FBE As Decimal
            FBE = 0

            'Dim FBE As Decimal = objDbfService.GetFBEForGrowerEdit(Flower, Farm, UOM, Boxes)

            'Dim nFBE As Decimal = Inventory.InventoryGrid.GetFBE(r("CAT"), Row("FARM"), Row("UOM"))
            'FBE += nFBE * Convert.ToDecimal(Row("Boxes"))

            Return GrowerDetails.SaveGrowerDetail(ID, Flower, FlowerName, Boxes, Boxes_rec, FBE, Units, UOM, Adjust, Freight, Duties, Fumigation, Other,
                                     Cost, Price, Invoice, Type, User.ID, ReceivingDate, Awb)

            'Return Nothing
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveGrowerDetail::PageGrower")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadAllFarmByGrowerHeaderID(ByVal HeaderID As String, ByVal Query As String, ByVal qtype As String) As List(Of GrowerDetail)
        Try
            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso Query IsNot Nothing AndAlso Query <> String.Empty Then
                whereCondition = " And " + BuildWhereCondition(GetType(GrowerDetail), qtype, Query)
            End If

            Return GrowerDetails.LoadAllFarmByGrowerHeaderID(HeaderID, whereCondition)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadAllFarmByGrowerHeaderID::PageGrowerReport")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintMultipleReportsInGrower(ByVal PrintFOBDetailedReport As String, ByVal PrintFOBSummaryReport As String, ByVal PrintConsDetailedReport As String,
                                                 ByVal PrintConsignmentSummary As String, ByVal PrintFarmDetailedReport As String, ByVal HeaderID As String, ByVal Farm As String,
                                                 ByVal FromDate As String, ByVal ToDate As String) As String
        Try

            Dim PrintFOBDetailedReportres As String = ""
            Dim PrintConsDetailedReportres As String = ""
            Dim PrintFOBSummaryReportres As String = ""
            Dim PrintConsSummaryReportres As String = ""
            Dim PrintFarmDetailedReportres As String = ""
            'ImportGrowerCgfromDBF()

            Dim filename As String = ""
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim CombineFileName As String = ""
            Dim FullFileName As String = ""
            Dim filepath As String = ""
            Dim fileNames As String() = {}
            Dim SelectedCnt As Integer
            Dim SysPath As String = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()  'HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim PoFiles As New List(Of String)
            Dim PrintedReports As New List(Of String)

            Dim FramePDFTable As String = ""
            Dim User As New User

            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return "LogOut"
            Else
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If
            'end

            Dim FarmDetails As New Farm
            Dim ToEmailsForGrowerReports As String = ""

            If PrintFarmDetailedReport = 1 Then
                PrintFOBDetailedReportres = PrintGrowerFarmDetailedReport(HeaderID, Farm, FromDate, ToDate, True)
                Dim PdfAndXlsResult As String() = PrintFOBDetailedReportres.Split("*~~~~*")
                Dim Pdfresult As String = PdfAndXlsResult(0)
                Dim Xlsresult As String = PdfAndXlsResult(2)

                If Pdfresult.EndsWith(".pdf") Then
                    filepath = Pdfresult
                    ' FullFileName = SysPath & PrintShipptingLabelselectedres
                    Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    PrintedReports.Add(FullPath)

                End If

                If Xlsresult.EndsWith(".xls") Then
                    filepath = Xlsresult
                    ' FullFileName = SysPath & PrintShipptingLabelselectedres
                    Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    PrintedReports.Add(FullPath)
                End If
                SelectedCnt += 1
            End If


            If PrintFOBDetailedReport = 1 Then
                PrintFOBDetailedReportres = PrintGrowerFOBDetailedReport(HeaderID, Farm, FromDate, ToDate)

                If PrintFOBDetailedReportres.EndsWith(".pdf") Then
                    filepath = PrintFOBDetailedReportres
                    ' FullFileName = SysPath & PrintShipptingLabelselectedres
                    Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    PrintedReports.Add(FullPath)
                    'If Farm <> "0" And ToEmailsForGrowerReports <> "" Then
                    '    Logs.GrowerReportsEmailLogs(User.Email, ToEmailsForGrowerReports, FarmDetails.Name + " Farm Liquidation for date range from " + FromDate + " to " + ToDate + "", PrintFOBDetailedReportres, FarmDetails.Name + " Farm Liquidation for date range from " + FromDate + " to " + ToDate + "")
                    'End If
                End If
                SelectedCnt += 1
            End If

            If PrintConsDetailedReport = 1 Then

                PrintConsDetailedReportres = PrintGrowerConsDetailedReport(HeaderID, Farm, FromDate, ToDate)

                If PrintConsDetailedReportres.EndsWith(".pdf") Then
                    filepath = PrintConsDetailedReportres
                    ' FullFileName = SysPath & PrintShipptingLabelselectedres
                    Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    PrintedReports.Add(FullPath)
                    'If Farm <> "0" And ToEmailsForGrowerReports <> "" Then
                    '    Logs.GrowerReportsEmailLogs(User.Email, ToEmailsForGrowerReports, "", PrintConsDetailedReportres, FarmDetails.Name + " Consignment Report for date range from " + FromDate + " to " + ToDate + "")
                    'End If
                End If
                SelectedCnt += 1
            End If

            If PrintConsignmentSummary = 1 Then
                PrintConsSummaryReportres = PrintGrowerConsSummaryReport(HeaderID, Farm, FromDate, ToDate)
                If PrintConsSummaryReportres.EndsWith(".pdf") Then
                    filepath = PrintConsSummaryReportres
                    ' FullFileName = SysPath & PrintShipptingLabelselectedres
                    Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    PrintedReports.Add(FullPath)
                    'If Farm <> "0" And ToEmailsForGrowerReports <> "" Then
                    '    Logs.GrowerReportsEmailLogs(User.Email, ToEmailsForGrowerReports, "", PrintConsSummaryReportres, FarmDetails.Name + " Consignment Report for date range from " + FromDate + " to " + ToDate + "")
                    'End If
                End If
                SelectedCnt += 1
            End If

            If PrintFOBSummaryReport = 1 Then
                PrintFOBSummaryReportres = PrintGrowerFOBSummaryReport(HeaderID, Farm, FromDate, ToDate, True)
                Dim PdfAndXlsResult As String() = PrintFOBSummaryReportres.Split("*~~~~*")
                Dim Pdfresult As String = PdfAndXlsResult(0)
                Dim Xlsresult As String = PdfAndXlsResult(2)

                If Pdfresult.EndsWith(".pdf") Then
                    filepath = Pdfresult
                    ' FullFileName = SysPath & PrintShipptingLabelselectedres
                    Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    PrintedReports.Add(FullPath)

                End If

                If Xlsresult.EndsWith(".xls") Then
                    filepath = Xlsresult
                    ' FullFileName = SysPath & PrintShipptingLabelselectedres
                    Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                    PrintedReports.Add(FullPath)
                    'If Farm <> "0" And ToEmailsForGrowerReports <> "" Then
                    '    Logs.GrowerReportsEmailLogs(User.Email, ToEmailsForGrowerReports, "", Pdfresult + "," + Xlsresult, FarmDetails.Name + " Farm Liquidation for date range from " + FromDate + " to " + ToDate + "")
                    'End If
                End If
                SelectedCnt += 1
            End If

            If PrintedReports.Count = 0 Then
                Return "No reports Found"
            Else
                Return String.Join("*~*", PrintedReports.ToArray()).ToString()
            End If

            'If PrintFOBDetailedReportres.EndsWith(".pdf") Then
            '    Return filepath
            'Else
            '    Return "No Order Found"
            'End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintMultipleReportsInGrower::PageOrder")
            Return "error" + ex.Message
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintMultipleReportsInGrowerForAllFarmOption(ByVal PrintFarmDetailedReport As String, ByVal PrintFOBDetailedReport As String, ByVal PrintFOBSummaryReport As String, ByVal PrintConsDetailedReport As String,
                                                 ByVal PrintConsignmentSummary As String, ByVal HeaderID As String, ByVal FarmsList As String,
                                                 ByVal FromDate As String, ByVal ToDate As String) As ArrayList
        Try
            Dim PrintFarmDetailedReportres As String = ""
            Dim PrintFOBDetailedReportres As String = ""
            Dim PrintConsDetailedReportres As String = ""
            Dim PrintFOBSummaryReportres As String = ""
            Dim PrintConsSummaryReportres As String = ""
            'ImportGrowerCgfromDBF()

            Dim filename As String = ""
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim CombineFileName As String = ""
            Dim FullFileName As String = ""
            Dim filepath As String = ""
            Dim fileNames As String() = {}
            Dim SelectedCnt As Integer
            Dim SysPath As String = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()  'HttpContext.Current.Server.MapPath("~/" + foldername + "/")
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim PoFiles As New List(Of String)



            Dim ReportResult As New ArrayList

            Dim FramePDFTable As String = ""
            Dim User As New User

            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return Nothing
            Else
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If
            'end


            For Each Farm In FarmsList.Split(",")
                Dim PrintedReportData(2) As String
                PrintedReportData(0) = Farm
                Dim FarmEmailDetails As Farm = GrowerFarmEmails.GetGrowerFarmEmailByCode(Farm)
                If Not FarmEmailDetails Is Nothing Then
                    PrintedReportData(1) = FarmEmailDetails.Email
                Else
                    PrintedReportData(1) = ""
                End If

                If PrintFarmDetailedReport = 1 Then
                    PrintFarmDetailedReportres = PrintGrowerFarmDetailedReport(HeaderID, Farm, FromDate, ToDate, False)
                    Dim PdfAndXlsResult As String() = PrintFarmDetailedReportres.Split("*~~~~*")
                    Dim Pdfresult As String = PdfAndXlsResult(0)
                    Dim Xlsresult As String = PdfAndXlsResult(2)

                    If Pdfresult.EndsWith(".pdf") Then
                        filepath = Pdfresult
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PrintedReportData(2) = FullPath
                    End If
                    SelectedCnt += 1
                End If

                If PrintFOBDetailedReport = 1 Then
                    PrintFOBDetailedReportres = PrintGrowerFOBDetailedReport(HeaderID, Farm, FromDate, ToDate)

                    If PrintFOBDetailedReportres.EndsWith(".pdf") Then
                        filepath = PrintFOBDetailedReportres
                        ' FullFileName = SysPath & PrintShipptingLabelselectedres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PrintedReportData(2) = FullPath
                    End If
                    SelectedCnt += 1
                End If

                If PrintConsDetailedReport = 1 Then

                    PrintConsDetailedReportres = PrintGrowerConsDetailedReport(HeaderID, Farm, FromDate, ToDate)

                    If PrintConsDetailedReportres.EndsWith(".pdf") Then
                        filepath = PrintConsDetailedReportres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PrintedReportData(2) = FullPath
                    End If
                    SelectedCnt += 1
                End If

                If PrintConsignmentSummary = 1 Then
                    PrintConsSummaryReportres = PrintGrowerConsSummaryReport(HeaderID, Farm, FromDate, ToDate)
                    If PrintConsSummaryReportres.EndsWith(".pdf") Then
                        filepath = PrintConsSummaryReportres
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PrintedReportData(2) = FullPath
                    End If
                    SelectedCnt += 1
                End If

                If PrintFOBSummaryReport = 1 Then
                    PrintFOBSummaryReportres = PrintGrowerFOBSummaryReport(HeaderID, Farm, FromDate, ToDate, False)
                    Dim PdfAndXlsResult As String() = PrintFOBSummaryReportres.Split("*~~~~*")
                    Dim Pdfresult As String = PdfAndXlsResult(0)
                    Dim Xlsresult As String = PdfAndXlsResult(2)

                    If Pdfresult.EndsWith(".pdf") Then
                        filepath = Pdfresult
                        Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
                        PrintedReportData(2) = FullPath
                    End If

                    SelectedCnt += 1
                End If
                ReportResult.Add(PrintedReportData)
            Next

            If ReportResult.Count = 0 Then
                Return Nothing
            Else
                Return ReportResult
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintMultipleReportsInGrowerForAllFarms::PageOrder")
            'Return "error" + ex.Message
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerFarmEmailByCode(ByVal Farm As String) As Farm
        Try
            Return GrowerFarmEmails.GetGrowerFarmEmailByCode(Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerFarmEmailByCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintGrowerFOBDetailedReport(ByVal HeaderID As String, ByVal Farm As String, ByVal FromDate As String, ByVal ToDate As String) As String
        Try


            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "HeaderID"
            reportParameterCollection(1).Values.Add(HeaderID)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Farm"
            reportParameterCollection(2).Values.Add(Farm)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "FromDate"
            reportParameterCollection(3).Values.Add(FromDate)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ToDate"
            reportParameterCollection(4).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            Dim subject As String = ""
            If Farm <> "0" Then
                subject = CompanyName + " Grower FOB Detailed Report for " + Farm + " from " + FromDate + " to " + ToDate
                filename = "GrowerFOBDetailed" + "_" + Farm + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            Else
                subject = CompanyName + " Grower FOB Detailed Report from " + FromDate + " to " + ToDate
                filename = "GrowerFOBDetailed" + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptFOBDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Dim ReportName As String = objPdf.ExportToPdf(filename, "rptGrowerConsignmentDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Landscape, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If Not ReportName.Trim().Contains("error : ") Then
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), subject, "labelnotification")
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintGrowerFOBDetailedReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintGrowerFarmDetailedReport(ByVal HeaderID As String, ByVal Farm As String, ByVal FromDate As String, ByVal ToDate As String, ByVal ExportXlsAlso As Boolean) As String
        Try


            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "HeaderID"
            reportParameterCollection(1).Values.Add(HeaderID)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Farm"
            reportParameterCollection(2).Values.Add(Farm)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "FromDate"
            reportParameterCollection(3).Values.Add(FromDate)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ToDate"
            reportParameterCollection(4).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filenamepdf As String = ""
            Dim filenamexls As String = ""
            Dim subject As String = ""

            If Farm.Contains(",") = False Then
                subject = CompanyName + " Grower Farm Detailed Report for " + Farm + " from " + FromDate + " to " + ToDate
                filenamepdf = "GrowerFarmDetailed" + "_" + Farm + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            Else
                subject = CompanyName + " Grower Farm Detailed Report from " + FromDate + " to " + ToDate
                filenamepdf = "GrowerFarmDetailed" + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            End If

            If Farm.Contains(",") = False Then
                filenamexls = "GrowerFarmDetailed" + "_" + Farm + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".xls"
            Else
                filenamexls = "GrowerFarmDetailed" + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".xls"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""

            Dim ReportNameForPdf As String = objPdf.ExportToPdf(filenamepdf, "rptFarmDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Dim ReportNameForXls As String = ""
            If ExportXlsAlso Then
                ReportNameForXls = objPdf.ExportToPdf(filenamexls, "rptFarmDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.Excel, "BloomsReportSource")
            End If
            'Dim ReportName As String = objPdf.ExportToPdf(filename, "rptGrowerConsignmentDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Landscape, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If Not ReportNameForPdf.Trim().Contains("error : ") Then
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filenamepdf), subject, "labelnotification")
            End If
            Return ReportNameForPdf + "*~~~~*" + ReportNameForXls
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintGrowerFarmDetailedReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintGrowerFOBSummaryReport(ByVal HeaderID As String, ByVal Farm As String, ByVal FromDate As String, ByVal ToDate As String, ByVal ExportXlsAlso As Boolean) As String
        Try


            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "HeaderID"
            reportParameterCollection(1).Values.Add(HeaderID)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Farm"
            reportParameterCollection(2).Values.Add(Farm)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "FromDate"
            reportParameterCollection(3).Values.Add(FromDate)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ToDate"
            reportParameterCollection(4).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filenamepdf As String = ""
            Dim filenamexls As String = ""
            If Farm.Contains(",") = False Then
                filenamepdf = "GrowerFOBSummary" + "_" + Farm + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            Else
                filenamepdf = "GrowerFOBSummary" + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            End If
            Dim subject = ""
            If Farm.Contains(",") = False Then
                subject = CompanyName + " Grower FOB Summary Report for " + Farm + " from " + FromDate + " to " + ToDate
                filenamexls = "GrowerFOBSummary" + "_" + Farm + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".xls"
            Else
                subject = CompanyName + " Grower FOB Summary Report from " + FromDate + " to " + ToDate
                filenamexls = "GrowerFOBSummary" + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".xls"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportNameForPdf As String = objPdf.ExportToPdf(filenamepdf, "rptFOBSummary", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Dim ReportNameForXls As String = ""
            If ExportXlsAlso Then
                ReportNameForXls = objPdf.ExportToPdf(filenamexls, "rptFOBSummary", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.Excel, "BloomsReportSource")
            End If
            'Dim ReportName As String = objPdf.ExportToPdf(filename, "rptGrowerConsignmentDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Landscape, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filenamepdf), (CompanyName + " Report Printing Notification For Grower FOB Summary Report by user:" + User.Email), "labelnotification")
            If Not ReportNameForPdf.Trim().Contains("error : ") Then
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filenamepdf), subject, "labelnotification")
            End If
            Return ReportNameForPdf + "*~~~~*" + ReportNameForXls

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintGrowerFOBSummaryReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintGrowerConsDetailedReport(ByVal HeaderID As String, ByVal Farm As String, ByVal FromDate As String, ByVal ToDate As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "HeaderID"
            reportParameterCollection(1).Values.Add(HeaderID)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Farm"
            reportParameterCollection(2).Values.Add(Farm)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "FromDate"
            reportParameterCollection(3).Values.Add(FromDate)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ToDate"
            reportParameterCollection(4).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            Dim subject = ""
            If Farm <> "0" Then
                subject = CompanyName + " Grower Consignment Detailed Report for " + Farm + " from " + FromDate + " to " + ToDate
                filename = "GrowerConsDetailed" + "_" + Farm + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            Else
                subject = CompanyName + " Grower Consignment Detailed Report from " + FromDate + " to " + ToDate
                filename = "GrowerConsDetailed" + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            'Dim ReportName As String = objPdf.ExportToPdf(filename, "rptFOBDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptGrowerConsignmentDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Landscape, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Grower Consignment Detailed Report by user:" + User.Email), "labelnotification")
            If Not ReportName.Trim().Contains("error : ") Then
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), subject, "labelnotification")
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintGrowerConsDetailedReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintGrowerConsSummaryReport(ByVal HeaderID As String, ByVal Farm As String, ByVal FromDate As String, ByVal ToDate As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}


            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "HeaderID"
            reportParameterCollection(1).Values.Add(HeaderID)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Farm"
            reportParameterCollection(2).Values.Add(Farm)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "FromDate"
            reportParameterCollection(3).Values.Add(FromDate)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ToDate"
            reportParameterCollection(4).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            Dim subject As String = ""
            If Farm <> "0" Then
                subject = CompanyName + " Grower Consignment Summary Report for " + Farm + " from " + FromDate + " to " + ToDate
                filename = "GrowerConsSummary" + "_" + Farm + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            Else
                subject = CompanyName + " Grower Consignment Summary Report from " + FromDate + " to " + ToDate
                filename = "GrowerConsSummary" + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            'Dim ReportName As String = objPdf.ExportToPdf(filename, "rptFOBDetails", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptGrowerSummary", reportParameterCollection, ExportSSRS.PdfOrientation.Landscape, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Grower Consignment Summary Report by user:" + User.Email), "labelnotification")
            If Not ReportName.Trim().Contains("error : ") Then
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), subject, "labelnotification")
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintGrowerConsSummaryReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateGrowerDetailAdjustAmount(ByVal DetailID As String) As String
        Try
            Return GrowerDetails.UpdateGrowerDetailAdjustAmount(DetailID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateGrowerDetailAdjustAmount::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerInvoiceDetailsByFarm(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                            ByVal qtype As String, Filter As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype = "AWB" Then
                query = Regex.Replace(query, "[-]", "")
            End If
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(GrowerDetail), qtype, query)
            End If

            If Filter IsNot Nothing Then
                whereCondition = IIf(whereCondition <> "", whereCondition + " and " + Filter, Filter)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerDetails.GetGrowerFarmHeaderFgrd()

            Dim QSearch As String = ""
            Dim HeaderID As String = "0"
            Dim Farm As String = ""
            'If Filter <> "" Then
            '    Dim SplitFilter = Filter.Split("=")
            '    HeaderID = SplitFilter(1).ToString().Split("and")(0).ToString().Trim()
            '    Farm = SplitFilter(2).ToString().Replace("'", "")
            'End If

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                'Dim data As List(Of GrowerDetail) = obj.GetGrowerInvoiceDetailsByFarm(HeaderID,Farm)
                Dim data As List(Of GrowerDetail) = obj.GetGrowerInvoiceDetailsByFarm(whereCondition)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Farm", "AWB", "Invoice", "ReceivingDate", "InvAmount", "InvFileName"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Awb").ColumnName = "Awb"
                dt.Columns("Invoice").ColumnName = "Invoice"
                dt.Columns("ReceivingDate").ColumnName = "ReceivingDate"

                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Awb").DataType = GetType(String)

                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next

                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "$Inv")
                Return BuildXmlDoc(filepath)
            Else
                'Dim data As List(Of GrowerDetail) = obj.GetGrowerInvoiceDetailsByFarm(HeaderID,Farm)
                Dim data As List(Of GrowerDetail) = obj.GetGrowerInvoiceDetailsByFarm(whereCondition)
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID),
                                            New XElement("cell", row.Farm),
                                            New XElement("cell", FormatAWBnumber(row.Awb)),
                                            New XElement("cell", row.Invoice),
                                            New XElement("cell", row.ReceivingDate.ToString("MM/dd/yyyy")),
                                            New XElement("cell", IIf(row.InvAmount <> 0.0, row.InvAmount.ToString("N", CultureInfo.InvariantCulture), row.InvAmount)),
                                            New XElement("cell", IIf(row.DetailID <> 0, "<img style='Cursor:pointer;' id='GrowerInvoiceSelect_" & row.DetailID.ToString() & "' src='" & IIf(row.InvoiceVerified, "images/check-on.png", "images/check-off.png") & "' />", "")),
                                            New XElement("cell", String.Format("<a href='#' id='lnkGrowerInvoiceFile_" + row.DetailID.ToString() + "_" + row.Invoice + "_" + row.Awb + "' data-filename='" + IIf(Convert.ToString(row.InvFileName) = "", "Upload A File", row.InvFileName) + "' title='" + IIf(Convert.ToString(row.InvFileName) = "", "Upload A File", row.InvFileName) + "' style='cursor:pointer'>" + IIf(Convert.ToString(row.InvFileName) = "", "<img src='images/addfile.png' height='16' width='16' />", "<img src='images/editfile.png' height='16' width='16' />") + "</a>"))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Dim idx As Integer = data.Count - 1
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = "Total"
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""

                Return newDoc

            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerInvoiceDetailsByFarm::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleGrowerInvoiceSelected(ByVal Selected As String, ByVal ID As String) As String
        Try
            Return GrowerDetails.ToggleGrowerInvoiceSelected(Selected, ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleGrowerInvoiceSelected::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveInvoiceUploadFiles(ByVal DetailID As String, ByVal InvFileName As String, fileType As String) As String
        Try
            Return GrowerDetails.SaveInvoiceUploadFiles(DetailID, InvFileName, fileType)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveInvoiceUploadFiles::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveFarmUploadFiles(ByVal HeaderID As String, ByVal Farm As String, ByVal FarmFileName As String) As String
        Try
            Return GrowerDetails.SaveFarmUploadFiles(HeaderID, Farm, FarmFileName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFarmUploadFiles::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetIsGrowerDelete() As String
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If

            Dim GrowerResult As String = IIf(UserDetails.IsGrowerDelete = True, "Valid", "Invalid")
            Return GrowerResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetIsGrowerDelete::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckAndChangeGrowerLockStatusForUser(ByVal IsLocked As String, ByVal HeaderID As String) As String
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If

            If UserDetails Is Nothing Then
                Return "Logout"
            End If

            If UserDetails.IsGrowerlock = True Then
                Return GrowerHeaders.ChangeGrowerLockStatusForUser(IsLocked, HeaderID, UserDetails.ID)
            Else
                Return "Not Authorised"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckCanChangeLockStatusForGrower::PageGrower")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckGrowerReportIsAlreadyLocked(ByVal HeaderID As String) As String
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If

            If UserDetails Is Nothing Then
                Return "Logout"
            End If
            Return GrowerHeaders.CheckGrowerReportIsAlreadyLocked(HeaderID, UserDetails.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckCanChangeLockStatusForGrower::PageGrower")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerReportMailContent() As List(Of GrowerHeader)
        Try
            Dim CList As List(Of GrowerHeader) = GrowerHeaders.GetGrowerReportMailContent()
            Dim Content As String = ""
            For count = 0 To CList.Count - 1
                Content += CList(count).GrowerMailContent
            Next
            Return CList
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerReportMailContent::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ClearInvoiceNumberFortheFarmInGrowerReport(ByVal HeaderID As String, ByVal Farm As String) As String
        Try
            Return GrowerDetails.ClearInvoiceNumberFortheFarmInGrowerReport(HeaderID, Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearInvoiceNumberFortheFarmInGrowerReport::PageGrower")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetRecalculateAllExpense() As String
        Try
            Return GrowerDetails.GetRecalculateAllExpense()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetRecalculateAllExpense::PageGrower")
            Return Nothing
        End Try
    End Function

#End Region

    <System.Web.Services.WebMethod(True)>
    Public Async Function GenerateEliteEDIFiles(ByVal order As String) As Task(Of String)
        Try
            Dim OrderList() As String
            Dim result As String = String.Empty
            OrderList = order.Split(",")
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            For Each item In OrderList
                result += ">" + item + "-" + EliteService.SendAsync(item, User) + Environment.NewLine
            Next
            Return "Success~" + result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GenerateEliteEDIFiles::PageOrder")
            Return "Error~" + ex.Message
        End Try
    End Function

#Region "FloridaBeautyXML"
    <System.Web.Services.WebMethod(True)>
    Public Function GenerateFBEDIFiles(ByVal order As String) As String
        Try
            Dim OrderList() As String
            OrderList = order.Split(",")
            For Each item In OrderList
                Dim FBXml = FloridaBeautyXML.GetFloridaBeautyXMLByOrder(item)
                Dim ResponseXML = UploadFloridaBeautyARXML(FBXml.RequestXML.ToString(), FBXml.OrderNo, FBXml.AREmailIds, "1")
                InvoiceHistory.SaveInvoiceHistory(FBXml.OrderNo, "", ResponseXML.ToString(), "Manual EDI")

                FloridaBeautyXML.UpdateFloridaBeautyXMLResponse(FBXml.ID, ResponseXML.ToString())
            Next
            Return "Success~File has been uploaded"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GenerateFBEDIFiles::PageOrder")
            Return "Error~" + ex.Message
        End Try
    End Function

    ''' <summary>
    ''' MANI:12/11/2018:Get the xml from table and send the xml to upload method 
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function SendFloridaBeautyEDI(ByVal EDIDropdown As String) As Task(Of String)
        Try
            Dim FBXmlList As List(Of BO.FloridaBeautyXML) = FloridaBeautyXML.GetFloridaBeautyXML()
            If FBXmlList.Count > 0 Then
                For Each FBXml In FBXmlList
                    Dim ResponseXML = UploadFloridaBeautyARXML(FBXml.RequestXML.ToString(), FBXml.OrderNo, FBXml.AREmailIds, EDIDropdown:=EDIDropdown)
                    FloridaBeautyXML.UpdateFloridaBeautyXMLResponse(FBXml.ID, ResponseXML.ToString())
                Next
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::SendFloridaBeautyEDI::PageOrder")
            Return Nothing
        End Try
        Return Nothing
    End Function


    '<summary>
    'MANI:12/11/2018:sends the xml to flordia edi
    '</summary>
    '<returns></returns>
    Public Function UploadFloridaBeautyARXML(ByVal RequestXml As String, ByVal OrderNo As String, ByVal ToEmails As String, Optional ByVal EDIDropdown As String = "") As String
        Dim subject As String = ""
        Dim companyname As String = ""
        Dim subjectconsignee As String = ""
        Dim body As String = ""
        Dim Responsemessage As String = ""
        Dim VendorEmailPath As String = ""
        Dim shipperaccount As String = ""
        Dim consignee As String = ""
        Dim BoxNo As String = ""
        Dim tmpResponsexml As String = ""
        Dim invno As String = ""
        Dim shipdate As String = ""
        Dim datatime As String = ""
        Dim FBfilename As String = ""
        Dim subjectboxno As String = ""
        Dim TotalDetailCount As String = ""
        Dim SuccessDetailCount As String = ""
        Dim FailureDetailCount As String = ""

        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            'FB API
            Dim FBUserName As String = ConfigurationManager.AppSettings("FloridaBeautyUserName").ToString()
            Dim FBPassword As String = ConfigurationManager.AppSettings("FloridaBeautyPassword").ToString()
            Dim APIUrl As String = ConfigurationManager.AppSettings("FloridaBeautyAPIURL").ToString()

            VendorEmailPath = ConfigurationManager.AppSettings("VendorEmailsFolder") + "\XML"
            If (Not Directory.Exists(VendorEmailPath)) Then
                Directory.CreateDirectory(VendorEmailPath)
            End If
            companyname = ConfigurationManager.AppSettings("CompanyName")
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
            Dim doc As New XmlDocument()
            doc.LoadXml(RequestXml)
            Dim invoiceno As String = ""

            Dim toemail As String = ""
            Dim isSuccess As Boolean = False
            Dim emailnodeList As XmlNodeList = doc.SelectNodes("/FBFShipperEDI/EdiHeader/DFlowerEmail")
            toemail = emailnodeList.Item(0).InnerText

            Dim shipdatelist As XmlNodeList = doc.SelectNodes("/FBFShipperEDI/EdiHeader/Shipdate")
            shipdate = shipdatelist.Item(0).InnerText
            Dim invoicelist As XmlNodeList = doc.SelectNodes("/FBFShipperEDI/EdiHeader/DflowerInv")
            invoiceno = invoicelist.Item(0).InnerText
            invno = invoiceno.TrimStart(New Char() {"0"})
            invoiceno = invno
            invoiceno = "Invoice# " + invoiceno + ""

            Dim shipperlist As XmlNodeList = doc.SelectNodes("/FBFShipperEDI/EdiHeader/Shipper")
            If shipperlist.Count > 0 Then
                shipperaccount = shipperlist.Item(0).InnerText
                shipperaccount = shipperaccount + " - "
            Else
                shipperaccount = ""
            End If
            If shipperaccount Is Nothing Or shipperaccount = "" Then
                Dim content = ""
                content = "Shipper not defined"
                ArmelliniXML.InsertArmelliniXMLLogs(RequestXml, "", "", content, False, "Error", "", OrderNo, 0, 0, "", "", If(User Is Nothing, "", User.Name))
                Dim unused = Logs.SendMail(FromEmail, User.Email + ",jose@dflower.com", RequestXml, "", companyname + " - " + " FB - " + OrderNo + " - Shipper is empty")
                Return content
            End If

            'get  BoxNo 
            Dim boxnolist As XmlNodeList = doc.SelectNodes("/FBFShipperEDI/EdiDetail/BoxNo")
            If boxnolist.Count > 0 Then
                BoxNo = boxnolist.Item(0).InnerText
                subjectboxno = "Box# " + BoxNo
            Else
                BoxNo = ""
                subjectboxno = ""
            End If

            'get  consignee 
            Dim dsconsignee As New DataSet()
            Dim dtconsignee As New DataTable()
            Dim dtconsdistinct As New DataTable()
            Dim XmlReader = New XmlNodeReader(doc)
            dsconsignee.ReadXml(XmlReader)
            If (dsconsignee.Tables.Contains("EdiDetail")) Then

                dtconsignee = dsconsignee.Tables("EdiDetail")
                If (dtconsignee.Rows.Count > 0 And dtconsignee.Columns.Contains("Consignee")) Then 'single consignee

                    dtconsdistinct = dtconsignee.DefaultView.ToTable(True, "Consignee")
                    If (dtconsdistinct.Rows.Count = 1) Then
                        subjectconsignee = "Consignee: " + dtconsdistinct.Rows(0)("Consignee") + " "
                        consignee = dtconsdistinct.Rows(0)("Consignee").ToString()
                    ElseIf (dtconsdistinct.Rows.Count > 1) Then 'multiple consignee

                        subjectconsignee = "Consignee: " + dtconsdistinct.Rows(0)("Consignee") + " + Others"
                        consignee = dtconsdistinct.Rows(0)("Consignee").ToString()
                    End If
                Else
                    consignee = ""
                    subjectconsignee = ""
                End If

            Else
                consignee = ""
                subjectconsignee = ""

            End If
            If consignee Is Nothing Or consignee = "" Then
                Dim content = ""
                content = "Missing Consignee"
                FloridaBeautyXML.InsertFloridaBeautyXMLLogs(RequestXml, "", "", content, False, "Error", "", OrderNo, 0, 0, "", "")
                Dim unused1 = Logs.SendMail(FromEmail, User.Email + ",jose@dflower.com", "", RequestXml, companyname + " - " + " Order# " + OrderNo + " Florida Beauty - Consignee is empty")
                Return content
            End If

            Dim finvoice As String = ""
            If (invno.Trim().Length < 7) Then
                finvoice = invno.Trim().PadLeft(7, "0")
            Else
                finvoice = invno.Trim()
            End If

            'Dim myUri = New Uri(APIUrl)

            Dim webRequest As HttpWebRequest = CType(webRequest.Create(APIUrl), HttpWebRequest)
            webRequest.Headers.Add("fbf_auth_username", FBUserName)
            webRequest.Headers.Add("fbf_auth_password", FBPassword)
            webRequest.ContentType = "text/xml;charset=""utf-8"""""
            webRequest.Accept = "text/xml"
            webRequest.Method = "POST"

            'webRequest.Timeout = 4000
            Dim ResponseXML As String = ""

            Dim bytes As Byte() = Encoding.UTF8.GetBytes(RequestXml)

            Dim requeststream As Stream = webRequest.GetRequestStream()
            requeststream.Write(bytes, 0, bytes.Length)
            requeststream.Close()


            Dim myWebResponse = CType(webRequest.GetResponse(), HttpWebResponse)

            Dim myStreamReader = New StreamReader(myWebResponse.GetResponseStream())
            ResponseXML = myStreamReader.ReadToEnd
            myStreamReader.Close()



            'If (responsestream Is Nothing) Then
            '    Throw New InvalidOperationException("responseStream is null")
            'End If

            'ResponseXML = ProcessStream(responsestream)




            'if response Msg has Error msg other than successful then send email to AREmailIds(1.SalespersonEmail.2.ARNotification in Email screen set to true)
            If ResponseXML.Contains("<FbfShipperEDI_Result>") Then
                Dim responsedoc As XmlDocument = New XmlDocument()
                responsedoc.LoadXml(ResponseXML) '
                'Dim errheader As XmlNodeList = responsedoc.SelectNodes("/AELShipmentErrors/ErrorHeader/ERROR_MSG")  'get failure message
                'Dim errdetails As XmlNodeList = responsedoc.SelectNodes("/AELShipmentErrors/ErrorDetail/ERROR_MSG")  'get  success message

                Dim xmlTotalDetailCount As XmlNodeList = responsedoc.SelectNodes("/FbfShipperEDI_Result/EdiHeader/TotalDetailCount")


                If (xmlTotalDetailCount.Count > 0) Then
                    TotalDetailCount = xmlTotalDetailCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim()
                End If

                Dim xmlSuccessDetailCount As XmlNodeList = responsedoc.SelectNodes("/FbfShipperEDI_Result/EdiHeader/SuccessDetailCount")


                If (xmlSuccessDetailCount.Count > 0) Then
                    SuccessDetailCount = xmlSuccessDetailCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim()
                End If

                Dim xmlFailureDetailCount As XmlNodeList = responsedoc.SelectNodes("/FbfShipperEDI_Result/EdiHeader/FailureDetailCount")


                If (xmlFailureDetailCount.Count > 0) Then
                    FailureDetailCount = xmlFailureDetailCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim()
                End If


                Dim Errdetails As XmlNodeList = responsedoc.SelectNodes("/FbfShipperEDI_Result/EdiDetailError/ErrorMsg")

                If Errdetails.Count = 0 Then
                    isSuccess = True
                    datatime = DateTime.Now.ToString(" MM-dd-yy hh mm ss")
                    FBfilename = "I" + finvoice + datatime + " Florida Beauty.xml"
                    Responsemessage = String.Format("Successfully Uploaded {0} of {1} Boxes", SuccessDetailCount, TotalDetailCount)
                    InvoiceHistory.SaveInvoiceHistory(OrderNo, "", Responsemessage, User.UserName)
                    Try
                        'obj.CreateArmelliniXMLFile(RequestXml, FBfilename, True)
                    Catch ex As Exception
                        AppendLog(ex.Message, "UploadFloridaBeautyARXML")
                    End Try
                Else
                    isSuccess = False
                    datatime = DateTime.Now.ToString(" MM-dd-yy hh mm ss")
                    FBfilename = "I" + finvoice + datatime + " Florida Beauty.xml"
                    Responsemessage = Errdetails.Item(0).InnerText.Replace(vbLf, "")
                    InvoiceHistory.SaveInvoiceHistory(OrderNo, "", Responsemessage, User.UserName)
                    Logs.SendMail(User.Email, "jose@dflower.com", ResponseXML, "", companyname + " " + Responsemessage)
                    Try
                        'obj.CreateArmelliniXMLFile(RequestXml, FBfilename, False)
                    Catch ex As Exception
                        AppendLog(ex.Message, "UploadFloridaBeautyARXML")
                    End Try
                End If



                If isSuccess Then 'check success 

                    Dim XMLFileName As String = "FBXML_" + OrderNo + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".XML"

                    Dim filepath As String = VendorEmailPath & "\" & XMLFileName
                    Dim FloridaXmlFolder As String = ConfigurationManager.AppSettings("ArmelliniXMLEmailsFolder")
                    Dim CarrierEmailxmlNameFolderName As String = ConfigurationManager.AppSettings("FloridaXML")
                    Dim Carrierfilepath As String = FloridaXmlFolder + "\" + CarrierEmailxmlNameFolderName + "\" + XMLFileName
                    If File.Exists(filepath) Then
                        File.WriteAllText(filepath, "")
                        Using writer As New StreamWriter(filepath, True)
                            writer.WriteLine(RequestXml)
                        End Using
                    Else
                        Dim writer As StreamWriter = File.CreateText(filepath)
                        writer.WriteLine(RequestXml)
                        writer.Close()
                    End If
                    If (EDIDropdown = "1") Then
                        Try
                            File.Copy(filepath, Carrierfilepath)
                        Catch ex As Exception
                        End Try
                    End If

                    Dim canSendAllArmelliniEmails As Boolean = If(ConfigurationManager.AppSettings("SendAllArmelliniEmails").ToString() = "1", True, False)
                    If canSendAllArmelliniEmails Then
                        subject = shipperaccount + companyname + " FBEDI " + invoiceno + "  " + shipdate + "  " + subjectconsignee + "  " + Responsemessage + "  " + subjectboxno
                        Logs.ManualPOEmailLogs(VendorFromEmails, toemail, vbCrLf + vbCrLf + "--From web", XMLFileName, subject)

                        If (EDIDropdown = "1") Then
                            Logs.ManualPOEmailLogs(FromEmail, User.Email, vbCrLf + vbCrLf + "--From web", XMLFileName, subject)
                        End If
                    End If

                    Try
                        'inserting the response message in the history file for the order
                        'obj.InsertLogInHistoryFileForARXML(OrderNo, "FBEDI From Web - " + Responsemessage, IIf(User Is Nothing, "", User.Name)) '

                    Catch ex As Exception

                    End Try
                    FloridaBeautyXML.InsertFloridaBeautyXMLLogs(RequestXml, FBfilename, ResponseXML, Responsemessage, True, "Success", shipdate, invno, TotalDetailCount, SuccessDetailCount, consignee, BoxNo)

                Else 'check  failure
                    Dim XMLFileName As String = "FBXML_" + OrderNo + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".XML"

                    Dim filepath As String = VendorEmailPath & "\" & XMLFileName
                    Dim FloridaXmlFolder As String = ConfigurationManager.AppSettings("ArmelliniXMLEmailsFolder")
                    Dim CarrierEmailxmlNameFolderName As String = ConfigurationManager.AppSettings("FloridaXML")
                    Dim Carrierfilepath As String = FloridaXmlFolder + "\" + CarrierEmailxmlNameFolderName + "\" + XMLFileName
                    If File.Exists(filepath) Then
                        File.WriteAllText(filepath, "")
                        Using writer As New StreamWriter(filepath, True)
                            writer.WriteLine(RequestXml)
                        End Using

                    Else
                        Dim writer As StreamWriter = File.CreateText(filepath)
                        writer.WriteLine(RequestXml)
                        writer.Close()
                    End If
                    If (EDIDropdown = "1") Then
                        Try
                            File.Copy(filepath, Carrierfilepath)
                        Catch ex As Exception
                        End Try
                    End If

                    subject = shipperaccount + companyname + " FBXML " + invoiceno + "  " + shipdate + "  " + subjectconsignee + "  " + Responsemessage + "  " + subjectboxno
                    subject = subject.Replace("\n", "")
                    Logs.ManualPOEmailLogs(VendorFromEmails, toemail, ResponseXML + vbCrLf + vbCrLf + "--From web", XMLFileName, subject)
                    If (EDIDropdown = "1") Then
                        Logs.ManualPOEmailLogs(FromEmail, User.Email, vbCrLf + vbCrLf + "--From web", XMLFileName, subject)
                    End If

                    FloridaBeautyXML.InsertFloridaBeautyXMLLogs(RequestXml, FBfilename, ResponseXML, Responsemessage, False, "Error", shipdate, invno, TotalDetailCount, SuccessDetailCount, consignee, BoxNo)
                    Try
                        'inserting the response message in the history file for the order
                        'objDbfservice.InsertLogInHistoryFileForARXML(OrderNo, "FBEDI From Web - " + Responsemessage, IIf(User Is Nothing, "", User.Name))
                    Catch ex As Exception

                    End Try
                End If
            Else 'response not proper xml format 

                Dim XMLFileName As String = "FBXML_" + OrderNo + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".XML"
                Dim filepath As String = VendorEmailPath & "\" & XMLFileName
                Dim FloridaXmlFolder As String = ConfigurationManager.AppSettings("ArmelliniXMLEmailsFolder")
                Dim CarrierEmailxmlNameFolderName As String = ConfigurationManager.AppSettings("FloridaXML")
                Dim Carrierfilepath As String = FloridaXmlFolder + "\" + CarrierEmailxmlNameFolderName + "\" + XMLFileName
                If File.Exists(filepath) Then
                    File.WriteAllText(filepath, "")
                    Using writer As New StreamWriter(filepath, True)
                        writer.WriteLine(RequestXml)
                    End Using

                Else
                    Dim writer As StreamWriter = File.CreateText(filepath)
                    writer.WriteLine(RequestXml)
                    writer.Close()
                End If
                If (EDIDropdown = "1") Then
                    Try
                        File.Copy(filepath, Carrierfilepath)
                    Catch ex As Exception
                    End Try
                End If

                isSuccess = False
                datatime = DateTime.Now.ToString(" MM-dd-yy hh mm ss")
                FBfilename = "I" + finvoice + datatime + " Florida Beauty.xml"
                Try
                    'objDbfService.CreateArmelliniXMLFile(RequestXml, FBfilename, False)
                Catch ex As Exception
                    AppendLog(ex.Message, "UploadFloridaBeautyARXML")
                End Try


                subject = shipperaccount + companyname + " FBXML " + invoiceno + "  " + shipdate + "  " + subjectconsignee + "  " + ResponseXML + "  " + subjectboxno
                body = ResponseXML.ToString()
                subject = subject.Replace("\n", "")
                FloridaBeautyXML.InsertFloridaBeautyXMLLogs(RequestXml, FBfilename, ResponseXML, ResponseXML, False, "Error", shipdate, invno, 0, 0, consignee, BoxNo)
                Try
                    'inserting the response message in the history file for the order
                    'objDbfSercice.InsertLogInHistoryFileForARXML(OrderNo, "FBEDI From Web -  " + ResponseXML, IIf(User Is Nothing, "", User.Name))
                Catch ex As Exception

                End Try

                Logs.ManualPOEmailLogs(VendorFromEmails, toemail, body + vbCrLf + vbCrLf + "--From web", XMLFileName, subject)
                If (EDIDropdown = "1") Then
                    Logs.ManualPOEmailLogs(FromEmail, User.Email, vbCrLf + vbCrLf + "--From web", XMLFileName, subject)
                End If

            End If

            Return ResponseXML
        Catch ex As Exception

            'FloridaBeautyXML.InsertFloridaBeautyXMLLogs(RequestXml, "", "", ex.Message.Substring(0, 127), False, "Exception", shipdate, invno, 0, 0, consignee, BoxNo)
            FloridaBeautyXML.InsertFloridaBeautyXMLLogs(RequestXml, "", "", ex.Message.ToString(), False, "Exception", shipdate, invno, 0, 0, consignee, BoxNo)


            ErrorLogs.LogException(ex, "Error In Service::UploadFBXML::PageOrder")
            If ex.Message.Contains("Invalid use") Then
                Return "Invalid username or password"
            Else
                Return "error:" + ex.Message
            End If
        End Try
    End Function

#End Region


#Region "ARXML"

    <System.Web.Services.WebMethod(True)>
    Public Function SendARXML(ByVal ARServiceUserName As String, ByVal ARServicePassword As String, ByVal EDIDropdown As String) As String
        Try
            Dim SetNewArmellini As Boolean = IIf(ConfigurationManager.AppSettings("SetNewArmellini").ToString() = "1", True, False)
            Dim ARXmlList As List(Of BO.ArmelliniXML) = ArmelliniXML.GetArmelliniXML()

            If ARXmlList.Count > 0 Then
                'If SetNewArmellini Then
                For Each ARXml In ARXmlList
                    Dim ResponseXML = ArXML1(ARXml.RequestXML.ToString(), ARXml.OrderNo)
                    ArmelliniXML.UpdateArmelliniXMLResponse(ARXml.ID, ResponseXML)
                Next
                'Else
                '    For Each ARXml In ARXmlList
                '        Dim ResponseXML = UploadARXML(ARXml.RequestXML.ToString(), ARServiceUserName, ARServicePassword, ARXml.OrderNo, ARXml.AREmailIds, EDIDropdown:=EDIDropdown)
                '        ArmelliniXML.UpdateArmelliniXMLResponse(ARXml.ID, ResponseXML)
                '    Next
                'End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::SendARXML::PageOrder")
            Return Nothing
        End Try
        Return Nothing
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARXMLListForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ArmelliniXML.GetArmelliniXMLDetails
            Dim data As List(Of BO.ArmelliniXML) = obj.GetARXMLListForFgrd(whereCondition, sortExp, start, rp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", Convert.ToString(row.CreatedDateTime)),
                                        New XElement("cell", row.CreatedUserName),
                                        New XElement("cell", row.OrderNo),
                                        New XElement("cell", "<a href='#' id='Res_" + row.ID.ToString() + "'>ResponseXML</a>"),
                                        New XElement("cell", IIf(row.IsSent, "Success", "Failure"))))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARXMLListForFgrd")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetArmelliniXMLByID(ByVal ID As String) As BO.ArmelliniXML
        Try
            Dim ARXmlList As BO.ArmelliniXML = ArmelliniXML.GetArmelliniXMLByID(ID)
            Return ARXmlList
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::GetArmelliniXMLByID::PageARXML")
            Return Nothing
        End Try
    End Function


#End Region

#Region "Types"
    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportCategoryfromDBF() As String
    '    Try
    '        Dim ListOfCategories = obj.LoadCategories()
    '        If ListOfCategories.Length > 0 Then

    '            If ListOfCategories(0).ErrorMessage = "" Then
    '                Dim CategoryList = New XElement("CategoryDetails",
    '                From TypeObj In ListOfCategories
    '                Select New XElement("Types", "",
    '                New XElement("TYPE", TypeObj.TYPE),
    '                New XElement("NAME", TypeObj.NAME),
    '                New XElement("GLCONSIG", TypeObj.GLCONSIG),
    '                New XElement("GLNONCONS", TypeObj.GLNONCONS),
    '                New XElement("PERCENT1", TypeObj.PERCENT1),
    '                New XElement("PERCENT2", TypeObj.PERCENT2),
    '                New XElement("PERCENT0", TypeObj.PERCENT0),
    '                New XElement("SOLDAS", TypeObj.SOLDAS),
    '                New XElement("DAYS", TypeObj.DAYS),
    '                    New XElement("UNITS", TypeObj.UNITS)))
    '                Return Types.SaveCategories(CategoryList.ToString())
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.VendorEmailLogs(User, ListOfCategories(0).ErrorMessage, "", "Error Notification", "error")
    '                Return ListOfCategories(0).ErrorMessage
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportCategoryfromDBF::PageFlowers")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetProdCatDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Types
            Dim data As List(Of BO.Types) = obj.GetProdCatListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"TYPE", "NAME", "Markups", "UnitsDays"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("NAME").ColumnName = "Product Name"
                dt.Columns("UnitsDays").ColumnName = "/Units/Days"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "DutyDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID.ToString()),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteProdCat_" & row.ID.ToString() & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditProdCat_" & row.ID.ToString() & "'/>"),
                                        New XElement("cell", Convert.ToString(row.TYPE)),
                                        New XElement("cell", row.NAME),
                                        New XElement("cell", row.MainType),
                                        New XElement("cell", row.Markups),
                                        New XElement("cell", row.UnitsDays)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetProdCatDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetProdCatDetailByID(ByVal ID As Integer) As List(Of BO.Types)
        Try
            Dim HostName = GetHostName()
            Dim data As List(Of BO.Types) = DAO.Types.GetProdCatDetailByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetProdCatDetailByID::PageProdCat")
            Throw ex
        End Try
    End Function

    Public Function GetHostName() As String
        Dim HostName As String
        HostName = System.Net.Dns.GetHostName
        Return HostName

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveProdCat(ByVal ID As String, ByVal ProdCatType As String, ByVal ProdCatName As String, ByVal Soldas As String, ByVal Units As Integer,
    ByVal Days As Integer, ByVal Percent0 As Integer, ByVal Percent1 As Integer, ByVal Percent2 As Integer, ByVal MinPrice As Decimal, ByVal MaxPrice As Decimal, ByVal MainType As String) As String
        Try
            Dim ProdCatID As String = ""

            If (ID = "0") Then
                ProdCatID = DAO.Types.InsertProdCat(ProdCatType, ProdCatName, Soldas, Units, Days, Percent0, Percent1, Percent2, MinPrice, MaxPrice, MainType)
            Else

                DAO.Types.UpdateProdCat(ID, ProdCatType, ProdCatName, Soldas, Units, Days, Percent0, Percent1, Percent2, MinPrice, MaxPrice, MainType)
                ProdCatID = Convert.ToInt32(ID)
            End If
            If (Not ProdCatType.Contains("UNIQUE KEY constraint")) Then
                Return ProdCatID
            Else
                Return ProdCatID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveProdCat::PageProdCat")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteProdCatbyID(ByVal ID As String) As String
        Try
            Return DAO.Types.DeleteProdCatbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteProdCatbyID::PageProdCat")
            Return Nothing
        End Try
    End Function

#End Region

#Region "GrowerDetailNotes"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerNotesByDetailIDForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                            ByVal qtype As String, GrowerDetailID As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""



            If GrowerDetailID IsNot Nothing Then
                whereCondition = "GrowerDetailID =" + GrowerDetailID + ""
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerDetailNotes.GetGrowerDetailNotesFgrd
            If (ExportCSV <> "") Then
                'Dim splitExportcsv = ExportCSV.Split("|")
                'Dim data As List(Of GrowerDetail) = obj.GetGrowerFarmDetailForFgrd(whereCondition, sortExp, start, splitExportcsv(2))

                'Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                'Dim selectedColumns As String() =
                '    {"Farm", "FlowerName", "Boxes", "Units", "UOM", "FBE", "Origross", "Gross", "Boxnum", "Invoice", "Notes", "FOB", "ReceivingDate", "Awb", "Type", "BoxCharge", "Adjust", "Freight", "Duties", "Fuel", "Fumigation",
                '     "Other", "Commission", "Packing", "Handling", "Cost", "Tax1", "Tax2", "Tax3", "FuelPaid", "Boxes_rec"}

                'Dim dt As DataTable = New DataView(dt1).ToTable()
                'dt.Columns("Awb").ColumnName = "Awb"
                'dt.Columns("Boxes").ColumnName = "Boxes"
                'dt.Columns("FBE").ColumnName = "FBE"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                'Dim dtCloned As DataTable = dt.Clone()
                'dtCloned.Columns("Awb").DataType = GetType(String)
                'For Each row As DataRow In dt.Rows
                '    dtCloned.ImportRow(row)
                'Next
                'Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                'Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of GrowerDetailNote) = obj.GetGrowerNotesByDetailIDForFgrd(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.NotesID),
                                            New XElement("cell", "<b><a href='#' id='deleteGrowerDetailNotes_" & row.NotesID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                            New XElement("cell", "<b><a href='#' id='editNotes_" & row.NotesID & "'><img src='images/Edit.png'/></a></b>"),
                                            New XElement("cell", row.Notes),
                                            New XElement("cell", row.Amount)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Errosr in Service::GetGrowerNotesByDetailIDForFgrd::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
        Return Nothing
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function SaveGrowerNotesByDetailID(ByVal GrowerDetailID As String, ByVal NoteNo As String, ByVal Notes As String, ByVal Amount As String) As String
        Try
            Return GrowerDetailNotes.SaveGrowerNotesByDetailID(GrowerDetailID, NoteNo, HttpUtility.UrlDecode(Notes, System.Text.Encoding.Default), Amount)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveGrowerNotesByDetailID::PageGrower")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function UpdateGrowerNotesByNoteID(ByVal NoteID As String, ByVal NoteNo As String, ByVal Notes As String, ByVal Amount As String) As String
        Try
            Return GrowerDetailNotes.UpdateGrowerNotesByNoteID(NoteID, NoteNo, HttpUtility.UrlDecode(Notes, System.Text.Encoding.Default), Amount)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateGrowerNotesByNoteID::PageGrower")
            Return Nothing
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function DeleteGrowerNotesByID(ByVal ID As String) As String
        Try
            Return GrowerDetailNotes.DeleteGrowerNotesByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteGrowerNotesByID::PageGrower")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerNotesByNoteID(ByVal NoteID As String) As GrowerDetailNote
        Try
            Return GrowerDetailNotes.GetGrowerNotesByNoteID(NoteID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerNotesByNoteID::PageGrower")
            Return Nothing
        End Try
    End Function

#End Region

#Region "GrowCg"

    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportGrowerCgfromDBF() As String
    '    Try
    '        Dim ListOfGrowerCg = obj.LoadGrowerCg()
    '        If ListOfGrowerCg.Length > 0 Then
    '            If ListOfGrowerCg(0).ErrorMessage = "" Then
    '                Dim GrowerCgList = New XElement("GrowerCgs",
    '                From TypeObj In ListOfGrowerCg
    '                Select New XElement("GrowerCg", "",
    '                New XElement("FARM", TypeObj.Farm),
    '                New XElement("PERIOD", TypeObj.Period),
    '                New XElement("Reason", TypeObj.Reason),
    '                New XElement("Amount", TypeObj.Amount)))
    '                Return GrowerDetails.SaveGrowerCgList(GrowerCgList.ToString())
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, ListOfGrowerCg(0).ErrorMessage, "", "Error Notification", "error")
    '                Return ListOfGrowerCg(0).ErrorMessage
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportGrowerCgfromDBF::PageGrower")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerCgForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                          ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try



            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(GrowerCg), qtype, query)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerCgs.GetGrowerCgFgrd
            If (ExportCSV <> "") Then
                'Dim splitExportcsv = ExportCSV.Split("|")
                'Dim data As List(Of GrowerDetail) = obj.GetGrowerFarmDetailForFgrd(whereCondition, sortExp, start, splitExportcsv(2))

                'Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                'Dim selectedColumns As String() =
                '    {"Farm", "FlowerName", "Boxes", "Units", "UOM", "FBE", "Origross", "Gross", "Boxnum", "Invoice", "Notes", "FOB", "ReceivingDate", "Awb", "Type", "BoxCharge", "Adjust", "Freight", "Duties", "Fuel", "Fumigation",
                '     "Other", "Commission", "Packing", "Handling", "Cost", "Tax1", "Tax2", "Tax3", "FuelPaid", "Boxes_rec"}

                'Dim dt As DataTable = New DataView(dt1).ToTable()
                'dt.Columns("Awb").ColumnName = "Awb"
                'dt.Columns("Boxes").ColumnName = "Boxes"
                'dt.Columns("FBE").ColumnName = "FBE"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                'Dim dtCloned As DataTable = dt.Clone()
                'dtCloned.Columns("Awb").DataType = GetType(String)
                'For Each row As DataRow In dt.Rows
                '    dtCloned.ImportRow(row)
                'Next
                'Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                'Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of GrowerCg) = obj.GetGrowerCgForFgrd(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                            New XElement("cell", "<b><a href='#' id='deleteGrowCg_" & row.ID & "'><img src='images/delete-icon.png'/></a></b>"),
                                            New XElement("cell", "<b><a href='#' id='editGrowCg_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                            New XElement("cell", row.Farm),
                                            New XElement("cell", row.Period),
                                            New XElement("cell", row.Reason),
                                            New XElement("cell", row.Amount)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerCgForFgrd::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
        Return Nothing
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetExpenses(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String) As XmlDocument
        Try


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1
            Dim obj As New GrowerCgs.GetExpensesFgrd
            Dim data As List(Of Expenses) = obj.GetExpenses()
            If data Is Nothing Or data.Count = 0 Then
                Return BuildFlexiGridError("No data found. Please enter some expenses")
            End If


            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", obj.TotalRows.ToString()),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                            New XElement("cell", "<b><a href='#' id='deleteExpense_" & row.ID & "'><img src='images/delete-icon.png'/></a></b>"),
                                            New XElement("cell", "<b><a href='#' id='editExpense_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                            New XElement("cell", row.AWB),
                                            New XElement("cell", row.Farm),
                                            New XElement("cell", row.DATEExp),
                                            New XElement("cell", row.INVOICE),
                                            New XElement("cell", row.BOXES),
                                            New XElement("cell", row.FREIGHT),
                                            New XElement("cell", Format(Math.Round(IIf(row.BOXES = 0, 0, (row.FREIGHT / row.BOXES)), 2), "0.00")),
                                            New XElement("cell", Format(Math.Round(IIf(row.BOXES = 0, 0, (row.HANDLING * row.BOXES)), 2), "0.00")),
                                            New XElement("cell", row.HANDLING),
                                            New XElement("cell", row.FUMIGATION),
                                            New XElement("cell", row.OTHERCHARGES),
                                            New XElement("cell", row.Amount)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(Convert.ToString(xmlDoc))
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetExpenses::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAWBListForExpenses() As List(Of AWBs)
        Try
            Return GrowerCgs.GetAWBListForExpenses()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAWBListForExpenses::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmByAWB(ByVal AWB As String) As List(Of Expenses)
        Try
            Return GrowerCgs.GetFarmByAWB(AWB)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmByAWB::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFbeByAWB(ByVal AWB As String, ByVal Farm As String) As String
        Try
            Return GrowerCgs.GetFbeByAWB(AWB, Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmByAWB::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetExpenseByID(ByVal ID As String) As Expenses
        Try
            Return GrowerCgs.GetExpenseByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAWBListForExpenses::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveOrUpdateExpense(ByVal ID As String, ByVal AWB As String, ByVal FARM As String, ByVal INVOICE As String, ByVal ENTRYNUM As String, ByVal DATEexp As String, ByVal FREIGHT As String, ByVal BOXES As String, ByVal FUMIGATION As String, ByVal OTHERCHARGES As String, ByVal HANDLING As String) As String
        Try
            If ID = "" Then
                ID = "0"
            End If
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Return GrowerCgs.SaveOrUpdateExpense(ID, AWB, FARM, INVOICE, ENTRYNUM, DATEexp, FREIGHT, BOXES, FUMIGATION, OTHERCHARGES, HANDLING, User.UserName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateGrowerCg::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteExpense(ByVal ID As String) As String
        Try
            Return GrowerCgs.DeleteExpense(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteExpense::PageGrower")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerCgDetailsyID(ID As String) As GrowerCg
        Try
            Users.GetUserByID(ID)

            Return GrowerCgs.GetGrowerCgDetailsyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerCgDetailsyID::PageGrower")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function UpdateGrowerCg(ByVal ID As String, ByVal Farm As String, ByVal GrDate As String,
                       ByVal Reason As String, ByVal Amount As String) As String
        Try
            Return GrowerCgs.UpdateGrowerCg(ID, Farm.ToUpper(), GrDate, Reason.ToUpper(), Amount)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateGrowerCg::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveGrowerCg(ByVal Farm As String, ByVal GrDate As String,
                     ByVal Reason As String, ByVal Amount As String) As String
        Try
            Return GrowerCgs.SaveGrowerCg(Farm.ToUpper(), GrDate, Reason.ToUpper(), Amount)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateGrowerCg::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteGrowerCg(ByVal ID As String) As String
        Try
            Return GrowerCgs.DeleteGrowerCg(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteGrowerCg::PageGrower")
            Return Nothing
        End Try
    End Function


#End Region

#Region "FarmEmail"
    <System.Web.Services.WebMethod(True)>
    Public Function ImportFarmEmailfromDBF() As String
        Try

            Return GrowerFarmEmails.SaveFarmEmailList()

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ImportFarmEmailfromDBF::PageGrower")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGrowerFarmEmailForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String,
                                          ByVal qtype As String, ByVal ExportCSV As String, ByVal HeaderID As String) As XmlDocument
        Try


            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Farm), qtype, query)
            End If

            If HeaderID = "0" Or HeaderID = "" Or HeaderID Is Nothing Then
                HeaderID = "0"
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New GrowerFarmEmails.GetGrowerFarmEmailFgrd
            If (ExportCSV <> "") Then





                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of Farm) = obj.GetGrowerFarmEmailForFgrd(whereCondition, HeaderID, sortExp, start, rp)
                Dim dt1 As DataTable
                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Farm", "Name", "Email"}
                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of Farm) = obj.GetGrowerFarmEmailForFgrd(whereCondition, HeaderID, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<b><a href='#' id='deleteGrowFarmEmail_" & row.ID & "'><img src='images/delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<b><a href='#' id='editGrowFarmEmail_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.Farm),
                                        New XElement("cell", "<a id='GrowerFarmEmails_" & row.ID.ToString() & "'>" + row.Email + "</href>"),
                                        New XElement("cell", row.FOB),
                                        New XElement("cell", row.City),
                                        New XElement("cell", row.Country),
                                        New XElement("cell", row.Name)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerFarmEmailForFgrd::PageGrower")
            Return BuildFlexiGridError(ex.Message)
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveGrowerFarmEmail(ByVal Farm As String, ByVal Email As String) As String
        Try
            Return GrowerFarmEmails.SaveGrowerFarmEmail(Farm.ToUpper(), Email)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveGrowerFarmEmail::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateGrowerFarmEmail(ByVal ID As String, ByVal Farm As String, ByVal Email As String) As String
        Try
            Return GrowerFarmEmails.UpdateGrowerFarmEmail(ID, Farm.ToUpper(), Email)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateGrowerFarmEmail::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetGrowerFarmEmailDetailsByID(ID As String) As GrowerFarmEmail
        Try
            'Users.GetUserByID(ID)

            Return GrowerFarmEmails.GetGrowerFarmEmailDetailsByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGrowerFarmEmailDetailsByID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteGrowerFarmEmail(ByVal ID As String) As String
        Try
            Return GrowerFarmEmails.DeleteGrowerFarmEmail(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteGrowerCg::PageGrower")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Approve"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPendingRecordsToApprove(ByVal Approved As String) As Object
        Try
            Dim result = ""
            Dim objPriceApproval As New PriceApproval
            Dim dt As DataTable = objPriceApproval.GetPendingRecordsToApprove()

            If dt.Rows.Count > 0 Then
                Dim TotalRowCount As Integer = dt.Rows.Count

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", "1"),
                                            New XElement("total", TotalRowCount),
                                            From row In dt.Rows()
                                            Select
                                                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                                                New XElement("cell", row("CUSTOMER")),
                                                New XElement("cell", row("NAME")),
                                                New XElement("cell", row("AWB")),
                                                New XElement("cell", Convert.ToDateTime(row("DATEREC")).ToString("MM/dd/yyyy")),
                                                New XElement("cell", row("FLOWER")),
                                                New XElement("cell", row("FARM")),
                                                New XElement("cell", ("<div style='padding-bottom: 3px; background-color: " + Convert.ToString(row("BGCOLOR")) + "; color: " + Convert.ToString(row("FONTCOLOR")) + ";' class='flowerDescription'>" + Convert.ToString(row("DESC")) + "</div>")),
                                                New XElement("cell", row("COLORCODE")),
                                                New XElement("cell", row("PRICE")),
                                                New XElement("cell", row("MARKET")),
                                                New XElement("cell", row("COST")),
                                                New XElement("cell", row("BOXES")),
                                                New XElement("cell", row("CSHAND")),
                                                New XElement("cell", row("UNITS")),
                                                New XElement("cell", row("UOM")),
                                                New XElement("cell", Convert.ToDateTime(row("TRANSDATE")).ToString("MM/dd/yyyy hh:mm tt")),
                                                New XElement("cell", row("ASKEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("ASKEDDATE")).ToString("MM/dd/yyyy hh:mm tt")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Return newDoc
            End If

            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingRecordsToApprove::PageApprove")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPendingRecordsCount() As String
        Try
            Dim objPriceApproval As New PriceApproval
            Dim dt As DataTable = objPriceApproval.GetPendingRecordsToApprove()

            Return dt.Rows.Count.ToString()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingRecordsCount::PageApprove")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetApprovedRecordsToday() As Object
        Try
            Dim result = ""
            Dim Filter = "Today"
            Dim objPriceApproval As New PriceApproval
            Dim dt As DataTable = objPriceApproval.GetApprovedRecords(Filter)

            If dt.Rows.Count > 0 Then
                Dim TotalRowCount As Integer = dt.Rows.Count

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", "1"),
                                            New XElement("total", TotalRowCount),
                                            From row In dt.Rows()
                                            Select
                                                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                                                New XElement("cell", row("CUSTOMER")),
                                                New XElement("cell", row("NAME")),
                                                New XElement("cell", row("AWB")),
                                                New XElement("cell", Convert.ToDateTime(row("DATEREC")).ToString("MM/dd/yyyy")),
                                                New XElement("cell", row("FLOWER")),
                                                New XElement("cell", row("FARM")),
                                                New XElement("cell", ("<div style='padding-bottom: 3px; background-color: " + Convert.ToString(row("BGCOLOR")) + "; color: " + Convert.ToString(row("FONTCOLOR")) + ";' class='flowerDescription'>" + Convert.ToString(row("DESC")) + "</div>")),
                                                New XElement("cell", row("COLORCODE")),
                                                New XElement("cell", row("PRICE")),
                                                New XElement("cell", row("MARKET")),
                                                New XElement("cell", row("COST")),
                                                New XElement("cell", row("BOXES")),
                                                New XElement("cell", row("CSHAND")),
                                                New XElement("cell", row("UNITS")),
                                                New XElement("cell", row("UOM")),
                                                New XElement("cell", row("ASKEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("ASKEDDATE")).ToString("MM/dd/yyyy hh:mm tt")),
                                                New XElement("cell", row("APPROVEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("TRANSDATE")).ToString("MM/dd/yyyy hh:mm tt")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Return newDoc
            End If

            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingRecordsToApprove::PageApprove")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetApprovedRecordsYesterday() As Object
        Try
            Dim result = ""
            Dim Filter = "Yesterday"
            Dim objPriceApproval As New PriceApproval
            Dim dt As DataTable = objPriceApproval.GetApprovedRecords(Filter)

            If dt.Rows.Count > 0 Then
                Dim TotalRowCount As Integer = dt.Rows.Count

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", "1"),
                                            New XElement("total", TotalRowCount),
                                            From row In dt.Rows()
                                            Select
                                                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                                                New XElement("cell", row("CUSTOMER")),
                                                New XElement("cell", row("NAME")),
                                                New XElement("cell", row("AWB")),
                                                New XElement("cell", Convert.ToDateTime(row("DATEREC")).ToString("MM/dd/yyyy")),
                                                New XElement("cell", row("FLOWER")),
                                                New XElement("cell", row("FARM")),
                                                New XElement("cell", ("<div style='padding-bottom: 3px; background-color: " + Convert.ToString(row("BGCOLOR")) + "; color: " + Convert.ToString(row("FONTCOLOR")) + ";' class='flowerDescription'>" + Convert.ToString(row("DESC")) + "</div>")),
                                                New XElement("cell", row("COLORCODE")),
                                                New XElement("cell", row("PRICE")),
                                                New XElement("cell", row("MARKET")),
                                                New XElement("cell", row("COST")),
                                                New XElement("cell", row("BOXES")),
                                                New XElement("cell", row("CSHAND")),
                                                New XElement("cell", row("UNITS")),
                                                New XElement("cell", row("UOM")),
                                                New XElement("cell", row("ASKEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("ASKEDDATE")).ToString("MM/dd/yyyy hh:mm tt")),
                                                New XElement("cell", row("APPROVEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("TRANSDATE")).ToString("MM/dd/yyyy hh:mm tt")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Return newDoc
            End If

            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingRecordsToApprove::PageApprove")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetApprovedRecordsThisMonth() As Object
        Try
            Dim result = ""
            Dim Filter = "ThisMonth"
            Dim objPriceApproval As New PriceApproval
            Dim dt As DataTable = objPriceApproval.GetApprovedRecords(Filter)

            If dt.Rows.Count > 0 Then
                Dim TotalRowCount As Integer = dt.Rows.Count

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", "1"),
                                            New XElement("total", TotalRowCount),
                                            From row In dt.Rows()
                                            Select
                                                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                                                New XElement("cell", row("CUSTOMER")),
                                                New XElement("cell", row("NAME")),
                                                New XElement("cell", row("AWB")),
                                                New XElement("cell", Convert.ToDateTime(row("DATEREC")).ToString("MM/dd/yyyy")),
                                                New XElement("cell", row("FLOWER")),
                                                New XElement("cell", row("FARM")),
                                                New XElement("cell", ("<div style='padding-bottom: 3px; background-color: " + Convert.ToString(row("BGCOLOR")) + "; color: " + Convert.ToString(row("FONTCOLOR")) + ";' class='flowerDescription'>" + Convert.ToString(row("DESC")) + "</div>")),
                                                New XElement("cell", row("COLORCODE")),
                                                New XElement("cell", row("PRICE")),
                                                New XElement("cell", row("MARKET")),
                                                New XElement("cell", row("COST")),
                                                New XElement("cell", row("BOXES")),
                                                New XElement("cell", row("CSHAND")),
                                                New XElement("cell", row("UNITS")),
                                                New XElement("cell", row("UOM")),
                                                New XElement("cell", row("ASKEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("ASKEDDATE")).ToString("MM/dd/yyyy hh:mm tt")),
                                                New XElement("cell", row("APPROVEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("TRANSDATE")).ToString("MM/dd/yyyy hh:mm tt")))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Return newDoc
            End If

            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingRecordsToApprove::PageApprove")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetApprovedRecords(ByVal Filter As String, ByVal Approved As String) As Object
        Try
            'Modified By: Subhajit On: 06-07-2022
            Dim result = ""
            Dim objPriceApproval As New PriceApproval
            Dim dt As DataTable = objPriceApproval.GetApprovalRecords(Filter, Approved)

            If dt.Rows.Count > 0 Then
                Dim TotalRowCount As Integer = dt.Rows.Count

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", "1"),
                                            New XElement("total", TotalRowCount),
                                            From row In dt.Rows()
                                            Select
                                                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                                                New XElement("cell", row("CUSTOMER")),
                                                New XElement("cell", row("NAME")),
                                                New XElement("cell", row("AWB")),
                                                New XElement("cell", (DateTime.Today - Convert.ToDateTime(row("DATEREC"))).TotalDays.ToString()),
                                                New XElement("cell", row("FLOWER")),
                                                New XElement("cell", row("FARM")),
                                                New XElement("cell", ("<div style='padding-bottom: 3px; background-color: " + Convert.ToString(row("BGCOLOR")) + "; color: " + Convert.ToString(row("FONTCOLOR")) + ";' class='flowerDescription'>" + Convert.ToString(row("DESC")) + "</div>")),
                                                New XElement("cell", row("COLORCODE")),
                                                New XElement("cell", row("PRICE")),
                                                New XElement("cell", row("MARKET")),
                                                New XElement("cell", row("COST")),
                                                New XElement("cell", row("BOXES")),
                                                New XElement("cell", row("CSHAND")),
                                                New XElement("cell", row("UNITS")),
                                                New XElement("cell", row("UOM")),
                                                New XElement("cell", row("ASKEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("ASKEDDATE")).ToString("MM/dd/yyyy hh:mm tt")),
                                                New XElement("cell", objPriceApproval.GetApprovalText(Convert.ToString(row("APPROVED")), Convert.ToDateTime(row("ASKEDDATE")))),
                                                New XElement("cell", row("APPROVEDBY")),
                                                New XElement("cell", Convert.ToDateTime(row("TRANSDATE")).ToString("MM/dd/yyyy hh:mm tt")),
                                                New XElement("cell", objPriceApproval.GetApproveButton(Convert.ToString(row("APPROVED")), Convert.ToString(row("ID")), Convert.ToDateTime(row("ASKEDDATE")))),
                                                New XElement("cell", objPriceApproval.GetDenyButton(Convert.ToString(row("APPROVED")), Convert.ToString(row("ID")), Convert.ToDateTime(row("ASKEDDATE")))))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))

                Return newDoc
            End If

            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingRecordsToApprove::PageApprove")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateApprovalStatus(ByVal ID As Integer, ByVal ApprovalStatus As String, ByVal ApprovedBy As String, ByVal Reason As String) As String
        Try
            'Modified By: Subhajit On: 06-07-2022
            Dim objPriceApproval As New PriceApproval
            Return objPriceApproval.UpdateApprovalStatus(ID, ApprovalStatus, ApprovedBy, Reason)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingToApproveDetailsByRecNo::PageApprove")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPendingToApproveDetailsByRecNo(ByVal ID As Integer) As List(Of Approval)
        Try
            Dim objPriceApproval As New PriceApproval
            Return objPriceApproval.GetPendingToApproveDetailsByRecNo(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingToApproveDetailsByRecNo::PageApprove")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetDetailsByRecNo(ByVal RecNo As String, ByVal GotoTop As Boolean, ByVal GotoBottom As Boolean, ByVal GotoPrev As Boolean, GotoNext As Boolean) As Object
        Try
            Dim result = Nothing
            'Dim result = objDbfService.GetDetailsByRecNo(RecNo, GotoTop, GotoBottom, GotoPrev, GotoNext)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDetailsByRecNo::PageApprove")
            Return Nothing
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function ApproveRecordByRecNo(ByVal RecNo As String) As String
    '    Try
    '        Dim User As New User
    '        If Not Session("LoginUserDetails") Is Nothing Then
    '            User = Session("LoginUserDetails")
    '        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '            User = Session("LoginAdminDetails")
    '        End If
    '        Dim result As New Object
    '        If Not User Is Nothing Then
    '            If Not User.UserName Is Nothing Then
    '                If User.UserName.Length > 9 Then
    '                    result = obj.ApproveRecordByRecNo(RecNo, User.UserName.Substring(0, 8))
    '                Else
    '                    result = obj.ApproveRecordByRecNo(RecNo, User.UserName)
    '                End If
    '            Else
    '                result = obj.ApproveRecordByRecNo(RecNo, "POPUP")
    '            End If

    '        Else
    '            result = obj.ApproveRecordByRecNo(RecNo, "POPUP")
    '        End If
    '        Return result

    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ApproveRecordByRecNo::PageApprove")
    '        Return Nothing
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DenyRecordByRecNo(ByVal RecNo As String) As String
        Try
            Dim result = Nothing
            'result = objDbfService.DenyRecordByRecNo(RecNo)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DenyRecordByRecNo::PageApprove")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckApprovalFileExist() As String
        Try
            Dim result = Nothing
            result = "Exist"
            'Dim result = objDbfService.CheckApprovalFileExist()
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckApprovalFileExist::PageApprove")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Customer"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCustomerDetailsFromSQL(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CustomerDetail), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim SalesPerson As Integer = 0

            Dim Canseeallcustomers As String = "N"
            Dim permissions As String = User.ORDER

            Canseeallcustomers = permissions.Substring(13, 1)

            If User.UserType.ToLower() = "sales person" Then
                If whereCondition <> "" Then
                    whereCondition = whereCondition + " And A.salesman=" + User.SalesPerson
                Else
                    whereCondition = "where A.salesman=" + User.SalesPerson
                End If
            Else
                If Canseeallcustomers = "N" Then
                    whereCondition = "where A.salesman=" + User.SalesPerson
                End If
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New CustomerDetails.GetCustomerDetailsForFgrd

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of CustomerDetail) = obj.GetCustomerDetailsFromSQL(whereCondition)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Customer", "Name", "Phone", "Purchaser", "City", "State", "Country", "LastSale", "Days", "LastCall", "ARBalance", "Creditlimit", "Available", "Credithold", "SalesmanName", "CallDays", "DeliveryDays"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Customer").ColumnName = "CUST#"
                dt.Columns("Purchaser").ColumnName = "Buyer"
                dt.Columns("ARBalance").ColumnName = "Balance"
                dt.Columns("SalesmanName").ColumnName = "SalesPerson"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                'dtCloned.Columns("Date").DataType = GetType(String)
                'dtCloned.Columns("Time").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "OrdCust$CustDet")
                Return BuildXmlDoc(filepath)
            Else

                Dim data As List(Of CustomerDetail) = obj.GetCustomerDetailsFromSQL(whereCondition)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", "100"),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.Customer),
                                            New XElement("cell", "<img src='images/dollar.png' style='cursor:pointer;' id='ARINVS_" + row.Customer.ToString() + "' title='Click to open up closed invoices  (F5)'></a>"),
                                            New XElement("cell", If(User.UserType.ToLower() = "warehouse", row.Customer.ToString(), "<a id='aCustomerARINVS_" + row.Customer.ToString() + "' title='Click to open up call history (F7)' style='text-decoration:underline;cursor:pointer;'>" + row.Customer.ToString() + "</a>")),
                                            New XElement("cell", IIf(User.Name.ToLower() = "demo", "XXXXXXXXXXXXXXXXXXXXXXXX", "<a style='text-decoration: underline;cursor:Pointer;'  id='aCustomerName_" + row.Customer.ToString() + "' title='Click to enter a new order for this customer'>" + row.Name + "</a>")),
                                            New XElement("cell", row.PHONE),
                                            New XElement("cell", row.Purchaser),
                                            New XElement("cell", row.CITY),
                                            New XElement("cell", row.STATE),
                                            New XElement("cell", row.COUNTRY),
                                            New XElement("cell", row.LastSale),
                                            New XElement("cell", "<span title='Number of days since last sale'>" + row.Days + "</span>"),
                                            New XElement("cell", row.LastCall),
                                            New XElement("cell", IIf(row.ARBALANCE <> 0.0, row.ARBALANCE.ToString("N", CultureInfo.InvariantCulture), row.ARBALANCE)),
                                            New XElement("cell", IIf(row.CREDITLIMIT <> 0.0, row.CREDITLIMIT.ToString("N", CultureInfo.InvariantCulture), row.CREDITLIMIT)),
                                            New XElement("cell", IIf(row.Available <> 0.0, row.Available.ToString("N", CultureInfo.InvariantCulture), row.Available)),
                                            New XElement("cell", IIf(row.Credithold = "Y", "<a id='aCustomerHoldARINVS_" + row.Customer.ToString() + "'> <img style='cursor:pointer;width: 26px;height: 25px;margin-top: -6px;margin-bottom: -3px;margin-left:-4px;' src='images/ARInqHold.png' title='" + row.ReasonHold + "'/></a>", "")),
                                            New XElement("cell", row.CallDays),
                                            New XElement("cell", "<span title='" + row.DeliveryDays + "'>" + row.DeliveryDays + "</span>"),
                                            New XElement("cell", row.SalesmanName)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomerDetailsFromSQL")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCustomerDetailsForARInquiryFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CustomerDetail), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            whereCondition = "where (Balance+Orders)<>0"

            If User.UserType.ToLower() = "sales person" Then
                If whereCondition <> "" Then
                    whereCondition = whereCondition + " And salesman=" + User.SalesPerson
                Else
                    whereCondition = "where salesman=" + User.SalesPerson
                End If
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New CustomerDetails.GetCustomerDetailsForFgrd

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of CustomerDetail) = obj.GetCustomerDetailsWithBalance(whereCondition)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Customer", "Name", "APPHONE", "APCONTACT", "City", "State", "Country", "LastPayment", "Days", "LastCall", "ARBalance", "BAL0030", "BAL3060", "BAL6090", "BAL90", "Creditlimit", "Available", "Credithold", "SalesmanName", "CustSince", "TermsDesc"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Customer").ColumnName = "CUST#"
                dt.Columns("APCONTACT").ColumnName = "APCONTACT"
                dt.Columns("ARBalance").ColumnName = "Balance"
                dt.Columns("SalesmanName").ColumnName = "SalesPerson"
                dt.Columns("CustSince").ColumnName = "OpenDate"
                dt.Columns("TermsDesc").ColumnName = "Terms"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                'dtCloned.Columns("Date").DataType = GetType(String)
                'dtCloned.Columns("Time").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "OrdCust$ARInquiry")
                Return BuildXmlDoc(filepath)
            Else

                Dim data As List(Of CustomerDetail) = obj.GetCustomerDetailsWithBalance(whereCondition)
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", "100"),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.Customer), New XAttribute("style", IIf(row.Customer <> 0, IIf(row.Statement = "False" Or row.Statement = "0", "background:#FF9B9B", ""), "")),
                                            New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='CustSelect_" & row.Customer.ToString() & "' src='images/check-off.png' />")),
                                            New XElement("cell", "<img src='images/dollar.png' style='cursor:pointer;' title='click to open up closed invoices ( F5 )' id='ARINVS_" + row.Customer.ToString() + "'></a>"),
                                            New XElement("cell", If(User.UserType.ToLower() = "warehouse", row.Customer.ToString(), "<a title='Click to open up call history (F7)' id='aCustomer_" + row.Customer.ToString() + "," + Convert.ToDateTime("01/01/1900") + "' style='text-decoration:underline;cursor:pointer;'>" + row.Customer.ToString() + "</a>")),
                                            New XElement("cell", IIf(User.Name.ToLower() = "demo", "XXXXXXXXXXXXXXXXXXXXXXXX", "<a title='Click to open up customer maintenance' id='aCustNameARInquiry_" + row.Customer.ToString() + "' style='text-decoration:underline;cursor:pointer;'>" + row.Name + "</a>")),
                                            New XElement("cell", IIf(row.APPHONE.Trim() = "", row.PHONE, "<span title=" + row.PHONE + ">" + row.APPHONE + "</span>")),
                                            New XElement("cell", IIf(row.APCONTACT.Trim() = "", row.Purchaser, row.APCONTACT)),
                                            New XElement("cell", row.CITY),
                                            New XElement("cell", row.STATE),
                                            New XElement("cell", row.COUNTRY),
                                            New XElement("cell", row.LastPayment),
                                            New XElement("cell", ""),
                                            New XElement("cell", row.LastCall),
                                            New XElement("cell", IIf(row.ARBALANCE <> 0.0, IIf(row.ARBALANCE < 0.0, "<span style='font-weight:bold;color:red;font-size: 13px;'>" + row.ARBALANCE.ToString("N", CultureInfo.InvariantCulture) + "</span>", "<span style='font-weight:bold'>" + row.ARBALANCE.ToString("N", CultureInfo.InvariantCulture) + "</span>"), "<span style='font-weight:bold'>" + row.ARBALANCE.ToString() + "</span>")),
                                            New XElement("cell", IIf(row.ORDERS <> 0.0, row.ORDERS.ToString("N", CultureInfo.InvariantCulture), row.ORDERS)),
                                            New XElement("cell", IIf(row.Credithold = "Y", "<img id='aCustomerHoldARINVS_" + row.Customer.ToString() + "' style='cursor:pointer;width: 26px;height: 25px;margin-top: -6px;margin-bottom: -3px;margin-left:-4px;' src='images/ARInqHold.png' title='" + row.ReasonHold + "'/>", "")),
                                            New XElement("cell", IIf(row.BAL0030 <> 0.0, row.BAL0030.ToString("N", CultureInfo.InvariantCulture), row.BAL0030)),
                                            New XElement("cell", IIf(row.BAL3060 <> 0.0, row.BAL3060.ToString("N", CultureInfo.InvariantCulture), row.BAL3060)),
                                            New XElement("cell", IIf(row.BAL6090 <> 0.0, row.BAL6090.ToString("N", CultureInfo.InvariantCulture), row.BAL6090)),
                                            New XElement("cell", IIf(row.BAL90 <> 0.0, row.BAL90.ToString("N", CultureInfo.InvariantCulture), row.BAL90)),
                                            New XElement("cell", IIf(row.BAL120 <> 0.0, row.BAL120.ToString("N", CultureInfo.InvariantCulture), row.BAL120)),
                                            New XElement("cell", IIf(row.CREDITLIMIT <> 0.0, row.CREDITLIMIT.ToString("N", CultureInfo.InvariantCulture), row.CREDITLIMIT)),
                                            New XElement("cell", IIf(row.Available <> 0.0, row.Available.ToString("N", CultureInfo.InvariantCulture), row.Available)),
                                            New XElement("cell", row.SalesmanName),
                                            New XElement("cell", row.CustSince),
                                            New XElement("cell", IIf(row.TERMSDESC = "", "", "<span title='" + row.TERMSDESC + "'>" + row.TERMSDESC + "</span>"))))))

                Dim newDoc As New XmlDocument()
                Dim idx As Integer = data.Count - 1
                newDoc.LoadXml(xmlDoc.ToString())
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""


                Return newDoc

            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomerDetailsFromSQL")
            Return Nothing
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function GetCustForAutocomplete(ByVal Searchtext As String) As List(Of CustomerDetail)
        Try
            Return CustomerDetails.GetCustForAutocomplete(Searchtext.ToUpper())
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustForAutocomplete::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustForAutocompleteWithDivision(ByVal Searchtext As String, ByVal OnlyMe As String) As List(Of CustomerDetail)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If OnlyMe = "true" Then
                Return CustomerDetails.GetCustForAutocompleteWithDivision(Searchtext.ToUpper(), User.SalesPerson, User.Division)
            Else
                Return CustomerDetails.GetCustForAutocompleteWithDivision(Searchtext.ToUpper(), "0", User.Division)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustForAutocompleteWithDivision::PageOrder")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Soumya:
    ''' </summary>
    ''' <param name="Searchtext"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetCustForAutocompleteAR(ByVal Searchtext As String) As List(Of CustomerDetail)
        Try
            Return CustomerDetails.GetCustForAutocompleteAR(Searchtext.ToUpper())
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustForAutocompleteAR::PageOrder")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' AUTHOR : Abinaya
    ''' Date created : 08/24/2017
    ''' Brief description of : ARINVS customer information and net sales details 
    ''' </summary>
    ''' <param name="Customer"></param>
    ''' <returns>Customer details list</returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesOrderCustInfo(ByVal Customer As String) As List(Of CustomerDetail)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim data As List(Of CustomerDetail) = CustomerDetails.GetSalesOrderCustInfo(Customer, User.Name)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderCustInfo::PageCustDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetNestSalesCalculation(ByVal Customer As String) As DataTable
        Try
            Dim data As DataTable = CustomerDetails.GetNestSalesCalculation(Customer)
            Dim json As New JavaScriptSerializer()
            Return data

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNestSalesCalculation::PageCustNetSales")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetTotalCompanySalesCalculation(ByVal Customer As String, ByVal SalesMan As String, ByVal OnlyMe As String, ByVal GraphType As String, ByVal Category As String) As CustomerMaster
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim data As CustomerMaster
            If OnlyMe = "true" Then
                data = CustomerDetails.GetTotalCompanySalesCalculation(Customer, User.SalesPerson, User.Division, GraphType, User.ID)
                data.CurrentSalesPersonId = User.SalesPerson
            Else
                data = CustomerDetails.GetTotalCompanySalesCalculation(Customer, SalesMan, User.Division, GraphType, User.ID)
            End If
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTotalCompanySalesCalculation::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCategories() As List(Of KeyValuePair(Of String, String))
        Try
            Return CustomerDetails.GetCategoryList()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCategories::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomers(ByVal SalesMan As Integer) As List(Of KeyValuePair(Of String, String))
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Return CustomerDetails.GetCustomerList(SalesMan)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomers::PageOrder")
            Throw
            'Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesPersonWiseDailyDataForGraphs(ByVal GraphType As String) As CustomerMaster
        Try
            Dim data As CustomerMaster
            data = CustomerDetails.GetSalesPersonWiseDailyDataForGraphs(GraphType)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesPersonWiseDailyDataForGraphs::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCategorySalesForGraphs(ByVal CAT As String, ByVal GraphType As String) As CustomerMaster
        Try
            Dim data As CustomerMaster
            If GraphType = "CategoryUnits" Then
                data = CustomerDetails.GetCategoryUnitsForGraphs(CAT)
            Else
                data = CustomerDetails.GetCategorySalesForGraphs(CAT)
            End If

            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCategorySalesForGraphs::PageOrder")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' AUTHOR : Abinaya
    ''' Date created : 09/01/2017
    ''' Brief description of : Update Customer Info on SQL table F_CUST and tblAPCONTACT  
    ''' </summary>
    ''' 'Abi/Nivetha :: 01 Mar 19 :: Need to add three edit fields that are in f_cust :: Modified
    ''' <returns>Success String value</returns>
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCustomerDetailsInfo(ByVal CustNo As String, ByVal Buyer As String, ByVal Phone As String, ByVal Fax As String, ByVal CallTime As String, ByVal CallDays As String, ByVal DelivDays As String, ByVal Airport As String, ByVal Airline As String, ByVal ShipInstrc As String, ByVal Email As String, ByVal FaxOrEmail As String, ByVal APContact As String, ByVal APPhone As String, ByVal APEmail As String, ByVal APFax As String, ByVal CombInv As Boolean, ByVal NoSubs As Integer) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim data = CustomerDetails.UpdateCustomerDetailsInfo(CustNo, Buyer, Phone, Fax, CallTime, CallDays, DelivDays, Airport, Airline, ShipInstrc, Email, FaxOrEmail, APContact, APPhone, APEmail, APFax, CombInv, NoSubs)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCustomerDetailsInfo::PageCustDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerComments(ByVal Customer As Integer) As String

        Try
            Return CustomerDetails.GetCustomerComments(Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomerComments::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCustomerComments(ByVal Customer As String, ByVal Comments As String) As String
        Try
            Comments = HttpUtility.UrlDecode(Comments, System.Text.Encoding.Default)
            Return CustomerDetails.SaveCustomerComments(Customer, Comments)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCustomerComments::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmComments(ByVal Farm As String) As String
        Try
            Return Farms.GetFarmComments(Farm)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmComments::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveFarmComments(ByVal Farm As String, ByVal Comments As String) As String
        Try
            Comments = HttpUtility.UrlDecode(Comments, System.Text.Encoding.Default)
            Return Farms.SaveFarmComments(Farm, Comments)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFarmComments::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCustomerOrders(ByVal Customer As String) As String
        Try
            If Integer.TryParse(Customer, 0) Then
                Return CustomerDetails.UpdateCustomerOrders(Customer)
            Else
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCustomerOrders::PageOrder")
            Return "error"
        End Try
    End Function

#End Region

#Region "ARINVS"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARINVDetailsForCustomerFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String, ByVal IsARINVHistory As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CustomerDetail), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ARINVS.GetARINVSForFgrd

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of ARINVSS) = obj.GetARINVSDetailsForCustomer(Customer, "1", Convert.ToBoolean(Convert.ToInt32(IsARINVHistory)))

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Invoice", "RecDate", "PO", "ShiptoName", "AWB", "Carrier", "WH", "Boxes", "FBE", "Cubes", "Charges", "Payments", "Credits", "Adjustment", "Balance", "AccumulatedBalance", "SLSMAN"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'dt.Columns("Customer").ColumnName = "CUST#"
                'dt.Columns("Purchaser").ColumnName = "Buyer"
                'dt.Columns("ARBalance").ColumnName = "Balance"
                'dt.Columns("SalesmanName").ColumnName = "SalesPerson"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "ARINVS$ARINVS")
                Return BuildXmlDoc(filepath)
            Else

                Dim data As List(Of ARINVSS) = obj.GetARINVSDetailsForCustomer(Customer, "0", Convert.ToBoolean(Convert.ToInt32(IsARINVHistory)))
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", data.Count),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.Invoice),
                                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='ARINVselect_" & row.Invoice.ToString() & "' src='" & IIf(row.ARINVSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                                        New XElement("cell", IIf(row.PO = "UnApplied", row.Invoice, "<a style='cursor:pointer;text-decoration:underline;' id='aVetInvoice_" + row.Invoice + "$" + Customer + "$" + row.RecDate + "'>" + row.Invoice + "</a>")),
                                        New XElement("cell", "<a id='aOrderDate_" + row.Invoice.ToString() + "' style='text-decoration:underline;cursor:pointer;'>" + row.RecDate + "</a>"),
                                        New XElement("cell", row.PO),
                                        New XElement("cell", "<a title='" + row.Shipto + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoName) + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoAddress1) + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoAddress2) + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoCity) + "," + ReplaceSingleQutoesInString(row.ShiptoState) + "<br/>" + row.ShiptoZip + "'>" + ReplaceSingleQutoesInString(row.ShiptoName) + "</a>"),
                                        New XElement("cell", IIf(row.AWB = "" Or row.AWB = "0", "", row.AWB)),
                                        New XElement("cell", If(row.Carrier <> "A1" And row.Carrier <> "A2 " And row.Carrier <> "A3" And row.Carrier <> "AR", row.Carrier, "<span><a href='#' id='lnkCarrierARXML_" + row.Invoice + "'>" + row.Carrier + "</span>")),
                                        New XElement("cell", row.WH),
                                        New XElement("cell", row.Charges.ToString("#,##0.00")),
                                        New XElement("cell", row.Payments.ToString("#,##0.00")),
                                        New XElement("cell", row.Credits.ToString("#,##0.00")),
                                        New XElement("cell", row.Adjustment.ToString("#,##0.00")),
                                        New XElement("cell", If(row.Invoice = 0, row.Balance.ToString("#,##0.00"), "<a id='aOrderBalance_" + row.Invoice.ToString() + "' style='text-decoration:underline;font-weight: bold;cursor:pointer;'>" + row.Balance.ToString("#,##0.00") + "</a>")),
                                        New XElement("cell", row.AccumulatedBalance.ToString("#,##0.00")),
                                        New XElement("cell", row.SLSMAN),
                                        New XElement("cell", IIf(row.EMAILED = True, "<img style='Cursor:pointer;margin-top:-3px' id='EmailedInvoiceSelect_" & row.Invoice.ToString() & "' src='images/check-on.png' />", ""))
                                        ))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Dim idx As Integer = data.Count - 1

                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = "Total"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""


                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVSDetailsForCustomer")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetUnAppliedAmountDetailsByCustomerForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CustomerDetail), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ARINVS.GetARINVSForFgrd
            Dim data As List(Of ARINVSS) = obj.GetUnAppliedAmountDetailsForCustomer(Customer)
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", data.Count),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.Customer),
                                        New XElement("cell", row.RecDate),
                                        New XElement("cell", row.Check),
                                        New XElement("cell", row.Charges.ToString("#,##0.00"))))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVSDetailsForCustomer")
            Return Nothing
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportF_ARINVSfromDBF() As String
    '    Try
    '        Dim result As String = ""
    '        result = obj.GetF_ARINVSDetailsFromDBF()
    '        Return result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportF_ARINVSfromDBF::PageFlowers")
    '        Return "error"
    '    End Try
    'End Function


    <System.Web.Services.WebMethod(True)>
    Public Async Function SendStatementReportForCustomer(ByVal Customers As String, ByVal StatementDate As String, ByVal EmailToIDs As String,
                                                  ByVal SendEmailByOutlook As String, ByVal EmailOrPDF As String) As Task(Of ArrayList)
        Try

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return Nothing
            End If
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim ReportResult As New ArrayList
            Dim fileNames As New List(Of String)

            For Each customer In Customers.Split(",")


                Dim obj As New ARINVS.GetARINVSForFgrd
                Dim data As List(Of ARINVSS) = obj.GetARINVSDetailsForStatementReport(customer, StatementDate)

                If data Is Nothing Then
                    Continue For
                End If


                Dim EmailTo As String = ""
                Dim CustomerDefaultEmailAddressForStatementReport As String = ""
                Dim PrintOptionSetOnDocsFortheCustomer As Boolean = False
                If EmailOrPDF = "Email" Then
                    'First we have to look into if there any email address for the customer inthe F_CUSTDO for to statement report(DOCTYPE=S)
                    CustomerDefaultEmailAddressForStatementReport = DAOCustDO.GetAddressForCustomerByDocTypeAndDelType(customer, "S", "'E','F'") 'DOCTYPE=S(Statement) And DELTYPE=E(Email)
                    PrintOptionSetOnDocsFortheCustomer = DAOCustDO.PrintOptionSetOnDocsFortheCustomer(customer, "S")

                End If


                Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNo(customer)

                Dim PrintedReportData(4) As String
                'PrintedReportData(0) = Farm
                PrintedReportData(0) = customer

                'we have to use email address for the customer in the F_CUSTDO if there no info have to use F_CUST.Email
                If CustomerDefaultEmailAddressForStatementReport.Trim() = "" Then
                    If CustomerDetail.Email = "" Then
                        PrintedReportData(1) = ""
                    Else
                        PrintedReportData(1) = CustomerDetail.Email  'if no information in F_CUSTDO then it should look in f_cust.email
                    End If
                Else
                    PrintedReportData(1) = CustomerDefaultEmailAddressForStatementReport
                End If


                If CustomerDetail.Name = "" Then
                    PrintedReportData(2) = ""
                Else
                    PrintedReportData(2) = CustomerDetail.Name
                End If

                If EmailToIDs = "" Then
                    EmailTo = PrintedReportData(1).ToString()
                Else
                    EmailTo = EmailToIDs
                End If


                Dim User As New User
                If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginUserDetails")
                ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                    User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
                End If


                If data.Count > 0 Then
                    Dim XMLData = New XElement("ReportHeader",
                        From row In data
                        Select New XElement("Report", "",
                        New XElement("RecDate", row.RecDate),
                        New XElement("Invoice", row.Invoice),
                        New XElement("PO", row.PO),
                        New XElement("Charge", row.Charges),
                        New XElement("Payment", row.Payments),
                        New XElement("Credits", row.Credits),
                        New XElement("Balance", row.Balance),
                        New XElement("ACCBalance", row.AccumulatedBalance),
                        New XElement("Customer", customer),
                        New XElement("UserID", User.ID)))
                    Dim result As String = ARINVS.InsertARINVSStatementReportData(XMLData.ToString(), User.ID)
                End If

                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
                Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
                Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}

                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "UserID"
                reportParameterCollection(1).Values.Add(User.ID)

                reportParameterCollection(2) = New ReportParameter()
                reportParameterCollection(2).Name = "StatementDate"
                reportParameterCollection(2).Values.Add(StatementDate)

                reportParameterCollection(3) = New ReportParameter()
                reportParameterCollection(3).Name = "Customer"
                reportParameterCollection(3).Values.Add(customer)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""

                filename = "Statement_" + customer + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"



                Dim BodyMessage As String = ""
                Dim ReportName As String = objPdf.ExportToPdf(filename, "rptStatement", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Invoice. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")

                If Not ReportName.Trim().Contains("error : ") And EmailTo <> "" And SendEmailByOutlook = "0" And EmailOrPDF = "Email" And CustomerDetail.Statement = "True" Then
                    Await Logs.SendMail(User.Email, EmailTo + "," + User.Email, "", ReportName, (CompanyName + " Statement For " + CustomerDetail.Name + " as of " + StatementDate), "STATEMENT", "", customer)
                End If


                Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + ReportName.Replace("~/", "").Replace("\", "/")
                PrintedReportData(3) = FullPath
                PrintedReportData(4) = PrintOptionSetOnDocsFortheCustomer 'Need To generate PDF
                fileNames.Add(FullPath)
                ReportResult.Add(PrintedReportData)
            Next

            If ReportResult.Count = 0 Then
                Return ReportResult
            Else
                If EmailOrPDF = "PDF" Then
                    Dim CombinedFilePath As String = ""
                    Dim CombineFileName As String = ""
                    If Customers.Contains(",") Then
                        CombineFileName = "Statement_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".pdf"
                    Else
                        CombineFileName = "Statement_" + Customers + "_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".pdf"
                    End If
                    CombinedFilePath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() + "\" + ReportExportFolder + "\" + CombineFileName
                    Dim Result As String = POReportExport.CombineMultiplePDFs(fileNames.ToArray(), CombinedFilePath)
                    ReportResult = New ArrayList
                    ReportResult.Add(XmlPath.Replace("~/", "").Replace("\", "/") + "\" + ReportExportFolder + "\" + CombineFileName)
                    Return ReportResult
                End If

                Return ReportResult
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::SendARINVSStatementReport")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerDocumentsAddress(ByVal CustomerNo As String, ByVal DocType As String, ByVal DelType As String) As String
        Try
            Dim EmailAddress As String = ""

            Dim CustomerDefaultEmailAddressForStatementReport As String = ""

            'First we have to look into if there any email address for the customer inthe F_CUSTDO for to statement report(DOCTYPE=S)
            CustomerDefaultEmailAddressForStatementReport = DAOCustDO.GetAddressForCustomerByDocTypeAndDelType(CustomerNo, DocType, DelType) 'DOCTYPE=S(Statement) And DELTYPE=E(Email)::Add DELTYPE=F(FAX) also ::02Nov2017

            Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNo(CustomerNo)

            'we have to use email address for the customer in the F_CUSTDO if there no info have to use F_CUST.Email

            If CustomerDefaultEmailAddressForStatementReport.Trim() = "" Then
                If CustomerDetail IsNot Nothing Then
                    If DelType = "'E'" Then
                        EmailAddress = If(CustomerDetail.Email.Trim() <> "", CustomerDetail.Email, "")
                    End If
                    If DelType = "'F'" Then
                        EmailAddress = If(CustomerDetail.Fax.Trim() <> "", CustomerDetail.Fax, "")
                    End If
                    If DelType = "'E','F'" Then
                        EmailAddress = If(CustomerDetail.Email <> "", CustomerDetail.Email + ",", "") + If(CustomerDetail.Fax <> "", CustomerDetail.Fax + "@faxage.com", "")
                    End If
                Else
                    Return ""
                End If
            Else        'if no information in F_CUSTDO then it should look in f_cust.email::Add fax address also ::02Nov2017
                EmailAddress = CustomerDefaultEmailAddressForStatementReport
            End If

            Return EmailAddress
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetCustomerDocumentsAddress")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUnAppliedAmountForCustomer(ByVal CustomerNo As String) As Decimal
        Try
            Return ARINVS.GetUnAppliedAmountForCustomer(CustomerNo)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetUnAppliedAmountForCustomer")
            Return 0.0
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetTotalBalanceOfAR(ByVal AsOfDate As String) As Decimal
        Try
            Return ARINVS.GetTotalBalanceOfAR(AsOfDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetTotalBalanceOfAR")
            Return 0.0
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetARSummaryDetails(ByVal StartDate As String, ByVal EndDate As String) As ARSummary
        Try
            Return ARINVS.GetARSummaryDetails(StartDate, EndDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetARSummaryDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARINVSViewPaymentsHeaderByCustomer(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(ARINVSS), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ARINVS.GetARINVSForFgrd
            Dim data As List(Of ARINVSS) = obj.GetARINVSViewPaymentsHeaderByCustomer(Customer)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", page.ToString()),
                                       New XElement("total", IIf(data.Count = 0, "1", data.Count)),
                                       data.Select(Function(row) New XElement("row", New XAttribute("id", row.Check + "_" + row.RecDate.Replace("/", "").Replace("-", "") + "_" + row.Deposit),
                                       New XElement("cell", row.PaymentType),
                                       New XElement("cell", IIf(row.Check = "0", "", row.Check)),
                                       New XElement("cell", row.RecDate),
                                       New XElement("cell", row.Payments.ToString("#,##0.00")),
                                       New XElement("cell", row.Deposit),
                                       New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='aViewPaymentsEmail_" & row.Check + "_" + row.RecDate.Replace("/", "").Replace("-", "") & "' src='images/email.png' />")))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVSViewPaymentsHeader")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARINVSViewPaymentsDetailsByCustomerAndCheck(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String, ByVal Check As String, ByVal RecDate As String, ByVal Deposit As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(ARINVSS), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1



            Dim obj As New ARINVS.GetARINVSForFgrd
            Dim data As List(Of ARINVSS) = obj.GetARINVSViewPaymentsDetailsByCustomerAndCheck(Check, Customer, RecDate, Deposit)
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", data.Count),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.Invoice),
                                        New XElement("cell", row.Invoice),
                                        New XElement("cell", row.RecDate),
                                        New XElement("cell", row.PO),
                                        New XElement("cell", row.Payments.ToString("#,##0.00"))))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Dim idx As Integer = data.Count - 1

            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = "Total"
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""



            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVSViewPaymentsHeader")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARINVNotesForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(ARINVSS), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1



            Dim data As List(Of BOARCOMM) = DAOARCOMM.GetARINVNotesDetail(Customer, sortExp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", data.Count),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.COMMID),
                                        New XElement("cell", "<b><a href='#' id='deleteARINVNotes_" & row.COMMID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<b><a href='#' id='editARINVNotes_" & row.COMMID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.COMMENTS),
                                        New XElement("cell", row.ADDUSER),
                                        New XElement("cell", row.ADDDATE),
                                        New XElement("cell", row.ADDTIME)))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            'Dim idx As Integer = data.Count - 1

            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = "Total"
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""



            Return newDoc
            ' End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVNotesForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetARINVNotesByCOMMID(ByVal COMMID As String) As BOARCOMM
        Try
            Return DAOARCOMM.GetARINVNotesByCOMMID(COMMID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVNotesByCOMMID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteARINVNotesByCOMMID(ByVal COMMID As String) As String
        Try
            Return DAOARCOMM.DeleteARINVNotesByCOMMID(COMMID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteARINVNotesByCOMMID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveARINVNotesByCOMMID(ByVal Customer As String, ByVal COMMENTS As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Return DAOARCOMM.SaveARINVNotesByCOMMID(Customer, HttpUtility.UrlDecode(COMMENTS, System.Text.Encoding.Default), User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveARINVNotesByCOMMID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateARINVNotesByCOMMID(ByVal Customer As String, ByVal COMMID As String, ByVal COMMENTS As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Return DAOARCOMM.UpdateARINVNotesByCOMMID(Customer, COMMID, HttpUtility.UrlDecode(COMMENTS, System.Text.Encoding.Default), User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveARINVNotesByCOMMID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARINVDocsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(ARINVSS), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of BOCustDO) = DAOCustDO.GetARINVDocsDetail("", sortExp)
                Dim dtARINVSDocs As DataTable

                dtARINVSDocs = ConvertToDataTable(data)

                Dim selectedColumns As String() =
                        {"Customer", "CustomerName", "DocType", "DelType", "ADDRESS", "ADDUSER", "ADDDATE", "ADDTIME"}

                Dim dtTempARINVDocs As DataTable = New DataView(dtARINVSDocs).ToTable(False, selectedColumns)
                dtTempARINVDocs.Columns("DocType").ColumnName = "DOCUMENT"
                dtTempARINVDocs.Columns("DelType").ColumnName = "METHOD"

                'dtTempARINVDocs.Rows.RemoveAt(dtTempARINVDocs.Rows.Count - 1)
                Dim dtClonedARINVDocs As DataTable = dtTempARINVDocs.Clone()
                'dtClonedARINVDocs.Columns("LastLogin").DataType = GetType(String)
                For Each row As DataRow In dtTempARINVDocs.Rows
                    dtClonedARINVDocs.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtClonedARINVDocs, "CUSTDO")
                Return BuildXmlDoc(filepath)

            Else
                Dim data As List(Of BOCustDO) = DAOCustDO.GetARINVDocsDetail(Customer, sortExp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", data.Count),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.DocID),
                                            New XElement("cell", "<b><a href='#' id='deleteARINVDocs_" & row.DocID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                            New XElement("cell", "<b><a href='#' id='editARINVDocs_" & row.DocID & "'><img src='images/Edit.png'/></a></b>"),
                                            New XElement("cell", IIf(row.DocType = "I", "I Invoice", IIf(row.DocType = "S", "S Stat.", row.DocType))),
                                            New XElement("cell", IIf(row.DelType = "E", "E Email", IIf(row.DelType = "F", "F Fax", IIf(row.DelType = "P", "P Pdf", row.DelType)))),
                                            New XElement("cell", row.ADDRESS),
                                            New XElement("cell", row.ADDUSER),
                                            New XElement("cell", row.ADDDATE),
                                            New XElement("cell", row.ADDTIME)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc

            End If
            ' End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVDocsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteARINVDocsByDocsID(ByVal DocsID As String) As String
        Try
            Return DAOCustDO.DeleteARINVDocsByDocsID(DocsID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteARINVDocsByDocsID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetARINVDocsByDocsID(ByVal DocsID As String) As BOCustDO
        Try
            Return DAOCustDO.GetARINVDocsByDocsID(DocsID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVDocsByDocsID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveARINVDocsByDocsID(ByVal Customer As String, ByVal DocType As String, ByVal DelType As String, ByVal Address As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Return DAOCustDO.SaveARINVDocsByDocsID(Customer, DocType, DelType, HttpUtility.UrlDecode(Address, System.Text.Encoding.Default), User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveARINVDocsByDocsID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateARINVDocsByDocsID(ByVal Customer As String, ByVal DocsID As String, ByVal DocType As String, ByVal DelType As String, ByVal Address As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Return DAOCustDO.UpdateARINVDocsByDocsID(Customer, DocsID, DocType, DelType, HttpUtility.UrlDecode(Address, System.Text.Encoding.Default), User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateARINVDocsByDocsID::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintCreditReqReport(ByVal Invoice As String, ByVal EmailOrPDF As String, ByVal EmailTo As String, ByVal Subject As String, ByVal Body As String, ByVal CreReqID As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}

            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "Invoice"
            reportParameterCollection(0).Values.Add(Invoice)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "BtnType"
            reportParameterCollection(1).Values.Add(EmailOrPDF)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ConnectionString"
            reportParameterCollection(2).Values.Add(ConString)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "CreReqID"
            reportParameterCollection(3).Values.Add(CreReqID)


            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
            filename = CompanyName + "_CreditRequestForInvoiceNo_" + Invoice + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptCreditReq", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Invoice. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
            If EmailOrPDF.ToUpper() = "EMAIL" Then
                If Not ReportName.Trim().Contains("error : ") And EmailTo <> "" Then
                    Dim unused = Logs.SendMail(User.Email, EmailTo, HttpUtility.UrlDecode(Body, System.Text.Encoding.Default), (ReportExportFolder + "\" + filename), Subject)
                End If
            End If
            Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + ReportName.Replace("~/", "").Replace("\", "/")
            Return FullPath

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintCreditReqReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerEmailIDforCrReq(ByVal Customer As String, ByVal InvoiceId As String) As String()
        Try
            Dim EmailAddress(2) As String
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()

            Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNo(Customer)
            EmailAddress(0) = CustomerDetail.Email
            EmailAddress(1) = CompanyName + " Credit Request for Invoice No.: " + IIf(Not String.IsNullOrEmpty(InvoiceId), InvoiceId, "")
            Return EmailAddress
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetCustomerEmailIDforCrReq")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARINVTransactionDetailsByInvoice(ByVal Invoice As String, ByVal IsARINVHistory As String) As XmlDocument

        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If




            Dim obj As New ARINVS.GetARINVSForFgrd


            Dim data As List(Of ARINVSS) = obj.GetARINVTransactionsByInvoice(Invoice, IsARINVHistory)
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", "0"),
                                        New XElement("total", data.Count),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.RECNO),
                                        New XElement("cell", row.PaymentType),
                                        New XElement("cell", row.InvDate),
                                        New XElement("cell", row.Charges.ToString("#,##0.00")),
                                        New XElement("cell", row.Check),
                                        New XElement("cell", row.Deposit),
                                        New XElement("cell", row.Reason),
                                        New XElement("cell", "<img style='cursor:pointer'  title='" + GetPersonIconDetails(row.ADDUSER, Convert.ToDateTime(row.ADDDATE).ToString("MM/dd/yyyy"), row.ADDTIME, row.ADDAPP, row.UPDUSER, Convert.ToDateTime(row.UPDDATE).ToString("MM/dd/yyyy"), row.UPDTIME, row.UPDAPP, row.DELUSER, Convert.ToDateTime(row.DELDATE).ToString("MM/dd/yyyy"), row.DELTIME, row.DELAPP, row.LOCKUSER, Convert.ToDateTime(row.LOCKDATE).ToString("MM/dd/yyyy"), row.LOCKTIME, row.LOCKAPP) + "'   id='imgPersonIconDetails_" + row.RECNO.ToString() + "'   src='images/Edit_user.png' />"),
                                        New XElement("cell", IIf(row.PaymentType = "Adjustment", "<b><a href='#' id='deleteAdjustment_" & row.sqlID & "'><img src='images/delete-icon.png'/></a></b>", ""))))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Dim idx As Integer = data.Count - 1



            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVSDetailsForCustomer")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetEmailAddressForARINVSViewPaymentsReport(ByVal CustomerNo As Integer) As String
        Try
            Dim EmailAddress As String = ""

            Dim CustDoEmail As String = ""

            'First we have to look into if there any email address for the customer in F_CUSTDO for to statement report(DOCTYPE=S)
            CustDoEmail = DAOCustDO.GetAddressForCustomerByDocTypeAndDelType(CustomerNo, "S", "'E'") 'DOCTYPE=S(Statement) And DELTYPE=E(Email)

            'we have to use email address for the customer in the F_CUSTDO if there no info have to use F_CUST.Email
            If CustDoEmail.Trim() = "" Then
                Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNo(CustomerNo)

                If CustomerDetail.Email = "" Then
                    EmailAddress = ""
                Else
                    EmailAddress = CustomerDetail.Email  'if no information in F_CUSTDO then it should look in f_cust.email
                End If
            Else
                EmailAddress = CustDoEmail
            End If
            Return EmailAddress
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetEmailAddressForARINVSViewPaymentsReport")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetARINVSViewPaymentsHeaderByCustomerdetails(ByVal Check As Integer, ByVal RecDate As String, ByVal CustomerNo As Integer, ByVal Amount As String, ByVal ToEmail As String, Deposit As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            Dim obj As New ARINVS.GetARINVSForFgrd
            Dim data As List(Of ARINVSS) = obj.GetARINVSViewPaymentsDetailsByCustomerAndCheck(Check, CustomerNo, RecDate, Deposit)
            Dim dt1 As DataTable
            Dim BodyContent As String = ""
            dt1 = ConvertToDataTable(data)
            BodyContent = GetARINVSViewPaymentsDetailsByCustomerAndCheckDetails(dt1, Check, RecDate, Amount, CustomerNo, HttpUtility.UrlDecode(data.First().CustName, System.Text.Encoding.Default))
            Logs.SendMail(User.Email, ToEmail, BodyContent, "", "Customer Applied Payment Report")

            Return "Success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetARINVSViewPaymentsHeaderByCustomerdetails")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetARINVSViewPaymentsDetailsByCustomerAndCheckDetails(ByVal dt1 As DataTable, ByVal Check As Integer, ByVal RecDate As String, ByVal Amount As String, ByVal CustomerNo As Integer, ByVal CustomerName As String) As String
        Try
            ' Dim data = SPORD.GetSPORDUserDetails(SpordID)
            'Dim str As String = "<table><tr><td>Cust#</td><td>Customer Name</td></tr><tr><td>" + Customer.ToString() + "</td><td></td></tr></table>"
            Dim str As String = "<h2 style='text-align: left;'>Customer Check Applied Report</h2>"
            '<h2 style ='text-align: center; align='left'>Customer Check Applied Report</h2>
            str += "<table  style='width: 629px; height: 157px;'><tr style='font-weight: bold; height: 18px;'><td style='height: 18px; width: 76px; text-align: right; padding-right: 20px'>Cust#</td><td style='height: 18px; width: 524px;' colspan='6'>Customer Name</td></tr>"
            str += "<tr style='height: 18px;'><td style='height: 18px; width: 76px; text-align: right; padding-right: 20px'>" + CustomerNo.ToString() + "</td><td style='text-align: left; height: 18px; width: 524px;' colspan='6'>" + CustomerName.ToString() + "</td></tr>"
            str += "<tr style='font-weight: bold; height: 31.8438px;'><td style='height: 31.8438px; width: 76px; text-align: center;'>Check #</td><td style='height: 31.8438px; width: 95px; text-align: center;'>Date</td><td style='height: 31.8438px; width: 133px; text-align: right; padding-right:20px'>Amount</td><td  style='height: 31.8438px; width: 96px; text-align: center;'>InvoiceNo</td><td style='height: 31.8438px; width: 86px; text-align: center;'>Date</td><td style='height: 31.8438px; width: 104px;text-align: center;'>PO</td><td style='height: 31.8438px; width: 133px;text-align: right;'>Amount</td></tr>"
            Dim count As Int32 = 0
            For count = 0 To dt1.Rows.Count - 1
                str += "<tr  style='height: 18px;'>"
                If count = 0 Then
                    str += "<td  style='text-align: right; height: 18px; width: 76px; padding-right: 20px'>" + Check.ToString() + "</td><td style='height: 18px; width: 95px; text-align: center;'>" + RecDate.ToString() + "</td><td style='height: 18px; width: 133px; text-align: right; padding-right:20px'>" + Amount.ToString() + "</td>"
                Else
                    str += "<td colspan='3' ></td>"
                End If
                If count = dt1.Rows.Count - 1 Then
                    str += "<td colspan='4'><hr size='1' color='black'' /></td></tr><tr style='height: 18px;'><td colspan='3'></td>"
                    str += "<td  style='height: 18px; width: 96px; ' colspan='3'>Total </td><td style='height: 18px; width: 10px;text-align: right;'>" + dt1.Rows(count)("Payments").ToString() + "</td>"
                Else
                    str += "<td style='height: 18px; width: 96px;'> " + dt1.Rows(count)("Invoice") + "</td><td style='height: 18px; width: 86px;'>" + dt1.Rows(count)("RecDate").ToString() + "</td><td style='height: 18px; width: 104px;'>" + dt1.Rows(count)("PO").ToString() + "</td><td style='height: 18px; width: 10px;text-align: right;'>" + dt1.Rows(count)("Payments").ToString() + "</td>"
                    str += "</tr>"
                End If
            Next
            str += "</tbody></table>"

            'For Each row As DataRow In dt1.Rows
            '    Dim KeyList As New List(Of String) From {row.Item("Invoice"), row.Item("RecDate"), row.Item("PO"), row.Item("Payments")}
            '    str += "<tr>"
            'str += "<td style=background:white;width:110px;>" + KeyList(0) + "</td> <td style=background:white;width:110px;>" + KeyList(1) + "</td><td style=background:white;width:110px;>" + KeyList(2) + "</td><td style=background:white;width:110px;>" + KeyList(3) + "</td>"
            '    str += "</tr>"
            'Next
            'str += "</table>"
            Return str
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetARINVSViewPaymentsDetailsByCustomerAndCheckDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetAdjustmentsTotalsForToday() As Double
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim obj As New ARINVS.GetARINVSForFgrd
            Dim data As Double = obj.GetAdjustmentsTotalsForToday()

            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetAdjustmentsTotalsForToday")
            Throw ex
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function DeleteAdjustmentbyID(ByVal ID As String) As String
        Try
            Dim obj As New ARINVS.GetARINVSForFgrd
            Dim data As String = obj.DeleteAdjustmentbyID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCreditCodebyID::PageCreditCode")
            Return Nothing
        End Try
    End Function


#End Region

#Region "VET"
    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportVETfromDBF() As String
    '    Try
    '        Dim result As String = ""
    '        result = obj.GetVETDetailsFromDBF()
    '        Return result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportVETfromDBF::PageFlowers")
    '        Return "error"
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportVET1fromDBF() As String
    '    Try
    '        Dim result As String = ""

    '        result = obj.GetVET1DetailsFromDBF()
    '        Return result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportVET1fromDBF::PageFlowers")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPONumberFromVETForAutocomplete(ByVal Searchtext As String) As List(Of VET_)
        Try
            Return VET.GetPONumberFromVETForAutocomplete(Searchtext.ToUpper())
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPONumberFromVETForAutocomplete::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInvoiceNoListFromVETByPONumber(ByVal PONumber As String) As List(Of VET_)
        Try
            Return VET.GetInvoiceNoListFromVETByPONumber(PONumber)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInvoiceNoListFromVETByPONumber::PageOrder")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' MANI :: Delete VET Detail by ID:: 10/22/2018
    ''' </summary>
    ''' <param name="ID"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteVETDetail(ByVal ID As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If

            Dim DeleteResult = VET.DeleteVETDetail(ID, User.Name)
            Return DeleteResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteVETDetail")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' MANI :: Get details from by VET details 
    ''' </summary>
    ''' <param name="ID"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetVETDetailsByID(ByVal ID As String) As BO.SalesDetail
        Try
            Return VET.GetVETDetailsByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetVETDetailsByID")
            Throw ex
        End Try
    End Function


    ''' <summary>
    ''' Mani::23/03/2018: ADD/Update Detail for an order
    ''' </summary>
    ''' <param name="VETID"></param>
    ''' <param name="Order"></param>
    ''' <param name="Customer"></param>
    ''' <param name="InventoryIDs"></param>
    ''' <param name="Quantity"></param>
    ''' <param name="Price"></param>
    ''' <param name="Type"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ADDUPDATEVETDetail(ByVal VETID As String, ByVal Order As String, ByVal Customer As String, ByVal InventoryIDs As String,
                                                      ByVal Quantity As Decimal, ByVal Price As Decimal,
                                                       ByVal Type As String, Units As String, PlusFuel As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If
            If Integer.TryParse(Order, 0) And Integer.TryParse(Customer, 0) Then
                Return VET.ADDUPDATEVETDetail(VETID, Order, Customer, InventoryIDs, Quantity, Price, Type, User.Name, Units, PlusFuel, User.ID, "")
            Else
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ADDUPDATEVETDetail")
            Return "error"
        End Try
    End Function



    ''' <summary>
    ''' MANI::24/10/2018::Void an VET
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function VoidVET(ByVal OrderNo As String, ByVal ReasonVoid As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Try
                If User.Name Is Nothing Then
                    Return "Logout"
                End If
            Catch ex As Exception
                Return "Logout"
            End Try

            Return VET.VoidVET(OrderNo, ReasonVoid, User.Name)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::VoidVET::PageOrder")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetVETInvoiceDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Invoice As String, ByVal ExportCSV As String) As XmlDocument
        Try
            'Modified By: Subhajit On: 06-14-2022
            Dim dtAllCredits As DataTable = F_CREREQ.GetAllCreditDetailsByInvoice(Invoice)

            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(VET_), qtype, query)
            End If
            'jad 2 - 15 - 2023 added wherecodition=''
            If whereCondition = "" And Invoice IsNot Nothing And Invoice <> "" Then
                whereCondition = IIf(whereCondition = "", "Invoice=" + Invoice, whereCondition + " and Invoice= " + Invoice)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1
            Dim obj As New VET
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data As List(Of VET_) = obj.GetVETInvoiceDetailsList(whereCondition, sortExp, start, rp)
                Dim dt1 As DataTable
                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Invoice", "Customer", "Shipto", "Flower", "Description", "Slsname", "Farm", "AWB", "Boxes", "UOM", "Units",
                                                    "TotalUnits", "FOB", "Totperline", "Type", "gpm", "BoxNum", "BoxCode", "UPC", "PODFlower"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Customer").ColumnName = "CUST#"
                dt.Columns("Slsname").ColumnName = "SLS"
                dt.Columns("Totperline").ColumnName = "Total"
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                'dtCloned.Columns("Date").DataType = GetType(String)
                'dtCloned.Columns("Time").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next

                Dim fileName As String
                fileName = "INVOICE_" + Invoice + "$VETInv"

                Dim filepath = ExporttoExcel(dtCloned, fileName)
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of VET_) = obj.GetVETInvoiceDetailsList(whereCondition, sortExp, start, rp)
                If data(0).ErrorMessage = "" Then
                    Dim SelectedPOs As New ArrayList
                    Dim TotalRowCount As Integer = 0

                    TotalRowCount = data(0).TotalRows.ToString()

                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    Dim FlowerColorVisibility As Boolean = False
                    For Each i In UserFeatures
                        If i.Name.ToLower = "show flower color" Then
                            FlowerColorVisibility = i.Value
                        End If
                    Next

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", String.Format("<input type='image' name='' style='Cursor:pointer;margin-top:-3px' id='VETOrderselect_' src='images/check-off.png' />")),
                       New XElement("cell", "<img href='#' id='VETDetailDelete_" + Convert.ToString(row.ID) + "' src='images/Delete-icon.png' style='cursor:pointer'/>"),
                    New XElement("cell", "<img href='#'  id='VETDetailEdit_" & Convert.ToString(row.ID) & "' src='images/Edit.png' style='cursor:pointer'/>"),
                       New XElement("cell", IIf(F_CREREQ.CheckCreditAppliedStatus(row.ID.ToString(), Invoice, dtAllCredits) > 0, "<a href='#'  title='Credits' id='credit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(Invoice = "0", "", Invoice) & "'  style='cursor:pointer;'><img src='images/sadface.png' style='width: 21px;height: 17px;margin-left: -3px;'/></a>", "<a href='#'  title='Credits' id='credit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(Invoice = "0", "", Invoice) & "'  style='cursor:pointer;'><img src='images/FACE03.png' style='width: 16px;height: 16px;'/></a>")),
                       New XElement("cell", row.RowNo),
                       New XElement("cell", row.Flower),
                       New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Bgcolor.ToString() + "' class='flowerDescription'><a title='" + row.Flower + "' id='VETDetailName_" & Convert.ToString(row.ID) & "'  style='color:" + row.Fontcolor.ToString() + ";'>" + row.Description + "</a></div>", "<a >" + row.Description + "</a>")),
                       New XElement("cell", row.Farm),
                       New XElement("cell", If(row.AWB = 0, If(row.RowNo = 0, "", "0"), If(row.AWB.ToString().Length <= 3, row.AWB, row.AWB.ToString().Substring(If(row.AWB = 0, 0, row.AWB.ToString().Length - 4))))),
                       New XElement("cell", "<a id='VETDetailBoxes_" & Convert.ToString(row.ID) & "' >" + Convert.ToString(row.Boxes) + "</a>"),
                       New XElement("cell", "<a id='VETDetailUOM_" & Convert.ToString(row.ID) & "' >" + Convert.ToString(row.UOM) + "</a>"),
                       New XElement("cell", "<a id='VETDetailUnits_" & Convert.ToString(row.ID) & "' >" + IIf(Convert.ToString(row.Units) = "0", "", Convert.ToString(row.Units)) + "</a>"),
                       New XElement("cell", IIf(row.TotalUnits1 = "0", "", row.TotalUnits1)),
                       New XElement("cell", IIf(row.FOB.ToString() = "0", "", row.FOB.ToString("#,##0.000"))),
                       New XElement("cell", IIf(row.TotPerLine.ToString() = "0", If(row.RowNo = 0, row.TotPerLine.ToString("#,##0.00"), "0"), If(row.RowNo = 0, row.TotPerLine.ToString("#,##0.00"), row.TotPerLine.ToString("#,##0.00")))),
                       New XElement("cell", "<a id='VETDetailType_" & Convert.ToString(row.ID) & "' >" + Convert.ToString(row.Type) + "</a>"),
                       New XElement("cell", IIf(row.GPM = "0", "<a href='#'  title='Cost: " + Convert.ToString(row.Cost) + " Freight: " + Convert.ToString(row.Othercost) + " Handling: " + Convert.ToString(row.Handling) + " Duties: " + Convert.ToString(row.ANDEAN) + " Landedcost: " + Convert.ToString(row.Landedcost) + "'></a>", "<a href='#'  title='Cost: " + Convert.ToString(row.Cost) + "<BR>Estimated<BR>Freight: " + Convert.ToString(row.Othercost) + " Handling: " + Convert.ToString(row.Handling) + " Duties: " + Convert.ToString(row.ANDEAN) + " Landedcost: " + Convert.ToString(row.Landedcost) + "  GPM: " + Convert.ToString(row.EstimatedGPM) + "%<BR>Actual<BR>Freight: " + Convert.ToString(row.ActualFreight) + " Handling: " + Convert.ToString(row.ActualHandling) + " Duties: " + Convert.ToString(row.ANDEAN) + " Landedcost: " + Convert.ToString(row.ActualLandedcost) + "  GPM: " + Convert.ToString(row.GPM) + "%<BR>Other Charges: " + Convert.ToString(row.ActualOtherCharges) + "Freigth out/Unit: " + Convert.ToString(row.FreightOut) + "'>" + row.GPM.ToString("#,##0.0") + "%") + "</a>"),
                       New XElement("cell", IIf(row.Boxnum = "0", "", row.Boxnum)),
                       New XElement("cell", row.Boxcode),
                       New XElement("cell", IIf(row.UPC = "0", "", row.UPC)),
                       New XElement("cell", IIf(row.PODFlower = "", "", row.PODFlower)),
                       New XElement("cell", row.Salesman),
                       New XElement("cell", "<a id='VETDetailInvenId_" & Convert.ToString(row.ID) & "' >" + Convert.ToString(row.InvenID) + "</a>")))))

                    Dim newDoc As New XmlDocument()
                    'New XElement("cell", "<a id='VETDetailBoxes_" & Convert.ToString(row.ID) & "' >" + IIf(Convert.ToString(row.Boxes) = "0", "", Convert.ToString(row.Boxes)) + "</a>"),
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Dim idx As Integer = data.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = "Totals"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    Return newDoc
                Else
                    'Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetVETInvoiceDetailsList::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckInvoice(ByVal Searchtext As String) As String
        Try
            Dim result As String = ""

            result = SalesOrder.CheckInvoiceExist(Searchtext.ToString())
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckInvoice::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckVETInvoice(ByVal Searchtext As String) As List(Of VET_)
        Try
            Dim data As New List(Of VET_)
            ' data = VET.CheckInvOrder(SearchText.ToString())
            data = VET.CheckInvVET(Searchtext.ToString())
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckVetInvoice::PageOrder")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Mani::06/04/2018::To release "Scan" and "Shipped" on first time,   Second click will make printed , list , bills,  false in F_order1 for the selected orders
    ''' </summary>
    ''' <param name="OrderNos"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ReleaseInvoice(ByVal OrderNos As String) As String
        Try
            Dim user As New User
            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return "LogOut"
            Else
                user = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If
            'end

            SalesOrder.ReleaseInvoice(OrderNos, user.Name)
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ReleaseInvoice::PageOrder")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' MANI::10/29/2018::Set Scanned Flag to 1
    ''' </summary>
    ''' <param name="OrderNos"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ActivateScanFlag(ByVal OrderNos As String) As String
        Try
            Dim user As New User
            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return "LogOut"
            Else
                user = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If
            'end

            SalesOrder.ActivateScanFlag(OrderNos, user.Name)
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ActivateScanFlag::PageOrder")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Async Function PrintInvoiceReportForVET(ByVal Invoice As String, ByVal EmailIDs As String, ByVal Subject As String, ByVal Body As String, ByVal Type As String, ByVal CustName As String) As Task(Of String)
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim HeaderInformation = CreateXMLForInvoiceReportHeaderForVET(Invoice)
            Dim DetailsInformation = CreateXMLForInvoiceReportDetailForVET(Invoice)

            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertInvoiceReportData(HeaderInformation, DetailsInformation, User.ID)

                'checkusersessionIsActive:start
                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If
                'end


                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "UserID"
                reportParameterCollection(1).Values.Add(User.ID)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim ShipDate As Date
                Dim filename As String = ""
                'If CustName.Length > 10 Then
                '    CustName = CustName.Substring(0, 10)
                'Else
                '    CustName = CustName
                'End If

                If Not Invoice.Contains(",") And Invoice.Length > 7 Then
                    Invoice = Invoice.Substring(0, 7)
                Else
                    Invoice = Invoice
                End If

                Try
                    If Invoice.Contains(",") Then
                        filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        'If Type = "Download" Then
                        '    filename = CustName + " Invoice Number " + Order + " shipped on " + DateTime.Now.ToString("MM-dd-yy") + ".pdf"
                        'Else
                        '    filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        'End If
                    Else
                        'filename = "Invoice_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        ShipDate = VET.GetVETDate(Invoice)

                        If Type = "Download" Then
                            filename = CustName + " Invoice No. " + Invoice + " shipped on " + ShipDate.ToString("MM-dd-yy") + ".pdf"
                        Else
                            filename = CompanyName + " Invoice No. " + Invoice + " shipped on " + ShipDate.ToString("MM-dd-yy") + ".pdf"
                        End If
                    End If
                Catch ex As Exception
                    filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                End Try

                Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
                Dim InvoiceReportName As String = ""
                If ConfigurationManager.AppSettings.AllKeys.Contains("InvoiceReportName") Then
                    InvoiceReportName = ConfigurationManager.AppSettings("InvoiceReportName").ToString()
                End If
                Dim BodyMessage As String = ""
                If String.IsNullOrEmpty(InvoiceReportName) Then
                    InvoiceReportName = "rptInvoice"
                End If
                'JAD
                Dim ReportName As String = objPdf.ExportToPdf(filename, InvoiceReportName, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Invoice. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                'Dim Subject As String = ""

                'If Invoice.Contains(",") Then
                '    Subject = CompanyName + " several Invoices  by user:" + User.Email '+ " ip: " + LocalIPAddress.ToString()
                'Else
                '    Subject = CompanyName + " Invoice:" + Invoice + " For shipping date " + ShipDate.ToString("MM-dd-yy") + "  by user:" + User.Email '+ " ip: " + LocalIPAddress.ToString()
                'End If // Commented by Belal on 05 sept 2020 :: Subject will be generated from fronend

                If Type = "Email" Then
                    If Not ReportName.Trim().Contains("error : ") Then
                        Await Logs.SendMail(User.Email, EmailIDs + "," + User.Email, Body, ReportName, Subject, "INVOICE", Invoice, "")
                    End If
                End If

                Return ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" And DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceReportForVET")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Async Function PrintBillofLadingReportForVET(ByVal Invoice As String, ByVal EmailIDs As String, ByVal Subject As String, ByVal Body As String, ByVal Type As String, ByVal CustName As String) As Task(Of String)
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim HeaderInformation = CreateXMLForInvoiceReportHeaderForVET(Invoice)
            Dim DetailsInformation = CreateXMLForInvoiceReportDetailForVET(Invoice)

            If (HeaderInformation <> "error" And DetailsInformation <> "error" And HeaderInformation <> "No Data") Then
                SalesOrder.InsertInvoiceReportData(HeaderInformation, DetailsInformation, User.ID)

                'checkusersessionIsActive:start
                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If
                'end


                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}


                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "UserID"
                reportParameterCollection(1).Values.Add(User.ID)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim ShipDate As Date
                Dim filename As String = ""
                'If CustName.Length > 10 Then
                '    CustName = CustName.Substring(0, 10)
                'Else
                '    CustName = CustName
                'End If

                If Not Invoice.Contains(",") And Invoice.Length > 7 Then
                    Invoice = Invoice.Substring(0, 7)
                Else
                    Invoice = Invoice
                End If

                Try
                    If Invoice.Contains(",") Then
                        filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        'If Type = "Download" Then
                        '    filename = CustName + " Invoice Number " + Order + " shipped on " + DateTime.Now.ToString("MM-dd-yy") + ".pdf"
                        'Else
                        '    filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        'End If
                    Else
                        'filename = "Invoice_" + Order + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                        ShipDate = VET.GetVETDate(Invoice)

                        If Type = "Download" Then
                            filename = CustName + " Invoice No. " + Invoice + " shipped on " + ShipDate.ToString("MM-dd-yy") + ".pdf"
                        Else
                            filename = CompanyName + " Invoice No. " + Invoice + " shipped on " + ShipDate.ToString("MM-dd-yy") + ".pdf"
                        End If
                    End If
                Catch ex As Exception
                    filename = "Invoice_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".pdf"
                End Try

                Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
                Dim InvoiceReportName As String = ""
                If ConfigurationManager.AppSettings.AllKeys.Contains("InvoiceReportName") Then
                    InvoiceReportName = ConfigurationManager.AppSettings("InvoiceReportName").ToString()
                End If
                Dim BodyMessage As String = ""
                If String.IsNullOrEmpty(InvoiceReportName) Then
                    InvoiceReportName = "rptInvoice"
                End If
                'JAD
                Dim ReportName As String = objPdf.ExportToPdf(filename, InvoiceReportName, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Invoice. Invoice#:" + Order + " by user:" + User.Email), "labelnotification")
                'Dim Subject As String = ""

                'If Invoice.Contains(",") Then
                '    Subject = CompanyName + " several Invoices  by user:" + User.Email '+ " ip: " + LocalIPAddress.ToString()
                'Else
                '    Subject = CompanyName + " Invoice:" + Invoice + " For shipping date " + ShipDate.ToString("MM-dd-yy") + "  by user:" + User.Email '+ " ip: " + LocalIPAddress.ToString()
                'End If // Commented by Belal on 05 sept 2020 :: Subject will be generated from fronend

                If Type = "Email" Then
                    If Not ReportName.Trim().Contains("error : ") Then
                        Await Logs.SendMail(User.Email, EmailIDs + "," + User.Email, Body, ReportName, Subject, "INVOICE", Invoice, "")
                    End If
                End If

                Return ReportName
            ElseIf HeaderInformation = "error" Or DetailsInformation = "error" Then
                Return "error"
            ElseIf HeaderInformation = "No Data" And DetailsInformation = "No Data" Then
                Return "No Data"
            Else
                Return "error"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceReportForVET")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForInvoiceReportHeaderForVET(ByVal Order As String) As String
        Try
            Dim ResultHeader As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    'Dim data = obj.GetInvoiceReportHeader(strTest)
                    Dim data = VET.GetInvoiceReportHeaderFromVET(strTest)
                    If data.Count > 0 Then
                        If data(0).ErrorMessage = "" Then
                            Dim HeaderInfo = New XElement("InvoiceHeader",
                                From Header In data
                                Select New XElement("Header", "",
                                New XElement("OrderNo", Header.Order.ToString()),
                                New XElement("Account", Header.Customer),
                                New XElement("BillTo", Header.CustomerName),
                                New XElement("Address1", Header.Address1),
                                New XElement("Address2", Header.Address2),
                                New XElement("Phone", Header.Phone),
                                New XElement("Fax", Header.Fax),
                                New XElement("City", Header.City),
                                New XElement("State", Header.State),
                                New XElement("Country", Header.Country),
                                New XElement("zip", Header.Zip),
                                New XElement("Contact", Header.Contact),
                                New XElement("Shipto", Header.Shipto),
                                New XElement("SalesManName", Header.SalesManName),
                                New XElement("Terms", Header.Terms),
                                New XElement("AWB", Header.AWB),
                                New XElement("Carrier", Header.Carrier),
                                New XElement("Shipdate", Header.ShippingDate),
                                New XElement("PO", Header.PO),
                                New XElement("WH", Header.WH),
                                New XElement("ShiptoAddress", Header.ShiptoAddress),
                                New XElement("ShiptoCity", Header.ShiptoCity),
                                New XElement("ShiptoState", Header.ShiptoState),
                                New XElement("ShiptoZip", Header.ShiptoZip),
                                New XElement("Void", Header.VOID),
                                New XElement("Printed", Header.Printed),
                                New XElement("InvoiceComments", Header.PickRemark)))
                            ResultHeader += HeaderInfo.ToString()
                        Else
                            Dim User As New User
                            If Not Session("LoginUserDetails") Is Nothing Then
                                User = Session("LoginUserDetails")
                            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                                User = Session("LoginAdminDetails")
                            End If
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                Dim data = VET.GetInvoiceReportHeaderFromVET(Order)
                If data.Count > 0 Then
                    If data(0).ErrorMessage = "" Then
                        Dim HeaderInfo = New XElement("InvoiceHeader",
                            From Header In data
                            Select New XElement("Header", "",
                            New XElement("OrderNo", Header.Order.ToString()),
                            New XElement("Account", Header.Customer),
                            New XElement("BillTo", Header.CustomerName),
                            New XElement("Address1", Header.Address1),
                            New XElement("Address2", Header.Address2),
                            New XElement("Phone", Header.Phone),
                            New XElement("Fax", Header.Fax),
                            New XElement("City", Header.City),
                            New XElement("State", Header.State),
                            New XElement("Country", Header.Country),
                            New XElement("zip", Header.Zip),
                            New XElement("Contact", Header.Contact),
                            New XElement("Shipto", Header.Shipto),
                            New XElement("SalesManName", Header.SalesManName),
                            New XElement("Terms", Header.Terms),
                            New XElement("AWB", Header.AWB),
                            New XElement("Carrier", Header.Carrier),
                            New XElement("Shipdate", Header.ShippingDate),
                            New XElement("PO", Header.PO),
                            New XElement("WH", Header.WH),
                            New XElement("ShiptoAddress", Header.ShiptoAddress),
                            New XElement("ShiptoCity", Header.ShiptoCity),
                            New XElement("ShiptoState", Header.ShiptoState),
                            New XElement("ShiptoZip", Header.ShiptoZip),
                            New XElement("Void", Header.VOID),
                            New XElement("Printed", Header.Printed),
                            New XElement("InvoiceComments", Header.PickRemark)))
                        Return HeaderInfo.ToString()
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultHeader

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForInvoiceReportHeaderForVET::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreateXMLForInvoiceReportDetailForVET(ByVal Order As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim ResultDetails As String = ""
            Dim SelectedRecordsCount As Integer = 0
            Dim stringSeparators() As String = {","}
            Dim OrderList() As String
            OrderList = Order.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            Dim arrlst As New ArrayList()
            arrlst.AddRange(OrderList)
            Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
            If (arrlst.Count > TransferSplitingRangeValue) Then
                Dim SplitingIndex As Integer = 0
                Dim SplitingTimesCount As Integer = Math.Ceiling(arrlst.Count / TransferSplitingRangeValue)
                Dim i As Integer = 0
                For i = 0 To SplitingTimesCount - 1
                    If (arrlst.Count - SplitingIndex) < TransferSplitingRangeValue Then
                        TransferSplitingRangeValue = arrlst.Count - SplitingIndex
                    End If
                    Dim SplitOrderByHeaderId As ArrayList = arrlst.GetRange(SplitingIndex, TransferSplitingRangeValue)
                    SplitingIndex = SplitingIndex + (SplitOrderByHeaderId.Count)

                    Dim strTest As String = ""
                    strTest = String.Join(",", SplitOrderByHeaderId.ToArray())
                    Dim data = VET.GetInvoiceReportDetailFromVET(strTest)
                    'Dim data = obj.GetInvoiceReportDetail(strTest)
                    If data.Count > 0 Then
                        If data(0).ErrorMessage = "" Then
                            Dim DetailInfo = New XElement("InvoiceDetail",
                            From Detail In data
                            Select New XElement("Detail", "",
                            New XElement("OrderNo", Detail.Order.ToString()),
                            New XElement("Flower", Detail.FlowerDetails.Flower),
                            New XElement("Category", Detail.FlowerDetails.CAT),
                            New XElement("Name", Detail.FlowerDetails.Name),
                            New XElement("FarmCode", Detail.FarmDetails.FarmCode),
                            New XElement("UOM", Detail.UOM),
                            New XElement("Boxes", Detail.Boxes1),
                            New XElement("UnitsPerBox", Detail.Units),
                            New XElement("Units", Detail.TotalUnits1),
                            New XElement("FOB", Detail.FOB),
                            New XElement("Amount", Detail.Amount),
                            New XElement("Cubes", Detail.Cubes),
                            New XElement("Type", Detail.Type),
                            New XElement("UserID", User.ID)))
                            'New XElement("UPC", Detail.item("UPC")),
                            'New XElement("DATECODE", Detail.item("DATECODE")),
                            'New XElement("BOXCODE", Detail.item("BOXCODE")),

                            ResultDetails += DetailInfo.ToString()
                        Else
                            Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                            Return "error"
                        End If
                    Else
                        Return "No Data"
                    End If
                Next
            Else
                'Dim data = obj.GetInvoiceReportDetail(Order)
                Dim data = VET.GetInvoiceReportDetailFromVET(Order)
                If data.Count > 0 Then
                    If data(0).ErrorMessage = "" Then
                        Dim DetailInfo = New XElement("InvoiceDetail",
                        From Detail In data
                        Select New XElement("Detail", "",
                        New XElement("OrderNo", Detail.Order.ToString()),
                        New XElement("Flower", Detail.FlowerDetails.Flower),
                        New XElement("Category", Detail.FlowerDetails.CAT),
                        New XElement("Name", Detail.FlowerDetails.Name),
                        New XElement("FarmCode", Detail.FarmDetails.FarmCode),
                        New XElement("UOM", Detail.UOM),
                        New XElement("Boxes", Detail.Boxes1),
                        New XElement("UnitsPerBox", Detail.Units),
                        New XElement("Units", Detail.TotalUnits1),
                        New XElement("FOB", Detail.FOB),
                        New XElement("Amount", Detail.Amount),
                        New XElement("Cubes", Detail.Cubes),
                        New XElement("Type", Detail.Type),
                        New XElement("UserID", User.ID)))
                        Return DetailInfo.ToString()
                    Else
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return "error"
                    End If
                Else
                    Return "No Data"
                End If
            End If
            Return ResultDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreateXMLForInvoiceReportDetailForVET::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function VETOrderConsolView(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal Invoice As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim whereCondition As String = ""

            If Invoice <> "" Then
                If lReadFromSQL = False Then
                    whereCondition = "Invoice=" + Invoice + "And Type <> 'K'"
                Else
                    whereCondition = "Invoice=" + Invoice + "And Type <> 'K'"
                End If
            Else
                If (Filter <> "") Then
                    whereCondition = "Type <> 'K' And [Order]<>'0' And " + Filter + ""
                Else
                    whereCondition = "Type <> 'K' And [Order]<>'0'"
                End If
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim TotalRowCount As Integer = 0
                Dim data = Nothing

                data = VET.GetVETOrderConsolList(whereCondition, "Flower asc", start, rp, User.ID)
                TotalRowCount = data.count

                If TotalRowCount > 0 Then
                    Dim dt1 As DataTable = ConvertToDataTable(data)
                    If dt1(TotalRowCount - 1)("ErrorMessage").ToString() = "" Then

                        Dim selectedColumns As String() =
                                    {"Invoice", "Flower", "Description", "Farm", "Boxes", "UOM", "Units", "TotalUnits1", "FOB",
                                     "TotPerLine", "Dimensions", "Cubes", "Weight"}

                        Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                        dt.Columns("Invoice").ColumnName = "INV#"
                        dt.Columns("TotPerLine").ColumnName = "Total$"
                        dt.Columns("TotalUnits1").ColumnName = "TotalUnits"
                        dt.Rows.RemoveAt(dt.Rows.Count - 1)
                        Dim dtCloned As DataTable = dt.Clone()
                        For Each row As DataRow In dt.Rows
                            dtCloned.ImportRow(row)
                        Next
                        Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                        Return BuildXmlDoc(filepath)

                    Else
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt1(TotalRowCount - 1)("ErrorMessage").ToString(), "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Return Nothing
                End If
            Else
                Dim data As List(Of VET_) = VET.GetVETOrderConsolList(whereCondition, "Flower asc", start, rp, User.ID)
                If data(0).ErrorMessage = "" Then

                    Dim SelectedPOs As New ArrayList
                    Dim TotalRowCount As Integer = 0

                    TotalRowCount = data(0).TotalRows.ToString()

                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    Dim FlowerColorVisibility As Boolean = False
                    For Each i In UserFeatures
                        If i.Name.ToLower = "show flower color" Then
                            FlowerColorVisibility = i.Value
                        End If
                    Next


                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", IIf(row.Invoice = "0", "", Convert.ToString(row.Invoice))),
                       New XElement("cell", Convert.ToString(row.Flower)),
                       New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Bgcolor.ToString() + "' class='flowerDescription'><a id='VETDetailName_" & Convert.ToString(row.ID) & "'  style='color:" + row.Fontcolor.ToString() + ";'>" + row.Description + "</a></div>", "<a >" + row.Description.ToString() + "</a>")),
                       New XElement("cell", row.Farm.ToString().ToString()),
                       New XElement("cell", "<a id='VETDetailBoxes_" & Convert.ToString(row.ID) & "' >" + Convert.ToString(row.Boxes) + "</a>"),
                       New XElement("cell", "<a id='VETDetailUOM_" & Convert.ToString(row.ID) & "' >" + Convert.ToString(row.UOM) + "</a>"),
                       New XElement("cell", "<a id='VETDetailUnits_" & Convert.ToString(row.ID) & "' >" + IIf(Convert.ToString(row.Units) = "0", "", Convert.ToString(row.Units)) + "</a>"),
                       New XElement("cell", IIf(Convert.ToString(row.TotalUnits1) = "0", "", row.TotalUnits1)),
                       New XElement("cell", IIf(row.FOB.ToString() = "0", "", row.FOB.ToString("#,##0.00"))),
                       New XElement("cell", IIf(row.TotPerLine.ToString() = "0", If(row.RowNo = 0, row.TotPerLine.ToString("#,##0.00"), "0"), If(row.RowNo = 0, row.TotPerLine.ToString("#,##0.00"), row.TotPerLine.ToString("#,##0.00")))),
                       New XElement("cell", row.Dimensions),
                       New XElement("cell", IIf(row.Cubes.ToString() = "0", "", row.Cubes.ToString("#,##0.000"))),
                       New XElement("cell", IIf(row.Weight.ToString() = "0", "", row.Weight.ToString("#,##0.00"))),
                       New XElement("cell", "<span id='VETDetailCAT_" & Convert.ToString(row.ID) & "'>" + row.CAT + "</span>"),
                       New XElement("cell", "<span id='VETDetailColor_" & Convert.ToString(row.ID) & "'>" + row.Color + "</span>"),
                       New XElement("cell", "<span id='VETDetailVariety_" & Convert.ToString(row.ID) & "'>" + row.VARIETY + "</span>"),
                       New XElement("cell", "<span id='VETDetailGrade_" & Convert.ToString(row.ID) & "'>" + row.GRADE + "</span>")))))


                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))

                    Return newDoc
                Else
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::VETOrderConsolView::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function VETOrderCATSUMM(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal Invoice As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim whereCondition As String = ""

            If Invoice <> "" Then
                whereCondition = "[Invoice]=" + Invoice + "And vw.Type <> 'K'"
            Else
                If (Filter <> "") Then
                    whereCondition = "vw.Type <> 'K' And [Order]<>'0' And " + Filter + ""
                Else
                    whereCondition = "vw.Type <> 'K' And [Order]<>'0'"
                End If
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            Dim data = Nothing

            data = VET.GetVETOrderCATSUMMList(whereCondition, "Flower asc", start, rp)
            Dim dt As DataTable = ConvertToDataTable(data)

            If dt.Rows.Count > 0 Then

                If dt(0)("ErrorMessage").ToString() = "" Then


                    Dim TotalRowCount As Integer = 0

                    If dt.Rows.Count > 0 Then
                        TotalRowCount = dt(0)("TotalRows").ToString()
                    End If

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                    New XElement("rows", New XElement("page", page.ToString()),
                    New XElement("total", TotalRowCount),
                    From row In dt.Rows()
                    Select
                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                    New XElement("cell", row("CAT")),
                    New XElement("cell", row("NAME")),
                    New XElement("cell", row("Bunches")),
                    New XElement("cell", row("Units")),
                    New XElement("cell", row("Amount")),
                    New XElement("cell", row("Cubes")),
                    New XElement("cell", row("Weight")),
                    New XElement("cell", IIf(row("BoxLength") = "0" Or row("BoxWidth") = "0" Or row("BoxHeight") = "0", "<a style='background-color:red;' id='OrderDetailDimensions_" & Convert.ToString(row("ID")) & "' >" + row("Dimensions") + "</a>", "<a id='OrderDetailDimensions_" & Convert.ToString(row("ID")) & "' >" + row("Dimensions") + "</a>")))))


                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))

                    Return newDoc
                Else
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Return Nothing
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::OrderDetailConsolView::PageOrder")
            Return Nothing
        End Try
    End Function

#End Region

#Region "F_SLSMAN"
    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportF_SLSMANfromDBF(ByVal TableName As String, ByVal SpName As String) As String
    '    Try
    '        Dim ConStr As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
    '        'Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
    '        Dim result = obj.ImportDBFtoSQLfromService(TableName, SpName, 1, 0, True, ConStr, 5000)

    '        Return result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportF_SLSMANfromDBF::PageFlowers")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSlsmanControlNum(ByVal Salesman As String) As List(Of SalesPersons)
        Try
            Return SalesPerson.GetSlsmanControlNum(Salesman)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSlsmanControlNum::PageOrder")
            Throw ex
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetSLSMANPONum(ByVal Salesman As String) As String
    '    Try
    '        Return obj.GetSLSMANPONum(Salesman)
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetSLSMANPONum")
    '        Throw ex
    '    End Try
    'End Function


#End Region

#Region "F_CUST"
    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportF_CUSTfromDBF(ByVal TableName As String, ByVal SpName As String) As String
    '    Try
    '        Dim ConStr As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
    '        'Dim TransferSplitingRangeValue As Integer = Convert.ToInt32(ConfigurationManager.AppSettings("TransferSplitingRangeValue").ToString())
    '        Dim result = obj.ImportDBFtoSQLfromService(TableName, SpName, 1, 0, True, ConStr, 5000)

    '        Return result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportF_CUSTfromDBF::PageFlowers")
    '        Throw ex
    '    End Try
    'End Function
#End Region

#Region "F_Emails"


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetEmailDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.CrCode), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New F_Emails
            Dim data As List(Of BO.F_Emails) = obj.GetF_EmailsListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"TYPE", "EMAILS"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("TYPE").ColumnName = "TYPE"
                dt.Columns("EMAILS").ColumnName = "EMAILS"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "F_EmailsDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteEmail_" & row.ID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditEmail_" & row.ID & "'/>"),
                                        New XElement("cell", row.TYPE),
                                        New XElement("cell", row.EMAILS)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetEmailDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveEmail(ByVal ID As String, ByVal Type As String, ByVal Emails As String) As String
        Try
            Dim EmailID As String = ""

            If (ID = "0") Then
                EmailID = F_Emails.InsertF_Emails(Type, Emails)
            Else

                F_Emails.UpdateF_Emails(ID, Type, Emails)
                EmailID = Convert.ToInt32(ID)
            End If
            If (Not Type.Contains("UNIQUE KEY constraint")) Then
                Return EmailID
            Else
                Return EmailID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCreditCode::PageCreditCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetF_EmailsByID(ByVal ID As Integer) As List(Of BO.F_Emails)
        Try
            Dim data As List(Of BO.F_Emails) = F_Emails.GetF_EmailsByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditCodeByID::PageCreditCode")
            Throw ex
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function DeleteF_EmailsebyID(ByVal ID As String) As String
        Try
            Return F_Emails.DeleteF_EmailsbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCreditCodebyID::PageCreditCode")
            Return Nothing
        End Try
    End Function

#End Region
#Region "CREREQ"

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditDetails(ByVal ID As String, ByVal CalledFromVET As String) As List(Of Credits)
        Try
            If (CalledFromVET = "1") Then
                Return F_CREREQ.GetCreditDetailsFromVET(ID)
            Else
                Return F_CREREQ.GetCreditDetailsFromFOrder(ID)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditDetails::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCreditRequestDetails(ID As Integer, TotalUnits As Integer, Price As Decimal, Freight As Decimal, CreditCode As String, Reason As String, Control As Integer, CreditFileNames As String, CREREQID As Integer, ByVal Fuel As String, ByVal Taxes As String, ByVal Source As String) As Integer
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim newCREREQID As Integer

            ' ID is the id from VET_
            ' CreditID is the id from F_CREREQ table ,  in this case it will be 0 since we are adding
            '
            newCREREQID = F_CREREQ.SaveCreditRequestDetails(ID, TotalUnits, Price, Freight, CreditCode, Reason, Control, CreditFileNames, LoginUserDetails.Name, CREREQID, Fuel, Taxes, Source)
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()

            If CompanyName <> "Misty Flowers" And (LoginUserDetails.ORDER.Replace(" ", "").Substring(78, 1) = "Y") Then

                F_CREREQ.UpdateCreditStatus(newCREREQID, "P", LoginUserDetails.Name)
                F_CREREQ.UpdateCreditStatus(newCREREQID, "A", LoginUserDetails.Name)
                '  Pass 0 as invoice and 
                UpdateCreditStatus(newCREREQID, "A", ID, 0, DateTime.Now, ((TotalUnits * Price) + Freight + Fuel + Taxes), Reason)
            End If

            If CreditFileNames <> "" Then
                If CREREQID = 0 Then
                    MoveImgFiles(ID, newCREREQID)
                End If
            End If


            Return newCREREQID
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCreditRequestDetails::PageOrder")
            Return Nothing
        End Try
    End Function
    '<System.Web.Services.WebMethod(True)>
    'Public Function CheckCreditUnitLimits(InvoiceNo As Integer) As Integer
    '    Try
    '        Dim LoginUserDetails As New User

    '        If Not Session("LoginUserDetails") Is Nothing Then
    '            LoginUserDetails = Session("LoginUserDetails")
    '        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '            LoginUserDetails = Session("LoginAdminDetails")
    '        End If
    '        Dim newCRREQID As Integer
    '        newCRREQID = F_CREREQ.GetCreditUnitLimitsByInvoiceNo(InvoiceNo)
    '        Return newCRREQID
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::CheckCreditUnitLimits::PageOrder")
    '        Return Nothing
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function MoveImgFiles(VETID As Integer, CREREQID As Integer) As String
        Try
            Dim srcMainFolderName = String.Format(ConfigurationManager.AppSettings("CreditRequestPath"), "VET", VETID)
            Dim srcSysPath As String = HttpContext.Current.Server.MapPath("~/" + srcMainFolderName + "/")

            Dim destMainFolderName = String.Format(ConfigurationManager.AppSettings("CreditRequestPath"), "CREREQ", CREREQID)
            Dim destSysPath As String = HttpContext.Current.Server.MapPath("~/" + destMainFolderName + "/")

            If Not System.IO.Directory.Exists(destSysPath) Then
                System.IO.Directory.CreateDirectory(destSysPath)
            End If

            For Each srcFiles As String In Directory.GetFiles(Path.GetDirectoryName(srcSysPath))
                File.Move(srcFiles, destSysPath + "\" + Path.GetFileName(srcFiles))
            Next

            If Not File.Exists(srcSysPath) Then
                Directory.Delete(srcSysPath)
            End If

            'File.Move(srcSysPath, destSysPath)

            Return Nothing
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::MoveImgFiles::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCreditRequestInvoiceDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Invoice As String, ByVal ExportCSV As String) As XmlDocument

        Try

            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(VET_), qtype, query)
            End If

            If Invoice IsNot Nothing And Invoice <> "" Then
                whereCondition = IIf(whereCondition = "", "Invoice=" + Invoice, whereCondition + " and Invoice= " + Invoice)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New F_CREREQ


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Credits) = obj.GetCreditRequestInvoiceDetailsList(whereCondition, sortExp, start, rp)

                'Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                'Dim selectedColumns As String() = {"Invoice", "Customer", "Flower", "Description", "Slsname", "Farm", "AWB", "Boxes", "UOM", "Units",
                '                                    "TotalUnits", "FOB", "Totperline", "Type", "gpm", "BoxNum", "BoxCode", "UPC", "PODFlower"}

                'Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'dt.Columns("Customer").ColumnName = "CUST#"
                'dt.Columns("Slsname").ColumnName = "SLS"
                'dt.Columns("Totperline").ColumnName = "Total"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                'Dim dtCloned As DataTable = dt.Clone()
                ''dtCloned.Columns("Date").DataType = GetType(String)
                ''dtCloned.Columns("Time").DataType = GetType(String)
                'For Each row As DataRow In dt.Rows
                '    dtCloned.ImportRow(row)
                'Next
                'Dim filepath = ExporttoExcel(dtCloned, "OrdVET$VETInv")
                'Return BuildXmlDoc(filepath)
                Return Nothing
            Else
                Dim data As List(Of Credits) = obj.GetCreditRequestInvoiceDetailsList(whereCondition, sortExp, start, rp)

                If data(0).ErrorMessage = "" Then

                    Dim SelectedPOs As New ArrayList
                    Dim TotalRowCount As Integer = 0

                    TotalRowCount = data(0).TotalRows.ToString()

                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    Dim FlowerColorVisibility As Boolean = False
                    For Each i In UserFeatures
                        If i.Name.ToLower = "show flower color" Then
                            FlowerColorVisibility = i.Value
                        End If
                    Next
                    Dim sql = IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:'" + data(0).Bgcolor + "'' class='flowerDescription'><a style='color:'" + data(0).Fontcolor + "''>" + data(0).FlowerName + "</a></div>", "<a >" + data(0).FlowerName + "</a>")
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.RowNo), New XAttribute("background-color", ""), New XAttribute("color", ""),
                        New XElement("cell", "<a href='#' id='PrintCredit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(row.VETID = 0, "", row.VETID.ToString()) & "~" & IIf(Invoice = "0", "", Invoice) & "' style='cursor:pointer;'><img href='#' src='images/Print.png' style='cursor:pointer'/></a>"),
                        New XElement("cell", "<a href='#' id='editCredit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(row.VETID = 0, "", row.VETID.ToString()) & "~" & IIf(Invoice = "0", "", Invoice) & "~" & IIf(row.Status = "", "", row.Status.ToString()) & "' style='cursor:pointer;'><img href='#' src='images/Edit.png' style='cursor:pointer'/></a>"),
                       New XElement("cell", "<a href='#' id='deleteCredit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(row.VETID = 0, "", row.VETID.ToString()) & "~" & IIf(Invoice = "0", "", Invoice) & "~" & IIf(row.Status = "", "", row.Status.ToString()) & "' style='cursor:pointer;'><img href='#' src='images/Delete-icon.png' style='cursor:pointer'/></a>"),
                       New XElement("cell", row.RowNo),
                       New XElement("cell", row.ORDER),
                       New XElement("cell", row.ControlNum),
                       New XElement("cell", row.ADDDATE),
                       New XElement("cell", row.InvDate),
                       New XElement("cell", row.Farm),
                       New XElement("cell", "<span title='Days Fresh'>" + row.DaysFresh + "</span"),
                       New XElement("cell", "<span title='Days credit was applied'>" + row.DaysApplied + "</span>"),
                       New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Bgcolor + "' class='flowerDescription'><a style='color:" + row.Fontcolor + "'>" + row.FlowerName + "</a></div>", "<a>" + row.FlowerName + "</a>")),
                       New XElement("cell", IIf(row.TotalUnits = 0, "", row.TotalUnits)),
                       New XElement("cell", row.Price.ToString("#,##0.00")),
                       New XElement("cell", row.Status),
                       New XElement("cell", row.Applied),
                       New XElement("cell", row.REASON)))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1

                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = "Total Credits"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerTex= ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""

                    Return newDoc
                Else
                    'Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditRequestInvoiceDetailsList::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCreditRequestsbyCustomer(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Customer As String, ByVal ExportCSV As String) As XmlDocument

        Try

            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(VET_), qtype, query)
            End If

            If Customer IsNot Nothing And Customer <> "" Then
                whereCondition = IIf(whereCondition = "", "Customer=" + Customer, whereCondition + " and Customer= " + Customer)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New F_CREREQ


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Credits) = obj.GetCreditRequetsbyCustomer(whereCondition, sortExp, start, rp)

                'Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                'Dim selectedColumns As String() = {"Invoice", "Customer", "Flower", "Description", "Slsname", "Farm", "AWB", "Boxes", "UOM", "Units",
                '                                    "TotalUnits", "FOB", "Totperline", "Type", "gpm", "BoxNum", "BoxCode", "UPC", "PODFlower"}

                'Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'dt.Columns("Customer").ColumnName = "CUST#"
                'dt.Columns("Slsname").ColumnName = "SLS"
                'dt.Columns("Totperline").ColumnName = "Total"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                'Dim dtCloned As DataTable = dt.Clone()
                ''dtCloned.Columns("Date").DataType = GetType(String)
                ''dtCloned.Columns("Time").DataType = GetType(String)
                'For Each row As DataRow In dt.Rows
                '    dtCloned.ImportRow(row)
                'Next
                'Dim filepath = ExporttoExcel(dtCloned, "OrdVET$VETInv")
                'Return BuildXmlDoc(filepath)
                Return Nothing
            Else
                Dim data As List(Of Credits) = obj.GetCreditRequetsbyCustomer(whereCondition, sortExp, start, rp)

                If data(0).ErrorMessage = "" Then

                    Dim SelectedPOs As New ArrayList
                    Dim TotalRowCount As Integer = 0

                    TotalRowCount = data(0).TotalRows.ToString()

                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    Dim FlowerColorVisibility As Boolean = True
                    'For Each i In UserFeatures
                    '    If i.Name.ToLower = "show flower color" Then
                    '        FlowerColorVisibility = i.Value
                    '    End If
                    'Next
                    'Modified by Anubhuti 2023_05_15
                    Dim sql = IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:'" + data(0).Bgcolor + "'' class='flowerDescription'><a style='color:'" + data(0).Fontcolor + "''>" + data(0).FlowerName + "</a></div>", "<a >" + data(0).FlowerName + "</a>")
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                       data.Select(Function(row) New XElement("row", New XAttribute("id", row.RowNo), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", "<a href='#' id='PrintCredit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(row.VETID = 0, "", row.VETID.ToString()) & "~" & row.ORDER & "' style='cursor:pointer;'><img href='#' src='images/Print.png' style='cursor:pointer'/></a>"),
                       New XElement("cell", "<a href='#' id='editCredit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(row.VETID = 0, "", row.VETID.ToString()) & "~" & row.ORDER & "~" & IIf(row.Status = "", "", row.Status.ToString()) & "' style='cursor:pointer;'><img href='#' src='images/Edit.png' style='cursor:pointer'/></a>"),
                       New XElement("cell", "<a href='#' id='deleteCredit_" & IIf(row.ID = 0, "", row.ID.ToString()) & "~" & IIf(row.VETID = 0, "", row.VETID.ToString()) & "~" & row.ORDER & "~" & IIf(row.Status = "", "", row.Status.ToString()) & "' style='cursor:pointer;'><img href='#' src='images/Delete-icon.png' style='cursor:pointer'/></a>"),
                       New XElement("cell", row.RowNo),
                       New XElement("cell", row.ORDER),
                       New XElement("cell", row.ControlNum),
                       New XElement("cell", row.ADDDATE),
                       New XElement("cell", row.InvDate),
                       New XElement("cell", row.Farm),
                       New XElement("cell", "<span title='Days Fresh'>" + row.DaysFresh + "</span"),
                       New XElement("cell", "<span title='Days credit was applied'>" + row.DaysApplied + "</span>"),
                       New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Bgcolor + "' class='flowerDescription'><a style='color:" + row.Fontcolor + "'>" + row.FlowerName + "</a></div>", "<a>" + row.FlowerName + "</a>")),
                       New XElement("cell", IIf(row.TotalUnits = 0, "", row.TotalUnits)),
                       New XElement("cell", row.Price.ToString("#,##0.00")),
                       New XElement("cell", row.Status),
                       New XElement("cell", row.Applied),
                       New XElement("cell", row.REASON)))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1

                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = "Total Credits"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerTex= ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""

                    Return newDoc
                Else
                    'Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditRequetsbyCustomer::PageOrder")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function CheckCreditAppliedStatus(ByVal ID As String, ByVal Order As String) As List(Of Credits)
        Try

            Return F_CREREQ.CheckCreditAppliedStatus(ID, Order)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckCreditAppliedStatus::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditDetailsFromCREREQ(ByVal ID As String, ByVal VETID As String, ByVal Invoice As String) As List(Of Credits)
        Try

            Return F_CREREQ.GetCreditDetailsFromCREREQ(ID, VETID, Invoice)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditDetailsFromCREREQ::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCreditRequestDetails(CREREQID As Integer, VETID As Integer) As String
        Try

            Dim res = F_CREREQ.DeleteCreditRequestDetails(CREREQID, VETID)
            If res = "Success" Then
                Dim destMainFolderName = String.Format(ConfigurationManager.AppSettings("CreditRequestPath"), "CREREQ", CREREQID)
                Dim destSysPath As String = HttpContext.Current.Server.MapPath("~/" + destMainFolderName + "/")
                If (System.IO.Directory.Exists(destMainFolderName)) Then
                    For Each destFiles As String In Directory.GetFiles(destSysPath)
                        File.Delete(destFiles)
                    Next
                    Directory.Delete(destSysPath)
                End If
            End If
            Return res

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCreditRequestDetails::PageOrder")
            Return Nothing
        End Try
    End Function

    'Added by Anubhuti 2023_05_13
    <System.Web.Services.WebMethod(True)>
    Public Function ReverseCreditRequestDetails(CREREQID As Integer) As String
        Try

            Dim res = F_CREREQ.ReverseCreditRequestDetails(CREREQID)
            Return res

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ReverseCreditRequestDetails::PageARINVS")
            Return Nothing
        End Try
    End Function

#End Region

#Region "CRCODE"
    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportF_CRCODEfromDBF(ByVal TableName As String, ByVal SpName As String) As String
    '    Try
    '        Dim ConStr As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()
    '        Dim result = obj.ImportDBFtoSQLfromService(TableName, SpName, 1, 0, True, ConStr, 5000)
    '        Return result
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ImportF_CRCODEfromDBF::PageFlowers")
    '        Return "error"
    '    End Try
    'End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadCreditCode() As List(Of Credits)
        Try
            Return F_CRCODE.LoadCreditCode()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadCreditCode::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCreditCodeDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.CrCode), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New CrCode
            Dim data As List(Of BO.CrCode) = obj.GetCreditCodeListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"CODE", "REASON", "CHARGEGROW", "RETURNINV", "GLACCOUNT"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("CODE").ColumnName = "CODE"
                dt.Columns("REASON").ColumnName = "REASON"
                dt.Columns("CHARGEGROW").ColumnName = "CHARGE GROW"
                dt.Columns("RETURNINV").ColumnName = "RETURN INV"
                dt.Columns("GLACCOUNT").ColumnName = "GL ACCOUNT"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "CreditCodeDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteCreditCode_" & row.ID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditCreditCode_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.CODE)),
                                        New XElement("cell", row.REASON),
                                        New XElement("cell", row.CHARGEGROW),
                                        New XElement("cell", row.RETURNINV),
                                        New XElement("cell", row.GLACCOUNT)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditCodeDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCreditCode(ByVal ID As String, ByVal Code As String, ByVal Reason As String, ByVal ChargeRow As String, ByVal ReturnInv As String,
    ByVal GlaAccount As String) As String
        Try
            Dim CreditCodeID As String = ""

            If (ID = "0") Then
                CreditCodeID = CrCode.InsertCreditCode(Code, Reason, ChargeRow, ReturnInv, GlaAccount)
            Else

                CrCode.UpdateCreditCode(ID, Code, Reason, ChargeRow, ReturnInv, GlaAccount)
                CreditCodeID = Convert.ToInt32(ID)
            End If
            If (Not Code.Contains("UNIQUE KEY constraint")) Then
                Return CreditCodeID
            Else
                Return CreditCodeID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCreditCode::PageCreditCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditCodeByID(ByVal ID As Integer) As List(Of BO.CrCode)
        Try
            Dim data As List(Of BO.CrCode) = CrCode.GetCreditCodeByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditCodeByID::PageCreditCode")
            Throw ex
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCreditCodebyID(ByVal ID As String) As String
        Try
            Return CrCode.DeleteCreditCodebyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCreditCodebyID::PageCreditCode")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Credits"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPendingInfoDetails(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal ExportCSV As String) As XmlDocument

        Try

            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Credits), qtype, query)
            End If

            Dim FromDate As String = ""
            Dim ToDate As String = ""

            If Filter IsNot Nothing And Filter <> "" Then
                Dim FilterSplit = Filter.Split("$")
                If FilterSplit.Length = 3 Then
                    Filter = FilterSplit(0)
                    FromDate = FilterSplit(1)
                    ToDate = FilterSplit(2)
                Else
                    Filter = FilterSplit(0)
                End If

                Dim FilterCond As String = ""
                If Filter = "SalesMgr" Then
                    FilterCond = "cr.status='P' and isnull(cr.salesmang,'')=''"
                ElseIf Filter = "CrMgr" Then
                    FilterCond = "cr.status='P' and isnull(cr.salesmang,'')<>'' and cr.applied=0"
                ElseIf Filter = "Denied" Then
                    FilterCond = "cr.status='D' and cr.applied=0"
                ElseIf Filter = "Approved" Then
                    FilterCond = "cr.status='A' and cr.applied=0"
                ElseIf Filter = "Limbo" Then
                    FilterCond = "cr.status='L' and TransDate between convert(datetime, '" + FromDate + "', 101)  and convert(datetime, '" + ToDate + "', 101) "
                ElseIf Filter = "Every" Then
                    FilterCond = "cr.status<>'L' and cr.status<>'P' and TransDate between convert(datetime, '" + FromDate + "', 101)  and convert(datetime, '" + ToDate + "', 101) "
                ElseIf Filter = "Applied" Then
                    FilterCond = "cr.status<>'L' and cr.applied=1 and TransDate between convert(datetime, '" + FromDate + "', 101)  and convert(datetime, '" + ToDate + "', 101) "
                End If
                whereCondition = IIf(whereCondition = "", FilterCond, " and " + FilterCond)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New F_CREREQ


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Credits) = obj.GetPendingInfoDetailsList(whereCondition, sortExp, start, rp)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Customer", "CustName", "Order", "InvDate", "TransDate", "CODE", "CreditDesc", "REASON", "Salesman", "Farm", "FarmName", "Flower", "FlowerName", "AWB", "Boxes", "UOM", "Units", "TotalUnits", "Price", "GrowerAmt", "ControlNum", "Status", "DateRec", "DaysFresh", "FarmInv", "FOB", "UnitCost", "Packing", "ImpCost", "Freight", "Fuel", "Fumigation", "AntiDump", "ADDUSER", "ADDDATE", "ADDTIME", "Salesmang", "SMDATE", "SMTIME", "APPROVEDBY", "APPROVEDDA", "APPROVEDTI", "DENIEDBY", "DENIEDDATE", "DENIEDTIME", "DENIEDREAS", "GrowerAmtTotal"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Customer").ColumnName = "CUST#"
                dt.Columns("Order").ColumnName = "Invoice"
                dt.Columns("CODE").ColumnName = "Credit Code"
                dt.Columns("Salesman").ColumnName = "Sales Person"
                dt.Columns("FlowerName").ColumnName = "Product Description"

                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("InvDate").DataType = GetType(String)
                dtCloned.Columns("TransDate").DataType = GetType(String)
                'dtCloned.Columns("Time").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "Credits$Credits")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of Credits) = obj.GetPendingInfoDetailsList(whereCondition, sortExp, start, rp)
                If data.Count > 0 Then
                    If data(0).ErrorMessage = "" Then

                        Dim SelectedPOs As New ArrayList
                        Dim TotalRowCount As Integer = 0

                        TotalRowCount = data(0).TotalRows.ToString()

                        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        Dim FlowerColorVisibility As Boolean = False
                        For Each i In UserFeatures
                            If i.Name.ToLower = "show flower color" Then
                                FlowerColorVisibility = i.Value
                            End If
                        Next
                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", TotalRowCount),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer'/>"),
                       New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer'/>"),
                       New XElement("cell", row.ID),
                       New XElement("cell", row.Customer),
                       New XElement("cell", row.CustName),
                       New XElement("cell", row.ORDER),
                       New XElement("cell", row.InvDate),
                       New XElement("cell", row.TransDate),
                       New XElement("cell", row.CODE),
                       New XElement("cell", row.Salesman),
                       New XElement("cell", row.Farm),
                       New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Bgcolor + "' class='flowerDescription'><a style='color:" + row.Fontcolor + "'>" + row.FlowerName + "</a></div>", "<a>" + row.FlowerName + "</a>")),
                       New XElement("cell", IIf(row.AWB = "" Or row.AWB Is DBNull.Value, "", FormatAWBnumber(row.AWB))),
                       New XElement("cell", row.GrowerAmt),
                       New XElement("cell", "$" + Convert.ToDecimal(row.GrowerAmtTotal).ToString("#,##0.00"))))))

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(xmlDoc.ToString())
                        Dim idx As Integer = data.Count - 1

                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = "Total"
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                        newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                        'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""

                        Return newDoc
                    Else
                        'Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                       New XElement("rows", New XElement("page", page.ToString()),
                       New XElement("total", data.Count),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", ""), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", ""),
                       New XElement("cell", "")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Return newDoc
                End If
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPendingInfoDetails::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditDetailsByOption(ByVal CreditOpt As String, ByVal CREREQID As String) As List(Of Credits)
        Try
            Return F_CREREQ.GetCreditDetailsListByOption(CreditOpt, CREREQID)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditDetailsByOption::PageCredits")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' ANITHA :: 05-Oct-2018 :: from credits insert into f_arinvs
    ''' </summary>
    ''' <param name="CREREQID"></param>
    ''' <param name="Status"></param>
    ''' <param name="Customer"></param>
    ''' <param name="Invoice"></param>
    ''' <param name="InvDate"></param>
    ''' <param name="Amount"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCreditStatus(CREREQID As String, Status As String, Customer As String, Invoice As String, ByVal InvDate As String, ByVal Amount As String, ByVal Reason As String) As String
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            F_CREREQ.UpdateCreditStatus(CREREQID, Status, LoginUserDetails.Name)

            If Status = "A" Then
                Try
                    Dim CurrentDate = DateTime.Now.ToString("MM/dd/yyyy")
                    If Invoice = 0 Then
                        Dim data As List(Of Credits) = F_CREREQ.GetInvoicefromCreditRequest(CREREQID)
                        Payments.WRTAR(data(0).INVOICE.ToString(), CurrentDate, "6", 0, Amount, data(0).Customer.ToString(), 0.0, 0, "", LoginUserDetails.Name, Reason)
                    Else
                        Payments.WRTAR(Invoice, CurrentDate, "6", 0, Amount, Customer, 0.0, 0, "", LoginUserDetails.Name, Reason)
                    End If
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in Service::WRTAR::UpdateCreditStatus")
                    Return Nothing
                End Try

                Try
                    F_CREREQ.InsertintoF_SLSCHG(CREREQID, "F", LoginUserDetails.Name)
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in Service::InsertintoF_SLSCHG::UpdateCreditStatus")
                    Return Nothing
                End Try
            End If
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCreditStatus::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCreditRequest(CREREQID As String) As String
        Try
            Return F_CREREQ.DeleteCreditRequest(CREREQID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCreditRequest::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCreditDetails(ID As String, VETID As String, TotalUnits As String, TotalCrReqAmt As String, TotGrowerAmt As String, Price As String, UnitCost As String, Packing As String, ImportCost As String, Freight As String, Fumigation As String, AntiDump As String, Fuel As String, Reason As String, TabName As String, DeniedReason As String) As String
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Return F_CREREQ.UpdateCreditDetails(ID, VETID, TotalUnits, TotalCrReqAmt, TotGrowerAmt, Price, UnitCost, Packing, ImportCost, Freight, Fumigation, AntiDump, Fuel, LoginUserDetails.Name, Reason, TabName, DeniedReason)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCreditDetails::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCreditDetailsWithImages(ID As String, VETID As String, TotalUnits As String, TotalCrReqAmt As String, TotGrowerAmt As String, Price As String, UnitCost As String, Packing As String, ImportCost As String, Freight As String, Fumigation As String, AntiDump As String, Fuel As String, Reason As String, TabName As String, DeniedReason As String, CreditFilenames As String) As String
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Return F_CREREQ.UpdateCreditDetailsWithImages(ID, VETID, TotalUnits, TotalCrReqAmt, TotGrowerAmt, Price, UnitCost, Packing, ImportCost, Freight, Fumigation, AntiDump, Fuel, LoginUserDetails.Name, Reason, TabName, DeniedReason, CreditFilenames)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCreditDetails::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function RemoveCreditRequestPic(ID As String, VETID As String, FileName As String) As String
        Try
            Return F_CREREQ.RemoveCreditRequestPic(ID, VETID, FileName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::RemoveCreditRequestPic::PageCredits")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintCreditAdviceRpt(ByVal CREREQID As Integer, ByVal RptName As String) As String
        Try

            Dim filename As String = ""
            Dim CombinedFilePath As String = ""
            Dim foldername As String = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim CombineFileName As String = ""
            Dim FullFileName As String = ""
            Dim filepath As String = ""
            Dim fileNames As String() = {}
            Dim SysPath As String = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()
            Dim XmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()
            Dim PoFiles As New List(Of String)


            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}

            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "CREREQID"
            reportParameterCollection(1).Values.Add(CREREQID)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "RptName"
            reportParameterCollection(2).Values.Add(RptName)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filenamepdf As String = ""

            filenamepdf = RptName + "_" + CREREQID.ToString() + "_" + DateTime.Now.ToString("yyyyMMdd_hhmmssfff") + ".pdf"

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""

            Dim ReportNameForPdf As String = objPdf.ExportToPdf(filenamepdf, "rptCrReqByFarm", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")

            If Not ReportNameForPdf.Trim().Contains("error : ") Then
                'Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filenamepdf), (CompanyName + " " + RptName + " Report by user:" + User.Email + " ip: " + LocalIPAddress.ToString()), "labelnotification")
                Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filenamepdf), (CompanyName + " " + RptName + " Report by user:" + User.Email), "labelnotification")
            End If

            filepath = ReportNameForPdf
            Dim FullPath As String = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")
            filepath = XmlPath.Replace("~/", "").Replace("\", "/") + "/" + filepath.Replace("~/", "").Replace("\", "/")

            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintCreditAdviceRpt")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditRptEmailSub(ByVal CREREQID As Integer) As List(Of Credits)
        Try
            Return F_CREREQ.GetCreditRptEmailSub(CREREQID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditRptEmailSub::PageCredits")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Async Function SendCrReqEmail(ByVal Tomail As String, ByVal Subject As String, ByVal EmailBody As String, ByVal RptURL As String, ByVal RptName As String) As Task(Of String)
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            Return Await Logs.SendMail(User.Email, Tomail, EmailBody, (ReportExportFolder + "\" + RptURL), Subject, "CREDIT", "", "")
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SendCrReqEmail::PageCredits")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function CheckFarmCreditAppliedStatus(ByVal ID As String) As List(Of Credits)
        Try
            Return F_CREREQ.CheckFarmCreditAppliedStatus(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckFarmCreditAppliedStatus::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmCreditsFromCredit(ByVal ID As String, ByVal Screen As String) As List(Of Credits)
        Try
            Return F_CREREQ.GetFarmCreditsFromCredit(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmCreditsFromCredit::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveFarmCreditRequestDetails(ID As String, TotalUnits As Integer, Price As Decimal, Freight As Decimal, CreditCode As String, Reason As String, Control As Integer, CreditFileNames As String, CREREQID As Integer, ByVal Fuel As String, ByVal Taxes As String, ByVal Screen As String) As Integer
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim newCRREQID As Integer
            newCRREQID = F_CREREQ.SaveFarmCreditRequestDetails(ID, TotalUnits, Price, Freight, CreditCode, Reason, Control, CreditFileNames, LoginUserDetails.Name, CREREQID, Fuel, Taxes, Screen)

            If CreditFileNames <> "" Then
                If CREREQID = 0 Then
                    MoveImgFiles(0, newCRREQID)
                Else
                    MoveImgFiles(0, CREREQID)
                End If
                'Filter = "csrec-cssold>0"
            End If


            Return newCRREQID
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFarmCreditRequestDetails::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditDetailsForFarm(ByVal ID As String, ByVal Screen As String) As List(Of Credits)
        Try

            Return F_CREREQ.GetCreditDetailsForFarm(ID, Screen)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditDetailsForFarm::PageInventory")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetImageName(ByVal ID As String, ByVal VETID As String) As String
        Try
            Dim img = F_CREREQ.GetImageName(ID, VETID)
            Dim imgName As New List(Of String)
            For i As Integer = 0 To img.Count - 1
                imgName.Add(img.Item(i).ImageName)
            Next
            Dim ImageName = String.Join(",", imgName)

            Return ImageName
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetImageName::PageCredits")
            Return ""
        End Try
    End Function
#End Region

#Region "Pricing"
    ''' <summary>
    ''' Muthu Nivetha M :: 26Feb2020 :: Modified :: Displaying person details,credit details if exist, GPM
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPricingDetail(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ExportCSV As String) As XmlDocument
        Try
            Session("PricingAllList") = Nothing
            If Filter.ToUpper() <> "ALL" And Filter.ToString() <> "" Then
                Filter = Filter + " and csrec-cssold>0"
            ElseIf Filter.ToUpper() <> "ALL" And Filter.ToString() = "" Then
                Filter = "csrec-cssold>0"
            Else
                Filter = ""
            End If

            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Inventory), qtype, query.Replace("'", "''"))
                If (Filter <> String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition + " And " + Filter.Replace("&amp;", "&")
                ElseIf (Filter Is String.Empty And whereCondition <> String.Empty) Then
                    whereCondition = whereCondition
                End If
            Else
                If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                    whereCondition = Filter.Replace("&amp;", "&")
                ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                    whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
                End If
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If

            If whereCondition <> "" Then
                whereCondition = " where " + whereCondition
            End If
            Dim PricingList = Nothing
            PricingList = Inventory.LoadPricingDetail(whereCondition, sortExp, start, rp)


            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                If PricingList Is Nothing Then
                    Return Nothing
                End If
                If lReadFromSQL = True Then
                    If (TryCast(PricingList, Tuple(Of DataSet, String)).Item1.Tables(1).Rows(0)(0) <= 0) Then
                        Return Nothing
                    End If
                Else
                    If (PricingList.length <= 0) Then
                        Return Nothing
                    End If
                End If
                If Convert.ToString(TryCast(PricingList, Tuple(Of DataSet, String)).Item2) = "success" Then
                    Dim selectedColumns As String() = {"AWB", "WH", "Farm", "ProductCategory", "Color", "Variety", "ProductName", "Qty", "UOM", "Units", "Price", "PriceB", "PriceC", "GPM", "Cost", "OTHERCOST", "HANDLING", "ANDEAN", "LandedCost", "CustNum", "CSHOLD", "Flag", "Days"}
                    Dim dt As DataTable = New DataView(TryCast(PricingList, Tuple(Of DataSet, String)).Item1.Tables(0)).ToTable(False, selectedColumns)
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim filepath = ExporttoExcel(dt, splitExportcsv(1) + "Header")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, PricingList(0).ErrorMessage, "", "Error Notification", "Error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim dtPricingList As New DataSet
                If Not TryCast(PricingList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                    '22March19 :: Abinaya :: Inventory pricing fix-no scrolling, slow response time
                    dtPricingList = TryCast(PricingList, Tuple(Of DataSet, String)).Item1 'ConvertToDataTable(PricingList)
                Else
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If
                Dim FlowerColorVisibility As Boolean = False
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next
                '22March19 :: Abinaya :: Inventory pricing fix-no scrolling, slow response time
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", page.ToString()),
                                       New XElement("total", dtPricingList.Tables(1).Rows(0)(0)),
                                         From row In dtPricingList.Tables(0).Rows()
                                         Select
                                        New XElement("row", New XAttribute("id", row("ID")),
                                       New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='teselect_" & row("ID").ToString() & "' src='images/check-off.png' />")),
                                       New XElement("cell", "<span id='invenWH_" & row.Item("ID") & "'>" + row.Item("WH") + "</span>"),
                                       New XElement("cell", row("AWB")),
                                       New XElement("cell", row("Farm")),
                                       New XElement("cell", "<span id='invenCAT_" & row.Item("ID") & "'>" + row.Item("ProductCategory") + "</span>"),
                                       New XElement("cell", "<span id='invenColor_" & row.Item("ID") & "'>" + row.Item("Color") + "</span>"),
                                       New XElement("cell", "<span id='invenVariety_" & row.Item("ID") & "'>" + row.Item("Variety") + "</span>"),
                                       New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("BGCOLOR").ToString() + ";cursor:Pointer;color:" + row("FORECOLOR").ToString() +
                                                                                    "' class='flowerDescription' title='" + row("ProductName").Replace("'", "") + "'>" & row("ProductName") &
                                                                                    "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                    row("ProductName").Replace("'", "") + "'>" & row("ProductName") & "</div>"))),
                                       New XElement("cell", "<span title ='Received = " + row("CSREC").ToString() + " Sold = " + row("CSSOLD").ToString() + " Hold=" + row("CSHOLD").ToString() + "' > " + (row("CSREC") - (row("CSSOLD") + row("CSHOLD"))).ToString() + If(Convert.ToString(row("CSHOLD")) > 0, "*", "") + "</span>"),
                                       New XElement("cell", row("UOM")),
                                       New XElement("cell", row("Units")),
                                       New XElement("cell", "<a id='txtPriceA_" + row("ID").ToString() + "'>" + IIf(Convert.ToDecimal(row("Price")) = 0, "0.00", Convert.ToDecimal(row("Price")).ToString("N2")) + "</a><input type='text' style='display:none;width:50px' placeholder='" & IIf(Convert.ToDecimal(row("Price")) = 0, "0.00", Convert.ToDecimal(row("Price")).ToString("N2")) & "' id='editPriceA_" & row("ID").ToString() + "'></input>"),
                                       New XElement("cell", "<a id='txtPriceB_" + row("ID").ToString() + "'>" + IIf(Convert.ToDecimal(row("PriceB")) = 0, "0.00", Convert.ToDecimal(row("PriceB")).ToString("N2")) + "</a><input type='text' style='display:none;width:50px' placeholder='" & IIf(Convert.ToDecimal(row("PriceB")) = 0, "0.00", Convert.ToDecimal(row("PriceB")).ToString("N2")) & "' id='editPriceB_" & row("ID").ToString() + "'></input>"),
                                       New XElement("cell", "<a id='txtPriceC_" + row("ID").ToString() + "'>" + IIf(Convert.ToDecimal(row("PriceC")) = 0, "0.00", Convert.ToDecimal(row("PriceC")).ToString("N2")) + "</a><input type='text' style='display:none;width:50px' placeholder='" & IIf(Convert.ToDecimal(row("PriceC")) = 0, "0.00", Convert.ToDecimal(row("PriceC")).ToString("N2")) & "' id='editPriceC_" & row("ID").ToString() + "'></input>"),
                                       New XElement("cell", Convert.ToDecimal(row("Cost")).ToString("N2")),
                                       New XElement("cell", Convert.ToDecimal(row("OTHERCOST")).ToString("N3")),
                                       New XElement("cell", Convert.ToDecimal(row("HANDLING")).ToString("N3")),
                                       New XElement("cell", Convert.ToDecimal(row("ANDEAN")).ToString("N4")),
                                       New XElement("cell", Convert.ToDecimal(row("LandedCost")).ToString("N3")),
                                       New XElement("cell", "<a id='PriceGPM_" + row("ID").ToString() + "'>" + Convert.ToDecimal(row("GPM")).ToString("N1") + "</a>"),
                                       New XElement("cell", "<a id='txtCustNum_" + row("ID").ToString() + "'>" + IIf(row("CustNum").ToString() = "0", "", row("CustNum").ToString()) + "</a><input type='text' style='display:none;width:50px' pattern='[1-9]{1}[0-9]{9}' placeholder='" & IIf(row("CustNum").ToString() = "0", "", row("CustNum").ToString()) & "' id='editCustNum_" & row("ID").ToString() + "' maxlength='5'></input>"),
                                       New XElement("cell", "<a id='txtCsHold_" + row("ID").ToString() + "'>" + IIf(row("CSHOLD").ToString() = "0", "", row("CSHOLD").ToString()) + "</a><input type='text' style='display:none;width:50px' placeholder='" & IIf(row("CSHOLD").ToString() = "", "0", row("CSHOLD").ToString()) & "' id='editCsHold_" & row("ID").ToString() + "'></input>"),
                                       New XElement("cell", "<a id='txtFlag_" + row("ID").ToString() + "'>" + row("Flag") + "</a><input type='text' style='display:none;width:50px;margin-top:0px' class='AllUpperCaseTextBox' placeholder='" & row("Flag") & "' id='editFlag_" & row("ID").ToString() + "'></input>"),
                                       New XElement("cell", row("BOXNUM")),
                                       New XElement("cell", row("Days")),
                                       New XElement("cell", IIf(Convert.ToInt32(row("SqlID")) > 0, row("SqlID"), "")),
                                       New XElement("cell", IIf(Convert.ToInt32(row("SqlQty")) > 0, row("SqlQty"), "")),
                                       New XElement("cell", row("nPer0")),
                                       New XElement("cell", row("nPer1")),
                                       New XElement("cell", row("nPer2")),
                                       New XElement("cell", "<img style='cursor:pointer;margin-left:-4px;' title='" + GetPersonIconDetails(row("ADDUSER"), Convert.ToDateTime(row("ADDDATE")).ToString("MM/dd/yyyy"), row("ADDTIME"), "", row("UPDUSER"), Convert.ToDateTime(row("UPDDATE")).ToString("MM/dd/yyyy"), row("UPDTIME"), "", "", "", "", "", row("LOCKUSER"), Convert.ToDateTime(row("LOCKDATE")).ToString("MM/dd/yyyy"), row("LOCKTIME"), "") + "' id='imgaddeditDetails_" + row("ID").ToString() + "' src='images/Edit_user.png' />"),
                               New XElement("cell", IIf(Convert.ToBoolean(row("IsCreditExist")) = True, String.Format("<img style='Cursor:pointer;margin-top:-3px' id='InvCr_" & row("ID").ToString() & "' title='" + IIf(Convert.ToBoolean(row("IsCreditExist")) = True, IIf(Convert.ToString(row("CreditReason")) = "", "", Convert.ToString(row("CreditReason"))), "") + "' src='images/sadface.png' />"), "")),
                                              New XElement("cell", "<span id='invenGrade_" & row.Item("ID") & "'>" + row.Item("GRADE") + "</span>")
                                              )))
                '22March19 :: Abinaya :: Inventory pricing fix-no scrolling, slow response time
                'New XElement("cell", "<div style='height:15px;padding-top:5px;margin:-6px;font-weight:bold;background-color:" + row("BGColor") + ";color:" + row("ForeColor") + "'>" + row("ProductName") + "</div>"),

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
                '22March19 :: Abinaya :: Inventory pricing fix-no scrolling, slow response time
                'Else
                '    Dim User As New User
                '    'Dim User As New User
                '    If Not Session("LoginUserDetails") Is Nothing Then
                '        User = Session("LoginUserDetails")
                '    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                '        User = Session("LoginAdminDetails")
                '    End If
                '    Logs.VendorEmailLogs(User, PricingList(0).ErrorMessage, "", "Error Notification", "Error")
                '    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                '    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                'End If
            End If
            'Dim ExportList = obj.GetPricingDetail(Filter)
            'Dim ExportList = Inventory.LoadPricingDetails(Filter) //its gets data from sql
            'Session("PricingAllList") = PricingList
            'Dim SelectedDetails As New ArrayList()
            'If Not Context.Session("SelectedPricing") Is Nothing Then
            '    SelectedDetails = Context.Session("SelectedPricing")
            '    For Each Item In PricingList
            '        Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(Item.ID.ToString)).FirstOrDefault()
            '        If Not hasItem Is Nothing Then
            '            Item.Selected = True
            '        End If
            '    Next
            'End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetPricingDetail()::PagePricing")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function LoadPurchasesByFarmByAWB(ByVal FARMCODE As String) As XmlDocument
        Try
            Dim AmountList = Nothing
            AmountList = Inventory.LoadPurchasesByFarmByAWB(FARMCODE)

            Dim dtAmountList As New DataSet
            If Not TryCast(AmountList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                '22March19 :: Abinaya :: Inventory pricing fix-no scrolling, slow response time
                dtAmountList = TryCast(AmountList, Tuple(Of DataSet, String)).Item1 'ConvertToDataTable(PricingList)
            Else
                Dim newDoc1 As New XmlDocument()
                newDoc1.LoadXml("<rows><total>0</total></rows>")
                Return newDoc1
            End If

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", ""),
                                       New XElement("total", dtAmountList.Tables(0).Rows().Count()),
                                         From row In dtAmountList.Tables(0).Rows()
                                         Select
                                        New XElement("row", New XAttribute("id", row("SLNO")),
                                            New XElement("cell", row("LOT")),
                                            New XElement("cell", row("DATEREC")),
                                            New XElement("cell", row("BOXES")),
                                            New XElement("cell", row("FBE")),
                                            New XElement("cell", row("AMOUNT"))
                                              )))


            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: LoadPurchasesByFarm()::Page Settup")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function LoadPurchasesByProduct(ByVal FARMCODE As String, ByVal Product As String, ByVal sortname As String, ByVal sortorder As String) As XmlDocument
        Try
            'Dim SortExpr As String = sortname & " " & sortorder
            Dim SortExpr As String = ""
            If (sortname) <> "" Then
                SortExpr = IIf(sortname = "DATEREC", "CAST(DATEREC AS DATE)", sortname) & " " & sortorder
            End If
            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")

            Dim FlowerColorVisibility As Boolean = True
            'For Each i In UserFeatures
            '    If i.Name.ToLower = "show flower color" Then
            '        FlowerColorVisibility = i.Value
            '    End If
            'Next
            Dim PurchaseList = Nothing
            PurchaseList = Inventory.LoadPurchasesByProduct(FARMCODE, Product, SortExpr)

            Dim dtPurchaseList As New DataSet
            If Not TryCast(PurchaseList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                '22March19 :: Abinaya :: Inventory pricing fix-no scrolling, slow response time
                dtPurchaseList = TryCast(PurchaseList, Tuple(Of DataSet, String)).Item1 'ConvertToDataTable(PricingList)
            Else
                Dim newDoc1 As New XmlDocument()
                newDoc1.LoadXml("<rows><total>0</total></rows>")
                Return newDoc1
            End If

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                       New XElement("rows", New XElement("page", ""),
                                       New XElement("total", dtPurchaseList.Tables(0).Rows().Count()),
                                         From row In dtPurchaseList.Tables(0).Rows()
                                         Select
                                        New XElement("row", New XAttribute("id", row("SLNO")),
                                             New XElement("cell", row("WH")),
                                             New XElement("cell", row("FARM")),
                                             New XElement("cell", row("LOT")),
                                             New XElement("cell", row("DATEREC")),
                                            New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("BGCOLOR").ToString() + "' class='flowerDescription'><a style='color:" + row("fontcolor").ToString() + ";'>" + row("description") + "</a></div>", "<a >" + row("description") + "</a>")),
                                            New XElement("cell", row("BOXES")),
                                            New XElement("cell", row("UOM")),
                                            New XElement("cell", row("UNITSBUNCH")),
                                            New XElement("cell", row("UNITS")),
                                            New XElement("cell", row("TotalUnits")),
                                            New XElement("cell", row("COST")),
                                            New XElement("cell", row("TYPE")),
                                            New XElement("cell", row("FLAG")),
                                            New XElement("cell", row("CUST")),
                                            New XElement("cell", row("PO")),
                                            New XElement("cell", row("INVOICE"))
                                              )))


            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: LoadPurchasesByProduct()::Page Settup")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateInventoryPricing(ByVal Details As String) As String
        Try
            Dim result As String
            result = Inventory.UpdateInventoryPricing(Details)

            If result = "success" Then
                Return result
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateInventoryPricing::PagePricing")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function RecalculateInventoryPricing() As String
        Try
            Dim MsgStr As String
            MsgStr = Inventory.RecalculateInventoryPricing()
            Return MsgStr
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::RecalculateInventoryPricing::PageInventory")
            Return Nothing
        End Try
    End Function
#End Region

#Region "EXPORT DATA TO KOMETSALES"

    <System.Web.Services.WebMethod(True)>
    Public Function ExportSelectedFarms() As String
        Try

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim SelectedFarms As New ArrayList
            If Not Session("SelectedFarms") Is Nothing Then
                SelectedFarms = Session("SelectedFarms")
            End If
            If SelectedFarms.Count > 0 Then
                For Each FID As String In SelectedFarms
                    Dim farminfo As Farm = Farms.GetFarmDetails.GetFarmsbyID(FID)
                    Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                    Dim jsonSring = "{  ""authenticationToken"": """ + KometAPIToken + """,  ""name"": ""FARM - " + farminfo.Farm + """,  ""portOrigin"": """ + farminfo.City + """, ""country"": """ + farminfo.Country + """,  ""code"": """ + farminfo.Farm.ToString().Trim() + """,  ""phone1"": """",  ""phone2"": """",  ""webpage"":"""",  ""emailForPos"": """" }"
                    Dim data = Encoding.UTF8.GetBytes(jsonSring)
                    Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                    Dim result_post = SendRequest(New Uri(kometapiuri + "/vendor.add"), data, "application/json", "POST")
                    Dim json As JObject = JObject.Parse(result_post)
                    Dim vendorid = json.SelectToken("vendorId")
                    Dim message = json.SelectToken("message")
                    Dim status = json.SelectToken("status")
                    If Convert.ToBoolean(status) = True Then
                        Farms.UpdateKometID(vendorid, farminfo.Farm)
                        'obj.UpdateFarmsKometID(vendorid, farminfo.Farm)
                    Else
                        ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportFarmsToKomet::PageFarms")
                    End If
                Next
                ClearSelectedFarmSession()
            End If
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportSelectedFarms::PageFarms")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Sub ClearSelectedFarmSession()
        Dim log As New ArrayList
        Session("SelectedFarms") = log
    End Sub


    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedFarm(ByVal Selected As String, ByVal ID As String) As String
        Try

            Dim SelectedFarms As New ArrayList
            If Not Session("SelectedFarms") Is Nothing Then
                SelectedFarms = Session("SelectedFarms")
            End If
            Dim LogDet = SelectedFarms.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not LogDet Is Nothing Then
                If Selected = "0" Then
                    SelectedFarms.Remove(LogDet)
                End If
            Else
                If Selected = "1" Then
                    SelectedFarms.Add(ID)
                End If
            End If
            Session("SelectedFarms") = SelectedFarms

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedFarm::PageFarms")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedInventory(ByVal Selected As String, ByVal ID As String) As String
        Try

            Dim SelectedInvs As New ArrayList
            If Not Session("SelectedInventory") Is Nothing Then
                SelectedInvs = Session("SelectedInventory")
            End If
            Dim LogDet = SelectedInvs.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not LogDet Is Nothing Then
                If Selected = "0" Then
                    SelectedInvs.Remove(LogDet)
                End If
            Else
                If Selected = "1" Then
                    SelectedInvs.Add(ID)
                End If
            End If
            Session("SelectedInventory") = SelectedInvs

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedInventory::PageInventorytoKomet")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedCarrier(ByVal Selected As String, ByVal ID As String) As String
        Try

            Dim SelectedCarrier As New ArrayList
            If Not Session("SelectedCarrier") Is Nothing Then
                SelectedCarrier = Session("SelectedCarrier")
            End If
            Dim LogDet = SelectedCarrier.Cast(Of String).Where(Function(i) i.Equals(ID)).FirstOrDefault()
            If Not LogDet Is Nothing Then
                If Selected = "0" Then
                    SelectedCarrier.Remove(LogDet)
                End If
            Else
                If Selected = "1" Then
                    SelectedCarrier.Add(ID)
                End If
            End If
            Session("SelectedCarrier") = SelectedCarrier

            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedCarrier::PageCarrier")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedAllFarm(ByVal SelectedAll As String) As String
        Try
            Dim SelectedFarms As New ArrayList
            Dim data As List(Of Farm) = Farms.GetFarmsForKometpost()
            If SelectedAll = "0" Then
                Session("SelectedFarms") = SelectedFarms
            End If
            If SelectedAll = "1" Then
                For Each obj1 In data
                    SelectedFarms.Add(obj1.ID.ToString())
                Next
                Session("SelectedFarms") = SelectedFarms
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedAllFarm::PageFarms")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedAllInventory(ByVal SelectedAll As String) As String
        Try
            Dim SelectedInvs As New ArrayList

            Dim ExportList = Session("InventoryAllList")

            If SelectedAll = "0" Then
                Session("SelectedInventory") = SelectedInvs
            End If
            If SelectedAll = "1" Then
                For Each obj1 In ExportList
                    SelectedInvs.Add(obj1.ID.ToString())
                Next
                Session("SelectedInventory") = SelectedInvs
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedAllInventory::PageInventorytKomet")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ToggleSelectedAllCarrier(ByVal SelectedAll As String) As String
        Try
            Dim SelectedCarriers As New ArrayList

            Dim ExportList = Session("CarrierAllList")

            If SelectedAll = "0" Then
                Session("SelectedCarrier") = SelectedCarriers
            End If
            If SelectedAll = "1" Then
                For Each obj1 In ExportList
                    SelectedCarriers.Add(obj1.ID.ToString())
                Next
                Session("SelectedCarrier") = SelectedCarriers
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ToggleSelectedAllCarrier::PageCarrier")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ExportFarmsToKomet() As String
        Try

            Dim FarmList As List(Of Farm) = Farms.GetFarmsForKometpost()

            For Each farminfo As Farm In FarmList


                Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                Dim jsonSring = "{  ""authenticationToken"": """ + KometAPIToken + """,  ""name"": ""FARM - " + farminfo.Farm + """,  ""portOrigin"": """ + farminfo.City + """, ""country"": """ + farminfo.Country + """,  ""code"": """ + farminfo.Farm.ToString().Trim() + """,  ""phone1"": """",  ""phone2"": """",  ""webpage"":"""",  ""emailForPos"": """" }"
                Dim data = Encoding.UTF8.GetBytes(jsonSring)
                Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                Dim result_post = SendRequest(New Uri(kometapiuri + "/vendor.add"), data, "application/json", "POST")


                Dim json As JObject = JObject.Parse(result_post)
                Dim vendorid = json.SelectToken("vendorId")
                Dim message = json.SelectToken("message")
                Dim status = json.SelectToken("status")
                If Convert.ToBoolean(status) = True Then

                    Farms.UpdateKometID(vendorid, farminfo.Farm)
                    'obj.UpdateFarmsKometID(vendorid, farminfo.Farm)
                Else
                    ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportFarmsToKomet::PageFarms")
                End If



            Next


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportFarmsToKomet::PageFarms")
            Return Nothing
        End Try
        Return Nothing
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportCustomersToKomet() As String
        Try

            Dim ExportList As List(Of CustomerDetail) = CustomerDetails.GetCustomersForKometpost()

            For Each exportinfo As CustomerDetail In ExportList


                Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                Dim jsonSring As String = ""
                jsonSring = "{ " +
                 """authenticationToken"":  """ + KometAPIToken.ToString() + """," +
                 """name"": """ + exportinfo.Name.ToString() + """," +
                 """code"": """ + exportinfo.Customer.ToString().Trim() + """," +
                 """type"": ""0""," +
                 """phone"": """ + exportinfo.PHONE.ToString() + """," +
                 """fax"": """ + exportinfo.Fax + """," +
                 """website"":"" ""," +
                 """terms"":"" ""," +
                 """chargeFuelSurcharge"":1," +
                 """emailForInvoices"": """ + exportinfo.Email + """," +
                 """sendInvoiceVia"":""e-mail,+fax""," +
                 """billingStreet"":""" + exportinfo.ADDRESS1 + """," +
                 """billingCity"":""" + exportinfo.CITY + """," +
                 """billingState"":""" + exportinfo.STATE + """," +
                 """billingZipcode"":""" + exportinfo.ZIP + """," +
                 """billingCountry"":""" + exportinfo.COUNTRY + """" +
                    "}"

                Dim data = Encoding.UTF8.GetBytes(jsonSring)
                Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                Dim result_post = SendRequest(New Uri(kometapiuri + "/customer.add"), data, "application/json", "POST")


                Dim json As JObject = JObject.Parse(result_post)
                Dim returnID = json.SelectToken("customerId")
                Dim message = json.SelectToken("message")
                Dim status = json.SelectToken("status")
                If Convert.ToBoolean(status) = True Then

                    CustomerDetails.UpdateKometID(returnID, exportinfo.Customer)
                    'obj.UpdateCustomersKometID(returnID, exportinfo.Customer)
                Else
                    ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportCustomersToKomet::PageCustomer")
                End If



            Next


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportCustomersToKomet::PageCustomer")
            Return Nothing
        End Try
        Return Nothing
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportSingleCustomerToKomet(ByVal CustomerNo As String) As String
        Try
            Dim ExportCustomer As List(Of CustomerDetail) = CustomerDetails.GetSingleCustomerForKometpost(CustomerNo)
            Dim returnID = "0"
            For Each exportinfo As CustomerDetail In ExportCustomer
                Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                Dim jsonSring As String = ""
                jsonSring = "{ " +
                 """authenticationToken"":  """ + KometAPIToken.ToString() + """," +
                 """name"": """ + exportinfo.Name.ToString() + """," +
                 """code"": """ + exportinfo.Customer.ToString().Trim() + """," +
                 """type"": ""0""," +
                 """phone"": """ + exportinfo.PHONE.ToString() + """," +
                 """fax"": """ + exportinfo.Fax + """," +
                 """website"":"" ""," +
                 """terms"":"" ""," +
                 """chargeFuelSurcharge"":1," +
                  """markupValue"":""" + exportinfo.MARKUPVALUE + """," +
                   """markupType"":""%""," +
                 """emailForInvoices"": """ + exportinfo.Email + """," +
                 """sendInvoiceVia"":""e-mail,+fax""," +
                 """billingStreet"":""" + exportinfo.ADDRESS1 + """," +
                 """billingCity"":""" + exportinfo.CITY + """," +
                 """billingState"":""" + exportinfo.STATE + """," +
                 """billingZipcode"":""" + exportinfo.ZIP + """," +
                 """billingCountry"":""" + exportinfo.COUNTRY + """" +
                    "}"

                Dim data = Encoding.UTF8.GetBytes(jsonSring)
                Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                Dim result_post = SendRequest(New Uri(kometapiuri + "/customer.add"), data, "application/json", "POST")


                Dim json As JObject = JObject.Parse(result_post)
                returnID = json.SelectToken("customerId")
                Dim message = json.SelectToken("message")
                Dim status = json.SelectToken("status")
                If Convert.ToBoolean(status) = True Then
                    CustomerDetails.UpdateKometID(returnID, exportinfo.Customer)
                    'obj.UpdateCustomersKometID(returnID, exportinfo.Customer)
                Else
                    ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportCustomersToKomet::PageCustomer")
                End If



            Next
            Return returnID

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportCustomersToKomet::PageCustomer")
            Return Nothing
        End Try
        Return Nothing
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportCarriersToKomet() As String
        Try

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end



            Dim ExportList As List(Of Carrier) = Carriers.GetCarriersForKometpost()


            Dim SelectedDetails As New ArrayList()

            If Not Context.Session("SelectedCarrier") Is Nothing Then
                SelectedDetails = Context.Session("SelectedCarrier")
                For Each exportinfo As Carrier In ExportList
                    Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(exportinfo.ID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        exportinfo.Selected = True
                    Else
                        exportinfo.Selected = False
                    End If

                    If (exportinfo.Selected = False) Then
                        Continue For
                    End If

                    Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                    Dim jsonSring = "{" +
                     """authenticationToken"": """ + KometAPIToken.ToString() + """," +
                     """name"": """ + exportinfo.Name + """," +
                     """code"": """ + exportinfo.Carrier.ToString().Trim() + """," +
                    """capacity"":"" "" " +
                    "}"

                    Dim LiveKometID = GetCarrierKometIDbyCode(exportinfo.Carrier.ToString().Trim())
                    If (LiveKometID <> Nothing) Then
                        Carriers.UpdateKometID(LiveKometID, exportinfo.Carrier.ToString().Trim())
                        'obj.UpdateCarriersKometID(LiveKometID, exportinfo.Carrier.ToString().Trim())
                        Continue For
                    End If

                    Dim LiveCarrierKometID = GetCarrierKometIDbyName(exportinfo.Name.ToString())
                    If (LiveCarrierKometID <> Nothing) Then
                        Carriers.UpdateKometID(LiveCarrierKometID, exportinfo.Carrier.ToString().Trim())
                        'obj.UpdateCarriersKometID(LiveCarrierKometID, exportinfo.Carrier.ToString().Trim())
                        Continue For
                    End If

                    Dim data = Encoding.UTF8.GetBytes(jsonSring)
                    Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                    Dim result_post = SendRequest(New Uri(kometapiuri + "/carrier.add"), data, "application/json", "POST")


                    Dim json As JObject = JObject.Parse(result_post)
                    Dim returnID = json.SelectToken("carrierId")
                    Dim message = json.SelectToken("message")
                    Dim status = json.SelectToken("status")
                    If Convert.ToString(message) = "Carrier saved successfully." Then

                        Carriers.UpdateKometID(returnID, exportinfo.Carrier.ToString().Trim())
                        'obj.UpdateCarriersKometID(returnID, exportinfo.Carrier.ToString().Trim())
                    Else
                        ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportCarriersToKomet::PageCarrier")
                    End If



                Next
            End If
            Session("SelectedCarrier") = Nothing
            Return "Success"

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportCarriersToKomet::PageCarrier")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportProductsToKomet() As String
        Try

            Dim ExportList As ArrayList
            'Dim ExportList = objDbfService.GetInventoryDetailsForKometPost()
            For Each exportinfo In ExportList
                If (exportinfo.ProductCode = Nothing) Then
                    Continue For

                End If

                Dim LiveKometID = GetKometIDbyLegacyCode(exportinfo.ProductCode.ToString())
                If (LiveKometID <> Nothing) Then
                    GetProdDetails.UpdateKometID(LiveKometID.ToString(), exportinfo.ProductCode.ToString().Trim())
                    'obj.UpdateProductsKometID(LiveKometID.ToString(), exportinfo.ProductCode.ToString().Trim())
                    Continue For
                End If

                If GetProdDetails.IsProductHaveKometID(exportinfo.ProductCode.ToString()) = False Then
                    Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                    Dim jsonSring = "{" +
                     """authenticationToken"": """ + KometAPIToken.ToString() + """," +
                     """category"": """ + exportinfo.ProductCategory + """," +
                     """color"": """ + exportinfo.Color.ToString() + """," +
                       """variety"": """ + exportinfo.Variety.ToString() + """," +
                         """grade"": """ + exportinfo.Grade.ToString() + """," +
                           """code"": """ + exportinfo.ProductCode.ToString() + """," +
                    """defaultUnitType"":""Bunch"" " +
                    "}"




                    Dim data = Encoding.UTF8.GetBytes(jsonSring)
                    Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                    Dim result_post = SendRequest(New Uri(kometapiuri + "/product.add"), data, "application/json", "POST")


                    Dim json As JObject = JObject.Parse(result_post)
                    Dim returnID = json.SelectToken("productId")
                    Dim message = json.SelectToken("message")
                    Dim status = json.SelectToken("status")
                    If Convert.ToString(message) = "The Product was successfully saved." Then

                        GetProdDetails.UpdateKometID(returnID, exportinfo.ProductCode.ToString().Trim())
                        'obj.UpdateProductsKometID(returnID, exportinfo.ProductCode.ToString().Trim())
                    Else
                        ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportProductsToKomet::PageFlowers")
                    End If

                End If

            Next


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportProductsToKomet::PageFlowers")
            Return Nothing
        End Try
        Return Nothing
    End Function


    Public Function ExportSingleProductsToKomet(ByVal Code As String) As String
        Try
            Dim ExportData As List(Of Prod) = GetProdDetails.GetSingleProductForKometpost(Code)
            Dim returnID = ""
            If ExportData.Count > 0 Then

                For Each exportinfo As Prod In ExportData

                    If (exportinfo.CODE = Nothing) Then
                        Continue For

                    End If
                    If GetProdDetails.IsProductHaveKometID(exportinfo.CODE.ToString().Trim()) = False Then

                        Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                        Dim jsonSring = "{" +
                         """authenticationToken"": """ + KometAPIToken.ToString() + """," +
                         """category"": """ + exportinfo.CAT.Trim() + """," +
                         """color"": """ + exportinfo.COLOR.ToString().Trim() + """," +
                           """variety"": """ + exportinfo.VARIETY.ToString().Trim() + """," +
                             """grade"": """ + exportinfo.GRADE.ToString().Trim() + """," +
                               """code"": """ + exportinfo.CODE.ToString().Trim() + """," +
                        """defaultUnitType"":""Bunch"" " +
                        "}"


                        Dim LiveKometID = GetKometIDbyLegacyCode(exportinfo.CODE.ToString().Trim())
                        If (LiveKometID <> Nothing) Then
                            GetProdDetails.UpdateKometID(LiveKometID.ToString(), exportinfo.CODE.ToString().Trim())
                            'obj.UpdateProductsKometID(LiveKometID.ToString(), exportinfo.CODE.ToString().Trim())
                            Continue For
                        End If

                        Dim data = Encoding.UTF8.GetBytes(jsonSring)
                        Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                        Dim result_post = SendRequest(New Uri(kometapiuri + "/product.add"), data, "application/json", "POST")


                        Dim json As JObject = JObject.Parse(result_post)
                        returnID = json.SelectToken("productId")
                        Dim message = json.SelectToken("message")
                        Dim status = json.SelectToken("status")
                        If Convert.ToString(message) = "The Product was successfully saved." Then

                            GetProdDetails.UpdateKometID(returnID, exportinfo.CODE.ToString().Trim())
                            'obj.UpdateProductsKometID(returnID, exportinfo.CODE.ToString().Trim())
                        Else
                            ''ANITHA :: MAR-03-2018 18:05 :: added the product code for which product get error while posting to komet
                            ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportSingleProductsToKomet(" + exportinfo.CODE + ")::PageInventorytoKomet")
                        End If

                    End If

                Next
            End If
            Return returnID
        Catch ex As Exception
            ''ANITHA :: MAR-03-2018 18:05 :: added the product code for which product get error while posting to komet
            ErrorLogs.LogException(ex, "Error in Service::ExportSingleProductsToKomet(" + Code + ")::PageInventorytoKomet")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetBoxtypesFromKomet() As String
        Try

            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/boxtype.list" + "?authenticationToken=" + KometAPIToken.ToString() + ""
            Dim result_post = SendRequest(New Uri(UriwithParam), Nothing, "application/json", "POST")
            Dim json As JObject = JObject.Parse(result_post)
            Dim message = json.SelectToken("message")
            Dim status = json.SelectToken("status")
            If Convert.ToString(message) = "OK" Then
                Dim Boxetypes = json.SelectToken("boxtypes")
                Dim jss As New JavaScriptSerializer()
                Dim dict = jss.Deserialize(Of List(Of BoxType))(Boxetypes.ToString())
                BoxTypes.EmptyBoxTypes()
                For Each Datas In dict
                    BoxTypes.InsertBoxTypes(Datas.id, Datas.code.ToString().Trim(), Datas.fbe)
                Next
            Else
                ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::GetBoxtypesFromKomet::PageFlowers")
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetBoxtypesFromKomet::PageFlowers")
            Return Nothing
        End Try
        Return Nothing
    End Function

    Public Function UpdateAllProductKometIDFromKomet() As String
        Try
            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/product.list" + "?authenticationToken=" + KometAPIToken.ToString() + ""
            Dim req As HttpWebRequest = WebRequest.Create(UriwithParam.ToString())
            Dim res As HttpWebResponse = req.GetResponse()
            Dim srdr As New StreamReader(res.GetResponseStream())
            Dim rdstring = srdr.ReadToEnd()
            Dim json As JObject = JObject.Parse(rdstring)
            Dim invoices = json.SelectToken("products")
            Dim jss As New JavaScriptSerializer()
            Dim dict = jss.Deserialize(Of List(Of KometProduct))(invoices.ToString())
            For Each Datas In dict

                'obj.UpdateProductsKometID(Datas.id, Datas.legacyCode.ToString().Trim())
                ProdDetails.GetProdDetails.UpdateKometID(Datas.id, Datas.legacyCode.ToString().Trim())


            Next

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAllProductKometIDFromKomet::PageInventorytoKomet")
            Return Nothing
        End Try
        Return Nothing
    End Function

    Public Function UpdateAllCarrierKometIDFromKomet() As String
        Try
            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/carrier.list" + "?authenticationToken=" + KometAPIToken.ToString() + ""
            Dim req As HttpWebRequest = WebRequest.Create(UriwithParam.ToString())
            Dim res As HttpWebResponse = req.GetResponse()
            Dim srdr As New StreamReader(res.GetResponseStream())
            Dim rdstring = srdr.ReadToEnd()
            Dim json As JObject = JObject.Parse(rdstring)
            Dim invoices = json.SelectToken("carriers")
            Dim jss As New JavaScriptSerializer()
            Dim dict = jss.Deserialize(Of List(Of KometCarrier))(invoices.ToString())
            For Each Datas In dict
                Carriers.UpdateKometID(Datas.id, Datas.code.ToString().Trim())
                'obj.UpdateCarriersKometID(Datas.id, Datas.code.ToString().Trim())
            Next

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAllCarrierKometIDFromKomet::PageCarrier")
            Return Nothing
        End Try
        Return Nothing
    End Function


    Public Function IsProductExistsInKomet(ByVal CODE As String) As Boolean
        Try
            Dim IsExists As Boolean = False

            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/product.list" + "?authenticationToken=" + KometAPIToken.ToString() + "&legacyCode=" + CODE + ""
            Dim req As HttpWebRequest = WebRequest.Create(UriwithParam.ToString())
            Dim res As HttpWebResponse = req.GetResponse()
            Dim srdr As New StreamReader(res.GetResponseStream())
            Dim rdstring = srdr.ReadToEnd()
            Dim json As JObject = JObject.Parse(rdstring)
            Dim invoices = json.SelectToken("products")
            Dim jss As New JavaScriptSerializer()
            Dim dict = jss.Deserialize(Of List(Of KometProduct))(invoices.ToString())

            For Each Datas In dict
                IsExists = True
            Next

            Return IsExists

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAllProductKometIDFromKomet::PageInventorytoKomet")
            Return False
        End Try
    End Function

    Public Function GetKometIDbyLegacyCode(ByVal CODE As String) As String
        Try
            Dim KometID As String = ""

            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/product.list" + "?authenticationToken=" + KometAPIToken.ToString() + "&legacyCode=" + CODE.ToString().Trim() + ""
            Dim req As HttpWebRequest = WebRequest.Create(UriwithParam.ToString())
            Dim res As HttpWebResponse = req.GetResponse()
            Dim srdr As New StreamReader(res.GetResponseStream())
            Dim rdstring = srdr.ReadToEnd()
            Dim json As JObject = JObject.Parse(rdstring)
            Dim invoices = json.SelectToken("products")
            Dim jss As New JavaScriptSerializer()
            Dim dict = jss.Deserialize(Of List(Of KometProduct))(invoices.ToString())

            For Each Datas In dict
                KometID = Datas.id
            Next

            Return KometID

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAllProductKometIDFromKomet::PageInventorytoKomet")
            Return False
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateAllDflowerKometIDFromKomet() As String
        Try
            Dim KometID As String = ""
            Dim ProductCode As String = ""
            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/product.list" + "?authenticationToken=" + KometAPIToken.ToString() + ""
            Dim req As HttpWebRequest = WebRequest.Create(UriwithParam.ToString())
            Dim res As HttpWebResponse = req.GetResponse()
            Dim srdr As New StreamReader(res.GetResponseStream())
            Dim rdstring = srdr.ReadToEnd()
            Dim json As JObject = JObject.Parse(rdstring)
            Dim invoices = json.SelectToken("products")
            Dim jss As New JavaScriptSerializer()
            Dim dict = jss.Deserialize(Of List(Of KometProduct))(invoices.ToString())

            For Each Datas In dict
                KometID = Datas.id
                ProductCode = Datas.legacyCode
                GetProdDetails.UpdateKometID(KometID.ToString(), ProductCode.ToString().Trim())
                'obj.UpdateProductsKometID(KometID.ToString(), ProductCode.ToString().Trim())

            Next

            Return KometID

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAllProductKometIDFromKomet::PageInventorytoKomet")
            Return False
        End Try
    End Function

    Public Function GetCarrierKometIDbyCode(ByVal CODE As String) As String
        Try
            Dim KometID As String = ""

            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/carrier.list" + "?authenticationToken=" + KometAPIToken.ToString() + "&code=" + CODE.ToString().Trim() + ""
            Dim req As HttpWebRequest = WebRequest.Create(UriwithParam.ToString())
            Dim res As HttpWebResponse = req.GetResponse()
            Dim srdr As New StreamReader(res.GetResponseStream())
            Dim rdstring = srdr.ReadToEnd()
            Dim json As JObject = JObject.Parse(rdstring)
            Dim invoices = json.SelectToken("carriers")
            Dim jss As New JavaScriptSerializer()
            Dim dict = jss.Deserialize(Of List(Of KometCarrier))(invoices.ToString())

            For Each Datas In dict
                KometID = Datas.id
            Next

            Return KometID

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAllProductKometIDFromKomet::PageInventorytoKomet")
            Return False
        End Try
    End Function

    Public Function GetCarrierKometIDbyName(ByVal NAME As String) As String
        Try
            Dim KometID As String = ""

            Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
            Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
            Dim UriwithParam = kometapiuri + "/carrier.list" + "?authenticationToken=" + KometAPIToken.ToString() + "&name=" + NAME.ToString().Trim() + ""
            Dim req As HttpWebRequest = WebRequest.Create(UriwithParam.ToString())
            Dim res As HttpWebResponse = req.GetResponse()
            Dim srdr As New StreamReader(res.GetResponseStream())
            Dim rdstring = srdr.ReadToEnd()
            Dim json As JObject = JObject.Parse(rdstring)
            Dim invoices = json.SelectToken("carriers")
            Dim jss As New JavaScriptSerializer()
            Dim dict = jss.Deserialize(Of List(Of KometCarrier))(invoices.ToString())

            For Each Datas In dict
                KometID = Datas.id
            Next

            Return KometID

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateAllProductKometIDFromKomet::PageInventorytoKomet")
            Return False
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryToKometForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ExportCSV As String) As XmlDocument
        Try

            ' GetBoxtypesFromKomet()


            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                'Dim data As ArrayList
                'Dim data = obj.GetInventoryDetailsForKometPost()

                Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"ProductCode", "ProductName", "ProductCategory", "Variety", "Color",
                    "Grade", "Farm", "City", "BoxNumber", "Soldas", "Units",
                "UnitsBunch", "StemBunch", "Qty", "UOM", "Price", "PriceB",
                "Fuel", "FBE", "FEE", "Cost", "Days"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "InventorytoKomet")
                Return BuildXmlDoc(filepath)
            Else



                Session("InventoryAllList") = Nothing

                Dim ExportList As ArrayList
                'Dim ExportList = objDbfService.GetInventoryDetailsForKometPost()
                Session("InventoryAllList") = ExportList
                Dim SelectedDetails As New ArrayList()
                If Not Context.Session("SelectedInventory") Is Nothing Then
                    SelectedDetails = Context.Session("SelectedInventory")
                    For Each Item In ExportList
                        Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(Item.ID.ToString)).FirstOrDefault()
                        If Not hasItem Is Nothing Then
                            Item.Selected = True
                        End If
                    Next
                End If

                Dim FeePerFullbox As Integer = 2

                Dim xmlDoc As New XDocument()

                'Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                '                        New XElement("rows", New XElement("page", page.ToString()),
                '                        'New XElement("total", "10"),
                '                        ExportList.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                '                                                                     New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='select_" & row.ID.ToString() & "' src='" & IIf(row.Selected, "images/check-on.png", "images/check-off.png") & "' />")),
                '                                                                      New XElement("cell", row.ProductCode),
                '                        New XElement("cell", "<div style='height:15px;padding-top:5px;margin:-6px;font-weight:bold;background-color:" + row.BGColor + ";color:" + row.ForeColor + "'>" + row.ProductName + "</div>"),
                '                        New XElement("cell", row.ProductCategory),
                '                        New XElement("cell", row.Variety),
                '                        New XElement("cell", row.Color),
                '                        New XElement("cell", row.Grade),
                '                        New XElement("cell", row.Farm),
                '                        New XElement("cell", row.City),
                '                        New XElement("cell", row.BoxNumber),
                '                        New XElement("cell", row.Soldas),
                '                        New XElement("cell", row.Units),
                '                        New XElement("cell", "<div " + If(row.Bunches.ToString() = "0", "title='Bunches can not be zero' style='background-color:red;margin-top: -5px;'", "style='margin-top: -5px;'") + ">" + row.Bunches.ToString() + "</div>"),
                '                        New XElement("cell", "<div " + If(row.UnitsBunch.ToString() = "0", "title='Units per bunch can not be zero' style='background-color:red;margin-top: -5px;'", "style='margin-top: -5px;'") + ">" + row.UnitsBunch.ToString() + "</div>"),
                '                        New XElement("cell", "<span style='height:25px;width:25px' title ='Received = " + row.CSREC.ToString() + " Sold = " + row.CSSOLD.ToString() + " Held=" + row.CSHOLD.ToString() + "' > " + row.Qty.ToString() + "</span>"),
                '                        New XElement("cell", row.UOM),
                '                        New XElement("cell", IIf(row.Cost > row.Price, "<div style='height:15px;padding-top:5px;margin:-6px;font-weight:bold;background-color:red;color:black'>" + row.Price.ToString("N3") + "</div>", row.Price.ToString("N3"))),
                '                        New XElement("cell", IIf(row.Cost > row.PriceB, "<div style='height:15px;padding-top:5px;margin:-6px;font-weight:bold;background-color:red;color:black'>" + row.PriceB.ToString("N3") + "</div>", row.PriceB.ToString("N3"))),
                '                        New XElement("cell", row.Fuel.ToString("N2")),
                '                        New XElement("cell", IIf(row.FBE = Nothing, "0", row.FBE.ToString("N2"))),
                '                        New XElement("cell", row.FEE.ToString("N2")),
                '                        New XElement("cell", row.Cost.ToString("N2")),
                '                        New XElement("cell", row.Days)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryToKometForFgrd::PageInventoryToKomet")
            Return Nothing
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function ExportSelectedInventoryToKomet() As String
        Try
            GetBoxtypesFromKomet()

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end
            Dim SelectedDetails As New ArrayList
            If Not Session("SelectedInventory") Is Nothing Then
                SelectedDetails = Session("SelectedInventory")
            End If
            Dim SelectedIDs As String = ""
            If SelectedDetails.Count > 0 Then
                For Each FID As String In SelectedDetails
                    SelectedIDs += FID + ","
                Next
            End If
            'Dim Selected = SelectedIDs.Remove(SelectedIDs.Length - 1)
            Dim Selected = SelectedIDs.TrimEnd(",")
            Dim ExportList As ArrayList
            'Dim ExportList = objDbfService.GetInventoryDetailsForKometPost()
            For Each exportinfo In ExportList
                Try
                    If (exportinfo.Cost > exportinfo.Price) Then
                        Continue For
                    End If
                    If (exportinfo.Cost > exportinfo.PriceB) Then
                        Continue For
                    End If
                    Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(exportinfo.ID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        exportinfo.Selected = True
                    Else
                        exportinfo.Selected = False
                    End If

                    If (exportinfo.Selected = False) Then
                        Continue For
                    End If
                    Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")

                    If (exportinfo.FarmKometID <= 0) Then
                        Continue For
                    End If
                    If (exportinfo.UnitsBunch <= 0) Then
                        Continue For

                    End If
                    If (exportinfo.Bunches <= 0) Then
                        Continue For

                    End If
                    Dim FarmID = "0"
                    FarmID = exportinfo.FarmKometID


                    Dim ProductID As String
                    ''ANITHA :: MAR-06-2018 18:00 added the trim when check the product is existing or not at komet
                    Dim IsExists = IsProductExistsInKomet(Convert.ToString(exportinfo.ProductCode).Trim())
                    If (IsExists = False) Then
                        ProductID = ExportSingleProductsToKomet(exportinfo.ProductCode.ToString().Trim())
                    Else
                        ProductID = ProdDetails.GetProdDetails.GetProductKometID(exportinfo.ProductCode.ToString().Trim())
                        If (ProductID = Nothing) Then
                            ProductID = GetKometIDbyLegacyCode(exportinfo.ProductCode.ToString().Trim())
                            GetProdDetails.UpdateKometID(ProductID.ToString(), exportinfo.ProductCode.ToString().Trim())
                            'obj.UpdateProductsKometID(ProductID.ToString(), exportinfo.ProductCode.ToString().Trim())
                        End If

                    End If

                    If ProductID = Nothing Then
                        Continue For
                    End If
                    Dim BoxtypeId = BoxTypes.GetBoxTypeKometID(exportinfo.UOM)
                    If (BoxtypeId = Nothing) Then
                        Continue For
                    End If

                    Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                    Dim Qty As Integer = (exportinfo.CSREC - exportinfo.CSSOLD - exportinfo.CSHOLD)

                    Dim LotNo As String = ""
                    'Dim LotNo As String = objDbfService.SaveInventoryatKomet(Qty.ToString(), exportinfo.ID.ToString())
                    Dim UriwithParam = kometapiuri + "/inventory.add" + "?authenticationToken=" + KometAPIToken.ToString() + "&growerId=" + FarmID.ToString() + "&awb=" + exportinfo.AWB.ToString() + "&lotNumber=" + LotNo.ToString() + "&unitType=" + exportinfo.Soldas.ToString() + "&stemsBunch=" + exportinfo.UnitsBunch.ToString() + "&productId=" + ProductID.ToString() + "&quantity=" + Qty.ToString() + "&boxTypeId=" + BoxtypeId.ToString() + "&bunches=" + exportinfo.Bunches.ToString() + "&unitCost=" + Math.Round((exportinfo.Cost + (exportinfo.OtherCost / exportinfo.Units)), 3).ToString() + "&shipDate=" + exportinfo.DateRec.ToString("yyyy-MM-dd") + "&arrivalDate=" + exportinfo.DateRec.ToString("yyyy-MM-dd") + "&priceA=" + exportinfo.Price.ToString() + "&priceB=" + exportinfo.PriceB.ToString() + "&breakdownProductId[0]=" + ProductID.ToString() + "&breakdownBunches[0]=" + exportinfo.Bunches.ToString() + "&breakdownStemsBunch[0]=" + exportinfo.UnitsBunch.ToString() + "&breakdownUnitCost[0]=" + Math.Round((exportinfo.Cost + (exportinfo.OtherCost / exportinfo.Units)), 3).ToString() + ""
                    Dim result_post = SendRequest(New Uri(UriwithParam), Nothing, "application/json", "POST")


                    Dim json As JObject = JObject.Parse(result_post)
                    Dim Boxes = json.SelectToken("boxes")
                    Dim message = json.SelectToken("message")
                    Dim status = json.SelectToken("status")
                    If Convert.ToString(message) = "OK" Then
                        'objDbfService.UpdateInventoryKometID(LotNo.ToString(), exportinfo.ProductCode.ToString().Trim(), exportinfo.Units, exportinfo.City, exportinfo.InvenPrice, exportinfo.BoxNumber, exportinfo.AWB, Convert.ToDateTime(exportinfo.DateRec))
                    Else
                        ErrorLogs.LogException(New Exception(Convert.ToString(message)), "Error in Service::ExportSelectedInventoryToKomet::PageInventorytoKomet :: ProductCode " + exportinfo.ProductCode.ToString() + " Qty " + exportinfo.Qty.ToString())
                    End If
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in Service::ExportSelectedInventoryToKomet::PageInventorytoKomet :: ProductCode " + exportinfo.ProductCode.ToString() + " Qty " + exportinfo.Qty.ToString())
                End Try

            Next
            Session("SelectedInventory") = Nothing
            Return "Success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportSelectedInventoryToKomet::PageInventorytoKomet")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ExportShiptoToKomet() As String
        Try

            Dim ExportList As List(Of ShipTo) = ShipTos.GetShiptosForKometpost()

            For Each exportinfo As ShipTo In ExportList


                Dim KometAPIToken = WebConfigurationManager.AppSettings("KometAPIToken")
                Dim jsonSring = "{" +
                 """authenticationToken"": """ + KometAPIToken + """," +
                 """customerId"": """ + exportinfo.Customer + """," +
                 """name"": """ + exportinfo.Name + """," +
                 """city"": """ + exportinfo.CITY + """," +
                 """state"": """ + exportinfo.STATE + """," +
                 """country"": """ + exportinfo.COUNTRY + """," +
                 """zipcode"": """ + exportinfo.ZIP + """," +
                 """address"":""" + exportinfo.ADDRESS1 + """," +
                 """fax"":""" + exportinfo.Fax + """," +
                 """phone"":""" + exportinfo.PHONE + """ " +
                "}"
                Dim data = Encoding.UTF8.GetBytes(jsonSring)
                Dim kometapiuri = WebConfigurationManager.AppSettings("KometAPIURI")
                Dim result_post = SendRequest(New Uri(kometapiuri + "/shipto.add"), data, "application/json", "POST")


                Dim json As JObject = JObject.Parse(result_post)
                Dim vendorid = json.SelectToken("shipToId")
                Dim message = json.SelectToken("message")
                Dim status = json.SelectToken("status")
                If Convert.ToBoolean(status) = True Then

                    ShipTos.UpdateKometID(vendorid, exportinfo.Customer)
                    'objDbfService.UpdateShipToKometID(vendorid, exportinfo.Customer)
                Else
                    ErrorLogs.LogException(New Exception(message, Nothing), "Error in Service::ExportShiptoToKomet::Pageshipto")
                End If



            Next


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportShiptoToKomet::Pageshipto")
            Return Nothing
        End Try
        Return Nothing
    End Function

#End Region

#Region "Carrier"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCarrierForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Carriers()
            Dim data As List(Of Carrier) = obj.GetCarrierListForFgrd(whereCondition, sortExp, start, rp)

            Session("CarrierAllList") = Nothing
            Session("CarrierAllList") = data
            Dim SelectedDetails As New ArrayList()
            If Not Context.Session("SelectedCarrier") Is Nothing Then
                SelectedDetails = Context.Session("SelectedCarrier")
                For Each Item In data
                    Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(Item.ID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        Item.Selected = True
                    End If
                Next
            End If
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Carrier", "Name", "AirlineType"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("AirlineType").ColumnName = "Type"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "FarmDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='select_" & row.ID.ToString() & "' src='" & IIf(row.Selected, "images/check-on.png", "images/check-off.png") & "' />")),
                                        New XElement("cell", "<b><a href='#' id='DeleteCarrier_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<b><a href='#' id='EditCarrier_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.Carrier),
                                        New XElement("cell", row.Name),
                                        New XElement("cell", row.AirlineType),
                                        New XElement("cell", row.KometID)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierForFgrd::PageCarrier")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCarrierbyID(ByVal ID As String, ByVal Carrier As String) As String
        Try
            Try
                Carriers.DeleteCarrierbyID(ID)
            Catch ex As Exception
                ErrorLogs.LogException(ex, "Error in Service::DeleteCarrierbyID::PageCarrier")
            End Try

            Return "Success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCarrier::PageCarrier")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' MANI ::  Get the list of carrier 
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetCarriersForDropdownList() As List(Of Carrier)
        Try
            Return Carriers.GetCarriersForDropdownList()

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarriersForDropdownList::PageCarrier")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Mani::11/22/2018:Get Carrier for autocomplete
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetCarriersForAutocomplete(ByVal Searchtext As String) As List(Of Carrier)
        Try
            Return Carriers.GetCarriersForAutocomplete(Searchtext)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarriersForAutocomplete::PageCarrier")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCarrierFromExistingOrder(ByVal Order As String) As String
        Try
            Return Carriers.GetCarrierFromExistingOrder(Order)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierFromExistingOrder::PageCarrier")
            Return Nothing
        End Try
    End Function

    'Added by Anubhuti 2023_07_11
    <System.Web.Services.WebMethod(True)>
    Public Function GetMaxDateRecCurrentOrder(ByVal Customer As String, ByVal Order As String) As String
        Try
            Return SalesOrder.GetMaxDateRecCurrentOrder(Customer, Order)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetMaxDateRecCurrentOrder::PageOrderSaveProcess")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' MANI ::  Get the list of carrier 
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetCarriersbyCarrierForDropdownList(ByVal CarrierLst As String) As List(Of Carrier)
        Try
            Return Carriers.GetCarriersbyCarrierForDropdownList(CarrierLst)
            'Dim CarrierDetails As List(Of Carrier) = Carriers.GetCarriersbyCarrierForDropdownList(CarrierLst)
            'Session("CarrierFilter") = CarrierDetails
            'Return CarrierDetails

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarriersbyCarrierForDropdownList::PageCarrier")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCarrierFilterSession() As String()
        Try
            Dim CarrierFilterSession(0) As String
            CarrierFilterSession = Session("CarrierFilterSession")
            Return CarrierFilterSession
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierFilterSession")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Sub SaveCarrierFilterSession(ByVal CarrierFilter As String)
        Try
            Dim CarrierFilterSession(0) As String
            CarrierFilterSession(0) = CarrierFilter
            Session("CarrierFilterSession") = CarrierFilterSession
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCarrierFilterSession")
        End Try
    End Sub

    <System.Web.Services.WebMethod(True)>
    Public Sub SaveSalesPersonFilterSession(ByVal ShowAllSalesPersonSales As Boolean)
        Try
            Session("ShowAllSalesPersonSales") = ShowAllSalesPersonSales
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveSalesPersonFilterSession")
        End Try
    End Sub

    Public Sub CopyProperties(ByVal objSource As Object, ByVal objDestination As Object)
        Dim destProps = objDestination.[GetType]().GetProperties()

        For Each sourceProp In objSource.[GetType]().GetProperties()

            For Each destProperty In destProps

                If destProperty.Name = sourceProp.Name AndAlso destProperty.PropertyType.IsAssignableFrom(sourceProp.PropertyType) Then
                    destProperty.SetValue(destProps, sourceProp.GetValue(sourceProp, New Object() {}), New Object() {})
                    Exit For
                End If
            Next
        Next
    End Sub

    <System.Web.Services.WebMethod(True)>
    Public Function GetCarrierByID(ByVal ID As String) As Carrier
        Try
            Dim CarrierDetails As New Carrier
            CarrierDetails = Carriers.GetCarrierbyID(ID)
            Session("CarrierDetails") = CarrierDetails
            Return CarrierDetails
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierByID::PageCarrier")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerKometID(CustomerNo As String) As String
        Try
            Dim ID As String = "0"
            ID = CustomerDetails.GetCustomerKometID(CustomerNo)
            Return ID
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomerKometID::PageARINVS")
            Return Nothing
        End Try
    End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function ImportCarrierfromDBF() As String
    '    Try
    '        Dim ListOfCarriers = obj.LoadCarriers()
    '        If ListOfCarriers.Length > 0 Then

    '            If ListOfCarriers(0).ErrorMessage = "" Then
    '                Dim FarmList = New XElement("CarriersDetails",
    '            From car In ListOfCarriers
    '            Select New XElement("Carriers", "",
    '                New XElement("CARRIER", car.CARRIER),
    '                New XElement("NAME", car.NAME),
    '                New XElement("AIRLINE", car.AIRLINE),
    '                New XElement("CUTOFF", car.CUTOFF),
    '                New XElement("DELCHARGE", car.DELCHARGE),
    '                New XElement("COUNTER", car.COUNTER),
    '                New XElement("IATA", car.IATA),
    '                New XElement("BEGAWB", car.BEGAWB),
    '                New XElement("ENDAWB", car.ENDAWB),
    '                New XElement("FLOWSCR", car.FLOWSCR),
    '                New XElement("FLOWSCX", car.FLOWSCX),
    '                New XElement("INFPHONE", car.INFPHONE),
    '                New XElement("AWBPHONE", car.AWBPHONE),
    '                New XElement("CONTACT", car.CONTACT),
    '                New XElement("NEEDBOOK", car.NEEDBOOK),
    '                New XElement("PRINTER", car.PRINTER),
    '                New XElement("GENERIC", car.GENERIC),
    '                New XElement("TWO_FORMS", car.TWO_FORMS),
    '                New XElement("ADDRESS1", car.ADDRESS1),
    '                New XElement("ADDRESS2", car.ADDRESS2),
    '                New XElement("ADDRESS3", car.ADDRESS3),
    '                New XElement("KometID", car.KOMETID)))
    '                Return Carriers.SaveCarriers(FarmList.ToString())
    '            Else
    '                Dim User As New User
    '                If Not Session("LoginUserDetails") Is Nothing Then
    '                    User = Session("LoginUserDetails")
    '                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '                    User = Session("LoginAdminDetails")
    '                End If
    '                Logs.SendErrorEmail(User, ListOfCarriers(0).ErrorMessage, "", "Error Notification", "error")
    '                Return Nothing
    '            End If
    '        Else
    '            Return Nothing
    '        End If
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::ListOfCarriersfromDBF::PageFarm")
    '        Return Nothing
    '    End Try
    'End Function

#End Region

#Region "OrderDetail"

    '<System.Web.Services.WebMethod(True)>
    'Public Function IsOrderDetExistsByID(RecNo As Integer) As Boolean
    '    Try
    '        Dim IsExists As Boolean = objDbfService.IsOrderDetExistsByID(RecNo)
    '        Return IsExists
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetUserByID::IsOrderDetExistsByID")
    '        Return False
    '    End Try
    'End Function

    ''' <summary>
    ''' MANI :: Delete Order Detail
    ''' </summary>
    ''' <param name="ID"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteOrderDetail(ByVal ID As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If

            Dim DeleteResult = SalesOrder.DeleteOrderDetail(ID, User.Name)
            Return DeleteResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteOrderMiscDetail(ByVal ID As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If

            Dim DeleteResult = SalesOrder.DeleteOrderMiscDetail(ID, User.Name)
            Return DeleteResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteOrderMiscDetail")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteVetMiscDetail(ByVal ID As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If

            Dim DeleteResult = SalesOrder.DeleteVetMiscDetail(ID, User.Name)
            Return DeleteResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteVetMiscDetail")
            Return "error"
        End Try
    End Function


    ''' <summary>
    '''  MANI :: ADD/Update MISC
    ''' </summary>
    ''' <param name="OrderDetailID"></param>
    ''' <param name="Order"></param>
    ''' <param name="Customer"></param>
    ''' <param name="Code"></param>
    ''' <param name="Name"></param>
    ''' <param name="Quantity"></param>
    ''' <param name="Price"></param>
    ''' <param name="Cost"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ADDUPDATEMisc(ByVal OrderDetailID As String, ByVal Order As String, ByVal Customer As String, ByVal Code As String,
                                                       ByVal Name As String, ByVal Quantity As Decimal, ByVal Price As Decimal,
                                                       ByVal Cost As Decimal, CalledFromVET As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If

            Return SalesOrder.ADDUPDATEMisc(OrderDetailID, Order, Customer, Code, Name, Quantity, Price, Cost, User.ID, CalledFromVET)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ADDUPDATEMisc")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' Mani::23/03/2018: ADD/Update Detail for an order
    ''' </summary>
    ''' <param name="OrderDetailID"></param>
    ''' <param name="Order"></param>
    ''' <param name="Customer"></param>
    ''' <param name="InventoryIDs"></param>
    ''' <param name="Quantity"></param>
    ''' <param name="Price"></param>
    ''' <param name="Type"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ADDUPDATEOrderDetail(ByVal OrderDetailID As String, ByVal Order As String, ByVal Customer As String, ByVal InventoryIDs As String, ByVal Quantity As Decimal, ByVal Price As Decimal, ByVal Type As String,
                                         Units As String, PlusFuel As String, ByVal CalledFromVET As String,
                                         StoreNo As String,
                                         BoxCode As String,
                                         UpcCode As String,
                                         UPCPRICE As String,
                                         DateCode As String,
                                         Desc As String
                                         ) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            If StoreNo.Trim() = "" Then
                StoreNo = 0
            End If
            If CalledFromVET = "1" Then
                Return VET.ADDUPDATEVETDetail(OrderDetailID, Order, Customer, InventoryIDs, Quantity, Price, Type, User.Name, Units, PlusFuel, User.ID, BoxCode, StoreNo, UpcCode, UPCPRICE, DateCode, Desc)
            Else
                Return SalesOrder.ADDUPDATEOrderDetail(OrderDetailID, Order, Customer, InventoryIDs, Quantity, Price, Type, User.Name, Units, PlusFuel, User.ID, BoxCode, StoreNo, UpcCode, UPCPRICE, DateCode, Desc)
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ADDUPDATEOrderDetail")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetSaveOrderWarehouse(ByVal OrderNo As String, ByVal Customer As String) As Tuple(Of String, String)
        Try
            Return SalesOrder.GetSaveOrderWarehouse(OrderNo, Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSaveOrderWarehouse")
            Return New Tuple(Of String, String)("error", "")
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetSaveOrderWarehouseForVet(ByVal OrderNo As String) As String
        Try
            Return SalesOrder.GetSaveOrderWarehouseForVet(OrderNo)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSaveOrderWarehouse")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckAWBByOrderNo(ByVal Order As String, ByVal Customer As String) As String
        Try
            Return SalesOrder.CheckAWBByOrderNo(Order, Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSaveOrderWarehouse")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function LoadWareHouseDDLData() As List(Of WareHouseDDLModel)
        Try
            Dim UserDetails As User = Session("LoginUserDetails")
            Return SalesOrder.LoadWareHouseDDLData(UserDetails.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadWareHouseDDLData")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetInventoryAccessFromSession() As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return User.InventoryAccesstypes
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ADDUPDATEOrderDetail")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function AddFutureOrderDetail(ByVal OrderDetailID As String, ByVal Order As String, ByVal Customer As String, ByVal Flower As String, ByVal Farm As String, ByVal Quantity As Decimal, ByVal UOM As String,
                                                ByVal Price As Decimal, ByVal Cost As Decimal, ByVal Type As String, ByVal Units As String, BoxCode As String, ByVal UPC As String, ByVal UPCPRICE As String, ByVal DateCode As String, ByVal Notes As String, ByVal Desc As String, ByVal L As String, ByVal W As String, ByVal H As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.AddFutureOrderDetail(OrderDetailID, Order, Customer, Flower, Farm, Quantity, UOM, Price, Cost, Type, Units, User.Name, User.ID, BoxCode, UPC, UPCPRICE, DateCode, Notes, Desc, L, W, H)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddFutureOrderDetail")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddFutureVETDetail(ByVal Invoice As Integer, ByVal Customer As String, ByVal Flower As String, ByVal Farm As String, ByVal Quantity As Decimal, ByVal UOM As String,
                                                ByVal Price As Decimal, ByVal Units As String, BoxCode As String, ByVal UPC As String, ByVal UPCPRICE As String, ByVal DateCode As String, ByVal VETId As String, ByVal Desc As String, ByVal L As String, ByVal W As String, ByVal H As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return VET.AddFutureVETDetail(Invoice, Customer, Flower, Farm, Quantity, UOM, Price, Units, User.Name, User.ID, BoxCode, UPC, UPCPRICE, DateCode, VETId, Desc, L, W, H)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddFutureVETDetail")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteVETFutureOrderDetails(ByVal VETId As String) As String
        Try
            Return VET.DeleteVETFutureOrderDetails(VETId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteVETFutureOrderDetails")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetVETFutureOrderDetailsByID(ByVal ID As String) As BO.SalesDetail
        Try
            Return VET.GetVETFutureOrderDetailsByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetVETFutureOrderDetailsByID")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GenerateStandingInvoiceManual(ByVal Shipdate As String, ByVal IsStanding As String, ByVal IsPreBook As String, ByVal AWB As String, ByVal Warehouse As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.GenerateStandingInvoiceManual(Shipdate, IsStanding, IsPreBook, AWB, Warehouse, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GenerateStandingInvoiceManual")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GenerateStandingInvoiceManualFromTemp(ByVal Shipdate As String, ByVal IsStanding As String, ByVal IsPreBook As String, ByVal AWB As String, ByVal Warehouse As String, ByVal Farm As String, ByVal InvenToIgnore As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.GenerateStandingInvoiceManualFromTemp(Shipdate, IsStanding, IsPreBook, AWB, Warehouse, Farm, InvenToIgnore, User.Name, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GenerateStandingInvoiceManualFromTemp")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GenerateAllocationForFutureOrdersFromTemp(ByVal Warehouse As String, ByVal InvenToIgnore As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.GenerateAllocationForFutureOrdersFromTemp(Warehouse, InvenToIgnore, User.Name, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GenerateStandingInvoiceManualFromTemp")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteTempStandingOrder() As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.DeleteTempStandingOrder(User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteTempStandingOrder")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function ClearStandingOrders() As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.ClearStandingOrders()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearStandingOrders")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateQtyTempStandingOrder(ByVal SelectedStr As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.UpdateQtyTempStandingOrder(SelectedStr)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateQtyTempStandingOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetStandingOrderList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal ShipDate As String, ByVal IsStanding As String, ByVal IsPreBooks As String, ByVal AWB As String, ByVal Warehouse As String, ByVal Airport As String, ByVal InvenToIgnore As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SalesOrder


            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
            Dim FlowerColorVisibility As Boolean = False
            For Each i In UserFeatures
                If i.Name.ToLower = "show flower color" Then
                    FlowerColorVisibility = i.Value
                End If
            Next

            Dim data As List(Of BO.StandingOrder) = obj.GetStandingOrderList(ShipDate, IsStanding, IsPreBooks, AWB, Warehouse, Airport, InvenToIgnore, User.ID)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", "100"),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.SrNo),
                                        New XElement("cell", row.Flower),
                                        New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ColorCode.ToString() + ";'>" + row.FlowerName + "</a></div>", "<a >" + row.FlowerName + "</a>")),
                                        New XElement("cell", IIf(row.OrderedQty <> "0", row.OrderedQty, "")),
                                        New XElement("cell", row.UOM),
                                        New XElement("cell", IIf(row.UnitsPerBox <> "0", row.UnitsPerBox, "")),
                                        New XElement("cell", IIf(row.TotalAmt <> "0", Convert.ToDecimal(row.TotalAmt).ToString("N", CultureInfo.InvariantCulture), "")),
                                        New XElement("cell", IIf(Convert.ToInt16(row.DiffQty) < 0, IIf(Convert.ToInt16(row.OrderedQty) + Convert.ToInt16(row.DiffQty) > 0, "<span style='font-weight:bold;color:red;font-size: 13px;'>" + row.DiffQty.ToString() + "</span>", row.DiffQty), "")),
                                        New XElement("cell", row.ShipDay),
                                        New XElement("cell", row.Comments),
                                        New XElement("cell", row.ShipDate),
                                        New XElement("cell", row.Farm)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetStandingOrderList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetStandingOrderCustomerDetails(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                    ByVal FlowerCode As String, ByVal UOM As String, ByVal Unit As String, ByVal Comments As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SalesOrder



            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
            Dim FlowerColorVisibility As Boolean = False
            For Each i In UserFeatures
                If i.Name.ToLower = "show flower color" Then
                    FlowerColorVisibility = i.Value
                End If
            Next

            Dim data As List(Of BO.StandingOrder) = obj.GetStandingOrderCustomerDetails(FlowerCode, UOM, Unit, Comments, User.ID)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                    New XElement("rows", New XElement("page", page.ToString()),
                                    New XElement("total", "100"),
                                    data.Select(Function(row) New XElement("row", New XAttribute("id", row.SQLId),
                                    New XElement("cell", row.Customer),
                                    New XElement("cell", row.CustomerName),
                                    New XElement("cell", "<input type='text' style='width:50px' placeholder='" & IIf(row.OrderedQty = "0", "0", row.OrderedQty) & "' id='txtInvQty_" & row.SQLId.ToString() + "' readonly></input>"),
                                    New XElement("cell", row.UOM),
                                    New XElement("cell", IIf(row.UnitsPerBox <> "0", row.UnitsPerBox, "")),
                                    New XElement("cell", IIf(row.FOB <> "0", row.FOB, "")),
                                    New XElement("cell", IIf(row.TotalAmt <> "0", row.TotalAmt, "")),
                                    New XElement("cell", row.ShipDate),
                                    New XElement("cell", row.ShipDay),
                                    New XElement("cell", "<b><a href='#' id='btnReduceQty_" & row.SQLId.ToString() & "'><img src='images/minus.png'/></a></b>"),
                                    New XElement("cell", row.GPM),
                                    New XElement("cell", IIf(row.CreditHold = "Y", "<a id='aCustomerHoldSPORD_" + row.SQLId.ToString() + "'> <img style='cursor:pointer;width: 26px;height: 25px;margin-top: -6px;margin-bottom: -3px;margin-left:-4px;' src='images/ARInqHold.png' title='" + row.CreditReason + "'/></a>", "")),
                                    New XElement("cell", row.SalesPerson)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetStandingOrderCustomerDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetStandingOrderAllCustomerDetails(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal ShipDate As String, ByVal IsStanding As String, ByVal IsPreBooks As String, ByVal AWB As String, ByVal Warehouse As String, ByVal Farm As String, ByVal InvenToIgnore As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SalesOrder

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of BO.StandingOrder) = obj.GetStandingOrderAllCustomerDetails(ShipDate, IsStanding, IsPreBooks, AWB, Warehouse, Farm, InvenToIgnore, User.ID)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"FlowerName", "OrderedQty", "UOM", "UnitsPerBox", "DiffQty", "ShipDay"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("FlowerName").ColumnName = "Desc"
                dt.Columns("OrderedQty").ColumnName = "Boxes"
                dt.Columns("UOM").ColumnName = "UOM"
                dt.Columns("DiffQty").ColumnName = "Short"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "StandInv$StandInven")
                Return BuildXmlDoc(filepath)
            Else
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                Dim FlowerColorVisibility As Boolean = False
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next

                Dim data As List(Of BO.StandingOrder) = obj.GetStandingOrderAllCustomerDetails(ShipDate, IsStanding, IsPreBooks, AWB, Warehouse, Farm, InvenToIgnore, User.ID)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", "100"),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.SQLId),
                                            New XElement("cell", row.Customer),
                                            New XElement("cell", row.CustomerName),
                                            New XElement("cell", row.OrderedQty),
                                            New XElement("cell", row.UOM),
                                            New XElement("cell", IIf(row.UnitsPerBox <> "0", row.UnitsPerBox, "")),
                                            New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ColorCode.ToString() + ";'>" + row.FlowerName + "</a></div>", "<a >" + row.FlowerName + "</a>")),
                                            New XElement("cell", IIf(row.FOB <> "0", row.FOB, "")),
                                            New XElement("cell", IIf(row.TotalAmt <> "0", row.TotalAmt, "")),
                                            New XElement("cell", row.ShipDate),
                                            New XElement("cell", row.Carrier),
                                            New XElement("cell", row.GPM),
                                            New XElement("cell", IIf(row.CreditHold = "Y", "<a id='aCustomerHoldAllSPORD_" + row.SQLId.ToString() + "'> <img style='cursor:pointer;width: 26px;height: 25px;margin-top: -6px;margin-bottom: -3px;margin-left:-4px;' src='images/ARInqHold.png' title='" + row.CreditReason + "'/></a>", ""))))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetStandingOrderAllCustomerDetails")
            Return Nothing
        End Try
    End Function
    'Added by Anubhuti 03/08/2023
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateTransfertoHistory(Shipdate As String, ChkforZeroBoxes As Boolean) As String
        Try
            Return SalesOrder.UpdateTransfertoHistory(Shipdate, ChkforZeroBoxes)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateTransfertoHistory::PageOrder")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderAllocationList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal CargoDate As String, ByVal MarketToIgnore As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SalesOrder

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of BO.SalesOrderAllocation) = obj.GetSalesOrderAllocationList(CargoDate, MarketToIgnore, User.ID)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"FlowerName", "OrderedQty", "UOM", "UnitsPerBox", "FOB", "DiffQty", "Comments"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("FlowerName").ColumnName = "Desc"
                dt.Columns("OrderedQty").ColumnName = "Boxes"
                dt.Columns("UOM").ColumnName = "UOM"
                dt.Columns("DiffQty").ColumnName = "Short"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "SalesOrderInvv$StandInven")
                Return BuildXmlDoc(filepath)
            Else
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                Dim FlowerColorVisibility As Boolean = False
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next

                Dim data As List(Of BO.SalesOrderAllocation) = obj.GetSalesOrderAllocationList(CargoDate, MarketToIgnore, User.ID)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", "100"),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.SrNo),
                                            New XElement("cell", row.Flower),
                                            New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ColorCode.ToString() + ";'>" + row.FlowerName + "</a></div>", "<a >" + row.FlowerName + "</a>")),
                                            New XElement("cell", IIf(row.OrderedQty <> "0", row.OrderedQty, "")),
                                            New XElement("cell", row.UOM),
                                            New XElement("cell", IIf(row.UnitsPerBox <> "0", row.UnitsPerBox, "")),
                                            New XElement("cell", IIf(row.FOB <> "0", Convert.ToDecimal(row.FOB).ToString("N", CultureInfo.InvariantCulture), "")),
                                            New XElement("cell", IIf(Convert.ToInt16(row.DiffQty) < 0, IIf(Convert.ToInt16(row.OrderedQty) + Convert.ToInt16(row.DiffQty) > 0, "<span style='font-weight:bold;color:red;font-size: 13px;'>" + row.DiffQty.ToString() + "</span>", row.DiffQty), "")),
                                            New XElement("cell", row.ShipDay),
                                            New XElement("cell", row.ShipDate)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderAllocationList")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderAllocationInvoiceDetails(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal CargoDate As String, ByVal MarketToIgnore As String, ByVal FlowerCode As String, ByVal UOM As String, ByVal Unit As Integer) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SalesOrder

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of BO.SalesOrderAllocation) = obj.GetSalesOrderAllocationInvoiceDetails(CargoDate, MarketToIgnore, FlowerCode, Unit, User.ID, UOM)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)

                Dim selectedColumns As String() =
                    {"Customer", "CustomerName", "FlowerName", "OrderedQty", "UOM", "UnitsPerBox", "Price", "InvoiceNo", "ShipDate"}
                ' 
                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.DefaultView.Sort = "Customer ASC"
                dt = dt.DefaultView.ToTable
                dt.Columns("FlowerName").ColumnName = "Desc"
                dt.Columns("OrderedQty").ColumnName = "Boxes"
                dt.Columns("UOM").ColumnName = "UOM"
                'dt.Columns("ShortQty").ColumnName = "Short"
                Dim dtCloned As DataTable = dt.Clone()

                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "Allocation$Allocation")
                Return BuildXmlDoc(filepath)
            Else
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                Dim FlowerColorVisibility As Boolean = True
                'For Each i In UserFeatures
                '    If i.Name.ToLower = "show flower color" Then
                '        FlowerColorVisibility = i.Value
                '    End If
                'Next

                Dim data As List(Of BO.SalesOrderAllocation) = obj.GetSalesOrderAllocationInvoiceDetails(CargoDate, MarketToIgnore, FlowerCode, Unit, User.ID, UOM)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", "100"),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.SQLId),
                                            New XElement("cell", row.InvoiceNo),
                                            New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ColorCode.ToString() + ";'>" + row.FlowerName + "</a></div>", "<a >" + row.FlowerName + "</a>")),
                                            New XElement("cell", row.Customer),
                                            New XElement("cell", row.CustomerName),
                                            New XElement("cell", "<input type='text' style='width:50px' placeholder='" & IIf(row.OrderedQty = "0", "0", row.OrderedQty) & "' id='txtSOInvQty_" & row.SQLId.ToString() + "'  readonly disabled='disabled'></input>"),
                                            New XElement("cell", row.UOM),
                                            New XElement("cell", IIf(row.UnitsPerBox <> "0", row.UnitsPerBox, "")),
                                            New XElement("cell", IIf(row.Price <> "0", row.Price, "")),
                                            New XElement("cell", row.ShipDate),
                                            New XElement("cell", "<b><a href='#' id='btnSOReduceQty_" & row.SQLId.ToString() & "'><img src='images/minus.png'/></a></b>"),
                                            New XElement("cell", ""),
                                            New XElement("cell", row.GPM),
                                            New XElement("cell", IIf(row.CreditHold = "Y", "<a id='aCustomerHoldSalesOrder_" + row.SQLId.ToString() + "'> <img style='cursor:pointer;width: 26px;height: 25px;margin-top: -6px;margin-bottom: -3px;margin-left:-4px;' src='images/ARInqHold.png' title='" + row.CreditReason + "'/></a>", ""))))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderAllocationInvoiceDetails")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderAllocationInvoiceDetailsClear() As Integer
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim obj As New SalesOrder

            Dim count As Integer

            count = 0

            count = obj.GetSalesOrderAllocationInvoiceDetailsClear(User.ID)

            Return count

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderAllocationInvoiceDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesOrderAllocationInvoiceDetailsByCargoDt(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal CargoDate As String, ByVal MarketToIgnore As String, ByVal FlowerCode As String, ByVal Unit As Integer, ByVal UOM As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SalesOrder

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of BO.SalesOrderAllocation) = obj.GetSalesOrderAllocationInvoiceDetails(CargoDate, MarketToIgnore, FlowerCode, Unit, User.ID, UOM)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"FlowerName", "OrderedQty", "UOM", "UnitsPerBox", "DiffQty", "ShipDay"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("FlowerName").ColumnName = "Desc"
                dt.Columns("OrderedQty").ColumnName = "Boxes"
                dt.Columns("UOM").ColumnName = "UOM"
                dt.Columns("DiffQty").ColumnName = "Short"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "StandInv$StandInven")
                Return BuildXmlDoc(filepath)
            Else
                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                Dim FlowerColorVisibility As Boolean = False
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next

                Dim data As List(Of BO.SalesOrderAllocation) = obj.GetSalesOrderAllocationInvoiceDetails(CargoDate, MarketToIgnore, FlowerCode, Unit, User.ID, UOM)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", "100"),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.SQLId),
                        New XElement("cell", row.InvoiceNo),
                        New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ColorCode.ToString() + ";'>" + row.FlowerName + "</a></div>", "<a >" + row.FlowerName + "</a>")),
                        New XElement("cell", row.Customer),
                        New XElement("cell", row.CustomerName),
                        New XElement("cell", "<input type='text' style='width:45px;text-align:right;margin-top:-5px;' placeholder='" & IIf(row.OrderedQty = "0", "0", row.OrderedQty) & "' id='txtSOInvQty_" & row.SQLId.ToString() + "' readonly disabled='disabled'></input>"),
                        New XElement("cell", row.UOM),
                        New XElement("cell", IIf(row.UnitsPerBox <> "0", row.UnitsPerBox, "")),
                        New XElement("cell", "<input type='text' style='width:48px;margin-top:-5px;text-align:right;' placeholder='" & IIf(row.Price <> "0", row.Price, "") & "' id='txtSOInvPrice_" & row.SQLId.ToString() + "'></input>"),
                        New XElement("cell", "<div>" + row.ShipDate.ToString() + "</div>"),
                        New XElement("cell", "<b><a href='#' id='btnSOReduceQty_" & row.SQLId.ToString() & "'><img src='images/minus.png'/></a></b>"),
                        New XElement("cell", row.ShortQty),
                        New XElement("cell", row.GPM),
                        New XElement("cell", IIf(row.CreditHold = "Y", "<a id='aCustomerHoldSalesOrder_" + row.SQLId.ToString() + "'> <img style='cursor:pointer;width: 26px;height: 25px;margin-top: -6px;margin-bottom: -3px;margin-left:-4px;' src='images/ARInqHold.png' title='" + row.CreditReason + "'/></a>", "")),
                        New XElement("cell", row.LandedCost),
                        New XElement("cell", row.nPer0),
                        New XElement("cell", row.IsPriceCalculated),
                        New XElement("cell", row.SalesmanEmail)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderAllocationInvoiceDetails")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteTempSalesOrderAllocation() As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.DeleteTempSalesOrderAllocation(User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteTempStandingOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateQtyTempSalesOrderAllocation(ByVal SelectedStr As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Return SalesOrder.UpdateQtyTempSalesOrderAllocation(SelectedStr)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateQtyTempSalesOrderAllocation")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderDetailsForMISC(ByVal OrderDetailID As String, ByVal ReadFromVET As String) As BO.SalesDetail
        Try
            Return SalesOrder.GetOrderDetailsForMISC(OrderDetailID, ReadFromVET)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderDetailsForMISC")
            Throw ex
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderDetailsForPOByID(ByVal OrderDetailID As String) As BO.SalesDetail
        Try
            Return SalesOrder.GetOrderDetailsForPOByID(OrderDetailID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderDetailsForPOByID")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderDetailsByID(ByVal OrderDetailID As String) As BO.SalesDetail
        Try
            Return SalesOrder.GetOrderDetailsByID(OrderDetailID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderDetailsByID")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFutureOrderDetailsByID(ByVal OrderDetailID As String, ByVal ClosedInv As String) As BO.SalesDetail
        Try
            Return SalesOrder.GetFutureOrderDetailsByID(OrderDetailID, ClosedInv)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFutureOrderDetailsByID")
            Throw ex
        End Try
    End Function
    ''' <summary>
    ''' Mani:: Move Orderdetails from one order to anouther order
    ''' </summary>
    ''' <param name="OrderNo"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function DropOrderRowsIntoAnotherOrder(ByVal OrderNo As String, ByVal OrderDetailIDs As String, ByVal IsConsol As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If

            Return SalesOrder.DropOrderRowsIntoAnotherOrder(OrderNo, OrderDetailIDs, User.Name, IsConsol)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DropOrderRowsIntoAnotherOrder::PageOrder")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function InsertPrintOrderLog(ByVal OrderNo As String, ByVal PrintInvoice As String, ByVal PrintShippingReport As String, ByVal PrintPickingList As String, ByVal EmailInvoice As String, ByVal FaxInvoice As String, ByVal Customer As String, ByVal ShipDate As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            If User Is Nothing Then
                Return "Logout"
            End If
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            Dim MsgStr() As String
            Dim PicklistPrinted As String
            MsgStr = SalesOrder.InsertPrintOrderLog(OrderNo, PrintInvoice, PrintShippingReport, PrintPickingList, EmailInvoice, FaxInvoice, Customer, User.Name, ShipDate, User.ID).Split("~")

            PicklistPrinted = MsgStr(2).ToString()
            If (PrintInvoice = "Y" Or PrintInvoice = "E" Or PrintInvoice = "F" Or PrintInvoice = "P") Then
                Dim ToEmail As String
                ToEmail = User.Email + IIf(MsgStr(1).ToString() = "", "", "," + MsgStr(1).ToString())
                If CompanyName <> "BloomsUSA" Then
                    Dim unused = Logs.SendMail(User.Email, ToEmail, "", "", CompanyName + " Invoice: " + OrderNo + " ShipDate: " + Convert.ToDateTime(ShipDate.ToString()).ToString("MM-dd-yyyy") + " is CONFIRMED and Ready To Print")
                End If
            End If

            Return MsgStr(0).ToString()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::InsertPrintOrderLog::PageOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ScheduleOrders(ByVal OrderNo As String, ByVal EmailIDs As String, ByVal ShippingDate As String, ByVal IsEmailOrFax As String, ByVal Customer As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            If User Is Nothing Then
                Return "Logout"
            End If

            Return SalesOrder.ScheduleOrders(OrderNo, EmailIDs, ShippingDate, IsEmailOrFax, Customer, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ScheduleOrders")
            Return Nothing
        End Try
    End Function
    'Added by Anubhut 05/30/2023
    <System.Web.Services.WebMethod(True)>
    Public Function SaveVDropValues(ByVal invoice As String, ByVal orderid As String, ByVal quantity As String) As String
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            SalesOrder.InsertVDropValues(invoice, orderid, quantity, LoginUserDetails.Name)
            Return Nothing
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveVDropValues::PageCurrentOrdersForCustomer")
            Return Nothing
        End Try
    End Function



#End Region

#Region "ImportDBFToSql"


#End Region

#Region "PO"

    <System.Web.Services.WebMethod(True)>
    Public Function GetPOStatus() As List(Of BOPO)
        Try
            Return DAOPO.GetPOStatus()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOSTATUSList::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCancelReason() As List(Of BOPO)
        Try
            Return DAOPO.GetCancelReason()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCancelReason::PagePO")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetVoidReason() As List(Of BOPO)
        Try
            Return DAOPO.GetVoidReason()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetVoidReason::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadCarrierForPOEdit(ByVal Airline As String) As List(Of Carrier)
        Try
            Return Carriers.LoadCarrierForPOEdit(Airline)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadCarrierForPOEdit::PagePO")
            Return Nothing
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPurchaseOrderHeaderGridForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                                      ByVal ExportCSV As String, ByVal Fromdate As String, ByVal Todate As String, ByVal Buyer As String, ByVal Farm As String, ByVal Origin As String, ByVal Status As String, ByVal isCargo As Boolean, ByVal PONUM As String) As XmlDocument
        Try
            Dim newDoc As New XmlDocument()

            Dim DBFFilterCondition As String = ""
            Dim SQLFilterCondition As String = ""

            If isCargo Then
                SQLFilterCondition = "CONVERT(DATE,PODATE,103)>=CONVERT(DATE,'" + Fromdate + "',101) " + " And " + " CONVERT(DATE,PODATE,103)<=CONVERT(DATE,'" + Todate + "',101)"
            Else
                SQLFilterCondition = "CONVERT(DATE,SHIPDATE,103)>=CONVERT(DATE,'" + Fromdate + "',101) " + " And " + " CONVERT(DATE,SHIPDATE,103)<=CONVERT(DATE,'" + Todate + "',101)"
            End If


            If Buyer <> "" Then
                SQLFilterCondition += " AND H.PASSNAME='" + Buyer + "'"
                'DBFFilterCondition += " AND H.PASSNAME=" + Buyer
            End If
            If Farm <> "" Then
                SQLFilterCondition += " AND H.FARM='" + Farm + "'"
                'DBFFilterCondition += " AND H.FARM=" + Farm
            End If
            If Origin <> "" Then
                SQLFilterCondition += " AND C.CITY='" + Origin + "'"
                'DBFFilterCondition += " AND C.CITY=" + Origin
            End If
            If Status <> "" Then
                SQLFilterCondition += " AND H.POSTAT='" + Status + "'"
                'DBFFilterCondition += " AND H.POSTAT=" + Status
            End If


            If PONUM <> "" Then
                SQLFilterCondition = " H.PONUM LIKE '%" + PONUM + "%'"
            End If

            'Dim POHList = Nothing
            'If lReadFromSQL = False Then
            '    POHList = obj.GetPurchaseOrderHeaderGridForFgrd(DBFFilterCondition, SQLFilterCondition)
            'Else
            Dim POHList As List(Of BOPO) = DAOPO.GetPurchaseOrderHeaderGridForFgrd(SQLFilterCondition)
            'End If
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                'Dim data = obj.GetPurchaseOrderHeaderGridForFgrd(DBFFilterCondition, SQLFilterCondition)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(POHList)
                Dim selectedColumns As String() =
                    {"Emailed", "PONumber", "PODate", "Farm", "FarmName", "ShipDate", "PROStatus", "AIRPORT", "AWB", "CARRIER", "BOXES", "BOXESFBE", "ADDUSER", "ADDDATE", "ADDTIME", "UPDUSER", "UPDDATE", "UPDTIME"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "PurchaseOrderHeader")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                New XElement("rows", New XElement("page", page.ToString()),
                                New XElement("total", POHList.Count),
                                POHList.Select(Function(row) New XElement("row", New XAttribute("id", row.PONumber), New XAttribute("style", ChangeBgColorBasedOnPurchaseOrderStatus(row.PROStatus, row.IsDiffQty)),
                                New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='PurchaseListselect_" & row.PONumber.ToString() & "' src='images/check-off.png' />"),
                                New XElement("cell", "<b><a href='#' id='editPOHeader_" & row.PONumber.ToString() & "'><img src='images/Edit.png'/></a></b>"),
                                New XElement("cell", row.PONumber),
                                New XElement("cell", row.Farm),
                                New XElement("cell", String.Format("<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                    row.FarmName.Replace("'", "") + "'>" & row.FarmName & "</div>")),
                                New XElement("cell", DateTime.Parse(row.PODate).ToString("MM/dd/yyyy")),
                                New XElement("cell", row.PROStatus),
                                New XElement("cell", DateTime.Parse(row.ShipDate).ToString("MM/dd/yyyy")),
                                New XElement("cell", Convert.ToDateTime(row.ShipDate).DayOfWeek.ToString()),
                                New XElement("cell", row.Airport),
                                New XElement("cell", row.WH),
                                New XElement("cell", row.Carrier),
                                New XElement("cell", row.BOXESFBE.ToString("#,###0.000")),
                                New XElement("cell", row.Boxes),
                                New XElement("cell", row.TotalUnits.ToString("#,##0")),
                                New XElement("cell", row.RECEIVEDBOXES),
                                New XElement("cell", "$" + row.TotalCost.ToString("#,##0.00")),
                                New XElement("cell", row.GPM.ToString("#,##0.00")),
                                New XElement("cell", row.AWB),
                                New XElement("cell", row.Comments),
                                New XElement("cell", IIf(row.Emailed = True, "<img style='Cursor:pointer;margin-top:-3px' id='EmailedPoSelect_" & row.PONumber.ToString() & "' src='images/check-on.png' />", "")),
                                New XElement("cell", "<img style='cursor:pointer;margin-left:-4px;' title='" + GetPersonIconDetails(row.ADDUSER, Convert.ToDateTime(row.ADDDATE).ToString("MM/dd/yyyy"), row.ADDTIME, row.ADDAPP, row.UPDUSER, Convert.ToDateTime(row.UPDDATE).ToString("MM/dd/yyyy"), row.UPDTIME, row.UPDAPP, "", "", "", "", "", "", "", "") + "' id='imgaddeditDetails_" + row.PONumber.ToString() + "' src='images/Edit_user.png' />")))))
                newDoc.LoadXml(xmlDoc.ToString())
                Dim idx As Integer = POHList.Count - 1
                If (idx > 0) Then

                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = "Total"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                End If
                Return newDoc

            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPurchaseOrderHeaderGridForFgrd::PageConfirmedPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadAllFiltersDataForPOList(ByVal Fromdate As String, ByVal Todate As String, ByVal Buyer As String, ByVal Farm As String, ByVal Origin As String, ByVal Status As String, ByVal isCargo As String) As List(Of BOPO)
        Try
            Return DAOPO.LoadAllFiltersDataForPOList(Fromdate, Todate, Buyer, Farm, Origin, Status, isCargo)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadAllFiltersDataForPOList::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetConfirmPOByPONumber(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                                  ByVal ExportCSV As String, ByVal PONumber As String) As XmlDocument
        Try


            Dim newDoc As New XmlDocument()

            If (ExportCSV <> "") Then

                'Dim splitExportcsv = ExportCSV.Split("|")

                'Dim data = obj.GetPurchaseOrderHeaderGridForFgrd(DBFFilterCondition, SQLFilterCondition)

                'Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                'Dim selectedColumns As String() =
                '    {"PONumber", "PODate", "Farm", "FarmName", "ShipDate", "PROStatus", "AIRPORT", "AWB", "CARRIER", "BOXES", "BOXESFBE"}

                'Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'Dim dtCloned As DataTable = dt.Clone()
                'For Each row As DataRow In dt.Rows
                '    dtCloned.ImportRow(row)
                'Next
                'Dim filepath = ExporttoExcel(dtCloned, "PurchaseOrderHeader")
                'Return BuildXmlDoc(filepath)
            Else

                Dim obj As New DAOPO.PODetails
                Dim data = obj.GetPODetailsForConfirm(PONumber)

                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")

                Dim FlowerColorVisibility As Boolean = False
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", data.Count),
                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID),
                            New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='Conselect_" & row.DetailID.ToString() & "' src='images/check-off.png' />"),
                            New XElement("cell", row.Farm),
                            New XElement("cell", "<a id='txtProdCodQ_" + row.DetailID.ToString() + "'>" + Convert.ToString(row.ProdCodeq).ToString() + "</a>"),
                            New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ForeColor.ToString() + ";' id='txtProdNameQ_" + row.DetailID.ToString() + "'>" + row.ProdNameq + "</a></div>", "<a id='txtProdNameQ_" + row.DetailID.ToString() + "'>" + row.ProdNameq + "</a>")),
                            New XElement("cell", "<a id='txtOrderQTY_" + row.DetailID.ToString() + "'>" + IIf(Convert.ToDecimal(row.QTYBOX) = 0, "0", Convert.ToDecimal(row.QTYBOX).ToString()) + "</a>"),
                            New XElement("cell", "<a id='txtConfirmQTY_" + row.DetailID.ToString() + "'>" + IIf(Convert.ToDecimal(row.QtyBConf) = 0, "0", Convert.ToDecimal(row.QtyBConf).ToString()) + "</a><input type='text' style='display:none;width:50px;margin-top:-1px' class='NumbersOnly' placeholder='" & IIf(Convert.ToDecimal(row.QtyBConf) = 0, "0", Convert.ToDecimal(row.QtyBConf).ToString()) & "' id='editConfirmQTY_" & row.DetailID.ToString() + "' onblur=ValidateConfirmQty('editConfirmQTY_" & row.DetailID.ToString() + "')></input>"),
                            New XElement("cell", row.UOM),
                            New XElement("cell", row.QtyXBox),
                            New XElement("cell", row.QtyUnit.ToString("#,##0")),
                            New XElement("cell", row.UnitCosq),
                            New XElement("cell", row.CustNumber),
                            New XElement("cell", row.PoStatus),
                            New XElement("cell", row.SPORDID),
                            New XElement("cell", row.ORDER2ID),
                            New XElement("cell", row.PONumber),
                            New XElement("cell", row.BoxNumber)))))

                newDoc.LoadXml(xmlDoc.ToString())
                Dim idx As Integer = data.Count - 1

                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = "Total"
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetConfirmPOByPONumber::PagePO")
            Return Nothing
        End Try
        Return Nothing
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function POListForDrop(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                                  ByVal ExportCSV As String, ByVal Farm As String, ByVal PONUM As String) As XmlDocument
        Try
            Dim newDoc As New XmlDocument()

            If (ExportCSV <> "") Then

            Else
                Dim obj As New DAOPO.PODetails
                Dim data = obj.POListForDrop(Farm, PONUM)
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", data.Count),
                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.HeaderID),
                            New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='POselect_" & row.PONumber.ToString() & "' src='images/check-off.png' />"),
                            New XElement("cell", row.PONumber),
                            New XElement("cell", row.ShipDate),
                            New XElement("cell", row.TOTALVALUE)))))
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::POListForDrop::PagePO")
            Return Nothing
        End Try
        Return Nothing

    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPODetailsByPONumberFromSQL(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                                  ByVal ExportCSV As String, ByVal PONumber As String) As XmlDocument
        Try
            Dim newDoc As New XmlDocument()
            If (ExportCSV <> "") Then
                'Dim splitExportcsv = ExportCSV.Split("|")

                'Dim data = obj.GetPurchaseOrderHeaderGridForFgrd(DBFFilterCondition, SQLFilterCondition)

                'Dim dt1 As DataTable

                'dt1 = ConvertToDataTable(data)
                'Dim selectedColumns As String() =
                '    {"PONumber", "PODate", "Farm", "FarmName", "ShipDate", "PROStatus", "AIRPORT", "AWB", "CARRIER", "BOXES", "BOXESFBE"}

                'Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'Dim dtCloned As DataTable = dt.Clone()
                'For Each row As DataRow In dt.Rows
                '    dtCloned.ImportRow(row)
                'Next
                'Dim filepath = ExporttoExcel(dtCloned, "PurchaseOrderHeader")
                'Return BuildXmlDoc(filepath)
            Else

                Dim obj As New DAOPO.PODetails
                Dim data = obj.GetPODetailsByPONumberFromSQL(PONumber)

                Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")

                Dim FlowerColorVisibility As Boolean = False
                For Each i In UserFeatures
                    If i.Name.ToLower = "show flower color" Then
                        FlowerColorVisibility = i.Value
                    End If
                Next
                'Modified by Anubhuti 2024_01_30
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", data.Count),
                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID),
                            New XElement("cell", "<img style='Cursor:pointer;margin-top:-3px' id='Detselect_" & row.PONumber.ToString() & "~" & row.Ord.ToString() & "' src='images/check-off.png' />"),
                            New XElement("cell", "<b><a href='#' id='deletePOdetail_" & row.PONumber.ToString() & "~" & row.Ord.ToString() & "'><img src='images/Delete-icon.png'/></a></b>"),
                            New XElement("cell", "<b><a href='#' id='editPOdetail_" & row.PONumber.ToString() & "~" & row.Ord.ToString() & "'><img src='images/Edit.png'/></a></b>"),
                            New XElement("cell", row.Ord),
                            New XElement("cell", row.Type),
                            New XElement("cell", row.Farm),
                            New XElement("cell", row.ProdCodeq),
                            New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ForeColor.ToString() + ";'>" + row.ProdNameq + "</a></div>", "<a >" + row.ProdNameq + "</a>")),
                            New XElement("cell", row.BoxNumber),
                            New XElement("cell", row.QTYBOX),
                            New XElement("cell", row.UOM),
                            New XElement("cell", row.BunXBox),
                            New XElement("cell", row.StemXBun),
                            New XElement("cell", row.QtyXBox),
                            New XElement("cell", row.QtyUnit.ToString("#,##0")),
                            New XElement("cell", row.UnitSalq),
                            New XElement("cell", row.UnitCosq),
                            New XElement("cell", (row.TotalCost).ToString("#,##0.00")),
                            New XElement("cell", row.GPM),
                            New XElement("cell", IIf(row.CustNumber <> "" And row.SPORDID <> "", "<div style='padding-bottom: 3px;Cursor:pointer;' class='flowerDescription'><a href='#' id='aCustomer_" + row.CustNumber.ToString() + "'>" + row.CustNumber.ToString() + "</a></div>", row.CustNumber)),
                            New XElement("cell", row.CustSHDate),
                            New XElement("cell", row.Day),
                            New XElement("cell", row.ShipDate),
                            New XElement("cell", row.Days),
                            New XElement("cell", "<a style='cursor:pointer;text-decoration:underline;' id='aPOOrderNo_" + row.Order.ToString() + "' data-customer='" + row.CustNumber.ToString() + "' data-isclosedorder='" + row.IsClosedOrder + "' >" + row.Order.ToString() + "</a>"),
                            New XElement("cell", row.Brand),
                            New XElement("cell", row.BoxCode),
                            New XElement("cell", row.Upc),
                            New XElement("cell", row.UpcDesc),
                            New XElement("cell", row.DateCode),
                            New XElement("cell", row.UpcPrice),
                            New XElement("cell", row.Freight),
                            New XElement("cell", row.Duties),
                            New XElement("cell", row.Comments),
                            New XElement("cell", ""),
                            New XElement("cell", row.PoStatus),
                            New XElement("cell", row.SPORDID),
                            New XElement("cell", row.ORDER2ID),
                            New XElement("cell", row.PONumber),
                            New XElement("cell", ""),
                            New XElement("cell", "")))))

                newDoc.LoadXml(xmlDoc.ToString())
                Dim idx As Integer = data.Count - 1

                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = "Total"
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""
                'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(17).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(18).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(19).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(20).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(21).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(22).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(23).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(24).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(25).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(26).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(27).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(28).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(29).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(30).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(31).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(32).InnerText = ""
                newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(33).InnerText = ""
                Return newDoc

            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPODetailsByPONumberFromSQL::PageConfirmedPO")
            Return Nothing
        End Try
        Return Nothing
    End Function
    'Added by Anubhuti 2023_10_12
    <System.Web.Services.WebMethod(True)>
    Public Function ImportRecipeToPOQSubAssembly(ByVal PONUM As String) As String
        Try
            Dim User As New User
            If Not Session("UserDetails") Is Nothing Then
                User = Session("UserDetails")
            End If
            Return DAOPO.ImportRecipeToPOQSubAssembly(PONUM)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::Save::ImportRecipeToPOQSubAssembly::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPOProductPurchaseDetailsTempGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                             ByVal TempPOHeaderID As String, ByVal ExportCSV As String) As XmlDocument

        Try
            Dim whereCondition As String = ""

            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BOPO), qtype, query)
            End If
            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1
            Dim obj As New DAOPO.PurchaseList
            Dim data As List(Of BOPO) = obj.GetPurchaseListDetailsFromTempByPOID(TempPOHeaderID)

            Dim FlowerColorVisibility As Boolean = False
            Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")

            For Each i In UserFeatures
                If i.Name.ToLower = "show flower color" Then
                    FlowerColorVisibility = i.Value
                End If
            Next

            Dim TotalRowCount As Integer = 0
            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                      New XElement("rows", New XElement("page", page.ToString()),
                      New XElement("total", data.Count),
                      data.Select(Function(row) New XElement("row", New XAttribute("id", row.DetailID),
                      New XElement("cell", "<b><a href='#' id='deletePOTempdetail_" & row.DetailID.ToString() & "'><img src='images/Delete-icon.png'/></a></b>"),
                      New XElement("cell", "<b><a href='#' id='editPOTempdetail_" & row.DetailID.ToString() & "'><img src='images/Edit.png'/></a></b>"),
                      New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px' id='POTemptick_" & row.DetailID.ToString() & "' src='images/check-off.png' />")),
                      New XElement("cell", row.Farm),
                      New XElement("cell", row.Flower),
                      New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.BGColor.ToString() + "' class='flowerDescription'><a style='color:" + row.ForeColor.ToString() + ";'>" + row.Flowername + "</a></div>", "<a >" + row.Flowername + "</a>")),
                      New XElement("cell", IIf(row.DetailID = 0, "<a href='#' style='display:block;text-decoration: none;' id='editTotalBoxeslinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" + row.Boxes.ToString() + "</a>", "<a href='#' style='display:block;text-decoration: none;'  id='editBoxeslinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" & row.Boxes.ToString() &
                                           "</a><input type='text' style='display:none;width:35px' placeholder='" & row.Boxes.ToString() & "' class='NumbersOnly'  id='editBoxestextOnTempPODetailGrid_" & row.DetailID.ToString() & "' maxlength='5'></input>")),
                      New XElement("cell", row.UOM),
                      New XElement("cell", "<a href='#' style='display:block;text-decoration: none;' id='editUnitsBunchlinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" & row.UnitsPerBunch.ToString() &
                                           "</a><input type='text' style='display:none;width:50px' class='NumbersOnly editUnitsBunchtext' placeholder='" & row.UnitsPerBunch.ToString() & "' id='editUnitsBunchtextOnTempPODetailGrid_" & row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:block;text-decoration: none;' id='editUnitslinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" & row.UnitsPerBox.ToString() &
                                           "</a><input type='text' style='display:none;width:50px' class='NumbersOnly editUnitstext' placeholder='" & row.UnitsPerBox.ToString() & "' maxlength='4' id='editUnitstextOnTempPODetailGrid_" & row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:block;text-decoration: none;' id='editTotalUnitslinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" + row.TotalUnits.ToString() + "</a>"),
                      New XElement("cell", "<a href='#' style='display:block;text-decoration: none;' id='editCostlinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" & row.Cost.ToString() &
                                           "</a><input type='text' style='display:none;width:50px' class='DecimalsOnly editCosttext' placeholder='" & row.Cost & "' id='editCosttextOnTempPODetailGrid_" & row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:block;text-decoration: none;' id='editTotalCostlinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>$" + row.TotalCost.ToString("#,##0.00") + "</a>"),
                      New XElement("cell", "<a href='#' style='display:block; text-decoration:none;' title='" + IIf(row.Type = "", "", row.Type) + "' id='editTypelinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.Type = "", "", row.Type) & "</a><input type='text' style='display:none;width:50px;padding: 1px;' maxlength='1' class='AllUpperCaseTextBox SpecifiedCharOnly' placeholder='" & row.Type & "' id='editTypetextOnTempPODetailGrid_" &
                                           row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:block; text-decoration:none;' id='editCustNumberlinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.CustNumber = "0", "", row.CustNumber) & "</a><input type='text' style='display:none;width:100px' maxlength='5' class='NumbersOnly' placeholder='" & row.CustNumber & "' id='editCustNumbertextOnTempPODetailGrid_" &
                                           row.DetailID.ToString() & "'></input>"),
                      New XElement("cell", "<a href='#' style='display:block;text-decoration: none;' title='" + row.Comments + "' href ='#' id='editCommentslinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.Comments = "", "", row.Comments) & "</a><input type='text' style='display:none;width:200px' maxlength='120' placeholder='" & row.Comments & "' id='editCommentstextOnTempPODetailGrid_" &
                                           row.DetailID.ToString() & "'></input>"),
                       New XElement("cell", "<a href='#' style='display:block; text-decoration:none;' title='" + IIf(row.BoxCode = "", "", row.BoxCode) + "' id='editBoxCodelinkOnTempPODetailGrid_" & row.DetailID.ToString() & "'>" &
                                           IIf(row.BoxCode = "", "", row.BoxCode) & "</a><input type='text' style='display:none;width:100px' maxlength='15' placeholder='" & row.BoxCode & "' id='editBoxCodetextOnTempPODetailGrid_" &
                                           row.DetailID.ToString() & "'></input>")))))



            Dim newDoc As New XmlDocument()
            Dim idx As Integer = data.Count - 1
            newDoc.LoadXml(xmlDoc.ToString())
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = "Total"
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(9).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(10).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""
            'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(12).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(13).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(14).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(15).InnerText = ""
            newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(16).InnerText = ""



            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOProductPurchaseDetailsTempGrid::PageManualPO")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function DeletePOTempdetail(ByVal Id As Integer) As String
        Try
            Dim obj As New DAOPO.PurchaseList
            Return obj.DeletePOTempdetail(Id)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateInlineEditDetailsTempPurchaseDetails::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPOHistoryList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
    ByVal query As String, ByVal qtype As String, ByVal Filter As String, ByVal PONumber As String, ByVal ExportCSV As String) As XmlDocument
        Try

            Dim whereCondition As String = ""

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If
            whereCondition = whereCondition.Replace("&lt;&gt;", "<>")

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of BOPO.POHistory) = DAOPO.GetPOHistoryList(whereCondition, sortExp, start, splitExportcsv(2))

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"PONUM", "ADDDATE", "ADDTIME", "ADDUSER", "LOGTEXT"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("ADDDATE").ColumnName = "Date"
                dt.Columns("ADDTIME").ColumnName = "Time"
                dt.Columns("ADDUSER").ColumnName = "Person"
                dt.Columns("LOGTEXT").ColumnName = "Note"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                dtCloned.Columns("Date").DataType = GetType(String)
                dtCloned.Columns("Time").DataType = GetType(String)
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1))
                Return BuildXmlDoc(filepath)

            Else
                Dim data As List(Of BOPO.POHistory) = DAOPO.GetPOHistoryList(whereCondition, sortExp, start, rp)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", data.Count.ToString()),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.PONUM.ToString()), New XAttribute("background-color", ""), New XAttribute("color", ""),
                        New XElement("cell", IIf(row.PONUM.ToString() = "0", "", row.PONUM.ToString())),
                        New XElement("cell", If(row.ADDDATE = Convert.ToDateTime("01/01/1900"), "", row.ADDDATE.ToString("MM/dd/yyyy HH:mm:ss"))),
                        New XElement("cell", IIf(row.ADDUSER = "", "", row.ADDUSER)),
                        New XElement("cell", IIf(row.LOGTEXT = "", "", row.LOGTEXT))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetPOHistoryList()::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateInlineEditDetailsTempPurchaseDetails(ByVal Details As String) As String
        Try
            Dim result = DAOPO.UpdateInlineEditDetailsTempPurchaseDetails(Details)
            If result = "success" Then
                Return result
            Else
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    User = Session("LoginAdminDetails")
                End If
                Logs.SendErrorEmail(User, result, "", "Error Notification", "error")
                Return "error"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateInlineEditDetailsTempPurchaseDetails::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DropItemFromPO(ByVal PONUMBER As String, ByVal SHIPDATE As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim PONum As String = ""
            PONum = DAOPO.GetPONumberFromSalesMan(User.SalesPerson)

            If PONum.Contains("Sorry") Then
                Return PONum
            End If

            Dim FinalBoxNo As String = ""
            Dim BoxnumberResult As String

            BoxnumberResult = DAOPO.GetBoxNumberFromConstant()


            If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
                Return BoxnumberResult
            Else
                FinalBoxNo = BoxnumberResult
            End If

            Dim startboxno As Integer = (Convert.ToUInt32(FinalBoxNo))


            Return DAOPO.DropItemFromPO(PONUMBER, PONum, SHIPDATE, startboxno, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DropItemfromPO::DropItemFromPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DropItemToNewPO(ByVal OLDPONUMBER As String, ByVal NEWPONUMER As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAOPO.DropItemToNewPO(OLDPONUMBER, NEWPONUMER, User.Name, User.ID)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DropItemToNewPO::DropItemToNewPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteZeroValueInTempPO(ByVal TempPOHeaderID As String) As String
        Try
            Return DAOPO.DeleteZeroValueInTempPO(TempPOHeaderID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteZeroValueInTempPO::PagePO")
            Return "error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function ConfirmPurchaseOrderPO(ByVal XMLString As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Return DAOPO.ConfirmPurchaseOrderPO(XMLString, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ConfirmPurchaseOrderPO::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CancelPurchaseOrder(ByVal POList As String, ByVal Reason As String, ByVal COMMENT As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAOPO.CancelPurchaseOrder(POList, Reason, COMMENT, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CancelPurchaseOrder::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function VoidPurchaseOrder(ByVal POList As String, ByVal Reason As String, ByVal COMMENT As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAOPO.VoidPurchaseOrder(POList, Reason, COMMENT, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::VoidPurchaseOrder::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ValidateBeforeDuplicate(ByVal PONUM As String) As String
        Try
            Return DAOPO.ValidateBeforeDuplicate(PONUM)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ValidateBeforeDuplicate::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPOHeaderDataByPONumber(ByVal PONumber As String) As BOPO
        Try
            Return DAOPO.GetPOHeaderDataByPONumber(PONumber)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOHeaderDataByPONumber::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPOQDetailForUpdate(ByVal PONumber As String, ByVal ORD As String, ByVal POQId As String) As BOPO
        Try
            Return DAOPO.GetPOQDetailForUpdate(PONumber, ORD, POQId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPOQDetailForUpdate::PagePO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ClearTempPOInformation(ByVal TempPOHeaderID As String) As String
        Try
            Return DAOPO.ClearTempPOInformation(TempPOHeaderID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ClearTempPOInformation::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CreatePO(ByVal TempPOHeaderID As String, ByVal ShipDate As String, ByVal Farm As String, ByVal TotalPODetailsCount As Integer, ByVal Status As String, ByVal AWB As String, ByVal Invoice As Integer) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim PONumber As String = ""
            PONumber = DAOPO.GetPONumberFromSalesMan(User.SalesPerson)

            If PONumber.Contains("Sorry") Then
                Return PONumber
            End If

            Dim BoxnumberResult As String
            BoxnumberResult = DAOPO.GetBoxNumberFromConstant(TotalPODetailsCount - 1)
            'End If

            If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
                Return BoxnumberResult
            End If

            'Commented By Prashant Due To Generate Wrong Box num on 03/31/2020
            'Dim startboxno As Integer = (Convert.ToUInt32(FinalBoxNo) - TotalPODetailsCount)
            'Return DAOPO.CREATEPO(TempPOHeaderID, ShipDate, Farm, PONumber, User.SalesPerson, startboxno, User.Name, Status)
            Dim Result As String
            Result = DAOPO.CREATEPO(TempPOHeaderID, ShipDate, Farm, PONumber, BoxnumberResult, User.ID, Status, AWB, Invoice)

            Dim newlyInsertedIds As String
            newlyInsertedIds = Result.Split("~")(1)
            Result = Result.Split("~")(0)
            If (AWB IsNot "" And Invoice > 0) Then
                UpdateMAWBAndHAWB(AWB, AWB, Invoice, newlyInsertedIds)
            End If
            Return Result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreatePO::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdatePO(ByVal PONUMBER As String, ByVal Farm As String, ByVal Warehouse As String, ByVal ShipDate As String, ByVal Type As String, ByVal POStatus As String, ByVal Agency As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAOPO.UPDATEPO(PONUMBER, Farm, Warehouse, ShipDate, Type, POStatus, Agency, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UPDATEPO::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GenerateStandingPurchaseOrders(ByVal Shipdate As String, ByVal AllWeek As String, ByVal Repeat As String, ByVal FARM As String, ByVal Customer As String, ByVal IgnoreCustomer As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAOPO.GenerateStandingPurchaseOrders(Shipdate, AllWeek, Repeat, FARM, Customer, IgnoreCustomer, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CreatePO::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExecuteCloseWeek() As String
        Try
            Return SalesOrder.ExecuteCloseWeek()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExecuteCloseWeek")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintHoldStandingOrderList() As String
        Try
            Dim dt1 As DataTable
            dt1 = DAOPO.PrintHoldStandingOrderList()
            Dim selectedColumns As String() = {"CUSTOMER", "CUSTOMERNAME", "FARM", "FARMNAME", "FLOWER", "DESCRIPTION", "ORDEREDQTY", "HOLDQTY", "HOLDFROM", "HOLDTO", "CARGODAY", "TRUCKDAY"}
            If (dt1.Rows.Count > 0) Then
                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "HoldSOList$FileReports")
                Return filepath
            Else
                Return "NO Data"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintHoldStandingOrderList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UPDATECOMMENT(ByVal PONUMBER As String, ByVal COMMENT As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAOPO.UPDATECOMMENT(PONUMBER, COMMENT, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UPDATEPO::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCommentByPONumber(ByVal PONUMBER As String) As String
        Try
            Return DAOPO.GetCommentByPONumber(PONUMBER)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCommentByPONumber::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DuplicatePurchaseOrder(ByVal PONUMBER As String, ByVal SHIPDATE As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim PONum As String = ""
            'If lReadFromSQL = False Then
            '    PONum = GetSLSMANPONum(User.SalesPerson)
            'Else
            PONum = DAOPO.GetPONumberFromSalesMan(User.SalesPerson)
            'End If
            If PONum.Contains("Sorry") Then
                Return PONum
            End If

            Dim FinalBoxNo As String = ""
            Dim BoxnumberResult As String
            'If lReadFromSQL = False Then
            '    BoxnumberResult = obj.GetMultipleBoxNumberFromConstant("0", User.Name)
            'Else
            BoxnumberResult = DAOPO.GetBoxNumberFromConstant()
            'End If

            If BoxnumberResult = "error" Or BoxnumberResult.Contains("Wait") Then
                Return BoxnumberResult
            Else
                FinalBoxNo = BoxnumberResult
            End If

            Dim startboxno As Integer = (Convert.ToUInt32(FinalBoxNo))


            Return DAOPO.DuplicatePO(PONUMBER, PONum, SHIPDATE, startboxno, User.Name)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UPDATEPO::DuplicatePurchaseOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DELETEPORDetail(PONUMBER As String, POQId As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return DAOPO.DELETEPODetail(PONUMBER, User.Name, POQId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UPDATEPO::PagePO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ADDUPDATEPODetailToPOQ(ByVal PONumber As String, ByVal Farm As String, ByVal Flower As String, ByVal Boxes As String, ByVal UOM As String, ByVal UnitsPerBunch As String, ByVal UnitsPerBox As String,
                                     ByVal CostPerUnits As String, ByVal Type As String, ByVal Comments As String, ByVal CustNumber As String, ByVal BoxCode As String, ByVal BreakDown As String, ByVal Flag As String,
                                     ByVal ORD As String, ByVal POQId As String, ByVal UPC As String, ByVal UPCDesc As String, ByVal UPCPrice As String, ByVal DateCode As String, ByVal FoodDesc As String,
                                           ByVal PickDesc As String, ByVal SleeveDesc As String) As String

        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If Flag = "I" Then
                Return DAOPO.ADDPODetailToPOQ(PONumber, Farm, Flower, Boxes, UOM, UnitsPerBunch, UnitsPerBox, CostPerUnits, Type, Comments, CustNumber, BoxCode, BreakDown, User.Name, UPC, UPCDesc, UPCPrice, DateCode, FoodDesc, PickDesc, SleeveDesc)
            Else
                Return DAOPO.UPDATEPODetailToPOQ(PONumber, Farm, Flower, Boxes, UOM, UnitsPerBunch, UnitsPerBox, CostPerUnits, Type, Comments, CustNumber, BoxCode, BreakDown, User.Name, ORD, POQId, UPC, UPCDesc, UPCPrice, DateCode, FoodDesc, PickDesc, SleeveDesc)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ADDPODetailToPOQ::PagePO")
            Return "error"
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ChangeBgColorBasedOnPurchaseOrderStatus(ByVal Prostatus As String, ByVal IsDiffQty As Integer) As String
        Try
            If (Prostatus = "EMAILED") Then
                Return "background:RGB(0,255,255)"
            ElseIf (Prostatus = "COMPLETED") Then
                Return "background:RGB(145,255,200)"
            ElseIf (Prostatus = "CANCELLED") Then
                Return "background:RGB(191, 21, 21)"
            ElseIf (Prostatus = "VOIDED") Then
                Return "background:RGB(191, 134, 21)"
            ElseIf (Prostatus = "PENDING") Then
                Return "background:RGB(230, 230, 31)"
            ElseIf (Prostatus = "POSTED" Or (Prostatus = "AC POSTED" And IsDiffQty = 0)) Then
                Return "background:RGB(192,192,192)"
            ElseIf (Prostatus = "AC POSTED" And IsDiffQty = 1) Then
                Return "background:RGB(32,143,241)"
            ElseIf (Prostatus = "") Then
                Return ""
            Else
                Return "background:RGB(255,128,128)"
            End If
        Catch ex As Exception
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ChangeBgColorBasedOnSalesOrderStatus(ByVal Farm As String, ByVal Awb As String, ByVal PODflower As String, ByVal POStatus As String, ByVal InvenType As String) As String
        Try
            If Farm = "ZZ" Then
                Return ""
            ElseIf (Awb = 0 And Trim(PODflower) = "") Then
                Return "background:RGB(255,105,180)"   'Pink
            ElseIf (Awb = 0 And PODflower <> "" And POStatus = "CONFIRMED") Then
                Return "background:RGB(255,255,0)"     'yellow
            ElseIf (Awb = 0 And PODflower <> "" And POStatus <> "CONFIRMED") Then
                Return "background:RGB(0,255,0)"       'green
            ElseIf Awb <> 0 And InvenType = "A" Then
                Return "background:RGB(255,0,0)"       'red
            End If
        Catch ex As Exception
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SavePurchaseListToTemp(ByVal Farm As String) As String
        Try
            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Or SessionStatus = "" Then
                Return "LogOut"
            End If
            'end

            Dim data As List(Of BOFarmPR) = DAOFarmPR.GetPurchaseDetailsFromFarmPR(Farm)

            Dim DetailsList = New XElement("PurchaseDetails",
                        From PurchaseDetails In data
                        Select New XElement("PO", "",
                            New XElement("Farm", PurchaseDetails.Farm),
                            New XElement("Flower", PurchaseDetails.Flower),
                            New XElement("FlowerName", PurchaseDetails.Flowername),
                            New XElement("Quantity", 0),
                            New XElement("UOM", PurchaseDetails.UOM),
                            New XElement("UnitsPerBunch", PurchaseDetails.UnitsPerBunch),
                            New XElement("Units", PurchaseDetails.UnitsPerBox),
                            New XElement("CostPerUnits", PurchaseDetails.Cost),
                            New XElement("CAT", PurchaseDetails.FlowerCategory),
                            New XElement("ColorCode", PurchaseDetails.ColorCode),
                            New XElement("ForeColor", PurchaseDetails.ForeColor),
                            New XElement("BGColor", PurchaseDetails.BGColor)))


            Return DAOPO.SavePurchaseListToTemp(Farm, DetailsList.ToString())

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In ServiceSavePurchaseListToTemp():PageManualPO")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddEditTempPODetails(ByVal TempPOHeaderID As String, ByVal Farm As String, ByVal Flower As String,
        ByVal Boxes As String, ByVal UOM As String, ByVal UnitsPerBunch As String, ByVal UnitsPerBox As String,
        ByVal CostPerUnits As String, ByVal Type As String, ByVal Comments As String, ByVal CustNumber As String,
         ByVal BoxCode As String, ByVal UPC As String, ByVal UPCDesc As String, ByVal UPCPrice As String, ByVal DateCode As String, ByVal BreakDown As String) As String
        Try

            Return DAOPO.AddEditTempPODetails(TempPOHeaderID, Farm, Flower, Boxes, UOM, UnitsPerBunch, UnitsPerBox,
            CostPerUnits, Type, Comments, CustNumber, BoxCode, UPC, UPCDesc, UPCPrice, DateCode, BreakDown)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveManualPODetails::PageManualPO")
            Return "error"
        End Try
    End Function


    '' Added by Anubhuti 04-06-2021
    <System.Web.Services.WebMethod(True)>
    Public Function UploadBouquetImage(ByVal fileBase64Str As String, ByVal fileBase64Str2 As String, ByVal fileBase64Str3 As String, ByVal fileBase64Str4 As String,
           ByVal fileName As String, ByVal fileName2 As String, ByVal fileName3 As String, ByVal fileName4 As String, ByVal Prodcode As String, ByVal POQID As Integer) As String
        Try
            Dim User As New User
            Dim MessageStr As String = ""

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            'Dim invoice As String = fileName.Split(".")(0)
            Dim folderPath As String = HttpContext.Current.Server.MapPath("~/ProductImages/Bouquet") ' get folder path
            Dim folderPath2 As String = HttpContext.Current.Server.MapPath("~/ProductImages/Food") ' get folder path
            Dim folderPath3 As String = HttpContext.Current.Server.MapPath("~/ProductImages/Pick") ' get folder path
            Dim folderPath4 As String = HttpContext.Current.Server.MapPath("~/ProductImages/Sleeve") ' get folder path
            If Not System.IO.Directory.Exists(folderPath) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath) ' create folder if not exist 
            End If
            If Not System.IO.Directory.Exists(folderPath2) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath2) ' create folder if not exist 
            End If
            If Not System.IO.Directory.Exists(folderPath3) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath3) ' create folder if not exist 
            End If
            If Not System.IO.Directory.Exists(folderPath4) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath4) ' create folder if not exist 
            End If
            Dim filePath As String = ""
            Dim filePath2 As String = ""
            Dim filePath3 As String = ""
            Dim filePath4 As String = ""

            If (fileBase64Str <> "") Then
                fileBase64Str = fileBase64Str.Split(",")(1)
                filePath = folderPath + "\" + Prodcode.ToString() + "_" + fileName
                File.WriteAllBytes(filePath, Convert.FromBase64String(fileBase64Str)) ' save file
            End If


            If (fileBase64Str2 <> "") Then
                fileBase64Str2 = fileBase64Str2.Split(",")(1)
                filePath2 = folderPath2 + "\" + Prodcode.ToString() + "_" + fileName2
                File.WriteAllBytes(filePath2, Convert.FromBase64String(fileBase64Str2)) ' save file
            End If

            If (fileBase64Str3 <> "") Then
                fileBase64Str3 = fileBase64Str3.Split(",")(1)
                filePath3 = folderPath3 + "\" + Prodcode.ToString() + "_" + fileName3
                File.WriteAllBytes(filePath3, Convert.FromBase64String(fileBase64Str3)) ' save file
            End If

            If (fileBase64Str4 <> "") Then
                fileBase64Str4 = fileBase64Str4.Split(",")(1)
                filePath4 = folderPath4 + "\" + Prodcode.ToString() + "_" + fileName4
                File.WriteAllBytes(filePath4, Convert.FromBase64String(fileBase64Str4)) ' save file
            End If


            If System.IO.File.Exists(filePath) Or System.IO.File.Exists(filePath2) Or System.IO.File.Exists(filePath3) Or System.IO.File.Exists(filePath4) Then 'check if file saved successfully and it exists 
                MessageStr = DAOPO.SaveBouquetImages(POQID, Prodcode, If(fileName = "", "", "ProductImages/Bouquet/" + Prodcode.ToString() + "_" + fileName), If(fileName2 = "", "", "ProductImages/Food/" + Prodcode.ToString() + "_" + fileName2), If(fileName4 = "", "", "ProductImages/Sleeve/" + Prodcode.ToString() + "_" + fileName4), If(fileName3 = "", "", "ProductImages/Pick/" + Prodcode.ToString() + "_" + fileName3), fileName, fileName2, fileName4, fileName3)
            Else
                MessageStr = "Error, file can't be saved!!"
            End If


            Return MessageStr
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UploadBouquetImage")
            Return "Error"
        End Try
    End Function

    '' Added by Anubhuti 04-06-2021
    <System.Web.Services.WebMethod(True)>
    Public Function UploadProductImage(ByVal fileBase64Str As String, ByVal fileName As String, ByVal Prodcode As String, ByVal POQID As Integer) As String
        Try
            Dim User As New User
            Dim MessageStr As String = ""

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim folderPath As String = HttpContext.Current.Server.MapPath("~/ProductImages/Products") ' get folder path
            If Not System.IO.Directory.Exists(folderPath) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath) ' create folder if not exist 
            End If
            Dim filePath As String = ""
            If (fileBase64Str <> "") Then
                fileBase64Str = fileBase64Str.Split(",")(1)
                filePath = folderPath + "\" + Prodcode.ToString() + "_" + fileName
                File.WriteAllBytes(filePath, Convert.FromBase64String(fileBase64Str)) ' save file
            End If


            If System.IO.File.Exists(filePath) Then 'check if file saved successfully and it exists 
                'MessageStr = DAOPO.SaveBouquetImages(POQID, Prodcode, If(fileName = "", "", "ProductImages/Products/" + Prodcode.ToString() + "_" + fileName))
            Else
                MessageStr = "Error, file can't be saved!!"
            End If


            Return MessageStr
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UploadBouquetImage")
            Return "Error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteBouquetImage(ByVal Prodcode As String, ByVal POQID As Integer, ByVal ImgType As String) As String
        Try
            Dim MessageStr As String = ""
            MessageStr = DAOPO.DeleteBouquetImages(POQID, Prodcode, ImgType)
            Return MessageStr
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteBouquetImage")
            Return "Error"
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetImageByProdCode(ByVal Prodcode As String) As BOPO
        Try
            Return DAOPO.GetImageByProdCode(Prodcode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetImageByProdCode::PagePO")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateFinalPOHeader() As String
        Try
            Dim MessageStr As String = ""
            MessageStr = DAOPO.UpdateFinalPOHeader()
            Return MessageStr
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateFinalPOHeader")
            Return "Error"
        End Try
    End Function
#End Region

#Region "SPORD"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetARINVSpordDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal Customer As String, ByVal Type As String, ByVal isF8BySummary As Boolean, ByVal SummaryDate As String, ByVal whereCondition As String) As XmlDocument
        Try
            'Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(SPORD), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim Filter As String = ""
            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            If isF8BySummary Then
                Dim shipdatewhereCondition = ""
                shipdatewhereCondition = "SHIPDATE = '" + SummaryDate + "'"
                whereCondition = If(whereCondition = "", shipdatewhereCondition, whereCondition + " AND " + shipdatewhereCondition)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SPORD

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of SPORDD) = obj.GetARINVSpordDetailsForCustomer(Customer, "", whereCondition, sortExp, 1, splitExportcsv(2), Type)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                '08April19 :: Abinaya :: SALES-Include order number column on F8 export
                Dim selectedColumns As String() =
                    {"Farm", "Flower", "FlowerName", "Type", "Status", "ShipDate", "CargoDate", "Boxes", "UOM", "Units", "Shipped", "Fob", "Cost", "Carrier", "PO", "BoxCode", "UPC", "DateCode", "Order", "WH", "Carrier2"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("FlowerName").ColumnName = "Description"
                dt.Columns("Boxes").ColumnName = "Qty"
                dt.Columns("Fob").ColumnName = "Price"
                dt.Columns("Carrier2").ColumnName = "Agency"
                dt.Columns("Carrier").ColumnName = "Truck"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "ARINVS$SPORD")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of SPORDD) = obj.GetARINVSpordDetailsForCustomer(Customer, "", whereCondition, sortExp, start, rp, Type)
                'As Per Instruction By Jose Commented by Prashant on 2019-01-13
                'Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                'Dim ShipmentStatus As Boolean = False
                'Dim FlowerColorVisibility As Boolean = False
                'For Each i In UserFeatures
                '    If i.Name.ToUpper = "SCANNING VALIDATION" And i.Value = True Then
                '        ShipmentStatus = True
                '    End If
                '    If i.Name.ToLower = "show flower color" Then
                '        FlowerColorVisibility = i.Value
                '    End If
                'Next
                If (obj.TotalRows = 0) Then
                    obj.TotalRows = 1
                End If
                Dim xmlDoc As XDocument = FrameXMLForSPORDFgrdAsXML(data, page, obj.TotalRows)

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Dim idx As Integer = data.Count - 1

                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVSpordDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPoqHistoryForF8(ByVal spordId As String) As XmlDocument

        Dim obj As New SPORD
        Dim data As List(Of SPORDD) = obj.GetPoqHistoryForF8(spordId)

        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                    New XElement("rows", New XElement("page", "1"),
                                    New XElement("total", data.Count().ToString()),
                                    data.Select(Function(row) New XElement("row", New XAttribute("id", Convert.ToString(row.SpordID).Trim()),
                                    New XElement("cell", row.Farm),
                                    New XElement("cell", row.PO),
                                    New XElement("cell", row.ProdNameQ),
                                    New XElement("cell", row.ShipDate),
                                    New XElement("cell", row.Boxes),
                                    New XElement("cell", row.UOM),
                                    New XElement("cell", row.QtyXBox),
                                    New XElement("cell", row.BoxNum),
                                    New XElement("cell", row.UnitCosq),
                                    New XElement("cell", row.UnitSalq),
                                    New XElement("cell", row.ProStatus),
                                    New XElement("cell", row.Market),
                                    New XElement("cell", row.CustShDate),
                                    New XElement("cell", row.Awb),
                                    New XElement("cell", row.Order)))))
        Dim newDoc As New XmlDocument()
        newDoc.LoadXml(xmlDoc.ToString())
        Return newDoc
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function ReloadParcularRowOnSPORDFgrd(ByVal Customer As String, ByVal SPORDID As String, ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String) As XmlDocument
        Dim obj As New SPORD

        Dim sortExp As String = sortname & " " & sortorder
        Dim start As Integer = ((page - 1) * rp) + 1
        rp -= 1

        Dim data As List(Of SPORDD) = obj.GetARINVSpordDetailsForCustomer(Customer, SPORDID, "", sortExp, start, rp, "")
        Dim xmlDoc As XDocument = FrameXMLForSPORDFgrdAsXML(data, "1", obj.TotalRows)
        Dim newDoc As New XmlDocument()
        newDoc.LoadXml(xmlDoc.ToString())

        Return newDoc
    End Function
    ''' <summary>
    ''' Muthu Nivetha M :: 11Feb2020 :: Modified :: Changed loading F8 by F_SPORD.SqlId instead F_SPORD.Id due to empty in ID
    ''' </summary>
    Private Function FrameXMLForSPORDFgrdAsXML(ByVal data As List(Of SPORDD), ByVal Page As String, ByVal TotalRows As Integer) As XDocument

        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
        Dim FlowerColorVisibility As Boolean = False
        For Each i In UserFeatures
            If i.Name.ToLower = "show flower color" Then
                FlowerColorVisibility = i.Value
            End If
        Next

        Dim daysOfService = ArmelliniService.GetDayOfService()

        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                    New XElement("rows", New XElement("page", Page.ToString()),
                                    New XElement("total", TotalRows.ToString()),
                                    data.Select(Function(row) New XElement("row", New XAttribute("id", Convert.ToString(row.SPORDSqlId).Trim()),
                                    New XElement("cell", String.Format("<img style='Cursor:pointer;margin-top:-3px;margin-left:-2px' id='F8select_" & Convert.ToString(row.SPORDSqlId).Trim().ToString() & "' src='" & IIf(row.F8Selected, "images/check-on.png", "images/check-off.png") & "' />")),
                                    New XElement("cell", "<b><a href='#' id='deleteARINVSpord_" & Convert.ToString(row.SPORDSqlId).Trim() & "' data-attr='" + row.Type + "'><img src='images/Delete-icon.png'/></a></b>"),
                                    New XElement("cell", "<b><a href='#' id='editARINVSpord_" & Convert.ToString(row.SPORDSqlId).Trim() & "'><img src='images/Edit.png'/></a></b>"),
                                    New XElement("cell", IIf((row.OrderTypes.Repeat = True) And (row.Status.ToString().ToLower() = "Co".ToLower()), IIf(row.Hold > 0 And row.HoldStatus = "Hold", "<a href='#' id=holdARINVSpord_" & Convert.ToString(row.SPORDSqlId).ToString() & "><img src='images/RedHold.png' style='width: 18px;height: 16px;margin-left: -3px;margin-top: -2px;'/></a>", "<a href='#' id=holdARINVSpord_" & Convert.ToString(row.SPORDSqlId).ToString() & "><img src='images/GreenHold.png' style='width: 18px;height: 16px;margin-left: -3px;margin-top: -2px;'/></a>"), "")),
                                    New XElement("cell", row.Farm),
                                    New XElement("cell", row.Flower),
                                    New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;cursor:pointer;background-color:" + row.Bgcolor.ToString() + "' class='flowerDescription' title='" + Convert.ToString(row.Flower).Replace("'", "") + "'><a style='color:" + row.Fontcolor.ToString() + ";'>" + row.FlowerName + "</a></div>", "<a >" + row.FlowerName + "</a>")),
                                    New XElement("cell", "<a id='typeARINVSpord_" & Convert.ToString(row.SPORDSqlId).Trim() & "' data-attr='" + row.Type + "'>" + row.Type + "</a>"),
                                    New XElement("cell", row.Status),
                                    New XElement("cell", row.ShipDate),
                                    New XElement("cell", "<span title=" + row.DaysDiff + ">" + row.CargoDate + "</span>"),
                                    New XElement("cell", row.Boxes),
                                    New XElement("cell", row.UOM),
                                    New XElement("cell", row.Units),
                                    New XElement("cell", row.Shipped),
                                    New XElement("cell", row.Fob),
                                    New XElement("cell", row.Cost),
                                    New XElement("cell", SpordCarrierColumnFormat(row.Carrier, row.Type, row.Consignee, row.ShipDate, daysOfService)),
                                    New XElement("cell", "<span style='cursor:pointer;' title=" + row.ShiptoName + " " + row.ShipToAddress1 + " " + row.ShipToCity + " " + row.ShipToPhone + ">" + row.Shipto + "</span>"),
                                    New XElement("cell", row.PO),
                                    New XElement("cell", row.BoxCode),
                                    New XElement("cell", row.UPC),
                                    New XElement("cell", row.DateCode),
                                    New XElement("cell", row.Order),
                                    New XElement("cell", row.WH),
                                    New XElement("cell", row.Agency),
                                    New XElement("cell", "<img style='cursor:pointer' title='" + GetSPORDUserDetails(Convert.ToString(row.SPORDSqlId), row.ADDUSER, row.ADDDATE, row.ADDTIME, row.ADDAPP, row.UPDUSER, row.UPDDATE, row.UPDTIME, row.UPDAPP, row.LOCKUSER, row.LOCKDATE, row.LOCKTIME, row.LOCKAPP) + "' id='imgaddeditDetails_" + Convert.ToString(row.SPORDSqlId).Trim().ToString() + "' src='images/Edit_user.png' />"),
                                    New XElement("cell", "<a href='#' id='F_SpordId_" & Convert.ToString(row.SPORDSqlId).Trim() & "'>" & row.SpordID.ToString() & "</a>"),
                                    New XElement("cell", "<a href='#' title='id: " & Convert.ToString(row.SpordID) & ", sqlId: " & Convert.ToString(row.SPORDSqlId) & "' id='spordId_" & Convert.ToString(IIf(row.SPORDSqlId = 0, row.SpordID, row.SPORDSqlId)).Trim() & "'>" & row.PODFlower.ToString() & "</a>")))))
        Return xmlDoc
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSPORDUserDetails(SpordID As String, ADDUSER As String, ADDDATE As String, ADDTIME As String, ADDAPP As String, UPDUSER As String, UPDDATE As String, UPDTIME As String, UPDAPP As String, LOCKUSER As String, LOCKDATE As String, LOCKTIME As String, LOCKAPP As String) As String
        Try
            ' Dim data = SPORD.GetSPORDUserDetails(SpordID)
            Dim HeadList As New List(Of String) From {"ID", "ADDED BY", "ADD DATE", "ADD TIME", "ADD APP", "UPDATED BY", "UPDATED DATE", "UPDATED TIME", "UPDATED APP", "LOCKED BY", "LOCK DATE", "LOCK TIME", "LOCK APP"}
            Dim KeyList As New List(Of String) From {SpordID, ADDUSER, ADDDATE, ADDTIME, ADDAPP, UPDUSER, UPDDATE, UPDTIME, UPDAPP, LOCKUSER, LOCKDATE, LOCKTIME, LOCKAPP}
            Dim str As String = "<table>"
            For j = 0 To KeyList.Count - 1
                'For Each i In data
                'Dim s As String GetPurchaseOrderHeaderGridForFgrd= DirectCast(i(KeyList(j)), String)

                If (HeadList(j) = "ADDED BY" Or HeadList(j) = "UPDATED BY" Or HeadList(j) = "LOCKED BY") And KeyList(j) = "" Then
                    j += 3
                Else
                    str += "<tr> <td style=color:white;padding-right:20px;padding-bottom:2px;>" + HeadList(j) + "</td> <td style=background:white;width:110px;>" + KeyList(j) + "</td> </tr>"
                End If

                'Next
            Next
            str += "</table>"

            Return str
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetSPORDUserDetails")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Muthu Nivetha M :: 11Feb2020 :: Modified :: Changed loading F8Hold by F_SPORD.SqlId instead F_SPORD.Id due to empty in ID
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function GetSPORDHoldDetails(ByVal SpordSqlID As String) As List(Of SPORDD)
        Try
            Dim data = SPORD.GetSPORDHoldDetails(SpordSqlID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetSPORDHoldDetails")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Muthu Nivetha M :: 11Feb2020 :: Modified :: Changed saving F8Hold by F_SPORD.SqlId instead F_SPORD.Id due to empty in ID
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveHoldDetails(ByVal BoxesHold As String, ByVal HoldFrom As String, ByVal HoldTo As String, ByVal CargoHoldf As String, ByVal CargoHoldt As String, ByVal SpordSqlID As String) As String
        Try
            Dim data = SPORD.SaveHoldDetails(BoxesHold, HoldFrom, HoldTo, CargoHoldf, CargoHoldt, SpordSqlID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetSPORDHoldDetails")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetUserFarmCode(ByVal UserID As Integer) As List(Of Farm)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If User.UserType.ToLower() = "vendor" Or User.UserType.ToLower() = "cargo agent" Then
                Return Farms.GetUserFarmCode(UserID)
            Else
                Return Farms.GetUserFarmCode(0)
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetUserFarmCodeByUserID::PageManualPO")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCarrierDetailsFromSPORD() As List(Of SPORDD)
        Try

            Dim data = SPORD.GetCarrierDetails()
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetCarrierDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetStatusForSPORD() As List(Of SPORDD)
        Try
            Dim data = SPORD.GetStatusDetails()
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetStatusForSPORD::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetShiptoForSPORD(ByVal Customer As String) As List(Of SPORDD)
        Try
            Dim data = SPORD.GetShiptoDetails(Customer)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetShiptoForSPORD::PageARINVS")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetNextIDForTables(ByVal TableName As String) As String
        Try
            Dim ID As Integer = 0
            ID = If(TableName.Trim() = "", 0, Convert.ToInt64(DAO.F_ID.GetNextIDForTABLES(TableName)))
            Return ID.ToString()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetNextIDForTables")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' Muthu Nivetha M :: 11Feb2020 :: Modified :: Changed saving F8 by F_SPORD.SqlId instead F_SPORD.Id due to empty in ID
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveSPORDDetails(ByVal CopyThisRecordToAnotherCustomer As Boolean, ByVal SpordSqlID As String, ByVal Customer As Integer, ByVal Farm As String, ByVal Flower As String, ByVal FlowerName As String, ByVal BreakDown As String, ByVal Qty As Integer, ByVal UOM As String, ByVal Units As Integer, ByVal Bunch As Integer, ByVal FOB As Decimal, ByVal Type As String, ByVal Status As String, ByVal Order As Integer, ByVal ShipDate As String, ByVal EndDate As String, ByVal GrowerDate As String, ByVal EndGrowerDate As String, ByVal CustPO As String, ByVal BoxCode As String, ByVal Cost As Decimal, ByVal PODFlower As String, ByVal Carrier As String, ByVal Shipto As Integer, ByVal CargoAgency As String, ByVal CommentsG As String, ByVal Comments As String, ByVal UPC As String, ByVal DateCode As String, ByVal UPCPrice As String, ByVal UPCDesc As String, ByVal Sleeve As String, ByVal SleeveDesc As String, ByVal Food As String, ByVal FoodDesc As String, ByVal Pick As String, ByVal PickDesc As String, ByVal Warehouse As String, ByVal bitNewShip As String, ByVal CreateDuplicateRecord As Boolean, ByVal SoldAs As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then

                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim data As String = ""
            If SpordSqlID = "0" Or CopyThisRecordToAnotherCustomer = True Or CreateDuplicateRecord Then
                data = SPORD.SaveSPORDDetails(Customer, Farm, Flower, FlowerName, BreakDown, Qty, UOM, Units, Bunch, FOB, Type, Status, Order, ShipDate, EndDate, GrowerDate, EndGrowerDate, CustPO, BoxCode, Cost, PODFlower, Carrier, Shipto, CargoAgency, CommentsG.TrimEnd(), Comments.TrimEnd(), UPC, DateCode.TrimEnd(), UPCPrice.TrimEnd(), UPCDesc.TrimEnd(), Sleeve, SleeveDesc.TrimEnd(), Food, FoodDesc.TrimEnd(), Pick, PickDesc.TrimEnd(), Warehouse, User.Name, SoldAs, False, If(User Is Nothing, "", User.SalesPerson), CreateDuplicateRecord)
            Else
                data = SPORD.UpdateSPORDDetails(SpordSqlID, Customer, Farm, Flower, FlowerName, BreakDown, Qty, UOM, Units, Bunch, FOB, Type, Status, Order, ShipDate, EndDate, GrowerDate, EndGrowerDate, CustPO, BoxCode, Cost, PODFlower, Carrier, Shipto, CargoAgency, CommentsG.TrimEnd(), Comments.TrimEnd(), UPC, DateCode.TrimEnd(), UPCPrice.TrimEnd(), UPCDesc.TrimEnd(), Sleeve, SleeveDesc.TrimEnd(), Food, FoodDesc.TrimEnd(), Pick, PickDesc.TrimEnd(), Warehouse, User.Name, If(bitNewShip = "1", True, False), SoldAs, False, If(User Is Nothing, "", User.SalesPerson), SpordSqlID)
            End If
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "SaveSPORDDetails")
            Return "error"
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSPORDEditDetails(ByVal SpordID As String) As List(Of SPORDD)
        Try
            Dim data = SPORD.GetSPORDEditDetails(SpordID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetSPORDEditDetails")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Muthu Nivetha M :: 11Feb2020 :: Modified :: Changed deleting F8 by F_SPORD.SqlId instead F_SPORD.Id due to empty in ID
    ''' </summary>
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteSPORDDetails(ByVal SpordSqlID As String) As String
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            'If LoginUserDetails.ORDER.Substring(73, 1) = "Y" Then
            Dim data = SPORD.DeleteSPORDDetails(SpordSqlID, LoginUserDetails.Name)
            Return data
            'Else
            '    Return "Do not have permission"
            'End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "DeleteSPORDDetails")
            Return Nothing
        End Try
    End Function


    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="page"></param>
    ''' <param name="rp"></param>
    ''' <param name="sortname"></param>
    ''' <param name="sortorder"></param>
    ''' <param name="query"></param>
    ''' <param name="qtype"></param>
    ''' <param name="ExportCSV"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetViewSPORDTransactionsGrid(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal Customer As String, ByVal ExportCSV As String, ByVal isGetSingleF8TransLog As Boolean, ByVal SpordSqlId As String, ByVal isFromF8screen As Boolean) As XmlDocument
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            'If Filter() <> "" Then
            '    Filter = If(isGetSingleF8TransLog And Convert.ToInt32(SpordSqlId) <> Convert.ToInt32(0), "CUSTOMER=" + Filter() + " AND SPORDTRANS.SQLID = " + SpordSqlId, "CUSTOMER=" + Filter())
            'End If

            If ExportCSV <> "" Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim data = Nothing
                data = SPORD.GetViewSPORDTransactionsGrid(Customer, SpordSqlId, isFromF8screen, If(LoginUserDetails Is Nothing, "0", LoginUserDetails.SalesPerson))

                If (data.count <= 0) Then
                    Return Nothing
                End If
                If data(0).ErrorMessage = "" Then
                    Dim dt1 As DataTable

                    dt1 = ConvertToDataTable(data)

                    Dim selectedColumns As String() =
                            {"CUSTOMER", "SHIPDATE", "ENDDATE", "SHIPBOGOTA", "ENDSHIPBOG", "FARM", "FLOWER", "ORDER", "BOXES", "UNITS", "UOM", "STATUS", "TYPE", "PRICES", "COST", "CARRIER", "PO", "BoxCode", "UPC", "DateCode", "WH", "Agency"}

                    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                    dt.Columns("SHIPBOGOTA").ColumnName = "FarmShip"
                    dt.Columns("ENDSHIPBOG").ColumnName = "FarmEndDate"
                    dt.Columns("CUSTOMER").ColumnName = "Cust#"
                    dt.Rows.RemoveAt(dt.Rows.Count - 1)
                    Dim dtCloned As DataTable = dt.Clone()
                    For Each row As DataRow In dt.Rows
                        dtCloned.ImportRow(row)
                    Next
                    Dim filepath = ExporttoExcel(dtCloned, splitExportcsv(1) + "Farm")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim data = Nothing
                data = SPORD.GetViewSPORDTransactionsGrid(Customer, SpordSqlId, isFromF8screen, If(LoginUserDetails Is Nothing, "0", LoginUserDetails.SalesPerson))
                Dim dt As DataTable = ConvertToDataTable(data)
                If dt.Rows.Count > 0 Then
                    If Convert.ToString(dt(0)("ErrorMessage")) = "" Then
                        Dim SelectedPOs As New ArrayList
                        Dim TotalRowCount As Integer = 0
                        If dt.Rows.Count > 0 Then
                            TotalRowCount = dt.Rows.Count().ToString()
                        End If
                        Dim FlowerColorVisibility As Boolean = False
                        Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                        For Each i In UserFeatures
                            If i.Name.ToLower = "show flower color" Then
                                FlowerColorVisibility = i.Value
                            End If
                        Next
                        '//Cust, Shipdate, EndDate, Shipbogota, EndShipBog , Farm, Flower, Order, Boxes, Units, UOM, Status, Type, Cost, Carrier
                        ' New XElement("cell", IIf(row.Item("Comments").ToString() = "", "", "<img href='#' title='" + row.Item("Comments").ToString() + "' id='F8TransComment_" & Convert.ToString(row.Item("ID")) & "' src='images/star.png' style='cursor:pointer'/>")),
                        '  New XElement("cell", IIf(row.Item("Commensint").ToString() = "", "", "<img href='#' title='" + row.Item("Commensint").ToString() + "' id='F8TransCommentInt_" & Convert.ToString(row.Item("ID")) & "'src='images/information.png' style='cursor:pointer'/>")),

                        Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                New XElement("rows", New XElement("page", page.ToString()),
                                                New XElement("total", TotalRowCount),
                                                From row In dt.Rows()
                                                Select
                                                New XElement("row", New XAttribute("id", row.Item("ID").ToString()),
                                                New XElement("cell", "<img style='cursor:pointer' title='" + GetPersonIconDetails(row.Item("AddUser"), Convert.ToDateTime(row.Item("AddDate")).ToString("MM/dd/yyyy"), row.Item("AddTime"), row.Item("ADDAPP"), "", "", "", "", "", "", "", "", "", "", "", "") + "' id='imgViewSPORDTransDetails_" + row.Item("ID").ToString() + "' src='images/Edit_user.png' />"),
                                                New XElement("cell", ""),
                                                New XElement("cell", row.Item("TransType")),
                                                New XElement("cell", row.Item("CUSTOMER")),
                                                New XElement("cell", row.Item("Shipdate")),
                                                New XElement("cell", row.Item("EndDate")),
                                                New XElement("cell", row.Item("Shipbogota")),
                                                New XElement("cell", row.Item("EndShipBog")),
                                                New XElement("cell", row.Item("Farm")),
                                                New XElement("cell", row.Item("Flower")),
                                                New XElement("cell", String.Format(IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row.Item("FlowerDetails").BGColor.ToString() + ";cursor:Pointer;color:" + row.Item("FlowerDetails").FontColor.ToString() +
                                                                                    "' class='flowerDescription' title='" + row.Item("ProductName").Replace("'", "") + "'>" & row.Item("ProductName") &
                                                                                    "</div>", "<div style='padding-bottom: 3px;cursor:pointer;' class='flowerDescription' title='" +
                                                                                    row.Item("ProductName").Replace("'", "") + "'>" & row.Item("ProductName") & "</div>"))),
                                                New XElement("cell", row.Item("Order")),
                                                New XElement("cell", row.Item("Boxes")),
                                                New XElement("cell", row.Item("Units")),
                                                New XElement("cell", row.Item("UOM")),
                                                New XElement("cell", row.Item("Status")),
                                                New XElement("cell", row.Item("Type")),
                                                New XElement("cell", Convert.ToDecimal(row.Item("PRICES")).ToString("#,##0.000")),
                                                New XElement("cell", Convert.ToDecimal(row.Item("Cost")).ToString("#,##0.000")),
                                                New XElement("cell", row.Item("Carrier")),
                                                New XElement("cell", row.Item("PO")),
                                                New XElement("cell", row.Item("BoxCode")),
                                                New XElement("cell", row.Item("UPC")),
                                                New XElement("cell", row.Item("DateCode")),
                                                New XElement("cell", row.Item("WH")),
                                                New XElement("cell", row.Item("Agency")))))

                        Dim newDoc As New XmlDocument()
                        newDoc.LoadXml(Convert.ToString(xmlDoc))
                        Return newDoc
                    Else
                        Dim User As New User
                        If Not Session("LoginUserDetails") Is Nothing Then
                            User = Session("LoginUserDetails")
                        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                            User = Session("LoginAdminDetails")
                        End If
                        Logs.SendErrorEmail(User, dt(0)("ErrorMessage"), "", "Error Notification", "error")
                        Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                    End If
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                     New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", dt.Rows().Count().ToString()),
                        From row In dt.Rows()
                        Select
                        New XElement("row", New XAttribute("id", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetViewSPORDTransactionsGrid::F8 Screen")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function FarmShipDate(ByVal ShippingDateToCustomer As String, ByVal FarmCode As String) As String
        Try
            Dim data = SPORD.FarmShipDateFromCustomerDate(ShippingDateToCustomer, FarmCode)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "FarmShipDate")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFarmBrand(ByVal Farm As String) As List(Of FarmBrandModel)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return FarmBrand.GetFarmBrand(Farm)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFarmBrand::PageManualPO")
            Return Nothing
        End Try
    End Function
    'Added by Anubhuti On 16/01/2023
    <System.Web.Services.WebMethod(True)>
    Public Function F8CreateInvoices(ByVal Customer As String, ByVal ShippingDate As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim result = SPORD.F8CreateInvoices(Customer, ShippingDate, User.ID)

            Return result

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: F8CreateInvoices()::F8CreateInvoices")
            Return "error"
        End Try

    End Function
#Region "SPORD PRICE"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetViewSPORDByPriceGrid(Customer As Integer) As XmlDocument
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If


            Dim data = Nothing

            data = SPORD.GetViewSPORDByPriceGrid(Customer)

            Dim dt As DataTable = ConvertToDataTable(data)
            If dt.Rows.Count > 0 Then

                If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                    Dim SelectedPOs As New ArrayList
                    Dim TotalRowCount As Integer = 0

                    If dt.Rows.Count > 0 Then
                        TotalRowCount = dt.Rows.Count().ToString()
                    End If

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                New XElement("rows", New XElement("page", ""),
                                                New XElement("total", TotalRowCount),
                                                From row In dt.Rows()
                                                Select
                                                New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                       New XElement("cell", "<img href='#'  id='F8PriceDelete_" & Convert.ToString(row("ID")) & "' src='images/Delete-icon.png' style='cursor:pointer'/>"),
                       New XElement("cell", "<img href='#'  id='F8PriceEdit_" & Convert.ToString(row("ID")) & "' src='images/Edit.png' style='cursor:pointer'/>"),
                                                New XElement("cell", "<a id='F8PriceCust_" + Convert.ToString(row("ID")) + "'>" + row.item("Customer").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceProdId_" + Convert.ToString(row("ID")) + "'>" + row.item("idproduct").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceProdCode_" + Convert.ToString(row("ID")) + "'>" + row.Item("FlowerDetails").Flower.ToString() + "</a>"),
                                                New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;background-color:" + row.Item("FlowerDetails").Bgcolor.ToString() + "' class='flowerDescription' title='" + Convert.ToString(row.Item("FlowerDetails").Flower).Replace("'", "") + "'><a id='F8PriceProdName_" + Convert.ToString(row("ID")) + "' style='color:" + row.Item("FlowerDetails").Fontcolor.ToString() + ";'>" + row.Item("FlowerDetails").Name.ToString() + "</div>"),
                                                New XElement("cell", "<a id='F8PriceQty_" + Convert.ToString(row("ID")) + "'>" + row.Item("Quantity").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceUOM_" + Convert.ToString(row("ID")) + "'>" + row.Item("Uom").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceUnits_" + Convert.ToString(row("ID")) + "'>" + row.Item("units").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceUBunch_" + Convert.ToString(row("ID")) + "'>" + row.Item("unitsperbunch").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PricePrice_" + Convert.ToString(row("ID")) + "'>" + row.Item("Price").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceSoldas_" + Convert.ToString(row("ID")) + "'>" + row.Item("soldas").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceUPC_" + Convert.ToString(row("ID")) + "'>" + row.Item("UPC").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceBoxCode_" + Convert.ToString(row("ID")) + "'>" + row.Item("BoxCode").ToString() + "</a>"),
                                                New XElement("cell", "<a id='F8PriceGTIN_" + Convert.ToString(row("ID")) + "'>" + row.Item("GTIN").ToString() + "</a>"))))

                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, dt(0)("ErrorMessage"), "", "Error Notification", "error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                     New XElement("rows", New XElement("page", ""),
                        New XElement("total", dt.Rows().Count().ToString()),
                        From row In dt.Rows()
                        Select
                        New XElement("row", New XAttribute("id", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""),
                        New XElement("cell", ""))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetViewSPORDByPriceGrid::F8 Screen")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveSPORDPRICEDetails(ByVal SpordPriceID As String, ByVal PCustomer As Integer, ByVal PFlower As Integer, ByVal PQTY As Integer, ByVal PUOM As String, ByVal PUnits As Integer, ByVal PBunch As Integer, ByVal PSoldas As String, ByVal PPrice As Decimal, ByVal PUPC As String, ByVal PBoxcode As String, ByVal PGTIN As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then

                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim data As String = ""
            If SpordPriceID = "0" Then
                data = SPORD.SaveSPORDPRICEDetails(PCustomer, PFlower, PQTY, PUOM, PUnits, PBunch, PSoldas, PPrice, PUPC, PBoxcode, PGTIN)

            Else
                data = SPORD.UpdateSPORDPRICEDetails(SpordPriceID.ToString(), PCustomer, PFlower, PQTY, PUOM, PUnits, PBunch, PSoldas, PPrice, PUPC, PBoxcode, PGTIN)
            End If
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "SaveSPORDPRICEDetails")
            Return "error"
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSPORDEditPriceDetails(ByVal SpordID As String) As List(Of SPORDPRICE)
        Try
            Dim data = SPORD.GetSPORDEditPriceDetails(SpordID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetSPORDEditPriceDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteSPORDPRICEDetails(ByVal SpordID As String) As String
        Try
            Dim data = SPORD.DeleteSPORDPRICEDetails(SpordID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "DeleteSPORDPRICEDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPriceListForCust(customer As Integer) As Integer
        Dim TotalRowCount As Integer = 0
        Try
            Dim data = Nothing
            data = SPORD.GetViewSPORDByPriceGrid(customer)
            Dim dt As DataTable = ConvertToDataTable(data)
            If dt.Rows.Count > 0 Then
                If Convert.ToString(dt(0)("ErrorMessage")) = "" Then
                    If dt.Rows.Count > 0 Then
                        TotalRowCount = dt.Rows.Count().ToString()
                    End If
                    Return TotalRowCount
                Else
                    Return TotalRowCount
                End If
            Else
                Return TotalRowCount
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetPriceListForCust")
            Return TotalRowCount
        End Try
    End Function


#End Region

#Region "SPORD DOUBLES - CHECK"
    <System.Web.Services.WebMethod(True)>
    Public Function CreateDoubleForF8(ByVal SPORDSqlIds As String, ByVal ShippingDate As String) As String
        Try
            Dim LoginUserDetails As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If
            Dim data = SPORD.CreateDoubleForF8(SPORDSqlIds, ShippingDate, If(LoginUserDetails.UserName Is Nothing, "", LoginUserDetails.UserName))
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "CreateDoubleForF8")
            Return "error"
        End Try
    End Function
#End Region
#Region "SPORD Confirmation"
    <System.Web.Services.WebMethod(True)>
    Public Function GenerateConfirmationReport(ByVal FromDate As String, ToDate As String, ByVal Customer As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "Customer"
            reportParameterCollection(1).Values.Add(Customer)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "Fromdate"
            reportParameterCollection(2).Values.Add(FromDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "Todate"
            reportParameterCollection(3).Values.Add(ToDate)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "SelectedReport"
            reportParameterCollection(4).Values.Add("F8NotificationByCustomer")

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""


            If FromDate <> "" And ToDate <> "" Then
                filename = "SPORD Notification From " + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(ToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            ElseIf Customer <> "" Then
                filename = "SPORD Notification For Customer " + Customer + ".pdf"
            Else
                filename = "SPORD Notification Report.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptSpordNotification", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If FromDate <> "" And ToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary From " + FromDate + " To " + ToDate + " by user:" + User.Email), "labelnotification")
                ElseIf Customer <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For Flower # " + Customer + " by user:" + User.Email), "labelnotification")
                Else
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For All  by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GenerateConfirmationReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
#End Region
#End Region

#Region "Create CustomerOrder"


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetInventoryForCustomerOrderFgrdNew(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ShipDate As String, Category As String, Variety As String, Grade As String, Color As String) As XmlDocument
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Session("InvenOrderList") = Nothing
            'Dim ExportList = obj.GetInventoryDetailsForCustomerOrder(ShipDate, Category, Variety, Grade, Color, User.CustomerNo)

            Dim data = Nothing
            data = Inventory.LoadInventoryDetailsForCustomerOrder(ShipDate, Category, Variety, Grade, Color, User.CustomerNo)

            Session("InvenOrderList") = data
            Dim SelectedDetails As New ArrayList()
            If Not Context.Session("SelectedInventory") Is Nothing Then
                SelectedDetails = Context.Session("SelectedInventory")
                For Each Item In data
                    Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(Item.ID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        Item.Selected = True
                    End If
                Next
            End If


            Dim dt As DataTable = ConvertToDataTable(data)
            If dt.Rows.Count > 0 Then
                Dim TotalRowCount As Integer = 0
                If dt.Rows.Count > 0 Then
                    TotalRowCount = dt.Rows.Count.ToString()
                End If

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                        New XElement("rows", New XElement("page", page.ToString()),
                                                        New XElement("total", TotalRowCount),
                                                        From row In dt.Rows()
                                                        Select
                                                        New XElement("row", New XAttribute("id", row.Item("RowNo").ToString()),
                                                        New XElement("cell", "<span id='invenids_" + row.Item("RowNo").ToString() + "'>" + row.Item("IDs").ToString() + "</span>"),
                                                        New XElement("cell", "INVEN"),
                                                        New XElement("cell", "<span id='txtCity_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfCity_" + row.Item("RowNo").ToString() + "' value='" + row.Item("Country").ToString() + "-" + row.Item("City").ToString() + "'> " + row.Item("Country").ToString() + "-" + row.Item("City").ToString() + "</span>"),
                                                        New XElement("cell", "<span id='txtCat_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' >" + row.Item("ProductCategory").ToString() + "</span>"),
                                                        New XElement("cell", "<div id='divProduct_" + row.Item("RowNo").ToString() + "' style='height:15px;padding-top:5px;margin:-6px;font-weight:bold;background-color:" + row.Item("BGColor").ToString() + ";color:" + row.Item("ForeColor").ToString() + "'> <input type='hidden' id='hfProduct_" + row.Item("RowNo").ToString() + "' value='" + row.Item("ProductName").ToString() + "'> " + row.Item("ProductName").ToString() + "</div>"),
                                                        New XElement("cell", "<span id='txtProductCode_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfProductCode_" + row.Item("RowNo").ToString() + "' value='" + row.Item("ProductCode").ToString() + "'> " + row.Item("ProductCode").ToString() + "</span>"),
                                                        New XElement("cell", "<span id='txtQty_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' title ='Received = " + row.Item("CSREC").ToString() + " Sold = " + row.Item("CSSOLD").ToString() + " Held=" + row.Item("CSHOLD").ToString() + "' >  " + row.Item("Qty").ToString() + "</span> <input type='hidden' id='hfQty_" + row.Item("RowNo").ToString() + "' value='" + row.Item("Qty").ToString() + "'>"),
                                                        New XElement("cell", "<span id='txtBoxCode_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfBoxCode_" + row.Item("RowNo").ToString() + "' value='" + row.Item("BoxNumber").ToString() + "'> " + row.Item("BoxNumber").ToString() + "</span>"),
                                                        New XElement("cell", "<span id='txtUOM_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfUOM_" + row.Item("RowNo").ToString() + "' value='" + row.Item("UOM").ToString() + "'> " + row.Item("UOM").ToString() + "</span>"),
                                                        New XElement("cell", "<span id='txtSize_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfSize_" + row.Item("RowNo").ToString() + "' value='" + row.Item("Height").ToString() + "'> " + row.Item("Length").ToString() + "x" + row.Item("Width").ToString() + "x" + row.Item("Height").ToString() + "</span>"),
                                                        New XElement("cell", "<span id='txtUnits_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfUnits_" + row.Item("RowNo").ToString() + "' value='" + row.Item("Units").ToString() + "'> " + row.Item("Units").ToString() + "</span>"),
                                                        New XElement("cell", row.Item("Soldas").ToString()),
                                                        New XElement("cell", "<span id='txtUnitsBunch_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfUnitsBunch_" + row.Item("RowNo").ToString() + "' value='" + row.Item("UnitsBunch").ToString() + "'> " + row.Item("UnitsBunch").ToString() + "</span>"),
                                                        New XElement("cell", "<span id='txtPrice_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfPrice_" + row.Item("RowNo").ToString() + "' value='" + Convert.ToDecimal(row.Item("Price")).ToString("N3") + "'> " + Convert.ToDecimal(row.Item("Price")).ToString("N3") + "</span>"),
                                                        New XElement("cell", "<span id='txtFOB_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfFOB_" + row.Item("RowNo").ToString() + "' value='" + Convert.ToDecimal(row.Item("FOB")).ToString("N3") + "'> " + Convert.ToDecimal(row.Item("FOB")).ToString("N3") + "</span>"),
                                                        New XElement("cell", "<span id='txtFOBBOX_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfFOBBOX_" + row.Item("RowNo").ToString() + "' value='" + Convert.ToDecimal(row.Item("FOBBOX")).ToString("N2") + "'> " + Convert.ToDecimal(row.Item("FOBBOX")).ToString("N2") + "</span>"),
                                                        New XElement("cell", "<span id='txtNextIn_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' >" + row.Item("Days") + " </span>"),
                                                        New XElement("cell", "<a id='lnkAdd_" + row.Item("RowNo").ToString() + "'><img style='width:15px;height:15px' src='images/plus.png' /></a>"),
                                                        New XElement("cell", "<input type='text' style='width:30px;height:15px;margin-top:-5px;' class='NumbersOnly' placeholder='0' value='0' id='editQty_" & row.Item("RowNo").ToString() + "'></input>"),
                                                        New XElement("cell", "<a id='lnkSub_" + row.Item("RowNo").ToString() + "'><img style='width:15px;height:15px' src='images/minus.png' /></a>"),
                                                        New XElement("cell", "<input type='button' style='width:50px;height:18px;margin-top:-5px;text-align:top;' value='Update' id='btnUpdate_" & row.Item("RowNo").ToString() + "'></input>"),
                                                        New XElement("cell", InventoryForAddingOrderWithAnchorTag(row.Item("Picture"), row.Item("RowNo"), row.Item("RowNo"), row.Item("ProductName").ToString().IndexOf("5*") > 0)),
                                                        New XElement("cell", "<span id='txtWH_" + row.Item("RowNo").ToString() + "' style='height:25px;width:25px' > <input type='hidden' id='hfWH_" + row.Item("RowNo").ToString() + "' value='" + row.Item("WH").ToString() + "'> " + row.Item("WH").ToString() + "</span>")
)))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            Else
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml("<rows><total>0</total></rows>")
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInventoryForCustomerOrderFgrd::PageCustomerOrder")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerTruckDays(CustomerNo As String) As String
        Try
            Dim ID As String = "0"
            ID = CustomerDetails.GetCustomerTruckDays(CustomerNo)
            Return ID
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomerTruckDays::PageARINVS")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function CreateCustomerOrder(ByVal Header As Object, ByVal Detail As Object) As String

        Try
            Dim User As New User
            'checkusersessionIsActive:start
            If Session("LoginUserDetails") Is Nothing Then
                Return "LogOut"
            Else
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            End If

            Dim OrderNo As String = ""
            Dim WH As String = ""
            Dim Carrier = Header("CarrierID")
            Dim Customer = Header("Customer")
            Dim PONO = Header("PONo")
            Dim ShipDate = Header("ShipDate")
            Dim ShipTo = Header("ShipTo")
            Dim TotalAmout = Header("TotalAmt")

            For Each det In Detail
                If Customer = Nothing Then
                    Continue For
                End If
                If det("ProductCode") = Nothing Then
                    Continue For
                End If
                WH = det("WH")
                WH = WH.Replace("'", "")
                SalesOrder.ADDUPDATEOrderDetail("", "0", Customer, det("IDINVEN"), det("InCart"), det("Price"), "I", User.Name, det("Units"), "0", User.ID, "")
            Next

            Dim CustomerData As DataRow = SalesOrder.GetCustomerRecordByID(Customer)
            Dim CustomerEmail = CustomerData("EMAIL") 'getting CustomerEmail  from DBF
            Dim SLSMAN = CustomerData("SALESMAN") 'getting SLSMAN  from DBF
            Dim Terms = CustomerData("TERMS") 'customer Terms 
            Dim NextInvoiceNoFromConstant As Integer = 0
            NextInvoiceNoFromConstant = DAO.Constant.GetNextInvoiceNumFromConstant()
            OrderNo = NextInvoiceNoFromConstant.ToString()
            SalesOrder.CreateCustomerOrder("1", NextInvoiceNoFromConstant, Customer, ShipDate, "", Carrier, "", "", WH, PONO, SLSMAN, "", "", "", "", "", "", "", "", "", "", ShipTo, Terms, "", User.Name, User.ID, TotalAmout, CustomerEmail)
            Return "Success~" + OrderNo
        Catch ex As Exception
            Return "Error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesOrderCustDetails(ByVal Customer As String) As CustomerDetail
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            Dim data As CustomerDetail = CustomerDetails.GetSalesOrderCustDetails(Customer, User.Name)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesOrderCustDetails::PageOrderDetails")
            Return Nothing
        End Try
    End Function


    '<System.Web.Services.WebMethod(True)>
    'Public Function GetColors() As List(Of String)
    '    Try
    '        Dim data = obj.GetColors()
    '        Return data.ToList()
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetColor::PageCustomerOrder")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetVarieties(ByVal Category As String) As List(Of String)
    '    Try
    '        Dim data = obj.GetVarieties(Category)
    '        'Return data.ToList()
    '        If data IsNot Nothing Then
    '            Return data.ToList()
    '        End If
    '        Return Nothing
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetVariety::PageCustomerOrder")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetGrades() As List(Of String)
    '    Try
    '        Dim data = obj.GetGrades()
    '        Return data.ToList()
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetGrades::PageCustomerOrder")
    '        Return Nothing
    '    End Try
    'End Function

    '<System.Web.Services.WebMethod(True)>
    'Public Function GetCategories() As List(Of String)
    '    Try
    '        Dim data = obj.GetCategories()
    '        Return data.ToList()
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::GetCategories::PageCustomerOrder")
    '        Return Nothing
    '    End Try
    'End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetSaleManbyOrderNo(ByVal Oderno As String, ByVal isFromVET As Boolean) As String
        Try
            Dim data = VET.GetSaleManbyOrderNo(Oderno, isFromVET)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSaleManbyOrderNo::PageCustomerOrder")
            Return Nothing
        End Try
    End Function
#End Region

#Region "CALL LIST"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCallListGridDetails(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal OnlyMe As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CALLSS), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim Filter As String
            Filter = "where UserID=" + User.ID.ToString()

            If User.Division > 0 Then
                Filter += " AND CUSTOMER IN (SELECT CUSTOMER FROM F_CUST WHERE DIVISION=" + User.Division + ")"
            End If

            If OnlyMe = "true" Then
                Filter += " AND SALESMAN=" + User.SalesPerson
            End If

            Dim obj As New CALLS
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of CALLSS) = obj.GetCallListDetailsFromSQL(Filter.ToString())

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Customer", "Name", "City", "Phone", "CallTime", "Carrier", "Comments"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Name").ColumnName = "Customer Name"
                dt.Columns("City").ColumnName = "Purchaser"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "CallList$CALL")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of CALLSS) = obj.GetCallListDetailsFromSQL(Filter.ToString())

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", data.Count),
                                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.CALL_ID),
                                            New XElement("cell", row.Customer),
                                            New XElement("cell", row.Name),
                                            New XElement("cell", row.City),
                                            New XElement("cell", row.Phone),
                                            New XElement("cell", row.CallTime),
                                            New XElement("cell", IIf(row.Carrier.Trim() = "", "<span title='" + row.DeliveryDaysTooltip + "' style='background:transparent;color:transparent;'>" + row.Customer.ToString() + "</span>", row.Carrier)),
                                            New XElement("cell", "<a id='CallListType_" & row.CALL_ID & "'>" + IIf(row.Type = "Y", "&#10004;", row.Type) + "</a>"),
                                            New XElement("cell", row.Comments),
                                            New XElement("cell", IIf(row.CreditHold = "Y", "<img style='cursor:pointer;width: 26px;height: 25px;margin-top: -6px;margin-bottom: -3px;margin-left:-4px;' src='images/ARInqHold.png' title='" + row.ReasonHold + "'/>", ""))))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Dim idx As Integer = data.Count - 1

                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCallListGridDetails")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function SaveCallList(ByVal DayID As Integer, ByVal CallListDate As Date) As String
        Try
            Dim CLResult As String = ""
            'Dim Salesman = Users.GetSalesPersonByID(UserID)
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            CLResult = CALLS.SaveCallList(User.SalesPerson, User.ID, DayID, CallListDate, User.Name)

            Return CLResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCallList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCallListCountForUser(ByVal UserID As String) As Integer
        Try
            Dim obj As New CALLS()
            Dim CallListCount = obj.GetCallListCountForUser(UserID)
            Return CallListCount
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCallListCountForUser")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function SaveCallListLog(ByVal CALL_ID As Integer, ByVal Customer As Integer, ByVal Comments As String, ByVal Button As String) As String
        Try
            Dim CallLogResult As String = ""
            Dim CallListType As String = ""
            Dim ReturnValue As String = ""
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            CallLogResult = CALLS.SaveCallListLog(CALL_ID, Customer, HttpUtility.UrlDecode(Comments, System.Text.Encoding.Default), User.ID, User.Name, Button)

            Return CallLogResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCallLogToHS")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function SaveCallLaterToday(ByVal CALL_ID As Integer, ByVal Customer As String, ByVal CallTime As String, ByVal Comments As String) As String
        Try
            Dim CallLaterResult As String = ""
            Dim CallListObj As New CALLS()
            CallLaterResult = CALLS.SaveCallLaterToday(CALL_ID, Customer, CallTime, HttpUtility.UrlDecode(Comments, System.Text.Encoding.Default))
            Return CallLaterResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCallLaterToday")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function SaveCallAnotherDay(ByVal CALL_ID As Integer, ByVal Customer As String, ByVal DayAdd As Integer, ByVal Comments As String) As String
        Try
            Dim CallAnotherResult As String = ""
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            CallAnotherResult = CALLS.SaveCallAnotherDay(CALL_ID, Customer, DayAdd, HttpUtility.UrlDecode(Comments, System.Text.Encoding.Default), User.ID)
            Return CallAnotherResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCallAnotherDay")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function RemoveCallList() As String
        Try
            Dim RemoveListResult As String = ""
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            RemoveListResult = CALLS.RemoveCallList(User.ID)
            Return RemoveListResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::RemoveCallList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCallListTypeAfterSaleMade(ByVal Customer As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            CALLS.UpdateCallListTypeAfterSaleMade(Customer, User.ID)
            Return "Success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCallListTypeAfterSaleMade")
            Return Nothing
        End Try
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function GetCallListCustomerForCallID(ByVal CALL_ID As Integer) As Integer
        Try
            Dim obj As New CALLS()
            Dim CallListCustNo = obj.GetCallListCustomerForCallID(CALL_ID)
            Return CallListCustNo
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCallListCustomerForCallID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCallListCreatedDay(ByVal UserID As String) As String
        Try
            Dim obj As New CALLS()
            Dim CallListCount = obj.GetCallListCreatedDay(UserID)
            Return CallListCount
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCallListCreatedDay")
            Return Nothing
        End Try
    End Function
#End Region

#Region "PO Report"
    <System.Web.Services.WebMethod(True)>
    Public Function PrintPOReports(ByVal PONumList As String) As String
        Try
            Dim ARDepositReportResult As String = ""
            ARDepositReportResult = PrintPurchaseOrderReport(PONumList)
            Return ARDepositReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPOReports")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintPurchaseOrderReport(ByVal PONumList As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "PONUMBERs"
            reportParameterCollection(1).Values.Add(PONumList)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            filename = "Purchase Order Report" + DateTime.Now.ToString("yyyyMMdd", CultureInfo.InvariantCulture) + ".pdf"

            'filename = CompanyName + " Purchase Order # " + PONumList + ".pdf"
            '" created on " + DateTime.Now.ToString("yyMMdd:hh:mm:ss", CultureInfo.InvariantCulture) + ".pdf"
            'filename = CompanyName + "_Purchase_Order_Report" + PONumList + "___Print_Time_" + DateTime.Now.ToString("hh_mm_ss") + ".pdf"
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim ReportName As String = ""
            ReportName = objPdf.ExportToPdf(filename, "rptPurchaseOrderReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")


            Dim BodyMessage As String = ""

            'If ReportName <> "" Then
            '    If FromDate <> "" And ToDate <> "" Then
            '        Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary From " + FromDate + " To " + ToDate + " by user:" + User.Email), "labelnotification")
            '    ElseIf Flower <> "" Then
            '        Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For Flower # " + Flower + " by user:" + User.Email), "labelnotification")
            '    Else
            '        Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For All  by user:" + User.Email), "labelnotification")
            '    End If
            'End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPurchaseOrderReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintMultiplePurchaseOrders(ByVal PONumList As String) As String
        Try
            Dim POPrintMultiplePurchaseOrders As String = ""
            POPrintMultiplePurchaseOrders = PrintMultiplePurchaseOrdersPDF(PONumList)
            Return POPrintMultiplePurchaseOrders
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPOReports")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintMultiplePurchaseOrdersPDF(ByVal PONumList As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "PONUMBERs"
            reportParameterCollection(1).Values.Add(PONumList)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            filename = "Purchase_Order_" + PONumList + "___Print_Time_" + DateTime.Now.ToString("yyyyMMdd", CultureInfo.InvariantCulture) + "_" + DateTime.Now.ToString("HHmmss", CultureInfo.InvariantCulture) + ".pdf"
            ' "___Print_Time_" + DateTime.Now.ToString("yyyyMMddHHmmss", CultureInfo.InvariantCulture) + 

            Dim dIndex = PONumList.IndexOf(",")

            'filename = CompanyName + " Purchase Order # " + PONumList + ".pdf"
            '" created on " + DateTime.Now.ToString("yyMMdd:hh:mm:ss", CultureInfo.InvariantCulture) + ".pdf"
            'filename = CompanyName + "_Purchase_Order_Report" + PONumList + "___Print_Time_" + DateTime.Now.ToString("hh_mm_ss") + ".pdf"


            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = "rptPurchaseOrderReport"


            ReportName = objPdf.ExportToPdf(filename, ReportName, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")


            'If dIndex > 0 Then
            '    ReportName = objPdf.ExportToPdf(filename, "rptPurchaseOrderReportwithoutsubreport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'Else
            '    ReportName = objPdf.ExportToPdf(filename, "rptPurchaseOrderReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            'End If



            'If ReportName <> "" Then
            '    If FromDate <> "" And ToDate <> "" Then
            '        Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary From " + FromDate + " To " + ToDate + " by user:" + User.Email), "labelnotification")
            '    ElseIf Flower <> "" Then
            '        Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For Flower # " + Flower + " by user:" + User.Email), "labelnotification")
            '    Else
            '        Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For All  by user:" + User.Email), "labelnotification")
            '    End If
            'End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPurchaseOrderReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ValidatePOEmailExist(ByVal Polist As String) As String
        Try
            Dim Message As String
            Message = DAOPO.ValidatePOEmailExist(Polist)
            Return Message
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ValidatePOEmailExist::Polist")
            Return "error~" + ex.Message.ToString()
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ValidateFarmEmail(ByVal Farm As String) As String
        Try
            Dim Message As String
            Message = DAOPO.ValidateFarmEmail(Farm)
            Return Message
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ValidateFarmEmail::Polist")
            Return "error~" + ex.Message.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateEmailLog(ByVal MESSAGE_ID As String, ByVal EMAILTYPE As String, ByVal EMAILEDDOCUMENTNUMBER As String) As String
        Try
            Dim Message As String
            Message = Logs.UpdateEmailLog(MESSAGE_ID, EMAILTYPE, EMAILEDDOCUMENTNUMBER)
            Return Message
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateEmailLog")
            Return "error~" + ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DenyStandingOrder(ByVal SpordSqlId As String, ByVal Comment As String, ByVal SalesType As String) As String
        Try
            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim Message As String
            Dim ToEmail As String

            Dim deniedEmail As DeniedEmail = DAOPO.GetemailforDeniedOrder(SpordSqlId, SalesType)
            Dim MessageBody As String = ""
            MessageBody = deniedEmail.Message + " Reason " + Comment
            ToEmail = deniedEmail.ToEmail
            Dim unused = Logs.SendMail(User.Email, ToEmail + "," + User.Email, "", "", MessageBody)

            Message = DAOPO.DenyStandingOrder(SpordSqlId, Comment, User.ID, User.UserName, SalesType)
            Return Message
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DenyStandingOrder::CreatePO")
            Return "error" + ex.Message.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Async Function SendPurchaseOrderEmail(ByVal Polist As String, ByVal EmailList As String, ByVal Body As String, ByVal Subject As String) As Task(Of String)
        Try
            Dim Message As String = ""
            Dim i As Integer
            Dim stringSeparators() As String = {","}
            Dim PONUM() As String
            PONUM = Polist.Split(stringSeparators, StringSplitOptions.RemoveEmptyEntries)
            For i = 0 To PONUM.Length - 1
                Message = Await GeneratePurchaseOrderEmail(PONUM(i), EmailList, Body, Subject)
                PurchaseOrders.Updatepoheaderstatus(PONUM(i), "EMAILED", 0)
                'If Message.Trim().Contains("Error") And Message.Trim().Contains("Nothing") Then
                '    Return Message
                'End If
            Next
            Return Message
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SendPurchaseOrderEmail::Polist")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Async Function GeneratePurchaseOrderEmail(ByVal PONUM As String, ByVal EmailList As String, ByVal Body As String, ByVal Subject As String) As Task(Of String) '04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark 
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim emailReturnMessage As String = "error"
            Dim FarmEmail As String = ""
            If EmailList <> "" Then
                FarmEmail = EmailList
            Else
                FarmEmail = DAOPO.GetFarmEmailList(PONUM)
            End If
            If (FarmEmail <> "error" And FarmEmail <> "") Then


                Dim SessionStatus As String = ""
                If Not Session("LoginUserDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("User")
                ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                    SessionStatus = CheckLoginSessionIsActive("Admin")
                End If
                If SessionStatus = "InActive" Then
                    Return "LogOut"
                End If

                Dim objPdf As New ExportSSRS
                Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

                Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}

                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "PONUMBERs"
                reportParameterCollection(0).Values.Add(PONUM)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "ConnectionString"
                reportParameterCollection(1).Values.Add(ConString)

                Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
                Dim filename As String = ""
                filename = "Purchase_Order#_" + PONUM.Replace("*", "-") + "___Print_Time_" + DateTime.Now.ToString("hh_mm_ss") + ".pdf"

                Dim POHData As BOPO
                POHData = DAOPO.GetPOHeaderDataByPONumber(PONUM)

                Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()


                Dim BodyMessage As String = ""
                'Dim ReportName As String = ""
                Dim ReportName As String = objPdf.ExportToPdf(filename, "rptPurchaseOrderReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
                If Subject = "" Then
                    Subject = "Purchase_Order for " + POHData.FarmName + " for shipment on " + POHData.ShipDate + " " + Convert.ToDateTime(POHData.ShipDate).ToString("dddd") + " #" + POHData.PONumber '+ " ip: " + LocalIPAddress.ToString()
                End If

                If Not ReportName.Trim().Contains("error : ") Then
                    emailReturnMessage = Await Logs.SendMail(User.Email, FarmEmail, Body, ReportName, Subject, "PO", PONUM, "")
                    DAOPO.GetPOHeaderDataByPONumber(PONUM)

                End If
                Return emailReturnMessage
            Else
                Return emailReturnMessage
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GeneratePurchaseOrderEmail")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

#End Region

#Region "SalesReport"

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesReports(ByVal FromDate As String, ToDate As String, ByVal Flower As String, ByVal Category As String, Grade As String, ByVal Variety As String, ByVal Color As String, ByVal Farm As String) As String
        Try
            Dim ARDepositReportResult As String = ""
            ARDepositReportResult = PrintSalesSummaryReport(FromDate, ToDate, Flower, Category, Grade, Variety, Color, Farm)
            Return ARDepositReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDepositReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryReport(ByVal FromDate As String, ToDate As String, ByVal Flower As String, ByVal Category As String, Grade As String, ByVal Variety As String, ByVal Color As String, ByVal Farm As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(8) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(FromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(ToDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "Farm"
            reportParameterCollection(3).Values.Add(Farm)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "Category"
            reportParameterCollection(4).Values.Add(Category)

            reportParameterCollection(5) = New ReportParameter()
            reportParameterCollection(5).Name = "Grade"
            reportParameterCollection(5).Values.Add(Grade)

            reportParameterCollection(6) = New ReportParameter()
            reportParameterCollection(6).Name = "Variety"
            reportParameterCollection(6).Values.Add(Variety)

            reportParameterCollection(7) = New ReportParameter()
            reportParameterCollection(7).Name = "Color"
            reportParameterCollection(7).Values.Add(Color)

            reportParameterCollection(8) = New ReportParameter()
            reportParameterCollection(8).Name = "Flower"
            reportParameterCollection(8).Values.Add(Flower)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""


            If FromDate <> "" And ToDate <> "" Then
                filename = "Sales Summary From " + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(ToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            ElseIf Flower <> "" Then
                filename = "Sales Summary For Flower " + Flower + ".pdf"
            Else
                filename = "Sales Summary Report.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptSalesSummary_new", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If FromDate <> "" And ToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary From " + FromDate + " To " + ToDate + " by user:" + User.Email), "labelnotification")
                ElseIf Flower <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For Flower # " + Flower + " by user:" + User.Email), "labelnotification")
                Else
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For All  by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryReportNoIdea")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintDailyPTDSalesbySalesperson(ByVal FromDate As String, ToDate As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(FromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""


            If FromDate <> "" And ToDate <> "" Then
                filename = "Daily_PTD_SalesPerson_Sales_Summary_From_" + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(ToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "Daily_PTD_SalesPerson_Sales_Summary_Report.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptDailyPeriodtoDateSalesbySalesperson", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If FromDate <> "" And ToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary From " + FromDate + " To " + ToDate + " by user:" + User.Email), "labelnotification")
                Else
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For All  by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDailyPTDSalesPersonSalesSummaryReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
#End Region

#Region "AR Reports"
    <System.Web.Services.WebMethod(True)>
    Public Function PrintARDepositReports(ByVal FromDate As String, ByVal ToDate As String, ByVal CheckNo As String, ByVal BankNo As String, CustomerNo As String, ByVal DepositType As String, ByVal DepositNumber As String) As String
        Try
            Dim ARDepositReportResult As String = ""

            Dim RowCount = 1
            'Dim RowCount = CASH.GetCountForDepositsReport(DepositFrom, DepositTo, CheckNo, BankNo, CustomerNo, FromDate, ToDate, DepositType)


            If RowCount > 0 Then
                If DepositType.Split("~")(0) = "All Deposits" Then
                    ARDepositReportResult = PrintDepositReport(FromDate, ToDate, CheckNo, BankNo, CustomerNo, DepositType, 0)
                ElseIf DepositType.Split("~")(0) = "A Deposit" Then
                    ARDepositReportResult = PrintDepositReport(FromDate, ToDate, CheckNo, BankNo, CustomerNo, DepositType, DepositNumber)
                ElseIf DepositType.Split("~")(0) = "Deposit Summary" Then
                    ARDepositReportResult = PrintDepositSummaryReport(FromDate, ToDate, CustomerNo)
                End If
            ElseIf RowCount = 0 Then
                ARDepositReportResult = "No Data"
            End If

            Return ARDepositReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDepositReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintDepositReport(ByVal FromDate As String, ByVal ToDate As String, ByVal CheckNo As String, ByVal BankNo As String, CustomerNo As String, ByVal DepositType As String, ByVal DepositNumber As Integer) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            If DepositType.Split("~").Length = 2 Then
                DepositType = DepositType.Split("~")(1)
            Else
                'DepositType = ""           --Other deposit type don't pass with empty values
                DepositType = DepositType
            End If

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(7) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(FromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(ToDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "CheckNo"
            reportParameterCollection(3).Values.Add(CheckNo)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "BankNo"
            reportParameterCollection(4).Values.Add(BankNo)

            reportParameterCollection(5) = New ReportParameter()
            reportParameterCollection(5).Name = "CustomerNo"
            reportParameterCollection(5).Values.Add(CustomerNo)

            reportParameterCollection(6) = New ReportParameter()
            reportParameterCollection(6).Name = "DepositType"
            reportParameterCollection(6).Values.Add(DepositType)

            reportParameterCollection(7) = New ReportParameter()
            reportParameterCollection(7).Name = "DepositNumber"
            reportParameterCollection(7).Values.Add(DepositNumber)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            filename = "Deposit Listing From " + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(ToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"


            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptDeposit", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If FromDate <> "" And ToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary From " + FromDate + " To " + ToDate + " by user:" + User.Email), "labelnotification")
                ElseIf CustomerNo <> "0" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For Customer# " + CustomerNo + " by user:" + User.Email), "labelnotification")
                Else
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Summary For All  " + CustomerNo + " by user:" + User.Email), "labelnotification")

                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDepositReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintDepositSummaryReport(ByVal FromDate As String, ByVal ToDate As String, ByVal CustomerNo As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(FromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""


            'filename = CompanyName + "DepositSummaryFrom " + FromDate.ToString() + "To" + ToDate.ToString() + ".pdf"
            filename = "DepositSummaryList" + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(ToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptBankwiseSummary", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Deposit Summary From:" + FromDate + " To " + ToDate + " by user:" + User.Email), "labelnotification")
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDepositSummaryReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintARReturnedChecksReport(ByVal ReturnedChecksFromDate As String, ReturnedChecksToDate As String, ByVal ReturnedChecksCustomerNo As String, ByVal ReturnedChecksType As String) As String
        Try
            Dim ARReturnedChecksReportResult As String = ""
            Dim RowCount = NSF.GetCountForReturnedChecks(ReturnedChecksFromDate, ReturnedChecksToDate, ReturnedChecksCustomerNo, ReturnedChecksType)

            If RowCount > 0 Then
                ARReturnedChecksReportResult = PrintReturnedChecksReport(ReturnedChecksFromDate, ReturnedChecksToDate, ReturnedChecksCustomerNo, ReturnedChecksType)
            ElseIf RowCount = 0 Then
                ARReturnedChecksReportResult = "No Data"
            End If

            Return ARReturnedChecksReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARReturnedChecksReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintReturnedChecksReport(ByVal ReturnedChecksFromDate As String, ReturnedChecksToDate As String, ByVal ReturnedChecksCustomerNo As String, ByVal ReturnedChecksType As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(ReturnedChecksFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(ReturnedChecksToDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "ReturnType"
            reportParameterCollection(3).Values.Add(ReturnedChecksType)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "Customer"
            reportParameterCollection(4).Values.Add(ReturnedChecksCustomerNo)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If ReturnedChecksFromDate <> "" And ReturnedChecksToDate <> "" Then
                filename = "Returned Checks From " + Convert.ToDateTime(ReturnedChecksFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(ReturnedChecksToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            ElseIf ReturnedChecksCustomerNo <> "0" Then
                filename = "Returned Checks For Customer " + ReturnedChecksCustomerNo + ".pdf"
            Else
                filename = "Returned Checks.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptARReturnedChecks", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If ReturnedChecksFromDate <> "" And ReturnedChecksToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Returned Checks From " + ReturnedChecksFromDate + " To " + ReturnedChecksToDate + " by user:" + User.Email), "labelnotification")
                ElseIf ReturnedChecksCustomerNo <> "0" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Returned Checks For Customer# " + ReturnedChecksCustomerNo + " by user:" + User.Email), "labelnotification")
                Else
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Returned Checks by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARReturnedChecksReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintARAllInvoicesReport(ByVal InvoicesFromDate As String, InvoicesToDate As String) As String
        Try
            Dim ARInvoicesReportResult As String = ""
            Dim RowCount = ARHIST.GetCountForAllInvoices(InvoicesFromDate, InvoicesToDate)

            If RowCount > 0 Then
                ARInvoicesReportResult = PrintAllInvoicesReport(InvoicesFromDate, InvoicesToDate)
            ElseIf RowCount = 0 Then
                ARInvoicesReportResult = "No Data"
            End If

            Return ARInvoicesReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARAllInvoicesReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintAllInvoicesReport(ByVal InvoicesFromDate As String, InvoicesToDate As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(InvoicesFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(InvoicesToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If InvoicesFromDate <> "" And InvoicesToDate <> "" Then
                filename = "All Invoices From " + Convert.ToDateTime(InvoicesFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(InvoicesToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "AllInvoices.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptARInvoices", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If InvoicesFromDate <> "" And InvoicesToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For All Invoices From " + InvoicesFromDate + " To " + InvoicesToDate + " by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintAllInvoicesReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintARInvoicesWithDifferences(ByVal InvoicesFromDate As String, InvoicesToDate As String) As String
        Try
            Dim ARInvoicesReportResult As String = ""
            Dim RowCount = ARINVS.GetCountForInvoiceListing(InvoicesFromDate, InvoicesToDate)

            If RowCount > 0 Then
                ARInvoicesReportResult = PrintInvoiceListingReport(InvoicesFromDate, InvoicesToDate)
            ElseIf RowCount = 0 Then
                ARInvoicesReportResult = "No Data"
            End If

            Return ARInvoicesReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARInvoicesWithDifferences")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintInvoiceListingReport(ByVal InvoicesFromDate As String, InvoicesToDate As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FROMDATE"
            reportParameterCollection(1).Values.Add(InvoicesFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "TODATE"
            reportParameterCollection(2).Values.Add(InvoicesToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If InvoicesFromDate <> "" And InvoicesToDate <> "" Then
                filename = "Invoice Listing From " + Convert.ToDateTime(InvoicesFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(InvoicesToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "Invoice Listinh.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptInvoiceListing", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If InvoicesFromDate <> "" And InvoicesToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Invoice Listing From " + InvoicesFromDate + " To " + InvoicesToDate + " by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceListingReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintARCreditsByCustReport(ByVal CreditsFromDate As String, CreditsToDate As String, ByVal CreditsDateType As String) As String
        Try
            Dim ARCreditsReportResult As String = ""
            Dim RowCount = ARHIST.GetCountForCreditsByCust(CreditsFromDate, CreditsToDate, CreditsDateType)

            If RowCount > 0 Then
                ARCreditsReportResult = PrintCreditsByCustReport(CreditsFromDate, CreditsToDate, CreditsDateType)
            ElseIf RowCount = 0 Then
                ARCreditsReportResult = "No Data"
            End If

            Return ARCreditsReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARCreditsByCustReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintCreditsByCustReport(ByVal CreditsFromDate As String, CreditsToDate As String, ByVal CreditsDateType As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(CreditsFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(CreditsToDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "CreditType"
            reportParameterCollection(3).Values.Add(CreditsDateType)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If CreditsFromDate <> "" And CreditsToDate <> "" Then
                filename = "Credits By Customer From " + Convert.ToDateTime(CreditsFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(CreditsToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "Credits By Customer.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptARCredits", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If CreditsFromDate <> "" And CreditsToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Credits By Customer From " + CreditsFromDate + " To " + CreditsToDate + " by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARCreditsByCustReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintARCreditCardPaymentsReport(ByVal PaymentsFromDate As String, PaymentsToDate As String, ByVal PaymentsType As String, ByVal PaymentsDateType As String) As String
        Try
            Dim ARPaymentsReportResult As String = ""
            Dim RowCount As Integer
            If PaymentsType = "Detailed" Then
                RowCount = ARCARD.GetCountForPayments(PaymentsFromDate, PaymentsToDate, "UDP_ARCardPaymentsDetailed", PaymentsDateType)
            ElseIf PaymentsType = "Summary" Then
                RowCount = ARCARD.GetCountForPayments(PaymentsFromDate, PaymentsToDate, "UDP_ARCardPaymentsSummary", PaymentsDateType)
            End If
            If RowCount > 0 Then
                ARPaymentsReportResult = PrintPaymentsReport(PaymentsFromDate, PaymentsToDate, PaymentsType, PaymentsDateType)
            ElseIf RowCount = 0 Then
                ARPaymentsReportResult = "No Data"
            End If
            Return ARPaymentsReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARCreditCardPaymentsReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintPaymentsReport(ByVal PaymentsFromDate As String, PaymentsToDate As String, ByVal PaymentsType As String, ByVal PaymentsDateType As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(PaymentsFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(PaymentsToDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "PaymentsDateType"
            reportParameterCollection(3).Values.Add(PaymentsDateType)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If PaymentsFromDate <> "" And PaymentsToDate <> "" Then
                filename = "Payments " + PaymentsType + " From " + Convert.ToDateTime(PaymentsFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(PaymentsToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "Payments " + PaymentsType + ".pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""

            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptARCardPayments" + PaymentsType, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")



            If ReportName <> "" Then
                If PaymentsFromDate <> "" And PaymentsToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Payments " + PaymentsType + " From " + PaymentsFromDate + " To " + PaymentsToDate + " by user:" + User.Email), "labelnotification")
                End If
            End If

            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPaymentsReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintARAdjustmentReport(ByVal AdjustmentFromDate As String, AdjustmentToDate As String, ByVal AdjustmentDateType As String, GL As Boolean) As String
        Try
            Dim ARAdjustmentReportResult As String = ""
            Dim RowCount = ARAdjustment.GetCountForAdjustment(AdjustmentFromDate, AdjustmentToDate, AdjustmentDateType)

            If RowCount > 0 Then
                ARAdjustmentReportResult = PrintAdjustmentReport(AdjustmentFromDate, AdjustmentToDate, AdjustmentDateType, GL)
            ElseIf RowCount = 0 Then
                ARAdjustmentReportResult = "No Data"
            End If

            Return ARAdjustmentReportResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARAdjustmentReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintAdjustmentReport(ByVal AdjustmentFromDate As String, AdjustmentToDate As String, ByVal AdjustmentDateType As String, ByVal GL As Boolean) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(4) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(AdjustmentFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(AdjustmentToDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "AdjustmentDateType"
            reportParameterCollection(3).Values.Add(AdjustmentDateType)

            reportParameterCollection(4) = New ReportParameter()
            reportParameterCollection(4).Name = "ByGL"
            reportParameterCollection(4).Values.Add(GL)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If AdjustmentFromDate <> "" And AdjustmentToDate <> "" Then
                filename = "Adjustment listing From " + Convert.ToDateTime(AdjustmentFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(AdjustmentToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "Adjustment listing.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptARAdjustment", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If AdjustmentFromDate <> "" And AdjustmentToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Adjusment listing From " + AdjustmentFromDate + " To " + AdjustmentToDate + " by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintARAdjustmentReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintDocsToExcel() As String
        Try
            Dim data As List(Of BOCustDO) = DAOCustDO.GetARReportsDocsDetail()

            Dim dt1 As DataTable

            dt1 = ConvertToDataTable(data)
            Dim selectedColumns As String() =
                {"Customer", "CustomerName", "DocType", "DelType", "Address"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            'dt.Columns("Name").ColumnName = "Customer Name"
            'dt.Columns("City").ColumnName = "Purchaser"
            'dt.Rows.RemoveAt(dt.Rows.Count - 1)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "ARDocs$ARDocs")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintDocsToExcel")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Anitha :: 22-Oct-2018 :: check COD report have any data to print
    ''' </summary>
    ''' <param name="CODFromDate"></param>
    ''' <param name="CODToDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CheckCntforCODReport(ByVal CODFromDate As String, ByVal CODToDate As String) As String
        Try
            Return F_CREREQ.CheckCntforCODReport(CODFromDate, CODToDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckCntforCODReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    ''' <summary>
    ''' ANITHA :: OCT-01-2018 :: PrintCODReport
    ''' </summary>
    ''' <param name="CODFromDate"></param>
    ''' <param name="CODToDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintCODReport(ByVal CODFromDate As String, ByVal CODToDate As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            'Dim WhereClause As String = "[DATE]>='" + CODFromDate + "' And [DATE]<='" + CODToDate + "' And COD='Y'"
            'Dim WhereClause As String = "[DATE]>='" + CODFromDate + "' And [DATE]<='" + CODToDate + "'"

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(CODFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(CODToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            filename = "CODReport" + Convert.ToDateTime(CODFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + "_To_" + Convert.ToDateTime(CODToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " .pdf"
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptCODReport", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For COD Report From:" + CODFromDate + " To " + CODToDate + " by user:" + User.Email), "labelnotification")
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintCODReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    ''' <summary>
    ''' Anitha :: check sales maintenance journal have any data to print
    ''' </summary>
    ''' <param name="SalesMaintenanceJournalFromDate"></param>
    ''' <param name="SalesMaintenanceJournalToDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CheckCntforPrintSalesMaintenanceJournal(ByVal SalesMaintenanceJournalFromDate As String, ByVal SalesMaintenanceJournalToDate As String) As String
        Try
            Return F_CREREQ.CheckCntforPrintSalesMaintenanceJournal(SalesMaintenanceJournalFromDate, SalesMaintenanceJournalToDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckCntforPrintSalesMaintenanceJournal")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    ''' <summary>
    ''' ANITHA :: OCT-01-2018 :: PrintSalesMaintenanceJournal
    ''' </summary>
    ''' <param name="SalesMaintenanceJournalFromDate"></param>
    ''' <param name="SalesMaintenanceJournalToDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesMaintenanceJournal(ByVal SalesMaintenanceJournalFromDate As String, ByVal SalesMaintenanceJournalToDate As String, ByVal Eod As Boolean) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim FromEmail As String = User.Email

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If

            'Dim WhereClause As String = "[DATE]>='" + CODFromDate + "' And [DATE]<='" + CODToDate + "' And COD='Y'"
            'Dim WhereClause As String = "[DATE]>='" + CODFromDate + "' And [DATE]<='" + CODToDate + "'"

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(3) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(SalesMaintenanceJournalFromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(SalesMaintenanceJournalToDate)

            reportParameterCollection(3) = New ReportParameter()
            reportParameterCollection(3).Name = "Eod"
            reportParameterCollection(3).Values.Add(Eod)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""
            filename = "SalesMaintenanceJournal" + Convert.ToDateTime(SalesMaintenanceJournalFromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " To " + Convert.ToDateTime(SalesMaintenanceJournalToDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptSalesMaintenanceJournal", reportParameterCollection, ExportSSRS.PdfOrientation.SalesMaintenanceJournal, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification For Sales Maintenance Journal From:" + SalesMaintenanceJournalFromDate + " To " + SalesMaintenanceJournalToDate + " by user:" + User.Email), "labelnotification")
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesMaintenanceJournal")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

#End Region

#Region "Setups"
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSetupsReport(ByVal ReportOption As String, ByVal FromDate As String, ByVal ToDate As String, ByVal Airport As String) As String
        Try
            Dim SetupsReportResult As String = ""

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter()
            Dim Names As String()
            Dim RptFiles As String()
            Dim count As Integer
            Dim RptName As String = ""

            If FromDate = "" And ToDate = "" And Airport = "" Then
                If ReportOption = "Duty Table Listing" Or ReportOption = "Tax Table Listing" Then
                    RptName = "rptFilesDutyTaxList"
                    reportParameterCollection = New ReportParameter(1) {}
                    reportParameterCollection(0) = New ReportParameter()
                    reportParameterCollection(0).Name = "ConnectionString"
                    reportParameterCollection(0).Values.Add(ConString)

                    reportParameterCollection(1) = New ReportParameter()
                    reportParameterCollection(1).Name = "whereClause"
                    reportParameterCollection(1).Values.Add(If(ReportOption = "Duty Table Listing", "F_FLODUT", "F_FLOTAX"))
                    filename = ReportOption + ".pdf"
                Else
                    Names = {"Salesperson Listing", "Carrier Codes Listing", "Airport Codes Listing", "Credit Terms Listing", "Customer Types Listing", "Product Categories Listing", "Brands Listing", "Order Entry Changes", "Credits Reason Codes", "Call History", "Price Approval Listing"}
                    RptFiles = {"rptFilesSalespersonList", "rptFilesCarrierList", "rptFilesAirportList", "rptFilesCreditTermsList", "rptFilesCustTypesList", "rptFilesProdTypesList", "rptFilesBrandsList", "rptFilesOrderEntryChangesList", "rptFilesCreditReasonCodesList", "rptFilesCallHistList", ""}

                    For count = 0 To Names.Length - 1
                        If Names(count) = ReportOption Then
                            RptName = RptFiles(count)
                        End If
                    Next

                    reportParameterCollection = New ReportParameter(0) {}
                    reportParameterCollection(0) = New ReportParameter()
                    reportParameterCollection(0).Name = "ConnectionString"
                    reportParameterCollection(0).Values.Add(ConString)
                    filename = ReportOption + ".pdf"
                End If
            ElseIf Airport <> "" Then
                RptName = "rptFilesFarmsList"
                reportParameterCollection = New ReportParameter(1) {}
                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "whereClause"
                reportParameterCollection(1).Values.Add(Airport)

                filename = If(Airport <> "All", ReportOption + " By Orgin " + Airport + ".pdf", ReportOption + ".pdf")
            Else
                Names = {"Salesperson Listing", "Carrier Codes Listing", "Airport Codes Listing", "Duty Table Listing", "Credit Terms Listing", "Customer Types Listing", "Product Categories Listing", "Brands Listing", "Order Entry Changes", "Credits Reason Codes", "Call History", "Price Approval Listing"}
                RptFiles = {"rptFilesSalespersonList", "rptFilesCarrierList", "rptFilesAirportList", "", "rptFilesCreditTermsList", "rptFilesCustTypesList", "rptFilesProdTypesList", "rptFilesBrandsList", "rptFilesOrderEntryChangesList", "rptFilesCreditReasonCodesList", "rptFilesCallHistList", "rptFilesApprovedHistoryList"}

                For count = 0 To Names.Length - 1
                    If Names(count) = ReportOption Then
                        RptName = RptFiles(count)
                    End If
                Next

                reportParameterCollection = New ReportParameter(2) {}
                reportParameterCollection(0) = New ReportParameter()
                reportParameterCollection(0).Name = "ConnectionString"
                reportParameterCollection(0).Values.Add(ConString)

                reportParameterCollection(1) = New ReportParameter()
                reportParameterCollection(1).Name = "FromDate"
                reportParameterCollection(1).Values.Add(FromDate)

                reportParameterCollection(2) = New ReportParameter()
                reportParameterCollection(2).Name = "ToDate"
                reportParameterCollection(2).Values.Add(ToDate)
                filename = ReportOption + " From " + FromDate.Replace("/", "_") + " To " + ToDate.Replace("/", "_") + ".pdf"
            End If

            'filename = CompanyName + "DepositSummaryFrom " + FromDate.ToString() + "To" + ToDate.ToString() + ".pdf"

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, RptName, reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report Printing Notification for " + ReportName + " by user:" + User.Email), "labelnotification")
            Return ReportName
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSetupsReport")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintProductsToExcel() As String
        Try
            Dim data As List(Of Flower) = Flowers.GetProductDetailsListing()

            Dim dt1 As DataTable

            dt1 = ConvertToDataTable(data)
            Dim selectedColumns As String() =
                {"Flower", "CAT", "Name", "Charge", "BOXES", "UNITS", "UnitsPerBunch", "PRICE", "PACKED", "UOM", "BUNCH", "WEIGHT", "GROWER", "DUTY", "GRADE", "VARIETY", "Color", "FLOWERTYPE", "FLORALSTAT", "STATUS", "DAYS", "BILLCODE", "ColorCode", "UserCode", "PIC", "SENT", "ADDUSER", "ADDDATE", "ADDTIME", "ADDAPP", "DELUSER", "DELDATE", "DELTIME", "DELAPP", "UPDUSER", "UPDDATE", "UPDTIME", "UPDAPP", "LOCKUSER", "LOCKDATE", "LOCKTIME", "LOCKAPP"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            'dt.Columns("Name").ColumnName = "Customer Name"
            'dt.Columns("City").ColumnName = "Purchaser"
            'dt.Rows.RemoveAt(dt.Rows.Count - 1)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "ProductListing$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintProductsToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintCustomerListingToExcel() As String
        Try
            Dim obj As CustomerDetails.GetCustomerDetailsForFgrd = New CustomerDetails.GetCustomerDetailsForFgrd()
            Dim Data As List(Of CustomerDetail) = obj.GetCustomerDetailsFromSQL("")

            Dim dt1 As DataTable

            dt1 = ConvertToDataTable(Data)
            Dim selectedColumns As String() =
                {"CUSTOMER", "Name", "ADDRESS1", "ADDRESS2", "CITY", "STATE", "ZIP", "COUNTRY", "PHONE", "SALESMAN", "SalesmanName", "ARBalance"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            'dt.Columns("Name").ColumnName = "Customer Name"
            'dt.Columns("City").ColumnName = "Purchaser"
            'dt.Rows.RemoveAt(dt.Rows.Count - 1)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "CustomerListing$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintCustomerListingToExcel")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSOToExcel() As String
        Try
            Dim data As List(Of SPORDD) = SPORD.GetSPORDSODetailsForExcel()

            Dim dt1 As DataTable

            dt1 = ConvertToDataTable(data)
            Dim selectedColumns As String() =
                {"FARM", "CARGODAY", "FLOWER", "BOXES", "UOM", "UNITS", "COST", "UNITSBUNCH", "PO", "CARRIER2", "COMMENTS", "PODFLOWER", "ADDUSER", "ADDDATE", "ADDTIME"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            'dt.Columns("Name").ColumnName = "Customer Name"
            'dt.Columns("City").ColumnName = "Purchaser"
            'dt.Rows.RemoveAt(dt.Rows.Count - 1)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "FarmsSO$FarmsList")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSOToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryReportToExcel(ByVal FromDate As String, ToDate As String, ByVal Flower As String, ByVal Category As String, Grade As String, ByVal Variety As String, ByVal Color As String, ByVal Farm As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryReport(FromDate, ToDate, Flower, Category, Grade, Variety, Color, Farm)
            Dim selectedColumns As String() = {"FLOWER", "NAME", "CAT", "COLOR", "VARIETY", "GRADE", "TOTALSALES", "TOTALUNITS", "TOTALPRICE", "AVERAGEPRICE"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "SalesSummary$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryReportToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryReportBySalesPersonToExcel(ByVal FromDate As String, ToDate As String, ByVal Farm As String, ByVal SalesPerson As String, ByVal ReportType As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryBySalesPersonReport(FromDate, ToDate, Farm, SalesPerson, ReportType)
            Dim selectedColumns As String() = {"SALESMAN", "CUSTOMER", "CUSTNAME", "BOXESSOLD", "TOTALUNITS", "TOTALSALES"}
            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            dt.Columns("SALESMAN").ColumnName = "Sales Person#"
            dt.Columns("CUSTNAME").ColumnName = "Cust Name#"
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dt1, "SalesSummaryBySPer$FileReports", "", FromDate, ToDate)
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryReportBySalesPersonToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintGPMBouqCalcToExcel(ByVal FromDate As String, ToDate As String, ByVal SalesPerson As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintGPMBouqCalcToExcel(FromDate, ToDate, SalesPerson)
            Syncfusion.Licensing.SyncfusionLicenseProvider.RegisterLicense("NTY4NDg5QDMxMzkyZTM0MmUzMEp5SXhoOUMvZDR6S1JJeDZvRkhrbVRka0xBRDNVRTQ5MkMwdmQ2ZUM1UDg9;NTY4NDkwQDMxMzkyZTM0MmUzMFBkRmpZVUFFRGNRdmlzRjhJdTlYOVdMRFZaVU8zRkdKSTRiNzRmSGx6dGs9;NTY4NDkxQDMxMzkyZTM0MmUzMGNUcXZCZG0veWFUZHJjZEFjSDYyWWlrZlFUUURhWW0wUTJwbE5kTG5yY1E9;NTY4NDkyQDMxMzkyZTM0MmUzMElacTlBeVJHTVhQMTBjb2I0R2llRE95QnVRSTBEYXBJM3B1Tll4eHAvc1E9;NTY4NDkzQDMxMzkyZTM0MmUzMFJ4ZXVhV1lXNGI0UG5yeWJWSWdVd3J0dTMvb3RMbENXTzdLcUN5UTYwWU09;NTY4NDk0QDMxMzkyZTM0MmUzMGl4WXVUQ2VkUlRKR2EzU1llNWk1dFh4NVNQcGRVcHkxQVdkam9hUDNOVUk9;NTY4NDk1QDMxMzkyZTM0MmUzMGh4YU1zTS82OGl0UWt1NzFPZC9QdkFzU0x2bmY3MWxic0h4Vjl3M0hRenc9;NTY4NDk2QDMxMzkyZTM0MmUzMGtaZDBjdWhSWmVRYzNlSTUyenlHVVVTQktaWTQ1b0N1ZXo2Ry9uNjh0aEk9;NTY4NDk3QDMxMzkyZTM0MmUzMFFpaktVRVNPN1NrT1lkUW5SdjVDMll1eDJVelYwNVN2WTZrMkRNcXhjZ289;NTY4NDk4QDMxMzkyZTM0MmUzMEtqc0E4bk92Ykw3emZlajN6WDZZWmpLWFJvckVrajRzd2R5TDF6a3FRbHM9;NTY4NDk5QDMxMzkyZTM0MmUzMFlqb2txcklTZDgyRU81YVBOa2xZTXcvTmpNbGVYMEppM0JSK1ViUXUrN0k9")
            Dim FolderPath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()
            Dim Foldername = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim FulFilePath = FolderPath + Foldername + "\\"
            Dim filename As String = "BouquetExplosionReport_" + DateTime.Now.ToString("HHmmss") + ".xlsx"
            GPMtoExcelBouq(dt1, FulFilePath, filename)

            Return filename
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintGPMCalcToExcel")
            Return Nothing
        End Try

    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintGPMCalcToExcel(ByVal FromDate As String, ToDate As String, ByVal SalesPerson As String, ByVal bySalesDate As String) As String
        Try
            Dim dt1 As DataTable
            'Dim filename As String = "GrossProfitReport_from_" + FromDate + "_to_" + ToDate + "_" + DateTime.Now.ToString("HHmmss") + ".xlsx"
            dt1 = SalesOrder.PrintGPMCalcToExcel(FromDate, ToDate, SalesPerson, bySalesDate)
            Syncfusion.Licensing.SyncfusionLicenseProvider.RegisterLicense("NTY4NDg5QDMxMzkyZTM0MmUzMEp5SXhoOUMvZDR6S1JJeDZvRkhrbVRka0xBRDNVRTQ5MkMwdmQ2ZUM1UDg9;NTY4NDkwQDMxMzkyZTM0MmUzMFBkRmpZVUFFRGNRdmlzRjhJdTlYOVdMRFZaVU8zRkdKSTRiNzRmSGx6dGs9;NTY4NDkxQDMxMzkyZTM0MmUzMGNUcXZCZG0veWFUZHJjZEFjSDYyWWlrZlFUUURhWW0wUTJwbE5kTG5yY1E9;NTY4NDkyQDMxMzkyZTM0MmUzMElacTlBeVJHTVhQMTBjb2I0R2llRE95QnVRSTBEYXBJM3B1Tll4eHAvc1E9;NTY4NDkzQDMxMzkyZTM0MmUzMFJ4ZXVhV1lXNGI0UG5yeWJWSWdVd3J0dTMvb3RMbENXTzdLcUN5UTYwWU09;NTY4NDk0QDMxMzkyZTM0MmUzMGl4WXVUQ2VkUlRKR2EzU1llNWk1dFh4NVNQcGRVcHkxQVdkam9hUDNOVUk9;NTY4NDk1QDMxMzkyZTM0MmUzMGh4YU1zTS82OGl0UWt1NzFPZC9QdkFzU0x2bmY3MWxic0h4Vjl3M0hRenc9;NTY4NDk2QDMxMzkyZTM0MmUzMGtaZDBjdWhSWmVRYzNlSTUyenlHVVVTQktaWTQ1b0N1ZXo2Ry9uNjh0aEk9;NTY4NDk3QDMxMzkyZTM0MmUzMFFpaktVRVNPN1NrT1lkUW5SdjVDMll1eDJVelYwNVN2WTZrMkRNcXhjZ289;NTY4NDk4QDMxMzkyZTM0MmUzMEtqc0E4bk92Ykw3emZlajN6WDZZWmpLWFJvckVrajRzd2R5TDF6a3FRbHM9;NTY4NDk5QDMxMzkyZTM0MmUzMFlqb2txcklTZDgyRU81YVBOa2xZTXcvTmpNbGVYMEppM0JSK1ViUXUrN0k9")
            Dim FolderPath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()
            Dim Foldername = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim FulFilePath = FolderPath + Foldername + "\\"
            Dim filename As String = "GrossProfitReport_from_" + FromDate.Replace("/", "_") + "_to_" + ToDate.Replace("/", "_") + "_" + DateTime.Now.ToString("HHmmss") + ".xlsx"

            'Dim filename As String = "GrossProfitReport_" + DateTime.Now.ToString("HHmmss") + ".xlsx"

            GPMtoExcel(dt1, FulFilePath, filename, FromDate, ToDate)

            Return filename
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintGPMCalcToExcel")
            Return Nothing
        End Try
    End Function

    Private Function GPMtoExcelBouq(dt1 As DataTable, FulFilePath As String, filename As String) As Boolean
        Dim rownumber As Int32 = 4, colnumber = 0
        Dim ee As ExcelEngine = New ExcelEngine()
        Dim app As IApplication = ee.Excel
        app.DefaultVersion = ExcelVersion.Excel2016

        Dim wb As IWorkbook = app.Workbooks.Create(2)
        Dim sheet As IWorksheet = wb.Worksheets(0)
        sheet.Name = "Data"
        sheet.Range().Item("A2").Text = "Sales calculation"
        sheet.Range().Item("A3").Text = "Invoice"
        sheet.Range().Item("B3").Text = "AWB"
        sheet.Range().Item("C3").Text = "FARM"
        sheet.Range().Item("D3").Text = "FARM INV"
        sheet.Range().Item("E3").Text = "BOXNUM"
        sheet.Range().Item("F3").Text = "DATE"
        sheet.Range().Item("G3").Text = "DATEREC"
        sheet.Range().Item("H3").Text = "CUSTOMER"
        sheet.Range().Item("I3").Text = "CustomerName"
        sheet.Range().Item("J3").Text = "flower"
        sheet.Range().Item("K3").Text = "FlowerName"
        sheet.Range().Item("L3").Text = "UOM"
        sheet.Range().Item("M3").Text = "Boxes"
        sheet.Range().Item("N3").Text = "Units"
        sheet.Range().Item("O3").Text = "Total units"
        sheet.Range().Item("P3").Text = "Type"
        sheet.Range().Item("Q3").Text = "Category"
        sheet.Range().Item("R3").Text = "Sales Person"
        sheet.Range().Item("S3").Text = "Customer Type"
        sheet.Range().Item("T3").Text = "Month"
        sheet.Range().Item("U3").Text = "Year"
        Try

            For Each row In dt1.Rows
                sheet.Range().Item("A" & rownumber).Text = row("Invoice")
                sheet.Range().Item("B" & rownumber).Text = row("AWB")
                sheet.Range().Item("C" & rownumber).Text = row("FARM")
                sheet.Range().Item("D" & rownumber).Text = row("farmInv")
                sheet.Range().Item("E" & rownumber).Text = row("BOXNUM")
                sheet.Range().Item("F" & rownumber).DateTime = row("Date")
                sheet.Range().Item("G" & rownumber).DateTime = row("DATEREC")
                sheet.Range().Item("H" & rownumber).Text = row("CUSTOMER")
                sheet.Range().Item("I" & rownumber).Text = row("CustomerName")
                sheet.Range().Item("J" & rownumber).Text = row("flower")
                sheet.Range().Item("K" & rownumber).Text = row("FlowerName")
                sheet.Range().Item("L" & rownumber).Text = row("UOM")
                sheet.Range().Item("M" & rownumber).Number = row("boxes")
                sheet.Range().Item("N" & rownumber).Number = row("units")
                sheet.Range().Item("O" & rownumber).Number = row("boxes") * row("units")
                sheet.Range().Item("P" & rownumber).Text = row("MainType")
                sheet.Range().Item("Q" & rownumber).Text = row("FlowerCategory")
                sheet.Range().Item("R" & rownumber).Text = row("Salesman")
                sheet.Range().Item("S" & rownumber).Text = row("CustomerType")
                sheet.Range().Item("T" & rownumber).Number = DateAndTime.Month(row("Date"))
                sheet.Range().Item("U" & rownumber).Number = DateAndTime.Year(row("Date"))
                rownumber += 1
            Next
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GPMtoExcelBouq")

        End Try
        sheet.UsedRange.AutofitColumns()
        'sheet("A4:R" & rownumber).NumberFormat = True

        Dim data As PivotCacheImpl = wb.PivotCaches.Add(sheet("A3:U" & rownumber))
        sheet = wb.Worksheets(1)

        sheet.Name = "Report"
        Dim table As IPivotTable = sheet.PivotTables.Add("Reports", sheet("A1"), data)
        table.Fields(9).Axis = PivotAxisTypes.Row
        table.Fields(7).Axis = PivotAxisTypes.Row
        table.Fields(2).Axis = PivotAxisTypes.Row
        table.DataFields.Add(sheet.PivotTables(0).Fields(12), "Total Boxes", PivotSubtotalTypes.Sum)
        table.DataFields.Add(sheet.PivotTables(0).Fields(14), "Total Units", PivotSubtotalTypes.Sum)
        table.Location = sheet.Range(1, 1, 100, 20)
        table.Layout()
        data.IsRefreshOnLoad = True

        wb.SaveAs(FulFilePath + filename)
        Return True
    End Function

    Private Function GPMtoExcel(dt1 As DataTable, FulFilePath As String, filename As String, fromDate As String, toDate As String) As Boolean
        Dim rownumber As Int32 = 4, colnumber = 0
        Dim ee As ExcelEngine = New ExcelEngine()
        Dim app As IApplication = ee.Excel
        app.DefaultVersion = ExcelVersion.Excel2016

        Dim wb As IWorkbook = app.Workbooks.Create(2)
        Dim sheet As IWorksheet = wb.Worksheets(0)
        sheet.Name = "Data"
        sheet.Range().Item("A2").Text = "Sales calculation"
        sheet.Range().Item("A3").Text = "Invoice"
        sheet.Range().Item("B3").Text = "AWB"
        sheet.Range().Item("C3").Text = "FARM"
        sheet.Range().Item("D3").Text = "FARM INV"
        sheet.Range().Item("E3").Text = "BOXNUM"
        sheet.Range().Item("F3").Text = "DATE"
        sheet.Range().Item("G3").Text = "DATEREC"
        sheet.Range().Item("H3").Text = "CUSTOMER"
        sheet.Range().Item("I3").Text = "CustomerName"
        sheet.Range().Item("J3").Text = "flower"
        sheet.Range().Item("K3").Text = "FlowerName"
        sheet.Range().Item("L3").Text = "UOM"
        sheet.Range().Item("M3").Text = "Boxes"
        sheet.Range().Item("N3").Text = "Units"
        sheet.Range().Item("O3").Text = "Total units"
        sheet.Range().Item("P3").Text = "Price"
        sheet.Range().Item("Q3").Text = "Sales"
        sheet.Range().Item("R3").Text = "Cred"
        sheet.Range().Item("S3").Text = "Cost"
        sheet.Range().Item("T3").Text = "Profit"
        sheet.Range().Item("U3").Text = "GPM"
        sheet.Range().Item("V3").Text = "Flower Cost"
        sheet.Range().Item("W3").Text = "Total Flower Cost"
        sheet.Range().Item("X3").Text = "Freight Cost"
        sheet.Range().Item("Y3").Text = "Total Freight Cost"
        sheet.Range().Item("Z3").Text = "Handling Cost"
        sheet.Range().Item("AA3").Text = "Total Handling Cost"
        sheet.Range().Item("AB3").Text = "Duties"
        sheet.Range().Item("AC3").Text = "Total Duties"
        sheet.Range().Item("AD3").Text = "Type"
        sheet.Range().Item("AE3").Text = "Category"
        sheet.Range().Item("AF3").Text = "Sales Person"
        sheet.Range().Item("AG3").Text = "Customer Type"
        sheet.Range().Item("AH3").Text = "Month"
        sheet.Range().Item("AI3").Text = "Year"
        Try

            For Each row In dt1.Rows
                sheet.Range().Item("A" & rownumber).Text = row("Invoice")
                sheet.Range().Item("B" & rownumber).Text = row("AWB")
                sheet.Range().Item("C" & rownumber).Text = row("FARM")
                sheet.Range().Item("D" & rownumber).Text = row("farmInv")
                sheet.Range().Item("E" & rownumber).Text = row("BOXNUM")
                sheet.Range().Item("F" & rownumber).DateTime = row("Date")
                sheet.Range().Item("G" & rownumber).DateTime = row("DATEREC")
                sheet.Range().Item("H" & rownumber).Text = row("CUSTOMER")
                sheet.Range().Item("I" & rownumber).Text = row("CustomerName")
                sheet.Range().Item("J" & rownumber).Text = row("flower")
                sheet.Range().Item("K" & rownumber).Text = row("FlowerName")
                sheet.Range().Item("L" & rownumber).Text = row("UOM")
                sheet.Range().Item("M" & rownumber).Number = row("boxes")
                sheet.Range().Item("N" & rownumber).Number = row("units")
                sheet.Range().Item("O" & rownumber).Number = row("boxes") * row("units")
                sheet.Range().Item("P" & rownumber).Number = row("FOB")
                sheet.Range().Item("P" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("Q" & rownumber).Number = row("Sales")
                sheet.Range().Item("Q" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("R" & rownumber).Number = row("Cred")
                sheet.Range().Item("R" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("S" & rownumber).Number = row("Cost")
                sheet.Range().Item("S" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("T" & rownumber).Number = row("Sales") + row("Cred") - row("Cost")
                sheet.Range().Item("T" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("U" & rownumber).Number = row("GPM") / 100
                sheet.Range().Item("U" & rownumber).NumberFormat = "0.00%"
                sheet.Range().Item("V" & rownumber).Number = row("flowerCost")
                sheet.Range().Item("V" & rownumber).NumberFormat = "#,##0.0000"
                sheet.Range().Item("W" & rownumber).Number = row("totalflowerCost")
                sheet.Range().Item("W" & rownumber).NumberFormat = "#,##0.000"
                sheet.Range().Item("X" & rownumber).Number = row("freightCost")
                sheet.Range().Item("X" & rownumber).NumberFormat = "#,##0.000"
                sheet.Range().Item("Y" & rownumber).Number = row("totalfreightCost")
                sheet.Range().Item("Y" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("Z" & rownumber).Number = row("handling")
                sheet.Range().Item("Z" & rownumber).NumberFormat = "#,##0.000"
                sheet.Range().Item("AA" & rownumber).Number = row("totalhandling")
                sheet.Range().Item("AA" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("AB" & rownumber).Number = row("duties")
                sheet.Range().Item("AB" & rownumber).NumberFormat = "#,##0.000"
                sheet.Range().Item("AC" & rownumber).Number = row("totalduties")
                sheet.Range().Item("AC" & rownumber).NumberFormat = "#,##0.00"
                sheet.Range().Item("AD" & rownumber).Text = row("MainType")
                sheet.Range().Item("AE" & rownumber).Text = row("FlowerCategory")
                sheet.Range().Item("AF" & rownumber).Text = row("Salesman")
                sheet.Range().Item("AG" & rownumber).Text = row("CustomerType")
                sheet.Range().Item("AH" & rownumber).Number = DateAndTime.Month(row("Date"))
                sheet.Range().Item("AI" & rownumber).Number = DateAndTime.Year(row("Date"))
                rownumber += 1
            Next
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GPMToExcel")

        End Try
        sheet.UsedRange.AutofitColumns()
        'sheet("A4:R" & rownumber).NumberFormat = True

        Dim data As PivotCacheImpl = wb.PivotCaches.Add(sheet("A3:AI" & rownumber))
        sheet = wb.Worksheets(1)

        sheet.Name = "Report"
        sheet.Range().Item("A2").Text = "Gross Profit Report from " & fromDate & " to " & toDate
        Dim table As IPivotTable = sheet.PivotTables.Add("Reports", sheet("A1"), data)
        table.Fields(8).Axis = PivotAxisTypes.Row
        'table.Fields(7).Axis = PivotAxisTypes.Row
        'table.Fields(2).Axis = PivotAxisTypes.Row
        Dim fieldSales As IPivotField = sheet.PivotTables(0).Fields(16)
        Dim fieldCred As IPivotField = sheet.PivotTables(0).Fields(17)
        Dim fieldCost As IPivotField = sheet.PivotTables(0).Fields(18)
        Dim fieldGPM As IPivotField = sheet.PivotTables(0).Fields(20)
        Dim fieldProfit As IPivotField = sheet.PivotTables(0).Fields(19)
        fieldSales.NumberFormat = "0.00"
        fieldCost.NumberFormat = "0.00"
        fieldCred.NumberFormat = "0.00"
        fieldGPM.NumberFormat = "0.00%"
        table.DataFields.Add(sheet.PivotTables(0).Fields(12), "Total Boxes", PivotSubtotalTypes.Sum)
        table.DataFields.Add(sheet.PivotTables(0).Fields(14), "Total Units", PivotSubtotalTypes.Sum)
        table.DataFields.Add(fieldSales, "Total Sales", PivotSubtotalTypes.Sum)
        table.DataFields.Add(fieldCost, "Total Cost", PivotSubtotalTypes.Sum)
        table.DataFields.Add(fieldCred, "Total Cred", PivotSubtotalTypes.Sum)
        table.DataFields.Add(fieldProfit, "Total Profit", PivotSubtotalTypes.Sum)
        table.DataFields.Add(fieldGPM, "Total GPM", PivotSubtotalTypes.Average)
        table.Location = sheet.Range(3, 1, 100, 20)
        table.Layout()
        data.IsRefreshOnLoad = True

        wb.SaveAs(FulFilePath + filename)
        Return True
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryByCustomerToExcel() As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryByCustomer()
            dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "SalesSummaryByCustomer$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryByCustomerToExcel")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryReportByDayToExcel(ByVal FromDate As String, ToDate As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryReportByDay(FromDate, ToDate)
            'dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "PrintSalesSummaryReportByDay$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryReportByDayToExcel")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintExpenseReportToExcel(ByVal FromDate As String, ToDate As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintExpenseReport(FromDate, ToDate)
            'dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "PrintExpenseReport$FileReports", "", FromDate, ToDate)
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintExpenseReportToExcel")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryReportByStateToExcel(ByVal FromDate As String, ToDate As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryReportByState(FromDate, ToDate)
            'dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "PrintSalesSummaryReportByState$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryReportByStateToExcel")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintInvoiceDifferenceToExcel(ByVal FromDate As String, ToDate As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = ARINVS.PrintInvoiceswithDifferences(FromDate, ToDate)
            'dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "PrintInvoiceDifference$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintInvoiceDifferenceToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryBySalesManToExcel() As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryBySalesManToExcel()
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "SalesSummaryBySalesMan$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryBySalesManToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryBySalesManByMonthToExcel() As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryBySalesManByMonthToExcel()
            dt1.Columns.Remove("SalesPersonID")
            dt1.Columns.Remove("SalesPerson")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "ByMonthlySaleBySPer$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryBySalesManByMonthToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryByCustomerGroupToExcel() As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryByCustomerGroup()
            dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "ByCustomerGroupSalesSummary$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryByCustomerGroupToExcel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryByFarmToExcel() As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryByFarm()
            dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "SalesSummaryByFarm$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryByFarmToExcel")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryByCategoryToExcel() As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryByCategory()
            dt1.Columns.Remove("ID")
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "SalesSummaryByCategory$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryByCategoryToExcel")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryByProductToExcel() As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintSalesSummaryByProduct()
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "SalesSummaryByProduct$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryByProductToExcel")
            Return Nothing
        End Try
    End Function
    'Modified by Anubhuti 2023_06_29
    <System.Web.Services.WebMethod(True)>
    Public Function PrintInventoryAvailabilityReportToExcel(ByVal MarketToIgnore As String, ByVal IsFuelIncluded As String, ByVal PriceLevel As String) As String
        Try
            Dim dt1 As DataTable
            dt1 = SalesOrder.PrintInventoryAvailabilityReportToExcel(MarketToIgnore, IsFuelIncluded, PriceLevel)
            Dim dtCloned As DataTable = dt1.Clone()
            For Each row As DataRow In dt1.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "InventoryAvailability$FileReports")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryByCustomerToExcel")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Get excel report for sales summary :: Created by Abinaya
    ''' </summary>
    ''' <param name="SummaryBy"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function PrintSalesSummaryToExcel(ByVal SummaryBy As String) As String
        Try
            Dim currentYear = Year(Date.Now)
            Dim data As List(Of Payment) = Payments.GetSalesSummaryDetails(SummaryBy, currentYear)

            Dim dt1 As DataTable

            dt1 = ConvertToDataTable(data)
            Dim selectedColumns As String() = If(SummaryBy = "CustomerSummary", {"Salesman", "Customer", "CustName", "SalesValue1", "SalesValue2", "SalesValue3", "SalesValue4", "SalesValue5"}, {"Salesman", "SalesmanName", "SalesValue1", "SalesValue2", "SalesValue3", "SalesValue4", "SalesValue5"})

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            dt.Columns("Salesman").ColumnName = "Sales Person#"
            If (SummaryBy = "CustomerSummary") Then
                dt.Columns("Customer").ColumnName = "Customer#"
                dt.Columns("CustName").ColumnName = "Customer Name"
            End If
            dt.Columns("SalesValue1").ColumnName = currentYear
            dt.Columns("SalesValue2").ColumnName = currentYear - 1
            dt.Columns("SalesValue3").ColumnName = currentYear - 2
            dt.Columns("SalesValue4").ColumnName = currentYear - 3
            dt.Columns("SalesValue5").ColumnName = currentYear - 4

            'dt.Rows.RemoveAt(dt.Rows.Count - 1)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, If(SummaryBy = "CustomerSummary", "CustSalesSummary$FileReports", "SalesPersonSummary$FileReports"))
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintSalesSumamryToExcel")
            Return Nothing
        End Try
    End Function


#End Region

#Region "Constant"

    <System.Web.Services.WebMethod(True)>
    Public Function GetNextInvoiceNumFromConstant() As String
        Try
            Dim InvoiceNumber = DAO.Constant.GetNextInvoiceNumFromConstant()
            Return InvoiceNumber
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNextInvoiceNumFromConstant")
            Return 0
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPrintInvoiceAndPickListConstant() As String
        Try
            Dim result = DAO.Constant.GetPrintInvoiceAndPickListConstant()
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPrintInvoiceAndPickListConstant")
            Return "False"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetReportToPrintAtSaveConstant() As String
        Try
            Dim result = DAO.Constant.GetReportToPrintAtSaveConstant()
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPrintInvoiceAndPickListConstant")
            Return ""
        End Try
    End Function


    ''' <summary>
    ''' Mani::11/30/2018:Get Next Prebook Number from constant
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetNextPrebookNumFromConstant() As String
        Try
            Dim PrebookNum = DAO.Constant.GetNextPrebookNumFromConstant()
            Return PrebookNum
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNextPrebookNumFromConstant")
            Return 0
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetShowGenerateAutoPOConstant() As String
        Try
            Dim result = DAO.Constant.GetShowGenerateAutoPOConstant()
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetShowGenerateAutoPOConstant")
            Return "False"
        End Try
    End Function

#End Region

#Region "New Order"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetNewOrderGridList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String,
                                        ByVal query As String, ByVal qtype As String, ByVal Customer As String, ByVal ExportCSV As String) As XmlDocument

        Try

            If qtype.ToLower() = "lot" Then
                query = Regex.Replace(query, "[-]", "")
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim whereCondition As String = ""

            If Customer = "" Then
                whereCondition = "[Order]=0 And vw.CUSTOMER=0"
            Else
                whereCondition = "[Order]=0 And vw.CUSTOMER=" + Customer + ""
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (page <= 0) Then
                rp = 0
                start = 0
            End If



            Dim data = Nothing
            Dim isEXTRAFIELD As String = "S"                    '27 Mar 19 :: Muthu Nivetha M ::  On invoice show if line is a substitute

            'data = SalesOrder.GetSalesOrderDetailsList(If(OrderNo <> "", "[Order]=" + OrderNo, ""), "", 0, 0)
            ''2021/08/14
            ''data = SalesOrder.GetSalesOrderDetailsList(whereCondition, "Flower asc", start, rp, User.ID)
            data = SalesOrder.GetSalesOrderDetailsList(whereCondition, "ORDER BY Flower,SQLID asc", start, rp, User.ID)

            Dim dt As DataTable = ConvertToDataTable(data)

            If dt.Rows.Count > 0 Then

                If dt(0)("ErrorMessage").ToString() = "" Then


                    Dim TotalRowCount As Integer = 0

                    If dt.Rows.Count > 0 Then
                        TotalRowCount = dt(0)("TotalRows").ToString()
                    End If

                    Dim UserFeatures As List(Of Feature) = Session("LoginUserFeatures")
                    Dim ShipmentStatus As Boolean = False
                    Dim FlowerColorVisibility As Boolean = True
                    'For Each i In UserFeatures
                    '    If i.Name.ToLower = "show flower color" Then
                    '        FlowerColorVisibility = i.Value
                    '    End If
                    'Next

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                    New XElement("rows", New XElement("page", page.ToString()),
                    New XElement("total", TotalRowCount),
                    From row In dt.Rows()
                    Select
                    New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                    New XElement("cell", "<img href='#'  id='NewOrderDetailDelete_" & Convert.ToString(row("ID")) & "~" & row("Farmcode") & "' src='images/Delete-icon.png' style='cursor:pointer'/>"),
                    New XElement("cell", "<img href='#'  id='NewOrderDetailEdit_" & Convert.ToString(row("ID")) & "~" & row("Farmcode") & "' src='images/Edit.png' style='cursor:pointer'/>"),
                    New XElement("cell", " <img href='#'  src='images/FACE03.png' title='Credits' style='cursor:pointer;width: 16px;height: 16px;'/>"),
                    New XElement("cell", IIf(row("EXTRAFIELD").ToString().ToUpper() = isEXTRAFIELD, "<div style='padding: 0;color:red;'>" + row("Flower") + "</div>", row("Flower"))),
                    New XElement("cell", IIf(FlowerColorVisibility, "<div style='padding-bottom: 3px;background-color:" + row("BGColor").ToString() + "' class='flowerDescription'><a id='NewOrderDetailName_" & Convert.ToString(row("ID")) & "' style='color:" + row("FontColor").ToString() + ";'>" + row("Name") + "</a></div>", "<a >" + row("Name") + "</a>")),
                    New XElement("cell", row("FarmCode")),
                    New XElement("cell", If(Convert.ToString(row("AWB")) = 0, If(row("ID") = 0, "", ""), If(row("AWB").ToString().Length <= 3, row("AWB"), row("AWB").ToString().Substring(If(row("AWB") = 0, 0, row("AWB").ToString().Length - 4))))),
                    New XElement("cell", "<a id='NewOrderDetailBoxes_" & Convert.ToString(row("ID")) & "' >" + IIf(Convert.ToString(row("Boxes1")) = "0", "", Convert.ToString(row("Boxes1"))) + "</a>"),
                    New XElement("cell", "<a id='NewOrderDetailUOM_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("UOM")) + "</a>"),
                    New XElement("cell", "<a id='NewOrderDetailUnits_" & Convert.ToString(row("ID")) & "' >" + IIf(Convert.ToString(row("Units")) = "0", "", Convert.ToString(row("Units"))) + "</a>"),
                    New XElement("cell", IIf(Convert.ToString(row("TotalUnits1")) = "0", "", Convert.ToDecimal(row("TotalUnits1")).ToString("#,#"))),
                    New XElement("cell", IIf(Convert.ToString(row("FOB")) = "0", "", Convert.ToDecimal(row("FOB")).ToString("#,##0.000"))),
                    New XElement("cell", IIf(row("TotPerLine") = "0", If(row("ID") = 0, Convert.ToDecimal(row("GrandTotal")).ToString("#,##0.00"), "0"), If(row("ID") = 0, Convert.ToDecimal(row("GrandTotal")).ToString("#,##0.00"), Convert.ToDecimal(row("TotPerLine")).ToString("#,##0.00")))),
                    New XElement("cell", "<a id='NewOrderDetailType_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("Type")) + "</a>"),
                    New XElement("cell", IIf(Convert.ToString(row("gpm")) = "0", "", Convert.ToDecimal(row("gpm")).ToString("#,##0.0") + "%")),
                    New XElement("cell", IIf(row("BoxNum") = "0", "", row("BoxNum"))),
                    New XElement("cell", row("BoxCode")),
                    New XElement("cell", IIf(row("UPC") = "0", "", row("UPC"))),
                    New XElement("cell", IIf(row("UPCPRICE") = "0", "", row("UPCPRICE"))),
                    New XElement("cell", "<a id='NewOrderDetailPODflower_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("PODFlower")) + "</a>"),
                    New XElement("cell", "<a id='NewOrderDetailInvenId_" & Convert.ToString(row("ID")) & "' >" + Convert.ToString(row("InvenID")) + "</a>"),
                    New XElement("cell", "<a id='NewOrderDetailAWB_" & Convert.ToString(row("ID")) & "' >" + If(Convert.ToString(row("AWB")) = 0, If(row("ID") = 0, "", ""), If(row("AWB").ToString().Length <= 3, row("AWB"), row("AWB").ToString().Substring(If(row("AWB") = 0, 0, row("AWB").ToString().Length - 4)))) + "</a>"))))
                    '27 Mar 19 :: Muthu Nivetha M ::  On invoice show if line is a substitute :: EndsS

                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Dim idx As Integer = dt.Rows.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = "Totals"

                    Return newDoc
                Else
                    'Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, data(0).ErrorMessage, "", "Error Notification", "error")
                    'Return BuildFlexiGridError(data(0).ErrorMessage.Split("###")(15).Replace("Exception", ""))
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Return Nothing
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: GetSalesOrderDetailsList()::PageOrder")
            Return Nothing
        End Try
        Return Nothing
    End Function

    ''' <summary>
    ''' MANI ::  CREATE/UPDAING a Order
    ''' </summary>
    ''' <param name="ISNewOrder"></param>
    ''' <param name="OrderNo"></param>
    ''' <param name="Customer"></param>
    ''' <param name="ShippingDate"></param>
    ''' <param name="Carrier"></param>
    ''' <param name="Cutofftime"></param>
    ''' <param name="AWB"></param>
    ''' <param name="CustPO"></param>
    ''' <param name="CustMsg1"></param>
    ''' <param name="CustMsg2"></param>
    ''' <param name="CustMsg3"></param>
    ''' <param name="CustMsg4"></param>
    ''' <param name="CustMsg5"></param>
    ''' <param name="ShipMsg1"></param>
    ''' <param name="ShipMsg2"></param>
    ''' <param name="ShipMsg3"></param>
    ''' <param name="ShipMsg4"></param>
    ''' <param name="ShipMsg5"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CreateOrUpdateOrder(ISNewOrder As String, ByVal OrderNo As String, ByVal Customer As String,
                                    ByVal ShippingDate As String, ByVal CargoDate As String, ByVal Carrier As String, ByVal Cutofftime As String, ByVal AWB As String, ByVal WH As String,
                                    CustPO As String, ByVal SLSMAN As String, ByVal CustMsg1 As String,
                                    ByVal CustMsg2 As String, ByVal CustMsg3 As String, ByVal CustMsg4 As String, ByVal CustMsg5 As String, ByVal ShipMsg1 As String,
                                    ByVal ShipMsg2 As String, ByVal ShipMsg3 As String, ByVal ShipMsg4 As String, ByVal ShipMsg5 As String, ByVal Shipto As String, ByVal Terms As String, ByVal DroporderDetailIDsToNewOrder As String, ByVal CalledFromVET As String,
                                    ByVal ShipToName As String, ByVal ShipToAddress1 As String, ByVal ShipToAddress2 As String, ByVal ShipToCity As String, ByVal ShipToState As String, ByVal ShipToZip As String,
                                    ByVal ShipToPhone As String, ByVal ShipToFax As String, ByVal ShipToContact As String, ByVal ShipToCountry As String) As String
        Try



            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            Try
                If User.Name Is Nothing Then
                    Return "Logout"
                End If
            Catch ex As Exception
                Return "Logout"
            End Try

            'Try
            '    If Carrier = "AR" Or Carrier = "A1" Or Carrier = "A2" Or Carrier = "A3" Then

            '        Dim consignee As String = SalesOrder.GetConsigneebyCustomerandShipto(Customer, Shipto, Carrier)

            '        If Not String.IsNullOrEmpty(consignee) Then
            '            Dim dates = ArmelliniService.GetDayOfService(consignee)
            '            Dim shipDate As Date = Convert.ToDateTime(ShippingDate)
            '            If Not dates.Any(Function(c) c.shipDate.Trim() = shipDate) Then
            '                Dim datesAvailable As String = String.Join(",", dates.Select(Function(x) x.shipDate.ToString()))
            '                'check with jose
            '                'Return "Date does not exist! Available dates are " + datesAvailable
            '            End If
            '        End If
            '    ElseIf Carrier = "FB" Then
            '        'added by Pardeep on 2023-02-12
            '        Dim consignee As String = SalesOrder.GetConsigneebyCustomerandShipto(Customer, Shipto, Carrier)
            '        If Not String.IsNullOrEmpty(consignee) Then
            '            Dim shipDate As Date = Convert.ToDateTime(ShippingDate)
            '            Dim response = FloridaBeautyService.GetDayOfService(consignee, shipDate.ToString("yyyy-MM-dd"))
            '            If response.hasService Then

            '            End If
            '        End If
            '    End If



            'Catch ex As Exception
            'End Try


            Dim NextInvoiceNoFromConstant As Integer = 0

            If ISNewOrder = "1" Then
                NextInvoiceNoFromConstant = DAO.Constant.GetNextInvoiceNumFromConstant()
                OrderNo = NextInvoiceNoFromConstant
            End If

            If CalledFromVET = "1" Then
                Dim dt = VET.UpdateVET(OrderNo, Customer, ShippingDate, Carrier, Cutofftime, AWB, CustPO, SLSMAN,
                                                 CustMsg1, CustMsg2, CustMsg3, CustMsg4, CustMsg5,
                                                 ShipMsg1, ShipMsg2, ShipMsg3, ShipMsg4, ShipMsg5, Shipto, Terms,
                                                  User.Name, User.ID, WH)


            Else
                Dim dt = SalesOrder.CreateOrUpdateOrder(ISNewOrder, OrderNo, Customer, ShippingDate, CargoDate, Carrier, Cutofftime, AWB, WH, CustPO, SLSMAN,
                                                 CustMsg1, CustMsg2, CustMsg3, CustMsg4, CustMsg5,
                                                 ShipMsg1, ShipMsg2, ShipMsg3, ShipMsg4, ShipMsg5, Shipto, Terms,
                                                 DroporderDetailIDsToNewOrder, User.Name, User.ID, ShipToName, ShipToAddress1, ShipToAddress2, ShipToCity, ShipToState, ShipToZip,
                                                  ShipToPhone, ShipToFax, ShipToContact, ShipToCountry)

                If (ISNewOrder = 1) Then

                    Try
                        For Each row In dt.Rows

                            Dim subject = "Sales to a new customer or existing customer that has not been sold for more than 180 days"
                            Dim ToEmails = Convert.ToString(row("Emails"))
                            If Trim(ToEmails) <> "" Then
                                Dim Body = "Customer No: " + Convert.ToString(row("Customer")) + " " + Convert.ToString(row("CustomerName")) + " Terms :" + Convert.ToString(row("TERMSDESC")) + " Credit Limit of $" + Convert.ToString(row("arlimit")) + "###"
                                Body += "Dated for " + Convert.ToString(row("ShipDate")) + " Carrier : " + Convert.ToString(row("Carrier")) + " " + Convert.ToString(row("CarrierName")) + "###"
                                Body += "Amount $" + Convert.ToString(row("InvAmt")) + "###"
                                Body += "Previous sale to this customer " + Convert.ToString(row("LASTSALE")) + "###"
                                Dim unused = Logs.SendMail(User.Email, ToEmails, Body, "", subject)
                            End If

                        Next
                    Catch ex As Exception
                        ErrorLogs.LogException(ex, "Error In Service::CreateOrUpdateOrder::Email180days::PageOrder")
                    End Try

                End If

            End If



            Return OrderNo
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::CreateOrUpdateOrder::PageOrder")
            If (ex.Message.Contains("UNIQUE KEY constraint")) Then
                Return "Unique error"
            Else
                Return "error"
            End If
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPoqAwbByOrderDetailId(ByVal OrderDetailId As Integer) As String
        Try
            Dim result = SalesOrder.GetPoqAwbByOrderDetailId(OrderDetailId)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPoqAwbByOrderDetailId::PageSale")
            Return ""
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function LoadCargoDateForOrderUpdate(ByVal ORDER As String, ByVal CUSTOMER As String) As String
        Try

            Dim result = SalesOrder.LoadCargoDateForOrderUpdate(ORDER, CUSTOMER)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadCargoDateForOrderUpdate::PageSale")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckInvoiceHasNegativeBoxes(ByVal OrderNo As String, ByVal CustomerNo As String) As String
        Try

            Dim result = SalesOrder.CheckInvoiceHasNegativeBoxes(OrderNo, CustomerNo)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckInvoiceHasNegativeBoxes::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function UpdateCustomerAndShippingMessages(ByVal OrderNo As String, ByVal CustMsg1 As String,
                                          ByVal CustMsg2 As String, ByVal CustMsg3 As String, ByVal CustMsg4 As String, ByVal CustMsg5 As String, ByVal ShipMsg1 As String,
                                          ByVal ShipMsg2 As String, ByVal ShipMsg3 As String, ByVal ShipMsg4 As String, ByVal ShipMsg5 As String) As String
        Try


            SalesOrder.UpdateCustomerAndShippingMessages(OrderNo, CustMsg1, CustMsg2, CustMsg3, CustMsg4, CustMsg5,
                                                  ShipMsg1, ShipMsg2, ShipMsg3, ShipMsg4, ShipMsg5)
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateCustomerAndShippingMessages::PageOrder")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' MANI::17/07/2018::Void an order
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function VoidOrder(ByVal OrderNo As String, ByVal ReasonVoid As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Try
                If User.Name Is Nothing Then
                    Return "Logout"
                End If
            Catch ex As Exception
                Return "Logout"
            End Try

            Return SalesOrder.VoidOrder(OrderNo, ReasonVoid, User.Name)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::VoidOrder::PageOrder")
            Return "error"
        End Try
    End Function


    ''' <summary>
    ''' MANI::17/07/2018::Flip an order
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function FlipOrder(ByVal OrderNo As String, ByVal Customer As String, ByVal CalledFromVET As String) As String
        Try

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
            Try
                If User.Name Is Nothing Then
                    Return "Logout"
                End If
            Catch ex As Exception
                Return "Logout"
            End Try

            Dim dt As DataTable = SalesOrder.FlipOrder(OrderNo, Customer, User.Name, CalledFromVET)


            Try
                For Each row In dt.Rows
                    Dim ARLimits_Emails As String = F_Emails.GetEmailsByType("ARLIMITS")
                    Dim CustomerFromNo = Convert.ToString(row("CustomerFrom"))
                    Dim CustomerFromName = Convert.ToString(row("CustomerFromName"))
                    Dim CustomerToNo = Convert.ToString(row("CustomerTo"))
                    Dim CustomerToName = Convert.ToString(row("CustomerToName"))
                    Dim InvoiceNo = Convert.ToString(row("InvoiceNo"))
                    Dim InvoiceDate = Convert.ToString("InvoiceDate")
                    Dim subject = "Inv# " + InvoiceNo + " transferred from customer# " + CustomerFromNo + "/" + CustomerFromName +
                        " to Customer# " + CustomerToNo + "/" + CustomerToName

                    Dim ToEmails = ARLimits_Emails
                    If Trim(ToEmails) <> "" Then
                        Dim Body = "Invoice# " + InvoiceNo + " dated for " + InvoiceDate + " Customer Name :" + CustomerToName
                        Dim unused = Logs.SendMail(User.Email, ToEmails, Body, "", subject)
                    End If

                Next
            Catch ex As Exception
                ErrorLogs.LogException(ex, "Error In Service::CreateOrUpdateOrder::Email180days::PageOrder")
            End Try

            Return "success"

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::FlipOrder::PageOrder")
            Return "error"
        End Try
    End Function



    ''' <summary>
    ''' Generate and send pdf's direcly to default printers
    ''' </summary>
    ''' <param name="OrderNo"></param>
    ''' <param name="PrintInvoice"></param>
    ''' <param name="PrintPickingList"></param>
    ''' <param name="PrintShippingReport"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GenerateReportsInOrderToPrinter(ByVal OrderNo As String, ByVal PrintInvoice As String,
                                                    ByVal PrintPickingList As String,
                                                    ByVal PrintShippingReport As String,
                                                    ByVal EmailInvoice As String,
                                                    ByVal FaxInvoice As String,
                                                    ByVal ShipDate As String,
                                                    ByVal Customer As String) As String
        Try

            If OrderNo <> "undefined" Then
                Dim User As New User
                If Not Session("LoginUserDetails") Is Nothing Then
                    User = Session("LoginUserDetails")
                End If

                '  Dim taskOrginals = Task.Factory.StartNew(Function() PrintingReportInOrderRoPrinter(OrderNo, PrintInvoice, PrintPickingList, PrintShippingReport))
                Dim Wh = Warehouses.GetWarehouseDetailByWarehouse("")
                Dim FileName = ""
                Dim folderPath = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString() '+ ConfigurationManager.AppSettings("ExportFolder").ToString()
                Dim Fullpath = ""
                Dim TextFileName = ""
                Dim PrintedReports As New List(Of String)
                If PrintInvoice.ToUpper() = "Y" Or EmailInvoice.ToUpper() <> "N" Or FaxInvoice.ToUpper() <> "N" Then
                    Dim EmailAddress As String = ""
                    Dim FaxOrEmail = CustomerDetails.GetFaxOrEmailDetailsForCustomer(Customer)
                    Try


                        Dim CustDoEmail As String = ""


                        If ((FaxOrEmail = "IE" Or FaxOrEmail = "P") And PrintInvoice.ToUpper() = "Y") Or EmailInvoice.ToUpper() <> "N" Then
                            'First we have to look into if there any email address for the customer in F_CUSTDO for to statement report(DOCTYPE=S)
                            CustDoEmail = DAOCustDO.GetAddressForCustomerByDocTypeAndDelType(Customer, "I", "'E'") 'DOCTYPE=I(Invoice) And DELTYPE=E(Email)
                            Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNo(Customer)
                            If CustDoEmail.Trim() = "" Then
                                EmailAddress = If(CustomerDetail.Email.Trim() <> "", CustomerDetail.Email, "")
                            Else
                                EmailAddress = CustDoEmail
                            End If
                        End If

                        If (FaxOrEmail = "IF" And PrintInvoice.ToUpper() = "Y") Or FaxInvoice.ToUpper() <> "N" Then
                            'First we have to look into if there any email address for the customer in F_CUSTDO for to statement report(DOCTYPE=S)
                            CustDoEmail = DAOCustDO.GetAddressForCustomerByDocTypeAndDelType(Customer, "I", "'F'") 'DOCTYPE=I(Invoice) And DELTYPE=E(Fax)
                            Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNo(Customer)
                            If CustDoEmail.Trim() = "" Then
                                EmailAddress = If(CustomerDetail.Fax.Trim() <> "", CustomerDetail.Fax + "@faxage.com", "")
                            Else
                                EmailAddress = If(CustDoEmail.Trim() <> "", CustDoEmail + "@faxage.com", "")
                            End If
                        End If
                    Catch ex As Exception

                    End Try
                    ' 04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark :: Starts
                    Dim NeedToUpdateBit = False
                    NeedToUpdateBit = IIf((PrintInvoice.ToUpper() = "Y" AndAlso EmailInvoice.ToUpper() = "Y") Or PrintInvoice.ToUpper() = "Y", False, True)

                    FileName = PrintInvoiceReport(OrderNo, "Email", EmailAddress, "", "", "", ShipDate, NeedToUpdateBit)
                    ' 04 Apr 2019 :: SALES-Invoice emailed from Invoice view should not add"printed" checkmark :: Ends
                    Fullpath = folderPath + "\" + FileName

                    'SendPDFToPrinter(Fullpath, Wh.Invoice) ' Print the report on the printer
                    If PrintInvoice.ToUpper() = "Y" And FaxOrEmail = "P" Then
                        'SendPDFToPrinterPDFWithTool(Wh.Invoice, Fullpath)
                        'TextFileName = "Invoice_" + OrderNo + "_" + DateTime.Now.ToString("MMddyyyyHHmmss")
                        If FileName <> "" And FileName.Contains(".pdf") Then
                            PrintedReports.Add("Invoice")
                            'CreateTextFileforPrinter(Fullpath, Wh.Invoice, TextFileName)
                        End If
                    End If


                End If

                If PrintPickingList = "Y" Then
                    FileName = PrintPickList(OrderNo)
                    Fullpath = folderPath + "\" + FileName
                    'TextFileName = "Picking_" + OrderNo + "_" + DateTime.Now.ToString("MMddyyyyHHmmss")
                    'SendPDFToPrinter(Fullpath, Wh.Picking) ' Print the report on the printer
                    'SendPDFToPrinterPDFWithTool(Wh.Picking, Fullpath)
                    If FileName <> "" And FileName.Contains(".pdf") Then
                        PrintedReports.Add("PickList")
                        'CreateTextFileforPrinter(Fullpath, Wh.Picking, TextFileName)
                    End If
                End If

                If PrintShippingReport = "Y" Then
                    FileName = PrintShippingLabelList(OrderNo, ShipDate, "", "")
                    Fullpath = folderPath + "\" + FileName
                    TextFileName = "ShipLabel_" + OrderNo + "_" + DateTime.Now.ToString("MMddyyyyHHmmss")
                    'SendPDFToPrinter(Fullpath, Wh.ShipLabel) ' Print the report on the printer
                    'SendPDFToPrinterPDFWithTool(Wh.ShipLabel, Fullpath)
                    If FileName <> "" And FileName.Contains(".pdf") Then
                        PrintedReports.Add("Label")
                        'CreateTextFileforPrinter(Fullpath, Wh.ShipLabel, TextFileName)
                    End If
                End If

                SalesOrder.UpdateActivityLogForOrderReports(OrderNo, User.Email, User.Name, PrintedReports.ToArray(), LocalIPAddress())
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GenerateReportsInOrderToPrinter")
            Return Nothing
        End Try
        Return Nothing
    End Function

    ''' <summary>
    ''' Method to Print the report to the printer by the given printer name
    ''' </summary>
    ''' <param name="ExportedPath"></param>
    ''' <param name="PrinterName"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CreateTextFileforPrinter(ByVal ExportedPath As String, ByVal PrinterName As String, ByVal FileName As String) As String
        Try

            Dim vendorEmails As String = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()
            Dim printerfolder As String = ConfigurationManager.AppSettings("PrinterFolder").ToString()

            Dim filepath As String = vendorEmails + "\" + printerfolder + "\" + FileName + ".txt"

            If Not System.IO.Directory.Exists(vendorEmails + "\" + printerfolder) Then
                System.IO.Directory.CreateDirectory(vendorEmails + "\" + printerfolder)
            End If
            If Not System.IO.File.Exists(filepath) Then
                System.IO.File.Create(filepath).Dispose()
            End If
            Dim file As System.IO.StreamWriter
            file = My.Computer.FileSystem.OpenTextFileWriter(filepath, True)
            file.WriteLine(ExportedPath)
            file.WriteLine(PrinterName)
            file.Close()

            Return "Success"
        Catch ex As Exception
            'ErrorLogs.LogException(ex, "Error in Service::CreateTextFileforPrinter::PageOrdeSaveProcess")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckIsUnsavedOrderFortheUser(ByVal CurrentCustomer As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Try
                If User.Name Is Nothing Then
                    Return "Logout"
                End If
            Catch ex As Exception
                Return "Logout"
            End Try

            Dim result = SalesOrder.CheckIsUnsavedOrderFortheUser(User.ID, CurrentCustomer)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckIsUnsavedOrderFortheUser::PageOrder")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderUpdatePersonDetails(ByVal OrderNo As String) As String
        Try
            If OrderNo <> "" Then
                Dim result = SalesOrder.GetOrderUpdatePersonDetails(OrderNo)
                Dim personDetails = GetPersonIconDetails(result.ADDUSER, result.ADDDATE, result.ADDTIME, result.ADDAPP, result.UPDUSER, result.UPDDATE, result.UPDTIME, result.UPDAPP, result.DELUSER, result.DELDATE, result.DELTIME, result.DELAPP, result.LOCKUSER, result.LOCKDATE, result.LOCKTIME, result.LOCKAPP)
                Return personDetails
            Else
                Return ""
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderUpdatePersonDetails::PageOrder")
            Return "error"
        End Try
    End Function


    ''' <summary>
    ''' MANI::10/19/2018:Check Printed,Picking,List or Scanned set to true
    ''' </summary>
    ''' <param name="OrderNo"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CheckOrderCanModified(ByVal OrderNo As String) As String
        Try
            If OrderNo <> "" Then
                Return SalesOrder.CheckOrderCanModified(OrderNo)
            Else
                Return "1"
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckOrderCanModified::PageOrder")
            Return "error"
        End Try
    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="OrderNo"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderflagsbyOrderNo(ByVal OrderNo As String) As BO.SalesHeader
        Try
            If OrderNo <> "" Then
                Return SalesOrder.GetOrderflagsbyOrderNo(Convert.ToInt32(OrderNo))
            Else
                Return New BO.SalesHeader
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderflagsbyOrderNo::PageOrderDetails")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetConsigneebyOrderNo(ByVal OrderNo As String, ByVal ShipTo As String) As String
        Try
            If OrderNo <> "" Then
                Return SalesOrder.GetConsigneebyOrderNo(Convert.ToInt32(OrderNo), Convert.ToInt32(ShipTo))
            Else
                Return ""
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetConsigneebyOrderNo::PageOrderDetails")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function GetConsigneebyCustomerandShipto(ByVal OrderNo As String, ByVal ShipTo As String, Carrier As String) As String
        Try
            If OrderNo <> "" Then
                Return SalesOrder.GetConsigneebyCustomerandShipto(Convert.ToInt32(OrderNo), Convert.ToInt32(ShipTo), Carrier)
            Else
                Return ""
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetConsigneebyOrderNo::PageOrderDetails")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Anitha :: 29-Jan-2019 :: Get message from msg inv
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetMessagesfromMsgINV() As BO.F_MsgInv
        Try
            Return SalesOrder.GetMessagesfromMsgINV()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetMessagesfromMsgINV::PageOrder")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Anitha :: 12-Mar-2019 :: Get Order Date for given Order
    ''' </summary>
    ''' <param name="OrderNo"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderDateByrderNo(ByVal OrderNo As String) As BO.SalesHeader
        If Integer.TryParse(OrderNo, 0) Then
            Return SalesOrder.GetOrderDateByrderNo(OrderNo)
        Else
            Return Nothing
        End If
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSaleDiscount(ByVal discountCode As String, ByVal customerNo As String, ByVal orderNo As String) As String
        Try
            Return SalesOrder.GetDiscountAmount(discountCode, customerNo, orderNo)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSaleDiscount::PageAddedItMisc")
            Return 0
        End Try
    End Function

#End Region

#Region "Terms"


    ''' <summary>
    ''' MANI ::  Get the list of terms 
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetTermsForDropdown() As List(Of BO.Terms)
        Try
            Return DAO.Terms.GetTermsForDropdown()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTermsForDropdown")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetTermsDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Terms
            Dim data As List(Of BO.Terms) = obj.GetTermsDetailsForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Code", "TermsDesc", "CreditCard", "COD"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("TermsDesc").ColumnName = "Terms Description"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "TermsDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<b><a href='#' id='DeleteCreditTerms_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<b><a href='#' id='EditCreditTerms_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.Code),
                                        New XElement("cell", row.TermsDesc),
                                        New XElement("cell", row.CreditCard),
                                        New XElement("cell", row.COD)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTermsDetailsForFgrd::PageCreditTerms")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditTermsDetailByID(ByVal ID As Integer) As List(Of BO.Terms)
        Try
            Dim data As List(Of BO.Terms) = DAO.Terms.GetCreditTermsDetailByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditTermsDetailByID::PageCreditTerms")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCreditTerms(ByVal ID As String, ByVal CreditTermsCode As String, ByVal CreditTermsDesc As String, ByVal COD As String, ByVal CreditCard As String,
    ByVal Days As Integer, ByVal Discount As Decimal, ByVal DDays As Integer) As String
        Try
            Dim CreditTermsID As String = ""

            If (ID = "0") Then
                CreditTermsID = DAO.Terms.InsertCreditTerms(CreditTermsCode, CreditTermsDesc, COD, CreditCard, Days, Discount, DDays)
            Else

                DAO.Terms.UpdateCreditTerms(ID, CreditTermsCode, CreditTermsDesc, COD, CreditCard, Days, Discount, DDays)
                CreditTermsID = Convert.ToInt32(ID)
            End If
            If (Not CreditTermsCode.Contains("UNIQUE KEY constraint")) Then
                Return CreditTermsID
            Else
                Return CreditTermsID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCreditTerms::PageCreditTerms")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCreditTermsbyID(ByVal ID As String) As String
        Try
            Return DAO.Terms.DeleteCreditTermsbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCreditTermsbyID::PageCreditTerms")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Shipto"


    ''' <summary>
    ''' MANI ::  Get the list of shipto for the customer 
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetShiptoForDropdownByCustomer(ByVal Customer As String) As List(Of ShipTo)
        Try
            Return ShipTos.GetShiptoForDropdownByCustomer(Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetShiptoForDropdownByCustomer")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' GABRIEL : 04/11/2023:  Get the shipto for the customer 
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetShiptoByCustomer(ByVal Customer As String) As ShipTo
        Try
            Return ShipTos.GetShiptoByCustomer(Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetShiptoByCustomer")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetShiptoDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CustomerDetail), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New ShipTos

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of ShipTo) = obj.GetShiptoListForFgrd(Customer)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Invoice", "RecDate", "PO", "ShiptoName", "AWB", "Carrier", "WH", "Charges", "Payments", "Credits", "Adjustment", "Balance", "AccumulatedBalance"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'dt.Columns("Customer").ColumnName = "CUST#"
                'dt.Columns("Purchaser").ColumnName = "Buyer"
                'dt.Columns("ARBalance").ColumnName = "Balance"
                'dt.Columns("SalesmanName").ColumnName = "SalesPerson"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "ARINVS$ARINVS")
                Return BuildXmlDoc(filepath)
            Else

                Dim data As List(Of ShipTo) = obj.GetShiptoListForFgrd(Customer)

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                New XElement("rows", New XElement("page", page.ToString()),
                                New XElement("total", obj.TotalRows.ToString()),
                                data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID.ToString()),
                                New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteShipto_" & row.ID.ToString() & "'/>"),
                                New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditShipto_" & row.ID.ToString() & "'/>"),
                                New XElement("cell", row.Shipto),
                                New XElement("cell", row.Name),
                                New XElement("cell", row.ADDRESS1),
                                New XElement("cell", row.CITY),
                                New XElement("cell", row.STATE),
                                New XElement("cell", row.PHONE),
                                New XElement("cell", row.Comment)))))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetShiptoDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveShiptoDetails(ByVal ID As String, ByVal Shipto As String, ByVal ShiptoName As String, ByVal Address1 As String, ByVal Address2 As String, ByVal City As String, ByVal State As String, ByVal Zip As String, ByVal Country As String, ByVal Phone As String, ByVal Fax As String, ByVal Contact As String, ByVal Calls As String, ByVal CallTime As String, ByVal Caller As String, ByVal Carrier As String, ByVal Comment As String, ByVal Customer As String, ByVal Route As String) As String
        Try
            Dim result As String = ""
            result = ShipTos.SaveShiptoDetails(ID, Shipto, ShiptoName, Address1, Address2, City, State, Zip, Country, Phone, Fax, Contact, Calls, CallTime, Caller, Carrier, Comment, Customer, Route)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveShiptoDetails::PageShipto")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetShiptoDetailsByID(ByVal ID As String) As List(Of ShipTo)
        Try
            Return ShipTos.GetShiptoDetailsByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetShiptoDetailsByID::PageShipto")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteShiptoDetails(ByVal ID As String) As String
        Try
            Return ShipTos.DeleteShiptoDetails(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteShiptoDetails::PageShipto")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetNextShiptoValue(ByVal Customer As String) As Integer
        Try
            Return Convert.ToInt32(ShipTos.GetNextShiptoValue(Customer))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNextShiptoValue::PageShipto")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function isExistShipToForCustomer(ByVal Customer As String, ByVal ShipTo As String, ByVal ShipToId As String) As Integer
        Try
            Return Convert.ToInt32(ShipTos.isExistShipToForCustomer(Customer, ShipTo, ShipToId))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::isExistShipToForCustomer::PageShipto")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerNameForShipto(ByVal Customer As String) As String
        Try
            Return ShipTos.GetCustomerNameForShipto(Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustomerNameForShipto::PageShipto")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Posting Payments"
    <System.Web.Services.WebMethod(True)>
    Public Function PostingPaymentsToAdjustment(ByVal xAmount As Decimal, ByVal xCust As Integer, ByVal xInvoice As String, ByVal xDate As String, ByVal xInvAmount As String, ByVal xReason As String, ByVal xGL As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim PostingResult = Payments.wtrcust(xAmount, xCust)
            Dim nBalancetoApply As Decimal = 0.0
            Dim xInvoiceSplit = xInvoice.Split(",")
            Dim xInvAmountSplit = xInvAmount.Split(",")
            Dim ntotaltoapply As Decimal = 0.0
            Dim obj As New ARChecks()

            nBalancetoApply = xAmount
            For i = 0 To xInvoiceSplit.Length - 1

                'If xAmount >= xInvAmountSplit(i) Then
                '    ntotaltoapply = xInvAmountSplit(i)
                'Else
                '    ntotaltoapply = xAmount
                'End If
                'xAmount -= ntotaltoapply

                'If i = xInvoiceSplit.Length - 1 And xAmount > 0 Then
                '    ntotaltoapply = ntotaltoapply + xAmount
                'End If
                ''Dim ARINVDateList = SalesOrder.GetOrderDateByrderNo(xInvoiceSplit(i))

                ntotaltoapply = xInvAmountSplit(i)
                If ntotaltoapply = 0 Then
                    ntotaltoapply = xAmount
                End If
                nBalancetoApply = nBalancetoApply - ntotaltoapply


                Payments.WRTAR(xInvoiceSplit(i), xDate, "3", 0, ntotaltoapply, xCust, 0.0, 0, "", User.Name, xReason)
                Payments.wtradjust(xInvoiceSplit(i), xDate, ntotaltoapply, xCust, xReason, xGL, User.Name)
                Payments.wtreodcash(ntotaltoapply, "TOTALADJ")


                If nBalancetoApply <= 0 Then
                    Exit For
                End If
            Next

            Return PostingResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PostingPaymentsToAdjustment")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetDepositHeaderList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal FromDate As String, ByVal ToDate As String, ByVal IsActive As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(Payment), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New CASH
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Payment) = Payments.GetDepositListByDate(FromDate, ToDate, IsActive)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"DEPOSIT", "DepositDate", "BANK", "AMOUNT", "ISACTIVE", "ISLOCKED", "LOCKEDUSERID"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "DepositDetails$PostPayments")
                Return BuildXmlDoc(filepath)

            Else
                Dim data As List(Of Payment) = Payments.GetDepositListByDate(FromDate, ToDate, IsActive)
                If data Is Nothing Then
                    Return Nothing
                ElseIf (data.Count > 0) Then
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", data.Count.ToString()),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", If(row.Deposit = 0, "0", IIf(row.Islocked, "1", "0") + "_" + row.Deposit.ToString() + "_" + Convert.ToDateTime(row.DepositDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM-dd-yy") + "_" + row.Bank)), New XAttribute("style", ""),
                        New XElement("cell", IIf(row.IsActive = True, IIf(row.DepositLockContent Is Nothing, "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='deleteDepositHeader_" + If(row.Islocked, "1", "0") + "_" + row.Deposit.ToString() + "_" + row.DepositDate.Replace("/", "-") + "_" + row.Bank + "'/>", ""), "")),
                        New XElement("cell", IIf(row.IsActive = True, IIf(row.DepositLockContent Is Nothing, "<img href='#' src='images/Edit.png' style='cursor:pointer' id='editDepositHeader_" + If(row.Islocked, "1", "0") + "_" + row.Deposit.ToString() + "_" + row.DepositDate.Replace("/", "-") + "_" + row.Bank + "'/>", ""), "")),
                        New XElement("cell", "<span data-depositdate=" + row.DepositDate + " >" + row.DepositDate + "</span>"),
                        New XElement("cell", row.Deposit),
                        New XElement("cell", row.Amount.ToString("#,##0.00")),
                        New XElement("cell", row.Bank),
                        New XElement("cell", "<img style='Cursor:pointer;' id='imgDepositLock_" + IIf(row.Islocked, "1", "0") + "_" + row.Deposit.ToString() + "_" + row.DepositDate.Replace("/", "-") + "_" + row.Bank + "' src='" & IIf(row.Islocked, "images/locked.png", "images/unlocked.png") & "' />"),
                        New XElement("cell", "<img style='Cursor:pointer;' title='Export To Excel' id='imgExportAllDepositData_" + IIf(row.Islocked, "1", "0") + "_" + row.Deposit.ToString() + "_" + row.DepositDate.Replace("/", "-") + "_" + row.Bank + "' src='images/Excel.png' />"),
                        New XElement("cell", "<img style='Cursor:pointer;' title='Export To PDF' id='imgExportAllDepositPDFData_" + IIf(row.Islocked, "1", "0") + "_" + row.Deposit.ToString() + "_" + row.DepositDate.Replace("/", "-") + "_" + row.Bank + "' width='15' src='images/PDFicon.png' />"),
                        New XElement("cell", IIf(row.IsActive = True, "<img href='#' src='images/Print.png' style='cursor:pointer' id='printDepositHeader_" + If(row.Islocked, "1", "0") + "_" + row.Deposit.ToString() + "_" + row.DepositDate.Replace("/", "-") + "_" + row.Bank + "'/>", "")),
                        New XElement("cell", row.DepositLockContent)))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = data.LastOrDefault().Amount '' Modified by Anubhuti on 29/12/2022
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    Return newDoc
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", data.Count)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDepositHeaderList")
            Return Nothing
        End Try
    End Function
    'Added by Anubhuti On 25/12/2022
    <System.Web.Services.WebMethod(True)>
    Public Function UpdateDepositDate(ByVal Deposit As String, ByVal DepositDate As String, ByVal Bank As String) As String
        Try
            Dim User As New User
            If Not Session("UserDetails") Is Nothing Then
                User = Session("UserDetails")
            End If
            Return Payments.UpdateDepositDate(Deposit, DepositDate, Bank)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::UpdateDepositDate")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetDepositDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal FilterQuery As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(Payment), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Payment) = Payments.GetDepositDetailsList(FilterQuery)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"CHECK", "AMOUNT", "TYPE"}
                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "DepositDetails$PostPayments")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of Payment) = Payments.GetDepositDetailsList(FilterQuery)
                If data Is Nothing Then
                    Return Nothing
                ElseIf (data.Count > 0) Then
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", data.Count.ToString()),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", If(row.Deposit = 0, "0", row.Deposit.ToString() + "_" + row.Check.ToString() + "_" + row.Customer.ToString())), New XAttribute("style", ""),
                        New XElement("cell", row.Customer),
                        New XElement("cell", row.CustName),
                        New XElement("cell", row.Check),
                        New XElement("cell", row.Amount.ToString("#,##0.00")),
                        New XElement("cell", row.Type)))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = "Total"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    Return newDoc
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", data.Count)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDepositDetailsList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCheckDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal FilterQuery As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(Payments), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Payment) = Payments.GetCheckDetailsList(FilterQuery)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"CUSTOMER", "CUSTNAME", "INVOICE", "PO", "AMOUNT", "GL", "CTA"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "DepositDetails$PostPayments")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of Payment) = Payments.GetCheckDetailsList(FilterQuery)
                If data Is Nothing Then
                    Return Nothing
                ElseIf (data.Count > 0) Then
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", data.Count.ToString()),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", If(row.Check = 0 And row.Customer = 0, "0", row.Check.ToString() + "_" + row.Customer.ToString() + "_" + row.Invoice.ToString())), New XAttribute("style", ""),
                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='imgDeleteDetails_" + row.DetailID.ToString() + "_CashOrCheck" + "'/>"),
                        New XElement("cell", row.Invoice),
                        New XElement("cell", row.PO),
                        New XElement("cell", row.Amount.ToString("#,##0.00")),
                        New XElement("cell", row.GL),
                        New XElement("cell", "<img style='cursor:pointer'  title='" + GetPersonIconDetails(row.ADDUSER, Convert.ToDateTime(row.ADDDATE).ToString("MM/dd/yyyy"), row.ADDTIME, row.ADDAPP, row.UPDUSER, Convert.ToDateTime(row.UPDDATE).ToString("MM/dd/yyyy"), row.UPDTIME, row.UPDAPP, row.DELUSER, Convert.ToDateTime(row.DELDATE).ToString("MM/dd/yyyy"), row.DELTIME, row.DELAPP, row.LOCKUSER, Convert.ToDateTime(row.LOCKDATE).ToString("MM/dd/yyyy"), row.LOCKTIME, row.LOCKAPP) + "'   id='imgaddeditDetails_" + row.DetailID.ToString() + "'   src='images/Edit_user.png' />")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = "Total"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = data.LastOrDefault().Amount '' Modified by Anubhuti on 27/12/2022
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    Return newDoc
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", data.Count)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCheckDetailsList")
            Return Nothing
        End Try
    End Function
    <System.Web.Services.WebMethod(True)>
    Public Function DeletePaymentsDetailByID(ByVal DetailID As String, ByVal PaymentType As String) As String
        Try
            Dim DeleteStatus As String = ""

            Session("IsFromDeleteDeposit") = True '21 Mar 19 :: Muthu Nivetha M :: Post to an open invoice that has been set to scanned, same day.

            If PaymentType = "CreditCard" Then

            Else
                Dim DepositCheckDetailsList = Payments.GetCheckDetailsList(" ca.ID=" + DetailID)
                DeleteStatus = SavePostPaymentsInvoice(PaymentType, DepositCheckDetailsList(0).Invoice, DepositCheckDetailsList(0).Customer, DepositCheckDetailsList(0).PO, Convert.ToDecimal(DepositCheckDetailsList(0).Amount) * -1, DepositCheckDetailsList(0).Discount, DepositCheckDetailsList(0).Check, DepositCheckDetailsList(0).DepositDate, DepositCheckDetailsList(0).Bank, DepositCheckDetailsList(0).Deposit, DepositCheckDetailsList(0).Type, "", DepositCheckDetailsList(0).GL)
                Session("IsFromDeleteDeposit") = False '21 Mar 19 :: Muthu Nivetha M :: Post to an open invoice that has been set to scanned, same day.
            End If
            Session("IsFromDeleteDeposit") = False '21 Mar 19 :: Muthu Nivetha M :: Post to an open invoice that has been set to scanned, same day.
            Return DeleteStatus
        Catch ex As Exception
            Session("IsFromDeleteDeposit") = False '21 Mar 19 :: Muthu Nivetha M :: Post to an open invoice that has been set to scanned, same day.
            ErrorLogs.LogException(ex, "Error in Service::DeleteDepositHeaderWithDetailsByID::PagePostPayments")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function ImportDepositsFromCash() As String
        Try
            Dim importResult = Payments.ImportDepositsFromCash()
            Return importResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ImportDepositsFromCash")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckAndChangeDepositLockStatusForUser(ByVal IsLocked As String, ByVal Deposit As String, ByVal [Date] As String, ByVal Bank As String) As String
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If

            If UserDetails Is Nothing Then
                Return "Logout"
            End If
            Return Payments.ChangeDepositLockStatusForUser(IsLocked, Deposit, [Date], Bank, UserDetails.ID.ToString())

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckAndChangeDepositLockStatusForUser::PagePostPayments")
            Return "error"
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetIsDepositDelete() As String
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If

            Dim DepositResult As String = "Valid"
            Return DepositResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetIsDepositDelete::PagePostPayments")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteDepositHeaderWithDetailsByID(ByVal Deposit As String, ByVal [Date] As String, ByVal Bank As String) As String
        Try
            Dim DepositHeader As String = Payments.DeleteDepositHeaderWithDetailsById(Deposit, [Date], Bank)
            Return DepositHeader
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteDepositHeaderWithDetailsByID::PagePostPayments")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetNextDepositNum() As Integer
        Try
            Return Payments.GetNextDepositNum()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNextDepositNum::PagePostPayments")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveNewDeposit(ByVal Deposit As Integer, ByVal [Date] As String, ByVal Amount As Decimal, ByVal Bank As String) As String
        Try
            Dim checkResult As String = ""
            checkResult = Payments.CheckSameDepositAndDiffBank(Deposit, Bank)
            If (checkResult = "success") Then
                Return Payments.SaveNewDeposit(Deposit, [Date], Amount, Bank)
            Else
                Return checkResult
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveNewDeposit::PagePostPayments")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportExcelDepositDetails(ByVal Deposit As Integer, ByVal [Date] As String, ByVal Bank As String) As String
        Try

            Dim dt1 As DataTable
            dt1 = Payments.ExportExcelDepositDetails(Deposit, [Date], Bank)
            Dim selectedColumns As String() =
                    {"DEPOSIT", "BANK", "DATE", "CUSTOMER", "CUSTNAME", "CHECK", "INVOICE", "PO", "AMOUNT", "TYPE", "GL", "CTA"}
            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            dt.Columns("DEPOSIT").ColumnName = "DEPOSIT #"
            dt.Columns("CUSTOMER").ColumnName = "CUST #"

            'dt.Rows.RemoveAt(dt.Rows.Count- 1)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "DepositDetails$PostPayments")
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportExcelDepositDetails::PagePostPayments")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ExportPDFDepositDetails(ByVal Deposit As Integer, ByVal [Date] As String, ByVal Bank As String, ByVal FileFormat As String) As String
        Try

            Dim dt1 As DataTable
            dt1 = Payments.ExportExcelDepositDetails(Deposit, [Date], Bank)
            Dim selectedColumns As String() =
                    {"DEPOSIT", "BANK", "DATE", "CUSTOMER", "CUSTNAME", "CHECK", "INVOICE", "PO", "AMOUNT", "TYPE", "GL", "CTA"}
            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            dt.Columns("DEPOSIT").ColumnName = "DEPOSIT #"
            dt.Columns("CUSTOMER").ColumnName = "CUST #"

            'dt.Rows.RemoveAt(dt.Rows.Count- 1)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "DepositDetails$PostPayments", FileFormat)
            Return filepath
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ExportExcelDepositDetails::PagePostPayments")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPersonIconDetails(ByVal ADDUSER As String, ByVal ADDDATE As String, ByVal ADDTIME As String, ByVal ADDAPP As String, ByVal UPDUSER As String, ByVal UPDDATE As String, ByVal UPDTIME As String, ByVal UPDAPP As String, ByVal DELUSER As String, ByVal DELDATE As String, ByVal DELTIME As String, ByVal DELAPP As String, ByVal LOCKUSER As String, ByVal LOCKDATE As String, ByVal LOCKTIME As String, ByVal LOCKAPP As String) As String
        Try
            ' Dim data = SPORD.GetSPORDUserDetails(SpordID)
            Dim HeadList As New List(Of String) From {"ADD BY", "ADD DATE", "ADD TIME", "ADD APP", "UPD BY", "UPD DATE", "UPD TIME", "UPD APP", "LOCK BY", "LOCK DATE", "LOCK TIME", "LOCK APP"}
            Dim KeyList As New List(Of String) From {ADDUSER, ADDDATE, ADDTIME, ADDAPP, UPDUSER, UPDDATE, UPDTIME, UPDAPP, LOCKUSER, LOCKDATE, LOCKTIME, LOCKAPP}
            Dim str As String = "<table>"
            For j = 0 To KeyList.Count - 1
                'For Each i In data
                'Dim s As String = DirectCast(i(KeyList(j)), String)
                If (HeadList(j) = "ADD BY" Or HeadList(j) = "UPD BY" Or HeadList(j) = "DEL BY" Or HeadList(j) = "LOCK BY") And KeyList(j) = "" Then
                    j += 3
                Else
                    str += "<tr> <td style=color:white;padding-right:20px;padding-bottom:2px;>" + HeadList(j) + "</td> <td style=background:white;width:110px;>" + KeyList(j) + "</td> </tr>"
                End If


                'Next
            Next
            str += "</table>"

            Return str
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetPersonIconDetails")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function CheckAndGetInvoiceDetails(ByVal xInvoice As Integer, ByVal xDate As String, ByVal xCustomer As String) As List(Of Payment)
        Try
            Return Payments.CheckAndGetInvoiceDetails(xInvoice, xDate, Convert.ToInt32(xCustomer))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetNextDepositNum::PagePostPayments")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetDiscountForCustomer(ByVal xInvDate As String, ByVal xCustomer As Integer, ByVal xDate As String) As Decimal
        Try

            'Dim tempxInvDate As DateTime = DateTime.ParseExact(xInvDate, "dd/MM/yy", CultureInfo.InvariantCulture)
            'Dim tempxDate As DateTime = DateTime.ParseExact(xDate, "dd/MM/yy", CultureInfo.InvariantCulture)

            'Dim xInvDate As DateTime = DateTime.ParseExact(tempxInvDate.ToString("dd/MM/yyyy"), "dd/MM/yyyy", CultureInfo.InvariantCulture)

            Return Payments.GetDiscountForCustomer(xInvDate, xCustomer, xDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDiscountForCustomer::PagePostPayments")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SavePostPaymentsInvoice(ByVal PaymentType As String, ByVal xInvoice As Integer, ByVal xCustomer As Integer, ByVal xPO As String, ByVal xAmount As Decimal, ByVal xDiscount As Decimal, ByVal xCheck As Integer, ByVal xDate As String, ByVal xBank As String, ByVal xDeposit As Integer, ByVal CardType As String, ByVal Approval As String, ByVal GL As String) As String
        Try
            '21 Mar 19 :: Muthu Nivetha M :: Post to an open invoice that has been set to scanned, same day. :: Starts
            Dim IsFromDeleteDeposit As Boolean
            Dim xType As String = ""
            IsFromDeleteDeposit = Session("IsFromDeleteDeposit")
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If
            If IsFromDeleteDeposit Then
                xDate = Convert.ToDateTime(xDate.ToString()).ToString("yyyy-MM-dd")
            Else
                xDate = Convert.ToDateTime(Convert.ToString(xDate), New System.Globalization.CultureInfo("en-US", True)).ToString("yyyy-MM-dd")
            End If
            '21 Mar 19 :: Muthu Nivetha M :: Post to an open invoice that has been set to scanned, same day. :: Ends

            If PaymentType = "CreditCard" Then
                Payments.WRTAR(xInvoice, xDate, "9", xCheck, xAmount, xCustomer, xDiscount, xDeposit, "", UserDetails.Name)
                If xDiscount <> 0.0 Then
                    Payments.WRTAR(xInvoice, xDate, "3", xCheck, xDiscount, xCustomer, 0.0, xDeposit, "", UserDetails.Name)
                    Payments.wtradjust(xInvoice, xDate, xDiscount, xCustomer, "", GL, UserDetails.Name)
                End If
                ARCARD.SaveNewCreditCardDetails(xCustomer, xInvoice, xAmount, CardType, xDate, Approval, xBank)
                'Payments.wtradjust(xInvoice, xDate, xDiscount, xCustomer, "", "", UserDetails.Name)
            Else
                'If xCheck = 0 Then
                '    xType = "3"
                'Else
                '    xType = "2"
                'End If

                'for payments type=2
                Payments.WRTAR(xInvoice, xDate, "2", xCheck, xAmount, xCustomer, xDiscount, xDeposit, "", UserDetails.Name)
                If xDiscount <> 0.0 Then
                    'for adjustments type=3
                    Payments.WRTAR(xInvoice, xDate, "3", xCheck, xDiscount, xCustomer, 0.0, xDeposit, "", UserDetails.Name)
                    Payments.wtradjust(xInvoice, xDate, xDiscount, xCustomer, "", GL, UserDetails.Name)
                End If
                Payments.wtrcash(xInvoice, xDate, "2", xCheck, xAmount, xCustomer, xDeposit, xBank, "")
                Payments.wtrdepositheader(xAmount, xDeposit, xBank)
                'Payments.wtradjust(xInvoice, xDate, xDiscount, xCustomer, "", "", UserDetails.Name)
            End If
            Return "success"

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SavePostPaymentsInvoice::PagePostPayments")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCustomerListForPostPayments(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal Customer As String, ByVal lParentchecked As Integer, ByVal IsPaymentsWithZeroBalance As String, ByVal IsByViewOpen As Boolean, ByVal viewDate As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CustomerDetail), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Payment) = Payments.GetCustomerListForPostPayments(Customer, Convert.ToBoolean(lParentchecked), IsPaymentsWithZeroBalance, IsByViewOpen, viewDate)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"Invoice", "RecDate", "PO", "ShiptoName", "AWB", "Carrier", "WH", "Charges", "Payments", "Credits", "Adjustment", "Balance", "AccumulatedBalance"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                'dt.Columns("Customer").ColumnName = "CUST#"
                'dt.Columns("Purchaser").ColumnName = "Buyer"
                'dt.Columns("ARBalance").ColumnName = "Balance"
                'dt.Columns("SalesmanName").ColumnName = "SalesPerson"
                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "PostPay$PostPay")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of Payment) = Payments.GetCustomerListForPostPayments(Customer, Convert.ToBoolean(lParentchecked), IsPaymentsWithZeroBalance, IsByViewOpen, viewDate)
                If data Is Nothing Then
                    Return Nothing
                ElseIf (data.Count - 1 > 0) Then
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", data.Count),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.Invoice.ToString()),
                                        New XElement("cell", row.Customer.ToString()),
                                        New XElement("cell", row.CustName),
                                        New XElement("cell", String.Format("<input type='image' name='' style='Cursor:pointer;margin-top:-3px' id='ARINVPayselect_" & row.Invoice.ToString() & "' src='" & IIf(row.ARINVSelected, "images/check-on.png", "images/check-off.png") & "' />")),
                                        New XElement("cell", IIf(row.PO = "UnApplied", row.Invoice.ToString(), "<a style='cursor:pointer;text-decoration:underline;' id='aVetInvoice_" + row.Invoice.ToString() + "$" + Customer.ToString() + "$" + row.RecDate + "'>" + row.Invoice.ToString() + "</a>")),
                                        New XElement("cell", "<a id='aOrderDate_" + row.Invoice.ToString() + "' style='text-decoration:underline;cursor:pointer;' data-recdate=" + Convert.ToDateTime(row.RecDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM/dd/yyyy") + " >" + Convert.ToDateTime(row.RecDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM/dd/yy") + "</a>"),
                                        New XElement("cell", row.PO),
                                        New XElement("cell", "<a title='" + row.Shipto + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoName) + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoAddress1) + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoAddress2) + "<br/>" + ReplaceSingleQutoesInString(row.ShiptoCity) + "," + ReplaceSingleQutoesInString(row.ShiptoState) + "<br/>" + row.ShiptoZip + "'>" + ReplaceSingleQutoesInString(row.ShiptoName) + "</a>"),
                                        New XElement("cell", row.AWB),
                                        New XElement("cell", If(row.Carrier <> "A1" And row.Carrier <> "A2 " And row.Carrier <> "A3" And row.Carrier <> "AR", row.Carrier, "<span><a href='#' id='lnkCarrierARXML_" + row.Invoice.ToString() + "'>" + row.Carrier + "</span>")),
                                        New XElement("cell", row.WH),
                                        New XElement("cell", row.Charges.ToString("#,##0.00")),
                                        New XElement("cell", row.Payments.ToString("#,##0.00")),
                                        New XElement("cell", row.Credits.ToString("#,##0.00")),
                                        New XElement("cell", row.Adjustment.ToString("#,##0.00")),
                                        New XElement("cell", If(row.Invoice = 0, row.Balance.ToString("#,##0.00"), "<a id='aPaymentsBalance_" + row.Invoice.ToString() + "' style='text-decoration:underline;cursor:pointer;'>" + row.Balance.ToString("#,##0.00") + "</a>")),
                                        New XElement("cell", If(row.Invoice = 0, row.Balance.ToString("#,##0.00"), "<a id='aPaymentsBalance_" + row.Invoice.ToString() + "' style='text-decoration:underline;cursor:pointer;'>" + row.Balance.ToString("#,##0.00") + "</a>")),
                                        New XElement("cell", Convert.ToDateTime(row.InvDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM/dd/yy"))))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1

                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(8).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(11).InnerText = ""

                    Return newDoc
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", data.Count)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetARINVSDetailsForCustomer")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckAndGetPODetails(ByVal xPO As String, ByVal xDate As String) As List(Of Payment)
        Try
            Return Payments.CheckAndGetPODetails(xPO, xDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckAndGetPODetails::PagePostPayments")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function PrintPostPaymentsDepositReports(ByVal ExportedPath As String) As String
        Try
            Dim psi As New ProcessStartInfo
            Dim print As New PrinterSettings

            psi.UseShellExecute = True

            psi.Verb = "print"


            psi.WindowStyle = ProcessWindowStyle.Hidden
            psi.CreateNoWindow = True

            psi.Arguments = print.PrinterName ' Here specify printer name
            Dim e As New Exception
            ErrorLogs.LogException(e, "name:" + print.PrinterName)
            psi.FileName = HttpUtility.UrlDecode(ExportedPath, System.Text.Encoding.Default) ' Here specify a document to be printed

            Process.Start(psi)
            Return "Success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::PrintPostPaymentsDepositReports::PagePostPayments")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCSVFilesToTemp(ByVal HeaderFileName As String, fileType As String) As Payment
        Try
            Return Payments.SaveCSVFilesToTemp(HeaderFileName, fileType)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveHeaderFiles::PageManualPO")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ApplyPaymentsForPostAFile(ByVal Deposit As String, ByVal DepositDate As String, ByVal Bank As String, ByVal Amount As String, ByVal Check As String) As String
        Try
            Return Payments.ApplyPaymentsForPostAFile(Deposit, DepositDate, Bank, Amount, Check)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveHeaderFiles::PageManualPO")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ShowEODCASHDetails() As BO.EODCASH
        Try
            Return DAO.EODCASH.GetEODCASHDetails()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ShowEODCASHDetails::PageAccounts")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' Load Credit card details in grid :: Created by Abinaya :: 17Aug2018 
    ''' </summary>
    ''' <param name="page"></param>
    ''' <param name="rp"></param>
    ''' <param name="sortname"></param>
    ''' <param name="sortorder"></param>
    ''' <param name="query"></param>
    ''' <param name="qtype"></param>
    ''' <param name="ExportCSV"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="IsActive"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCreditCardHeaderList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal FromDate As String, ByVal ToDate As String, ByVal IsActive As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(F_ARCARD), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of F_ARCARD) = ARCARD.GetCreditCardListByDate(FromDate, ToDate, IsActive)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() =
                    {"CreditCardType", "CreditCardDate", "BANK", "AMOUNT"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "CreditCardDetails$PostPayments")
                Return BuildXmlDoc(filepath)

            Else
                Dim data As List(Of F_ARCARD) = ARCARD.GetCreditCardListByDate(FromDate, ToDate, IsActive)
                If data Is Nothing Then
                    Return Nothing
                ElseIf (data.Count > 0) Then
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", data.Count.ToString()),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", If(row.CreditCardType.ToString() = "0", "0", row.CreditCardType.ToString() + "_" + row.CreditCardDate.Replace("/", "-") + "_" + row.Bank)), New XAttribute("style", ""),
                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='deleteCreditCardHeader_" + row.CreditCardType.ToString() + "_" + row.CreditCardDate.Replace("/", "-") + "_" + row.Bank + "'/>"),
                        New XElement("cell", "<span data-CreditCarddate=" + Convert.ToDateTime(row.CreditCardDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM/dd/yyyy") + " >" + Convert.ToDateTime(row.CreditCardDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM/dd/yy") + "</span>"),
                        New XElement("cell", row.CreditCardType),
                        New XElement("cell", row.TotalAmount.ToString("#,##0.00")),
                        New XElement("cell", row.Bank),
                        New XElement("cell", "<img style='Cursor:pointer;' title='Export To Excel' id='imgExportAllCreditCardData_" + row.CreditCardType.ToString() + "_" + row.CreditCardDate.Replace("/", "-") + "_" + row.Bank + "' src='images/Excel.png' />"),
                        New XElement("cell", "<img href='#' src='images/Print.png' style='cursor:pointer' id='printCreditCardHeader_" + row.CreditCardType.ToString() + "_" + row.CreditCardDate.Replace("/", "-") + "_" + row.Bank + "'/>")))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(2).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(4).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(5).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(6).InnerText = ""
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(7).InnerText = ""
                    Return newDoc
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", data.Count)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditCardHeaderList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetIsCreditCardDelete() As String
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If

            Dim DepositResult As String = "Valid"
            Return DepositResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetIsDepositDelete::PagePostPayments")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCreditCardHeaderWithDetailsByID(ByVal CardType As String, ByVal [Date] As String, ByVal Bank As String) As String
        Try
            Dim DepositHeader As String = Payments.DeleteCreditHeaderWithDetailsById(CardType, [Date], Bank)
            Return DepositHeader
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCreditCardHeaderWithDetailsByID::PagePostPayments")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCreditCardDetailsListByCustomer(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal FilterQuery As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(F_ARCARD), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Payment) = Payments.GetDepositDetailsList(FilterQuery)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"CHECK", "AMOUNT", "TYPE"}
                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "DepositDetails$PostPayments")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of F_ARCARD) = ARCARD.GetCreditCardDetailsListByCustomer(FilterQuery)
                If data Is Nothing Then
                    Return Nothing
                ElseIf (data.Count > 0) Then
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", data.Count.ToString()),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", If(row.CreditCardType = "0", "0", row.CreditCardType + "_" + row.Customer.ToString() + "_" + row.ApprovalCode)), New XAttribute("style", ""),
                        New XElement("cell", row.Customer),
                        New XElement("cell", row.CustName),
                        New XElement("cell", row.TotalAmount.ToString("#,##0.00")),
                        New XElement("cell", row.ApprovalCode)))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    Return newDoc
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", data.Count)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditCardDetailsList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCreditCardDetailsListByInvoice(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal FilterQuery As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(F_ARCARD), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim data As List(Of Payment) = Payments.GetDepositDetailsList(FilterQuery)

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"CHECK", "AMOUNT", "TYPE"}
                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "DepositDetails$PostPayments")
                Return BuildXmlDoc(filepath)
            Else
                Dim data As List(Of F_ARCARD) = ARCARD.GetCreditCardDetailsListByInvoice(FilterQuery)
                If data Is Nothing Then
                    Return Nothing
                ElseIf (data.Count > 0) Then
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                        New XElement("rows", New XElement("page", page.ToString()),
                        New XElement("total", data.Count.ToString()),
                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.CreditCardID), New XAttribute("style", ""),
                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='deleteCreditCardDetailsByInvoice_" + row.CreditCardID.ToString() + "'/>"),
                        New XElement("cell", row.Invoice),
                        New XElement("cell", row.CreditCardDate),
                        New XElement("cell", row.TotalAmount.ToString("#,##0.00"))))))
                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(xmlDoc.ToString())
                    Dim idx As Integer = data.Count - 1
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(0).InnerText = ""
                    newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(1).InnerText = "Total"
                    'newDoc.GetElementsByTagName("row").Item(idx).ChildNodes(3).InnerText = ""
                    Return newDoc
                Else
                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                                    New XElement("rows", New XElement("page", page.ToString()),
                                                    New XElement("total", data.Count)))
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc1
                End If
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCreditCardDetailsList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCreditCardDetailsByID(ByVal ID As Integer) As F_ARCARD
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If

            Dim CreditCardResult = ARCARD.GetCreditCardDetailsByID(ID)

            Return CreditCardResult
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetIsDepositDelete::PagePostPayments")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Save unapplied payments on arinvs and cash
    ''' Anitha :: 17-Dec-2018 :: changed current date into Deposit Header date
    ''' </summary>
    ''' <param name="xCustomer"></param>
    ''' <param name="xCheck"></param>
    ''' <param name="xAmount"></param>
    ''' <param name="xBank"></param>
    ''' <param name="xDeposit"></param>
    ''' <param name="xDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveUnAppliedPayments(ByVal xCustomer As String, ByVal xCheck As String, ByVal xAmount As String, ByVal xBank As String, ByVal xDeposit As String, ByVal xDate As String) As String
        Try
            Dim UserDetails As New User
            If (Not HttpContext.Current.Session("LoginAdminDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginAdminDetails")
            ElseIf (Not HttpContext.Current.Session("LoginUserDetails") Is Nothing) Then
                UserDetails = HttpContext.Current.Session("LoginUserDetails")
            End If
            ''UnApplied payments in ARINVS with type 7
            'Payments.WRTAR(0, DateTime.Now.ToString("MM/dd/yyyy"), "7", If(xCheck = "", 0, Convert.ToInt32(xCheck)), If(xAmount = "", 0.00, Convert.ToDecimal(xAmount)), If(xCustomer = "", 0, Convert.ToInt32(xCustomer)), 0.00, xDeposit, "", UserDetails.Name)
            ''UnApplied payments in cash table with type of 2(check)
            'Payments.wtrcash(0, DateTime.Now.ToString("MM/dd/yyyy"), "2", If(xCheck = "", 0, Convert.ToInt32(xCheck)), If(xAmount = "", 0.00, Convert.ToDecimal(xAmount)), If(xCustomer = "", 0, Convert.ToInt32(xCustomer)), xDeposit, xBank, "")

            'UnApplied payments in ARINVS with type 7
            Payments.WRTAR(0, xDate, "7", If(xCheck = "", 0, Convert.ToInt32(xCheck)), If(xAmount = "", 0.0, Convert.ToDecimal(xAmount)), If(xCustomer = "", 0, Convert.ToInt32(xCustomer)), 0.0, xDeposit, "", UserDetails.Name)
            'UnApplied payments in cash table with type of 2(check)
            Payments.wtrcash(0, xDate, "2", If(xCheck = "", 0, Convert.ToInt32(xCheck)), If(xAmount = "", 0.0, Convert.ToDecimal(xAmount)), If(xCustomer = "", 0, Convert.ToInt32(xCustomer)), xDeposit, xBank, "")

            Return "Success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetIsDepositDelete::PagePostPayments")
            Throw ex
        End Try
    End Function

#End Region

#Region "Closing Accounts"
    <System.Web.Services.WebMethod(True)>
    Public Function ar102(dCloseDate As String) As String
        Try
            Return ARClosing.ar102(dCloseDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ar102::PageAccounts")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' Print AR Journal summary report from year closing menu :: Created by Abinaya :: 31Jul2018
    ''' </summary>
    ''' <param name="EodDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ARJournalSummary(EodDate As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(1) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "EodDate"
            reportParameterCollection(1).Values.Add(EodDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If EodDate <> "" And EodDate <> "" Then
                filename = "Journal summary on " + Convert.ToDateTime(EodDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "Journal Summary.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptARJournalSummary", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If EodDate <> "" And EodDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report AR Journal Summary on " + EodDate + " by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ARJournalSummary")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    '
    ''' <summary>
    ''' Print AR sales by awbnumber report from listing menu :: Created by Anitha :: 14Dec2018
    ''' </summary>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function ARSalesByAWBNumber(ByVal FromDate As String, ByVal ToDate As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end


            Dim objPdf As New ExportSSRS
            Dim ConString As String = ConfigurationManager.ConnectionStrings("BloomsConnectionString").ToString()

            Dim reportParameterCollection As ReportParameter() = New ReportParameter(2) {}
            reportParameterCollection(0) = New ReportParameter()
            reportParameterCollection(0).Name = "ConnectionString"
            reportParameterCollection(0).Values.Add(ConString)

            reportParameterCollection(1) = New ReportParameter()
            reportParameterCollection(1).Name = "FromDate"
            reportParameterCollection(1).Values.Add(FromDate)

            reportParameterCollection(2) = New ReportParameter()
            reportParameterCollection(2).Name = "ToDate"
            reportParameterCollection(2).Values.Add(ToDate)

            Dim CompanyName As String = ConfigurationManager.AppSettings("CompanyName").ToString()
            Dim filename As String = ""

            If FromDate <> "" And ToDate <> "" Then
                filename = "Sales By AWBNumber from " + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + " to " + Convert.ToDateTime(FromDate, New System.Globalization.CultureInfo("en-US", True)).ToString("MM_dd_yy") + ".pdf"
            Else
                filename = "Sales By AWBNumber.pdf"
            End If

            Dim ReportExportFolder = ConfigurationManager.AppSettings("ExportFolder").ToString()
            Dim BodyMessage As String = ""
            Dim ReportName As String = objPdf.ExportToPdf(filename, "rptSalesByAWBNumber", reportParameterCollection, ExportSSRS.PdfOrientation.Portrait, ExportSSRS.FileType.PDF, "BloomsReportSource")
            If ReportName <> "" Then
                If FromDate <> "" And ToDate <> "" Then
                    Logs.VendorEmailLogs(User, BodyMessage, (ReportExportFolder + "\" + filename), (CompanyName + " Report AR Sales By AWBNumber from " + FromDate + " to " + ToDate + " by user:" + User.Email), "labelnotification")
                End If
            End If
            Return ReportName

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ARSalesByAWBNumber")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

    ''' <summary>
    ''' Calculate all invoice total :: Created by Abinaya :: 09Aug2018
    ''' </summary>
    ''' <param name="dCloseDate"></param>
    ''' <returns>Invoice total value</returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetInvoiceTotalForDayClosing(dCloseDate As String) As String
        Try
            Return ARClosing.GetInvoiceTotalForDayClosing(dCloseDate)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetInvoiceTotalForDayClosing::PageAccounts")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' DAY CLOSING PROCESS- POSTING TO SALES FILES:: Created by Abinaya :: 
    ''' Anitha :: 02-Nov-2018 :: send reports through email sales maintenance journal,ar journal summary,cod report
    ''' </summary>
    ''' <param name="dCloseDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function DayWiseClosing(dCloseDate As String, ByVal TotalSales As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim SalesMaintenanceJournal As String = ""
            Dim ARJournalSummaryReport As String = ""
            Dim CODReport As String = ""
            Dim SalesSummary As String = ""
            Dim Attachaments As String = ""

            Dim IsSendInvoiceOnEOD As String = ConfigurationManager.AppSettings("IsSendInvoiceOnEOD").ToString()
            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")


            Dim fromdate As String = ""
            Dim result As String = ""

            Try
                result = ARClosing.DayWiseClosing(dCloseDate, User.ID, User.Name, TotalSales, IsSendInvoiceOnEOD, User.Email)
                If result.Split("~")(1) <> "" Then
                    fromdate = result.Split("~")(1)
                End If
            Catch ex As Exception
                ErrorLogs.LogException(ex, "Error in Service::DayWiseClosing::PageAccounts")
            End Try

            If fromdate <> "" Then
                Try
                    'sending true to SalesMaintenanceJournal because it is being called from EOD
                    SalesMaintenanceJournal = PrintSalesMaintenanceJournal(fromdate, dCloseDate, True)
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in Service::PrintSalesMaintenanceJournal::PageAccounts")
                End Try

                Try
                    'Dim lstDay As New DateTime(Convert.ToDateTime(dCloseDate).Year - 1, 12, 31)
                    ARJournalSummaryReport = ARJournalSummary(dCloseDate)
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in Service::ARJournalSummary::PageAccounts")
                End Try

                Try
                    CODReport = PrintCODReport(fromdate, dCloseDate)
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in Service::PrintCODReport::PageAccounts")
                End Try

                Try
                    SalesSummary = PrintSalesSummaryReport(dCloseDate, dCloseDate, "Y", "")
                Catch ex As Exception
                    ErrorLogs.LogException(ex, "Error in Service::PrintSalesSummaryReport::PageAccounts")
                End Try

                Dim ToEmail As String = F_Emails.GetEmailsByType("EOD")
                If ToEmail = "" Then ToEmail = User.Email
                If Not ToEmail.Contains(User.Email) Then ToEmail += "," & User.Email

                If Not SalesMaintenanceJournal.ToLower().StartsWith("error") Then
                    Dim v = Logs.SendMail(User.Email, ToEmail, "", SalesMaintenanceJournal, "EOD Sales Maintenance Journal Report from " + fromdate + " to " + dCloseDate).GetAwaiter().GetResult()
                End If
                If Not ARJournalSummaryReport.ToLower().StartsWith("error") Then
                    Dim unused = Logs.SendMail(User.Email, ToEmail, "", ARJournalSummaryReport, "EOD AR Journal Summary Report for " + dCloseDate).GetAwaiter().GetResult()
                End If
                'If Not CODReport.ToLower().StartsWith("error") Then
                '    Logs.SendMail(User.Email, ToEmail, "", CODReport, "EOD Report For Date " + dCloseDate).GetAwaiter().GetResult()
                'End If
                If Not SalesSummary.ToLower().StartsWith("error") Then
                    Dim unused1 = Logs.SendMail(User.Email, ToEmail, "", SalesSummary, "EOD Sales Summary Report for " + dCloseDate).GetAwaiter().GetResult()
                End If

                Return "Success"
            Else
                Return result.Split("~")(0)
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DayWiseClosing::PageAccounts")
            Throw ex
        End Try
    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="dCloseDate"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function MonthWiselosing(dCloseDate As String) As String
        Try

            Dim User As New User
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If

            'checkusersessionIsActive:start
            Dim SessionStatus As String = ""
            If Not Session("LoginUserDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("User")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                SessionStatus = CheckLoginSessionIsActive("Admin")
            End If
            If SessionStatus = "InActive" Then
                Return "LogOut"
            End If
            'end

            Dim data As List(Of MonthWiseClosing) = ARClosing.MonthWiseClosing(dCloseDate, User.Name)

            Dim dt1 As DataTable

            dt1 = ConvertToDataTable(data)
            Dim selectedColumns As String() =
                    {"Name", "Value"}

            Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            Dim dtCloned As DataTable = dt.Clone()
            For Each row As DataRow In dt.Rows
                dtCloned.ImportRow(row)
            Next
            Dim filepath = ExporttoExcel(dtCloned, "MonthWiseClosing$FileReports")
            Return filepath

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::MonthWiseClosing")
            Return "error : " + ex.Message + ":::" + ex.ToString()
        End Try
    End Function

#End Region

#Region "Customer Types"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCustTypesDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.CustTypes
            Dim data As List(Of BO.CustTypes) = obj.GetCustTypesListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"TYPE", "NAME", "PRICELEVEL", "FOB"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("NAME").ColumnName = "Description"
                dt.Columns("PRICELEVEL").ColumnName = "Price Level"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "CustomerTypesDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteCustTypes_" & row.ID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditCustTypes_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.TYPE)),
                                        New XElement("cell", row.NAME),
                                        New XElement("cell", row.PRICELEVEL),
                                        New XElement("cell", row.FOB),
                                        New XElement("cell", Convert.ToString(row.ADA)),
                                        New XElement("cell", row.ADAROSES),
                                        New XElement("cell", row.ITIMIZE)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustTypesDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustTypesDetailByID(ByVal ID As Integer) As List(Of BO.CustTypes)
        Try
            Dim data As List(Of BO.CustTypes) = DAO.CustTypes.GetCustTypesDetailByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCustTypesDetailByID::PageCustTypes")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCustTypes(ByVal ID As String, ByVal CustTypesCode As String, ByVal CustTypesName As String, ByVal PriceLevel As String, ByVal Fob As String,
    ByVal Itimize As String) As String
        Try
            Dim CustTypesID As String = ""

            If (ID = "0") Then
                CustTypesID = DAO.CustTypes.InsertCustTypes(CustTypesCode, CustTypesName, PriceLevel, Fob, Itimize)
            Else

                DAO.CustTypes.UpdateCustTypes(ID, CustTypesCode, CustTypesName, PriceLevel, Fob, Itimize)
                CustTypesID = Convert.ToInt32(ID)
            End If
            If (Not CustTypesCode.Contains("UNIQUE KEY constraint")) Then
                Return CustTypesID
            Else
                Return CustTypesID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCustTypes::PageCustTypes")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCustTypesbyID(ByVal ID As String) As String
        Try
            Return DAO.CustTypes.DeleteCustTypesbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCustTypesbyID::PageCustTypes")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Country Codes"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCountryCodesDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Country
            Dim data As List(Of BO.Country) = obj.GetCountryCodesListForFgrd(whereCondition, sortExp, start, rp)

            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"COUNTRY", "NAME", "CURRENCYCODE", "CURRENCYRATE"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Country").ColumnName = "Code"
                dt.Columns("NAME").ColumnName = "Country Name"
                dt.Columns("CURRENCYCODE").ColumnName = "Currency"
                dt.Columns("CURRENCYRATE").ColumnName = "Rate"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "CountryDet$Files")
                Return BuildXmlDoc(filepath)
            Else

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteCountryCodes_" & row.ID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditCountryCodes_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.COUNTRY)),
                                        New XElement("cell", row.NAME),
                                        New XElement("cell", row.CURRENCYCODE),
                                        New XElement("cell", row.CURRENCYRATE)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCountryCodesDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCountryCodesDetailByID(ByVal ID As Integer) As List(Of BO.Country)
        Try
            Dim data As List(Of BO.Country) = DAO.Country.GetCountryCodesDetailByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCountryCodesDetailByID::PageCountryCodes")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCountryCodes(ByVal ID As String, ByVal CountryCodesCountry As String, ByVal CountryCodesName As String, ByVal CurrencyCode As String, ByVal CurrencyRate As String) As String
        Try
            Dim CountryCodesID As String = ""

            If (ID = "0") Then
                CountryCodesID = DAO.Country.InsertCountryCodes(CountryCodesCountry, CountryCodesName, "", "")
            Else

                DAO.Country.UpdateCountryCodes(ID, CountryCodesCountry, CountryCodesName, "", "")
                CountryCodesID = Convert.ToInt32(ID)
            End If
            If (Not CountryCodesCountry.Contains("UNIQUE KEY constraint")) Then
                Return CountryCodesID
            Else
                Return CountryCodesID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveCountryCodes::PageCountryCodes")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCountryCodesbyID(ByVal ID As String) As String
        Try
            Return DAO.Country.DeleteCountryCodesbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCountryCodesbyID::PageCountryCodes")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' ABI::28-Apr-2018::To get Country code lists
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetCountryCodeList() As List(Of BO.Country)
        Try
            Return DAO.Country.GetCountryCodeList()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCountryCodeList")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Order Status"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetOrderStatusDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.OrderStatus
            Dim data As List(Of BO.OrderStatus) = obj.GetOrderStatusListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Status", "Desc"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Status").ColumnName = "CODE"
                dt.Columns("Desc").ColumnName = "Description"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "Orderstaus$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteOrderStatus_" & row.ID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditOrderStatus_" & row.ID & "'/>"),
                                        New XElement("cell", row.STATUS),
                                        New XElement("cell", row.DESC)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderStatusDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderStatusDetailByID(ByVal ID As Integer) As List(Of BO.OrderStatus)
        Try
            Dim data As List(Of BO.OrderStatus) = DAO.OrderStatus.GetOrderStatusDetailByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderStatusDetailByID::PageOrderStatus")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveOrderStatus(ByVal ID As String, ByVal OrderStatusCode As String, ByVal OrderStatusDesc As String) As String
        Try
            Dim OrderStatusID As String = ""

            If (ID = "0") Then
                OrderStatusID = DAO.OrderStatus.InsertOrderStatus(OrderStatusCode, OrderStatusDesc)
            Else

                OrderStatusID = DAO.OrderStatus.UpdateOrderStatus(ID, OrderStatusCode, OrderStatusDesc)
                'OrderStatusID = Convert.ToInt32(ID)
            End If
            If (Not OrderStatusCode.Contains("UNIQUE KEY constraint")) Then
                Return OrderStatusID
            Else
                Return OrderStatusID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveOrderStatus::PageOrderStatus")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteOrderStatusbyID(ByVal ID As String) As String
        Try
            Return DAO.OrderStatus.DeleteOrderStatusbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteOrderStatusbyID::PageOrderStatus")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Fuel by Box"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetFuelByBoxDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Fuel
            Dim data As List(Of BO.Fuel) = obj.GetFuelByBoxListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"UOM", "SalesType", "FUEL", "FROMDATE", "TODATE"}



                For Each row As DataRow In dt1.Rows
                    Dim fromdateformat As String
                    fromdateformat = row.Item("FROMDATE")
                    Dim todateformat As String
                    todateformat = row.Item("TODATE")
                    Dim fromdate As String = Convert.ToDateTime(fromdateformat).ToString("MM/dd/yy")
                    Dim todate As String = Convert.ToDateTime(todateformat).ToString("MM/dd/yy")
                    For Each column As DataColumn In dt1.Columns
                        row.SetField(4, fromdate)
                        row.SetField(5, todate)
                    Next
                Next

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("UOM").ColumnName = "UOM"
                dt.Columns("SalesType").ColumnName = "SalesType"
                dt.Columns("FUEL").ColumnName = "FUEL"
                dt.Columns("FROMDATE").ColumnName = "FROM"
                dt.Columns("TODATE").ColumnName = "TO"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "FuelCharge$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteFuelByBox_" & row.ID & "'/>"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditFuelByBox_" & row.ID & "'/>"),
                                        New XElement("cell", row.UOM),
                                        New XElement("cell", row.SALESTYPE),
                                        New XElement("cell", row.FUEL),
                                        New XElement("cell", Convert.ToDateTime(row.FROMDATE).ToString("MM/dd/yy")),
                                        New XElement("cell", "-"),
                                        New XElement("cell", Convert.ToDateTime(row.TODATE).ToString("MM/dd/yy"))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFuelByBoxDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFuelByBoxDetailByID(ByVal ID As Integer) As BO.Fuel
        Try
            Return DAO.Fuel.GetFuelByBoxDetailByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFuelByBoxDetailByID::PageFuelByBox")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveFuelByBox(ByVal ID As String, ByVal FuelByBoxUom As String, ByVal FuelByBoxSalesType As String, ByVal FuelByBoxFuel As Decimal, ByVal FuelByBoxValidFrom As String, ByVal FuelByBoxValidTo As String) As String
        Try
            Dim FuelByBoxID As String = ""

            If (ID = "0") Then
                FuelByBoxID = DAO.Fuel.InsertFuelByBox(FuelByBoxUom, FuelByBoxSalesType, FuelByBoxFuel, FuelByBoxValidFrom, FuelByBoxValidTo)
            Else

                DAO.Fuel.UpdateFuelByBox(ID, FuelByBoxUom, FuelByBoxSalesType, FuelByBoxFuel, FuelByBoxValidFrom, FuelByBoxValidTo)
                FuelByBoxID = Convert.ToInt32(ID)
            End If
            If (Not FuelByBoxUom.Contains("UNIQUE KEY constraint")) Then
                Return FuelByBoxID
            Else
                Return FuelByBoxID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveFuelByBox::PageFuelByBox")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteFuelByBoxbyID(ByVal ID As String) As String
        Try
            Return DAO.Fuel.DeleteFuelByBoxbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteFuelByBoxbyID::PageFuelByBox")
            Return Nothing
        End Try
    End Function
#End Region

#Region "Customer Maintenance"
    ''' <summary>
    ''' Load Customer type list :: By Abinaya :: 09May2018
    ''' </summary>
    ''' <returns>List of Types and its name</returns>
    <System.Web.Services.WebMethod(True)>
    Public Function LoadCustomerTypes() As List(Of BO.CustTypes)
        Try
            Dim data As List(Of BO.CustTypes) = DAO.CustTypes.LoadCustomerTypes()
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::LoadCustomerTypes::PageCustomer")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCustomer(ByVal Customer As String) As String
        Try
            Dim Result As String
            Result = CustomerDetails.DeleteCustomer(Customer)
            Return Result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "DeleteCustomer")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function VerifyCarrierAccount(ByVal Customer As String, ByVal DELLS As String) As String
        Try
            Dim Result As String
            Result = CustomerDetails.VerifyCarrierAccount(Customer, DELLS)
            Return Result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "VerifyCarrierAccount")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustDetailsByCustomerNo(ByVal Customer As String) As CustomerDetail
        Try
            Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNo(Customer)
            Return CustomerDetail
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetCustomerEmailIDforCrReq")
            Return Nothing
        End Try
    End Function
    'Add By Prashant For previous and next customer button on 30 Aug 2019
    <System.Web.Services.WebMethod(True)>
    Public Function GetCustDetailsByCustomerNoWithPrevNextCustomer(ByVal Customer As String) As CustomerDetail
        Try
            Dim CustomerDetail = CustomerDetails.GetCustDetailsByCustomerNoWithPrevNextCustomer(Customer)
            Return CustomerDetail
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetCustDetailsByCustomerNoWithPrevNextCustomer")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetLastCustDetails() As CustomerDetail
        Try
            Dim CustomerDetail = CustomerDetails.GetLastCustDetails()
            Return CustomerDetail
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetLastCustDetails")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCustomerDetails(IsCustomerAdd As String, Customer As String, Name As String, Type As String, Markup As String, Address1 As String, Address2 As String, City As String, Country As String, State As String, Zip As String, Airport As String, Territory As String, Purchaser As String, Phone As String, BuyerExt As String, Contact As String, Apphone As String, ContactExt As String, Title As String, Fax As String, ContactTitleExt As String, Email As String, Salesman As String, SalesmanName As String, Termscode As String, TermsDesc As String, Prepaid As String, LineFuel As String, Billto As String, Parent As String, ARLimit As String, Interest As String, SalesID As String, CreditApp As String, CreditDate As String, CreditHold As String, NACM As String, NACMNUM As String, ReasonHold As String, ChargeFuel As String, FaxOrEmail As String, Statement As String, Collection As String, OkToSell As String, Service As String, ShipInstr As String, CallTime As String, Carrier As String, Printnodat As String, AndeanTax As String, Armellini2 As String, Calls As String, DELLS As String, WareHouse As String, Division As String, Vendor As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            If (IsCustomerAdd = "0") Then
                Return CustomerDetails.InsertCustomerDetails(Customer, Name, Type, Convert.ToDecimal(Markup), HttpUtility.UrlDecode(Address1, System.Text.Encoding.Default), HttpUtility.UrlDecode(Address2, System.Text.Encoding.Default), City, Country, State, Zip, Airport, Territory, Purchaser, Phone, BuyerExt, HttpUtility.UrlDecode(Contact, System.Text.Encoding.Default), Apphone, ContactExt, Title, Fax, ContactTitleExt, HttpUtility.UrlDecode(Email, System.Text.Encoding.Default), Salesman, SalesmanName, Termscode, TermsDesc, If(Prepaid = "", False, Convert.ToBoolean(If(Prepaid = "Y", True, False))), If(LineFuel = "", False, Convert.ToBoolean(If(LineFuel = "Y", True, False))), If(Billto = "", 0, Convert.ToInt32(Billto)), If(Parent = "", 0, Convert.ToInt32(Parent)), If(ARLimit = "", "0.00", ARLimit), If(Interest = "", 0.0, Convert.ToDecimal(Interest)), SalesID, CreditApp, CreditDate, CreditHold, NACM, NACMNUM, ReasonHold, If(ChargeFuel = "", False, Convert.ToBoolean(If(ChargeFuel = "Y", True, False))), FaxOrEmail, If(Statement = "", False, Convert.ToBoolean(If(Statement = "Y", True, False))), If(Collection = "", False, Convert.ToBoolean(If(Collection = "Y", True, False))), OkToSell, Service, Vendor, ShipInstr, CallTime, Carrier, Printnodat, If(AndeanTax = "", False, Convert.ToBoolean(If(AndeanTax = "Y", True, False))), Armellini2, Calls, DELLS, User.Name, User.Email, WareHouse, Division)
            Else
                Return CustomerDetails.UpdateCustomerDetails(Customer, Name, Type, Convert.ToDecimal(Markup), HttpUtility.UrlDecode(Address1, System.Text.Encoding.Default), HttpUtility.UrlDecode(Address2, System.Text.Encoding.Default), City, Country, State, Zip, Airport, Territory, Purchaser, Phone, BuyerExt, HttpUtility.UrlDecode(Contact, System.Text.Encoding.Default), Apphone, ContactExt, Title, Fax, ContactTitleExt, HttpUtility.UrlDecode(Email, System.Text.Encoding.Default), Salesman, SalesmanName, Termscode, TermsDesc, If(Prepaid = "", False, Convert.ToBoolean(If(Prepaid = "Y", True, False))), If(LineFuel = "", False, Convert.ToBoolean(If(LineFuel = "Y", True, False))), If(Billto = "", 0, Convert.ToInt32(Billto)), If(Parent = "", 0, Convert.ToInt32(Parent)), If(ARLimit = "", "0.00", ARLimit), If(Interest = "", 0.0, Convert.ToDecimal(Interest)), SalesID, CreditApp, CreditDate, CreditHold, NACM, NACMNUM, ReasonHold, If(ChargeFuel = "", False, Convert.ToBoolean(If(ChargeFuel = "Y", True, False))), FaxOrEmail, If(Statement = "", False, Convert.ToBoolean(If(Statement = "Y", True, False))), If(Collection = "", False, Convert.ToBoolean(If(Collection = "Y", True, False))), OkToSell, Service, Vendor, ShipInstr, CallTime, Carrier, Printnodat, If(AndeanTax = "", False, Convert.ToBoolean(If(AndeanTax = "Y", True, False))), Armellini2, Calls, DELLS, User.Name, User.Email, WareHouse, Division)
            End If


        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service:: UpdateCustomerDetails::PageCustomer")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetNextCustomerNoFromConst() As String
        Try
            Return CustomerDetails.GetNextCustomerNoFromConst()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSlsmanControlNum::PageOrder")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function CheckIsCustomerAlreadyExist(ByVal Customer As String) As String
        Try
            Return CustomerDetails.CheckIsCustomerAlreadyExist(Convert.ToInt32(Customer))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckIsCustomerAlreadyExist::PageCustomer")
            Throw ex
        End Try
    End Function

#End Region

#Region "Carrier Code"

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCarrierCodeDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String,
                                         ByVal ExportCSV As String, ByVal Customer As String, ByVal Shipto As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = "where " + BuildWhereCondition(GetType(CustomerDetail), qtype, query)
            End If

            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If



            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.CaCode

            'If (ExportCSV <> "") Then

            '    Dim splitExportcsv = ExportCSV.Split("|")

            '    Dim data As List(Of BO.CaCode) = obj.GetCarrierCodeListForFgrd(Customer, Shipto)

            '    Dim dt1 As DataTable

            '    dt1 = ConvertToDataTable(data)
            '    Dim selectedColumns As String() =
            '        {"Invoice", "RecDate", "PO", "ShiptoName", "AWB", "Carrier", "WH", "Charges", "Payments", "Credits", "Adjustment", "Balance", "AccumulatedBalance"}

            '    Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
            '    'dt.Columns("Customer").ColumnName = "CUST#"
            '    'dt.Columns("Purchaser").ColumnName = "Buyer"
            '    'dt.Columns("ARBalance").ColumnName = "Balance"
            '    'dt.Columns("SalesmanName").ColumnName = "SalesPerson"
            '    'dt.Rows.RemoveAt(dt.Rows.Count - 1)
            '    Dim dtCloned As DataTable = dt.Clone()
            '    For Each row As DataRow In dt.Rows
            '        dtCloned.ImportRow(row)
            '    Next
            '    Dim filepath = ExporttoExcel(dtCloned, "ARINVS$ARINVS")
            '    Return BuildXmlDoc(filepath)
            'Else

            Dim data As List(Of BO.CaCode) = obj.GetCarrierCodeListForFgrd(Customer, Shipto)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", page.ToString()),
                            New XElement("total", obj.TotalRows.ToString()),
                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID.ToString()),
                            New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteCaCode_" & row.ID.ToString() & "'/>"),
                            New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditCaCode_" & row.ID.ToString() & "'/>"),
                            New XElement("cell", row.Carrier),
                            New XElement("cell", row.CarrierName),
                            New XElement("cell", row.Account),
                            New XElement("cell", row.Zone),
                            New XElement("cell", row.UpdUser),
                            New XElement("cell", row.UpdDate),
                            New XElement("cell", row.UpdTime)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierCodeDetailsForFgrd")
            Return Nothing
        End Try
    End Function


    <System.Web.Services.WebMethod(True)>
    Public Function SaveCarrierCodeDetails(ByVal ID As String, ByVal Shipto As String, ByVal Customer As String, ByVal Carrier As String, ByVal Account As String, ByVal Zone As String) As String
        Try
            Dim result As String = ""
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            result = DAO.CaCode.SaveCarrierCodeDetails(ID, Shipto, Customer, Carrier, Account, Zone, User.Name)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveShiptoDetails::PageCarrierCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCarrierCodeDetailsByID(ByVal ID As String) As List(Of BO.CaCode)
        Try
            Return DAO.CaCode.GetCarrierCodeDetailsByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetCarrierCodeDetailsByID::PageCarrierCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCarrierCodeDetails(ByVal ID As String) As String
        Try
            Return DAO.CaCode.DeleteCarrierCodeDetails(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteCarrierCodeDetails::PageCarrierCode")
            Return Nothing
        End Try
    End Function


#End Region

#Region "FreightByCarrier"
    'Added By Anubhuti 08/10/2021
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetCustomerFreightByCarrierForFgrd(ByVal Customer As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim obj As New DAO.CaCode

            Dim data As List(Of BO.CustomerFreightByCarrier) = obj.GetCustomerFreightByCarrierForFgrd(Customer)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                            New XElement("rows", New XElement("page", "0"),
                            New XElement("total", obj.TotalRows.ToString()),
                            data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID.ToString()),
                            New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteFreightByCarrier_" & row.ID.ToString() & "'/>"),
                            New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditFreightByCarrier_" & row.ID.ToString() & "'/>"),
                            New XElement("cell", row.Customer),
                            New XElement("cell", row.Carrier),
                            New XElement("cell", row.ChargeAmount),
                            New XElement("cell", row.ChargeBy),
                            New XElement("cell", row.UPDUSER),
                            New XElement("cell", row.UPDDATE)))))

            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFreightByCarrierForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCustomerFreightByCarrier(ByVal Customer As String, ByVal Carrier As String, ByVal ChargeAmount As String, ByVal ChargeBy As String, ByVal ID As String) As String
        Try
            Dim result As String = ""
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            result = DAO.CaCode.SaveCustomerFreightByCarrier(Customer, Carrier, ChargeAmount, ChargeBy, ID, User.Name)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveShiptoDetails::PageCarrierCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerFreightByCarrierByID(ByVal ID As String) As BO.CustomerFreightByCarrier
        Try
            Return DAO.CaCode.GetCustomerFreightByCarrierByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetFreightByCarrierByID::PageGrower")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteCustomerFreightByID(ByVal ID As String) As String
        Try
            Dim result As String = ""
            result = DAO.CaCode.DeleteCustomerFreightByID(ID)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteFreightByCarrierByID::PageGrower")
            Return Nothing
        End Try
    End Function

#End Region

#Region "SETEOD"

    ''' <summary>
    ''' Get Type From SETEOD file :: MANI::06/15/2018
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function GetTypeFromSETEOD() As String
        Try
            Dim Type = DAO.SETEOD.GetTypeFromSETEOD()
            Return Type
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetTypeFromSETEOD")
            Return "error"
        End Try
    End Function

#End Region

#Region "Lock"

    ''' <summary>
    ''' 06-29-2018::MANI::Common mehtod for inserting a particcular record on the lock table
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function InsertLock(ByVal LockRecord As String, ByVal Page As String, ByVal Functionality As String) As String
        Try
            Return DAO.Lock.InsertLock(LockRecord, Page, Functionality)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "InsertLock")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' 06-29-2018::MANI::Release a particular record from lock table
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function DeleteLock(ByVal LockRecord As String, ByVal Page As String, ByVal Functionality As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            Else
                Return "logout"
            End If
            Dim IsDeleted = ""
            IsDeleted = DAO.Lock.DeleteLock(LockRecord, Page, Functionality)
            If Functionality = "InvenLockRelease_Release" Then
                Logs.Savelog(User.ID, "PageInventory", "DeleteLock", "Release Lock", LockRecord)
            End If
            Return IsDeleted
        Catch ex As Exception
            ErrorLogs.LogException(ex, "DeleteLock")
            Return Nothing
        End Try
    End Function

#End Region

#Region "CreditLimitsApproval"

    <System.Web.Services.WebMethod(True)>
    Public Function GetCustomerDetailsforCreditLimitsApproval(ByVal Customer As String) As CustomerDetail
        Try
            Return CreditLimitsApproval.GetCustomerDetailsforCreditLimitsApproval(Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetCustomerDetailsforCreditLimitsApproval")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveCustomerDetailsforCreditLimitsApproval(ByVal Customer As String, ByVal AMTAPPROV As String, ByVal APPROVED As String,
                                                                      ByVal HOLLYDAYAM As String, ByVal EXPDATE As String) As String
        Try
            Return CreditLimitsApproval.SaveCustomerDetailsforCreditLimitsApproval(Customer, AMTAPPROV, APPROVED, HOLLYDAYAM, EXPDATE)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "SaveCustomerDetailsforCreditLimitsApproval")
            Return Nothing
        End Try
    End Function
    ''' <summary>
    ''' Check if the customer has approved/not for approval of the over credit limit to the person :: Abinaya :: 15Feb2019
    ''' </summary>
    ''' <param name="Customer"></param>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CheckApprovedForCustomer(ByVal Customer As String) As String
        Try
            Return CreditLimitsApproval.CheckApprovedForCustomer(Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "CheckApprovedForCustomer")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' check if user has Y in Override credit limit  :: Abinaya :: 02Marh2019
    ''' </summary>
    ''' <param name="Customer"></param>
    ''' <returns>Y/N</returns>
    <System.Web.Services.WebMethod(True)>
    Public Function CheckUsersOverrideCreditLimit(ByVal Customer As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            End If
            Dim OverrideCreditLimit As String
            Dim OrderRightsPosition As Integer
            OrderRightsPosition = 7
            OverrideCreditLimit = Users.GetUserTypeAccessRightsDetails(User.ID, OrderRightsPosition)
            Return OverrideCreditLimit
        Catch ex As Exception
            ErrorLogs.LogException(ex, "CheckApprovedForCustomer")
            Return Nothing
        End Try
    End Function


#End Region

#Region "Printer"
    Private Shared Sub doPrint(ByVal executable As String, ByVal fileFullPath As String, ByVal printerName As String)
        Dim startInfo As System.Diagnostics.ProcessStartInfo = New ProcessStartInfo()
        startInfo.Arguments = "/h /t """ & fileFullPath & """ """ & printerName & """"
        startInfo.FileName = executable
        startInfo.UseShellExecute = True
        startInfo.WindowStyle = ProcessWindowStyle.Hidden
        Dim process As System.Diagnostics.Process = New Process()

        Try
            process = Process.Start(startInfo)
        Catch ex As Exception
            'DBMaint.updateLogFile(ex.Message.ToString())
        Finally
            process.WaitForExit(20000)

            If process.HasExited = False Then
                process.Kill()
            End If
        End Try
    End Sub

    '<DllImport("winspool.drv", CharSet:=CharSet.Auto, SetLastError:=True)>
    'Public Shared Function SetDefaultPrinter(ByVal Name As String) As Boolean

    'Public Sub SendPDFToPrinterPDFWithTool(ByVal PrinterName As String, ByVal Filepath As String)
    '    Try
    '        AppendLog("Print Execution Start for PrinterName: " & PrinterName & " and FilePath:" & Filepath, "SendPDFToPrinterPDFWithTool")
    '        Dim printerpdfusername As String = ConfigurationManager.AppSettings("PrinterPDFUserName").ToString()
    '        Dim printerpdfpassword As String = ConfigurationManager.AppSettings("PrinterPDFPassword").ToString()

    '        Dim pdfPrint = New PdfPrint(printerpdfusername, printerpdfpassword)
    '        Dim pdfFile As String = Filepath
    '        'Dim numberOfPages As Integer = pdfPrint.GetNumberOfPages(pdfFile)          /*Commented by Abinaya - for printer issue testing*/
    '        pdfPrint.PrinterName = PrinterName
    '        Dim status = pdfPrint.Print(pdfFile)

    '        Dim statusdesc = DecodeStatusCode(status)

    '        If statusdesc = "OK" Then
    '            AppendLog("Print success", "SendPDFToPrinterPDFWithTool")
    '        Else
    '            AppendLog(statusdesc, "SendPDFToPrinterPDFWithTool")
    '            Throw New ArgumentException(statusdesc + " {PrinterName:  " & PrinterName & "}")
    '        End If

    '        AppendLog("Print Execution Ended for PrinterName: " & PrinterName & " and FilePath:" & Filepath, "SendPDFToPrinterPDFWithTool")
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::SendPDFToPrinterPDFWithTool::PageOrder")
    '    End Try
    'End Sub


    'Public Shared Function DecodeStatusCode(ByVal status As PdfPrint.Status) As String
    '    Select Case status
    '        Case PdfPrint.Status.OK
    '            Return "OK"
    '        Case PdfPrint.Status.FILE_DOESNT_EXIST
    '            Return "Filename doesn't exist"
    '        Case PdfPrint.Status.CANNOT_PRINT_FILE
    '            Return "Cannot print file"
    '        Case PdfPrint.Status.PRINTER_DOESNT_EXIST
    '            Return "Printer doesn't exist"
    '        Case PdfPrint.Status.INVALID_DEVMOD
    '            Return "Invalid printer properties structure."
    '        Case PdfPrint.Status.NOT_AVAILABLE_PRINTER_PROPERTIES
    '            Return "Not available printer properties"
    '        Case PdfPrint.Status.CANT_INITIALIZE_PRINTER
    '            Return "Can't initialize printer"
    '        Case PdfPrint.Status.PASSWORD_INVALID
    '            Return "Invalid password"
    '        Case PdfPrint.Status.INVALID_PDF
    '            Return "Invalid pdf"
    '        Case PdfPrint.Status.FILENAME_NOT_SET
    '            Return "File name not set"
    '        Case PdfPrint.Status.PASSWORD_NOT_PROVIDED
    '            Return "PDF is password protected and password isn't provided."
    '        Case PdfPrint.Status.UNKNOWN_ERROR
    '            Return "Unknown error"
    '        Case PdfPrint.Status.INVALID_PRINT_RANGE
    '            Return "Invalid print range"
    '        Case PdfPrint.Status.INVALID_ADOBE_PRINT_RANGE
    '            Return "Invalid print range for adobe. It could be from-to, single page or empty."
    '        Case PdfPrint.Status.PAGE_NUMBER_DOESNT_EXIST
    '            Return "Page number doesn't exist"
    '        Case PdfPrint.Status.PRINTING_CANCELLED
    '            Return "Printing cancelled"
    '        Case PdfPrint.Status.INVALID_IMAGE_TYPE
    '            Return "Invalid image type."
    '        Case PdfPrint.Status.NOT_32_BIT
    '            Return "Printing with Adobe is supported only in 32 bit application."
    '    End Select

    '    Return "Unknown error."
    'End Function

    ' Method to Print the report to the printer by the given printer name
    '<System.Web.Services.WebMethod(True)>
    'Public Function SendPDFToPrinter(ByVal ExportedPath As String, ByVal PrinterName As String) As String
    '    Try
    '        'DefaultPrinterName()

    '        'ExportedPath = "D:\Common\Sites\VendorEmails\ReportExports\Ageing_20180817 125815575.pdf"
    '        Dim psi As New ProcessStartInfo
    '        Dim print As New PrinterSettings

    '        psi.UseShellExecute = True

    '        psi.Verb = "print"

    '        psi.WindowStyle = ProcessWindowStyle.Hidden
    '        psi.CreateNoWindow = True


    '        Dim wshnetwork As Object = CreateObject("WScript.Network")

    '        wshnetwork.SetDefaultPrinter(PrinterName)



    '        psi.FileName = HttpUtility.UrlDecode(ExportedPath, System.Text.Encoding.Default) ' Here specify a document to be printed
    '        Try
    '            Process.Start(psi)
    '        Catch ex As Exception
    '            Throw ex
    '        End Try

    '        Return "Success"
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "Error in Service::PrintPostPaymentsDepositReports::PagePostPayments")
    '        Throw ex
    '    End Try
    'End Function


    'Private Function DefaultPrinterName() As String
    '    Dim oPS As New System.Drawing.Printing.PrinterSettings
    '    Dim printerlist() As String
    '    Dim i = 0

    '    ' Find all printers installed
    '    For Each pkInstalledPrinters In
    '    PrinterSettings.InstalledPrinters

    '        Dim defaulfprint = pkInstalledPrinters

    '    Next pkInstalledPrinters

    '    Try
    '        DefaultPrinterName = oPS.PrinterName
    '    Catch ex As Exception
    '        'MessageBox.Show(ex.Message, "Capturing Default Printer", MessageBoxButtons.OK)
    '    Finally
    '        oPS = Nothing
    '    End Try
    'End Function


#End Region

#Region "Colors"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetColorsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Colors), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Colors
            Dim data As List(Of BO.Colors) = obj.GetColorsListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"ColorCode"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("ColorCode").ColumnName = "Color"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "ColorDet$Files")
                Return BuildXmlDoc(filepath)
            Else

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteColors_" & row.ID & "' data-colorcode='" + row.ColorCode + "' />"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditColors_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.ColorCode))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetColorsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetColorsByID(ByVal ID As Integer) As BO.Colors
        Try
            Return DAO.Colors.GetColorsByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetColorsByID::PageColors")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddEditDetleteSelectColors(ByVal ID As String, ByVal ColorCode As String, ByVal Mode As String, ByVal ShortCode As String) As String
        Try
            Return DAO.Colors.AddEditDetleteSelectColors(ID, ColorCode, Mode, ShortCode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddEditDetleteSelectColors::PageColors")
            Return Nothing
        End Try
    End Function


#End Region

#Region "Varieties"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetVarietiesForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Variety), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Variety
            Dim data As List(Of BO.Variety) = obj.GetVarietiesListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Category", "Variety", "Code"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Category").ColumnName = "Category"
                dt.Columns("Variety").ColumnName = "Variety"
                dt.Columns("Code").ColumnName = "Short Code"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "VarietyDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim webConfigPath = System.Configuration.ConfigurationManager.AppSettings("ProductImages")
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteVarieties_" & row.ID & "' data-variety='" + row.Variety + "' />"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditVarieties_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.Category)),
                                        New XElement("cell", Convert.ToString(row.Variety)),
                                        New XElement("cell", Convert.ToString(row.Code)),
                                        New XElement("cell", If(row.Photo = "", "", Convert.ToString(row.Photo))),
                                        New XElement("cell", If(row.PhotoLarge = "", "", Convert.ToString(row.PhotoLarge)))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetVarietiesForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetVarietiesByID(ByVal ID As Integer) As BO.Variety
        Try
            Return DAO.Variety.GetVarietiesByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetVarietiesByID::PageVarieties")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddEditDeleteSelectVarieties(ByVal ID As String, ByVal Category As String, ByVal Variety As String, ByVal ShortCode As String,
                                                  ByVal Mode As String, ByVal fileBase64Str As String, ByVal fileName As String, ByVal LargefileBase64Str As String, ByVal LargefileName As String) As String
        Try
            Dim webConfigPath = System.Configuration.ConfigurationManager.AppSettings("ProductImages")
            Dim folderPath As String = HttpContext.Current.Server.MapPath(webConfigPath) ' get folder path

            If Not System.IO.Directory.Exists(folderPath) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath) ' create folder if not exist 
            End If
            Dim filePath As String = ""
            Dim largefilePath As String = ""

            If (fileBase64Str <> "") Then
                Dim SmallImageFolder As String = folderPath + "Small"

                If Not System.IO.Directory.Exists(SmallImageFolder) Then ' check if folder exist
                    System.IO.Directory.CreateDirectory(SmallImageFolder) ' create folder if not exist 
                End If

                fileBase64Str = fileBase64Str.Split(",")(1)
                filePath = SmallImageFolder + "/" + fileName
                File.WriteAllBytes(filePath, Convert.FromBase64String(fileBase64Str)) ' save file
            End If

            If (LargefileBase64Str <> "") Then
                Dim LargeImageFolder As String = folderPath + "Large"

                If Not System.IO.Directory.Exists(LargeImageFolder) Then ' check if folder exist
                    System.IO.Directory.CreateDirectory(LargeImageFolder) ' create folder if not exist 
                End If

                LargefileBase64Str = LargefileBase64Str.Split(",")(1)
                largefilePath = LargeImageFolder + "/" + LargefileName
                File.WriteAllBytes(largefilePath, Convert.FromBase64String(LargefileBase64Str)) ' save file
            End If

            Return DAO.Variety.AddEditDeleteSelectVarieties(ID, Category, Variety, ShortCode, Mode, If(fileName = "", "", fileName), If(LargefileName = "", "", LargefileName))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddEditDeleteSelectVarieties::PageVarieties")
            Return Nothing
        End Try
    End Function


#End Region

#Region "Pictures"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetPicturesForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BOPICTURES.Variety), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Pictures
            Dim data As List(Of BO.Variety) = obj.GetPicturesListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Category", "Variety", "Color"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Category").ColumnName = "Category"
                dt.Columns("Variety").ColumnName = "Variety"
                dt.Columns("Color").ColumnName = "Color"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "PicturesDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim webConfigPath = System.Configuration.ConfigurationManager.AppSettings("ProductImages")
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeletePictures_" & row.ID & "' data-variety='" + row.Variety + "' />"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditPictures_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.Category)),
                                        New XElement("cell", Convert.ToString(row.Variety)),
                                        New XElement("cell", Convert.ToString(row.Color)),
                                        New XElement("cell", If(row.Photo = "", "", Convert.ToString(row.Photo))),
                                        New XElement("cell", If(row.PhotoLarge = "", "", Convert.ToString(row.PhotoLarge)))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPicturesForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetPicturesByID(ByVal ID As Integer) As BO.Variety
        Try
            Return DAO.Pictures.GetPicturesByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetPicturesByID::PagePictures")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddEditDeleteSelectPictures(ByVal ID As String, ByVal Category As String, ByVal Variety As String, ByVal Color As String,
                                                  ByVal Mode As String, ByVal fileBase64Str As String, ByVal fileName As String, ByVal LargefileBase64Str As String, ByVal LargefileName As String) As String
        Try
            Dim webConfigPath = System.Configuration.ConfigurationManager.AppSettings("ProductImages")
            Dim folderPath As String = HttpContext.Current.Server.MapPath(webConfigPath) ' get folder path

            If Not System.IO.Directory.Exists(folderPath) Then ' check if folder exist
                System.IO.Directory.CreateDirectory(folderPath) ' create folder if not exist 
            End If
            Dim filePath As String = ""
            Dim largefilePath As String = ""

            If (fileBase64Str <> "") Then
                Dim SmallImageFolder As String = folderPath + "Small"

                If Not System.IO.Directory.Exists(SmallImageFolder) Then ' check if folder exist
                    System.IO.Directory.CreateDirectory(SmallImageFolder) ' create folder if not exist 
                End If

                fileBase64Str = fileBase64Str.Split(",")(1)
                filePath = SmallImageFolder + "/" + fileName
                File.WriteAllBytes(filePath, Convert.FromBase64String(fileBase64Str)) ' save file
            End If

            If (LargefileBase64Str <> "") Then
                Dim LargeImageFolder As String = folderPath + "Large"

                If Not System.IO.Directory.Exists(LargeImageFolder) Then ' check if folder exist
                    System.IO.Directory.CreateDirectory(LargeImageFolder) ' create folder if not exist 
                End If

                LargefileBase64Str = LargefileBase64Str.Split(",")(1)
                largefilePath = LargeImageFolder + "/" + LargefileName
                File.WriteAllBytes(largefilePath, Convert.FromBase64String(LargefileBase64Str)) ' save file
            End If

            Return DAO.Pictures.AddEditDeleteSelectPictures(ID, Category, Variety, Color, Mode, If(fileName = "", "", fileName), If(LargefileName = "", "", LargefileName))
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddEditDeleteSelectPictures::PagePictures")
            Return Nothing
        End Try
    End Function


#End Region
#Region "Grades"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetGradesForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Grades), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Grades
            Dim data As List(Of BO.Grades) = obj.GetGradesListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Category", "Grade"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("Category").ColumnName = "Category"
                dt.Columns("Grade").ColumnName = "Grade"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "GradeDet$Files")
                Return BuildXmlDoc(filepath)
            Else

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteGrades_" & row.ID & "' data-grade='" + row.Grade + "' data-category='" + row.Category + "' />"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditGrades_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.Category)),
                                        New XElement("cell", Convert.ToString(row.Grade))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGradesForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetGradesByID(ByVal ID As Integer) As BO.Grades
        Try
            Return DAO.Grades.GetGradesByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetGradesByID::PageGrades")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddEditDetleteSelectGrades(ByVal ID As String, ByVal Category As String, ByVal Grade As String, ByVal Mode As String) As String
        Try
            Return DAO.Grades.AddEditDetleteSelectGrades(ID, Category, Grade, Mode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddEditDetleteSelectGrades::PageGrades")
            Return Nothing
        End Try
    End Function


#End Region

#Region "Duty Table"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetDutyForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String, ByVal TableName As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(BO.Duty), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New DAO.Duty
            Dim data As List(Of BO.Duty) = obj.GetDutyListForFgrd(whereCondition, sortExp, start, rp, TableName)
            If (ExportCSV <> "") Then

                Dim splitExportcsv = ExportCSV.Split("|")

                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"COUNTRY", "FLOWER", "TAX", "PRICE", "ANTIDUMP", "DutyDATE", "FEE", "NAME", "SOLDAS", "TUSA"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("DutyDATE").ColumnName = "DATE"
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "DutyDet$Files")
                Return BuildXmlDoc(filepath)
            Else

                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteDuty_" & row.ID & "' data-country='" + row.COUNTRY + "' data-flower='" + row.FLOWER + "' data-name='" + row.NAME + "' />"),
                                        New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditDuty_" & row.ID & "'/>"),
                                        New XElement("cell", Convert.ToString(row.COUNTRY)),
                                        New XElement("cell", Convert.ToString(row.FLOWER)),
                                        New XElement("cell", Convert.ToString(row.NAME)),
                                        New XElement("cell", Convert.ToString(row.MarketPriceDuty)),
                                        New XElement("cell", row.DutyDATE.ToString("MM/dd/yyyy"))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDutyForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetDutyByID(ByVal ID As Integer, ByVal TableName As String) As BO.Duty
        Try
            Return DAO.Duty.GetDutyByID(ID, TableName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetDutyByID::PageDuty")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function AddEditDetleteSelectDuty(ByVal ID As String, ByVal COUNTRY As String, ByVal FLOWER As String, ByVal TAX As String, ByVal PRICE As String, ByVal ANTIDUMP As String, ByVal FEE As String, ByVal NAME As String, ByVal SOLDAS As String, ByVal TUSA As String, ByVal Mode As String, ByVal TableName As String) As String
        Try
            Return DAO.Duty.AddEditDetleteSelectDuty(ID, COUNTRY, FLOWER, TAX, PRICE, ANTIDUMP, FEE, NAME, SOLDAS, TUSA, Mode, TableName)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::AddEditDetleteSelectDuty::PageDuty")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Changes_New funtions"
    ' Muthu Nivetha M :: 16 Mar 19 :: Print Label on look up by boxnumber results screen
    <System.Web.Services.WebMethod(True)>
    Public Function GetOrdersByFarmandBoxnum(ByVal Farm As String, ByVal BoxNum As String) As String
        Try
            Dim salesdetail As New List(Of BO.SalesDetail)
            Session("SessionIsForLookup") = Nothing
            salesdetail = SalesOrder.GetOrdersByFarmandBoxnum(Farm, BoxNum)
            If (salesdetail IsNot Nothing AndAlso salesdetail.Count > 0) Then   '21 Mar 19 :: Muthu Nivetha M :: Print Label on look up by boxnumber results screen
                If Session("SessionIsForLookup") Is Nothing Then
                    Session("SessionIsForLookup") = salesdetail
                End If
                Dim orders As String = String.Join(",", salesdetail.[Select](Function(s) s.Order).Distinct()).ToString()
                Dim shipdates As String = String.Join(",", salesdetail.[Select](Function(s) s.ShippingDate).Distinct()).ToString()
                Dim custs As String = String.Join(",", salesdetail.[Select](Function(s) s.CustCode).Distinct()).ToString()
                GenerateReportsInOrderToPrinter(orders, "", "", "Y", "", "", shipdates, salesdetail(0).CustCode)
            Else
                Return "No records to Print"
            End If
            Return "Valid"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrdersByFarmandBoxnum")
            Return Nothing
        End Try
    End Function
    'Muthu Nivetha M :: 18 Mar 19 ::  Locks up system :: Sales-Person
    <System.Web.Services.WebMethod(True)>
    Public Function CheckIsSalesPersonSameForNewOrder(ByVal Customer As String) As List(Of String)
        Dim result As New List(Of String)
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If
            If Customer = "" Then
                Customer = "0"
            End If
            result = SalesOrder.CheckIsSalesPersonSameForNewOrder(Customer, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::CheckIsSalesPersonSameForNewOrder")
        End Try
        Return result
    End Function

#End Region

#Region "Message Maintenance"
    ''' <summary>
    ''' Abinaya :: 05-Feb-2019 :: Save message from Invoice message maintenance
    ''' </summary>
    ''' <returns></returns>
    <System.Web.Services.WebMethod(True)>
    Public Function SaveMessagesfromMsgINV(ByVal Text1 As String, ByVal Text2 As String, ByVal Text3 As String, ByVal Text4 As String, ByVal Text5 As String) As String
        Try
            Return SalesOrder.SaveMessagesfromMsgINV(Text1, Text2, Text3, Text4, Text5)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveMessagesfromMsgINV::PageSetups")
            Return Nothing
        End Try
    End Function
#End Region

#Region "SalesMan" ' Add By Prashant On 02 Jul 2019

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetSalesmanForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New SalesmanCode()
            Dim data As List(Of SalesMan) = obj.GetSalesmanForFgrd(whereCondition, sortExp, start, rp)

            Session("SalesmanAllList") = Nothing
            Session("SalesmanAllList") = data
            Dim SelectedDetails As New ArrayList()
            If Not Context.Session("SelectedSalesman") Is Nothing Then
                SelectedDetails = Context.Session("SelectedSalesman")
                For Each Item In data
                    Dim hasItem = SelectedDetails.Cast(Of String).Where(Function(i) i.Equals(Item.ID.ToString)).FirstOrDefault()
                    If Not hasItem Is Nothing Then
                        Item.Selected = True
                    End If
                Next
            End If
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"Salesman", "Name", "Email"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                dt.Columns("AirlineType").ColumnName = "Type"

                'dt.Rows.RemoveAt(dt.Rows.Count - 1)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "FarmDet$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<b><a href='#' id='DeleteSalesman_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<b><a href='#' id='EditSalesman_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.SalesMan),
                                        New XElement("cell", row.Name),
                                        New XElement("cell", row.Email)))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesmanForFgrd::PageSalesmanCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesManList() As List(Of SalesMan)
        Try
            Return SalesmanCode.GetSalesManList()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesManList")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesManByCode(ByVal code As String) As SalesMan
        Try
            Return SalesmanCode.GetSalesManByCode(code)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesManByCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesManByID(ByVal ID As String) As SalesMan
        Try
            Return SalesmanCode.GetSalesManByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesManByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveSalesManCode(ByVal ID As String, ByVal SALESMAN As String, ByVal NAME As String, ByVal EMAIL As String, ByVal COLORCODE As Int16, ByVal PRODUCTS As String) As String
        Try
            Dim SalesManId As String = ""
            If (ID = "0") Then
                SalesManId = SalesmanCode.InsertSalesMan(SALESMAN, NAME, EMAIL, COLORCODE, PRODUCTS)
            Else
                SalesManId = SalesmanCode.UpdateSalesMan(Convert.ToInt32(ID), SALESMAN, NAME, EMAIL, COLORCODE, PRODUCTS)
            End If
            If (Not SalesManId.Contains("UNIQUE KEY constraint")) Then
                Return SalesManId
            Else
                Return SalesManId
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveSalesManCode::PageSalesManCode")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteSalesManByID(ByVal ID As String) As String
        Try
            Return SalesmanCode.DeleteSalesManbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteSalesManbyID")
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' Prashant ::02-Jun-2019::To get Sales man code lists
    ''' </summary>
    ''' <returns></returns>   
    '''     
    <System.Web.Services.WebMethod(True)>
    Public Function GetSalesManCodeList() As List(Of SalesMan)
        Try
            Return SalesmanCode.GetSalesManCodeList()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetSalesManCodeList")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Warehouse Freight" ' Add By Prashant On 02 Jul 2019
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetWarehouseFreightForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, Filter As String, ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Users), qtype, query)
            End If

            If (Filter <> String.Empty And whereCondition Is String.Empty) Then
                whereCondition = Filter.Replace("&amp;", "&")
            ElseIf (Filter <> String.Empty And whereCondition IsNot String.Empty) Then
                whereCondition = whereCondition + " AND " + Filter.Replace("&amp;", "&")
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim obj As New Warehouses.WarehouseFreight()
            Dim data As List(Of Warehouse) = obj.GetWarehouseFreightForFgrd(whereCondition, sortExp, start, rp)

            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                Dim dt1 As DataTable

                dt1 = ConvertToDataTable(data)
                Dim selectedColumns As String() = {"WH", "AIRPORT", "FREIGHT"}

                Dim dt As DataTable = New DataView(dt1).ToTable(False, selectedColumns)
                Dim dtCloned As DataTable = dt.Clone()
                For Each row As DataRow In dt.Rows
                    dtCloned.ImportRow(row)
                Next
                Dim filepath = ExporttoExcel(dtCloned, "WarehouseFreight$Files")
                Return BuildXmlDoc(filepath)
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<b><a href='#' id='DeleteWarehouseFreight_" & row.ID & "'><img src='images/Delete-icon.png'/></a></b>"),
                                        New XElement("cell", "<b><a href='#' id='EditWarehouseFreight_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.WH),
                                        New XElement("cell", row.AIRPORT),
                                        New XElement("cell", row.FREIGHT.ToString("#,##0.00"))))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWarehouseFreightForFgrd::PageWarehouseFreight")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetWarehouseFreightByID(ByVal ID As Integer) As Warehouse
        Try
            Return Warehouses.WarehouseFreight.GetWarehouseFreightByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetWarehouseFreightByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveWarehouseFreight(ByVal ID As String, ByVal WH As String, ByVal AIRPORT As String, ByVal FREIGHT As Double) As String
        Try
            Dim Message As String = ""
            If (ID = "0") Then
                Message = Warehouses.WarehouseFreight.InsertWarehouseFreight(WH, AIRPORT, FREIGHT)
            Else
                Message = Warehouses.WarehouseFreight.UpdateWarehouseFreight(ID, WH, AIRPORT, FREIGHT)
            End If
            Return Message
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveWarehouseFreight::PageWarehouseFreight")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteWarehouseFreightByID(ByVal ID As String) As String
        Try
            Return Warehouses.WarehouseFreight.DeleteWarehouseFreightByID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteWarehouseFreightByID")
            Return Nothing
        End Try
    End Function
#End Region


#Region "New Armellini XML"
    Public Function ArXML1(ByVal ARRequestXml As String, ByVal OrderNo As String) As String
        Dim User As New User
        Try
            If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginUserDetails")
            ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
                User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
            End If
            Dim clientService As New DataEntryService.DataEntryPortClient
            Dim authHeader As New DataEntryService.AuthHeader
            Dim aelisShipperEDI As New DataEntryService.AelisShipperEDI
            Dim orderHeader As New DataEntryService.OrderHeader
            Dim orderDetails As New List(Of DataEntryService.OrderDetail)
            Dim aELOrderResponse As New DataEntryService.AELOrderResponse

            Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

            authHeader.Username = ConfigurationManager.AppSettings("ArmelliniUserName").ToString()
            authHeader.Password = ConfigurationManager.AppSettings("ArmelliniPassword").ToString()

            Dim responsedoc As XmlDocument = New XmlDocument()
            responsedoc.LoadXml(ARRequestXml)

            Dim xmlrequestReader As XmlReader = New XmlNodeReader(responsedoc)
            Dim ns As XmlNamespaceManager = New XmlNamespaceManager(responsedoc.NameTable)
            ns.AddNamespace("N", "http://www.armellini.com/a4/schemas")


            Dim xmlTotalReqCount As XmlNodeList = responsedoc.SelectNodes("/N:AelisShipperEDI/N:OrderHeader/N:Shipdate", ns)


            If xmlTotalReqCount.Count > 0 Then
                orderHeader.Shipdate = xmlTotalReqCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim()
            End If
            'orderHeader.Shipper = ConfigurationManager.AppSettings("ArmelliniShipper").ToString()
            Dim dt As DataTable
            dt = ArmelliniXML.GetOrderDetailsForXML(OrderNo)
            If dt.Rows.Count > 0 Then
                orderHeader.Shipper = dt.Rows(0)("ConstantArmellini")
            Else
                orderHeader.Shipper = ""
            End If

            If orderHeader.Shipper Is Nothing Or orderHeader.Shipper = "" Then
                Dim content = ""
                content = "Shipper not defined"
                ArmelliniXML.InsertArmelliniXMLLogs(ARRequestXml, "", "", content, False, "Error", "", OrderNo, 0, 0, "", "", If(User Is Nothing, "", User.Name))
                Dim companyname As String = ConfigurationManager.AppSettings("CompanyName")
                Dim unused = Logs.SendMail(FromEmail, If(User.Email Is Nothing, "jose@dflower.com", User.Email), ARRequestXml, "", "" + companyname + " - " + " AR - " + OrderNo + " - Shipper is empty")
                Return content
            End If
            Dim isvalidconsignee As Boolean = True

            If dt.Rows.Count > 0 Then
                For i As Integer = 0 To dt.Rows.Count - 1
                    Dim orderDetail As New DataEntryService.OrderDetail
                    orderDetail.UnitID = IIf(dt.Rows(i)("LabelCode") Is DBNull.Value And dt.Rows(i)("ARBoxNo") Is DBNull.Value, "", Convert.ToString(dt.Rows(i)("LabelCode")) + Convert.ToString(dt.Rows(i)("ARBoxNo")))
                    orderDetail.UnitOfMeasure = "Box"
                    orderDetail.Consignee = IIf(dt.Rows(i)("Consignee") Is DBNull.Value, "", Convert.ToString(dt.Rows(i)("Consignee")))
                    If orderDetail.Consignee = "" Then
                        isvalidconsignee = False
                        Exit For
                    End If
                    orderDetail.Length = IIf(dt.Rows(i)("L") Is DBNull.Value, 0, Convert.ToString(dt.Rows(i)("L")))
                    orderDetail.Width = IIf(dt.Rows(i)("W") Is DBNull.Value, 0, Convert.ToString(dt.Rows(i)("W")))
                    orderDetail.Height = IIf(dt.Rows(i)("H") Is DBNull.Value, 0, Convert.ToString(dt.Rows(i)("H")))
                    orderDetail.Invoice = IIf(dt.Rows(i)("OrderNo") Is DBNull.Value, "", Convert.ToString(dt.Rows(i)("OrderNo")))
                    orderDetail.Product_Description = IIf(dt.Rows(i)("Product") Is DBNull.Value, "", Convert.ToString(dt.Rows(i)("Product")))
                    orderDetail.PO = IIf(dt.Rows(i)("PONumber") Is DBNull.Value, "", Convert.ToString(dt.Rows(i)("PONumber")))
                    orderDetail.Measure = "Inch"
                    orderDetails.Add(orderDetail)
                Next
            End If

            If Not isvalidconsignee Then
                Dim content = ""
                content = "Missing Consignee"
                ArmelliniXML.InsertArmelliniXMLLogs(ARRequestXml, "", "", content, False, "Error", "", OrderNo, 0, 0, "", "", If(User Is Nothing, "", User.Name))
                Dim companyname As String = ConfigurationManager.AppSettings("CompanyName")
                Dim unused1 = Logs.SendMail(FromEmail, If(User.Email Is Nothing, "jose@dflower.com", User.Email), ARRequestXml, "", "" + companyname + " - " + " AR - " + OrderNo + " - Shipper is empty")
                Return content
            End If

            aelisShipperEDI.OrderHeader = orderHeader
            aelisShipperEDI.OrderDetail = orderDetails.ToArray()

            'Getting Response from Armellini
            aELOrderResponse = clientService.AelisShipperEDI(authHeader, aelisShipperEDI)
            If aELOrderResponse.ResponseHeader IsNot Nothing Then
                'Generate Response XML
                Dim responsedet As New List(Of DataEntryService.ResponseDetail)
                If aELOrderResponse.ResponseDetail IsNot Nothing Then
                    For Each resdet As DataEntryService.ResponseDetail In aELOrderResponse.ResponseDetail
                        responsedet.Add(resdet)
                    Next
                End If
                If GenerateResponseXml(aELOrderResponse.ResponseHeader, IIf(aELOrderResponse.ResponseDetail IsNot Nothing, responsedet, Nothing)) = "success" Then
                    Return isArXMLGenerated(aELOrderResponse.ResponseHeader, ARRequestXml, orderHeader.Shipdate, OrderNo, "", "", IIf(aELOrderResponse.ResponseDetail IsNot Nothing, True, False))
                Else
                    Return aELOrderResponse.ResponseHeader.errorMessage
                End If
            Else
                'Return aELOrderResponse.ResponseHeader.errorMessage
                Return Nothing
            End If
        Catch ex As Exception
            ArmelliniXML.InsertArmelliniXMLLogs(ARRequestXml, "", "", ex.Message.ToString(), False, "Exception", "", OrderNo, 0, 0, "", "", If(User Is Nothing, "", User.Name))
            ErrorLogs.LogException(ex, "Error In Service::ArXML1::PageOrder")
            Return ex.Message.ToString()
        End Try
    End Function

    Public Function GenerateResponseXml(ByVal responsehdr As DataEntryService.ResponseHeader, Optional ByVal responsedet As List(Of DataEntryService.ResponseDetail) = Nothing) As String
        Try
            Dim xml As XElement

            If responsedet Is Nothing Then
                xml = New XElement("Response",
                                  New XElement("ResponseHeader",
                                    New XElement("errorMessage", IIf(responsehdr.errorMessage Is Nothing, "", responsehdr.errorMessage)),
                                    New XElement("orderNumber", responsehdr.orderNumber),
                                    New XElement("shipdate", responsehdr.shipdate),
                                    New XElement("shipper", responsehdr.shipper),
                                    New XElement("totalUnitsDiscrepancy", responsehdr.totalUnitsDiscrepancy),
                                    New XElement("totalUnitsDuplicates", responsehdr.totalUnitsDuplicates),
                                    New XElement("totalUnitsInFile", responsehdr.totalUnitsInFile),
                                    New XElement("totalUnitsSuccess", responsehdr.totalUnitsSuccess)))
            Else
                xml = New XElement("Response",
                                    New XElement("ResponseHeader",
                                    New XElement("errorMessage", IIf(responsehdr.errorMessage Is Nothing, "", responsehdr.errorMessage)),
                                    New XElement("orderNumber", responsehdr.orderNumber),
                                    New XElement("shipdate", responsehdr.shipdate),
                                    New XElement("shipper", responsehdr.shipper),
                                    New XElement("totalUnitsDiscrepancy", responsehdr.totalUnitsDiscrepancy),
                                    New XElement("totalUnitsDuplicates", responsehdr.totalUnitsDuplicates),
                                    New XElement("totalUnitsInFile", responsehdr.totalUnitsInFile),
                                    New XElement("totalUnitsSuccess", responsehdr.totalUnitsSuccess)),
                                   From resdet In responsedet
                                   Select New XElement("ResponseDetail",
                                        New XElement("consignee", resdet.consignee),
                                                New XElement("consignee_name", resdet.consignee_name),
                                                New XElement("unitsSuccess", resdet.unitsSuccess),
                                                New XElement("unitsFailed", resdet.unitsFailed),
                                                New XElement("message", resdet.message),
                                                New XElement("unitFailedDetailCount", resdet.unitFailedDetail.Count),
                                                From unit In resdet.unitFailedDetail
                                                Select New XElement("unitFailedDetail",
                                                    New XElement("UnitID", unit))))
            End If
            ResponseXml = xml.ToString()
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error In Service::GenerateResponseXml::PageOrder")
            Return "error"
        End Try
    End Function

    Public Function isArXMLGenerated(ByVal responsehdr As DataEntryService.ResponseHeader, ByVal ARRequestXml As String, ByVal shipdate As String, ByVal orderno As String, ByVal consignee As String, ByVal boxno As String, ByVal isResponseDet As Boolean) As String
        Dim User As New User
        If Not System.Web.HttpContext.Current.Session("LoginUserDetails") Is Nothing Then
            User = System.Web.HttpContext.Current.Session("LoginUserDetails")
        ElseIf Not System.Web.HttpContext.Current.Session("LoginAdminDetails") Is Nothing Then
            User = System.Web.HttpContext.Current.Session("LoginAdminDetails")
        End If

        Dim subject As String = "", companyname As String = "", subjectconsignee As String = "", body As String = "", barcodeaccount As String = "",
         tmpResponsexml As String = "", invno As String = "", armellinifilename As String = "", subjectboxno As String = "", datatime As String = "", Responsemessage As String = "", VendorEmailPath As String = ""
        Try
            companyname = ConfigurationManager.AppSettings("CompanyName")
            Dim doc As XmlDocument = New XmlDocument()
            doc.LoadXml(ARRequestXml)
            Dim invoiceno As String = ""

            Dim toemail As String = ""
            Dim isSuccess As Boolean = False

            Dim xmlrequestReader As XmlReader = New XmlNodeReader(doc)
            Dim ns As XmlNamespaceManager = New XmlNamespaceManager(doc.NameTable)
            ns.AddNamespace("N", "http://www.armellini.com/a4/schemas")


            Dim emailnodeList As XmlNodeList = doc.SelectNodes("/N:AelisShipperEDI/N:OrderHeader/N:DFlowerEmail", ns)
            toemail = emailnodeList.Item(0).InnerText

            Dim shipdatelist As XmlNodeList = doc.SelectNodes("/N:AelisShipperEDI/N:OrderHeader/N:Shipdate", ns)
            shipdate = shipdatelist.Item(0).InnerText

            'New Armellini Email Subject Format
            Try
                Dim invoicelist As XmlNodeList = doc.SelectNodes("/N:AelisShipperEDI/N:OrderDetail/N:Invoice", ns)
                If (invoicelist.Count > 0) Then
                    invoiceno = invoicelist.Item(0).InnerText
                End If
            Catch ex As Exception
                Dim invoicelist As XmlNodeList = doc.SelectNodes("/N:AelisShipperEDI/N:OrderDetail/N:Invoice", ns)
                invoiceno = invoicelist.Item(0).InnerText
            End Try
            'New Armellini Email Subject Format

            invno = invoiceno.TrimStart(New Char() {"0"})
            invoiceno = invno
            invoiceno = "Invoice# " + invoiceno + ""

            'New Armellini Email Subject Format
            'Dim barcodelist As XmlNodeList = doc.SelectNodes("/AelisShipperEDI/OrderHeader/BarCodeAccount")
            'If barcodelist.Count > 0 Then
            '    barcodeaccount = barcodelist.Item(0).InnerText
            '    barcodeaccount = barcodeaccount + " - "
            'Else
            barcodeaccount = ""
            'End If


            'get  BoxNo 
            Dim boxnolist As XmlNodeList = doc.SelectNodes("/N:AelisShipperEDI/N:OrderDetail/N:UnitID", ns)
            If boxnolist.Count > 0 Then
                boxno = boxnolist.Item(0).InnerText
                subjectboxno = "UnitID# " + boxno
            Else
                boxno = ""
                subjectboxno = ""
            End If
            'New Armellini Email Subject Format

            'get  consignee 
            Dim dsconsignee As New DataSet()
            Dim dtconsignee As New DataTable()
            Dim dtconsdistinct As New DataTable()
            Dim XmlReader = New XmlNodeReader(doc)
            dsconsignee.ReadXml(XmlReader)
            If (dsconsignee.Tables.Contains("OrderDetail")) Then
                dtconsignee = dsconsignee.Tables("OrderDetail")
                If (dtconsignee.Rows.Count > 0 And dtconsignee.Columns.Contains("Consignee")) Then 'single consignee
                    dtconsdistinct = dtconsignee.DefaultView.ToTable(True, "Consignee")
                    'New Armellini Email Subject Format
                    consignee = If(dtconsdistinct.Rows(0)("Consignee") Is DBNull.Value, "", dtconsdistinct.Rows(0)("Consignee").ToString())
                    If (dtconsdistinct.Rows.Count = 1) Then
                        subjectconsignee = "Consignee: " + If(consignee = "", "'Not Exist'", consignee) + ""
                    ElseIf (dtconsdistinct.Rows.Count > 1) Then 'multiple consignee
                        subjectconsignee = "Consignee: " + If(consignee = "", "'Not Exist'", consignee) + " + Others"
                    End If
                    'New Armellini Email Subject Format
                Else
                    consignee = ""
                    subjectconsignee = ""
                End If
            Else
                consignee = ""
                subjectconsignee = ""

            End If

            Dim finvoice As String = ""
            If (invno.Trim().Length < 7) Then
                finvoice = invno.Trim().PadLeft(7, "0")
            Else
                finvoice = invno.Trim()
            End If

            Dim TotalUnitsInFileCount = 0, TotalUnitsSuccessCount = 0, TotalUnitsDuplicatesCount = 0, TotalUnitsDiscrepancyCount = 0, TotalunitFailedDetailCount = 0

            VendorEmailPath = ConfigurationManager.AppSettings("VendorEmailsFolder") + "\XML"
            If (Not Directory.Exists(VendorEmailPath)) Then
                Directory.CreateDirectory(VendorEmailPath)
            End If

            Dim responsedoc As XmlDocument = New XmlDocument()
            responsedoc.LoadXml(ResponseXml)

            'Getting All Response counts from Armellini 
            Dim xmlTotalUnitsInFileCount As XmlNodeList = responsedoc.SelectNodes("/Response/ResponseHeader/totalUnitsInFile"),
             xmlTotalUnitsSuccessCount As XmlNodeList = responsedoc.SelectNodes("/Response/ResponseHeader/totalUnitsSuccess"),
             xmlTotalUnitsDuplicatesCount As XmlNodeList = responsedoc.SelectNodes("/Response/ResponseHeader/totalUnitsDuplicates"),
             xmlTotalUnitsDiscrepancyCount As XmlNodeList = responsedoc.SelectNodes("/Response/ResponseHeader/totalUnitsDiscrepancy")

            If xmlTotalUnitsInFileCount.Count > 0 Then
                TotalUnitsInFileCount = IIf(xmlTotalUnitsInFileCount.Item(0).InnerText = "", 0, xmlTotalUnitsInFileCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim())
            End If
            If xmlTotalUnitsSuccessCount.Count > 0 Then
                TotalUnitsSuccessCount = IIf(xmlTotalUnitsSuccessCount.Item(0).InnerText = "", 0, xmlTotalUnitsSuccessCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim())
            End If
            If xmlTotalUnitsDuplicatesCount.Count > 0 Then
                TotalUnitsDuplicatesCount = IIf(xmlTotalUnitsDuplicatesCount.Item(0).InnerText = "", 0, xmlTotalUnitsDuplicatesCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim())
            End If
            If xmlTotalUnitsDiscrepancyCount.Count > 0 Then
                TotalUnitsDiscrepancyCount = IIf(xmlTotalUnitsDiscrepancyCount.Item(0).InnerText = "", 0, xmlTotalUnitsDiscrepancyCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim())
            End If

            Dim xmlTotalResponseDetailCount As XmlNodeList = responsedoc.SelectNodes("/Response/ResponseDetail"),
                xmlTotalunitFailedDetailCount As XmlNodeList = responsedoc.SelectNodes("/Response/ResponseDetail/unitFailedDetail")

            'If xmlTotalResponseDetailCount.Count > 0 Then
            '    TotalResponseDetailCount = IIf(xmlTotalResponseDetailCount.Item(0).InnerText = "", 0, xmlTotalResponseDetailCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim())
            'End If
            'If xmlTotalunitFailedDetailCount.Count > 0 Then
            '    TotalunitFailedDetailCount = IIf(xmlTotalunitFailedDetailCount.Item(0).InnerText = "", 0, xmlTotalunitFailedDetailCount.Item(0).InnerText.Replace("/n", "").Replace("\n", "").Trim())
            'End If

            Dim Errdetails As XmlNodeList = responsedoc.SelectNodes("/Response/ResponseHeader/errorMessage")
            If Errdetails.Count > 0 AndAlso (Errdetails.Item(0).InnerText = "" And Errdetails.Item(0).InnerText = Nothing) AndAlso TotalUnitsInFileCount = TotalUnitsSuccessCount Then
                isSuccess = True
                datatime = DateTime.Now.ToString(" MM-dd-yy hh mm ss")
                armellinifilename = "I" + finvoice + datatime + ".xml"
                Responsemessage = String.Format("Successfully Uploaded {0} of {1} Boxes", TotalUnitsSuccessCount, TotalUnitsInFileCount)
                Try
                    'objDbfService.CreateArmelliniXMLFile(ARRequestXml, armellinifilename, True)
                Catch ex As Exception
                    AppendLog(ex.Message, "isArXMLGenerated")
                End Try
            ElseIf Errdetails.Count > 0 AndAlso (Errdetails.Item(0).InnerText = "" And Errdetails.Item(0).InnerText = Nothing) Then
                isSuccess = False
                datatime = DateTime.Now.ToString(" MM-dd-yy hh mm ss")
                armellinifilename = "I" + finvoice + datatime + ".xml"
                Try
                    'objDbfService.CreateArmelliniXMLFile(ARRequestXml, armellinifilename, True)
                Catch ex As Exception
                    AppendLog(ex.Message, "isArXMLGenerated")
                End Try
                For i As Integer = 0 To xmlTotalResponseDetailCount.Count - 1
                    Dim getxml = xmlTotalResponseDetailCount.Item(i).InnerXml
                    If getxml <> "" Then
                        getxml = "<ResponseDetail>" + getxml + "</ResponseDetail>"
                        responsedoc = New XmlDocument()
                        responsedoc.LoadXml(getxml)

                        'New Armellini Email Subject Format
                        Dim getconsigneename = responsedoc.SelectNodes("/ResponseDetail/consignee_name")
                        Responsemessage += " " + If(String.IsNullOrEmpty(Convert.ToString(getconsigneename.Item(0).InnerText)), "", getconsigneename.Item(0).InnerText + " - ")
                        Dim getmessage = responsedoc.SelectNodes("/ResponseDetail/message")
                        Responsemessage += " " + If(String.IsNullOrEmpty(Convert.ToString(getmessage.Item(0).InnerText)), "", getmessage.Item(0).InnerText)
                        'New Armellini Email Subject Format

                        'New Armellini service - add emoji to subject
                        Dim errmsg = If(String.IsNullOrEmpty(Convert.ToString(getmessage.Item(0).InnerText)), "", getmessage.Item(0).InnerText)
                        If errmsg.Trim().ToLower() <> "the unit id was already received" Then
                            isArxmlfails = True
                        End If
                        'New Armellini service - add emoji to subject

                        'New Armellini Email Subject Format
                        Dim getunitFailedDetailCount = responsedoc.SelectNodes("/ResponseDetail/unitFailedDetail/UnitID")
                        If getunitFailedDetailCount.Count > 0 Then
                            Responsemessage += " for "
                            Responsemessage += " " + If(String.IsNullOrEmpty(Convert.ToString(getunitFailedDetailCount(0).InnerText)), "", getunitFailedDetailCount(0).InnerText + "")
                            If getunitFailedDetailCount.Count > 0 Then
                                Responsemessage += " + Others "
                            End If
                        End If
                        'New Armellini Email Subject Format
                    End If
                Next
                Responsemessage += String.Format(" Successfully Uploaded {0} of {1} Boxes", TotalUnitsSuccessCount, TotalUnitsInFileCount)
                'New Armellini Email Subject Format
            Else
                isSuccess = False
                isArxmlfails = True 'New Armellini
                datatime = DateTime.Now.ToString(" MM-dd-yy hh mm ss")
                armellinifilename = "I" + finvoice + datatime + ".xml"
                Responsemessage = String.Format("Successfully Uploaded {0} of {1} Boxes", TotalUnitsSuccessCount, TotalUnitsInFileCount)
                Responsemessage += " " + Errdetails.Item(0).InnerText.Replace(vbLf, "")
                Try
                    'objDbfService.CreateArmelliniXMLFile(ARRequestXml, armellinifilename, False)
                Catch ex As Exception
                    AppendLog(ex.Message, "isArXMLGenerated")
                End Try
            End If

            If Responsemessage.Contains("""") Then
                Responsemessage = Responsemessage.Replace("""", "'")
            End If
            If isSuccess Then
                'Generating file
                Dim XMLFileName As String = "ARXML_" + orderno + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".XML"

                Dim filepath As String = VendorEmailPath & "\" & XMLFileName
                Dim ArmelliniXmlFolder As String = ConfigurationManager.AppSettings("ArmelliniXMLEmailsFolder")
                Dim CarrierEmailxmlNameFolderName As String = ConfigurationManager.AppSettings("ArmelliniXML")
                Dim Carrierfilepath As String = ArmelliniXmlFolder + "\" + CarrierEmailxmlNameFolderName + "\" + XMLFileName
                If File.Exists(filepath) Then
                    File.WriteAllText(filepath, "")
                    Using writer As New StreamWriter(filepath, True)
                        writer.WriteLine(ARRequestXml)
                    End Using
                Else
                    Dim writer As StreamWriter = File.CreateText(filepath)
                    writer.WriteLine(ARRequestXml)
                    writer.Close()
                End If

                Dim canSendAllArmelliniEmails As Boolean = If(ConfigurationManager.AppSettings("SendAllArmelliniEmails").ToString() = "1", True, False)
                If canSendAllArmelliniEmails Then
                    subject = barcodeaccount + companyname + " ARXML " + orderno + "  " + shipdate + "  " + subjectconsignee + "  " + Responsemessage + "  " + subjectboxno
                    Logs.ManualPOEmailLogs(VendorFromEmails, toemail, vbCrLf + vbCrLf + "--From web", XMLFileName, subject)
                End If
                Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")

                Try
                    'inserting the response message in the history file for the order
                    'objDbfService.InsertLogInHistoryFileForARXML(orderno, "ARXML From Web - " + Responsemessage, IIf(User Is Nothing, "", User.Name))
                Catch ex As Exception

                End Try
                Dim tmpmessage As String = Responsemessage.ToLower()
                Dim successmessage As String() = tmpmessage.Split(New String() {"of"}, StringSplitOptions.None)
                Dim totalboxessend = Convert.ToInt32(Regex.Replace(successmessage(1), "[^0-9]+", String.Empty))
                Dim totalboxesupload = Convert.ToInt32(Regex.Replace(successmessage(0), "[^0-9]+", String.Empty))
                ArmelliniXML.InsertArmelliniXMLLogs(ARRequestXml, armellinifilename, ResponseXml, Responsemessage, isSuccess, "Success", shipdate, orderno, totalboxessend, totalboxesupload, consignee, boxno, If(User Is Nothing, "", User.Name))
            Else
                Dim XMLFileName As String = "ARXML_" + orderno + "_" + DateTime.Now.ToString("yyyyMMdd hhmmssfff") + ".XML"

                Dim filepath As String = VendorEmailPath & "\" & XMLFileName
                Dim ArmelliniXmlFolder As String = ConfigurationManager.AppSettings("ArmelliniXMLEmailsFolder")
                Dim CarrierEmailxmlNameFolderName As String = ConfigurationManager.AppSettings("ArmelliniXML")
                Dim Carrierfilepath As String = ArmelliniXmlFolder + "\" + CarrierEmailxmlNameFolderName + "\" + XMLFileName
                If File.Exists(filepath) Then
                    File.WriteAllText(filepath, "")
                    Using writer As New StreamWriter(filepath, True)
                        writer.WriteLine(ARRequestXml)
                    End Using

                Else
                    Dim writer As StreamWriter = File.CreateText(filepath)
                    writer.WriteLine(ARRequestXml)
                    writer.Close()
                End If

                'New - armellini service - if error on new armellini service, send mail subject with emoji
                Dim addsmiley = ""
                If isArxmlfails Then
                    For j As Integer = 0 To 4
                        addsmiley += Encoding.UTF8.GetString(New Byte() {&HE2, &H9C, &H96})
                    Next
                End If
                'subject = barcodeaccount + companyname + " ARXML " + invoiceno + "  " + shipdate + "  " + subjectconsignee + "  " + Responsemessage + "  " + subjectboxno
                subject = addsmiley + " " + barcodeaccount + companyname + " ARXML " + invoiceno + "  " + shipdate + "  " + subjectconsignee + "  " + Responsemessage + "  " + subjectboxno
                'New - armellini service - if error on new armellini service, send mail subject with emoji

                subject = subject.Replace("\n", "")
                Logs.ManualPOEmailLogs(VendorFromEmails, toemail, ResponseXml + vbCrLf + vbCrLf + "--From web", XMLFileName, subject)
                Dim FromEmail As String = ConfigurationManager.AppSettings("VendorFromEmails")
                ArmelliniXML.InsertArmelliniXMLLogs(ARRequestXml, armellinifilename, ResponseXml, Responsemessage, isSuccess, "Error", shipdate, orderno, TotalUnitsInFileCount, TotalUnitsSuccessCount, consignee, boxno, If(User Is Nothing, "", User.Name))
                Try
                    'inserting the response message in the history file for the order
                    'objDbfService.InsertLogInHistoryFileForARXML(orderno, "ARXML From Web - " + Responsemessage, IIf(User Is Nothing, "", User.Name))
                Catch ex As Exception

                End Try
            End If
            isArxmlfails = False 'New - armellini service
            Return ResponseXml
        Catch ex As Exception
            isArxmlfails = False 'New - armellini service
            Dim BodyResponseMessage As String = ""
            If ex.Message.Length > 127 Then
                BodyResponseMessage = ex.Message.Substring(0, 127)
            Else
                BodyResponseMessage = ex.Message
            End If
            If (ex.Message.Contains("Error uploading xml. Invalid use") = True) Then  'Check Credentials error 
                subject = companyname + " ARXML:" + " Invalid Credentials used for the armellni service.Please check"

                body = ex.Message.ToString()

                Logs.ManualPOEmailLogs(VendorFromEmails, "jose@dflower.com", body + vbCrLf + vbCrLf + "--From web", "", subject)
                'ArmelliniXML.InsertArmelliniXMLLogs(sXml, "", "", ex.Message.Substring(0, 127), False, "Exception", "", "", 0, 0, "", "")
                'ArmelliniXML.InsertArmelliniXMLLogs(sXml, "", "", BodyResponseMessage, False, "Exception", "", "", 0, 0, "", "", User.UserName)
                ArmelliniXML.InsertArmelliniXMLLogs(ARRequestXml, "", "", ex.Message.ToString(), False, "Exception", shipdate, orderno, 0, 0, consignee, boxno, If(User Is Nothing, "", User.Name))
            Else

                'ArmelliniXML.InsertArmelliniXMLLogs(sXml, "", "", ex.Message.Substring(0, 127), False, "Exception", shipdate, invno, 0, 0, consignee, BoxNo)
                'ArmelliniXML.InsertArmelliniXMLLogs(sXml, "", "", BodyResponseMessage, False, "Exception", shipdate, invno, 0, 0, consignee, boxno, User.Name)
                ArmelliniXML.InsertArmelliniXMLLogs(ARRequestXml, "", "", ex.Message.ToString(), False, "Exception", shipdate, orderno, 0, 0, consignee, boxno, If(User Is Nothing, "", User.Name))

            End If
            ErrorLogs.LogException(ex, "Error In Service::isArXMLGenerated::PageOrder")
            If ex.Message.Contains("Invalid use") Then
                Return "Invalid username or password"
            Else
                Return "error:" + ex.Message
            End If
        End Try
    End Function

#End Region
#Region "Order Types"
    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetOrderTypesDetailsForFgrd(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Airport), qtype, query)
            End If


            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1

            Dim OrdertypesList = Nothing
            Dim obj As New DAO.OrderTypes
            OrdertypesList = obj.GetOrderTypesListForFgrd(whereCondition, sortExp, start, rp)
            If (ExportCSV <> "") Then
                Dim splitExportcsv = ExportCSV.Split("|")
                If (TryCast(OrdertypesList, Tuple(Of DataSet, String)).Item1.Tables(1).Rows(0)(0) <= 0) Then
                    Return Nothing
                End If
                If Convert.ToString(TryCast(OrdertypesList, Tuple(Of DataSet, String)).Item2) = "success" Then
                    Dim selectedColumns As String() = {"OrderTypeCode", "Desc", "Repeat", "Frequency"}
                    Dim dt As DataTable = New DataView(TryCast(OrdertypesList, Tuple(Of DataSet, String)).Item1.Tables(0)).ToTable(False, selectedColumns)
                    Dim filepath = ExporttoExcel(dt, splitExportcsv(1) + "OrderTypes$Files")
                    Return BuildXmlDoc(filepath)
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, OrdertypesList(0).ErrorMessage, "", "Error Notification", "Error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim dtOrdertypesList As New DataSet
                If Not TryCast(OrdertypesList, Tuple(Of DataSet, String)).Item1 Is Nothing Then
                    dtOrdertypesList = TryCast(OrdertypesList, Tuple(Of DataSet, String)).Item1
                Else
                    Dim newDoc1 As New XmlDocument()
                    newDoc1.LoadXml("<rows><total>0</total></rows>")
                    Return newDoc1
                End If
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", dtOrdertypesList.Tables(1).Rows(0)(0)),
                                                     From row In dtOrdertypesList.Tables(0).Rows()
                                                     Select
                                                     New XElement("row", New XAttribute("id", row("OrderTypeId")),
                                                     New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteOrderTypes_" & row("OrderTypeId") & "'/>"),
                                                     New XElement("cell", "<img href='#' src='images/Edit.png' style='cursor:pointer' id='EditOrderTypes_" & row("OrderTypeId") & "'/>"),
                                                     New XElement("cell", row("OrderTypeCode")),
                                                     New XElement("cell", row("Desc")),
                                                     New XElement("cell", If(row("Repeat") = True, "Y", "N")),
                                                     New XElement("cell", row("Frequency")))))

                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(xmlDoc.ToString())
                Return newDoc
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderTypesDetailsForFgrd")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderTypesDetailByID(ByVal ID As Integer) As List(Of BO.OrderType)
        Try
            Dim data As List(Of BO.OrderType) = DAO.OrderTypes.GetOrderTypeDetailByID(ID)
            Return data
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderTypesDetailByID::PageOrderTypes")
            Throw ex
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveOrderTypes(ByVal ID As String, ByVal OrderTypesCode As String, ByVal OrderTypesDesc As String, ByVal OrderTypesRepeat As String, ByVal OrderTypesFrequency As String) As String
        Try
            Dim OrderTypesID As String = ""

            If (ID = "0") Then
                OrderTypesID = DAO.OrderTypes.InsertOrderTypes(OrderTypesCode, OrderTypesDesc, If(OrderTypesRepeat.Trim() = "" Or OrderTypesRepeat.ToLower().Trim() = "N".ToLower(), False, True), OrderTypesFrequency)
            Else

                OrderTypesID = DAO.OrderTypes.UpdateOrderTypes(ID, OrderTypesCode, OrderTypesDesc, If(OrderTypesRepeat.Trim() = "" Or OrderTypesRepeat.ToLower().Trim() = "N".ToLower(), False, True), OrderTypesFrequency)
            End If
            If (Not OrderTypesCode.Contains("UNIQUE KEY constraint")) Then
                Return OrderTypesID
            Else
                Return OrderTypesID
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveOrderTypes::PageOrderTypes")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteOrderTypesbyID(ByVal ID As String) As String
        Try
            Return DAO.OrderTypes.DeleteOrderTypesbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteOrderTypesbyID::PageOrderTypes")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetOrderTypesForAutoCompleteInSPORD(ByVal Searchtext As String) As List(Of BO.OrderType)
        Try
            Return DAO.OrderTypes.GetOrderTypesForAutoCompleteInSPORD(Searchtext)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetOrderTypesForAutoCompleteInSPORD")
            Return Nothing
        End Try
    End Function

#End Region

#Region "Sales Returns"
    <System.Web.Services.WebMethod(True)>
    Public Function GetInvoiceNumber() As String
        Try
            Return PostReturnsByCustomer.GetInvoiceNumber()

        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetInvoiceNumber")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetUOMFromPrices(ByVal Customer As String) As List(Of BOProd)
        Try
            Return PostReturnsByCustomer.GetUOMFromPrices(Customer)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetUOMFromPrices")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetFlowerAutoCompletePrices(ByVal Searchtext As String) As List(Of Flower)
        Try
            Return PostReturnsByCustomer.GetFlowerAutoCompletePrices(Searchtext)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetDescriptionPrices")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function TempCreditDetailsAddUpdDel(ByVal postReturnCustModel As PostReturnsByCustomerModel) As PostReturnsByCustomerModel
        Try
            Dim user As New User
            Dim returnCustModel As New PostReturnsByCustomerModel
            If Session("LoginUserDetails") Is Nothing Then
                returnCustModel.ErrorMessage = "LogOut"
            Else
                user = System.Web.HttpContext.Current.Session("LoginUserDetails")
                returnCustModel = PostReturnsByCustomer.TempCreditDetailsAddUpdDel(postReturnCustModel, user.ID)
            End If
            Return returnCustModel
        Catch ex As Exception
            ErrorLogs.LogException(ex, "TempCreditDetailsAddUpdDel")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetTempCreditDetailsList(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal Customer As String, ByVal ExportCSV As String) As XmlDocument
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Dim data = Nothing
            data = PostReturnsByCustomer.GetTempCreditDetailsList(Customer)



            Dim dt As DataTable = ConvertToDataTable(data)
            If dt.Rows.Count > 0 Then
                If Convert.ToString(dt(0)("ErrorMessage")) = "" Then

                    Dim TotalRowCount As Integer = 0

                    If dt.Rows.Count > 0 Then
                        TotalRowCount = dt.Rows.Count().ToString()
                    End If

                    Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                            New XElement("rows", New XElement("page", page.ToString()),
                                            New XElement("total", TotalRowCount),
                                            From row In dt.Rows()
                                            Select
                                            New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("background-color", ""), New XAttribute("color", ""),
                   New XElement("cell", "<img href='#'  id='SalesReturnDelete_" & Convert.ToString(row("ID")) & "' src='images/Delete-icon.png' style='cursor:pointer'/>"),
                   New XElement("cell", "<img href='#'  id='SalesReturnEdit_" & Convert.ToString(row("ID")) & "' src='images/Edit.png' style='cursor:pointer'/>"),
                                            New XElement("cell", "<a id='Customer_" + Convert.ToString(row("ID")) + "'>" + row.item("Customer").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Flower_" + Convert.ToString(row("ID")) + "'>" + row.Item("FlowerDetails").Flower.ToString() + "</a>"),
                                            New XElement("cell", "<div style='padding-bottom: 3px;cursor:pointer;background-color:" + row.Item("FlowerDetails").BGColor.ToString() + "' class='flowerDescription' title='" + Convert.ToString(row.Item("FlowerDetails").Name).Replace("'", "") + "'><a id='FlowerName" + Convert.ToString(row("ID")) + "' style='color:" + row.Item("FlowerDetails").FontColor.ToString() + ";'>" + row.Item("FlowerDetails").Name.ToString() + "</div>"),
                                            New XElement("cell", "<a id='Boxes_" + Convert.ToString(row("ID")) + "'>" + row.Item("Boxes").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Uom_" + Convert.ToString(row("ID")) + "'>" + row.Item("Uom").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Unit_" + Convert.ToString(row("ID")) + "'>" + row.Item("Unit").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Price_" + Convert.ToString(row("ID")) + "'>" + IIf(row.Item("Price").ToString() = 0, "", row.Item("Price").ToString()) + "</a>"),
                                            New XElement("cell", "<a id='Total_" + Convert.ToString(row("ID")) + "'>" + row.Item("Total").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Reasoncode_" + Convert.ToString(row("ID")) + "'>" + row.Item("Reasoncode").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Reason_" + Convert.ToString(row("ID")) + "'>" + row.Item("Reason").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Creditdate_" + Convert.ToString(row("ID")) + "'>" + row.Item("Creditdate").ToString() + "</a>"),
                                            New XElement("cell", "<a id='Notes_" + Convert.ToString(row("ID")) + "'>" + row.Item("Notes").ToString() + "</a>"))))

                    Dim newDoc As New XmlDocument()
                    newDoc.LoadXml(Convert.ToString(xmlDoc))
                    Return newDoc
                Else
                    Dim User As New User
                    If Not Session("LoginUserDetails") Is Nothing Then
                        User = Session("LoginUserDetails")
                    ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                        User = Session("LoginAdminDetails")
                    End If
                    Logs.SendErrorEmail(User, dt(0)("ErrorMessage"), "", "Error Notification", "error")
                    Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
                End If
            Else
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                 New XElement("rows", New XElement("page", page.ToString()),
                    New XElement("total", dt.Rows().Count().ToString()),
                    From row In dt.Rows()
                    Select
                    New XElement("row", New XAttribute("id", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", ""),
                    New XElement("cell", "")
                    )))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTempCreditDetailsList::F8 Screen")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ApplyCreditReturns(ByVal Invoice As String, ByVal Customer As String, ByVal TotalAmount As Decimal) As String
        Try
            Dim LoginUserDetails As New User

            If Not Session("LoginUserDetails") Is Nothing Then
                LoginUserDetails = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                LoginUserDetails = Session("LoginAdminDetails")
            End If

            Return PostReturnsByCustomer.ApplyCreditReturns(Invoice, Customer, LoginUserDetails.ID, TotalAmount)

        Catch ex As Exception
            ErrorLogs.LogException(ex, "ApplyCreditReturns")
            Return Nothing
        End Try
    End Function

#End Region


    ''sonu starts to save log on FARM change

    '<System.Web.Services.WebMethod(True)>
    'Public Function InsertPOLogHistory(ByVal PONUMBER As String, ByVal oldFarm As String, ByVal newFarm As String) As String

    '    Try
    '        Dim log As String = ""
    '        If oldFarm = newFarm Or oldFarm = "" Then
    '            Return ""
    '        End If
    '        log = "Change in PO Header : Farm From <b>[" & oldFarm & "]</b> to <b>[" & newFarm & "]</b>"
    '        Dim User As New User
    '        If Not Session("LoginUserDetails") Is Nothing Then
    '            User = Session("LoginUserDetails")
    '        ElseIf Not Session("LoginAdminDetails") Is Nothing Then
    '            User = Session("LoginAdminDetails")
    '        End If

    '        DAOPO.InsertPOHistoryLog(PONUMBER, log, User.ID)
    '        Return "success"
    '    Catch ex As Exception
    '        ErrorLogs.LogException(ex, "InsertLogHistory")
    '        Return Nothing
    '    End Try


    '    Return ""
    'End Function

    ''sonu ends

    <System.Web.Services.WebMethod(True)>
    Public Function MailJetHook(ByVal [event] As String, ByVal MessageID As String) As String
        Try
            SalesOrder.UpdateEmailStatus(MessageID, [event])
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "MailJetHook")
            Return Nothing
        End Try
        Return ""
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetDayOfService() As String
        Try
            If ArmelliniService.NeedUpdate() Then
                ArmelliniService.GetDayOfService()
                ' not used
                'FloridaBeautyService.SaveDayOfService(FloridaBeautyService.GetDayOfService())
            End If
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetDayOfService")
            Return Nothing
        End Try
        Return ""
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SaveDayOfService() As String
        Try
            ArmelliniService.SaveDayOfService()
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetDayOfService")
            Return Nothing
        End Try
        Return ""
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetLastProductSoldInfo(ByVal customer As String, ByVal flowercode As String) As Tuple(Of String, String, String)
        Try
            Dim result As Tuple(Of String, String, String) = Inventory.GetLastProductSoldInfo(customer, flowercode)
            Return result
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetLastProductSoldInfo")
            Return Nothing
        End Try
        Return New Tuple(Of String, String, String)("", "", "")
    End Function

    Function SalesOrderDayColumnFormat(ByVal day As String, ByVal hasMessages As Boolean, ByVal OrderNo As String) As String
        Dim value = IIf(day = "Today" Or day = String.Empty Or day = "", day, If(day.Length > 3, day.Substring(0, 3), ""))
        If hasMessages Then
            Return "<span id='Day_" + OrderNo + "' style='background: Red;padding: 6px 11px;margin-left: -11px;color: white;'>" + value + "</span>"
        End If
        Return "<span style=padding: 6px 11px;margin-left: -11px;color: white;'>" + value + "</span>"
    End Function

    Function SalesOrderBillsColumnFormat(ByVal row As DataRow) As String
        If row.Item("Bills") Then
            'Dim exportFolder As String = ConfigurationManager.AppSettings("ExportFolder").ToString()
            'Dim reportFolder As String = ConfigurationManager.AppSettings("VendorEmailsFolder").ToString()
            'Dim xmlPath As String = ConfigurationManager.AppSettings("XmlPath").ToString()

            'Dim files As String() = IO.Directory.GetFiles(reportFolder & exportFolder & "\\BillOfLading")
            'Dim query = From file In files Where file.Contains(row("order")) Select file
            'If query.Any() Then
            '    Return "<p style='display:none'>1</p><a href='" + xmlPath + files.First() + "'><img id='bills_" + row.Item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px;cursor:pointer;border-bottom:2px solid #1016AB' src='images/pinktick.png'></a>"
            'End If
            Return "<p style='display:none'>1</p><img id='bills_" + row.Item("order").ToString() + "'  style='margin-top:-3px; margin-left:3px;' src='images/pinktick.png'>"
        End If
        Return "<p style='display:none'>0</p>"
    End Function

    Function ManualPOHeaderForIncomingFgrdStatusColumnFormat(ByVal headerID As String, ByVal isXMLDownload As Boolean, ByVal orderDate As DateTime) As String
        Dim image As String = "images/check-off.png"
        Dim imageTitle As String = "Pending"
        If isXMLDownload Then
            image = "images/check-on.png"
            imageTitle = "Downloaded"
        ElseIf orderDate < DateTime.Today Then
            image = "images/icon_close.png"
            imageTitle = "Pending"
        End If
        Return String.Format("<img style='margin-top:-3px' id='IsXMLDownload_" & headerID & "' title='" + imageTitle + "'  src='" + image + "' />")
    End Function



    <System.Web.Services.WebMethod(True)>
    Public Function GetPickListMessage(ByVal order As String) As String
        Try

            Return SalesOrder.GetPickListMessage(order)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetPickListMessage")
            Return Nothing
        End Try
        Return ""
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function SwitchInventory(ByVal invId As Integer, ByVal orderId As Integer) As String
        Try

            Return SalesOrder.SwitchInventory(invId, orderId)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetPickListMessage")
        End Try
        Return "error"
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function InsertLogintoCallHs(ByVal Customer As Integer, ByVal Notes As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Return SalesOrder.InsertLogintoCallHs(Customer, Notes, User.ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetPickListMessage")
        End Try
        Return "error"
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ValidatePasscode(ByVal Passcode As String) As String
        Try
            If Users.ValidatePasscode(Passcode) Then
                Return "success"
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "ValidatePasscode")
            Return Nothing
        End Try
        Return "error"
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function InsertOrderHistory(ByVal order As String, ByVal customer As String, ByVal message As String) As String
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            InvoiceHistory.SaveInvoiceHistory(order, customer, message, User.Name)
            Return "success"
        Catch ex As Exception
            ErrorLogs.LogException(ex, "ValidatePasscode")
            Return "error"
        End Try
        Return "error"
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetOlderBoxesDetails(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String, ByVal ID As String) As XmlDocument
        Try

            Dim dt As DataTable = SalesOrder.GetOlderBoxDetails(ID)
            If Not dt Is Nothing AndAlso dt.Rows.Count > 0 Then
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                           New XElement("rows", New XElement("page", page.ToString()),
                           New XElement("total", dt.Rows.Count),
                           From row In dt.Rows()
                           Select
                           New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("color", ""),
                           New XElement("cell", row("farm")),
                           New XElement("cell", row("lot")),
                           New XElement("cell", row("daterec")),
                           New XElement("cell", row("uom")),
                           New XElement("cell", row("units")),
                           New XElement("cell", "<a href='#' id='SwitchId_" & Convert.ToString(row("ID")) & "' style='display: block;' >" & row("qty") & "</a>"),
                           New XElement("cell", row("days")),
                           New XElement("cell", row("boxnum"))
                               )))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            Else
                Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "GetLastProductSoldInfo")
            'Return Nothing
        End Try
        Return New XmlDocument()
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function Soldon(ByVal headerid As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If

            Dim dt As DataTable = SPORD.GetViewSPORDInvoicedTransforGrid(headerid)
            If Not dt Is Nothing AndAlso dt.Rows.Count > 0 Then
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                           New XElement("rows", New XElement("page", 1),
                           New XElement("total", dt.Rows.Count),
                           From row In dt.Rows()
                           Select
                           New XElement("row", New XAttribute("id", Convert.ToString(row("ID"))), New XAttribute("color", ""),
                           New XElement("cell", row("farm")),
                           New XElement("cell", row("FLOWER")),
                           New XElement("cell", row("lot")),
                           New XElement("cell", Convert.ToDateTime(row("daterec")).ToString("MM/dd/yyyy")),
                           New XElement("cell", Convert.ToDateTime(row("TRUCKDATE")).ToString("MM/dd/yyyy")),
                           New XElement("cell", row("CSREC")),
                           New XElement("cell", row("CSSOLD")),
                           New XElement("cell", row("units")),
                           New XElement("cell", row("uom")),
                           New XElement("cell", row("NAME")),
                           New XElement("cell", row("boxnum"))
                               )))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            Else
                Return BuildFlexiGridEmpty()
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "ValidatePasscode")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
        Return BuildFlexiGridEmpty()
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function SoldonOrder(ByVal invenid As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If


            Dim dt As DataTable = SPORD.GetViewSPORDInvoices(invenid)
            If Not dt Is Nothing AndAlso dt.Rows.Count > 0 Then
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                           New XElement("rows", New XElement("page", 1),
                           New XElement("total", dt.Rows.Count),
                           From row In dt.Rows()
                           Select
                           New XElement("row", New XAttribute("id", Convert.ToString(row("SQLID"))), New XAttribute("color", ""),
                           New XElement("cell", row("ORDER")),
                           New XElement("cell", Convert.ToDateTime(row("date")).ToString("MM/dd/yyyy")),
                           New XElement("cell", Convert.ToDateTime(row("date")).ToString("ddd")),
                           New XElement("cell", row("BOXES")),
                           New XElement("cell", row("FOB")),
                           New XElement("cell", row("BOXCODE"))
                               )))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            Else
                Return BuildFlexiGridEmpty()
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "ValidatePasscode")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
        Return BuildFlexiGridEmpty()
    End Function


    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function SoldonPoq(ByVal invenid As String) As XmlDocument
        Try
            Dim User As New User
            If Not Session("LoginUserDetails") Is Nothing Then
                User = Session("LoginUserDetails")
            ElseIf Not Session("LoginAdminDetails") Is Nothing Then
                User = Session("LoginAdminDetails")
            End If


            Dim dt As DataTable = SPORD.GetViewSPORDPoq(invenid)
            If Not dt Is Nothing AndAlso dt.Rows.Count > 0 Then
                Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                           New XElement("rows", New XElement("page", 1),
                           New XElement("total", dt.Rows.Count),
                           From row In dt.Rows()
                           Select
                           New XElement("row", New XAttribute("id", Convert.ToString(row("POQID"))), New XAttribute("color", ""),
                           New XElement("cell", row("PONUM")),
                           New XElement("cell", row("POSTAT")),
                           New XElement("cell", row("FARM")),
                           New XElement("cell", Convert.ToDateTime(row("shipdate")).ToString("MM/dd/yyyy")),
                           New XElement("cell", row("QTYBOX")),
                           New XElement("cell", row("QTYXBOX")),
                           New XElement("cell", row("UOM")),
                           New XElement("cell", row("BOXNUM"))
                    )))
                Dim newDoc As New XmlDocument()
                newDoc.LoadXml(Convert.ToString(xmlDoc))
                Return newDoc
            Else
                Return BuildFlexiGridEmpty()
            End If

        Catch ex As Exception
            ErrorLogs.LogException(ex, "ValidatePasscode")
            Return BuildFlexiGridError("OOPS! Something went wrong, please try again, we will research the issue.")
        End Try
        Return BuildFlexiGridEmpty()
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function ScanIncomingBarcode(ByVal barcode As String) As Incoming.ScanBarCodeResponse
        Dim response As New Incoming.ScanBarCodeResponse()
        Try
            Return Incoming.ScanIncomingBarcode(barcode)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ScanIncomingBarcode")
            response.success = False
            response.message = "Error in Service"
            Return response
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetIncomingBarcodeCount() As Int16
        Try
            Return Incoming.GetIncomingBarcodeCount()
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::ScanIncomingBarcode")
            Return 0
        End Try
    End Function


#Region "QuickBooks"
    'Private Shared ReadOnly appID As String = ConfigurationManager.AppSettings("QuickBooksAppID").ToString()
    'Private Shared ReadOnly appName As String = ConfigurationManager.AppSettings("QuickBooksAppName").ToString()
    'Private ReadOnly companyFile As String = ConfigurationManager.AppSettings("QuickBooksDataFile").ToString()

    'Private Function Connection() As QBSessionManager
    '    Dim sessionManager = New QBSessionManager()
    '    Try
    '        sessionManager.OpenConnection(appID, appName)
    '        sessionManager.BeginSession(companyFile, ENOpenMode.omDontCare)
    '        Return sessionManager
    '    Catch ex As Exception
    '        Return sessionManager
    '    End Try
    'End Function

    'Private Function DoBillAdd(ByVal listresponseIncoming As List(Of QuickBookBillIncoming)) As QBSessionManager
    '    Dim sessionManager = Connection()
    '    For Each responseIncoming In listresponseIncoming
    '        Dim requestMsgSet As IMsgSetRequest = sessionManager.CreateMsgSetRequest("US", 13, 0)
    '        requestMsgSet.Attributes.OnError = ENRqOnError.roeContinue
    '        'Bulid the XML For Bill Object
    '        BuildBillAddRq(requestMsgSet, responseIncoming)
    '        'Do Request and get the response
    '        Dim responseMsgSet As IMsgSetResponse = sessionManager.DoRequests(requestMsgSet)
    '        'check the response severity & message
    '        Dim StatusMessage = If(responseMsgSet.ResponseList.Count > 0, responseMsgSet.ResponseList.GetAt(0).StatusMessage, Nothing)
    '        Dim SeverityStatus = If(responseMsgSet.ResponseList.Count > 0, responseMsgSet.ResponseList.GetAt(0).StatusSeverity, Nothing)

    '        If SeverityStatus = "Error" Then
    '            Throw New Exception(StatusMessage)
    '        End If

    '    Next
    '    Return sessionManager
    'End Function

    'Private Sub BuildBillAddRq(ByVal requestMsgSet As IMsgSetRequest, ByVal responseIncoming As QuickBookBillIncoming)
    '    Dim BillAddRq As IBillAdd = requestMsgSet.AppendBillAddRq()
    '    BillAddRq.VendorRef.FullName.SetValue(responseIncoming.FarmName)
    '    BillAddRq.TxnDate.SetValue(responseIncoming.TnxDate)
    '    BillAddRq.DueDate.SetValue(responseIncoming.TnxDate.AddDays(30))
    '    BillAddRq.RefNumber.SetValue(responseIncoming.AWB)
    '    Dim ExpenseLineAdd549 As IExpenseLineAdd = BillAddRq.ExpenseLineAddList.Append()

    '    Dim accountref As String = ConfigurationManager.AppSettings("ExpenseAccountFullname").ToString()

    '    ExpenseLineAdd549.AccountRef.FullName.SetValue(accountref)
    '    ExpenseLineAdd549.Amount.SetValue(responseIncoming.PoAmount)
    '    ExpenseLineAdd549.Memo.SetValue("Testing")

    'End Sub


    'Private Sub BuildVendorAddRq(ByVal requestMsgSet As IMsgSetRequest, name As String)
    '    Dim VendorAddRq As IVendorAdd = requestMsgSet.AppendVendorAddRq()
    '    VendorAddRq.Name.SetValue(name)
    '    VendorAddRq.IsActive.SetValue(True)
    'End Sub


    'Private Function ConnectionOpen() As QBSessionManager
    '    Dim sessionManager = New QBSessionManager()
    '    sessionManager.OpenConnection(appID, appName)
    '    sessionManager.BeginSession(companyFile, ENOpenMode.omDontCare)
    '    Return sessionManager
    'End Function

    'Private Sub ConnctionClose(ByVal sessionManager As QBSessionManager)
    '    sessionManager.EndSession()
    '    sessionManager.CloseConnection()
    'End Sub

    'Private Sub DoBillAdd(ByVal sessionManager As QBSessionManager, ByVal quickBookBillIncomings As List(Of QuickBookBillIncoming))
    '    For Each quickBookBillIncoming In quickBookBillIncomings
    '        Dim requestMsgSet As IMsgSetRequest = sessionManager.CreateMsgSetRequest("US", 13, 0)
    '        requestMsgSet.Attributes.OnError = ENRqOnError.roeContinue
    '        BuildBillAddRq(requestMsgSet, quickBookBillIncoming)
    '        Dim responseMsgSet As IMsgSetResponse = sessionManager.DoRequests(requestMsgSet)
    '    Next
    'End Sub

    'Private Sub BuildBillAddRq(ByVal requestMsgSet As IMsgSetRequest, ByVal quickBookBillIncoming As QuickBookBillIncoming)
    '    Dim BillAddRq As IBillAdd = requestMsgSet.AppendBillAddRq()
    '    BillAddRq.VendorRef.FullName.SetValue(quickBookBillIncoming.FarmName)
    '    BillAddRq.TxnDate.SetValue(quickBookBillIncoming.TnxDate)
    '    BillAddRq.DueDate.SetValue(quickBookBillIncoming.TnxDate.AddDays(30))
    '    BillAddRq.RefNumber.SetValue(quickBookBillIncoming.AWB)
    '    Dim ExpenseLineAdd549 As IExpenseLineAdd = BillAddRq.ExpenseLineAddList.Append()
    '    Dim accountref As String = ConfigurationManager.AppSettings("ExpenseAccountFullname").ToString()
    '    ExpenseLineAdd549.AccountRef.FullName.SetValue(accountref)
    '    ExpenseLineAdd549.Amount.SetValue(quickBookBillIncoming.PoAmount)
    '    ExpenseLineAdd549.Memo.SetValue("Testing")
    'End Sub

    'Private Sub BuildVendorAddRq(ByVal sessionManager As QBSessionManager, ByVal VendorList As List(Of String))
    '    For Each name In VendorList
    '        Dim requestMsgSet As IMsgSetRequest = sessionManager.CreateMsgSetRequest("US", 13, 0)
    '        requestMsgSet.Attributes.OnError = ENRqOnError.roeContinue
    '        Dim VendorAddRq As IVendorAdd = requestMsgSet.AppendVendorAddRq()
    '        VendorAddRq.Name.SetValue(name)
    '        VendorAddRq.IsActive.SetValue(True)
    '        Dim responseMsgSet As IMsgSetResponse = sessionManager.DoRequests(requestMsgSet)
    '    Next
    'End Sub

#End Region

    'Added by Anubhuti 2023_09_18
#Region "TRAZE_MAPPING"
    <System.Web.Services.WebMethod(True)>
    Public Function SaveTRAZEVALUES(ByVal ID As Integer, ByVal FLOWER As String, ByVal UOM As String, ByVal PACK As Integer, ByVal PACKUNIT As String, ByVal INNERPACK As Integer,
      ByVal INNERPACKUNIT As String) As String
        Try
            Dim FlowerID As String = ""
            Dim result As String = ""
            result = TrazeMapping.SaveUpdateTRAZEVALUES(ID, FLOWER, UOM, PACK, PACKUNIT, INNERPACK, INNERPACKUNIT)
            If (Not FlowerID.Contains("UNIQUE KEY constraint")) Then
                Return FlowerID
            Else
                Return FlowerID
            End If
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::SaveTRAZEVALUES::PageTrazeMapping")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function DeleteTRAZEVALUESByID(ByVal ID As String) As String
        Try
            Return TrazeMapping.DeleteTRAZEVALUESbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::DeleteTRAZEVALUESByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    Public Function GetTRAZEVALUESByID(ByVal ID As String) As TRAZEVALUES
        Try
            Return TrazeMapping.GetTRAZEVALUESbyID(ID)
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTRAZEVALUESByID")
            Return Nothing
        End Try
    End Function

    <System.Web.Services.WebMethod(True)>
    <ScriptMethod(UseHttpGet:=False, XmlSerializeString:=True, ResponseFormat:=ResponseFormat.Xml)>
    Public Function GetTrazeMapping(ByVal page As Integer, ByVal rp As Integer, ByVal sortname As String, ByVal sortorder As String, ByVal query As String, ByVal qtype As String) As XmlDocument
        Try
            Dim whereCondition As String = ""
            If qtype IsNot Nothing AndAlso query IsNot Nothing AndAlso query <> String.Empty Then
                whereCondition = BuildWhereCondition(GetType(Email), qtype, query)
            End If

            Dim sortExp As String = sortname & " " & sortorder
            Dim start As Integer = ((page - 1) * rp) + 1
            rp -= 1


            Dim obj As New TrazeMapping

            Dim data As List(Of TRAZEVALUES) = obj.GetSystemTrazeMapping(whereCondition, sortExp, start, rp)

            Dim xmlDoc As New XDocument(New XDeclaration("1.0", "utf-8", "yes"),
                                        New XElement("rows", New XElement("page", page.ToString()),
                                        New XElement("total", obj.TotalRows.ToString()),
                                        data.Select(Function(row) New XElement("row", New XAttribute("id", row.ID),
                                        New XElement("cell", "<img href='#' src='images/Delete-icon.png' style='cursor:pointer' id='DeleteTrazeValues_" & row.ID & "'/>"),
                                        New XElement("cell", "<b><a href='#' id='EditTrazeValues_" & row.ID & "'><img src='images/Edit.png'/></a></b>"),
                                        New XElement("cell", row.FLOWER),
                                        New XElement("cell", row.UOM),
                                        New XElement("cell", row.PACK),
                                        New XElement("cell", row.PACKUNIT),
                                        New XElement("cell", row.INNERPACK),
                                        New XElement("cell", row.INNERPACKUNIT)))))
            Dim newDoc As New XmlDocument()
            newDoc.LoadXml(xmlDoc.ToString())
            Return newDoc
        Catch ex As Exception
            ErrorLogs.LogException(ex, "Error in Service::GetTrazeMapping::PageTrazeMapping")
            Return Nothing
        End Try
    End Function

#End Region

End Class



